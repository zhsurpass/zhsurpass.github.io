<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>多线程与线程池 posix thread</title>
      <link href="/2024/12/17/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0-posix-thread/"/>
      <url>/2024/12/17/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0-posix-thread/</url>
      
        <content type="html"><![CDATA[<h1 id="多线程与线程池-posix-thread">多线程与线程池 posix thread</h1><h2 id="多线程简介">多线程简介</h2><h3 id="多线程相关概念">多线程相关概念</h3><ul><li>进程(Process)：进程是正在运行的程序实体，并且包括这个运行的程序中占据的所有系统资源，比如说CPU(寄存器)，IO，内存，网络资源等。同样一个程序，同一时刻被两次运行了，那么他们就是两个独立的进程</li><li>线程(Thread)：线程是操作系统能够进行运算调度的最小单位。它被包含在进程之中，是进程中的实际运作单位。一条线程指的是进程中一个单一顺序的控制流，一个进程中可以运行多个线程，每条线程执行不同的任务</li><li>并发(Concurrent)：在操作系统中，是指一个时间段中有几个程序都处于已启动运行到运行完毕之间，且这几个程序都是在同一个处理机上运行。同一时刻只能有一条指令执行，但多个进程指令被快速的轮换执行，使得在宏观上具有多个进程同时执行的效果，但在微观上并不是同时执行的，只是把时间分成若干段，使多个进程快速交替的执行</li><li>并行(Parallel)：当系统有一个以上CPU时，当一个CPU执行一个进程时，另一个CPU可以执行另一个进程，两个进程互不抢占CPU资源，可以同时进行，这种方式我们称之为并行(Parallel)。其实决定并行的因素不是CPU的数量，而是CPU的核心数量，比如一个CPU多个核也可以并行</li></ul><h3 id="进程与线程的区别">进程与线程的区别</h3><ul><li>线程是程序执行的最小单位，而进程是操作系统分配资源的最小单位；进程是系统资源分配的单位，线程是系统调度的单位</li><li>一个进程由一个或多个线程组成，线程是一个进程中代码的不同执行路线</li><li>进程之间相互独立，进程之间不能共享资源，而线程共享所在进程的地址空间和其它资源。同时线程还有自己的栈和栈指针，程序计数器等寄存器</li><li>调度和切换：线程上下文切换比进程上下文切换要快得多</li></ul><h3 id="为什么要用多线程">为什么要用多线程</h3><ol><li>进程之间切换代价比较高，线程之间切换代价比较小</li><li>解决 CPU 和 IO 速度不匹配的问题，多线程更适合在 IO 切换频繁的场景</li><li>充分利用多核 CPU 资源、提高程序的并发效率</li></ol><h2 id="线程">线程</h2><h3 id="创建线程">创建线程</h3><h4 id="函数定义">函数定义</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">pthread_create</span><span class="params">(<span class="type">pthread_t</span> * thread, <span class="type">pthread_attr_t</span> * attr, <span class="type">void</span> * (*start_routine)(<span class="type">void</span> *), <span class="type">void</span> * arg)</span></span></span><br></pre></td></tr></table></figure><h4 id="参数说明">参数说明</h4><ul><li><code>thread</code>：新创建的线程的标识符</li><li><code>attr</code>：线程属性，一般设置为<code>NULL</code></li><li><code>start_routine</code>：新创线程从此开始运行</li><li><code>arg</code>：<code>start_routine</code>函数的参数</li></ul><h4 id="示例">示例</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> * <span class="title">foo</span><span class="params">(<span class="type">void</span> *)</span></span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;foo&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">pthread_t</span> tid;</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;tid, <span class="literal">nullptr</span>, foo, <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 阻塞等待输入，保持程序运行，避免主线程直接退出</span></span><br><span class="line">    std::<span class="built_in">getchar</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="线程退出">线程退出</h3><p>线程结束执行的方式共有3种，分别是：</p><ol><li><p>线程将指定函数体中的代码执行完后自行结束</p></li><li><p>线程执行过程中，遇到<code>pthread_exit()</code>函数结束执行</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">pthread_exit</span><span class="params">(<span class="type">void</span> * value_ptr)</span></span>;</span><br></pre></td></tr></table></figure></li><li><p>线程执行过程中，被同一进程中的其它线程(包括主线程)，调用<code>pthead_cancel()</code>函数强制终止</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">pthread_cancel</span><span class="params">(<span class="type">pthread_t</span> tid)</span></span>;</span><br></pre></td></tr></table></figure></li></ol><h4 id="示例">示例</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> * <span class="title">foo</span><span class="params">(<span class="type">void</span> *)</span></span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;foo1&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="built_in">pthread_exit</span>(PTHREAD_CANCELED);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;foo2&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">pthread_t</span> tid;</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;tid, <span class="literal">nullptr</span>, foo, <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 阻塞等待输入，保持程序运行，避免主线程直接退出</span></span><br><span class="line">    std::<span class="built_in">getchar</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> * <span class="title">foo</span><span class="params">(<span class="type">void</span> *)</span></span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;foo1&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">5</span>);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;foo2&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">pthread_t</span> tid;</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;tid, <span class="literal">nullptr</span>, foo, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">2</span>);</span><br><span class="line">    <span class="built_in">pthread_cancel</span>(tid);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 阻塞等待输入，保持程序运行，避免主线程直接退出</span></span><br><span class="line">    std::<span class="built_in">getchar</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="线程属性">线程属性</h3><h4 id="phtread-attr-t结构体">phtread_attr_t结构体</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> detachstate; <span class="comment">// 线程的分离状态</span></span><br><span class="line">    <span class="type">int</span> schedpolicy; <span class="comment">// 线程的调度策略</span></span><br><span class="line">    structsched_param schedparam; <span class="comment">// 线程的调度参数</span></span><br><span class="line">    <span class="type">int</span> inheritsched; <span class="comment">// 线程的继承性</span></span><br><span class="line">    <span class="type">int</span> scope; <span class="comment">// 线程的作用域</span></span><br><span class="line">    <span class="type">size_t</span> guardsize; <span class="comment">// 线程栈末尾的警戒缓冲区大小</span></span><br><span class="line">    <span class="type">int</span> stackaddr_set; <span class="comment">// 线程的栈设置</span></span><br><span class="line">    <span class="type">void</span>* stackaddr; <span class="comment">// 线程栈的位置</span></span><br><span class="line">    <span class="type">size_t</span> stacksize; <span class="comment">// 线程栈的大小</span></span><br><span class="line">&#125; <span class="type">pthread_attr_t</span>;</span><br></pre></td></tr></table></figure><h4 id="初始化线程属性">初始化线程属性</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">pthread_attr_init</span><span class="params">(pthread_1 <span class="type">attr_t</span> * attr)</span></span>;</span><br></pre></td></tr></table></figure><h4 id="线程作用域属性scope">线程作用域属性scope</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">pthread_attr_setscope</span><span class="params">(<span class="type">pthread_attr_t</span> * attr, <span class="type">int</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">pthread_attr_getscope</span><span class="params">(<span class="type">const</span> <span class="type">pthread_attr_t</span> * attr, <span class="type">int</span> *)</span></span>;</span><br></pre></td></tr></table></figure><p>作用域属性表示线程间竞争CPU的范围，也就是说线程优先级的有效范围。具体可以选择两个值：<code>PTHREAD_SCOPE_SYSTEM</code>和<code>PTHREAD_SCOPE_PROCESS</code>。前者表示与系统中所有线程一起竞争CPU时间，后者表示仅与同进程中的线程竞争CPU，默认的一般都是<code>PTHREAD_SCOPE_PROCESS</code>。</p><h4 id="线程分离状态属性detachstate">线程分离状态属性detachstate</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">pthread_attr_setdetachstate</span><span class="params">(<span class="type">pthread_attr_t</span> * attr, <span class="type">int</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">pthread_attr_getdetachstate</span><span class="params">(<span class="type">const</span> <span class="type">pthread_attr_t</span> * attr, <span class="type">int</span>*)</span></span>;</span><br></pre></td></tr></table></figure><p>在任何一个时间点上，线程是可结合的(joinable)，或者是可分离的(detached)，一个可结合的线程能够被其他线程收回其资源和杀死，在被其他线程回收之前，它的存储器资源(如栈)是不释放的。相反，一个分离的线程是不能被其他线程回收或杀死的，它的存储器资源在它终止时由系统自动释放。默认情况下，线程是非分离状态的。这种情况下，原有的线程等待创建的线程结束，只有当<code>pthread_join()</code>函数返回时，创建的线程才算终止，才能释放自己占用的系统资源。这两种状态的值分别是<code>PTHREAD_CREATE_DETACHED</code>(可分离线程)和<code>PTHREAD_CREATE_JOINABLE</code>(非分离线程)，默认是<code>PTHREAD_CREATE_JOINABLE</code>。</p><h4 id="销毁线程属性">销毁线程属性</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">pthread_attr_destroy</span><span class="params">(pthread_1 <span class="type">attr_t</span> * attr)</span></span>;</span><br></pre></td></tr></table></figure><h4 id="示例">示例</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> * <span class="title">foo</span><span class="params">(<span class="type">void</span> * ptr)</span></span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;foo&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">5</span>);</span><br><span class="line">    std::cout &lt;&lt; *((<span class="type">int</span>*)ptr) &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> * ptr = <span class="keyword">new</span> <span class="type">int</span>;</span><br><span class="line">    *ptr = <span class="number">8</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="type">pthread_attr_t</span> attr;</span><br><span class="line">    <span class="built_in">pthread_attr_init</span>(&amp;attr);</span><br><span class="line">    <span class="built_in">pthread_attr_setscope</span>(&amp;attr, PTHREAD_SCOPE_SYSTEM);</span><br><span class="line">    <span class="built_in">pthread_attr_setdetachstate</span>(&amp;attr, PTHREAD_CREATE_DETACHED);</span><br><span class="line">    <span class="type">pthread_t</span> tid;</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;tid, &amp;attr, foo, ptr);</span><br><span class="line">    <span class="built_in">pthread_attr_destroy</span>(&amp;attr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 阻塞等待输入，保持程序运行，避免主线程直接退出</span></span><br><span class="line">    std::<span class="built_in">getchar</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="线程封装">线程封装</h3><p>针对之前的代码做一些封装，以便于后续复用和使用。</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CMakeLists.txt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.19</span>)</span><br><span class="line"><span class="keyword">project</span>(pthread)</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD <span class="number">11</span>)</span><br><span class="line"><span class="keyword">include_directories</span>(./)</span><br><span class="line"><span class="keyword">file</span>(GLOB_RECURSE SOURCES <span class="string">&quot;utility/*.cpp&quot;</span> <span class="string">&quot;thread/*.cpp&quot;</span>)</span><br><span class="line"><span class="keyword">add_executable</span>(main <span class="variable">$&#123;SOURCES&#125;</span> main.cpp)</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// thread/thread.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh&#123;</span><br><span class="line">    <span class="keyword">namespace</span> thread&#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Thread</span>&#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">Thread</span>();</span><br><span class="line">            <span class="keyword">virtual</span> ~<span class="built_in">Thread</span>() = <span class="keyword">default</span>;</span><br><span class="line">            <span class="comment">// 要实现一个Thread子类必须实现run()方法</span></span><br><span class="line">            <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">run</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// 线程启动</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">start</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="comment">// 线程结束</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">stop</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span>:</span><br><span class="line">            <span class="comment">// 线程运行函数</span></span><br><span class="line">            <span class="function"><span class="type">static</span> <span class="type">void</span> * <span class="title">thread_func</span><span class="params">(<span class="type">void</span> * ptr)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span>:</span><br><span class="line">            <span class="comment">// 线程的唯一标识</span></span><br><span class="line">            <span class="type">pthread_t</span> m_tid;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// thread/thread.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread/thread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::thread;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Thread::<span class="built_in">Thread</span>() : <span class="built_in">m_tid</span>(<span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Thread::start</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">pthread_attr_t</span> attr;</span><br><span class="line">    <span class="built_in">pthread_attr_init</span>(&amp;attr);</span><br><span class="line">    <span class="built_in">pthread_attr_setscope</span>(&amp;attr, PTHREAD_SCOPE_SYSTEM);</span><br><span class="line">    <span class="comment">// 将线程设置为可分离的</span></span><br><span class="line">    <span class="built_in">pthread_attr_setdetachstate</span>(&amp;attr, PTHREAD_CREATE_DETACHED);</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;m_tid, &amp;attr, thread_func, (<span class="type">void</span>*)<span class="keyword">this</span>);</span><br><span class="line">    <span class="built_in">pthread_attr_destroy</span>(&amp;attr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Thread::stop</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">pthread_exit</span>(PTHREAD_CANCELED);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> * <span class="title">Thread::thread_func</span><span class="params">(<span class="type">void</span> * ptr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> thread = (Thread *)ptr;</span><br><span class="line">    thread-&gt;<span class="built_in">run</span>();</span><br><span class="line">    <span class="keyword">return</span> ptr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread/thread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::thread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TestThread</span> : <span class="keyword">public</span> Thread</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">run</span><span class="params">()</span> <span class="keyword">override</span></span>&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;test thread&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    TestThread thread;</span><br><span class="line">    thread.<span class="built_in">start</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 阻塞等待输入，避免主线程退出</span></span><br><span class="line">    std::<span class="built_in">getchar</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="互斥锁">互斥锁</h2><p>互斥量(mutex)从本质上来说是一把锁，在访问共享资源前对互斥量进行加锁，在访问完成后释放互斥量上的锁。对互斥量进行加锁后，任何其他试图再次对互斥量加锁的线程将会被阻塞，直到当前线程释放该互斥锁。</p><h3 id="创建互斥锁">创建互斥锁</h3><h4 id="静态创建">静态创建</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">pthread_mutex_t</span> mutex = PTHREAD_MUTEX_INITIALIZER;</span><br></pre></td></tr></table></figure><p>POSIX 定义了一个宏<code>PTHREAD_MUTEX_INITIALIZER</code>来静态初始化互斥锁。</p><h4 id="动态创建">动态创建</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">pthread_mutex_init</span><span class="params">(<span class="type">pthread_mutex_t</span> * mutex, <span class="type">const</span> <span class="type">pthread_mutexattr_t</span> * attr)</span></span>;</span><br></pre></td></tr></table></figure><h3 id="销毁互斥锁">销毁互斥锁</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">pthread_mutex_destroy</span><span class="params">(pthread_1 <span class="type">mutex_t</span> * mutex)</span></span>;</span><br></pre></td></tr></table></figure><h3 id="加锁和解锁">加锁和解锁</h3><h4 id="lock">lock</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">pthread_mutex_lock</span><span class="params">(<span class="type">pthread_mutex_t</span> * mutex)</span></span>;</span><br></pre></td></tr></table></figure><h4 id="unlock">unlock</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">pthread_mutex_unlock</span><span class="params">(<span class="type">pthread_mutex_t</span> * mutex)</span></span>;</span><br></pre></td></tr></table></figure><h4 id="trylock">trylock</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">pthread_mutex_trylock</span><span class="params">(<span class="type">pthread_mutex_t</span> * mutex)</span></span>;</span><br></pre></td></tr></table></figure><p><code>trylock</code>与<code>lock</code>不同的一点在于在锁已经被占用时返回<code>EBUSY</code>而不是挂起等待。</p><h3 id="互斥锁属性">互斥锁属性</h3><h4 id="初始化互斥锁属性">初始化互斥锁属性</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">pthread_mutexattr_init</span><span class="params">(<span class="type">pthread_mutexattr_t</span> *attr)</span></span>;</span><br></pre></td></tr></table></figure><h4 id="设置互斥锁的类型">设置互斥锁的类型</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">pthread_mutexattr_settype</span><span class="params">(<span class="type">pthread_mutexattr_t</span> *attr, <span class="type">int</span> type)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">pthread_mutexattr_gettype</span><span class="params">(<span class="type">const</span> <span class="type">pthread_mutexattr_t</span> *attr, <span class="type">int</span> *type)</span></span>;</span><br></pre></td></tr></table></figure><p>参数<code>type</code>用来定义互斥锁的类型，<code>type</code>可以设置成如下几种情况：</p><ol><li><code>PTHREAD_MUTEX_NORMAL</code>：标准互斥锁，该类型的互斥锁不具备死锁检测功能</li><li><code>PTHREAD_MUTEX_ERRORCHECK</code>：检错互斥锁，对此互斥锁的所有操作都会执行错误检测，这种互斥锁运行起来较一般类型慢，不过却可以作为调试，以发现后续程序在哪里违反了互斥锁的使用规则</li><li><code>PTHREAD_MUTEX_RECURSIVE</code>：递归互斥锁，该互斥锁维护有一个锁计数器，线程上锁则会将锁计数器的值加1，解锁则会将锁计数器的值减1。只有当锁计数器值降至0时，才会释放该互斥锁。这一类互斥锁与普通互斥锁的区别在于，同一个线程可以多次获得同一个递归锁，不会产生死锁；而如果一个线程多次获得同一个普通锁，则会产生死锁</li></ol><h4 id="销毁互斥锁属性">销毁互斥锁属性</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">pthread_mutexattr_destroy</span><span class="params">(<span class="type">pthread_mutexattr_t</span> *attr)</span></span>;</span><br></pre></td></tr></table></figure><h3 id="互斥锁封装">互斥锁封装</h3><p>用C++面向对象的方式对互斥锁做一些封装，使得相关代码更易使用。</p><h4 id="mutex类">Mutex类</h4><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CMakeLists.txt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.19</span>)</span><br><span class="line"><span class="keyword">project</span>(pthread)</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD <span class="number">11</span>)</span><br><span class="line"><span class="keyword">include_directories</span>(./)</span><br><span class="line"><span class="keyword">file</span>(GLOB_RECURSE SOURCES <span class="string">&quot;utility/*.cpp&quot;</span> <span class="string">&quot;thread/*.cpp&quot;</span>)</span><br><span class="line"><span class="keyword">add_executable</span>(main <span class="variable">$&#123;SOURCES&#125;</span> main.cpp)</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// thread/mutex.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> thread</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Mutex</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">Mutex</span>();</span><br><span class="line">            ~<span class="built_in">Mutex</span>();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 加锁</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">lock</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="comment">// 尝试加锁</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">try_lock</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="comment">// 解锁</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">unlock</span><span class="params">()</span></span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="type">pthread_mutex_t</span> m_mutex;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// thread/mutex.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread/mutext.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::thread;</span><br><span class="line"></span><br><span class="line">Mutex::<span class="built_in">Mutex</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">pthread_mutexattr_t</span> attr;</span><br><span class="line">    <span class="built_in">pthread_mutexattr_init</span>(&amp;attr);</span><br><span class="line">    <span class="built_in">pthread_mutexattr_settype</span>(&amp;attr, PTHREAD_MUTEX_ERRORCHECK);</span><br><span class="line">    <span class="built_in">pthread_mutex_init</span>(&amp;m_mutex, &amp;attr);</span><br><span class="line">    <span class="built_in">pthread_mutexattr_destroy</span>(&amp;attr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Mutex::~<span class="built_in">Mutex</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">pthread_mutex_destroy</span>(&amp;m_mutex);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Mutex::lock</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">pthread_mutex_lock</span>(&amp;m_mutex);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Mutex::try_lock</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">pthread_mutex_trylock</span>(&amp;m_mutex) == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Mutex::unlock</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">pthread_mutex_unlock</span>(&amp;m_mutex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="autolock类">AutoLock类</h4><p><code>AutoLock</code>类其实类似于C++ 11标准中的<code>lock_gurad</code>。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// thread/auto_lock.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread/mutext.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> thread</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">AutoLock</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">AutoLock</span>() = <span class="keyword">delete</span>;</span><br><span class="line">            <span class="built_in">AutoLock</span>(Mutex * mutex);</span><br><span class="line">            ~<span class="built_in">AutoLock</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            Mutex * m_mutex;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// thread/auto_lock.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread/auto_lock.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::thread;</span><br><span class="line"></span><br><span class="line">AutoLock::<span class="built_in">AutoLock</span>(Mutex * mutex) : <span class="built_in">m_mutex</span>(mutex)</span><br><span class="line">&#123;</span><br><span class="line">    m_mutex-&gt;<span class="built_in">lock</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">AutoLock::~<span class="built_in">AutoLock</span>()</span><br><span class="line">&#123;</span><br><span class="line">    m_mutex-&gt;<span class="built_in">unlock</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread/auto_lock.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::thread;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> g_num = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Mutex m;</span><br><span class="line">    <span class="comment">// 加锁</span></span><br><span class="line">    <span class="function">AutoLock <span class="title">lock</span><span class="params">(&amp;m)</span></span>;</span><br><span class="line">    <span class="comment">// 访问临界区资源</span></span><br><span class="line">    g_num = <span class="number">2</span>;</span><br><span class="line">    <span class="comment">// AutoLock析构函数中会解锁</span></span><br><span class="line">    <span class="comment">// Mutex析构函数中会销毁锁</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="条件变量">条件变量</h2><p>条件变量(pthread_cond)是C++多线程编程中的一种同步机制，它通常与互斥量(pthread_mutex)结合使用，用于实现线程间的协调与同步。条件变量的作用是使线程能够等待某个条件的发生，并在条件满足时被唤醒。条件变量可以用来避免线程轮询等待某个事件的发生，从而提高线程的效率。</p><h3 id="创建条件变量">创建条件变量</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">pthread_cond_init</span><span class="params">(<span class="type">pthread_cond_t</span> * cond, <span class="type">const</span> pthread_1 <span class="type">condattr_t</span> * attr)</span></span>;</span><br></pre></td></tr></table></figure><h3 id="阻塞等待条件变量">阻塞等待条件变量</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">pthread_cond_wait</span><span class="params">(<span class="type">pthread_cond_t</span> * cond, <span class="type">const</span> <span class="type">pthread_mutexr_t</span> * mutex)</span></span>;</span><br></pre></td></tr></table></figure><p>函数的作用是将线程置于等待状态，并且在等待期间会释放<code>mutex</code>互斥量的锁，当线程被唤醒之后再重新取得互斥量的锁。</p><h3 id="限时等待条件变量">限时等待条件变量</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">pthread_cond_timewait</span><span class="params">(<span class="type">pthread_cond_t</span> * cond, <span class="type">const</span> <span class="type">pthread_mutexr_t</span> * mutex, <span class="type">const</span> <span class="keyword">struct</span> timepsec * abstime)</span></span>;</span><br></pre></td></tr></table></figure><h3 id="发送信号">发送信号</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">pthread_cond_signal</span><span class="params">(<span class="type">pthread_cond_t</span> * cond)</span></span>;</span><br></pre></td></tr></table></figure><p>唤醒一个阻塞在条件变量上的线程。</p><h3 id="广播信号">广播信号</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">pthread_cond_broadcast</span><span class="params">(pthread_1 <span class="type">cond_t</span> * cond)</span></span>;</span><br></pre></td></tr></table></figure><p>唤醒全部阻塞在条件变量上的线程。</p><h3 id="销毁条件变量">销毁条件变量</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">pthread_cond_destroy</span><span class="params">(<span class="type">pthread_cond_t</span> * cond)</span></span>;</span><br></pre></td></tr></table></figure><h3 id="示例">示例</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;list&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread/thread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::thread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TaskQueue</span> : <span class="keyword">public</span> Thread</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">TaskQueue</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 初始化互斥锁</span></span><br><span class="line">        <span class="type">pthread_mutexattr_t</span> mutexattr;</span><br><span class="line">        <span class="built_in">pthread_mutexattr_init</span>(&amp;mutexattr);</span><br><span class="line">        <span class="built_in">pthread_mutexattr_settype</span>(&amp;mutexattr, PTHREAD_MUTEX_ERRORCHECK);</span><br><span class="line">        <span class="built_in">pthread_mutex_init</span>(&amp;m_mutex, &amp;mutexattr);</span><br><span class="line">        <span class="built_in">pthread_mutexattr_destroy</span>(&amp;mutexattr);</span><br><span class="line">        <span class="comment">// 初始化条件变量</span></span><br><span class="line">        <span class="type">pthread_condattr_t</span> condattr;</span><br><span class="line">        <span class="built_in">pthread_condattr_init</span>(&amp;condattr);</span><br><span class="line">        <span class="built_in">pthread_cond_init</span>(&amp;m_cond, &amp;condattr);</span><br><span class="line">        <span class="built_in">pthread_condattr_destroy</span>(&amp;condattr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">run</span><span class="params">()</span> <span class="keyword">override</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 使用条件变量先加锁</span></span><br><span class="line">            <span class="built_in">pthread_mutex_lock</span>(&amp;m_mutex);</span><br><span class="line">            <span class="keyword">while</span> (m_queue.<span class="built_in">empty</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                std::cout &lt;&lt; <span class="string">&quot;waiting for an integer...&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">                <span class="comment">// 等待信号</span></span><br><span class="line">                <span class="built_in">pthread_cond_wait</span>(&amp;m_cond, &amp;m_mutex);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">int</span> num = m_queue.<span class="built_in">front</span>();</span><br><span class="line">            m_queue.<span class="built_in">pop_front</span>();</span><br><span class="line">            <span class="built_in">pthread_mutex_unlock</span>(&amp;m_mutex);</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;num: &quot;</span> &lt;&lt; num &lt;&lt; std::endl;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">push</span><span class="params">(<span class="type">int</span> num)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 加锁</span></span><br><span class="line">        <span class="built_in">pthread_mutex_lock</span>(&amp;m_mutex);</span><br><span class="line">        m_queue.<span class="built_in">push_back</span>(num);</span><br><span class="line">        <span class="comment">// 发送信号</span></span><br><span class="line">        <span class="built_in">pthread_cond_signal</span>(&amp;m_cond);</span><br><span class="line">        <span class="comment">// 解锁</span></span><br><span class="line">        <span class="built_in">pthread_mutex_unlock</span>(&amp;m_mutex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// 互斥锁</span></span><br><span class="line">    <span class="type">pthread_mutex_t</span> m_mutex;</span><br><span class="line">    <span class="comment">// 条件变量</span></span><br><span class="line">    <span class="type">pthread_cond_t</span> m_cond;</span><br><span class="line">    std::list&lt;<span class="type">int</span>&gt; m_queue;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    TaskQueue queue;</span><br><span class="line">    queue.<span class="built_in">start</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">2</span>);</span><br><span class="line">        queue.<span class="built_in">push</span>(i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 阻塞等待输入，保持程序运行</span></span><br><span class="line">    std::<span class="built_in">getchar</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="条件变量封装">条件变量封装</h3><p>基于C++面向对象的方式将条件变量封装为<code>Condition</code>类。</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CMakeLists.txt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.19</span>)</span><br><span class="line"><span class="keyword">project</span>(pthread)</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD <span class="number">11</span>)</span><br><span class="line"><span class="keyword">include_directories</span>(./)</span><br><span class="line"><span class="keyword">file</span>(GLOB_RECURSE SOURCES <span class="string">&quot;utility/*.cpp&quot;</span> <span class="string">&quot;thread/*.cpp&quot;</span>)</span><br><span class="line"><span class="keyword">add_executable</span>(main <span class="variable">$&#123;SOURCES&#125;</span> main.cpp)</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// thread/thread.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh&#123;</span><br><span class="line">    <span class="keyword">namespace</span> thread&#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Thread</span>&#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">Thread</span>();</span><br><span class="line">            <span class="keyword">virtual</span> ~<span class="built_in">Thread</span>() = <span class="keyword">default</span>;</span><br><span class="line">            <span class="comment">// 要实现一个Thread子类必须实现run()方法</span></span><br><span class="line">            <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">run</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// 线程启动</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">start</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="comment">// 线程结束</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">stop</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span>:</span><br><span class="line">            <span class="comment">// 线程运行函数</span></span><br><span class="line">            <span class="function"><span class="type">static</span> <span class="type">void</span> * <span class="title">thread_func</span><span class="params">(<span class="type">void</span> * ptr)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span>:</span><br><span class="line">            <span class="comment">// 线程的唯一标识</span></span><br><span class="line">            <span class="type">pthread_t</span> m_tid;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// thread/thread.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread/thread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::thread;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Thread::<span class="built_in">Thread</span>() : <span class="built_in">m_tid</span>(<span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Thread::start</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">pthread_attr_t</span> attr;</span><br><span class="line">    <span class="built_in">pthread_attr_init</span>(&amp;attr);</span><br><span class="line">    <span class="built_in">pthread_attr_setscope</span>(&amp;attr, PTHREAD_SCOPE_SYSTEM);</span><br><span class="line">    <span class="comment">// 将线程设置为可分离的</span></span><br><span class="line">    <span class="built_in">pthread_attr_setdetachstate</span>(&amp;attr, PTHREAD_CREATE_DETACHED);</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;m_tid, &amp;attr, thread_func, (<span class="type">void</span>*)<span class="keyword">this</span>);</span><br><span class="line">    <span class="built_in">pthread_attr_destroy</span>(&amp;attr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Thread::stop</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">pthread_exit</span>(PTHREAD_CANCELED);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> * <span class="title">Thread::thread_func</span><span class="params">(<span class="type">void</span> * ptr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> thread = (Thread *)ptr;</span><br><span class="line">    thread-&gt;<span class="built_in">run</span>();</span><br><span class="line">    <span class="keyword">return</span> ptr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// thread/mutex.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> thread</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Mutex</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">Condition</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">Mutex</span>();</span><br><span class="line">            ~<span class="built_in">Mutex</span>();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 加锁</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">lock</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="comment">// 尝试加锁</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">try_lock</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="comment">// 解锁</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">unlock</span><span class="params">()</span></span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="type">pthread_mutex_t</span> m_mutex;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// thread/mutex.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread/mutext.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::thread;</span><br><span class="line"></span><br><span class="line">Mutex::<span class="built_in">Mutex</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">pthread_mutexattr_t</span> attr;</span><br><span class="line">    <span class="built_in">pthread_mutexattr_init</span>(&amp;attr);</span><br><span class="line">    <span class="built_in">pthread_mutexattr_settype</span>(&amp;attr, PTHREAD_MUTEX_ERRORCHECK);</span><br><span class="line">    <span class="built_in">pthread_mutex_init</span>(&amp;m_mutex, &amp;attr);</span><br><span class="line">    <span class="built_in">pthread_mutexattr_destroy</span>(&amp;attr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Mutex::~<span class="built_in">Mutex</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">pthread_mutex_destroy</span>(&amp;m_mutex);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Mutex::lock</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">pthread_mutex_lock</span>(&amp;m_mutex);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Mutex::try_lock</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">pthread_mutex_trylock</span>(&amp;m_mutex) == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Mutex::unlock</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">pthread_mutex_unlock</span>(&amp;m_mutex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// thread/condition.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread/mutext.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> thread</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Condition</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">Condition</span>();</span><br><span class="line">            ~<span class="built_in">Condition</span>();</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">wait</span><span class="params">(Mutex * mutex)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">signal</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">broadcast</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="type">pthread_cond_t</span> m_cond;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// thread/condition.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread/condition.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::thread;</span><br><span class="line"></span><br><span class="line">Condition::<span class="built_in">Condition</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">pthread_condattr_t</span> attr;</span><br><span class="line">    <span class="built_in">pthread_condattr_init</span>(&amp;attr);</span><br><span class="line">    <span class="built_in">pthread_cond_init</span>(&amp;m_cond, &amp;attr);</span><br><span class="line">    <span class="built_in">pthread_condattr_destroy</span>(&amp;attr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Condition::~<span class="built_in">Condition</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">pthread_cond_destroy</span>(&amp;m_cond);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Condition::wait</span><span class="params">(Mutex * mutex)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">pthread_cond_wait</span>(&amp;m_cond, &amp;(mutex-&gt;m_mutex));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Condition::signal</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">pthread_cond_signal</span>(&amp;m_cond);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Condition::broadcast</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">pthread_cond_broadcast</span>(&amp;m_cond);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;list&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread/thread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread/condition.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::thread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TaskQueue</span> : <span class="keyword">public</span> Thread</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">TaskQueue</span>() = <span class="keyword">default</span>;</span><br><span class="line">    ~<span class="built_in">TaskQueue</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">run</span><span class="params">()</span> <span class="keyword">override</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 使用条件变量先加锁</span></span><br><span class="line">            m_mutex.<span class="built_in">lock</span>();</span><br><span class="line">            <span class="keyword">while</span> (m_queue.<span class="built_in">empty</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                std::cout &lt;&lt; <span class="string">&quot;waiting for an integer...&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">                <span class="comment">// 等待信号</span></span><br><span class="line">                m_cond.<span class="built_in">wait</span>(&amp;m_mutex);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">int</span> num = m_queue.<span class="built_in">front</span>();</span><br><span class="line">            m_queue.<span class="built_in">pop_front</span>();</span><br><span class="line">            m_mutex.<span class="built_in">unlock</span>();</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;num: &quot;</span> &lt;&lt; num &lt;&lt; std::endl;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">push</span><span class="params">(<span class="type">int</span> num)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 加锁</span></span><br><span class="line">        m_mutex.<span class="built_in">lock</span>();</span><br><span class="line">        m_queue.<span class="built_in">push_back</span>(num);</span><br><span class="line">        <span class="comment">// 发送信号</span></span><br><span class="line">        m_cond.<span class="built_in">signal</span>();</span><br><span class="line">        <span class="comment">// 解锁</span></span><br><span class="line">        m_mutex.<span class="built_in">unlock</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    Mutex m_mutex;</span><br><span class="line">    Condition m_cond;</span><br><span class="line">    std::list&lt;<span class="type">int</span>&gt; m_queue;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    TaskQueue queue;</span><br><span class="line">    queue.<span class="built_in">start</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">2</span>);</span><br><span class="line">        queue.<span class="built_in">push</span>(i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 阻塞等待输入，保持程序运行</span></span><br><span class="line">    std::<span class="built_in">getchar</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="线程池设计与实现">线程池设计与实现</h2><p>线程池的整体架构如下：</p><p><img src="https://aliyun-oss-zh.oss-cn-beijing.aliyuncs.com/img/QQ20251215-124752.jpg" alt=""></p><p>将后台服务的每个客户端请求抽象并封装为一个任务<code>Task</code> ，这些任务交给任务分发<code>TaskDispatcher</code>来管理，它维护了一个任务队列。它接收到的任务都会存放至该队列中，该队列中如果有任务就被取出并交由线程池<code>ThreadPool</code>来处理。线程池中会维护一个工作线程的队列，初始时这些工作线程处于空闲状态，当线程池接收到任务分发分配过来的一个任务时，它会从这些空闲的工作线程中取出一个工作线程来处理该任务。该线程接收到该任务后其状态会从空闲状态转变为忙碌状态 ，然后开始执行此任务直到任务结束，任务执行结束后该工作线程会被线程池回收，会被重新放回至工作线程的队列中。然后这些空闲的工作线程等待任务分发分配下一个任务，继续检查任务队列中有无新的任务。</p><p>在整个架构中并对于后台服务来讲，任务的创建是在一个主线程中的，任务的分发是在另一个子线程中，如此可将任务创建和任务分发分离开来，以最大提升并发的性能。线程池接收到任务后，会有空闲的工作线程去执行它，所以线程池整体设计中有3种类型的线程：</p><ol><li>任务创建(主线程)</li><li>任务分发</li><li>线程池中的工作线程</li></ol><h3 id="任务">任务</h3><p>线程池应支持各种类型的任务，尽量通用以支撑各种业务功能。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// thread/task.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> thread</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Task</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">Task</span>();</span><br><span class="line">            <span class="built_in">Task</span>(<span class="type">void</span> * data);</span><br><span class="line">            <span class="keyword">virtual</span> ~<span class="built_in">Task</span>();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取m_data指针</span></span><br><span class="line">            <span class="function"><span class="type">void</span> * <span class="title">get_data</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="comment">// 设置m_data指针</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">set_data</span><span class="params">(<span class="type">void</span> * data)</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 任务的执行</span></span><br><span class="line">            <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">run</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// 任务的销毁</span></span><br><span class="line">            <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">destroy</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">protected</span>:</span><br><span class="line">            <span class="comment">// m_data指向的内容具体由业务决定</span></span><br><span class="line">            <span class="type">void</span> * m_data;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// thread/task.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread/task.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::thread;</span><br><span class="line"></span><br><span class="line">Task::<span class="built_in">Task</span>() : <span class="built_in">m_data</span>(<span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Task::<span class="built_in">Task</span>(<span class="type">void</span> * data) : <span class="built_in">m_data</span>(data)</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Task::~<span class="built_in">Task</span>()</span><br><span class="line">&#123;</span><br><span class="line">    m_data = <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> * <span class="title">Task::get_data</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Task::set_data</span><span class="params">(<span class="type">void</span> * data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_data = data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="工作线程">工作线程</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// thread/worker_thread.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread/thread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread/mutext.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread/condition.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread/task.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> thread</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">WorkerThread</span> : <span class="keyword">public</span> Thread</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">WorkerThread</span>();</span><br><span class="line">            ~<span class="built_in">WorkerThread</span>();</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">run</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line">            <span class="comment">// 线程池给工作线程分配任务</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">assign</span><span class="params">(Task * task)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="comment">// 工作线程具体处理的任务</span></span><br><span class="line">            Task * m_task;</span><br><span class="line">            Mutex m_mutex;</span><br><span class="line">            Condition m_cond;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// thread/worker_thread.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread/worker_thread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::thread;</span><br><span class="line"></span><br><span class="line">WorkerThread::<span class="built_in">WorkerThread</span>() : <span class="built_in">Thread</span>(), <span class="built_in">m_task</span>(<span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">WorkerThread::~<span class="built_in">WorkerThread</span>()</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">WorkerThread::run</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 工作线程不接收任何操作系统信号，信号由主线程处理</span></span><br><span class="line">    <span class="type">sigset_t</span> mask;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">sigfillset</span>(&amp;mask) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;worker thread sigfillset error!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 工作线程屏蔽掉信号，信号由主线程处理</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">pthread_sigmask</span>(SIG_SETMASK, &amp;mask, <span class="literal">nullptr</span>) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;worker thread pthread_sigmask error!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">pthread_cleanup_push</span>(cleanup, <span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 使用信号量先加锁</span></span><br><span class="line">        m_mutex.<span class="built_in">lock</span>();</span><br><span class="line">        <span class="keyword">while</span> (m_task == <span class="literal">nullptr</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 工作线程等待一个任务的到来</span></span><br><span class="line">            m_cond.<span class="built_in">wait</span>(&amp;m_mutex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 解锁</span></span><br><span class="line">        m_mutex.<span class="built_in">unlock</span>();</span><br><span class="line">        <span class="comment">// 在工作线程处理任务期间不允许其被其它线程干掉，因此其应屏蔽其它线程给它发送的CANCEL指令</span></span><br><span class="line">        <span class="type">int</span> rc = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> old_state = <span class="number">0</span>;</span><br><span class="line">        rc = <span class="built_in">pthread_setcancelstate</span>(PTHREAD_CANCEL_DISABLE, &amp;old_state);</span><br><span class="line">        <span class="comment">// 执行任务</span></span><br><span class="line">        m_task-&gt;<span class="built_in">run</span>();</span><br><span class="line">        <span class="comment">// 销毁任务</span></span><br><span class="line">        m_task-&gt;<span class="built_in">destroy</span>();</span><br><span class="line">        <span class="comment">// 工作已将当前任务处理完毕，注意将m_task置空</span></span><br><span class="line">        m_task = <span class="literal">nullptr</span>;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span>线程池回收该工作线程</span></span><br><span class="line">        <span class="comment">// 工作线程处理完任务空闲时允许其被其它线程CANCEL掉</span></span><br><span class="line">        rc = <span class="built_in">pthread_setcancelstate</span>(PTHREAD_CANCEL_ENABLE, &amp;old_state);</span><br><span class="line">        <span class="built_in">pthread_testcancel</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">pthread_cleanup_pop</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">WorkerThread::assign</span><span class="params">(Task * task)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 加锁</span></span><br><span class="line">    m_mutex.<span class="built_in">lock</span>();</span><br><span class="line">    <span class="comment">// 分配任务</span></span><br><span class="line">    m_task = task;</span><br><span class="line">    <span class="comment">// 发送信号</span></span><br><span class="line">    m_cond.<span class="built_in">signal</span>();</span><br><span class="line">    <span class="comment">// 解锁</span></span><br><span class="line">    m_mutex.<span class="built_in">unlock</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">WorkerThread::cleanup</span><span class="params">(<span class="type">void</span> * ptr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">log_info</span>(<span class="string">&quot;worker thread cleanup handler: %x&quot;</span>, ptr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="线程池">线程池</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// thread/thread_pool.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;list&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread/worker_thread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread/auto_lock.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> thread</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">ThreadPool</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">SINGLETON</span>(ThreadPool);</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="comment">// 创建指定数量的工作线程</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">create</span><span class="params">(<span class="type">int</span> threads)</span></span>;</span><br><span class="line">            <span class="comment">// 线程池给工作线程分配任务</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">assign</span><span class="params">(Task * task)</span></span>;</span><br><span class="line">            <span class="comment">// 从线程池中获取一个空闲的工作线程</span></span><br><span class="line">            <span class="function">WorkerThread * <span class="title">get</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="comment">// 工作线程处理完任务后，将该空闲的工作线程放回队列中</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">put</span><span class="params">(WorkerThread * thread)</span></span>;</span><br><span class="line">            <span class="comment">// 判断线程池中是否有空闲的工作线程</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">empty</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="comment">// 线程池中工作线程的数量</span></span><br><span class="line">            <span class="type">int</span> m_threads = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// 存储空闲工作线程的列表</span></span><br><span class="line">            std::list&lt;WorkerThread*&gt; m_pool; </span><br><span class="line">            Mutex m_mutex;</span><br><span class="line">            Condition m_cond;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// thread/thread_pool.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread/thread_pool.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::thread;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ThreadPool::create</span><span class="params">(<span class="type">int</span> threads)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">AutoLock <span class="title">lock</span><span class="params">(&amp;m_mutex)</span></span>;</span><br><span class="line">    m_threads = threads;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; m_threads; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">auto</span> thread = <span class="keyword">new</span> <span class="built_in">WorkerThread</span>();</span><br><span class="line">        m_pool.<span class="built_in">push_back</span>(thread);</span><br><span class="line">        thread-&gt;<span class="built_in">start</span>();</span><br><span class="line">        <span class="built_in">log_debug</span>(<span class="string">&quot;create worker thread %x&quot;</span>, thread);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// AutoLock析构函数中会自动解锁</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ThreadPool::assign</span><span class="params">(Task * task)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> thread = <span class="built_in">get</span>();</span><br><span class="line">    thread-&gt;<span class="built_in">assign</span>(task);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">WorkerThread * <span class="title">ThreadPool::get</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">AutoLock <span class="title">lock</span><span class="params">(&amp;m_mutex)</span></span>;</span><br><span class="line">    <span class="keyword">while</span> (m_pool.<span class="built_in">empty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        m_cond.<span class="built_in">wait</span>(&amp;m_mutex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">auto</span> thread = m_pool.<span class="built_in">front</span>();</span><br><span class="line">    m_pool.<span class="built_in">pop_front</span>();</span><br><span class="line">    <span class="keyword">return</span> thread;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ThreadPool::put</span><span class="params">(WorkerThread * thread)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">AutoLock <span class="title">lock</span><span class="params">(&amp;m_mutex)</span></span>;</span><br><span class="line">    m_pool.<span class="built_in">push_back</span>(thread);</span><br><span class="line">    m_cond.<span class="built_in">signal</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">ThreadPool::empty</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">AutoLock <span class="title">lock</span><span class="params">(&amp;m_mutex)</span></span>;</span><br><span class="line">    <span class="keyword">return</span> m_pool.<span class="built_in">empty</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="任务分发">任务分发</h3><p>任务分发是在子线程中做的。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// thread/task_dispatcher.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;list&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread/thread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread/thread_pool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread/task.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> thread</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 任务分发是在子线程中做的</span></span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">TaskDispatcher</span> : <span class="keyword">public</span> Thread</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">SINGLETON</span>(TaskDispatcher);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="comment">// 初始化需要分配多大的线程池，任务分发底层的任务都是由线程池处理</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">init</span><span class="params">(<span class="type">int</span> threads)</span></span>;</span><br><span class="line">            <span class="comment">// 将任务加入到任务队列中</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">assign</span><span class="params">(Task * task)</span></span>;</span><br><span class="line">            <span class="comment">// 处理某个任务，交由线程池来处理</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">handle</span><span class="params">(Task * task)</span></span>;</span><br><span class="line">            <span class="comment">// 判断任务队列是否为空</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">empty</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">run</span><span class="params">()</span></span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="comment">// 任务队列</span></span><br><span class="line">            std::list&lt;Task*&gt; m_queue;</span><br><span class="line">            Mutex m_mutex;</span><br><span class="line">            Condition m_cond;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// thread/task_dispatcher.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread/task_dispatcher.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::thread;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">TaskDispatcher::init</span><span class="params">(<span class="type">int</span> threads)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Singleton&lt;ThreadPool&gt;::<span class="built_in">instance</span>()-&gt;<span class="built_in">create</span>(threads);</span><br><span class="line">    <span class="comment">// 子线程运行</span></span><br><span class="line">    <span class="built_in">start</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">TaskDispatcher::assign</span><span class="params">(Task * task)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">log_debug</span>(<span class="string">&quot;task dispatcher assign task: %x&quot;</span>, task);</span><br><span class="line">    <span class="function">AutoLock <span class="title">lock</span><span class="params">(&amp;m_mutex)</span></span>;</span><br><span class="line">    m_queue.<span class="built_in">push_back</span>(task);</span><br><span class="line">    m_cond.<span class="built_in">signal</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">TaskDispatcher::handle</span><span class="params">(Task * task)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> pool = Singleton&lt;ThreadPool&gt;::<span class="built_in">instance</span>();</span><br><span class="line">    <span class="keyword">if</span> (!pool-&gt;<span class="built_in">empty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 线程池中若有空闲的工作线程，则直接给工作线程分配任务</span></span><br><span class="line">        pool-&gt;<span class="built_in">assign</span>(task);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        AutoLock <span class="built_in">lock</span>(&amp;m_mutex);</span><br><span class="line">        m_queue.<span class="built_in">push_back</span>(task);</span><br><span class="line">        <span class="built_in">log_warn</span>(<span class="string">&quot;all threads are busy!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">TaskDispatcher::empty</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">AutoLock <span class="title">lock</span><span class="params">(&amp;m_mutex)</span></span>;</span><br><span class="line">    <span class="keyword">return</span> m_queue.<span class="built_in">empty</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">TaskDispatcher::run</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// TaskDispatcher是在子线程中运行的，不希望该子线程接收到信号，因此需屏蔽掉所有信号</span></span><br><span class="line">    <span class="type">sigset_t</span> mask;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">sigfillset</span>(&amp;mask) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;task dispatcher sigfillset error!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">pthread_sigmask</span>(SIG_SETMASK, &amp;mask, <span class="literal">nullptr</span>) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;task dispatcher pthread_sigmask error!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        m_mutex.<span class="built_in">lock</span>();</span><br><span class="line">        <span class="keyword">while</span> (m_queue.<span class="built_in">empty</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            m_cond.<span class="built_in">wait</span>(&amp;m_mutex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">auto</span> task = m_queue.<span class="built_in">front</span>();</span><br><span class="line">        m_queue.<span class="built_in">pop_front</span>();</span><br><span class="line">        m_mutex.<span class="built_in">unlock</span>();</span><br><span class="line">        <span class="built_in">handle</span>(task);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="线程池应用">线程池应用</h2><p>首先定义线程池具体处理的任务：</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CMakeLists.txt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.19</span>)</span><br><span class="line"><span class="keyword">project</span>(pthread)</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD <span class="number">11</span>)</span><br><span class="line"><span class="keyword">include_directories</span>(./)</span><br><span class="line"><span class="keyword">file</span>(GLOB_RECURSE SOURCES <span class="string">&quot;utility/*.cpp&quot;</span> <span class="string">&quot;thread/*.cpp&quot;</span> <span class="string">&quot;task/*.cpp&quot;</span>)</span><br><span class="line"><span class="keyword">add_executable</span>(main <span class="variable">$&#123;SOURCES&#125;</span> main.cpp)</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// task/test_task.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread/task.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::thread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> task</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">TestTask</span> : <span class="keyword">public</span> Task</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">TestTask</span>(<span class="type">int</span> * num) : <span class="built_in">Task</span>((<span class="type">void</span>*)num)&#123;&#125;</span><br><span class="line">            ~<span class="built_in">TestTask</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">run</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">destroy</span><span class="params">()</span></span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// task/test_task.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;task/test_task.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::task;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">TestTask::run</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;test task run\n&quot;</span>);</span><br><span class="line">    <span class="type">int</span> * num = <span class="built_in">static_cast</span>&lt;<span class="type">int</span>*&gt;(m_data);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;num: %d\n&quot;</span>, *num);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">TestTask::destroy</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;test task destroy\n&quot;</span>);</span><br><span class="line">    <span class="comment">// 任务销毁时释放掉m_data</span></span><br><span class="line">    <span class="keyword">delete</span> <span class="built_in">static_cast</span>&lt;<span class="type">int</span>*&gt;(m_data);</span><br><span class="line">    <span class="comment">// 将任务本身也释放掉</span></span><br><span class="line">    <span class="keyword">delete</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>同时在<code>WorkerThread::run()</code>中在执行完任务并销毁任务后记得线程池要回收该工作线程：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// thread/worker_thread.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread/thread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread/mutext.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread/condition.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread/task.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility/logger.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::utility;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> thread</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">WorkerThread</span> : <span class="keyword">public</span> Thread</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">WorkerThread</span>();</span><br><span class="line">            ~<span class="built_in">WorkerThread</span>();</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">run</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line">            <span class="comment">// 由线程池调用，给工作线程分配任务</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">assign</span><span class="params">(Task * task)</span></span>;</span><br><span class="line">            <span class="comment">// 工作线程退出时清理自己</span></span><br><span class="line">            <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">cleanup</span><span class="params">(<span class="type">void</span> * ptr)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="comment">// 工作线程具体处理的任务</span></span><br><span class="line">            Task * m_task;</span><br><span class="line">            Mutex m_mutex;</span><br><span class="line">            Condition m_cond;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread/worker_thread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread/thread_pool.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::thread;</span><br><span class="line"></span><br><span class="line">WorkerThread::<span class="built_in">WorkerThread</span>() : <span class="built_in">Thread</span>(), <span class="built_in">m_task</span>(<span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">WorkerThread::~<span class="built_in">WorkerThread</span>()</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">WorkerThread::run</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 工作线程不接收任何操作系统信号，信号由主线程处理</span></span><br><span class="line">    <span class="type">sigset_t</span> mask;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">sigfillset</span>(&amp;mask) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;worker thread sigfillset error!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 工作线程屏蔽掉信号，信号由主线程处理</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">pthread_sigmask</span>(SIG_SETMASK, &amp;mask, <span class="literal">nullptr</span>) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;worker thread pthread_sigmask error!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">pthread_cleanup_push</span>(cleanup, <span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 使用信号量先加锁</span></span><br><span class="line">        m_mutex.<span class="built_in">lock</span>();</span><br><span class="line">        <span class="keyword">while</span> (m_task == <span class="literal">nullptr</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 工作线程等待一个任务的到来</span></span><br><span class="line">            m_cond.<span class="built_in">wait</span>(&amp;m_mutex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 解锁</span></span><br><span class="line">        m_mutex.<span class="built_in">unlock</span>();</span><br><span class="line">        <span class="comment">// 在工作线程处理任务期间不允许其被其它线程干掉，因此其应屏蔽其它线程给它发送的CANCEL指令</span></span><br><span class="line">        <span class="type">int</span> rc = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> old_state = <span class="number">0</span>;</span><br><span class="line">        rc = <span class="built_in">pthread_setcancelstate</span>(PTHREAD_CANCEL_DISABLE, &amp;old_state);</span><br><span class="line">        <span class="comment">// 执行任务</span></span><br><span class="line">        m_task-&gt;<span class="built_in">run</span>();</span><br><span class="line">        <span class="comment">// 销毁任务</span></span><br><span class="line">        m_task-&gt;<span class="built_in">destroy</span>();</span><br><span class="line">        <span class="comment">// 工作已将当前任务处理完毕，注意将m_task置空</span></span><br><span class="line">        m_task = <span class="literal">nullptr</span>;</span><br><span class="line">        <span class="comment">// 线程池回收该工作线程</span></span><br><span class="line">        Singleton&lt;ThreadPool&gt;::<span class="built_in">instance</span>()-&gt;<span class="built_in">put</span>(<span class="keyword">this</span>);</span><br><span class="line">        <span class="comment">// 工作线程处理完任务空闲时允许其被其它线程CANCEL掉</span></span><br><span class="line">        rc = <span class="built_in">pthread_setcancelstate</span>(PTHREAD_CANCEL_ENABLE, &amp;old_state);</span><br><span class="line">        <span class="built_in">pthread_testcancel</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">pthread_cleanup_pop</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">WorkerThread::assign</span><span class="params">(Task * task)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 加锁</span></span><br><span class="line">    m_mutex.<span class="built_in">lock</span>();</span><br><span class="line">    <span class="comment">// 分配任务</span></span><br><span class="line">    m_task = task;</span><br><span class="line">    <span class="comment">// 发送信号</span></span><br><span class="line">    m_cond.<span class="built_in">signal</span>();</span><br><span class="line">    <span class="comment">// 解锁</span></span><br><span class="line">    m_mutex.<span class="built_in">unlock</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">WorkerThread::cleanup</span><span class="params">(<span class="type">void</span> * ptr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">log_info</span>(<span class="string">&quot;worker thread cleanup handler: %x&quot;</span>, ptr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;task/test_task.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread/task_dispatcher.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::task;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::thread;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 初始化日志</span></span><br><span class="line">    <span class="keyword">auto</span> logger = Singleton&lt;Logger&gt;::<span class="built_in">instance</span>();</span><br><span class="line">    logger-&gt;<span class="built_in">open</span>(<span class="string">&quot;./main.log&quot;</span>);</span><br><span class="line">    logger-&gt;<span class="built_in">set_console</span>(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化线程池和任务队列</span></span><br><span class="line">    <span class="type">int</span> threads = <span class="number">16</span>;</span><br><span class="line">    Singleton&lt;TaskDispatcher&gt;::<span class="built_in">instance</span>()-&gt;<span class="built_in">init</span>(threads);</span><br><span class="line">    <span class="comment">// 主线程模拟给TaskDispatcher创建任务</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> * num = <span class="keyword">new</span> <span class="type">int</span>;</span><br><span class="line">        *num = i;</span><br><span class="line">        <span class="keyword">auto</span> task = <span class="keyword">new</span> <span class="built_in">TestTask</span>(num);</span><br><span class="line">        Singleton&lt;TaskDispatcher&gt;::<span class="built_in">instance</span>()-&gt;<span class="built_in">assign</span>(task);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 阻塞等待输入，保持程序运行</span></span><br><span class="line">    std::<span class="built_in">getchar</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>简单总结，使用线程池首先需要定义具体的任务，比如<code>TestTask</code>，它应继承自<code>Task</code>类并实现任务执行<code>run()</code>和任务销毁<code>destroy()</code>接口，由具体业务逻辑而定。定义好具体任务后即可使用线程池，引入<code>task_dispatcher.h</code>头文件，调用<code>TaskDispatcher::init()</code>以初始化线程池和任务队列，然后调用<code>TaskDispatcher::assign()</code>接口将具体任务分发给<code>TaskDispatcher</code>进行处理。</p>]]></content>
      
      
      
        <tags>
            
            <tag> C++后端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>《计算机架构性能评估方法》第四章 分析性能建模</title>
      <link href="/2024/11/22/%E3%80%8A%E8%AE%A1%E7%AE%97%E6%9C%BA%E6%9E%B6%E6%9E%84%E6%80%A7%E8%83%BD%E8%AF%84%E4%BC%B0%E6%96%B9%E6%B3%95%E3%80%8B-%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E5%88%86%E6%9E%90%E6%80%A7%E8%83%BD%E5%BB%BA%E6%A8%A1/"/>
      <url>/2024/11/22/%E3%80%8A%E8%AE%A1%E7%AE%97%E6%9C%BA%E6%9E%B6%E6%9E%84%E6%80%A7%E8%83%BD%E8%AF%84%E4%BC%B0%E6%96%B9%E6%B3%95%E3%80%8B-%E7%AC%AC%E5%9B%9B%E7%AB%A0-%E5%88%86%E6%9E%90%E6%80%A7%E8%83%BD%E5%BB%BA%E6%A8%A1/</url>
      
        <content type="html"><![CDATA[<h1 id="计算机架构性能评估方法-第四章-分析性能建模">《计算机架构性能评估方法》第四章 分析性能建模</h1><blockquote><p>Copyright © 2010 by Morgan &amp; Claypool<br>All rights reserved. No part of this publication may be reproduced, stored in a retrieval system, or transmitted in<br>any form or by any means—electronic, mechanical, photocopy, recording, or any other except for brief quotations in<br>printed reviews, without the prior permission of the publisher.<br>Computer Architecture Performance Evaluation Methods<br>Lieven Eeckhout<br><a href="http://www.morganclaypool.com">www.morganclaypool.com</a><br>ISBN: 9781608454679 paperback<br>ISBN: 9781608454686 ebook<br>DOI 10.2200/S00273ED1V01Y201006CAC010<br>A Publication in the Morgan &amp; Claypool Publishers series<br>SYNTHESIS LECTURES ON COMPUTER ARCHITECTURE<br>Lecture #10<br>Series Editor: Mark D. Hill, University of Wisconsin<br>Series ISSN<br>Synthesis Lectures on Computer Architecture<br>Print 1935-3235 Electronic 1935-3243</p></blockquote><p>分析性能建模是一种重要的性能评估方法，在过去几年中得到了越来越多的关注。与流行的仿真方法相比，分析建模可能不太准确，但它比仿真快好几个数量级：甚至可以立即获得性能估计结果，因为这就是一个计算有限数量公式的问题，最多几秒钟或者几分钟内就可以完成。仿真则很可能花费数小时、数天甚至数周的时间。</p><p>由于其巨大的速度优势，分析建模可以非常快速地探索巨大的架构设计空间，这使其在设计周期的早期阶段非常有用，甚至可以探索难以通过仿真探索的巨大设计空间。换句话说，分析建模可用于快速识别感兴趣的区域，然后通过仿真对其进行更详细的探索。<em>Lee</em>和<em>Brooks</em>所做的一项研究说明了分析建模在探索大型设计空间方面的力量，该研究探索了自适应微架构的潜力，它同时改变了微架构的适应性和适应的时间粒度——这是一项通过详细的周期精确的仿真无法实现的研究。</p><p>此外，分析建模提供了更多基本的洞察力。虽然仿真也提供了有价值的见解，但它需要许多仿真来理解性能对设计参数的敏感性。相反，在分析建模中，灵敏度可以从公式本身看出来。比如<em>Hill</em>和<em>Marty</em>将<em>Amdahl</em>定律扩展到多核处理器。他们用一个简单的硬件<em>cost model</em>增强了<em>Amdahl</em>定律，并探讨了对称(同质)、非对称(异构)和动态多核处理的影响。尽管它很简单，但它提供了基本的见解，并揭示了多核时代的各种重要成果。</p><h2 id="4-1-经验建模与机械建模">4.1 经验建模与机械建模</h2><p>在本章中，我们将分析性能建模的最新工作分为三大类：经验建模、机械建模和经验-机械混合建模。机械建模基于第一原则构建性能模型，也就是说，性能模型是基于对底层系统机制的基本理解，以自底向上的方式构建的。机械建模可以看作是“白盒”性能建模，它的主要特征是提供基本的洞察力，并可能产生新的知识。另一方面，经验建模通过“黑盒”方法构建性能模型。经验建模通常利用统计推断和机器学习技术，比如回归建模或神经网络，从训练数据中自动学习出性能模型。虽然由于底层系统的复杂性，通过经验建模推断性能模型更容易，但它通常比机械建模提供更少的洞察力。机械-经验混合建模方法是机械建模和经验建模的折中，它可以被视为“灰盒”建模。混合机械-经验模型从一个通用的性能公式开始，该公式来源于对底层系统的见解；然而，这个公式包含了一些未知的参数。然后通过拟合(比如回归)来推断这些未知参数，类似于经验建模。混合机械-经验建模的动机是它提供了洞察力（它继承自机械建模），同时简化了性能模型的构建（它继承自经验建模）。</p><p>尽管区分了经验建模和机械建模，但并不存在纯粹的经验建模或机械建模。例如在建模假设和近似中，机械建模总是包含某种形式的经验主义。同样地，经验建模总是包含一个机械组件，例如，在模型的输入列表中—模型输入列表是基于对底层系统的一些理解构建的。因此，经验建模和机械建模之间的区别是相对的，我们的分类基于建模中经验与机械的支配地位，现在将更详细地描述这三种建模方法。</p><h2 id="4-2-经验建模">4.2 经验建模</h2><p>虽然经验建模允许用户将领域知识嵌入到模型中，但没有这些先验知识依然能构建出有效的模型。这种灵活性可能解释了这种建模技术最近的流行性。不同的研究小组提出了不同的经验建模方法，这里将重新讨论。</p><h3 id="4-2-1-线性回归">4.2.1 线性回归</h3><p>线性回归是一种广泛使用的经验建模方法，它将响应变量与许多输入参数联系起来。<em>Joseph</em>等人将该技术应用于处理器性能建模，并建立了将微架构参数(以及它们之间的一些交互)与处理器整体性能联系起来的线性回归模型。他们只使用线性回归来检验设计参数的显著性，即他们没有使用线性回归进行预测建模。在这个意义上，线性回归类似于前面章节讨论的PCA和Plackett-Burman方法。接下来将讨论更先进的回归技术，包括非线性和基于样条的回归，它们已经成功地应用于预测建模。由于更高级的回归方法是在线性回归的基础上进行扩展的，所以在这里先讲述下线性回归。</p><p>线性回归最简单的形式是：</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo>=</mo><msub><mi>β</mi><mn>0</mn></msub><mo>+</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><msub><mi>β</mi><mi>i</mi></msub><msub><mi>x</mi><mi>i</mi></msub><mo>+</mo><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">y=\beta_0 + \sum_{i=1}^n \beta_i x_i + \epsilon</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05278em;">β</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.05278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:2.929066em;vertical-align:-1.277669em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6513970000000002em;"><span style="top:-1.872331em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3000050000000005em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.277669em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05278em;">β</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.05278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">ϵ</span></span></span></span></span></p><p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span></span></span></span>是因变量，也被称为响应变量，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">x_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>是自变量，也称为输入变量，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">\epsilon</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">ϵ</span></span></span></span>是由于未拟合产生的误差项。<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>β</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\beta_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05278em;">β</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.05278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>系数表示输入变量<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">x_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>每单位变化对应因变量<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span></span></span></span>的期望变化，即回归系数代表了各自变量的显著性或重要性。线性回归模型可能会将性能(因变量)与一组微架构参数(自变量)联系起来，后者可以是处理器带宽、管道深度、缓存大小、缓存延迟等。换句话说，线性回归尝试找到许多数据点的最佳线性拟合，如图4.1所示。</p><p><img src="https://aliyun-oss-zh.oss-cn-beijing.aliyuncs.com/img/QQ20241218-011011.jpg" alt=""></p><p>这个简单的线性回归模型假设输入变量是彼此独立的，即变量<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">x_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>对因变量<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span></span></span></span>的影响不依赖于<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">x_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>的值，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi><mo mathvariant="normal">≠</mo><mi>i</mi></mrow><annotation encoding="application/x-tex">j\neq i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel"><span class="mrel"><span class="mord"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.69444em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="rlap"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="inner"><span class="mrel"></span></span><span class="fix"></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.19444em;"><span></span></span></span></span></span></span><span class="mrel">=</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathdefault">i</span></span></span></span>。在许多情况下，这不是一个准确的假设，特别是在计算机体系结构中。比如使得处理器流水线更深对性能的影响取决于内存层次结构的配置。更激进的内存层次结构可以减少<em>cache</em>未命中率，从而减少访存平均耗时并增加流水线的优势。因此，在回归模型中是有可能要考虑变量间的相互影响：</p>]]></content>
      
      
      
        <tags>
            
            <tag> 计算机体系结构 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>《计算机架构性能评估方法》第五章 仿真</title>
      <link href="/2024/11/06/%E3%80%8A%E8%AE%A1%E7%AE%97%E6%9C%BA%E6%9E%B6%E6%9E%84%E6%80%A7%E8%83%BD%E8%AF%84%E4%BC%B0%E6%96%B9%E6%B3%95%E3%80%8B-%E7%AC%AC%E4%BA%94%E7%AB%A0-%E4%BB%BF%E7%9C%9F/"/>
      <url>/2024/11/06/%E3%80%8A%E8%AE%A1%E7%AE%97%E6%9C%BA%E6%9E%B6%E6%9E%84%E6%80%A7%E8%83%BD%E8%AF%84%E4%BC%B0%E6%96%B9%E6%B3%95%E3%80%8B-%E7%AC%AC%E4%BA%94%E7%AB%A0-%E4%BB%BF%E7%9C%9F/</url>
      
        <content type="html"><![CDATA[<h1 id="计算机架构性能评估方法-第五章-仿真">《计算机架构性能评估方法》第五章 仿真</h1><blockquote><p>Copyright © 2010 by Morgan &amp; Claypool<br>All rights reserved. No part of this publication may be reproduced, stored in a retrieval system, or transmitted in<br>any form or by any means—electronic, mechanical, photocopy, recording, or any other except for brief quotations in<br>printed reviews, without the prior permission of the publisher.<br>Computer Architecture Performance Evaluation Methods<br>Lieven Eeckhout<br><a href="http://www.morganclaypool.com">www.morganclaypool.com</a><br>ISBN: 9781608454679 paperback<br>ISBN: 9781608454686 ebook<br>DOI 10.2200/S00273ED1V01Y201006CAC010<br>A Publication in the Morgan &amp; Claypool Publishers series<br>SYNTHESIS LECTURES ON COMPUTER ARCHITECTURE<br>Lecture #10<br>Series Editor: Mark D. Hill, University of Wisconsin<br>Series ISSN<br>Synthesis Lectures on Computer Architecture<br>Print 1935-3235 Electronic 1935-3243</p></blockquote><p>仿真是计算机体系结构中普遍使用的性能评估方法。它被广泛使用有以下几个原因：</p><ol><li>分析建模方法尽管评估速度非常快，并且提供了深刻的洞察力，但对于架构师需要做出很多的设计决策而言引入了太多的不准确性。分析建模对于制定高层次设计决策和在庞大设计空间中识别感兴趣的区域非常有价值，然后使用分析建模方法很难评估各种设计方法导致的细微性能变化。</li><li>另一方面，硬件原型虽然非常准确，但开发起来非常耗时且昂贵。</li></ol><p>仿真器<em>sinmulator</em>是处理器体系架构的性能模型软件。仿真器所建模的处理器架构称为目标架构，在物理机器上运行仿真器就能得到性能结果。相较于构建硬件原型相比仿真有着非常重大优势，它开发相对便宜，并且通常比分析建模要准确得多。此外，仿真器非常灵活且易于参数化，这样便于探索架构设计空间，评估一个新颖的设计想法，这对于计算机架构师设计一个处理器和相关的研究者而言是非常重要的特性。比如，可以通过参数化，比如改变仿真器某些参数并在各种<em>benchmark</em>上跑仿真就能评估<em>cache</em>大小、延迟、处理器带宽和分支预测器的影响，评估出一个架构特性所带来的影响。仿真甚至能对当今非常不同的体系架构进行评估。</p><h2 id="5-1-计算机架构师的工具箱">5.1 计算机架构师的工具箱</h2><p>仿真有很多方法，每种方法代表了在准确性、评估时间、开发时间和覆盖范围间进行取舍。精度是指仿真模型相较于真实硬件的保真度，评估时间是指跑一次仿真需要多长时间，开发时间是指开发仿真器的所需时间，最后覆盖范围是指仿真器能探索的设计空间大小，例如一个<em>cache</em>仿真器仅能被用于评估计算机<em>cache</em>性能，而不是处理器的整体性能。</p><p>仿真器的权衡/取舍可以描述为图5.1所示的菱形，每种仿真方法或者一般的建模工作都可以按照这四个维度进行表征描述。这些维度不是彼此相互独立的，事实上它们是相互矛盾的。例如，通过建模附加特性可以对真实硬件进行更忠实地建模，这样增加了仿真器的覆盖范围，提高了仿真的准确度，但同时也增加了仿真器的开发时间和评估时间，因为仿真器将构建得更加复杂，并且由于增加的复杂度，会导致仿真跑得更慢执行时间更长。相反，如果一个仿真器仅对整个系统的一个组件进行建模，比如针对分支预测器或者<em>cache</em>，虽然相较于整个系统覆盖范围有限，但由于其相对简单且跑起来很快，开发时间和评估时间就会短，对于研究的组件的准确度就会很高非常有价值。</p><p><img src="https://aliyun-oss-zh.oss-cn-beijing.aliyuncs.com/img/QQ%E6%88%AA%E5%9B%BE20241106014117.jpg" alt=""></p><p>后续部分会描述计算架构师工具箱中常用的几种仿真技术，每种仿真技术代表了在准确性、覆盖率、开发时间和评估时间方面的不同权衡取舍。表5-1总结了四个维度上不同的仿真技术。</p><p><img src="https://aliyun-oss-zh.oss-cn-beijing.aliyuncs.com/img/QQ20241110-210115.jpg" alt=""></p><h2 id="5-2-功能性仿真">5.2 功能性仿真</h2><p>功能性仿真只对一个指令集架构<em>ISA</em>的功能特性进行建模，它不提供任何的时间估计。即任何一时刻仅仿真一个指令，获得输入值然后计算输出值。因此，功能性仿真器也被称为指令集模拟器。这些工具通常对于验证设计的正确性非常有用，而不适用于评估它的性能特征。所以，关于性能和实现细节的准确度和覆盖率是不适用的。然而，功能性仿真在开发时效方面很优秀，因为在硬件项目开发时通常已经就存在了功能仿真器，除非处理器实现了一套全新的指令集。功能仿真器具有很长的生命周期，它可以跨越许多开发项目。功能性仿真在评估时间方面很快，因为不需要对微架构特性进行建模。功能仿真器的例子是<em>sim-safe</em>和<em>sim-fast</em>。</p><h3 id="插桩">插桩</h3><p>功能仿真的另一种选择是插桩，也被称作直接执行。检测获取一个二进制文件并向其中添加代码，以便在实际硬件上运行经过插桩的二进制文件时收集感兴趣的属性。例如，如果目标是生成内存地址的追踪，则只需对可执行二进制文件中引用内存的每个指令进行检测，然后在本机硬件上运行经过插桩的二进制可执行文件就能得到对内存地址的追踪。插桩相较于功能性仿真的优势在于它带来的开销更小。插桩在真实硬件上本地执行所有指令，相反功能性仿真模拟所有指令因此每条目标指令会执行更多的主机指令。存在两种检测类型：静态插桩只静态地插桩二进制文件；动态插桩在运行时动态地插桩运行的二进制机器指令。静态插桩的例子是<em>Atom</em>和<em>EEL</em>，而<em>Embra</em>、<em>Shade</em>和<em>Pin</em>支持动态插桩。与功能性仿真相比，插桩的局限性在于目标指令集架构通常与主机的指令集架构相同，因此插桩框架不容易移植。就像<em>Shader</em>框架中所做的那样，动态插桩二进制翻译器可以将主机指令集架构的指令翻译成目标指令集架构的指令来解决这个问题。但是，仿真器只能在实现了目标指令集架构的机器上运行。</p><p><img src="https://aliyun-oss-zh.oss-cn-beijing.aliyuncs.com/img/QQ20241110-214436.jpg" alt=""></p><p><em>Burtscher</em>和<em>Ganusov</em>提出了一种将插桩的速度和功能性仿真的可移植性相结合的方法，参见图5.2。他们提出一个功能性仿真器合成器，它将一个二进制可执行文件以及一个包含所有支持指令的C定义代码片段的文件作为输入，然后合成器将二进制指令翻译成C语句。如果需要，用户可以添加模拟代码来收集比如指令或地址的追踪。编译合成后C代码生成定制的功能仿真器。</p><h3 id="操作系统的影响">操作系统的影响</h3><p>功能性仿真通常仅限于用户级代码，比如应用程序和系统库代码，然而它并不能仿真模拟操作系统调用或中断时发生的情况。为了获得功能正确的执行，需要仿真模拟影响应用代码的操作系统影响。一种常见的方法是忽略中断并模拟操作系统调用的效果。仿真模拟系统调用通常是通过手动识别系统调用的输入寄存器、输出寄存器和内存状态，并本地调用系统调用来完成。对于每个系统调用都需要这么做，这是一项繁琐且费力的工作，特别是当希望将一个仿真器移植到新版本的操作系统或者非常不一样的操作系统上。</p><p><em>Narayanasamy</em>等人提出了一种自动捕捉操作系统交互副作用的技术，一个插桩的二进制代码收集每个执行的系统调用、中断和DMA传输，记录它如何改变寄存器状态和内存状态。只有当内存位置稍后被一个<em>load</em>操作读时才会记录内存状态的改变。具体是按如何方式做的：插桩的二进制代码维护应用程序地址空间的一份用户级副本。操作系统的影响诸如系统调用、中断和DMA传输，只会影响应用程序的地址空间，而不是用户级的副本。应用程序的写操作更新了应用程序的地址空间和用户级的副本。应用程序的读操作会验证在应用程序地址空间读到数据是否与用户级副本中读到的数据匹配，如果不匹配仿真器就判定是由于操作系统的影响导致应用程序状态的改变，因此它知道需要记录应用程序地址空间中的负载值，这些状态变化存储在一个称为操作系统影响的日志中。在功能性仿真期间，当触发一个系统调用时会读取操作系统影响日志，日志中记录的状态改变会重放一遍，即修改仿真模拟的寄存器和内存状态以模拟系统调用带来的影响。因为这个过程不依赖于系统调用的语义，它是完全自动的，这就简化了开发和移植用户级仿真器。这个技术的副作用是它支持确定性的仿真，即操作系统的影响在运行时是相同的。虽然这样有助于比较不同的设计方案，但它也有缺陷，将在5.6.2节中讨论。</p><h2 id="5-3-全系统仿真">5.3 全系统仿真</h2><p>用户级仿真对于一些工作负载<em>workload</em>已经足够准确了，比如<em>SPEC CPU benchmarks</em>花费很少时间执行系统级代码，因此将仿真模拟限制为用户级代码就足矣了。然而对于其它的工作负载<em>workload</em>，比如商业工作负载数据库服务器、web服务器、电子邮件服务器等等，对它们仅仅仿真模拟用户级代码是明显不够的，因为这些工作负载<em>workload</em>花费了相当多的时间执行系统级代码，因此这些工作负载<em>workload</em>需要全系统仿真模拟。此外，多核硬件的激增增加了全系统仿真的重要性，因为多线程负载<em>workload</em>性能会收到操作系统调度决策的影响，不对操作系统进行仿真模拟可能导致不准确的性能指标，因为这样没有考虑操作系统的影响。</p><p>全系统仿真是指仿真模拟整个计算机系统，这样使得完整的软件栈能跑在仿真模拟器上。软件栈包括应用程序以及未修改的商业操作系统，这样仿真包括IO和操作系统活动，其次是处理器和内存活动。换言之，全系统仿真可以被看做是一个系统仿真模拟器或者一个系统虚拟机，它对用户来说就是虚拟硬件，它给全系统仿真模拟器的用户提供了就像跑在真实硬件上的假象。比较知名的全系统仿真模拟器例子有<em>SimOS</em>、<em>SimICs</em>、<em>SimNow</em>、<em>M5</em>、<em>Bochs</em>、<em>QEMU</em>和<em>Mambo</em>。</p><p>全系统仿真模拟器提供的功能与用户级功能仿真模拟器基本相同，两者都是提供对动态执行指令的追踪，唯一的区别是功能仿真模拟器只仿真用户级代码指令，而全系统仿真模拟器要同时仿真模拟用户级和系统级代码。因此与用户级仿真相比，全系统仿真实现了更大的覆盖范围，然而开发一个全系统仿真器远非易事。</p><h2 id="5-4-专门追踪驱动仿真">5.4 专门追踪驱动仿真</h2><p>专门追踪驱动的仿真采用指令和地址跟踪，这些追踪可能只包括用户级指令，也可能同时包括用户级和系统级指令，来孤立地仿真目标架构的特定组件，比如<em>cache</em>或者分支预测器。性能表现通常以未命中率来评估。有很多被广泛使用的工具，特别是对于<em>cache</em>仿真有<em>Dinero IV</em>。此外，针对在一次仿真模拟运行中仿真多个<em>cache</em>配置已经提出了几条建议。虽然开发时间和评估时间都很好，但覆盖范围比较有限，因为只对一个处理器的特定组件进行了建模。而且虽然未命中率指标的准确性很好，但由于许多其它因素的影响，处理器整体性能仅与这些未命中率大致相关。专门的跟踪驱动仿真在工具箱中仍占有一席之地，因为它提供了一种评估处理器特定层面的一种轻松方法。</p><h2 id="5-5-追踪驱动仿真">5.5 追踪驱动仿真</h2><p>完整的追踪驱动仿真，或者简称未追踪驱动仿真，采用程序指令和地址追踪，并将完整的<em>benchmark</em>追踪提供给详细的微架构时序仿真模拟器。一个追踪驱动仿真器将功能仿真与时序仿真分离开来。这通常很有用，因为功能仿真只需要执行一次，而在评估不同微架构时详细的时序仿真要执行很多次。这种分离一定程度上减少了评估时间。总的来说，完整的追踪驱动仿真需要很长的开发时间，也需要很长的仿真执行时间，但它在准确性和覆盖率上都非常好。</p><p>这种方法的一个明显缺点是需要存储追踪文件，对于当前的基准测试和运行时间合唱的计算机程序而言，追踪文件可能非常大。虽然现在磁盘空间已经非常便宜，但是可以使用追踪压缩来解决这个问题，针对计算机追踪压缩已经提出了几种方法。</p><p>现代超标量处理器的另一个缺点是它们预测分支并推测地执行很多指令，沿着错误预测的推测执行指令后续将被取消。这些无效的指令不会显示在通过功能性仿真生成的追踪文件中，尽管它们可能影响<em>cache</em>或预测器的内容。因此追踪驱动仿真并不能准确地仿真模拟出沿着错误预测路径的影响。</p><p>模拟多线程工作负载<em>workload</em>时的另一个限制是追踪驱动仿真不能对线程间次序和目标微架构进行建模。原因是追踪是固定的，并且施加了特定的顺序。对于一些研究，这种影响可能是有限的，然而对于其它研究来说，这可能是重要的。这一切都取决于优化的类型和评估的工作负载。关键问题是某些微架构的变化，例如分支预测器、<em>cache</em>、预取器等，甚至是很小的变化就可能导致线程以不同的顺序获取锁。这可能会导致共享资源，比如缓存、内存、互联网络等出现不同的冲突和争用行为，进而影响线程的交错并行。因此，即使是微体系结构中的微小变化也可能导致非常不同的性能数字，并且这些变化可能对于特定的基准测试出现巨大差异，所以一个特定基准测试的大变化可能不能代表其它工作负载。由于追踪驱动仿真模拟的时单个线程次序，它并不能捕捉这些影响。此外，追踪可能反映甚至可能不会出现在目标微体系结构上的特定次序。</p><h2 id="5-6-执行驱动仿真">5.6 执行驱动仿真</h2><p>与追踪驱动仿真相比，执行驱动仿真结合了功能仿真和时序仿真。为了做到这一点，它消除了追踪驱动仿真的缺点，即不需要存储追踪文件，可以准确地模拟推测执行的指令，并且可以准确地建模多线程工作负载。由于以上这些原因，执行驱动仿真已经成为实际上常用的仿真方法。执行驱动的仿真器有<em>SimpleScalar</em>、<em>RSIM</em>、<em>Asim</em>、<em>M5</em>、<em>GEMS</em>、<em>Flexus</em>和<em>PLTSim</em>。尽管执行驱动仿真相比于追踪驱动仿真实现了更高的准确度，但它是以增加开发时间和评估时间为代价的。</p><h3 id="5-6-1-分类">5.6.1 分类</h3><p><em>Manuer</em>等人针对执行驱动仿真器提出了一种有用的分类方法，参见图5.3。该分类方法反映了四种不同的方式来耦合功能和时序组件，以管理仿真器的复杂性和开发时间。一个紧密集成功能和时序组件的执行驱动仿真器，因此被称为集成的执行驱动仿真器(见图5.3a)，显然更难以开发和维护。一个集成仿真器并不灵活，难以扩展(比如在评估新的体系架构时)，并且存在潜在的风险就是修改时序组件可能意外地往功能组件中引入错误。此外，如前所述，功能模型往往变化很小，然而，在架构探索的过程中时序模型可能会发生很大的变化。因此，从仿真器的复杂性和开发的角度来看，将功能部分与时序部分解耦开是可取的。现在讨论的解耦方法有很多种：</p><p><img src="https://aliyun-oss-zh.oss-cn-beijing.aliyuncs.com/img/QQ20241117-223327.jpg" alt=""></p><p><strong>时序驱动仿真</strong></p><p>时序驱动仿真器允许时序仿真器驱动功能仿真器去沿着错误预测的路径获取指令，并选择特定的线程交错(图5.3b)。<em>Asim</em>就是一个时序驱动的仿真器。功能模型跟踪体系结构的状态，比如寄存器和内存值。时序模型没有值的概念，相反它从功能模型中获取有效地址，并使用它来确定缓存是否命中，访问分支预测器等。功能模型可以被视为时序模型调用的一系列函数调用，以便在精确的模拟时间执行特定的功能任务。需要组织功能模型以使其能够部分地模拟指令。特别是功能仿真器需要解码、执行、执行内存操作(访存)、终止和提交指令的能力。然后时序模型会调用功能模型来在正确的时间以正确的顺序执行特定的任务。例如，当仿真在一个加载单元上执行<code>load</code>指令时，时序模型会要求功能模型计算<code>load</code>的有效地址。然后将这个地址发送回时序模型，该模型随后会确定这个<code>load</code>指令是否会发生一次<em>cache</em>未命中。根据时序模型，只有当<em>cache</em>命中访问返回或者<em>cache</em>未命中从内存返回时，功能仿真器才会从内存读取该值。这确保<code>load</code>指令读取到与目标体系结构完全相同的数据。当<code>load</code>提交进目标体系架构时，指令也同样提交进功能模型中。功能模型还跟踪足够的内部状态，以便在发现指令沿着错误预测路径执行时可以在功能模型中终止该指令。</p><p><strong>功能优先仿真</strong></p><p>在功能优先仿真模型(图5.3c)中，功能仿真器将指令追踪输入时序仿真器。这类似于追踪驱动仿真，不同之处在于追踪不需要存储在磁盘上；追踪可以通过Unix管道从功能仿真器传送到时序仿真器。</p><p>为了能够沿着错误预测路径进行仿真，并对时序相关的线程间顺序和依赖关系进行建模，功能模型提供了回滚来恢复之前的状态。特别是在执行分支时，功能模型不知道分支是否被错误预测——只有时序仿真器知道——因此，它将只执行正确路径的指令。当时时序仿真器在取指阶段检测到错误预测分支时，功能仿真器需要重定向去沿着错误预测分支获取指令。这要求功能仿真器回滚到分支之前的状态，并沿着错误预测的分支路径向时序仿真器提供指令。在时序模型中解决了错误预测的分支后，功能模型需要再次回滚，然后开始向时序模型提供正确路径的指令。换言之，功能模型正在推测分支分支将采取的路径，即它推测该分支将被时序模型正确地预测。</p><p>如前所述，线程间依赖肯呢个取决于时序，也就是说时序的微小变化可能会改变线程获取锁的顺序，从而可能改变功能和性能。这也适用于功能优先的仿真器：功能模型和时序模型之间的计时可能不同，因此功能模型获取锁的顺序不一定与时序模型中观察到的顺序相同。这个排序问题基本上归结为<code>load</code>是否在功能和时序模型中读取相同的数据。因此，功能优先仿真可以通过跟踪功能模型和时序模型中读取到的数据来处理这个顺序问题。仿真器让功能模型提前运行，但是当时序模型检测到在目标体系结构中读取的数据将与和功能模型中读取的数据不同时，它会回滚模型，并请求功能模型使用正确的数据重新执行<code>load</code>指令，这称为推测功能优先仿真。解决顺序问题的代价是在时序仿真器中跟踪目标内存状态，并比较功能仿真器和时序仿真器的数据。</p><p><em>Argollo</em>等人提出了<em>COTSon</em>仿真基架，该设施采用AMD的<code>SimNow</code>功能仿真器将指令跟踪发送至时序仿真器。<em>COTSon</em>的主要重点是去模拟复杂的基准测试，比如商用操作系统和多层应用，以及向外扩展和仿真模拟大核心数。为了管理仿真器复杂度并提高仿真速度，<em>COTSon</em>不提供回滚功能，而是实现时序反馈，这使得时序仿真器可以调整功能仿真器的速度以反映时序估计。</p><p>综上所述，功能优先仿真的关键优势在于它允许功能仿真器在时序仿真器之前运行，并利用并行性，即并行运行功能和时序仿真器。相较于时序驱动仿真(时序模型在每个指令/周期驱动功能模型)，功能优先仿真提高了仿真器的性能，比如减少了评估时间，并降低了整个仿真器的复杂性。</p><p><strong>时序优先仿真</strong></p><p>时序优先仿真使时序模型先于功能模型运行，见图5.3。除了微体系结构状态之外，时序仿真器还对体系结构的特性(寄存器和内存状态)进行了建模，大部分都是正确的。这允许沿着错误预测的分支准确地建模推测性执行，以及线程间事件的顺序。当时序模型提交指令时，即当指令变为非推测性时，功能模型验证时序仿真器是否偏离了功能模型。当时序仿真器出现偏差时，由功能仿真器进行修复。这意味着在重新启动时序仿真器之前，体系结构状态将被重新加载，微体系结构状态将被重置。换句话说，时序优先仿真由一个几乎正确集成了的执行驱动仿真器(时序仿真器)组成，该仿真器由一个功能正确的功能仿真器检查。</p><p>时序优先仿真器比完全集成的仿真器更容易开发，因为时序仿真器不需要实现所有指令。指令子集对性能很重要，并且很好地涵盖动态执行的指令就足够了。与时序驱动仿真相比，时序优先仿真对功能仿真器的要求较少，而对时序仿真器的要求较多。</p><h3 id="5-6-2-处理非确定性">5.6.2 处理非确定性</h3><p>在执行驱动仿真器上模拟多线程工作负载时，必须处理的一个重要挑战是不确定性——<em>Alameldeen</em>和<em>Wood</em>对不确定性进行了全面的评估。不确定性指的是这样一个事实，即很小的时间变化可能导致从相同初始状态开始的执行遵循了不同的执行路径。非确定性在真实硬件和仿真中都存在。在实际硬件上，时序变化有各种来源，例如中断、I/O、与直接内存访问(DMA)的总线争用、DRAM刷新等。在比较体系架构设计方案时，还可以在仿真过程中观察到非确定性。例如，可能有雨多种原因，某些设计参数的更改(例如缓存大小、缓存延迟、分支预测器配置、处理器宽度等)可能导致不确定性。</p><ul><li>操作系统可能在不同的运行过程中做出不同的调度决策。例如，调度量可能在一次运行中在I/O事件之前结束，而在另一次运行中则不会结束。</li><li>线程可能以不同的顺序获得锁。这可能导致执行自旋锁循环指令所花费的周期和指令数在不同的体系结构中有所不同。</li><li>以不同相对速度运行的线程可能会导致不同的缓存一致性流量以及共享资源中的冲突行为。例如，共享多核缓存中的冲突行为在不同的架构设计中可能是不同的；同样，互连网络中的争用也可能不同。</li></ul><p>在架构探索过程中，不确定性使得比较不同设计方案变得非常复杂。时间差异可能导致仿真的<em>workload</em>由不同的性能特征采取不同的执行路径。因此很难比较不同的设计方案。如果执行路径的变化差异很重要，比较仿真就变得不可靠了，因为在不同的执行中完成的工作量和类型是不同的。最基本的问题是，在不同的设计方案之间观察到的性能差异是由于设计方案差异还是由于执行<em>workload</em>差异导致的。不解决这个问题可能会导致不正确的结论。</p><p><em>Alameldeen</em>和<em>Wood</em>提出了一个简单的实验，清晰地说明了在仿真中处理不确定性的必要性。他们考虑OLTP工作负载<em>workload</em>，并观察到性能随着内存访问时间的增加而增加，例如84-ns DRAM的性能比81-ns DRAM的性能提高7%。当然，这是没有意义的——没有一个计算机架构师会得出内存越慢性能越好的结论。尽管这个结论在这个简单的实验中是明显的，但在更复杂、更不直观的设计研究中可能不那么明显。对于如何处理不确定性，有三种可能的解决方案。</p><p><strong>长时间跑仿真</strong></p><p>一种解决方案是仿真足够长的时间，比如仿真模拟几分钟而不是几秒钟。不确定性可能在长期仿真模拟实验中基本被消除，然而考虑到计算机架构仿真非常缓慢，这个方法在实践中并不可行。</p><p><strong>消除不确定性</strong></p><p>第二种方法就是消除不确定性。<em>Lepak</em>等人和<em>Pereira</em>等人提出了在执行驱动仿真器上仿真不同架构配置时提供多线程程序可再现行为的方法；<em>Lepak</em>等人考虑的是全系统仿真，而<em>Pereira</em>等人关注的是用户级仿真。这些方法通过保证执行相同的执行路径来消除不确定性：它们通过引入人工熄火(突然中断)来强制跨仿真的共享内存访问顺序相同；此外，在仿真过程中，中断被强制触发在特定的点上。<em>Lepak</em>等人和<em>Pereira</em>等人的方法都提出了一个度量指标和方法来量化执行在多大程度上被迫是确定性的。引入熄火意味着在每个仿真中要完成相同数量的工作；因此，可以基于单个仿真比较不同的设计方案。强制确定性的缺陷在于它可能导致在真实系统中可能永远不会发生的执行。换句话说，对于易受不确定性影响的工作负载<em>workload</em>，这个方法可能没有用处。因此，正如<em>Lepak</em>等人所承认的那样，必须谨慎使用确定性仿真。</p><p>注意，跟踪驱动的仿真还完全消除了不确定性，因为跟踪中的指令在不同的系统中是完全相同的。然而，跟踪驱动的仿真也受到同样的限制：它不能恰当地评估影响线程交互的体系结构设计。</p><p><strong>统计方法</strong></p><p>第三种方法是使用(经典的)统计方法得出有效确凿的结论。<em>Alameldeen</em>和<em>Wood</em>提出在仿真过程中人为地注入小的时间变化。更具体地说，他们通过在DRAM访问延迟中添加0到4 ns之间的均匀分布随机数，以在内存系统定时中注入微小的变化。这些随机注入的扰动产生了从相同初始条件开始的一系列可能的执行——注意，仿真器是确定性的并且将总是产生相同的时间，因此需要引入随机扰动。然后他们多次运行仿真，并计算这些运行的平均值及其置信区间。</p><p>这种方法的一个明显缺点是它需要多次运行仿真，这延长了总仿真时间。与消除不确定性的方法相比，这个方法更加耗时。但是，这是通过仿真获得可靠性能数值的最佳方法。此外，运行多个(小型)仿真可能比执行一个长时间仿真更节省时间。</p><h2 id="5-7-模块化仿真基架">5.7 模块化仿真基架</h2><p>周期精确的仿真器是极其复杂的软件，与它们所建模的微架构相当。与任何其他大型软件项目一样，确保良好的软件结构对于保持开发过程的可管理性至关重要。模块化和可复用性是提高模型开发的可管理性和速度的两个关键目标。模块化指的是将性能建模问题分解为可以单独建模的更小的部分。可复用性是指在不同的应用环境中复用不利的组件。模块化和可复用性提供了很多好处，它提高了建模效率和性能模型的保真度(因为单个组件可能已经在不同的上下文中使用和验证过)；它允许跨项目共享单个组件，甚至在生产环境中跨产品和代际；它促进了体系架构实验，比如可以很容易地交换组件同时保持其余的性能模型不变。有所的这些好处都会缩短整体的开发时间。</p><p>一些仿真基础设施实践了模块化原则，例如<em>Asim</em>，<em>Liberty</em>，<em>MicroLib</em>，<em>UNISIM</em>和<em>M5</em>。模块化仿真基础设施通常提供一个仿真器基础设施，用于创建多个性能模型而不是仅有一个性能模型。<em>Asim</em>特别考虑了作为基础软件组件的模块。模块代表目标设计的物理组件(例如，缓存，分支预测器等)或硬件算法的操作(例如，缓存替换策略)。每个模块提供一个良好定义的接口，支持模块复用。开发人员可以为仿真基础设施贡献新的模块，只要他们实现模块接口，比如分支预测器应该实现分支预测器的三种方法：获得分支预测，更新分支预测器和处理错误预测的分支。<em>Asim</em>附带了架构师工作台，允许通过选择和连接模块来组装性能模型。</p><h2 id="5-8-仿真加速的需要">5.8 仿真加速的需要</h2><p>周期精确的仿真非常缓慢，这是当今架构研究和研发中的一个关键问题。最根本的原因是正在建模的微架构非常复杂。今天的处理器由数亿甚至数十亿个晶体管组成，它们实现了复杂的功能，如内存层次结构、推测执行、乱序执行、预取等。此外，多核处理的趋势进一步加剧了这个问题，因为现在需要模拟多核以及它们在共享资源中的相互作用。如此庞大的晶体管数量导致了一个非常大而复杂的设计空间，需要在新的微架构的设计周期中进行探索。</p><p><img src="https://aliyun-oss-zh.oss-cn-beijing.aliyuncs.com/img/QQ20241121-013208.jpg" alt=""></p><p>虽然直觉和分析建模可以帮助指导设计过程，但最终架构师必须依赖详细的周期精确仿真，以便在这个复杂的设计空间中做出正确的设计决策。微体系结构的复杂性明显地反映在性能模型的复杂性和速度上。周期精确的仿真模型非常慢。<em>Chiou</em>等人概述了当今仿真器的典型仿真速度，参见表5.2。学术界的仿真器的速度范围在69 KIPS和740 KIPS之间，它们通常比在1 KHz到200 KIPS速度范围内运行的工业界仿真器更快。换句话说，仅仿真(目标系统的)一秒钟的实时时间可能会耗费数小时甚至数天的仿真时间，即使是在当今最快的机器上运行的最快的仿真器上也是如此。这只是仿真一个设计点。架构师通常会运行许多仿真，以便深入了解设计空间。考虑到设计空间是巨大的，需要运行的仿真数量可能非常大，这可能会使得探索设计空间很快变得不可行的。</p><p>更糟糕的是，正在仿真的基准测试的复杂性也在增长。鉴于处理器变得越来越强大，基准测试需要变得更加复杂。在过去，在多核时代之前虽然单线程性能呈指数级增长，但基准测试需要执行更多指令并访问更多数据，以便以有意义的方式给当前和未来的处理器施加负载压力。比如SPEC CPU基准测试的复杂性大幅提高：动态指令数量从CPU89的平均25亿个动态执行指令增加到CPU2000的2300亿个指令，CPU2006的平均2.5亿条指令。现在在多核时代，为了强调设计中的多核处理器，基准测试将需要越来越多线程化。</p><p>周期精确仿真速度慢是一个众所周知且长期存在的问题，研究人员提出了各种解决方案来解决这一重要问题。由于其重要性，本书的其余部分致力于讲解提高仿真速度的技术。采样仿真将在第6章中介绍，它可能是最广泛使用的仿真加速技术，通过只仿真长时间运行基准中的一小段代码来减少仿真时间。我们将在第7章中重新讨论统计仿真，它采用不同的方法提高仿真速度，主要是通过生成代表长时间运行基准测试的小型工作负载<em>workload</em>，并且同时降低仿真器的复杂性。统计仿真的目的仅仅是作为一种快速探索设计空间的技术，与详细的周期精确模拟相补充。最后在第8章中描述了利用并行性来加速仿真的三种方法：(i)在并行机器上分布式运行仿真；(ii)并行化仿真器以在主机器的并行性中受益；(iii)通过将仿真器映射到可重构硬件(即fpga)上来利用细粒度并行性。</p>]]></content>
      
      
      
        <tags>
            
            <tag> 计算机体系结构 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IO多路复用之epoll</title>
      <link href="/2024/09/22/IO%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%E4%B9%8Bepoll/"/>
      <url>/2024/09/22/IO%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%E4%B9%8Bepoll/</url>
      
        <content type="html"><![CDATA[<h1 id="io多路复用之epoll模型">IO多路复用之epoll模型</h1><h2 id="epoll简介">epoll简介</h2><p>epoll是一个高性能的I/O事件通知机制，它是Linux内核提供的一种I/O多路复用方式。与其它传统的I/O多路复用机制如select和poll相比，epoll具有更高的扩展性和效率。epoll性能非常高，并且随着监听的文件描述符的增加，epoll的优势更加明显。</p><h2 id="工作模式">工作模式</h2><p>epoll有两种工作模式，水平触发LT和边缘触发ET。</p><h2 id="水平触发lt-level-trigger">水平触发LT(Level Trigger)</h2><p>只要接收缓冲区中有数据，就一直通知有读事件。</p><p>适合场景：数据较多的情况下，一次性读数据读不完。</p><p>优点：用法简单，但性能没有边缘触发高。</p><h2 id="边缘触发et-edge-trigger">边缘触发ET(Edge Trigger)</h2><p>缓冲区中有数据只会通知一次，之后再有新的数据到来才会通知(若是读数据的时候没有读完，则剩余的数据不会再通知，直到有新的数据到来)</p><p>适合场景：小数据量，一次性能够读完。</p><p>优点：性能更高，但用法较复杂。</p><h2 id="工作原理">工作原理</h2><p><img src="https://aliyun-oss-zh.oss-cn-beijing.aliyuncs.com/img/QQ20251127-185126.jpg" alt=""></p><p>epoll主要有3个API：<code>epoll_create()</code>、<code>epoll_ctl()</code>和<code>epoll_wait()</code>。</p><p>其中调用<code>epoll_create()</code>将创建一个<code>eventpoll</code>对象，该对象维护一棵红黑树。</p><p>调用<code>epoll_ctl()</code>可将监听套接字加入至红黑树或从红黑树中移除，待监听套接字加入至红黑树后，内核会监听该红黑树中哪些套接字会有就绪事件发生，然后会将所有的就绪事件放到通知队列<code>rdlist</code>中，其中每一个元素<code>epitem</code>就是一个就绪事件。内核会将通知队列中就绪事件复制到用户的程序中。</p><p>注意调用<code>epoll_wait()</code>时传入的第二个参数<code>events</code>，内核会将就绪事件队列复制到该数组中，后续用户程序遍历该数组即可检测到就绪事件。</p><p>epoll 在 Linux 内核中申请了一个简易的文件系统，用于存储相关的对象，每一个 epoll 对象都有一个独立的 eventpoll 结构体，这个结构体会在内核空间中创造独立的内存，用于存储使用 <code>epoll_ctl()</code> 方法向 epoll 对象中添加要监听的事件。这些事件都会挂到 rbr 红黑树中，这样重复添加的事件就可以通过红黑树而高效地识别出来。</p><p>Reference:</p><p><a href="https://www.jianshu.com/p/722819425dbd/">Select、Poll、Epoll详解 - 简书</a></p><h2 id="epoll-create函数">epoll_create函数</h2><h3 id="函数定义">函数定义</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">epoll_create</span><span class="params">(<span class="type">int</span> size)</span></span>;</span><br></pre></td></tr></table></figure><p>系统调用<code>epoll_create()</code>会创建一个epoll实例并返回该实例对应的文件描述符fd。在内核中，每个epoll实例会和一个<code>eventpoll</code>结构体类型对象一一对应，该对象是epoll的核心。</p><h3 id="参数说明">参数说明</h3><ul><li>size：表示要指定这个epoll实例可以监听的最大的套接字个数，也即事件表需要多大，但是在Linux 2.6.8内核版本以后，这个参数内核已经不再处理了(就是没有限制了)，但是必须要大于<code>1</code>。</li></ul><h3 id="返回值">返回值</h3><ul><li>成功：返回epoll句柄，该句柄代表一个<code>eventpoll</code>事件表</li><li>失败：返回<code>-1</code></li></ul><h2 id="epoll-ctl函数">epoll_ctl函数</h2><h3 id="函数定义">函数定义</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">epoll_ctl</span><span class="params">(<span class="type">int</span> epfd, <span class="type">int</span> op, <span class="type">int</span> fd, <span class="keyword">struct</span> epoll_event * event)</span></span>;</span><br></pre></td></tr></table></figure><h3 id="参数说明">参数说明</h3><ul><li><p>epfd：<code>epoll_create()</code>函数返回的epoll实例句柄</p></li><li><p>op：指定操作类型，操作类型有如下3种</p><table><thead><tr><th style="text-align:center">操作类型</th><th style="text-align:center">描述</th></tr></thead><tbody><tr><td style="text-align:center">EPOLL_CTL_ADD</td><td style="text-align:center">在epoll的监视列表中添加一个文件描述符(即参数fd)，指定监视的事件类型(参数event)</td></tr><tr><td style="text-align:center">EPOLL_CTL_MOD</td><td style="text-align:center">修改监视列表中已经存在的描述符(即参数fd)对应的监视事件类型(参数event)</td></tr><tr><td style="text-align:center">EPOLL_CTL_DEL</td><td style="text-align:center">将某监视列表中已经存在的描述符(即参数fd)删除，参数event传NULL</td></tr></tbody></table></li><li><p>fd：需要操作的文件描述符</p></li><li><p>event：需要epoll监视的fd对应的事件类型</p></li></ul><h3 id="返回值">返回值</h3><ul><li>成功：返回<code>0</code></li><li>错误：返回<code>-1</code></li></ul><h3 id="epoll-event结构体">epoll_event结构体</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">union</span> <span class="title class_">epoll_data</span> &#123;</span><br><span class="line">    <span class="type">void</span> *ptr;</span><br><span class="line">    <span class="type">int</span> fd;</span><br><span class="line">    <span class="type">uint32_t</span> u32;</span><br><span class="line">    <span class="type">uint64_t</span> u64;</span><br><span class="line">&#125; <span class="type">epoll_data_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">epoll_event</span> &#123;</span><br><span class="line">    <span class="type">uint32_t</span> events; <span class="comment">/* epoll监视的事件类型 */</span></span><br><span class="line">    <span class="type">epoll_data_t</span> data; <span class="comment">/* 用户数据 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>其中<code>events</code>成员描述事件类型，它是事件集合，通过位掩码的方式表示不同的事件，可以同时设置多个，通过<code>|</code>位或运算连接，可选项如下：</p><table><thead><tr><th style="text-align:center">事件类型</th><th style="text-align:center">描述</th></tr></thead><tbody><tr><td style="text-align:center">EPOLLIN</td><td style="text-align:center">文件描述符是否可读</td></tr><tr><td style="text-align:center">EPOLLOUT</td><td style="text-align:center">文件描述符是否可写</td></tr><tr><td style="text-align:center">EPOLLRDHUP</td><td style="text-align:center">对端关闭连接(被动)，或者套接字处于半关闭状态(主动)，这个事件会被触发。当使用边缘触发模式时，很方便写代码测试连接的对端是否关闭了连接</td></tr><tr><td style="text-align:center">EPOLLPRI</td><td style="text-align:center">表示对应的文件描述符有紧急的数据可读(这里应该表示有带外数据到来)</td></tr><tr><td style="text-align:center">EPOLLERR</td><td style="text-align:center">文件描述符是否错误。如果文件描述符已经关闭，继续写入也会收到这个事件。这个事件用户不设置也会被上报</td></tr><tr><td style="text-align:center">EPOLLHUP</td><td style="text-align:center">套接字被挂起，这个事件用户不设置也会被上报</td></tr><tr><td style="text-align:center">EPOLLET</td><td style="text-align:center">设置epoll的触发模式为边缘触发模式。如果没有设置这个参数，epoll默认情况下是水平触发模式</td></tr><tr><td style="text-align:center">EPOLLONESHOT</td><td style="text-align:center">设置添加的事件只触发一次，当epoll_wait 报告一次事件后，这个文件描述符后续所有的事件都不会再报告。只是禁用，文件描述符还在监视队列中，用户可以通过<code>epoll_ctl()</code>的EPOLL_CTL_MOD重新添加事件</td></tr></tbody></table><h2 id="epoll-wait函数">epoll_wait函数</h2><h3 id="函数定义">函数定义</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">epoll_wait</span><span class="params">(<span class="type">int</span> epfd, <span class="keyword">struct</span> epoll_event * events, <span class="type">int</span> maxevents, <span class="type">int</span> timeout)</span></span>;</span><br></pre></td></tr></table></figure><h3 id="参数说明">参数说明</h3><ul><li>epfd：<code>epoll_create()</code>函数返回的epoll实例的句柄</li><li>events：检测到事件，将所有就绪的事件从内核事件表中复制到<code>events</code>指向的数组中</li><li>maxevents：指定最多监听多少个事件</li><li>timeout：指定epoll的超时时间，单位是毫秒</li></ul><p>timeout分为三种情况：</p><ol><li>timeout设置为<code>-1</code>，<code>epoll_wait()</code>调用将永远阻塞，直到某个事件发生</li><li>timeout设置为<code>0</code>，<code>epoll_wait()</code>调用将立即返回</li><li>timeout设置为大于<code>0</code>，<code>epoll_wait()</code>将最多等待一段时间，超时后返回</li></ol><h3 id="返回值">返回值</h3><ul><li>成功：返回就绪的文件描述符的个数</li><li>失败：返回<code>-1</code></li></ul><h1 id="epoll代码实现">epoll代码实现</h1><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CMakeLists.txt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.19</span>)</span><br><span class="line"><span class="keyword">project</span>(epoll)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD <span class="number">11</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">include_directories</span>(<span class="string">&quot;./&quot;</span>)</span><br><span class="line"><span class="keyword">file</span>(GLOB_RECURSE SOURCES <span class="string">&quot;utility/*.cpp&quot;</span> <span class="string">&quot;socket/*.cpp&quot;</span> <span class="string">&quot;task/*.cpp&quot;</span>)</span><br><span class="line"><span class="keyword">add_executable</span>(server <span class="variable">$&#123;SOURCES&#125;</span> server.cpp)</span><br><span class="line"><span class="keyword">add_executable</span>(client <span class="variable">$&#123;SOURCES&#125;</span> client.cpp)</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// server.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/server_socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::socket;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_CONN 1024</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Singleton&lt;Logger&gt;::<span class="built_in">instance</span>()-&gt;<span class="built_in">open</span>(<span class="string">&quot;./server.log&quot;</span>);</span><br><span class="line">    <span class="function">ServerSocket <span class="title">server</span><span class="params">(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8080</span>)</span></span>;</span><br><span class="line">    <span class="comment">// 1.创建epoll实例</span></span><br><span class="line">    <span class="type">int</span> epfd = <span class="built_in">epoll_create</span>(MAX_CONN);</span><br><span class="line">    <span class="keyword">if</span> (epfd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">log_debug</span>(<span class="string">&quot;epoll create error: errno=%d errmsg=%s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2.将服务端套接字添加到监听队列</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">epoll_event</span> ev;</span><br><span class="line">    ev.events = (EPOLLIN | EPOLLHUP | EPOLLERR);</span><br><span class="line">    ev.data.fd = server.<span class="built_in">fd</span>();</span><br><span class="line">    ::<span class="built_in">epoll_ctl</span>(epfd, EPOLL_CTL_ADD, server.<span class="built_in">fd</span>(), &amp;ev);</span><br><span class="line">    <span class="comment">// 3.接收内核返回的就绪事件列表</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">epoll_event</span> events[MAX_CONN];</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">        <span class="type">int</span> num = ::<span class="built_in">epoll_wait</span>(epfd, events, MAX_CONN, <span class="number">-1</span>);</span><br><span class="line">        <span class="keyword">if</span> (num &lt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">log_error</span>(<span class="string">&quot;epoll wait error: errno=%d errmsg=%s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (num == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">log_debug</span>(<span class="string">&quot;epoll wait timeout&quot;</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; num; i++)&#123;</span><br><span class="line">            <span class="keyword">if</span> (events[i].data.fd == server.<span class="built_in">fd</span>())&#123;</span><br><span class="line">                <span class="comment">// 服务端套接字可读，意味着有新的连接过来</span></span><br><span class="line">                <span class="type">int</span> connfd = server.<span class="built_in">accept</span>();</span><br><span class="line">                <span class="comment">// 将新连接套接字添加到监听队列中</span></span><br><span class="line">                <span class="keyword">struct</span> <span class="title class_">epoll_event</span> ev2;</span><br><span class="line">                ev2.events = (EPOLLIN | EPOLLHUP | EPOLLERR | EPOLLONESHOT);</span><br><span class="line">                ev2.data.fd = connfd;</span><br><span class="line">                ::<span class="built_in">epoll_ctl</span>(epfd, EPOLL_CTL_ADD, connfd, &amp;ev2);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">// 客户端套接字可读</span></span><br><span class="line">                Socket <span class="built_in">socket</span>(events[i].data.fd);</span><br><span class="line">                <span class="keyword">if</span> (events[i].events &amp; EPOLLHUP)&#123;</span><br><span class="line">                    <span class="comment">// 挂起事件表明连接套接字挂断了</span></span><br><span class="line">                    <span class="built_in">log_error</span>(<span class="string">&quot;socket hang hup by peer: conn=%d errno=%d errmsg=%s&quot;</span>, socket.<span class="built_in">fd</span>(), errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">                    ::<span class="built_in">epoll_ctl</span>(epfd, EPOLL_CTL_DEL, socket.<span class="built_in">fd</span>(), <span class="literal">nullptr</span>);</span><br><span class="line">                    socket.<span class="built_in">close</span>();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (events[i].events &amp; EPOLLERR)&#123;</span><br><span class="line">                    <span class="comment">// 连接套接字发生错误</span></span><br><span class="line">                    <span class="built_in">log_error</span>(<span class="string">&quot;socket error: conn=%d errno=%d errmsg=%s&quot;</span>, socket.<span class="built_in">fd</span>(), errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">                    ::<span class="built_in">epoll_ctl</span>(epfd, EPOLL_CTL_DEL, socket.<span class="built_in">fd</span>(), <span class="literal">nullptr</span>);</span><br><span class="line">                    socket.<span class="built_in">close</span>();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (events[i].events &amp; EPOLLIN)&#123;</span><br><span class="line">                    ::<span class="built_in">epoll_ctl</span>(epfd, EPOLL_CTL_DEL, socket.<span class="built_in">fd</span>(), <span class="literal">nullptr</span>);</span><br><span class="line">                    <span class="comment">// 接收客户端数据</span></span><br><span class="line">                    <span class="type">char</span> buf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">                    <span class="type">int</span> len = socket.<span class="built_in">recv</span>(buf, <span class="built_in">sizeof</span>(buf));</span><br><span class="line">                    <span class="keyword">if</span> (len &lt; <span class="number">0</span>)&#123;</span><br><span class="line">                        <span class="built_in">log_error</span>(<span class="string">&quot;socket connection abort: conn=%d errno=%d errmsg=%s&quot;</span>, socket.<span class="built_in">fd</span>(), errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">                        socket.<span class="built_in">close</span>();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (len == <span class="number">0</span>)&#123;</span><br><span class="line">                        <span class="built_in">log_debug</span>(<span class="string">&quot;socket closed by peer: conn=%d&quot;</span>, socket.<span class="built_in">fd</span>());</span><br><span class="line">                        socket.<span class="built_in">close</span>();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span>&#123;</span><br><span class="line">                        <span class="built_in">log_debug</span>(<span class="string">&quot;recv: conn=%d msg=%s&quot;</span>, socket.<span class="built_in">fd</span>(), buf);</span><br><span class="line">                        <span class="comment">// 向客户端发送数据</span></span><br><span class="line">                        socket.<span class="built_in">send</span>(buf, len);</span><br><span class="line">                        <span class="keyword">struct</span> <span class="title class_">epoll_event</span> ev3;</span><br><span class="line">                        ev3.events = (EPOLLIN | EPOLLHUP | EPOLLERR | EPOLLONESHOT);</span><br><span class="line">                        ev3.data.fd = socket.<span class="built_in">fd</span>();</span><br><span class="line">                        ::<span class="built_in">epoll_ctl</span>(epfd, EPOLL_CTL_ADD, socket.<span class="built_in">fd</span>(), &amp;ev3);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// client.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/client_socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::socket;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Singleton&lt;Logger&gt;::<span class="built_in">instance</span>()-&gt;<span class="built_in">open</span>(<span class="string">&quot;./client.log&quot;</span>);</span><br><span class="line">    <span class="function">ClientSocket <span class="title">client</span><span class="params">(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8080</span>)</span></span>;</span><br><span class="line">    <span class="comment">// 向服务端发送数据</span></span><br><span class="line">    string data = <span class="string">&quot;hello world&quot;</span>;</span><br><span class="line">    client.<span class="built_in">send</span>(data.<span class="built_in">c_str</span>(), data.<span class="built_in">size</span>());</span><br><span class="line">    <span class="comment">// 接收服务端的数据</span></span><br><span class="line">    <span class="type">char</span> buf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    client.<span class="built_in">recv</span>(buf, <span class="built_in">sizeof</span>(buf));</span><br><span class="line">    <span class="built_in">log_info</span>(<span class="string">&quot;recv: %s&quot;</span>, buf);</span><br><span class="line">    <span class="comment">// 基类Socket析构函数中会调用close()</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="epoll代码封装">epoll代码封装</h1><h2 id="eventpoller类">EventPoller类</h2><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CMakeLists.txt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.19</span>)</span><br><span class="line"><span class="keyword">project</span>(epoll)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD <span class="number">11</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">include_directories</span>(<span class="string">&quot;./&quot;</span>)</span><br><span class="line"><span class="keyword">file</span>(GLOB_RECURSE SOURCES <span class="string">&quot;utility/*.cpp&quot;</span> <span class="string">&quot;socket/*.cpp&quot;</span> <span class="string">&quot;task/*.cpp&quot;</span>)</span><br><span class="line"><span class="keyword">add_executable</span>(server <span class="variable">$&#123;SOURCES&#125;</span> server2.cpp)</span><br><span class="line"><span class="keyword">add_executable</span>(client <span class="variable">$&#123;SOURCES&#125;</span> client.cpp)</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// socket/event_poller.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> socket</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">EventPoller</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">EventPoller</span>();</span><br><span class="line">            ~<span class="built_in">EventPoller</span>();</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">create</span><span class="params">(<span class="type">int</span> max_conn)</span></span>;</span><br><span class="line">            <span class="comment">// 往事件表中注册fd上的事件</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">add</span><span class="params">(<span class="type">int</span> fd, <span class="type">uint32_t</span> events)</span></span>;</span><br><span class="line">            <span class="comment">// 修改fd上的注册事件</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">mod</span><span class="params">(<span class="type">int</span> fd, <span class="type">uint32_t</span> events)</span></span>;</span><br><span class="line">            <span class="comment">// 删除fd上的注册事件</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">del</span><span class="params">(<span class="type">int</span> fd)</span></span>;</span><br><span class="line">            <span class="comment">// timeout单位为毫秒</span></span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">wait</span><span class="params">(<span class="type">int</span> timeout)</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 判断数组中指定索引上的文件描述符上是否有指定事件发生</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">is_set</span><span class="params">(<span class="type">int</span> idx, <span class="type">uint32_t</span> events)</span></span>;</span><br><span class="line">            <span class="comment">// 获取数组中指定索引上的文件描述符</span></span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">get_fd</span><span class="params">(<span class="type">int</span> idx)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="comment">// epoll专用的文件描述符</span></span><br><span class="line">            <span class="type">int</span> m_epfd;</span><br><span class="line">            <span class="comment">// epoll最大连接数</span></span><br><span class="line">            <span class="type">int</span> m_max_conn;</span><br><span class="line">            <span class="comment">// epoll用于回传待处理的事件数组</span></span><br><span class="line">            <span class="keyword">struct</span> <span class="title class_">epoll_event</span> * m_events;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// socket/event_poller.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/event_poller.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::socket;</span><br><span class="line"></span><br><span class="line">EventPoller::<span class="built_in">EventPoller</span>() : <span class="built_in">m_epfd</span>(<span class="number">0</span>), <span class="built_in">m_max_conn</span>(<span class="number">0</span>), <span class="built_in">m_events</span>(<span class="literal">nullptr</span>)</span><br><span class="line">&#123;    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">EventPoller::~<span class="built_in">EventPoller</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_epfd &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ::<span class="built_in">close</span>(m_epfd);</span><br><span class="line">        m_epfd = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (m_events != <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">delete</span>[] m_events;</span><br><span class="line">        m_events = <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">EventPoller::create</span><span class="params">(<span class="type">int</span> max_conn)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_epfd = ::<span class="built_in">epoll_create</span>(max_conn);</span><br><span class="line">    <span class="keyword">if</span> (m_epfd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    m_events = <span class="keyword">new</span> epoll_event[max_conn];</span><br><span class="line">    m_max_conn = max_conn;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EventPoller::add</span><span class="params">(<span class="type">int</span> fd, <span class="type">uint32_t</span> events)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">epoll_event</span> ev;</span><br><span class="line">    ev.events = events;</span><br><span class="line">    ev.data.fd = fd;</span><br><span class="line">    ::<span class="built_in">epoll_ctl</span>(m_epfd, EPOLL_CTL_ADD, fd, &amp;ev);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EventPoller::mod</span><span class="params">(<span class="type">int</span> fd, <span class="type">uint32_t</span> events)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">epoll_event</span> ev;</span><br><span class="line">    ev.events = events;</span><br><span class="line">    ev.data.fd = fd;</span><br><span class="line">    ::<span class="built_in">epoll_ctl</span>(m_epfd, EPOLL_CTL_MOD, fd, &amp;ev);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EventPoller::del</span><span class="params">(<span class="type">int</span> fd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ::<span class="built_in">epoll_ctl</span>(m_epfd, EPOLL_CTL_DEL, fd, <span class="literal">nullptr</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">EventPoller::wait</span><span class="params">(<span class="type">int</span> timeout)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ::<span class="built_in">epoll_wait</span>(m_epfd, m_events, m_max_conn, timeout);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">EventPoller::is_set</span><span class="params">(<span class="type">int</span> idx, <span class="type">uint32_t</span> events)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_events[idx].events &amp; events;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">EventPoller::get_fd</span><span class="params">(<span class="type">int</span> idx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_events[idx].data.fd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// server2.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/server_socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/event_poller.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::socket;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Singleton&lt;Logger&gt;::<span class="built_in">instance</span>()-&gt;<span class="built_in">open</span>(<span class="string">&quot;./server.log&quot;</span>);</span><br><span class="line">    <span class="function">ServerSocket <span class="title">server</span><span class="params">(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8080</span>)</span></span>;</span><br><span class="line">    EventPoller epoll;</span><br><span class="line">    epoll.<span class="built_in">create</span>(<span class="number">1024</span>);</span><br><span class="line">    epoll.<span class="built_in">add</span>(server.<span class="built_in">fd</span>(), (EPOLLIN | EPOLLHUP | EPOLLERR));</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> num = epoll.<span class="built_in">wait</span>(<span class="number">-1</span>);</span><br><span class="line">        <span class="keyword">if</span> (num &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">log_error</span>(<span class="string">&quot;epoll wait error: errno=%d errmsg=%s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (num == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">log_debug</span>(<span class="string">&quot;epoll wait timeout&quot;</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; num; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (epoll.<span class="built_in">get_fd</span>(i) == server.<span class="built_in">fd</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 服务端套接字可读</span></span><br><span class="line">                <span class="type">int</span> connfd = server.<span class="built_in">accept</span>();</span><br><span class="line">                <span class="comment">// 将连接套接字添加到监听队列</span></span><br><span class="line">                epoll.<span class="built_in">add</span>(connfd, (EPOLLIN | EPOLLHUP | EPOLLERR | EPOLLONESHOT));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 连接套接字有事件发生</span></span><br><span class="line">                Socket <span class="built_in">socket</span>(epoll.<span class="built_in">get_fd</span>(i));</span><br><span class="line">                <span class="keyword">if</span> (epoll.<span class="built_in">is_set</span>(i, EPOLLHUP))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 连接套接字挂断了</span></span><br><span class="line">                    <span class="built_in">log_error</span>(<span class="string">&quot;socket hang up by peer: conn=%d errno=%d errmsg=%s&quot;</span>, socket.<span class="built_in">fd</span>(), errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">                    epoll.<span class="built_in">del</span>(socket.<span class="built_in">fd</span>());</span><br><span class="line">                    socket.<span class="built_in">close</span>();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (epoll.<span class="built_in">is_set</span>(i, EPOLLERR))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 连接套接字发生错误</span></span><br><span class="line">                    <span class="built_in">log_error</span>(<span class="string">&quot;socket errno: conn=%d errno=%d errmsg=%s&quot;</span>, socket.<span class="built_in">fd</span>(), errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">                    epoll.<span class="built_in">del</span>(socket.<span class="built_in">fd</span>());</span><br><span class="line">                    socket.<span class="built_in">close</span>();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (epoll.<span class="built_in">is_set</span>(i, EPOLLIN))</span><br><span class="line">                &#123;</span><br><span class="line">                    ::<span class="built_in">epoll_ctl</span>(socket.<span class="built_in">fd</span>(), EPOLL_CTL_DEL, socket.<span class="built_in">fd</span>(), <span class="literal">nullptr</span>);</span><br><span class="line">                    <span class="comment">// 接收客户端数据</span></span><br><span class="line">                    <span class="type">char</span> buf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">                    <span class="type">int</span> len = socket.<span class="built_in">recv</span>(buf, <span class="built_in">sizeof</span>(buf));</span><br><span class="line">                    <span class="keyword">if</span> (len &lt; <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">log_error</span>(<span class="string">&quot;socket connection abort: conn=%d errno=%d errmsg=%s&quot;</span>, socket.<span class="built_in">fd</span>(), errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">                        socket.<span class="built_in">close</span>();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (len == <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">log_debug</span>(<span class="string">&quot;socket closed by peer: conn=%d&quot;</span>, socket.<span class="built_in">fd</span>());</span><br><span class="line">                        socket.<span class="built_in">close</span>();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">log_debug</span>(<span class="string">&quot;recv: conn=%d msg=%s&quot;</span>, socket.<span class="built_in">fd</span>(), buf);</span><br><span class="line">                        <span class="comment">// 向客户端发送数据</span></span><br><span class="line">                        socket.<span class="built_in">send</span>(buf, len);</span><br><span class="line">                        epoll.<span class="built_in">add</span>(socket.<span class="built_in">fd</span>(), (EPOLLIN | EPOLLHUP | EPOLLERR | EPOLLONESHOT));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// client.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/client_socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::socket;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Singleton&lt;Logger&gt;::<span class="built_in">instance</span>()-&gt;<span class="built_in">open</span>(<span class="string">&quot;./client.log&quot;</span>);</span><br><span class="line">    <span class="function">ClientSocket <span class="title">client</span><span class="params">(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8080</span>)</span></span>;</span><br><span class="line">    <span class="comment">// 向服务端发送数据</span></span><br><span class="line">    string data = <span class="string">&quot;hello world&quot;</span>;</span><br><span class="line">    client.<span class="built_in">send</span>(data.<span class="built_in">c_str</span>(), data.<span class="built_in">size</span>());</span><br><span class="line">    <span class="comment">// 接收服务端的数据</span></span><br><span class="line">    <span class="type">char</span> buf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    client.<span class="built_in">recv</span>(buf, <span class="built_in">sizeof</span>(buf));</span><br><span class="line">    <span class="built_in">log_info</span>(<span class="string">&quot;recv: %s&quot;</span>, buf);</span><br><span class="line">    <span class="comment">// 基类Socket析构函数中会调用close()</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="sockethandler类">SocketHandler类</h2><p>在基于<code>EventPoller</code>类编写的server3.cpp源码里，<code>main()</code>函数中启动服务进行监听的大部分逻辑都是一样的，可能只有业务处理部分会有不同，因此可对代码进行进一步的封装。</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CMakeLists.txt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.19</span>)</span><br><span class="line"><span class="keyword">project</span>(epoll)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD <span class="number">11</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">include_directories</span>(<span class="string">&quot;./&quot;</span>)</span><br><span class="line"><span class="keyword">file</span>(GLOB_RECURSE SOURCES <span class="string">&quot;utility/*.cpp&quot;</span> <span class="string">&quot;socket/*.cpp&quot;</span> <span class="string">&quot;task/*.cpp&quot;</span>)</span><br><span class="line"><span class="keyword">add_executable</span>(server <span class="variable">$&#123;SOURCES&#125;</span> server3.cpp)</span><br><span class="line"><span class="keyword">add_executable</span>(client <span class="variable">$&#123;SOURCES&#125;</span> client.cpp)</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// socket/event_poller.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> socket</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">EventPoller</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">EventPoller</span>();</span><br><span class="line">            ~<span class="built_in">EventPoller</span>();</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">create</span><span class="params">(<span class="type">int</span> max_conn)</span></span>;</span><br><span class="line">            <span class="comment">// 往事件表中注册fd上的事件</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">add</span><span class="params">(<span class="type">int</span> fd, <span class="type">uint32_t</span> events)</span></span>;</span><br><span class="line">            <span class="comment">// 修改fd上的注册事件</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">mod</span><span class="params">(<span class="type">int</span> fd, <span class="type">uint32_t</span> events)</span></span>;</span><br><span class="line">            <span class="comment">// 删除fd上的注册事件</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">del</span><span class="params">(<span class="type">int</span> fd)</span></span>;</span><br><span class="line">            <span class="comment">// timeout单位为毫秒</span></span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">wait</span><span class="params">(<span class="type">int</span> timeout)</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 判断数组中指定索引上的文件描述符上是否有指定事件发生</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">is_set</span><span class="params">(<span class="type">int</span> idx, <span class="type">uint32_t</span> events)</span></span>;</span><br><span class="line">            <span class="comment">// 获取数组中指定索引上的文件描述符</span></span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">get_fd</span><span class="params">(<span class="type">int</span> idx)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="comment">// epoll专用的文件描述符</span></span><br><span class="line">            <span class="type">int</span> m_epfd;</span><br><span class="line">            <span class="comment">// epoll最大连接数</span></span><br><span class="line">            <span class="type">int</span> m_max_conn;</span><br><span class="line">            <span class="comment">// epoll用于回传待处理的事件数组</span></span><br><span class="line">            <span class="keyword">struct</span> <span class="title class_">epoll_event</span> * m_events;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// socket/event_poller.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/event_poller.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::socket;</span><br><span class="line"></span><br><span class="line">EventPoller::<span class="built_in">EventPoller</span>() : <span class="built_in">m_epfd</span>(<span class="number">0</span>), <span class="built_in">m_max_conn</span>(<span class="number">0</span>), <span class="built_in">m_events</span>(<span class="literal">nullptr</span>)</span><br><span class="line">&#123;    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">EventPoller::~<span class="built_in">EventPoller</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_epfd &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ::<span class="built_in">close</span>(m_epfd);</span><br><span class="line">        m_epfd = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (m_events != <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">delete</span>[] m_events;</span><br><span class="line">        m_events = <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">EventPoller::create</span><span class="params">(<span class="type">int</span> max_conn)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_epfd = ::<span class="built_in">epoll_create</span>(max_conn);</span><br><span class="line">    <span class="keyword">if</span> (m_epfd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    m_events = <span class="keyword">new</span> epoll_event[max_conn];</span><br><span class="line">    m_max_conn = max_conn;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EventPoller::add</span><span class="params">(<span class="type">int</span> fd, <span class="type">uint32_t</span> events)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">epoll_event</span> ev;</span><br><span class="line">    ev.events = events;</span><br><span class="line">    ev.data.fd = fd;</span><br><span class="line">    ::<span class="built_in">epoll_ctl</span>(m_epfd, EPOLL_CTL_ADD, fd, &amp;ev);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EventPoller::mod</span><span class="params">(<span class="type">int</span> fd, <span class="type">uint32_t</span> events)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">epoll_event</span> ev;</span><br><span class="line">    ev.events = events;</span><br><span class="line">    ev.data.fd = fd;</span><br><span class="line">    ::<span class="built_in">epoll_ctl</span>(m_epfd, EPOLL_CTL_MOD, fd, &amp;ev);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EventPoller::del</span><span class="params">(<span class="type">int</span> fd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ::<span class="built_in">epoll_ctl</span>(m_epfd, EPOLL_CTL_DEL, fd, <span class="literal">nullptr</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">EventPoller::wait</span><span class="params">(<span class="type">int</span> timeout)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ::<span class="built_in">epoll_wait</span>(m_epfd, m_events, m_max_conn, timeout);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">EventPoller::is_set</span><span class="params">(<span class="type">int</span> idx, <span class="type">uint32_t</span> events)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_events[idx].events &amp; events;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">EventPoller::get_fd</span><span class="params">(<span class="type">int</span> idx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_events[idx].data.fd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// socket/socket_handler.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/server_socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/event_poller.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> socket</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">SocketHandler</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">SINGLETON</span>(SocketHandler);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">listen</span><span class="params">(<span class="type">const</span> string &amp; ip, <span class="type">int</span> port)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">attach</span><span class="params">(Socket * socket)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">detach</span><span class="params">(Socket * socket)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">remove</span><span class="params">(Socket * socket)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">handle</span><span class="params">(<span class="type">int</span> max_conn, <span class="type">int</span> timeout)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            Socket * m_server = <span class="literal">nullptr</span>;</span><br><span class="line">            EventPoller m_epoll;</span><br><span class="line">            <span class="comment">// 记录每个连接的套接字到Socket*的映射关系</span></span><br><span class="line">            std::map&lt;<span class="type">int</span>, Socket*&gt; m_conns;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// socket/socket_handler.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/socket_handler.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::socket;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SocketHandler::listen</span><span class="params">(<span class="type">const</span> string &amp; ip, <span class="type">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_server = <span class="keyword">new</span> <span class="built_in">ServerSocket</span>(ip, port);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SocketHandler::attach</span><span class="params">(Socket * socket)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_epoll.<span class="built_in">add</span>(socket-&gt;<span class="built_in">fd</span>(), (EPOLLIN | EPOLLHUP | EPOLLERR | EPOLLONESHOT));</span><br><span class="line">    m_conns[socket-&gt;<span class="built_in">fd</span>()] = socket;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SocketHandler::detach</span><span class="params">(Socket * socket)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_epoll.<span class="built_in">del</span>(socket-&gt;<span class="built_in">fd</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SocketHandler::remove</span><span class="params">(Socket * socket)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_epoll.<span class="built_in">del</span>(socket-&gt;<span class="built_in">fd</span>());</span><br><span class="line">    <span class="keyword">auto</span> it = m_conns.<span class="built_in">find</span>(socket-&gt;<span class="built_in">fd</span>());</span><br><span class="line">    <span class="keyword">if</span> (it != m_conns.<span class="built_in">end</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        m_conns.<span class="built_in">erase</span>(it);</span><br><span class="line">    &#125;</span><br><span class="line">    socket-&gt;<span class="built_in">close</span>();  </span><br><span class="line">    <span class="keyword">delete</span> socket;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SocketHandler::handle</span><span class="params">(<span class="type">int</span> max_conn, <span class="type">int</span> timeout)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_epoll.<span class="built_in">create</span>(max_conn);</span><br><span class="line">    m_epoll.<span class="built_in">add</span>(m_server-&gt;<span class="built_in">fd</span>(), (EPOLLIN | EPOLLHUP | EPOLLERR));</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> num = m_epoll.<span class="built_in">wait</span>(timeout);</span><br><span class="line">        <span class="keyword">if</span> (num &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">log_debug</span>(<span class="string">&quot;epoll wait error: errno=%d errmsg=%s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (num == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">log_debug</span>(<span class="string">&quot;epoll wait timeout&quot;</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; num; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (m_epoll.<span class="built_in">get_fd</span>(i) == m_server-&gt;<span class="built_in">fd</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 服务端套接字可读</span></span><br><span class="line">                <span class="type">int</span> connfd = m_server-&gt;<span class="built_in">accept</span>();</span><br><span class="line">                <span class="comment">// 将连接套接字添加到监听队列</span></span><br><span class="line">                <span class="keyword">auto</span> socket = <span class="keyword">new</span> <span class="built_in">Socket</span>(connfd);</span><br><span class="line">                <span class="built_in">attach</span>(socket);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 连接套接字出现可读事件</span></span><br><span class="line">                <span class="keyword">auto</span> socket = m_conns[m_epoll.<span class="built_in">get_fd</span>(i)];</span><br><span class="line">                <span class="keyword">if</span> (m_epoll.<span class="built_in">is_set</span>(i, EPOLLHUP))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 连接套接字挂断了</span></span><br><span class="line">                    <span class="built_in">log_error</span>(<span class="string">&quot;socket hang up by peer: conn=%d errno=%d errmsg=%s&quot;</span>, socket-&gt;<span class="built_in">fd</span>(), errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">                    <span class="built_in">remove</span>(socket);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (m_epoll.<span class="built_in">is_set</span>(i, EPOLLERR))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 连接套接字发生错误</span></span><br><span class="line">                    <span class="built_in">log_error</span>(<span class="string">&quot;socket error: conn=%d errno=%d errmsg=%s&quot;</span>, socket-&gt;<span class="built_in">fd</span>(), errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">                    <span class="built_in">remove</span>(socket);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (m_epoll.<span class="built_in">is_set</span>(i, EPOLLIN))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">detach</span>(socket);</span><br><span class="line">                    <span class="comment">// 接收客户端数据</span></span><br><span class="line">                    <span class="type">char</span> buf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">                    <span class="type">int</span> len = socket-&gt;<span class="built_in">recv</span>(buf, <span class="built_in">sizeof</span>(buf));</span><br><span class="line">                    <span class="keyword">if</span> (len &lt; <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">log_error</span>(<span class="string">&quot;socket connection abort: conn=%d errno=%d errmsg=%s&quot;</span>, socket-&gt;<span class="built_in">fd</span>(), errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">                        <span class="built_in">remove</span>(socket);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (len == <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">log_debug</span>(<span class="string">&quot;socket closed by peer: conn=%d&quot;</span>, socket-&gt;<span class="built_in">fd</span>());</span><br><span class="line">                        <span class="built_in">remove</span>(socket);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">detach</span>(socket);</span><br><span class="line">                        <span class="built_in">log_debug</span>(<span class="string">&quot;recv: conn=%d msg=%s&quot;</span>, socket-&gt;<span class="built_in">fd</span>(), buf);</span><br><span class="line">                        <span class="comment">// 向客户端发送数据</span></span><br><span class="line">                        socket-&gt;<span class="built_in">send</span>(buf, len);</span><br><span class="line">                        <span class="built_in">attach</span>(socket);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// server3.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/socket_handler.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::socket;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Singleton&lt;Logger&gt;::<span class="built_in">instance</span>()-&gt;<span class="built_in">open</span>(<span class="string">&quot;./server.log&quot;</span>);</span><br><span class="line">    <span class="keyword">auto</span> handler = Singleton&lt;SocketHandler&gt;::<span class="built_in">instance</span>();</span><br><span class="line">    handler-&gt;<span class="built_in">listen</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8080</span>);</span><br><span class="line">    handler-&gt;<span class="built_in">handle</span>(<span class="number">1024</span>, <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// client.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/client_socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::socket;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Singleton&lt;Logger&gt;::<span class="built_in">instance</span>()-&gt;<span class="built_in">open</span>(<span class="string">&quot;./client.log&quot;</span>);</span><br><span class="line">    <span class="function">ClientSocket <span class="title">client</span><span class="params">(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8080</span>)</span></span>;</span><br><span class="line">    <span class="comment">// 向服务端发送数据</span></span><br><span class="line">    string data = <span class="string">&quot;hello world&quot;</span>;</span><br><span class="line">    client.<span class="built_in">send</span>(data.<span class="built_in">c_str</span>(), data.<span class="built_in">size</span>());</span><br><span class="line">    <span class="comment">// 接收服务端的数据</span></span><br><span class="line">    <span class="type">char</span> buf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    client.<span class="built_in">recv</span>(buf, <span class="built_in">sizeof</span>(buf));</span><br><span class="line">    <span class="built_in">log_info</span>(<span class="string">&quot;recv: %s&quot;</span>, buf);</span><br><span class="line">    <span class="comment">// 基类Socket析构函数中会调用close()</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="业务与框架分离">业务与框架分离</h2><p>接收客户端数据这块业务逻辑可以通过<code>EchoTask</code>类来实现，即将具体业务交由<code>EchoTask</code>来处理，如此便实现了业务与框架分离。</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CMakeLists.txt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.19</span>)</span><br><span class="line"><span class="keyword">project</span>(epoll)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD <span class="number">11</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">include_directories</span>(<span class="string">&quot;./&quot;</span>)</span><br><span class="line"><span class="keyword">file</span>(GLOB_RECURSE SOURCES <span class="string">&quot;utility/*.cpp&quot;</span> <span class="string">&quot;socket/*.cpp&quot;</span> <span class="string">&quot;task/*.cpp&quot;</span>)</span><br><span class="line"><span class="keyword">add_executable</span>(server <span class="variable">$&#123;SOURCES&#125;</span> server3.cpp)</span><br><span class="line"><span class="keyword">add_executable</span>(client <span class="variable">$&#123;SOURCES&#125;</span> client.cpp)</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// socket/event_poller.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> socket</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">EventPoller</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">EventPoller</span>();</span><br><span class="line">            ~<span class="built_in">EventPoller</span>();</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">create</span><span class="params">(<span class="type">int</span> max_conn)</span></span>;</span><br><span class="line">            <span class="comment">// 往事件表中注册fd上的事件</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">add</span><span class="params">(<span class="type">int</span> fd, <span class="type">uint32_t</span> events)</span></span>;</span><br><span class="line">            <span class="comment">// 修改fd上的注册事件</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">mod</span><span class="params">(<span class="type">int</span> fd, <span class="type">uint32_t</span> events)</span></span>;</span><br><span class="line">            <span class="comment">// 删除fd上的注册事件</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">del</span><span class="params">(<span class="type">int</span> fd)</span></span>;</span><br><span class="line">            <span class="comment">// timeout单位为毫秒</span></span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">wait</span><span class="params">(<span class="type">int</span> timeout)</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 判断数组中指定索引上的文件描述符上是否有指定事件发生</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">is_set</span><span class="params">(<span class="type">int</span> idx, <span class="type">uint32_t</span> events)</span></span>;</span><br><span class="line">            <span class="comment">// 获取数组中指定索引上的文件描述符</span></span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">get_fd</span><span class="params">(<span class="type">int</span> idx)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="comment">// epoll专用的文件描述符</span></span><br><span class="line">            <span class="type">int</span> m_epfd;</span><br><span class="line">            <span class="comment">// epoll最大连接数</span></span><br><span class="line">            <span class="type">int</span> m_max_conn;</span><br><span class="line">            <span class="comment">// epoll用于回传待处理的事件数组</span></span><br><span class="line">            <span class="keyword">struct</span> <span class="title class_">epoll_event</span> * m_events;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// socket/event_poller.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/event_poller.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::socket;</span><br><span class="line"></span><br><span class="line">EventPoller::<span class="built_in">EventPoller</span>() : <span class="built_in">m_epfd</span>(<span class="number">0</span>), <span class="built_in">m_max_conn</span>(<span class="number">0</span>), <span class="built_in">m_events</span>(<span class="literal">nullptr</span>)</span><br><span class="line">&#123;    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">EventPoller::~<span class="built_in">EventPoller</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_epfd &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ::<span class="built_in">close</span>(m_epfd);</span><br><span class="line">        m_epfd = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (m_events != <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">delete</span>[] m_events;</span><br><span class="line">        m_events = <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">EventPoller::create</span><span class="params">(<span class="type">int</span> max_conn)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_epfd = ::<span class="built_in">epoll_create</span>(max_conn);</span><br><span class="line">    <span class="keyword">if</span> (m_epfd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    m_events = <span class="keyword">new</span> epoll_event[max_conn];</span><br><span class="line">    m_max_conn = max_conn;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EventPoller::add</span><span class="params">(<span class="type">int</span> fd, <span class="type">uint32_t</span> events)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">epoll_event</span> ev;</span><br><span class="line">    ev.events = events;</span><br><span class="line">    ev.data.fd = fd;</span><br><span class="line">    ::<span class="built_in">epoll_ctl</span>(m_epfd, EPOLL_CTL_ADD, fd, &amp;ev);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EventPoller::mod</span><span class="params">(<span class="type">int</span> fd, <span class="type">uint32_t</span> events)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">epoll_event</span> ev;</span><br><span class="line">    ev.events = events;</span><br><span class="line">    ev.data.fd = fd;</span><br><span class="line">    ::<span class="built_in">epoll_ctl</span>(m_epfd, EPOLL_CTL_MOD, fd, &amp;ev);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EventPoller::del</span><span class="params">(<span class="type">int</span> fd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ::<span class="built_in">epoll_ctl</span>(m_epfd, EPOLL_CTL_DEL, fd, <span class="literal">nullptr</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">EventPoller::wait</span><span class="params">(<span class="type">int</span> timeout)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ::<span class="built_in">epoll_wait</span>(m_epfd, m_events, m_max_conn, timeout);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">EventPoller::is_set</span><span class="params">(<span class="type">int</span> idx, <span class="type">uint32_t</span> events)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_events[idx].events &amp; events;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">EventPoller::get_fd</span><span class="params">(<span class="type">int</span> idx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_events[idx].data.fd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// task/echo_task.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::socket;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> task</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">EchoTask</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">EchoTask</span>() = <span class="keyword">delete</span>;</span><br><span class="line">            <span class="built_in">EchoTask</span>(<span class="type">int</span> sockfd);</span><br><span class="line">            ~<span class="built_in">EchoTask</span>();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 执行业务逻辑，执行完成返回true，否则返回false</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">run</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="comment">// 业务的销毁</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">destroy</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="type">int</span> m_sockfd = <span class="number">0</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// task/echo_task.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;task/echo_task.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::task;</span><br><span class="line"></span><br><span class="line">EchoTask::<span class="built_in">EchoTask</span>(<span class="type">int</span> sockfd) : <span class="built_in">m_sockfd</span>(sockfd)</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">EchoTask::~<span class="built_in">EchoTask</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">destroy</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">EchoTask::run</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">log_debug</span>(<span class="string">&quot;echo task run&quot;</span>);</span><br><span class="line">    <span class="comment">// 接收客户端数据</span></span><br><span class="line">    <span class="function">Socket <span class="title">socket</span><span class="params">(m_sockfd)</span></span>;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">int</span> len = socket.<span class="built_in">recv</span>(buf, <span class="built_in">sizeof</span>(buf));</span><br><span class="line">    <span class="keyword">if</span> (len &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (errno == EAGAIN || errno == EWOULDBLOCK)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 非阻塞IO模式下，recv()读取空的接收缓冲区或send()写入已满的发送缓冲区会返回-1</span></span><br><span class="line">            <span class="comment">// 错误码为EAGAIN或EWOULDBLOCK</span></span><br><span class="line">            <span class="built_in">log_debug</span>(<span class="string">&quot;socket recv would block: conn=%d errno=%d errmsg=%s&quot;</span>, m_sockfd, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (errno == EINTR)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// recv()接收客户端数据时被信号打断了</span></span><br><span class="line">            <span class="built_in">log_debug</span>(<span class="string">&quot;socket recv interrupted: conn=%d errno=%d errmsg=%s&quot;</span>, m_sockfd, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">log_debug</span>(<span class="string">&quot;socket connection abort: conn=%d errno=%d errmsg=%s&quot;</span>, m_sockfd, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (len == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_debug</span>(<span class="string">&quot;socket closed by peer: conn=%d&quot;</span>, m_sockfd);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">log_debug</span>(<span class="string">&quot;recv: conn=%d msg=%s&quot;</span>, m_sockfd, buf);</span><br><span class="line">    <span class="comment">// 向客户端发送数据</span></span><br><span class="line">    socket.<span class="built_in">send</span>(buf, len);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EchoTask::destroy</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">log_debug</span>(<span class="string">&quot;echo task destroy&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// socket/socket_handler.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/server_socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/event_poller.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> socket</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">SocketHandler</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">SINGLETON</span>(SocketHandler);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">listen</span><span class="params">(<span class="type">const</span> string &amp; ip, <span class="type">int</span> port)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">attach</span><span class="params">(Socket * socket)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">detach</span><span class="params">(Socket * socket)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">remove</span><span class="params">(Socket * socket)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">handle</span><span class="params">(<span class="type">int</span> max_conn, <span class="type">int</span> timeout)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            Socket * m_server = <span class="literal">nullptr</span>;</span><br><span class="line">            EventPoller m_epoll;</span><br><span class="line">            <span class="comment">// 记录每个连接的套接字到Socket*的映射关系</span></span><br><span class="line">            std::map&lt;<span class="type">int</span>, Socket*&gt; m_conns;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// socket/socket_handler.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/socket_handler.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;task/echo_task.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::socket;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::task;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SocketHandler::listen</span><span class="params">(<span class="type">const</span> string &amp; ip, <span class="type">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_server = <span class="keyword">new</span> <span class="built_in">ServerSocket</span>(ip, port);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SocketHandler::attach</span><span class="params">(Socket * socket)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_epoll.<span class="built_in">add</span>(socket-&gt;<span class="built_in">fd</span>(), (EPOLLIN | EPOLLHUP | EPOLLERR | EPOLLONESHOT));</span><br><span class="line">    m_conns[socket-&gt;<span class="built_in">fd</span>()] = socket;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SocketHandler::detach</span><span class="params">(Socket * socket)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_epoll.<span class="built_in">del</span>(socket-&gt;<span class="built_in">fd</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SocketHandler::remove</span><span class="params">(Socket * socket)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_epoll.<span class="built_in">del</span>(socket-&gt;<span class="built_in">fd</span>());</span><br><span class="line">    <span class="keyword">auto</span> it = m_conns.<span class="built_in">find</span>(socket-&gt;<span class="built_in">fd</span>());</span><br><span class="line">    <span class="keyword">if</span> (it != m_conns.<span class="built_in">end</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        m_conns.<span class="built_in">erase</span>(it);</span><br><span class="line">    &#125;</span><br><span class="line">    socket-&gt;<span class="built_in">close</span>();  </span><br><span class="line">    <span class="keyword">delete</span> socket;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SocketHandler::handle</span><span class="params">(<span class="type">int</span> max_conn, <span class="type">int</span> timeout)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_epoll.<span class="built_in">create</span>(max_conn);</span><br><span class="line">    m_epoll.<span class="built_in">add</span>(m_server-&gt;<span class="built_in">fd</span>(), (EPOLLIN | EPOLLHUP | EPOLLERR));</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> num = m_epoll.<span class="built_in">wait</span>(timeout);</span><br><span class="line">        <span class="keyword">if</span> (num &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">log_debug</span>(<span class="string">&quot;epoll wait error: errno=%d errmsg=%s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (num == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">log_debug</span>(<span class="string">&quot;epoll wait timeout&quot;</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; num; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (m_epoll.<span class="built_in">get_fd</span>(i) == m_server-&gt;<span class="built_in">fd</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 服务端套接字可读</span></span><br><span class="line">                <span class="type">int</span> connfd = m_server-&gt;<span class="built_in">accept</span>();</span><br><span class="line">                <span class="comment">// 将连接套接字添加到监听队列</span></span><br><span class="line">                <span class="keyword">auto</span> socket = <span class="keyword">new</span> <span class="built_in">Socket</span>(connfd);</span><br><span class="line">                <span class="built_in">attach</span>(socket);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 连接套接字出现可读事件</span></span><br><span class="line">                <span class="keyword">auto</span> socket = m_conns[m_epoll.<span class="built_in">get_fd</span>(i)];</span><br><span class="line">                <span class="keyword">if</span> (m_epoll.<span class="built_in">is_set</span>(i, EPOLLHUP))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 连接套接字挂断了</span></span><br><span class="line">                    <span class="built_in">log_error</span>(<span class="string">&quot;socket hang up by peer: conn=%d errno=%d errmsg=%s&quot;</span>, socket-&gt;<span class="built_in">fd</span>(), errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">                    <span class="built_in">remove</span>(socket);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (m_epoll.<span class="built_in">is_set</span>(i, EPOLLERR))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 连接套接字发生错误</span></span><br><span class="line">                    <span class="built_in">log_error</span>(<span class="string">&quot;socket error: conn=%d errno=%d errmsg=%s&quot;</span>, socket-&gt;<span class="built_in">fd</span>(), errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">                    <span class="built_in">remove</span>(socket);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (m_epoll.<span class="built_in">is_set</span>(i, EPOLLIN))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">detach</span>(socket);</span><br><span class="line">                    <span class="comment">// 接收客户端数据</span></span><br><span class="line">                    <span class="function">EchoTask <span class="title">task</span><span class="params">(socket-&gt;fd())</span></span>;</span><br><span class="line">                    <span class="keyword">if</span> (!task.<span class="built_in">run</span>())</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">remove</span>(socket);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">attach</span>(socket);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// server3.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/socket_handler.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::socket;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Singleton&lt;Logger&gt;::<span class="built_in">instance</span>()-&gt;<span class="built_in">open</span>(<span class="string">&quot;./server.log&quot;</span>);</span><br><span class="line">    <span class="keyword">auto</span> handler = Singleton&lt;SocketHandler&gt;::<span class="built_in">instance</span>();</span><br><span class="line">    handler-&gt;<span class="built_in">listen</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8080</span>);</span><br><span class="line">    handler-&gt;<span class="built_in">handle</span>(<span class="number">1024</span>, <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// client.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/client_socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::socket;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Singleton&lt;Logger&gt;::<span class="built_in">instance</span>()-&gt;<span class="built_in">open</span>(<span class="string">&quot;./client.log&quot;</span>);</span><br><span class="line">    <span class="function">ClientSocket <span class="title">client</span><span class="params">(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8080</span>)</span></span>;</span><br><span class="line">    <span class="comment">// 向服务端发送数据</span></span><br><span class="line">    string data = <span class="string">&quot;hello world&quot;</span>;</span><br><span class="line">    client.<span class="built_in">send</span>(data.<span class="built_in">c_str</span>(), data.<span class="built_in">size</span>());</span><br><span class="line">    <span class="comment">// 接收服务端的数据</span></span><br><span class="line">    <span class="type">char</span> buf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    client.<span class="built_in">recv</span>(buf, <span class="built_in">sizeof</span>(buf));</span><br><span class="line">    <span class="built_in">log_info</span>(<span class="string">&quot;recv: %s&quot;</span>, buf);</span><br><span class="line">    <span class="comment">// 基类Socket析构函数中会调用close()</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意：</p><ol><li>在阻塞模式下，客户端异常退出时服务端会检测到<code>EPOLLHUP</code>事件</li><li>在非阻塞模式下，<code>recv()</code>读取空的接收缓冲区，或者<code>send()</code>写入满的发送缓冲区，<code>recv()</code>函数返回<code>-1</code>，产生错误码为<code>EAGAIN(11)</code>，对应错误描述为：Resource temporarily unavailable</li><li>在读/写的时候出现中断错误，<code>recv()</code>函数返回<code>-1</code>，产生错误码为<code>EINTR(4)</code>，对应错误描述为：Interrupted system call</li></ol><p>考虑到网络编程可能会使用多线程环境，<code>SocketHandler</code>在主线程中负责客户端连接，客户端请求发送过来的数据则是在子线程中处理，在多线程环境中<code>SocketHandler</code>中类型为<code>std::map&lt;int, Socket*&gt;</code>的数据成员<code>m_conns</code>会出现问题，需要加锁访问。因此考虑将该数据成员去掉以简化<code>SocketHandler</code>类：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// socket/socket_handler.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/server_socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/event_poller.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> socket</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">SocketHandler</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">SINGLETON</span>(SocketHandler);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">listen</span><span class="params">(<span class="type">const</span> string &amp; ip, <span class="type">int</span> port)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">attach</span><span class="params">(<span class="type">int</span> sockfd)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">detach</span><span class="params">(<span class="type">int</span> sockfd)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">handle</span><span class="params">(<span class="type">int</span> max_conn, <span class="type">int</span> timeout)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            Socket * m_server = <span class="literal">nullptr</span>;</span><br><span class="line">            EventPoller m_epoll;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// socket/socket_handler.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/socket_handler.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;task/echo_task.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::socket;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::task;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SocketHandler::listen</span><span class="params">(<span class="type">const</span> string &amp; ip, <span class="type">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_server = <span class="keyword">new</span> <span class="built_in">ServerSocket</span>(ip, port); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SocketHandler::attach</span><span class="params">(<span class="type">int</span> sockfd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_epoll.<span class="built_in">add</span>(sockfd, (EPOLLIN | EPOLLHUP | EPOLLERR | EPOLLONESHOT));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SocketHandler::detach</span><span class="params">(<span class="type">int</span> sockfd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_epoll.<span class="built_in">del</span>(sockfd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SocketHandler::handle</span><span class="params">(<span class="type">int</span> max_conn, <span class="type">int</span> timeout)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_epoll.<span class="built_in">create</span>(max_conn);</span><br><span class="line">    m_epoll.<span class="built_in">add</span>(m_server-&gt;<span class="built_in">fd</span>(), (EPOLLIN | EPOLLHUP | EPOLLERR));</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> num = m_epoll.<span class="built_in">wait</span>(timeout);</span><br><span class="line">        <span class="keyword">if</span> (num &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">log_debug</span>(<span class="string">&quot;epoll wait error: errno=%d errmsg=%s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (num == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">log_debug</span>(<span class="string">&quot;epoll wait timeout&quot;</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; num; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (m_epoll.<span class="built_in">get_fd</span>(i) == m_server-&gt;<span class="built_in">fd</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 服务端套接字可读</span></span><br><span class="line">                <span class="type">int</span> connfd = m_server-&gt;<span class="built_in">accept</span>();</span><br><span class="line">                <span class="comment">// 将连接套接字添加到监听队列</span></span><br><span class="line">                <span class="function">Socket <span class="title">socket</span><span class="params">(connfd)</span></span>;</span><br><span class="line">                socket.<span class="built_in">set_non_blocking</span>();</span><br><span class="line">                <span class="built_in">attach</span>(connfd);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 连接套接字出现可读事件</span></span><br><span class="line">                <span class="type">int</span> connfd = m_epoll.<span class="built_in">get_fd</span>(i);</span><br><span class="line">                <span class="keyword">if</span> (m_epoll.<span class="built_in">is_set</span>(i, EPOLLHUP))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 连接套接字挂断了</span></span><br><span class="line">                    <span class="built_in">log_error</span>(<span class="string">&quot;socket hang up by peer: conn=%d errno=%d errmsg=%s&quot;</span>, connfd, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">                    <span class="built_in">detach</span>(connfd);</span><br><span class="line">                    ::<span class="built_in">close</span>(connfd);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (m_epoll.<span class="built_in">is_set</span>(i, EPOLLERR))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 连接套接字发生错误</span></span><br><span class="line">                    <span class="built_in">log_error</span>(<span class="string">&quot;socket error: conn=%d errno=%d errmsg=%s&quot;</span>, connfd, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">                    <span class="built_in">detach</span>(connfd);</span><br><span class="line">                    ::<span class="built_in">close</span>(connfd);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (m_epoll.<span class="built_in">is_set</span>(i, EPOLLIN))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">detach</span>(connfd);</span><br><span class="line">                    <span class="comment">// 接收客户端数据</span></span><br><span class="line">                    <span class="function">EchoTask <span class="title">task</span><span class="params">(connfd)</span></span>;</span><br><span class="line">                    <span class="keyword">if</span> (!task.<span class="built_in">run</span>())</span><br><span class="line">                    &#123;</span><br><span class="line">                        ::<span class="built_in">close</span>(connfd);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">attach</span>(connfd);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="epoll总结">epoll总结</h1><p>优点：</p><ol><li>没有文件描述符个数的限制；</li><li>IO效率不随文件描述符数量增加而线性下降；</li><li>使用<code>mmap</code>内存映射加速内核与用户空间的数据传递，不存在复制开销；</li><li>无需遍历整个被监听的文件描述符集合，只需要遍历那些被内核IO事件唤醒而加入就绪队列的文件描述符集合即可；</li><li>epoll除了提供select和poll那种IO事件的水平触发外，还提供了边缘触发，这就使得用户空间程序有可能缓存IO状态，减少<code>epoll_wait()</code>的调用，提高应用程序效率</li></ol><p>缺点：</p><p>epoll跨平台性不够，只能工作在Linux下</p>]]></content>
      
      
      
        <tags>
            
            <tag> C++后端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IO多路复用之poll</title>
      <link href="/2024/09/09/IO%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%E4%B9%8Bpoll/"/>
      <url>/2024/09/09/IO%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%E4%B9%8Bpoll/</url>
      
        <content type="html"><![CDATA[<h1 id="io多路复用之poll模型">IO多路复用之poll模型</h1><h2 id="poll简介">poll简介</h2><p>poll函数提供了类似于select的功能，允许进程向内核指示等待多个事件中的任何一个发生，它只在有一个或多个事件发生或经历一段指定时间后才唤醒进程。不过，与select相比，poll无最大文件描述符数量的限制。</p><h3 id="poll函数">poll函数</h3><h4 id="函数原型">函数原型</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">poll</span><span class="params">(<span class="keyword">struct</span> pollfd * fds, <span class="type">nfds_t</span> nfds, <span class="type">int</span> timeout)</span></span>;</span><br></pre></td></tr></table></figure><h4 id="参数说明">参数说明</h4><ul><li><code>fds</code>：一个指向一个<code>pollfd</code>结构体数组的指针，数组中每个成员都代表一个特定的文件描述符以及对它感兴趣的事件和发生的事件</li><li><code>nfds</code>：<code>fds</code>数组的成员数量</li><li><code>timeout</code>：调用应等待的最大毫秒数，以阻塞的方式等待文件描述符变为就绪</li></ul><p>其中，<code>timeout</code>参数分为三种情况：</p><ol><li>如果值为<code>-1</code>，<code>poll()</code>将会无限期地阻塞</li><li>如果值为<code>0</code>，<code>poll()</code>将立即返回</li><li>如果值大于<code>0</code>，<code>poll()</code>将等待一段时间再返回，精度为毫秒ms</li></ol><h4 id="返回值">返回值</h4><ul><li>成功：表示有多少个文件描述符有就绪事件发生</li><li>错误：返回<code>-1</code></li><li>超时：返回<code>0</code></li></ul><h3 id="pollfd结构体">pollfd结构体</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">pollfd</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">int</span> fd;<span class="comment">// 文件描述符</span></span><br><span class="line">   <span class="type">short</span> events;<span class="comment">// 要监听的事件</span></span><br><span class="line">    <span class="type">short</span> revents;<span class="comment">// 实际发生的事件</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li><code>fd</code>：需要被poll监听的文件描述符</li><li><code>events</code>：一组位标志，表示对应的文件描述符上我们感兴趣的事件，比如<code>POLLIN</code>(有数据可读)、<code>POLLOUT</code>(写数据不会阻塞)、<code>POLLERR</code>(错误事件)、<code>POLLHUP</code>(挂起事件)等</li><li><code>revents</code>：一组位标志，表示在对应的文件描述符上实际发生了哪些事件，这是<code>poll()</code>调用返回后由内核填充的</li></ul><h4 id="事件类型">事件类型</h4><ul><li><code>POLLIN</code>：有数据可读</li><li><code>POLLOUT</code>：写数据不会阻塞</li><li><code>POLLERR</code>：错误事件</li><li><code>POLLHUP</code>：挂起事件</li></ul><table><thead><tr><th style="text-align:center">常量</th><th style="text-align:center">说明</th></tr></thead><tbody><tr><td style="text-align:center">POLLIN</td><td style="text-align:center">普通或优先级带数据可读</td></tr><tr><td style="text-align:center">POLLRDNORM</td><td style="text-align:center">普通数据可读</td></tr><tr><td style="text-align:center">POLLRDBAND</td><td style="text-align:center">优先级带数据可读</td></tr><tr><td style="text-align:center">POLLPRI</td><td style="text-align:center">高优先级数据可读</td></tr><tr><td style="text-align:center">POLLOUT</td><td style="text-align:center">普通数据可写</td></tr><tr><td style="text-align:center">POLLWRNORM</td><td style="text-align:center">普通数据可写</td></tr><tr><td style="text-align:center">POLLWRBAND</td><td style="text-align:center">优先级带数据可写</td></tr><tr><td style="text-align:center">POLLERR</td><td style="text-align:center">发生错误</td></tr><tr><td style="text-align:center">POLLHUP</td><td style="text-align:center">发生挂起</td></tr><tr><td style="text-align:center">POLLNVAL</td><td style="text-align:center">描述字不是一个打开的文件</td></tr></tbody></table><p>当调用<code>poll()</code>函数时，内核会检查每个<code>pollfd</code>结构体中列出的文件描述符，看看是否有任何指定的事件发生。如果有，内核将会在<code>revents</code>字段中设置相应的位，以指示哪些事件已经发生。然后<code>poll()</code>函数返回，应用程序可以检查每个<code>pollfd</code>结构体的<code>revents</code>字段来确定每个文件描述符上发生了哪些事件。<br>当需要监听多个事件时，使用<code>events | POLLIN</code>设置<code>events</code>域；当<code>poll()</code>调用之后检测某事件是否就绪时，<code>revents &amp; POLLIN</code>进行判断。</p><h2 id="poll代码实现">poll代码实现</h2><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CMakeLists.txt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.19</span>)</span><br><span class="line"><span class="keyword">project</span>(poll)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD <span class="number">11</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">include_directories</span>(<span class="string">&quot;./&quot;</span>)</span><br><span class="line"><span class="keyword">file</span>(GLOB_RECURSE SOURCES <span class="string">&quot;utility/*.cpp&quot;</span> <span class="string">&quot;socket/*.cpp&quot;</span> <span class="string">&quot;task/*.cpp&quot;</span>)</span><br><span class="line"><span class="keyword">add_executable</span>(server <span class="variable">$&#123;SOURCES&#125;</span> server.cpp)</span><br><span class="line"><span class="keyword">add_executable</span>(client <span class="variable">$&#123;SOURCES&#125;</span> client.cpp)</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// socket/poller.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> socket</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Poller</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">Poller</span>();</span><br><span class="line">            ~<span class="built_in">Poller</span>();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建pollfd数组</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">create</span><span class="params">(<span class="type">int</span> max_conn)</span></span>;</span><br><span class="line">            <span class="comment">// 向pollfd数组中添加要监听的socket</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">add</span><span class="params">(<span class="type">int</span> fd)</span></span>;</span><br><span class="line">            <span class="comment">// 从pollfd数组中删除监听的socket</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">del</span><span class="params">(<span class="type">int</span> fd)</span></span>;</span><br><span class="line">            <span class="comment">// 从pollfd数组中判断该socket有无事件触发</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">is_set</span><span class="params">(<span class="type">int</span> fd)</span></span>;</span><br><span class="line">            <span class="comment">// milliseconds为poll()调用应等待的最大毫秒数</span></span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">poll</span><span class="params">(<span class="type">int</span> milliseconds)</span></span>;</span><br><span class="line">            <span class="comment">// 获取pollfd数组中有效socket的最大下标</span></span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">max_fd</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="comment">// 根据数组下标获取对应的fd</span></span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">get_fd</span><span class="params">(<span class="type">int</span> idx)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="comment">// 指向一个pollfd结构体数组的指针</span></span><br><span class="line">            <span class="comment">// 数组中每个元素代表一个特定的文件描述符以及对它感兴趣的事件和发生的事件</span></span><br><span class="line">            <span class="keyword">struct</span> <span class="title class_">pollfd</span> * m_fds;</span><br><span class="line">            <span class="comment">// 最大连接数</span></span><br><span class="line">            <span class="type">int</span> m_max_conn;</span><br><span class="line">            <span class="comment">// pollfd数组中有效socket的最大下标</span></span><br><span class="line">            <span class="type">int</span> m_max_fd;</span><br><span class="line">            <span class="comment">// 记录fd到pollfd结构体数组下标的映射关系</span></span><br><span class="line">            std::map&lt;<span class="type">int</span>, <span class="type">int</span>&gt; m_fds_map;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// socket/poller.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/poller.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::socket;</span><br><span class="line"></span><br><span class="line">Poller::<span class="built_in">Poller</span>() : <span class="built_in">m_fds</span>(<span class="literal">nullptr</span>), <span class="built_in">m_max_conn</span>(<span class="number">0</span>), <span class="built_in">m_max_fd</span>(<span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Poller::~<span class="built_in">Poller</span>()</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Poller::create</span><span class="params">(<span class="type">int</span> max_conn)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_fds = <span class="keyword">new</span> pollfd[max_conn];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; max_conn; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        m_fds[i].fd = <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    m_max_conn = max_conn;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Poller::add</span><span class="params">(<span class="type">int</span> fd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 把新的连接socket加入到监听队列中</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; m_max_conn; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (m_fds[i].fd == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 找到第一个空闲的pollfd</span></span><br><span class="line">            m_fds[i].fd = fd;</span><br><span class="line">            m_fds[i].events = POLLIN;</span><br><span class="line">            m_max_fd = std::<span class="built_in">max</span>(m_max_fd, i);</span><br><span class="line">            m_fds_map[fd] = i;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Poller::del</span><span class="params">(<span class="type">int</span> fd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> it = m_fds_map.<span class="built_in">find</span>(fd);</span><br><span class="line">    <span class="keyword">if</span> (it == m_fds_map.<span class="built_in">end</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    m_fds[it-&gt;second].fd = <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Poller::is_set</span><span class="params">(<span class="type">int</span> fd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> it = m_fds_map.<span class="built_in">find</span>(fd);</span><br><span class="line">    <span class="keyword">if</span> (it == m_fds_map.<span class="built_in">end</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 检测fd是否有可读事件发生</span></span><br><span class="line">    <span class="keyword">return</span> m_fds[it-&gt;second].revents &amp; POLLIN;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Poller::poll</span><span class="params">(<span class="type">int</span> milliseconds)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ::<span class="built_in">poll</span>(m_fds, m_max_fd + <span class="number">1</span>, milliseconds);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Poller::max_fd</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_max_fd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Poller::get_fd</span><span class="params">(<span class="type">int</span> idx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_fds[idx].fd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// server.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/server_socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::socket;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 最多监听套接字的数量</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_CONN 1024</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Singleton&lt;Logger&gt;::<span class="built_in">instance</span>()-&gt;<span class="built_in">open</span>(<span class="string">&quot;./server.log&quot;</span>);</span><br><span class="line">    <span class="function">ServerSocket <span class="title">server</span><span class="params">(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8080</span>)</span></span>;</span><br><span class="line">    <span class="comment">// 定义一个pollfd结构体数组</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">pollfd</span> fds[MAX_CONN];</span><br><span class="line">    <span class="comment">// 先初始化pollfd结构体数组</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MAX_CONN; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 将文件描述符fd设置为-1，这样内核可以忽略它</span></span><br><span class="line">        fds[i].fd = <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将服务端socket加入到队列中</span></span><br><span class="line">    fds[<span class="number">0</span>].fd = server.<span class="built_in">fd</span>();</span><br><span class="line">    fds[<span class="number">0</span>].events = POLLIN;</span><br><span class="line">    <span class="comment">// 在结构体数组fds中目前最大下标是0</span></span><br><span class="line">    <span class="type">int</span> max_fd = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// -1表示一直等待</span></span><br><span class="line">        <span class="type">int</span> num = <span class="built_in">poll</span>(fds, max_fd + <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">        <span class="keyword">if</span> (num &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">log_error</span>(<span class="string">&quot;poll error: errno=%d errmsg=%s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (num == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">log_error</span>(<span class="string">&quot;poll timeout&quot;</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">log_debug</span>(<span class="string">&quot;poll ok: num=%d&quot;</span>, num);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; max_fd + <span class="number">1</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!(fds[i].revents &amp; POLLIN))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 如果没有可读事件发生</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 是服务端监听socket有可读事件，即有客户端连接过来</span></span><br><span class="line">                <span class="type">int</span> connfd = server.<span class="built_in">accept</span>();</span><br><span class="line">                <span class="keyword">if</span> (connfd &lt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">log_error</span>(<span class="string">&quot;server accept error: errno=%d errmsg=%s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 将新的连接socket加入到监听队列中</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> k = <span class="number">0</span>; k &lt; MAX_CONN; k++)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 找到第一个空闲的pollfd</span></span><br><span class="line">                    <span class="keyword">if</span> (fds[k].fd == <span class="number">-1</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        fds[k].fd = connfd;</span><br><span class="line">                        fds[k].events = POLLIN;</span><br><span class="line">                        max_fd = std::<span class="built_in">max</span>(max_fd, connfd);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 是服务端连接socket有可读事件</span></span><br><span class="line">                Socket <span class="built_in">client</span>(fds[i].fd);</span><br><span class="line">                <span class="comment">// 接收客户端数据</span></span><br><span class="line">                <span class="type">char</span> buf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">                <span class="type">size_t</span> len = client.<span class="built_in">recv</span>(buf, <span class="built_in">sizeof</span>(buf));</span><br><span class="line">                <span class="keyword">if</span> (len &lt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 在阻塞IO模式recv()返回-1即出现错误</span></span><br><span class="line">                    <span class="built_in">log_error</span>(<span class="string">&quot;recv error: errno=%d errmsg=%d&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (len == <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 客户端关闭连接了</span></span><br><span class="line">                    <span class="built_in">log_debug</span>(<span class="string">&quot;socket closed by peer: connfd=%d&quot;</span>, fds[i].fd);</span><br><span class="line">                    <span class="comment">// 由于客户端已关闭连接，服务端需要将连接socket从监听队列中移除</span></span><br><span class="line">                    <span class="comment">// 将文件描述符fd设置为-1，内核即可忽略它</span></span><br><span class="line">                    fds[i].fd = <span class="number">-1</span>;</span><br><span class="line">                    client.<span class="built_in">close</span>();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 接收到客户端正常发送的数据</span></span><br><span class="line">                    <span class="built_in">log_debug</span>(<span class="string">&quot;recv: conn=%d msg=%s&quot;</span>, fds[i].fd, buf);</span><br><span class="line">                    <span class="comment">// 向客户端发送数据</span></span><br><span class="line">                    client.<span class="built_in">send</span>(buf, len);</span><br><span class="line">                    <span class="comment">// 调用服务端连接socket的close()，以避免其析构时关闭连接</span></span><br><span class="line">                    client.<span class="built_in">clear</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// client.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/client_socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::socket;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Singleton&lt;Logger&gt;::<span class="built_in">instance</span>()-&gt;<span class="built_in">open</span>(<span class="string">&quot;./client.log&quot;</span>);</span><br><span class="line">    <span class="function">ClientSocket <span class="title">client</span><span class="params">(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8080</span>)</span></span>;</span><br><span class="line">    <span class="comment">// 向服务端发送数据</span></span><br><span class="line">    string data = <span class="string">&quot;hello world&quot;</span>;</span><br><span class="line">    client.<span class="built_in">send</span>(data.<span class="built_in">c_str</span>(), data.<span class="built_in">size</span>());</span><br><span class="line">    <span class="comment">// 接收服务端的数据</span></span><br><span class="line">    <span class="type">char</span> buf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    client.<span class="built_in">recv</span>(buf, <span class="built_in">sizeof</span>(buf));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Recv: %s\n&quot;</span>, buf);</span><br><span class="line">    <span class="comment">// 基类Socket析构函数中会调用close()</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="poll代码封装">poll代码封装</h2><p>用C++对简陋的C风格poll代码实现进行封装调整：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// socket/socket_handler.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/server_socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/poller.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> socket</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">SocketHandler</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 单例模式</span></span><br><span class="line">            <span class="built_in">SINGLETON</span>(SocketHandler);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="comment">// 通过IP和端口启动服务</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">listen</span><span class="params">(<span class="type">const</span> string &amp; ip, <span class="type">int</span> port)</span></span>;</span><br><span class="line">            <span class="comment">// 将socket加入到监听队列中</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">attach</span><span class="params">(Socket * socket)</span></span>;</span><br><span class="line">            <span class="comment">// 将socket从监听队列中移除，不再监听其事件</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">detach</span><span class="params">(Socket * socket)</span></span>;</span><br><span class="line">            <span class="comment">// 将socket从监听队列中移除，并关闭socket，从映射表中删掉</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">remove</span><span class="params">(Socket * socket)</span></span>;</span><br><span class="line">            <span class="comment">// max_conn为最大连接数，timeout为超时时间，单位ms</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">handle</span><span class="params">(<span class="type">int</span> max_conn, <span class="type">int</span> timeout)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="comment">// 服务端监听socket</span></span><br><span class="line">            Socket * m_server = <span class="literal">nullptr</span>;</span><br><span class="line">            <span class="comment">// poller轮询对象</span></span><br><span class="line">            Poller m_poller;</span><br><span class="line">            <span class="comment">// 从socket的fd到Socket*的映射关系</span></span><br><span class="line">            std::map&lt;<span class="type">int</span>, Socket *&gt; m_conns;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// socket/socket_handler.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/socket_handler.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::socket;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SocketHandler::listen</span><span class="params">(<span class="type">const</span> string &amp; ip, <span class="type">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_server = <span class="keyword">new</span> <span class="built_in">ServerSocket</span>(ip, port);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SocketHandler::attach</span><span class="params">(Socket * socket)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_poller.<span class="built_in">add</span>(socket-&gt;<span class="built_in">fd</span>());</span><br><span class="line">    m_conns[socket-&gt;<span class="built_in">fd</span>()] = socket;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SocketHandler::detach</span><span class="params">(Socket * socket)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_poller.<span class="built_in">del</span>(socket-&gt;<span class="built_in">fd</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SocketHandler::remove</span><span class="params">(Socket * socket)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_poller.<span class="built_in">del</span>(socket-&gt;<span class="built_in">fd</span>());</span><br><span class="line">    socket-&gt;<span class="built_in">close</span>();</span><br><span class="line">    <span class="keyword">auto</span> it = m_conns.<span class="built_in">find</span>(socket-&gt;<span class="built_in">fd</span>());</span><br><span class="line">    <span class="keyword">if</span> (it != m_conns.<span class="built_in">end</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        m_conns.<span class="built_in">erase</span>(it);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">delete</span> socket;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SocketHandler::handle</span><span class="params">(<span class="type">int</span> max_conn, <span class="type">int</span> timeout)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 初始化Poller</span></span><br><span class="line">    m_poller.<span class="built_in">create</span>(max_conn);</span><br><span class="line">    <span class="comment">// 将服务端监听socket添加到队列中</span></span><br><span class="line">    m_poller.<span class="built_in">add</span>(m_server-&gt;<span class="built_in">fd</span>());</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> num = m_poller.<span class="built_in">poll</span>(timeout);</span><br><span class="line">        <span class="keyword">if</span> (num &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">log_error</span>(<span class="string">&quot;poll error: errno=%d, errmsg=%s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (num == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">log_error</span>(<span class="string">&quot;poll timeout&quot;</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">log_debug</span>(<span class="string">&quot;poll ok: num=%d&quot;</span>, num);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; m_poller.<span class="built_in">max_fd</span>() + <span class="number">1</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!m_poller.<span class="built_in">is_set</span>(m_poller.<span class="built_in">get_fd</span>(i)))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (num-- == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 服务端socket可读</span></span><br><span class="line">                <span class="type">int</span> connfd = m_server-&gt;<span class="built_in">accept</span>();</span><br><span class="line">                <span class="keyword">if</span> (connfd &lt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">log_error</span>(<span class="string">&quot;server accept error: errno=%d, errmsg=%s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 把新的连接socket加入到监听队列中</span></span><br><span class="line">                    <span class="keyword">auto</span> socket = <span class="keyword">new</span> <span class="built_in">Socket</span>(connfd);</span><br><span class="line">                    <span class="built_in">attach</span>(socket);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 连接socket可读</span></span><br><span class="line">                <span class="keyword">auto</span> socket = m_conns[m_poller.<span class="built_in">get_fd</span>(i)];</span><br><span class="line">                <span class="comment">// 先暂时将连接socket从监听队列中移除</span></span><br><span class="line">                <span class="built_in">detach</span>(socket);</span><br><span class="line">                <span class="comment">// 接收客户端的数据</span></span><br><span class="line">                <span class="type">char</span> buf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">                <span class="type">size_t</span> len = socket-&gt;<span class="built_in">recv</span>(buf, <span class="built_in">sizeof</span>(buf));</span><br><span class="line">                <span class="keyword">if</span> (len &lt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">log_error</span>(<span class="string">&quot;recv error: errno=%d, errmsg=%s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (len == <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 客户端已关闭连接</span></span><br><span class="line">                    <span class="built_in">log_debug</span>(<span class="string">&quot;socket closed by peer: conn=%d&quot;</span>, m_poller.<span class="built_in">get_fd</span>(i));</span><br><span class="line">                    <span class="built_in">remove</span>(socket);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">log_debug</span>(<span class="string">&quot;recv: connfd=%d msg=%s&quot;</span>, m_poller.<span class="built_in">get_fd</span>(i), buf);</span><br><span class="line">                    <span class="comment">// 向客户端发送数据</span></span><br><span class="line">                    socket-&gt;<span class="built_in">send</span>(buf, len);</span><br><span class="line">                    <span class="comment">// 业务逻辑处理完毕，将该连接socket重新加入到监听队列中</span></span><br><span class="line">                    <span class="built_in">attach</span>(socket);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// server.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/socket_handler.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::socket;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Singleton&lt;Logger&gt;::<span class="built_in">instance</span>()-&gt;<span class="built_in">open</span>(<span class="string">&quot;./server.log&quot;</span>);</span><br><span class="line">    <span class="keyword">auto</span> handler = Singleton&lt;SocketHandler&gt;::<span class="built_in">instance</span>();</span><br><span class="line">    handler-&gt;<span class="built_in">listen</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8080</span>);</span><br><span class="line">    handler-&gt;<span class="built_in">handle</span>(<span class="number">2048</span>, <span class="number">2000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// client.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/client_socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::socket;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Singleton&lt;Logger&gt;::<span class="built_in">instance</span>()-&gt;<span class="built_in">open</span>(<span class="string">&quot;./client.log&quot;</span>);</span><br><span class="line">    <span class="function">ClientSocket <span class="title">client</span><span class="params">(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8080</span>)</span></span>;</span><br><span class="line">    <span class="comment">// 向服务端发送数据</span></span><br><span class="line">    string data = <span class="string">&quot;hello world&quot;</span>;</span><br><span class="line">    client.<span class="built_in">send</span>(data.<span class="built_in">c_str</span>(), data.<span class="built_in">size</span>());</span><br><span class="line">    <span class="comment">// 接收服务端的数据</span></span><br><span class="line">    <span class="type">char</span> buf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    client.<span class="built_in">recv</span>(buf, <span class="built_in">sizeof</span>(buf));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Recv: %s\n&quot;</span>, buf);</span><br><span class="line">    <span class="comment">// 基类Socket析构函数中会调用close()</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="业务与框架分离">业务与框架分离</h2><p>在<code>ScoketHandler::handle()</code>中框架处理逻辑基本不会改动，但从客户端接受数据、向客户端发送数据等业务逻辑实现是会随时变动的，为了避免因为业务变动而修改框架代码，可以进一步引入<code>EchoTask</code>类来将业务逻辑与框架分离开来：</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CMakeLists.txt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.19</span>)</span><br><span class="line"><span class="keyword">project</span>(poll)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD <span class="number">11</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">include_directories</span>(<span class="string">&quot;./&quot;</span>)</span><br><span class="line"><span class="keyword">file</span>(GLOB_RECURSE SOURCES <span class="string">&quot;utility/*.cpp&quot;</span> <span class="string">&quot;socket/*.cpp&quot;</span> <span class="string">&quot;task/*.cpp&quot;</span>)</span><br><span class="line"><span class="keyword">add_executable</span>(server <span class="variable">$&#123;SOURCES&#125;</span> server.cpp)</span><br><span class="line"><span class="keyword">add_executable</span>(client <span class="variable">$&#123;SOURCES&#125;</span> client.cpp)</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// socket/poller.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> socket</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Poller</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">Poller</span>();</span><br><span class="line">            ~<span class="built_in">Poller</span>();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建pollfd数组</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">create</span><span class="params">(<span class="type">int</span> max_conn)</span></span>;</span><br><span class="line">            <span class="comment">// 向pollfd数组中添加要监听的socket</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">add</span><span class="params">(<span class="type">int</span> fd)</span></span>;</span><br><span class="line">            <span class="comment">// 从pollfd数组中删除监听的socket</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">del</span><span class="params">(<span class="type">int</span> fd)</span></span>;</span><br><span class="line">            <span class="comment">// 从pollfd数组中判断该socket有无事件触发</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">is_set</span><span class="params">(<span class="type">int</span> idx, <span class="type">short</span> events)</span></span>;</span><br><span class="line">            <span class="comment">// milliseconds为poll()调用应等待的最大毫秒数</span></span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">poll</span><span class="params">(<span class="type">int</span> milliseconds)</span></span>;</span><br><span class="line">            <span class="comment">// 获取pollfd数组中有效socket的最大下标</span></span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">max_fd</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="comment">// 根据数组下标获取对应的fd</span></span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">get_fd</span><span class="params">(<span class="type">int</span> idx)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="comment">// 指向一个pollfd结构体数组的指针</span></span><br><span class="line">            <span class="comment">// 数组中每个元素代表一个特定的文件描述符以及对它感兴趣的事件和发生的事件</span></span><br><span class="line">            <span class="keyword">struct</span> <span class="title class_">pollfd</span> * m_fds;</span><br><span class="line">            <span class="comment">// 最大连接数</span></span><br><span class="line">            <span class="type">int</span> m_max_conn;</span><br><span class="line">            <span class="comment">// pollfd数组中有效socket的最大下标</span></span><br><span class="line">            <span class="type">int</span> m_max_fd;</span><br><span class="line">            <span class="comment">// 记录fd到pollfd结构体数组下标的映射关系</span></span><br><span class="line">            std::map&lt;<span class="type">int</span>, <span class="type">int</span>&gt; m_fds_map;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// socket/poller.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/poller.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::socket;</span><br><span class="line"></span><br><span class="line">Poller::<span class="built_in">Poller</span>() : <span class="built_in">m_fds</span>(<span class="literal">nullptr</span>), <span class="built_in">m_max_conn</span>(<span class="number">0</span>), <span class="built_in">m_max_fd</span>(<span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Poller::~<span class="built_in">Poller</span>()</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Poller::create</span><span class="params">(<span class="type">int</span> max_conn)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_fds = <span class="keyword">new</span> pollfd[max_conn];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; max_conn; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        m_fds[i].fd = <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    m_max_conn = max_conn;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Poller::add</span><span class="params">(<span class="type">int</span> fd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 把新的连接socket加入到监听队列中</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; m_max_conn; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (m_fds[i].fd == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 找到第一个空闲的pollfd</span></span><br><span class="line">            m_fds[i].fd = fd;</span><br><span class="line">            m_fds[i].events = POLLIN | POLLHUP | POLLERR;</span><br><span class="line">            m_max_fd = std::<span class="built_in">max</span>(m_max_fd, i);</span><br><span class="line">            m_fds_map[fd] = i;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Poller::del</span><span class="params">(<span class="type">int</span> fd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> it = m_fds_map.<span class="built_in">find</span>(fd);</span><br><span class="line">    <span class="keyword">if</span> (it == m_fds_map.<span class="built_in">end</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    m_fds[it-&gt;second].fd = <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Poller::is_set</span><span class="params">(<span class="type">int</span> idx, <span class="type">short</span> events)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_fds[idx].revents &amp; events;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Poller::poll</span><span class="params">(<span class="type">int</span> milliseconds)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ::<span class="built_in">poll</span>(m_fds, m_max_fd + <span class="number">1</span>, milliseconds);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Poller::max_fd</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_max_fd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Poller::get_fd</span><span class="params">(<span class="type">int</span> idx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_fds[idx].fd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// task/echo_task.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::socket;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> task</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">EchoTask</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">EchoTask</span>() = <span class="keyword">delete</span>;</span><br><span class="line">            <span class="built_in">EchoTask</span>(<span class="type">int</span> sockfd);</span><br><span class="line">            ~<span class="built_in">EchoTask</span>();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 执行业务逻辑，执行完成返回true，否则返回false</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">run</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="comment">// 业务的销毁</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">destroy</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="type">int</span> m_sockfd = <span class="number">0</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// task/echo_task.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;task/echo_task.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::task;</span><br><span class="line"></span><br><span class="line">EchoTask::<span class="built_in">EchoTask</span>(<span class="type">int</span> sockfd) : <span class="built_in">m_sockfd</span>(sockfd)</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">EchoTask::~<span class="built_in">EchoTask</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">destroy</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">EchoTask::run</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">log_debug</span>(<span class="string">&quot;echo task run&quot;</span>);</span><br><span class="line">    <span class="comment">// 接收客户端数据</span></span><br><span class="line">    <span class="function">Socket <span class="title">socket</span><span class="params">(m_sockfd)</span></span>;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">int</span> len = socket.<span class="built_in">recv</span>(buf, <span class="built_in">sizeof</span>(buf));</span><br><span class="line">    <span class="keyword">if</span> (len &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (errno == EAGAIN || errno == EWOULDBLOCK)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 非阻塞IO模式下，recv()读取空的接收缓冲区或send()写入已满的发送缓冲区会返回-1</span></span><br><span class="line">            <span class="comment">// 错误码为EAGAIN或EWOULDBLOCK</span></span><br><span class="line">            <span class="built_in">log_debug</span>(<span class="string">&quot;socket recv would block: conn=%d errno=%d errmsg=%s&quot;</span>, m_sockfd, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (errno == EINTR)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// recv()接收客户端数据时被信号打断了</span></span><br><span class="line">            <span class="built_in">log_debug</span>(<span class="string">&quot;socket recv interrupted: conn=%d errno=%d errmsg=%s&quot;</span>, m_sockfd, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">log_debug</span>(<span class="string">&quot;socket connection abort: conn=%d errno=%d errmsg=%s&quot;</span>, m_sockfd, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (len == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_debug</span>(<span class="string">&quot;socket closed by peer: conn=%d&quot;</span>, m_sockfd);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">log_debug</span>(<span class="string">&quot;recv: conn=%d msg=%s&quot;</span>, m_sockfd, buf);</span><br><span class="line">    <span class="comment">// 向客户端发送数据</span></span><br><span class="line">    socket.<span class="built_in">send</span>(buf, len);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EchoTask::destroy</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">log_debug</span>(<span class="string">&quot;echo task destroy&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// socket/socket_handler.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/server_socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/poller.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> socket</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">SocketHandler</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 单例模式</span></span><br><span class="line">            <span class="built_in">SINGLETON</span>(SocketHandler);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="comment">// 通过IP和端口启动服务</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">listen</span><span class="params">(<span class="type">const</span> string &amp; ip, <span class="type">int</span> port)</span></span>;</span><br><span class="line">            <span class="comment">// 将socket加入到监听队列中</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">attach</span><span class="params">(<span class="type">int</span> sockfd)</span></span>;</span><br><span class="line">            <span class="comment">// 将socket从监听队列中移除，不再监听其事件</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">detach</span><span class="params">(<span class="type">int</span> sockfd)</span></span>;</span><br><span class="line">            <span class="comment">// max_conn为最大连接数，timeout为超时时间，单位ms</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">handle</span><span class="params">(<span class="type">int</span> max_conn, <span class="type">int</span> timeout)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="comment">// 服务端监听socket</span></span><br><span class="line">            Socket * m_server = <span class="literal">nullptr</span>;</span><br><span class="line">            <span class="comment">// poller轮询对象</span></span><br><span class="line">            Poller m_poller;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// socket/socket_handler.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/socket_handler.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::socket;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;task/echo_task.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::task;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SocketHandler::listen</span><span class="params">(<span class="type">const</span> string &amp; ip, <span class="type">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_server = <span class="keyword">new</span> <span class="built_in">ServerSocket</span>(ip, port);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SocketHandler::attach</span><span class="params">(<span class="type">int</span> sockfd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_poller.<span class="built_in">add</span>(sockfd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SocketHandler::detach</span><span class="params">(<span class="type">int</span> sockfd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_poller.<span class="built_in">del</span>(sockfd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SocketHandler::handle</span><span class="params">(<span class="type">int</span> max_conn, <span class="type">int</span> timeout)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 初始化Poller</span></span><br><span class="line">    m_poller.<span class="built_in">create</span>(max_conn);</span><br><span class="line">    <span class="comment">// 将服务端监听socket添加到队列中</span></span><br><span class="line">    <span class="built_in">attach</span>(m_server-&gt;<span class="built_in">fd</span>());</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> num = m_poller.<span class="built_in">poll</span>(timeout);</span><br><span class="line">        <span class="keyword">if</span> (num &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">log_error</span>(<span class="string">&quot;poll error: errno=%d, errmsg=%s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (num == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">log_error</span>(<span class="string">&quot;poll timeout&quot;</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">log_debug</span>(<span class="string">&quot;poll ok: num=%d&quot;</span>, num);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; m_poller.<span class="built_in">max_fd</span>() + <span class="number">1</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!m_poller.<span class="built_in">is_set</span>(i, POLLIN | POLLHUP | POLLERR))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (num-- == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 服务端socket可读</span></span><br><span class="line">                <span class="type">int</span> connfd = m_server-&gt;<span class="built_in">accept</span>();</span><br><span class="line">                <span class="keyword">if</span> (connfd &lt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">log_error</span>(<span class="string">&quot;server accept error: errno=%d, errmsg=%s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 把新的连接socket加入到监听队列中</span></span><br><span class="line">                    Socket <span class="built_in">socket</span>(connfd);</span><br><span class="line">                    <span class="comment">// 将该连接socket设置为非阻塞模式</span></span><br><span class="line">                    socket.<span class="built_in">set_non_blocking</span>();</span><br><span class="line">                    <span class="built_in">attach</span>(connfd);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 连接socket可读</span></span><br><span class="line">                <span class="type">int</span> connfd = m_poller.<span class="built_in">get_fd</span>(i);</span><br><span class="line">                <span class="keyword">if</span> (m_poller.<span class="built_in">is_set</span>(i, POLLHUP))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 连接socket挂了</span></span><br><span class="line">                    <span class="built_in">log_error</span>(<span class="string">&quot;socket hang up by peer: conn=%d&quot;</span>, connfd);</span><br><span class="line">                    <span class="built_in">detach</span>(connfd);</span><br><span class="line">                    ::<span class="built_in">close</span>(connfd);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (m_poller.<span class="built_in">is_set</span>(i, POLLERR))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 连接发生错误</span></span><br><span class="line">                    <span class="built_in">log_error</span>(<span class="string">&quot;socket error: conn=%d&quot;</span>, connfd);</span><br><span class="line">                    <span class="built_in">detach</span>(connfd);</span><br><span class="line">                    ::<span class="built_in">close</span>(connfd);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (m_poller.<span class="built_in">is_set</span>(i, POLLIN))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 先暂时将连接socket从监听队列中移除</span></span><br><span class="line">                    <span class="built_in">detach</span>(connfd);</span><br><span class="line">                    <span class="comment">// 接收客户端的数据</span></span><br><span class="line">                    <span class="comment">// EchoTask为业务类</span></span><br><span class="line">                    <span class="function">EchoTask <span class="title">task</span><span class="params">(connfd)</span></span>;</span><br><span class="line">                    <span class="keyword">if</span> (!task.<span class="built_in">run</span>())</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">// 如果业务运行错误则需将socket连接关闭</span></span><br><span class="line">                        ::<span class="built_in">close</span>(connfd);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">attach</span>(connfd);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// server.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/socket_handler.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::socket;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Singleton&lt;Logger&gt;::<span class="built_in">instance</span>()-&gt;<span class="built_in">open</span>(<span class="string">&quot;./server.log&quot;</span>);</span><br><span class="line">    <span class="keyword">auto</span> handler = Singleton&lt;SocketHandler&gt;::<span class="built_in">instance</span>();</span><br><span class="line">    handler-&gt;<span class="built_in">listen</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8080</span>);</span><br><span class="line">    handler-&gt;<span class="built_in">handle</span>(<span class="number">2048</span>, <span class="number">2000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// client.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/client_socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::socket;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Singleton&lt;Logger&gt;::<span class="built_in">instance</span>()-&gt;<span class="built_in">open</span>(<span class="string">&quot;./client.log&quot;</span>);</span><br><span class="line">    <span class="function">ClientSocket <span class="title">client</span><span class="params">(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8080</span>)</span></span>;</span><br><span class="line">    <span class="comment">// 向服务端发送数据</span></span><br><span class="line">    string data = <span class="string">&quot;hello world&quot;</span>;</span><br><span class="line">    client.<span class="built_in">send</span>(data.<span class="built_in">c_str</span>(), data.<span class="built_in">size</span>());</span><br><span class="line">    <span class="comment">// 接收服务端的数据 </span></span><br><span class="line">    <span class="type">char</span> buf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    client.<span class="built_in">recv</span>(buf, <span class="built_in">sizeof</span>(buf));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Recv: %s\n&quot;</span>, buf);</span><br><span class="line">    <span class="comment">// 基类Socket析构函数中会调用close()</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="poll总结">poll总结</h2><p>优点：</p><ol><li>没有描述符个数的限制</li><li>poll相较于select，在应对大数量文件描述符时速度会更快</li><li>select仅能监听可读、可写和异常事件，而poll可监听的事件类型更多</li></ol><p>缺点：</p><ol><li>大量的文件描述符在用户空间和内核空间之间复制。复制开销大</li><li>与select一样，poll返回后需要轮询文件描述符来获取就绪状态的文件描述符</li></ol>]]></content>
      
      
      
        <tags>
            
            <tag> C++后端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>库打桩机制</title>
      <link href="/2024/09/02/%E5%BA%93%E6%89%93%E6%A1%A9%E6%9C%BA%E5%88%B6/"/>
      <url>/2024/09/02/%E5%BA%93%E6%89%93%E6%A1%A9%E6%9C%BA%E5%88%B6/</url>
      
        <content type="html"><![CDATA[<p>最近做内存仿真相关研发时用到了打桩机制，相关总结如下：</p><p>Linux链接器支持一个很强大的技术，称为库打桩，它允许程序员截获对共享库函数的调用，取而代之执行自己的代码。使用打桩机制，可以追踪对某个特殊库函数的调用次数，验证和追踪它的输入和输出值，或者甚至把它替换成一个完全不同的实现。</p><p>下面是它的基本思想：给定一个需要打桩的目标函数，创建一个包装函数，它的原型与目标函数完全一样。使用某种特殊的打桩机制，就可以欺骗系统调用包装函数而不是目标函数了。包装函数通常会执行它自己的逻辑，然后调用目标函数，再将目标函数的返回值传递给调用者。</p><p>打桩可以发生在编译时、链接时或当程序被加载和执行的运行时。要研究这些不同的机制，后面会一个示例程序作为运行例子。它调用C标准库(<code>libc.so</code>)中的<code>malloc</code>和<code>free</code>函数，对<code>malloc</code>的调用从堆中分配一个32字节的块，并返回指向该块的指针；对<code>free</code>的调用把块还给堆，供后续的<code>malloc</code>调用使用。目标就是用打桩来追踪程序运行时对<code>malloc</code>和<code>free</code>的调用。</p><h2 id="编译时打桩">编译时打桩</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// compiletime/int.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;malloc.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">int</span>* p = <span class="built_in">malloc</span>(<span class="number">32</span>);</span><br><span class="line">    <span class="built_in">free</span>(p);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// compiletime/malloc.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> malloc(size) mymalloc(size)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> free(ptr) myfree(ptr)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">mymalloc</span><span class="params">(<span class="type">size_t</span> size)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">myfree</span><span class="params">(<span class="type">void</span>* ptr)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// compiletime/mymalloc.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> COMPILETIME</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;malloc.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* malloc wrapper function */</span></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">mymalloc</span><span class="params">(<span class="type">size_t</span> size)</span></span>&#123;</span><br><span class="line">    <span class="type">void</span>* ptr = <span class="built_in">malloc</span>(size);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;malloc(%d)=%p\n&quot;</span>, (<span class="type">int</span>)size, ptr);</span><br><span class="line">    <span class="keyword">return</span> ptr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* free wrapper function */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">myfree</span><span class="params">(<span class="type">void</span>* ptr)</span></span>&#123;</span><br><span class="line">    <span class="built_in">free</span>(ptr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;free(%p)\n&quot;</span>, ptr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>上面的代码展示了如何使用C预处理在编译时打桩，<code>mymalloc.c</code>中的包装函数调用目标函数，打印追踪记录并返回。本地的<code>malloc.h</code>头文件指示预处理器用对相应包装函数的调用替换掉对目标函数的调用。像下面这样编译和链接这个程序：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">gcc -DCOMPILETIME -c mymalloc.c</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">gcc -I. -o intc int.c mymalloc.o</span></span><br></pre></td></tr></table></figure><p>由于有<code>-I.</code>参数，所以会进行打桩，它告诉C预处理器在搜索通常的系统目录之前，先在当前目录中查找<code>malloc.h</code>。注意，<code>mymalloc.c</code>中的包装函数是使用标准<code>mallo.h</code>头文件编译的。</p><p>运行这个程序会得到如下的追踪信息：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">./intc</span> </span><br><span class="line">malloc(32)=0x55718fd292a0</span><br><span class="line">free(0x55718fd292a0)</span><br></pre></td></tr></table></figure><h2 id="链接时打桩">链接时打桩</h2><p>Linux静态链接器支持用<code>--wrap f</code>标志进行链接时打桩。这个标志告诉链接器，把对符号<code>f</code>的引用解析城<code>__wrap f</code>，还要把对符号<code>__real_f</code>的引用解析为<code>f</code>。以下是示例程序的包装函数：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// linktime/int.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;malloc.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">int</span>* p = <span class="built_in">malloc</span>(<span class="number">32</span>);</span><br><span class="line">    <span class="built_in">free</span>(p);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// linktime/mymalloc.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> LINKTIME</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span>* __real_malloc(<span class="type">size_t</span> size);</span><br><span class="line"><span class="type">void</span> __real_free(<span class="type">void</span>* ptr);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* malloc wrapper function */</span></span><br><span class="line"><span class="type">void</span>* __wrap_malloc(<span class="type">size_t</span> size)&#123;</span><br><span class="line">    <span class="type">void</span>* ptr = __real_malloc(size);        <span class="comment">/* call libc malloc */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;malloc(%d) = %p\n&quot;</span>, (<span class="type">int</span>)size, ptr);</span><br><span class="line">    <span class="keyword">return</span> ptr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* free wrapper function */</span></span><br><span class="line"><span class="type">void</span> __wrap_free(<span class="type">void</span>* ptr)&#123;</span><br><span class="line">    __real_free(ptr);                       <span class="comment">/* call libc free */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;free(%p)\n&quot;</span>, ptr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>用下述方法把这些源文件编译成可重定位目标文件，并把目标文件链接成可执行文件：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">gcc -DLINKTIME -c mymalloc.c</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">gcc -c int.c</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">gcc -Wl,--wrap,malloc -Wl,--wrap,free -o intl int.o mymalloc.o</span></span><br></pre></td></tr></table></figure><p><code>-Wl,option</code>标志把<code>option</code>传递给链接器。<code>option</code>中的每个逗号都要替换为一个空格，所以<code>-Wl,--wrap,malloc</code>就把<code>--wrap malloc</code>传递给链接器，以类似的方式传递<code>-Wl,--wrap,free</code>。</p><p>运行该程序会得到如下追踪信息：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">./intl</span> </span><br><span class="line">malloc(32) = 0x55d5164c02a0</span><br><span class="line">free(0x55d5164c02a0)</span><br></pre></td></tr></table></figure><h2 id="运行时打桩">运行时打桩</h2><p>编译时打桩需要能够访问程序的源代码，链接时打桩需要能够访问程序的可重定位对象文件。不过，有一种机制能够在运行时打桩，它只需要能够访问可执行目标文件。这个很厉害的机制基于动态链接器的<code>LD_PRELOAD</code>环境变量。</p><p>如果<code>LD_PRELOAD</code>环境变量被设置为一个共享库路径名的列表(以空格或分号分隔)，那么当你加载和执行一个程序，需要解析未定义的引用时，动态链接器(<code>LD-LINUX.SO</code>)会先搜索<code>LD_PRELOAD</code>库，然后才搜索任何其它的库。有了这个机制，当你加载和执行任意可执行文件时，可以对任何共享库中的任何函数打桩，包括<code>libc.so</code>。</p><p>以下展示了<code>malloc</code>和<code>free</code>的包装函数，每个包装函数中，对<code>dlsym</code>的调用返回指向目标<code>libc</code>函数的指针。然后包装函数调用目标函数，打印追踪记录，再返回：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// runtime/int.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;malloc.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">int</span>* p = <span class="built_in">malloc</span>(<span class="number">32</span>);</span><br><span class="line">    <span class="built_in">free</span>(p);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// runtime/mymalloc.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> RUNTIME</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* malloc wrapper function */</span></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">malloc</span><span class="params">(<span class="type">size_t</span> size)</span></span>&#123;</span><br><span class="line">    <span class="type">void</span>* (*mallocp)(<span class="type">size_t</span> size);</span><br><span class="line">    <span class="type">char</span>* error;</span><br><span class="line"></span><br><span class="line">    mallocp = <span class="built_in">dlsym</span>(RTLD_NEXT, <span class="string">&quot;malloc&quot;</span>);   <span class="comment">/* Get address of libc malloc */</span></span><br><span class="line">    <span class="keyword">if</span>((error = <span class="built_in">dlerror</span>()) != <span class="literal">NULL</span>)&#123;</span><br><span class="line">        <span class="built_in">fputs</span>(error, stderr);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;   </span><br><span class="line">    <span class="type">char</span>* ptr = <span class="built_in">mallocp</span>(size);              <span class="comment">/* Call libc malloc */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;malloc(%d) = %p\n&quot;</span>, (<span class="type">int</span>)size, ptr);</span><br><span class="line">    <span class="keyword">return</span> ptr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* free wrapper function */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">free</span><span class="params">(<span class="type">void</span>* ptr)</span></span>&#123;</span><br><span class="line">    <span class="built_in">void</span> (*freep)(<span class="type">void</span>*) = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">char</span>* error;</span><br><span class="line">    <span class="keyword">if</span>(!ptr) <span class="keyword">return</span>;</span><br><span class="line">    freep = <span class="built_in">dlsym</span>(RTLD_NEXT, <span class="string">&quot;free&quot;</span>);       <span class="comment">/* Get address of libc free */</span></span><br><span class="line">    <span class="keyword">if</span>((error = <span class="built_in">dlerror</span>()) != <span class="literal">NULL</span>)&#123;</span><br><span class="line">        <span class="built_in">fputs</span>(error, stderr);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;   </span><br><span class="line">    <span class="built_in">freep</span>(ptr);                             <span class="comment">/* Call libc free */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;free(%p)\n&quot;</span>, ptr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>下面是如何构建包含这些包装函数的共享库的方法：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">gcc -DRUNTIME -shared -fpic -o mymalloc.so mymalloc.c -ldl</span></span><br></pre></td></tr></table></figure><p>然后编译主程序：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">gcc -o intr int.c</span></span><br></pre></td></tr></table></figure><p>从bash shell中运行这个程序：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">LD_PRELOAD=<span class="string">&quot;./mymalloc.so&quot;</span> ./intr</span></span><br><span class="line">malloc(32) = 0x1bf7010</span><br><span class="line">free(0x1bf7010)</span><br></pre></td></tr></table></figure><p>注意，可以用<code>LD_PRELOAD</code>对任何可执行程序的库函数调用打桩！</p>]]></content>
      
      
      
        <tags>
            
            <tag> 链接 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IO多路复用之select</title>
      <link href="/2024/08/25/IO%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%E4%B9%8Bselect/"/>
      <url>/2024/08/25/IO%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8%E4%B9%8Bselect/</url>
      
        <content type="html"><![CDATA[<h1 id="io多路复用之select模型">IO多路复用之select模型</h1><h2 id="select简介">select简介</h2><p>select模型核心在于系统函数<code>select()</code>上，它用于监听一个或多个套接字的状态，对每一个套接字，调用者可以查询它的可读性、可写性以及错误状态信息。用<code>fd_set</code>结构来表示一组等待检查的套接字，在调用返回时，这个结构存有满足一定条件的套接字组的子集，并且<code>select()</code>返回满足条件的套接字的数目。</p><h3 id="select函数">select函数</h3><h4 id="函数原型">函数原型</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/select.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">select</span><span class="params">(<span class="type">int</span> nfds, fd_set * readfds, fd_set * writefds, fd_set * exceptfds, <span class="keyword">struct</span> timeval * timeout)</span></span>;</span><br></pre></td></tr></table></figure><h4 id="参数说明">参数说明</h4><ul><li><code>nfds</code>：监听的文件描述符(即socket)的总数，它通常被设置为<code>select()</code>监听的所有文件描述符中的最大值加<code>1</code>，因为文件描述符是从<code>0</code>开始计数的</li><li><code>readfds</code>：监听读就绪的文件描述符集合</li><li><code>writefds</code>：监听写就绪的文件描述符集合</li><li><code>exceptfds</code>：监听异常发生的文件描述符集合</li><li><code>timeout</code>：监听超时时间</li></ul><h4 id="返回值">返回值</h4><p><code>select()</code>成功时返回就绪(可读、可写和异常)文件描述符的总数。</p><p>如果在超时时间内没有任何文件描述符就绪，<code>select()</code>将返回<code>0</code>。</p><p><code>select()</code>失败时返回<code>-1</code>并设置<code>errno</code>。</p><p>如果在<code>select()</code>等待期间，程序接收到信号，则<code>select()</code>立即返回<code>-1</code>，并设置<code>errno</code>为<code>EINTR</code>。</p><h4 id="fd-set结构体">fd_set结构体</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">fd_set</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">long</span> __fds_bits[<span class="number">16</span>];  </span><br><span class="line">&#125;fd_set;</span><br></pre></td></tr></table></figure><p><code>fd_set</code>是一个数组的宏定义，它实际上是一个包含<code>16</code>个元素的<code>long</code>类型数组，该数组的每个元素的每一位(bit)标记一个文件描述符，即数组中每个元素中的每一位都能与一个打开的套接字建立联系，建立联系的工作由程序员完成，当调用<code>select()</code>时，由内核根据IO状态修改<code>fd_set</code>的内容，由此来通知哪个套接字可读。</p><p><img src="https://aliyun-oss-zh.oss-cn-beijing.aliyuncs.com/img/QQ20250901-005723.jpg" alt=""></p><p><code>fd_set</code>最多可以监控1024个套接字，因为<code>__fds_bits</code>数组由16个元素，每个元素<code>long</code>类型由8个字节，每个字节包含8个bit。</p><p><img src="https://aliyun-oss-zh.oss-cn-beijing.aliyuncs.com/img/QQ20250901-011216.jpg" alt=""></p><p>将<code>__fds_bits</code>数组在内存中展开后其实就是一个1024个比特位图，其中每个比特要么为0，要么为1。最开始会将<code>__fds_bits</code>中所有比特位全部设置为0，然后将要监听套接字对应的位图中的比特位设置为1，并将<code>fd_set</code>传递给内核，由内核监听这些套接字有无就绪事件到来。如果该套接字有就绪事件到来，则其对应的比特位会设置为1，否则会被设置为0，用户可以检测<code>fdset</code>所有的比特位来判定是否有就绪事件到来。</p><p>由于位操作过于繁琐，应该使用下面系统提供的一系列宏来访问<code>fd_set</code>结构体中的位：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/select.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">FD_ZERO</span>(fd_set * fdset);<span class="comment">/* 清除fdset的所有位 */</span></span><br><span class="line"><span class="built_in">FD_SET</span>(<span class="type">int</span> fd, fd_set * fdset);<span class="comment">/* 设置fdset的位fd */</span></span><br><span class="line"><span class="built_in">FD_CLR</span>(<span class="type">int</span> fd, fd_set * fdset);<span class="comment">/* 清除fdset的位fd */</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">FD_ISSET</span><span class="params">(<span class="type">int</span> fd, fd_set * fdset)</span></span>;<span class="comment">/* 测试fdset的位fd是否被设置 */</span></span><br></pre></td></tr></table></figure><h4 id="监控超时时间">监控超时时间</h4><p><code>timeval</code>结构体的定义如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">timeval</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">long</span> tv_sec;<span class="comment">/* 秒数 */</span></span><br><span class="line">    <span class="type">long</span> tv_usec;<span class="comment">/* 微秒数 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>由以上定义可见，<code>select()</code>提供了一个微秒级的定时方式。如果给<code>timeout</code>变量的<code>tv_sec</code>成员和<code>tv_usec</code>成员都传递<code>0</code>，则<code>select()</code>将立即返回。如果给<code>timeout</code>传递<code>NULL</code>，则<code>select()</code>将一直阻塞，直到某个文件描述符就绪。</p><h2 id="select代码实现">select代码实现</h2><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CMakeLists.txt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.19</span>)</span><br><span class="line"><span class="keyword">project</span>(select)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD <span class="number">11</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">include_directories</span>(<span class="string">&quot;./&quot;</span>)</span><br><span class="line"><span class="keyword">file</span>(GLOB_RECURSE SOURCES <span class="string">&quot;utility/*.cpp&quot;</span> <span class="string">&quot;socket/*.cpp&quot;</span>)</span><br><span class="line"><span class="keyword">add_executable</span>(server <span class="variable">$&#123;SOURCES&#125;</span> server.cpp)</span><br><span class="line"><span class="keyword">add_executable</span>(client <span class="variable">$&#123;SOURCES&#125;</span> client.cpp)</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// server.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/server_socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/select.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::socket;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Singleton&lt;Logger&gt;::<span class="built_in">instance</span>()-&gt;<span class="built_in">open</span>(<span class="string">&quot;./server.log&quot;</span>);</span><br><span class="line">    <span class="function">ServerSocket <span class="title">server</span><span class="params">(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8080</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将要监听的socket放入fds集合中</span></span><br><span class="line">    fd_set fds;</span><br><span class="line">    <span class="built_in">FD_ZERO</span>(&amp;fds);</span><br><span class="line">    <span class="comment">// 将服务端的监听套接字加入fds集合中</span></span><br><span class="line">    <span class="built_in">FD_SET</span>(server.<span class="built_in">fd</span>(), &amp;fds);</span><br><span class="line">    <span class="type">int</span> max_fd = server.<span class="built_in">fd</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        fd_set read_fds = fds;</span><br><span class="line">        <span class="comment">// nfds为监听的文件描述符(即socket)的总数，它通常被设置为select()监听的所有文件描述符中的最大值加1，因为文件描述符是从0开始计数的</span></span><br><span class="line">        <span class="comment">// 这里仅监听可读事件发生</span></span><br><span class="line">        <span class="type">int</span> ret = <span class="built_in">select</span>(max_fd + <span class="number">1</span>, &amp;read_fds, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">log_error</span>(<span class="string">&quot;select error: errno = %d errmsg = %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (ret == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// select()监听超时</span></span><br><span class="line">            <span class="built_in">log_debug</span>(<span class="string">&quot;select timeout&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">log_debug</span>(<span class="string">&quot;select ok: ret = %d&quot;</span>, ret);</span><br><span class="line">        <span class="comment">// 遍历整个位图</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> fd = <span class="number">0</span>; fd &lt; max_fd + <span class="number">1</span>; fd ++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">FD_ISSET</span>(fd, &amp;read_fds))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 该socket没有可读事件</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 区分是服务端的监听socket有事件发生还是连接socket有事件发生</span></span><br><span class="line">            <span class="keyword">if</span> (fd == server.<span class="built_in">fd</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 如果是服务端监听socket可读</span></span><br><span class="line">                <span class="type">int</span> connfd = server.<span class="built_in">accept</span>();</span><br><span class="line">                <span class="keyword">if</span> (connfd &lt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 要将服务端的连接socket也加入到fds集合中，这样下一次调用select()才能知道连接socket有无可读事件到来</span></span><br><span class="line">                <span class="built_in">FD_SET</span>(connfd, &amp;fds);</span><br><span class="line">                <span class="keyword">if</span> (max_fd &lt; connfd)</span><br><span class="line">                &#123;</span><br><span class="line">                    max_fd = connfd;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 服务端连接socket可读，即客户端向服务端发送消息了，要将消息读出来</span></span><br><span class="line">                Socket <span class="built_in">client</span>(fd);</span><br><span class="line">                <span class="comment">// 接收客户端的数据</span></span><br><span class="line">                <span class="type">char</span> buf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">                <span class="type">size_t</span> len = client.<span class="built_in">recv</span>(buf, <span class="built_in">sizeof</span>(buf));</span><br><span class="line">                <span class="keyword">if</span> (len == <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 连接被客户端关闭了</span></span><br><span class="line">                    <span class="built_in">log_debug</span>(<span class="string">&quot;socket closed by peer: conn = %d&quot;</span>, fd);</span><br><span class="line">                    <span class="comment">// 将服务端的连接socket从fds集合中清除并关闭</span></span><br><span class="line">                    <span class="built_in">FD_CLR</span>(fd, &amp;fds);</span><br><span class="line">                    client.<span class="built_in">close</span>();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (len &gt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">log_debug</span>(<span class="string">&quot;recv: conn = %d msg = %s&quot;</span>, fd, buf);</span><br><span class="line">                    <span class="comment">// 向客户端发送数据</span></span><br><span class="line">                    client.<span class="built_in">send</span>(buf, len);</span><br><span class="line">                    <span class="comment">// 为避免socket析构函数关闭连接，这里调用close()</span></span><br><span class="line">                    client.<span class="built_in">clear</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// client.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/client_socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::socket;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Singleton&lt;Logger&gt;::<span class="built_in">instance</span>()-&gt;<span class="built_in">open</span>(<span class="string">&quot;./client.log&quot;</span>);</span><br><span class="line">    <span class="function">ClientSocket <span class="title">client</span><span class="params">(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8080</span>)</span></span>;</span><br><span class="line">    string data = <span class="string">&quot;hello world&quot;</span>;</span><br><span class="line">    client.<span class="built_in">send</span>(data.<span class="built_in">c_str</span>(), data.<span class="built_in">size</span>());</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    client.<span class="built_in">recv</span>(buf, <span class="built_in">sizeof</span>(buf));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Recv: %s\n&quot;</span>, buf);</span><br><span class="line">    <span class="comment">// 基类Socket析构函数中会调用close()</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// socket/socket.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> std::string;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility/logger.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::utility;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> socket</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Socket</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">Socket</span>();</span><br><span class="line">            <span class="built_in">Socket</span>(<span class="type">int</span> sockfd);</span><br><span class="line">            <span class="keyword">virtual</span> ~<span class="built_in">Socket</span>();</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">fd</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="comment">// 服务端绑定socket</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">bind</span><span class="params">(<span class="type">const</span> string &amp; ip, <span class="type">int</span> port)</span></span>;</span><br><span class="line">            <span class="comment">// 服务端监听socket</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">listen</span><span class="params">(<span class="type">int</span> backlog)</span></span>;</span><br><span class="line">            <span class="comment">// 客户端连接服务端</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">connect</span><span class="params">(<span class="type">const</span> string &amp; ip, <span class="type">int</span> port)</span></span>;</span><br><span class="line">            <span class="comment">// 服务端接受客户端连接，accept()返回与客户端连接的socket</span></span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">accept</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="comment">// 发送数据，返回发送多少个字节</span></span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">send</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * buf, <span class="type">int</span> len)</span></span>;</span><br><span class="line">            <span class="comment">// 接收数据</span></span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">recv</span><span class="params">(<span class="type">char</span> * buf, <span class="type">int</span> len)</span></span>;</span><br><span class="line">            <span class="comment">// 关闭socket连接</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">close</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="comment">// 将m_sockfd置为0，避免析构时关闭socket连接</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">clear</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="comment">// 将socket由默认的阻塞IO设置为非阻塞IO</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">set_non_blocking</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="comment">// 设置TCP发送缓冲区大小</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">set_send_buffer</span><span class="params">(<span class="type">int</span> size)</span></span>;</span><br><span class="line">            <span class="comment">// 设置TCP接收缓冲区大小</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">set_recv_buffer</span><span class="params">(<span class="type">int</span> size)</span></span>;</span><br><span class="line">            <span class="comment">// 设置SO_LINGER选项</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">set_linger</span><span class="params">(<span class="type">bool</span> active, <span class="type">int</span> seconds)</span></span>;</span><br><span class="line">            <span class="comment">// 设置SO_KEEPALIVE选项</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">set_keepalive</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="comment">// 设置SO_REUSEADDR选项</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">set_reuseaddr</span><span class="params">()</span></span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">protected</span>:</span><br><span class="line">            string m_ip;</span><br><span class="line">            <span class="type">int</span> m_port;</span><br><span class="line">            <span class="type">int</span> m_sockfd;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// socket/socket.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::socket;</span><br><span class="line"></span><br><span class="line">Socket::<span class="built_in">Socket</span>() : <span class="built_in">m_ip</span>(<span class="string">&quot;&quot;</span>), <span class="built_in">m_port</span>(<span class="number">0</span>), <span class="built_in">m_sockfd</span>(<span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    m_sockfd = ::<span class="built_in">socket</span>(AF_INET, SOCK_STREAM, IPPROTO_TCP);</span><br><span class="line">    <span class="keyword">if</span> (m_sockfd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;Create socket error:  errno = %d errmsg = %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">log_debug</span>(<span class="string">&quot;Create socket success!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Socket::<span class="built_in">Socket</span>(<span class="type">int</span> sockfd) : <span class="built_in">m_ip</span>(<span class="string">&quot;&quot;</span>), <span class="built_in">m_port</span>(<span class="number">0</span>), <span class="built_in">m_sockfd</span>(sockfd)</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Socket::~<span class="built_in">Socket</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">close</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Socket::fd</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_sockfd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Socket::bind</span><span class="params">(<span class="type">const</span> string &amp; ip, <span class="type">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> address;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;address, <span class="number">0</span>, <span class="built_in">sizeof</span>(address));</span><br><span class="line">    address.sin_family = AF_INET;</span><br><span class="line">    <span class="keyword">if</span> (ip.<span class="built_in">empty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 如果传入的IP地址为空，则绑定任意的本地网卡地址</span></span><br><span class="line">        address.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 调用inet_addr()将用点分十进制字符串表示的IPv4地址转化为用网络字节序整数表示的IPv4地址，它失败时返回INADDR_NONE</span></span><br><span class="line">        address.sin_addr.s_addr = <span class="built_in">inet_addr</span>(ip.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 调用htons()将16位(2字节)短整型端口数据从主机字节序转换为网络字节序(大端序)</span></span><br><span class="line">    address.sin_port = <span class="built_in">htons</span>(port);</span><br><span class="line">    <span class="keyword">if</span> (::<span class="built_in">bind</span>(m_sockfd, (<span class="keyword">struct</span> sockaddr *)&amp;address, <span class="built_in">sizeof</span>(address)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;Bind socket error: errno = %d errmsg = %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    m_ip = ip;</span><br><span class="line">    m_port = port;</span><br><span class="line">    <span class="built_in">log_debug</span>(<span class="string">&quot;Bind socket success: ip = %s port = %d&quot;</span>, ip.<span class="built_in">c_str</span>(), port);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Socket::listen</span><span class="params">(<span class="type">int</span> backlog)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (::<span class="built_in">listen</span>(m_sockfd, <span class="number">1024</span>) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;Socket listen error: errno = %d errmsg = %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">log_debug</span>(<span class="string">&quot;Socket listening...&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Socket::connect</span><span class="params">(<span class="type">const</span> string &amp; ip, <span class="type">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> address;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;address, <span class="number">0</span>, <span class="built_in">sizeof</span>(address));</span><br><span class="line">    address.sin_family = AF_INET;</span><br><span class="line">    address.sin_addr.s_addr = <span class="built_in">inet_addr</span>(ip.<span class="built_in">c_str</span>());</span><br><span class="line">    address.sin_port = <span class="built_in">htons</span>(port);</span><br><span class="line">    <span class="keyword">if</span> (::<span class="built_in">connect</span>(m_sockfd, (<span class="keyword">struct</span> sockaddr *)&amp;address, <span class="built_in">sizeof</span>(address)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;Socket connect error: errno = %d errmsg = %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    m_ip = ip;</span><br><span class="line">    m_port = port;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Socket::accept</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> connfd = ::<span class="built_in">accept</span>(m_sockfd, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="keyword">if</span> (connfd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;Socket accept error: errno = %d errmsg = %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">log_debug</span>(<span class="string">&quot;Socket accept: connfd = %d&quot;</span>, connfd);</span><br><span class="line">    <span class="keyword">return</span> connfd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Socket::send</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * buf, <span class="type">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ::<span class="built_in">send</span>(m_sockfd, buf, len, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Socket::recv</span><span class="params">(<span class="type">char</span> * buf, <span class="type">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ::<span class="built_in">recv</span>(m_sockfd, buf, len, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Socket::close</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_sockfd &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ::<span class="built_in">close</span>(m_sockfd);</span><br><span class="line">        m_sockfd = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Socket::clear</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_sockfd = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Socket::set_non_blocking</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 先获取socket的标记</span></span><br><span class="line">    <span class="type">int</span> flags = <span class="built_in">fcntl</span>(m_sockfd, F_GETFL, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (flags &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;Socket set_non_blocking error: errno = %d errmsg=%s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    flags |= O_NONBLOCK;</span><br><span class="line">    <span class="comment">// 设置socket的标记位</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">fcntl</span>(m_sockfd, F_SETFL, flags) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;Socket set_non_blocking error: errno = %d errmsg=%s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Socket::set_send_buffer</span><span class="params">(<span class="type">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> buff_size = size;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">setsockopt</span>(m_sockfd, SOL_SOCKET, SO_SNDBUF, &amp;buff_size, <span class="built_in">sizeof</span>(buff_size)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;Socket set_send_buffer error: errno = %d errmsg = %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Socket::set_recv_buffer</span><span class="params">(<span class="type">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> buff_size = size;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">setsockopt</span>(m_sockfd, SOL_SOCKET, SO_RCVBUF, &amp;buff_size, <span class="built_in">sizeof</span>(buff_size)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;Socket set_recv_buffer error: errno = %d errmsg = %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Socket::set_linger</span><span class="params">(<span class="type">bool</span> active, <span class="type">int</span> seconds)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">linger</span> l;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;l, <span class="number">0</span>, <span class="built_in">sizeof</span>(l));</span><br><span class="line">    l.l_onoff = active ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">    l.l_linger = seconds;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">setsockopt</span>(m_sockfd, SOL_SOCKET, SO_LINGER, &amp;l, <span class="built_in">sizeof</span>(l)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;Socket set_linger error: errno = %d errmsg = %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Socket::set_keepalive</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> flag = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">setsockopt</span>(m_sockfd, SOL_SOCKET, SO_KEEPALIVE, &amp;flag, <span class="built_in">sizeof</span>(flag)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;Socket set_keepalive error: errno = %d errmsg = %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Socket::set_reuseaddr</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> flag = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">setsockopt</span>(m_sockfd, SOL_SOCKET, SO_REUSEADDR, &amp;flag, <span class="built_in">sizeof</span>(flag)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;Socket set_reuseaddr error: errno = %d errmsg = %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// socket/server_socket.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> socket</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">ServerSocket</span> : <span class="keyword">public</span> Socket</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">ServerSocket</span>() = <span class="keyword">delete</span>;</span><br><span class="line">            <span class="built_in">ServerSocket</span>(<span class="type">const</span> string &amp; ip, <span class="type">int</span> port);</span><br><span class="line">            ~<span class="built_in">ServerSocket</span>() = <span class="keyword">default</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// socket/server_socket.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/server_socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::socket;</span><br><span class="line"></span><br><span class="line">ServerSocket::<span class="built_in">ServerSocket</span>(<span class="type">const</span> string &amp; ip, <span class="type">int</span> port) : <span class="built_in">Socket</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 将socket设置为非阻塞</span></span><br><span class="line">    <span class="built_in">set_non_blocking</span>();</span><br><span class="line">    <span class="built_in">set_recv_buffer</span>(<span class="number">10</span> * <span class="number">1024</span>);</span><br><span class="line">    <span class="built_in">set_send_buffer</span>(<span class="number">10</span> * <span class="number">1024</span>);</span><br><span class="line">    <span class="built_in">set_linger</span>(<span class="literal">true</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">set_keepalive</span>();</span><br><span class="line">    <span class="built_in">set_reuseaddr</span>();</span><br><span class="line">    <span class="built_in">bind</span>(ip, port);</span><br><span class="line">    <span class="built_in">listen</span>(<span class="number">1024</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// socket/client_socket.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> socket</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">ClientSocket</span> : <span class="keyword">public</span> Socket</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">ClientSocket</span>() = <span class="keyword">delete</span>;</span><br><span class="line">            <span class="built_in">ClientSocket</span>(<span class="type">const</span> string &amp; ip, <span class="type">int</span> port);</span><br><span class="line">            ~<span class="built_in">ClientSocket</span>() = <span class="keyword">default</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// socket/client_socket.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/client_socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::socket;</span><br><span class="line"></span><br><span class="line">ClientSocket::<span class="built_in">ClientSocket</span>(<span class="type">const</span> string &amp; ip, <span class="type">int</span> port)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">connect</span>(ip, port);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="select代码封装">select代码封装</h2><p>用C++的方式对select相关代码进行封装，实现一个<code>Selector</code>类，使得开发更加方便。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// socket/selector.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/select.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> socket</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Selector</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">Selector</span>();</span><br><span class="line">            ~<span class="built_in">Selector</span>();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将socket对应的文件描述符加入fd_set集合中</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">set</span><span class="params">(<span class="type">int</span> fd)</span></span>;</span><br><span class="line">            <span class="comment">// 将socket对应的文件描述符从fd_set集合中移除</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">del</span><span class="params">(<span class="type">int</span> fd)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">select</span><span class="params">(<span class="type">int</span> milliseconds)</span></span>;</span><br><span class="line">            <span class="comment">// 获得监听socket中最大的文件描述符</span></span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">max_fd</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="comment">// 判断fd对应的socket是否可读</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">is_set</span><span class="params">(<span class="type">int</span> fd)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="comment">// 需要监听的socket集合</span></span><br><span class="line">            fd_set m_fds;</span><br><span class="line">            <span class="comment">// 临时的fd_set集合，用于传递给select()系统调用的</span></span><br><span class="line">            fd_set m_read_fds;</span><br><span class="line">            <span class="comment">// 最大的文件描述符</span></span><br><span class="line">            <span class="type">int</span> m_maxfd;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// socket/selector.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/selector.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::socket;</span><br><span class="line"></span><br><span class="line">Selector::<span class="built_in">Selector</span>() : <span class="built_in">m_maxfd</span>(<span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 将监听的文件描述符集合初始化</span></span><br><span class="line">    <span class="built_in">FD_ZERO</span>(&amp;m_fds);</span><br><span class="line">    <span class="built_in">FD_ZERO</span>(&amp;m_read_fds);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Selector::~<span class="built_in">Selector</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">FD_ZERO</span>(&amp;m_fds);</span><br><span class="line">    <span class="built_in">FD_ZERO</span>(&amp;m_read_fds);</span><br><span class="line">    m_maxfd = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Selector::set</span><span class="params">(<span class="type">int</span> fd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">FD_SET</span>(fd, &amp;m_fds);</span><br><span class="line">    m_maxfd = std::<span class="built_in">max</span>(m_maxfd, fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Selector::del</span><span class="params">(<span class="type">int</span> fd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">FD_CLR</span>(fd, &amp;m_fds);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Selector::select</span><span class="params">(<span class="type">int</span> milliseconds)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">timeval</span> tv;</span><br><span class="line">    tv.tv_sec = milliseconds / <span class="number">1000</span>;</span><br><span class="line">    tv.tv_usec = (milliseconds % <span class="number">1000</span>) * <span class="number">1000</span>;</span><br><span class="line">    m_read_fds = m_fds;</span><br><span class="line">    <span class="keyword">return</span> ::<span class="built_in">select</span>(m_maxfd + <span class="number">1</span>, &amp;m_read_fds, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>, &amp;tv);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Selector::max_fd</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_maxfd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Selector::is_set</span><span class="params">(<span class="type">int</span> fd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">FD_ISSET</span>(fd, &amp;m_read_fds);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// server.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/server_socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/selector.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::socket;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Singleton&lt;Logger&gt;::<span class="built_in">instance</span>()-&gt;<span class="built_in">open</span>(<span class="string">&quot;./server.log&quot;</span>);</span><br><span class="line">    <span class="function">ServerSocket <span class="title">server</span><span class="params">(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8080</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    Selector selector;</span><br><span class="line">    selector.<span class="built_in">set</span>(server.<span class="built_in">fd</span>());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> ret = selector.<span class="built_in">select</span>(<span class="number">2000</span>);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">log_error</span>(<span class="string">&quot;select error: errno = %d errmsg = %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (ret == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// select()监听超时</span></span><br><span class="line">            <span class="built_in">log_debug</span>(<span class="string">&quot;select timeout&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">log_debug</span>(<span class="string">&quot;select ok: ret = %d&quot;</span>, ret);</span><br><span class="line">        <span class="comment">// 遍历整个位图</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> fd = <span class="number">0</span>; fd &lt; selector.<span class="built_in">max_fd</span>() + <span class="number">1</span>; fd ++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!selector.<span class="built_in">is_set</span>(fd))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 该socket没有可读事件</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 区分是服务端的监听socket有事件发生还是连接socket有事件发生</span></span><br><span class="line">            <span class="keyword">if</span> (fd == server.<span class="built_in">fd</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 如果是服务端监听socket可读</span></span><br><span class="line">                <span class="type">int</span> connfd = server.<span class="built_in">accept</span>();</span><br><span class="line">                <span class="keyword">if</span> (connfd &lt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 要将服务端的连接socket也加入到fds集合中，这样下一次调用select()才能知道连接socket有无可读事件到来</span></span><br><span class="line">                selector.<span class="built_in">set</span>(connfd);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 服务端连接socket可读，即客户端向服务端发送消息了，要将消息读出来</span></span><br><span class="line">                Socket <span class="built_in">client</span>(fd);</span><br><span class="line">                <span class="comment">// 接收客户端的数据</span></span><br><span class="line">                <span class="type">char</span> buf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">                <span class="type">size_t</span> len = client.<span class="built_in">recv</span>(buf, <span class="built_in">sizeof</span>(buf));</span><br><span class="line">                <span class="keyword">if</span> (len == <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 连接被客户端关闭了</span></span><br><span class="line">                    <span class="built_in">log_debug</span>(<span class="string">&quot;socket closed by peer: conn = %d&quot;</span>, fd);</span><br><span class="line">                    <span class="comment">// 将服务端的连接socket从fds集合中清除并关闭</span></span><br><span class="line">                    selector.<span class="built_in">del</span>(fd);</span><br><span class="line">                    client.<span class="built_in">close</span>();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (len &gt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">log_debug</span>(<span class="string">&quot;recv: conn = %d msg = %s&quot;</span>, fd, buf);</span><br><span class="line">                    <span class="comment">// 向客户端发送数据</span></span><br><span class="line">                    client.<span class="built_in">send</span>(buf, len);</span><br><span class="line">                    <span class="comment">// 为避免socket析构函数关闭连接，这里调用close()</span></span><br><span class="line">                    client.<span class="built_in">clear</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="sockethandler类">SocketHandler类</h2><p>注意到<code>server.cpp</code>中大部分启动服务的代码逻辑都是一样的，只有像接收客户端数据和向客户端发送数据这块的业务处理逻辑可能会不同，其它比如调用<code>select()</code>、遍历<code>fd_set</code>集合等都相同，可以进一步封装。因此创建了一个<code>SocketHandler</code>类，服务的启动、socket的轮询等都是通过它来完成的：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// socket/socket_handler.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/server_socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/selector.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> socket</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">SocketHandler</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">SINGLETON</span>(SocketHandler);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">listen</span><span class="params">(<span class="type">const</span> string &amp; ip, <span class="type">int</span> port)</span></span>;</span><br><span class="line">            <span class="comment">// 将socket加入到监听的集合中</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">attach</span><span class="params">(Socket * socket)</span></span>;</span><br><span class="line">            <span class="comment">// 将socket从监听集合中移除</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">detach</span><span class="params">(Socket * socket)</span></span>;</span><br><span class="line">            <span class="comment">// 将socket从监听集合中移除并关闭连接(遇到客户端关闭连接时使用)</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">remove</span><span class="params">(Socket * socket)</span></span>;</span><br><span class="line">            <span class="comment">// timeout为超时参数，单位ms</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">handle</span><span class="params">(<span class="type">int</span> timeout)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="comment">// 服务端socket</span></span><br><span class="line">            Socket * m_server = <span class="literal">nullptr</span>;</span><br><span class="line">            <span class="comment">// 底层IO多路复用采用select</span></span><br><span class="line">            Selector m_selector;</span><br><span class="line">            <span class="comment">// 记录连接socket</span></span><br><span class="line">            std::map&lt;<span class="type">int</span>, Socket *&gt; m_conns;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// socket/socket_handler.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/socket_handler.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::socket;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SocketHandler::listen</span><span class="params">(<span class="type">const</span> string &amp; ip, <span class="type">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_server = <span class="keyword">new</span> <span class="built_in">ServerSocket</span>(ip, port);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SocketHandler::attach</span><span class="params">(Socket * socket)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_selector.<span class="built_in">set</span>(socket-&gt;<span class="built_in">fd</span>());</span><br><span class="line">    m_conns[socket-&gt;<span class="built_in">fd</span>()] = socket;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SocketHandler::detach</span><span class="params">(Socket * socket)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_selector.<span class="built_in">del</span>(socket-&gt;<span class="built_in">fd</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SocketHandler::remove</span><span class="params">(Socket * socket)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">detach</span>(socket);</span><br><span class="line">    socket-&gt;<span class="built_in">close</span>();</span><br><span class="line">    <span class="keyword">auto</span> it = m_conns.<span class="built_in">find</span>(socket-&gt;<span class="built_in">fd</span>());</span><br><span class="line">    <span class="keyword">if</span> (it != m_conns.<span class="built_in">end</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        m_conns.<span class="built_in">erase</span>(it);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">delete</span> socket;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SocketHandler::handle</span><span class="params">(<span class="type">int</span> timeout)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">attach</span>(m_server);</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> ret = m_selector.<span class="built_in">select</span>(timeout);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">log_error</span>(<span class="string">&quot;select error: errno = %d errmsg = %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (ret == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">log_debug</span>(<span class="string">&quot;select timeout&quot;</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">log_debug</span>(<span class="string">&quot;select ok: ret = %d&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> fd = <span class="number">0</span>; fd &lt; m_selector.<span class="built_in">max_fd</span>() + <span class="number">1</span>; fd++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!m_selector.<span class="built_in">is_set</span>(fd))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (fd == m_server-&gt;<span class="built_in">fd</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 服务端监听socket可读</span></span><br><span class="line">                <span class="type">int</span> connfd = m_server-&gt;<span class="built_in">accept</span>();</span><br><span class="line">                <span class="keyword">if</span> (connfd &lt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">auto</span> socket = <span class="keyword">new</span> <span class="built_in">Socket</span>(connfd);</span><br><span class="line">                <span class="built_in">attach</span>(socket);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">auto</span> socket = m_conns[fd];</span><br><span class="line">                <span class="built_in">detach</span>(socket);</span><br><span class="line">                <span class="comment">// 接收客户端数据</span></span><br><span class="line">                <span class="type">char</span> buf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">                <span class="type">size_t</span> len = socket-&gt;<span class="built_in">recv</span>(buf, <span class="built_in">sizeof</span>(buf));</span><br><span class="line">                <span class="keyword">if</span> (len == <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">log_debug</span>(<span class="string">&quot;socket closed by peer: connfd = %d&quot;</span>, fd);</span><br><span class="line">                    <span class="built_in">remove</span>(socket);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (len &gt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">log_debug</span>(<span class="string">&quot;recv: conn = %d msg = %s&quot;</span>, fd, buf);</span><br><span class="line">                    <span class="comment">// 向客户端发送数据</span></span><br><span class="line">                    socket-&gt;<span class="built_in">send</span>(buf, len);</span><br><span class="line">                    <span class="built_in">attach</span>(socket);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// server.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/socket_handler.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::socket;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Singleton&lt;Logger&gt;::<span class="built_in">instance</span>()-&gt;<span class="built_in">open</span>(<span class="string">&quot;./server.log&quot;</span>);</span><br><span class="line">    <span class="keyword">auto</span> handler = Singleton&lt;SocketHandler&gt;::<span class="built_in">instance</span>();</span><br><span class="line">    handler-&gt;<span class="built_in">listen</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8080</span>);</span><br><span class="line">    handler-&gt;<span class="built_in">handle</span>(<span class="number">2000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="业务与框架分离">业务与框架分离</h2><p><code>SocketHandler</code>类对服务的启动、服务启动后监听socket等进行了封装，但是注意<code>SocketHandler::handle()</code>中包含了业务逻辑的处理过程，比如与客户端数据的收发这块具体的业务逻辑。在良好的工业实践中应将业务逻辑与框架隔离出来，这样修改业务逻辑时不会修改框架的代码，因此先初步在<code>task</code>目录中引入一个处理业务逻辑的类<code>EchoTask</code>。</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CMakeLists.txt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.19</span>)</span><br><span class="line"><span class="keyword">project</span>(select)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD <span class="number">11</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">include_directories</span>(<span class="string">&quot;./&quot;</span>)</span><br><span class="line"><span class="keyword">file</span>(GLOB_RECURSE SOURCES <span class="string">&quot;utility/*.cpp&quot;</span> <span class="string">&quot;socket/*.cpp&quot;</span> <span class="string">&quot;task/*.cpp&quot;</span>)</span><br><span class="line"><span class="keyword">add_executable</span>(server <span class="variable">$&#123;SOURCES&#125;</span> server.cpp)</span><br><span class="line"><span class="keyword">add_executable</span>(client <span class="variable">$&#123;SOURCES&#125;</span> client.cpp)</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// task/echo_task.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::socket;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::utility;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> task</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">EchoTask</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">EchoTask</span>() = <span class="keyword">delete</span>;</span><br><span class="line">            <span class="built_in">EchoTask</span>(Socket * socket);</span><br><span class="line">            ~<span class="built_in">EchoTask</span>();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 执行业务逻辑，执行完成返回true，否则返回false</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">run</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="comment">// 业务的销毁</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">destroy</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            Socket * m_socket = <span class="literal">nullptr</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// task/echo_task.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;task/echo_task.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::task;</span><br><span class="line"></span><br><span class="line">EchoTask::<span class="built_in">EchoTask</span>(Socket * socket) : <span class="built_in">m_socket</span>(socket)</span><br><span class="line">&#123;&#125;</span><br><span class="line"></span><br><span class="line">EchoTask::~<span class="built_in">EchoTask</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">destroy</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">EchoTask::run</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">log_debug</span>(<span class="string">&quot;echo task run&quot;</span>);</span><br><span class="line">    <span class="comment">// 接收客户端数据</span></span><br><span class="line">    <span class="type">char</span> buf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">size_t</span> len = m_socket-&gt;<span class="built_in">recv</span>(buf, <span class="built_in">sizeof</span>(buf));</span><br><span class="line">    <span class="keyword">if</span> (len == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_debug</span>(<span class="string">&quot;socket closed by peer: conn=%d&quot;</span>, m_socket-&gt;<span class="built_in">fd</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (len &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_debug</span>(<span class="string">&quot;recv: conn=%d msg=%s&quot;</span>, m_socket-&gt;<span class="built_in">fd</span>(), buf);</span><br><span class="line">        <span class="comment">// 向客户端发送数据</span></span><br><span class="line">        m_socket-&gt;<span class="built_in">send</span>(buf, len);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EchoTask::destroy</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">log_debug</span>(<span class="string">&quot;echo task destroy&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// socket/socket_handler.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/socket_handler.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::socket;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;task/echo_task.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::task;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SocketHandler::listen</span><span class="params">(<span class="type">const</span> string &amp; ip, <span class="type">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_server = <span class="keyword">new</span> <span class="built_in">ServerSocket</span>(ip, port);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SocketHandler::attach</span><span class="params">(Socket * socket)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_selector.<span class="built_in">set</span>(socket-&gt;<span class="built_in">fd</span>());</span><br><span class="line">    m_conns[socket-&gt;<span class="built_in">fd</span>()] = socket;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SocketHandler::detach</span><span class="params">(Socket * socket)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_selector.<span class="built_in">del</span>(socket-&gt;<span class="built_in">fd</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SocketHandler::remove</span><span class="params">(Socket * socket)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">detach</span>(socket);</span><br><span class="line">    socket-&gt;<span class="built_in">close</span>();</span><br><span class="line">    <span class="keyword">auto</span> it = m_conns.<span class="built_in">find</span>(socket-&gt;<span class="built_in">fd</span>());</span><br><span class="line">    <span class="keyword">if</span> (it != m_conns.<span class="built_in">end</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        m_conns.<span class="built_in">erase</span>(it);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">delete</span> socket;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SocketHandler::handle</span><span class="params">(<span class="type">int</span> timeout)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">attach</span>(m_server);</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> ret = m_selector.<span class="built_in">select</span>(timeout);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">log_error</span>(<span class="string">&quot;select error: errno = %d errmsg = %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (ret == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">log_debug</span>(<span class="string">&quot;select timeout&quot;</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">log_debug</span>(<span class="string">&quot;select ok: ret = %d&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> fd = <span class="number">0</span>; fd &lt; m_selector.<span class="built_in">max_fd</span>() + <span class="number">1</span>; fd++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!m_selector.<span class="built_in">is_set</span>(fd))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (fd == m_server-&gt;<span class="built_in">fd</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 服务端监听socket可读</span></span><br><span class="line">                <span class="type">int</span> connfd = m_server-&gt;<span class="built_in">accept</span>();</span><br><span class="line">                <span class="keyword">if</span> (connfd &lt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">auto</span> socket = <span class="keyword">new</span> <span class="built_in">Socket</span>(connfd);</span><br><span class="line">                <span class="built_in">attach</span>(socket);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">auto</span> socket = m_conns[fd];</span><br><span class="line">                <span class="built_in">detach</span>(socket);</span><br><span class="line">                <span class="function">EchoTask <span class="title">task</span><span class="params">(socket)</span></span>;</span><br><span class="line">                <span class="keyword">if</span> (!task.<span class="built_in">run</span>())</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">remove</span>(socket);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">attach</span>(socket);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="程序部分逻辑完善">程序部分逻辑完善</h2><ol><li><p>阻塞模式下，客户端异常退出处理，<code>recv()</code>函数返回<code>-1</code>，产生错误码为<code>ECONNRESET (104)</code>，相应错误描述为：Connection reset by peer</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// task/echo_task.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">EchoTask::run</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">log_debug</span>(<span class="string">&quot;echo task run&quot;</span>);</span><br><span class="line">    <span class="comment">// 接收客户端数据</span></span><br><span class="line">    <span class="type">char</span> buf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">int</span> len = m_socket-&gt;<span class="built_in">recv</span>(buf, <span class="built_in">sizeof</span>(buf));</span><br><span class="line">    <span class="keyword">if</span> (len &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_debug</span>(<span class="string">&quot;socket connection abort: conn=%d&quot;</span>, m_socket-&gt;<span class="built_in">fd</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (len == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_debug</span>(<span class="string">&quot;socket closed by peer: conn=%d&quot;</span>, m_socket-&gt;<span class="built_in">fd</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">log_debug</span>(<span class="string">&quot;recv: conn=%d msg=%s&quot;</span>, m_socket-&gt;<span class="built_in">fd</span>(), buf);</span><br><span class="line">    <span class="comment">// 向客户端发送数据</span></span><br><span class="line">    m_socket-&gt;<span class="built_in">send</span>(buf, len);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>非阻塞模式下，<code>recv()</code>读取空的接收缓冲区，或者<code>send()</code>写入满的发送缓冲区，都会返回<code>-1</code>，产生的错误码为<code>EAGAIN (11)</code>或<code>EWOULDBLOCK (11)</code>，对应的错误描述为：Try again或Operation would block</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// socket/socket_handler.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SocketHandler::handle</span><span class="params">(<span class="type">int</span> timeout)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">attach</span>(m_server);</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> ret = m_selector.<span class="built_in">select</span>(timeout);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">log_error</span>(<span class="string">&quot;select error: errno = %d errmsg = %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (ret == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">log_debug</span>(<span class="string">&quot;select timeout&quot;</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">log_debug</span>(<span class="string">&quot;select ok: ret = %d&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> fd = <span class="number">0</span>; fd &lt; m_selector.<span class="built_in">max_fd</span>() + <span class="number">1</span>; fd++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!m_selector.<span class="built_in">is_set</span>(fd))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (fd == m_server-&gt;<span class="built_in">fd</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 服务端监听socket可读</span></span><br><span class="line">                <span class="type">int</span> connfd = m_server-&gt;<span class="built_in">accept</span>();</span><br><span class="line">                <span class="keyword">if</span> (connfd &lt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">auto</span> socket = <span class="keyword">new</span> <span class="built_in">Socket</span>(connfd);</span><br><span class="line">                <span class="comment">// 将连接socket设置为非阻塞IO</span></span><br><span class="line">                socket-&gt;<span class="built_in">set_non_blocking</span>();</span><br><span class="line">                <span class="built_in">attach</span>(socket);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">auto</span> socket = m_conns[fd];</span><br><span class="line">                <span class="built_in">detach</span>(socket);</span><br><span class="line">                <span class="function">EchoTask <span class="title">task</span><span class="params">(socket)</span></span>;</span><br><span class="line">                <span class="keyword">if</span> (!task.<span class="built_in">run</span>())</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">remove</span>(socket);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">attach</span>(socket);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// task/echo_task.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">EchoTask::run</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">log_debug</span>(<span class="string">&quot;echo task run&quot;</span>);</span><br><span class="line">    <span class="comment">// 接收客户端数据</span></span><br><span class="line">    <span class="type">char</span> buf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">int</span> len = m_socket-&gt;<span class="built_in">recv</span>(buf, <span class="built_in">sizeof</span>(buf));</span><br><span class="line">    <span class="keyword">if</span> (len &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (errno == EAGAIN || errno == EWOULDBLOCK)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 非阻塞IO模式下，recv()读取空的接收缓冲区或send()写入已满的发送缓冲区会返回-1</span></span><br><span class="line">            <span class="comment">// 错误码为EAGAIN或EWOULDBLOCK</span></span><br><span class="line">            <span class="built_in">log_debug</span>(<span class="string">&quot;socket recv would block: conn=%d&quot;</span>, m_socket-&gt;<span class="built_in">fd</span>());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">log_debug</span>(<span class="string">&quot;socket connection abort: conn=%d&quot;</span>, m_socket-&gt;<span class="built_in">fd</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (len == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_debug</span>(<span class="string">&quot;socket closed by peer: conn=%d&quot;</span>, m_socket-&gt;<span class="built_in">fd</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">log_debug</span>(<span class="string">&quot;recv: conn=%d msg=%s&quot;</span>, m_socket-&gt;<span class="built_in">fd</span>(), buf);</span><br><span class="line">    <span class="comment">// 向客户端发送数据</span></span><br><span class="line">    m_socket-&gt;<span class="built_in">send</span>(buf, len);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>读/写时出现了中断错误，<code>recv()</code>返回<code>-1</code>，产生错误码为<code>EINTR (4)</code>，相应错误描述为：Interrupted system call</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// task/echo_task.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">EchoTask::run</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">log_debug</span>(<span class="string">&quot;echo task run&quot;</span>);</span><br><span class="line">    <span class="comment">// 接收客户端数据</span></span><br><span class="line">    <span class="type">char</span> buf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">int</span> len = m_socket-&gt;<span class="built_in">recv</span>(buf, <span class="built_in">sizeof</span>(buf));</span><br><span class="line">    <span class="keyword">if</span> (len &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (errno == EAGAIN || errno == EWOULDBLOCK)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 非阻塞IO模式下，recv()读取空的接收缓冲区或send()写入已满的发送缓冲区会返回-1</span></span><br><span class="line">            <span class="comment">// 错误码为EAGAIN或EWOULDBLOCK</span></span><br><span class="line">            <span class="built_in">log_debug</span>(<span class="string">&quot;socket recv would block: conn=%d&quot;</span>, m_socket-&gt;<span class="built_in">fd</span>());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (errno == EINTR)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// recv()接收客户端数据时被信号打断了</span></span><br><span class="line">            <span class="built_in">log_debug</span>(<span class="string">&quot;socket recv interrupted: conn=%d&quot;</span>, m_socket-&gt;<span class="built_in">fd</span>());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">log_debug</span>(<span class="string">&quot;socket connection abort: conn=%d&quot;</span>, m_socket-&gt;<span class="built_in">fd</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (len == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_debug</span>(<span class="string">&quot;socket closed by peer: conn=%d&quot;</span>, m_socket-&gt;<span class="built_in">fd</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">log_debug</span>(<span class="string">&quot;recv: conn=%d msg=%s&quot;</span>, m_socket-&gt;<span class="built_in">fd</span>(), buf);</span><br><span class="line">    <span class="comment">// 向客户端发送数据</span></span><br><span class="line">    m_socket-&gt;<span class="built_in">send</span>(buf, len);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h2 id="程序优化">程序优化</h2><p>当前程序以单线程运行是没有问题的，但如果想将其移植到多线程环境中，比如主线程处理连接 ，子线程处理不同请求，此时<code>SocketHandler</code>类中的<code>std::map&lt;int, Socket *&gt; m_conns</code>可能会涉及到多线程加锁。考虑对socket库进一步优化，使其适用于多线程环境。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// socket/socket.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> std::string;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility/logger.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::utility;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> socket</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Socket</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">Socket</span>();</span><br><span class="line">            <span class="built_in">Socket</span>(<span class="type">int</span> sockfd);</span><br><span class="line">            <span class="keyword">virtual</span> ~<span class="built_in">Socket</span>();</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">fd</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="comment">// 服务端绑定socket</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">bind</span><span class="params">(<span class="type">const</span> string &amp; ip, <span class="type">int</span> port)</span></span>;</span><br><span class="line">            <span class="comment">// 服务端监听socket</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">listen</span><span class="params">(<span class="type">int</span> backlog)</span></span>;</span><br><span class="line">            <span class="comment">// 客户端连接服务端</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">connect</span><span class="params">(<span class="type">const</span> string &amp; ip, <span class="type">int</span> port)</span></span>;</span><br><span class="line">            <span class="comment">// 服务端接受客户端连接，accept()返回与客户端连接的socket</span></span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">accept</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="comment">// 发送数据，返回发送多少个字节</span></span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">send</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * buf, <span class="type">int</span> len)</span></span>;</span><br><span class="line">            <span class="comment">// 接收数据</span></span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">recv</span><span class="params">(<span class="type">char</span> * buf, <span class="type">int</span> len)</span></span>;</span><br><span class="line">            <span class="comment">// 关闭socket连接</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">close</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="comment">// 将socket由默认的阻塞IO设置为非阻塞IO</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">set_non_blocking</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="comment">// 设置TCP发送缓冲区大小</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">set_send_buffer</span><span class="params">(<span class="type">int</span> size)</span></span>;</span><br><span class="line">            <span class="comment">// 设置TCP接收缓冲区大小</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">set_recv_buffer</span><span class="params">(<span class="type">int</span> size)</span></span>;</span><br><span class="line">            <span class="comment">// 设置SO_LINGER选项</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">set_linger</span><span class="params">(<span class="type">bool</span> active, <span class="type">int</span> seconds)</span></span>;</span><br><span class="line">            <span class="comment">// 设置SO_KEEPALIVE选项</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">set_keepalive</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="comment">// 设置SO_REUSEADDR选项</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">set_reuseaddr</span><span class="params">()</span></span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">protected</span>:</span><br><span class="line">            string m_ip;</span><br><span class="line">            <span class="type">int</span> m_port;</span><br><span class="line">            <span class="type">int</span> m_sockfd;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// socket/socket.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::socket;</span><br><span class="line"></span><br><span class="line">Socket::<span class="built_in">Socket</span>() : <span class="built_in">m_ip</span>(<span class="string">&quot;&quot;</span>), <span class="built_in">m_port</span>(<span class="number">0</span>), <span class="built_in">m_sockfd</span>(<span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    m_sockfd = ::<span class="built_in">socket</span>(AF_INET, SOCK_STREAM, IPPROTO_TCP);</span><br><span class="line">    <span class="keyword">if</span> (m_sockfd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;Create socket error:  errno = %d errmsg = %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">log_debug</span>(<span class="string">&quot;Create socket success!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Socket::<span class="built_in">Socket</span>(<span class="type">int</span> sockfd) : <span class="built_in">m_ip</span>(<span class="string">&quot;&quot;</span>), <span class="built_in">m_port</span>(<span class="number">0</span>), <span class="built_in">m_sockfd</span>(sockfd)</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Socket::~<span class="built_in">Socket</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 为了避免socket析构时自动关闭连接，因此这里不调用close()</span></span><br><span class="line">    <span class="comment">// socket连接应主动关闭</span></span><br><span class="line">    <span class="comment">// close();</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Socket::fd</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_sockfd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Socket::bind</span><span class="params">(<span class="type">const</span> string &amp; ip, <span class="type">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> address;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;address, <span class="number">0</span>, <span class="built_in">sizeof</span>(address));</span><br><span class="line">    address.sin_family = AF_INET;</span><br><span class="line">    <span class="keyword">if</span> (ip.<span class="built_in">empty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 如果传入的IP地址为空，则绑定任意的本地网卡地址</span></span><br><span class="line">        address.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 调用inet_addr()将用点分十进制字符串表示的IPv4地址转化为用网络字节序整数表示的IPv4地址，它失败时返回INADDR_NONE</span></span><br><span class="line">        address.sin_addr.s_addr = <span class="built_in">inet_addr</span>(ip.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 调用htons()将16位(2字节)短整型端口数据从主机字节序转换为网络字节序(大端序)</span></span><br><span class="line">    address.sin_port = <span class="built_in">htons</span>(port);</span><br><span class="line">    <span class="keyword">if</span> (::<span class="built_in">bind</span>(m_sockfd, (<span class="keyword">struct</span> sockaddr *)&amp;address, <span class="built_in">sizeof</span>(address)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;Bind socket error: errno = %d errmsg = %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    m_ip = ip;</span><br><span class="line">    m_port = port;</span><br><span class="line">    <span class="built_in">log_debug</span>(<span class="string">&quot;Bind socket success: ip = %s port = %d&quot;</span>, ip.<span class="built_in">c_str</span>(), port);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Socket::listen</span><span class="params">(<span class="type">int</span> backlog)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (::<span class="built_in">listen</span>(m_sockfd, <span class="number">1024</span>) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;Socket listen error: errno = %d errmsg = %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">log_debug</span>(<span class="string">&quot;Socket listening...&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Socket::connect</span><span class="params">(<span class="type">const</span> string &amp; ip, <span class="type">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> address;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;address, <span class="number">0</span>, <span class="built_in">sizeof</span>(address));</span><br><span class="line">    address.sin_family = AF_INET;</span><br><span class="line">    address.sin_addr.s_addr = <span class="built_in">inet_addr</span>(ip.<span class="built_in">c_str</span>());</span><br><span class="line">    address.sin_port = <span class="built_in">htons</span>(port);</span><br><span class="line">    <span class="keyword">if</span> (::<span class="built_in">connect</span>(m_sockfd, (<span class="keyword">struct</span> sockaddr *)&amp;address, <span class="built_in">sizeof</span>(address)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;Socket connect error: errno = %d errmsg = %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    m_ip = ip;</span><br><span class="line">    m_port = port;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Socket::accept</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> connfd = ::<span class="built_in">accept</span>(m_sockfd, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="keyword">if</span> (connfd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;Socket accept error: errno = %d errmsg = %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">log_debug</span>(<span class="string">&quot;Socket accept: connfd = %d&quot;</span>, connfd);</span><br><span class="line">    <span class="keyword">return</span> connfd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Socket::send</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * buf, <span class="type">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ::<span class="built_in">send</span>(m_sockfd, buf, len, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Socket::recv</span><span class="params">(<span class="type">char</span> * buf, <span class="type">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ::<span class="built_in">recv</span>(m_sockfd, buf, len, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Socket::close</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_sockfd &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ::<span class="built_in">close</span>(m_sockfd);</span><br><span class="line">        m_sockfd = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Socket::set_non_blocking</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 先获取socket的标记</span></span><br><span class="line">    <span class="type">int</span> flags = <span class="built_in">fcntl</span>(m_sockfd, F_GETFL, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (flags &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;Socket set_non_blocking error: errno = %d errmsg=%s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    flags |= O_NONBLOCK;</span><br><span class="line">    <span class="comment">// 设置socket的标记位</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">fcntl</span>(m_sockfd, F_SETFL, flags) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;Socket set_non_blocking error: errno = %d errmsg=%s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Socket::set_send_buffer</span><span class="params">(<span class="type">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> buff_size = size;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">setsockopt</span>(m_sockfd, SOL_SOCKET, SO_SNDBUF, &amp;buff_size, <span class="built_in">sizeof</span>(buff_size)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;Socket set_send_buffer error: errno = %d errmsg = %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Socket::set_recv_buffer</span><span class="params">(<span class="type">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> buff_size = size;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">setsockopt</span>(m_sockfd, SOL_SOCKET, SO_RCVBUF, &amp;buff_size, <span class="built_in">sizeof</span>(buff_size)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;Socket set_recv_buffer error: errno = %d errmsg = %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Socket::set_linger</span><span class="params">(<span class="type">bool</span> active, <span class="type">int</span> seconds)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">linger</span> l;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;l, <span class="number">0</span>, <span class="built_in">sizeof</span>(l));</span><br><span class="line">    l.l_onoff = active ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">    l.l_linger = seconds;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">setsockopt</span>(m_sockfd, SOL_SOCKET, SO_LINGER, &amp;l, <span class="built_in">sizeof</span>(l)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;Socket set_linger error: errno = %d errmsg = %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Socket::set_keepalive</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> flag = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">setsockopt</span>(m_sockfd, SOL_SOCKET, SO_KEEPALIVE, &amp;flag, <span class="built_in">sizeof</span>(flag)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;Socket set_keepalive error: errno = %d errmsg = %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Socket::set_reuseaddr</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> flag = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">setsockopt</span>(m_sockfd, SOL_SOCKET, SO_REUSEADDR, &amp;flag, <span class="built_in">sizeof</span>(flag)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;Socket set_reuseaddr error: errno = %d errmsg = %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// socket/socket_handler.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/server_socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/selector.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> socket</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">SocketHandler</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">SINGLETON</span>(SocketHandler);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">listen</span><span class="params">(<span class="type">const</span> string &amp; ip, <span class="type">int</span> port)</span></span>;</span><br><span class="line">            <span class="comment">// 将socket加入到监听的集合中</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">attach</span><span class="params">(<span class="type">int</span> sockfd)</span></span>;</span><br><span class="line">            <span class="comment">// 将socket从监听集合中移除</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">detach</span><span class="params">(<span class="type">int</span> sockfd)</span></span>;</span><br><span class="line">            <span class="comment">// timeout为超时参数，单位ms</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">handle</span><span class="params">(<span class="type">int</span> timeout)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="comment">// 服务端socket</span></span><br><span class="line">            Socket * m_server = <span class="literal">nullptr</span>;</span><br><span class="line">            <span class="comment">// 底层IO多路复用采用select</span></span><br><span class="line">            Selector m_selector;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// socket/socket_handler.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/socket_handler.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::socket;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;task/echo_task.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::task;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SocketHandler::listen</span><span class="params">(<span class="type">const</span> string &amp; ip, <span class="type">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_server = <span class="keyword">new</span> <span class="built_in">ServerSocket</span>(ip, port);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SocketHandler::attach</span><span class="params">(<span class="type">int</span> sockfd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_selector.<span class="built_in">set</span>(sockfd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SocketHandler::detach</span><span class="params">(<span class="type">int</span> sockfd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_selector.<span class="built_in">del</span>(sockfd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SocketHandler::handle</span><span class="params">(<span class="type">int</span> timeout)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">attach</span>(m_server-&gt;<span class="built_in">fd</span>());</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> ret = m_selector.<span class="built_in">select</span>(timeout);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">log_error</span>(<span class="string">&quot;select error: errno = %d errmsg = %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (ret == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">log_debug</span>(<span class="string">&quot;select timeout&quot;</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">log_debug</span>(<span class="string">&quot;select ok: ret = %d&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> fd = <span class="number">0</span>; fd &lt; m_selector.<span class="built_in">max_fd</span>() + <span class="number">1</span>; fd++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!m_selector.<span class="built_in">is_set</span>(fd))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (fd == m_server-&gt;<span class="built_in">fd</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 服务端监听socket可读</span></span><br><span class="line">                <span class="type">int</span> connfd = m_server-&gt;<span class="built_in">accept</span>();</span><br><span class="line">                <span class="keyword">if</span> (connfd &lt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="function">Socket <span class="title">socket</span><span class="params">(connfd)</span></span>;</span><br><span class="line">                <span class="comment">// 将连接socket设置为非阻塞IO</span></span><br><span class="line">                socket.<span class="built_in">set_non_blocking</span>();</span><br><span class="line">                <span class="built_in">attach</span>(connfd);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">detach</span>(fd);</span><br><span class="line">                <span class="function">EchoTask <span class="title">task</span><span class="params">(fd)</span></span>;</span><br><span class="line">                <span class="keyword">if</span> (!task.<span class="built_in">run</span>())</span><br><span class="line">                &#123;</span><br><span class="line">                    ::<span class="built_in">close</span>(fd);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">attach</span>(fd);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// task/echo_task.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::socket;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::utility;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> task</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">EchoTask</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">EchoTask</span>() = <span class="keyword">delete</span>;</span><br><span class="line">            <span class="built_in">EchoTask</span>(<span class="type">int</span> sockfd);</span><br><span class="line">            ~<span class="built_in">EchoTask</span>();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 执行业务逻辑，执行完成返回true，否则返回false</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">run</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="comment">// 业务的销毁</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">destroy</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="type">int</span> m_sockfd = <span class="number">0</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// task/echo_task.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;task/echo_task.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::task;</span><br><span class="line"></span><br><span class="line">EchoTask::<span class="built_in">EchoTask</span>(<span class="type">int</span> sockfd) : <span class="built_in">m_sockfd</span>(sockfd)</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">EchoTask::~<span class="built_in">EchoTask</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">destroy</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">EchoTask::run</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">log_debug</span>(<span class="string">&quot;echo task run&quot;</span>);</span><br><span class="line">    <span class="comment">// 接收客户端数据</span></span><br><span class="line">    <span class="function">Socket <span class="title">socket</span><span class="params">(m_sockfd)</span></span>;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">int</span> len = socket.<span class="built_in">recv</span>(buf, <span class="built_in">sizeof</span>(buf));</span><br><span class="line">    <span class="keyword">if</span> (len &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (errno == EAGAIN || errno == EWOULDBLOCK)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 非阻塞IO模式下，recv()读取空的接收缓冲区或send()写入已满的发送缓冲区会返回-1</span></span><br><span class="line">            <span class="comment">// 错误码为EAGAIN或EWOULDBLOCK</span></span><br><span class="line">            <span class="built_in">log_debug</span>(<span class="string">&quot;socket recv would block: conn=%d&quot;</span>, m_sockfd);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (errno == EINTR)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// recv()接收客户端数据时被信号打断了</span></span><br><span class="line">            <span class="built_in">log_debug</span>(<span class="string">&quot;socket recv interrupted: conn=%d&quot;</span>, m_sockfd);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">log_debug</span>(<span class="string">&quot;socket connection abort: conn=%d&quot;</span>, m_sockfd);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (len == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_debug</span>(<span class="string">&quot;socket closed by peer: conn=%d&quot;</span>, m_sockfd);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">log_debug</span>(<span class="string">&quot;recv: conn=%d msg=%s&quot;</span>, m_sockfd, buf);</span><br><span class="line">    <span class="comment">// 向客户端发送数据</span></span><br><span class="line">    socket. <span class="built_in">send</span>(buf, len);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EchoTask::destroy</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">log_debug</span>(<span class="string">&quot;echo task destroy&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="select总结">select总结</h2><p>优点：</p><ol><li>select用法简单</li><li>select几乎支持所有的平台，可移植性更好</li><li>select对于超时提供了更好的精度级别(微秒us)，而poll和epoll是毫秒ms</li></ol><p>缺点：</p><ol><li>单个进程可监听的文件描述符数量有限制，最多允许1024个连接</li><li>需要维护一个用来存放大量文件描述符的<code>fd_set</code>数据结构，会使得用户空间和内核空间在传递该结构时复制开销较大</li><li>对<code>fd_set</code>进行扫描时是线性扫描，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mclose">)</span></span></span></span>时间复杂度。当文件描述符剧增后，IO效率较低，因此每次调用都对<code>fd_set</code>进行线性扫描遍历，所以随着文件描述符的增加会造成遍历速度慢的性能瓶颈问题</li></ol>]]></content>
      
      
      
        <tags>
            
            <tag> C++后端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux网络编程基础</title>
      <link href="/2024/08/11/Linux%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/"/>
      <url>/2024/08/11/Linux%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/</url>
      
        <content type="html"><![CDATA[<h1 id="网络编程基础">网络编程基础</h1><h2 id="网络协议：tcp-ip">网络协议：TCP/IP</h2><p><img src="https://aliyun-oss-zh.oss-cn-beijing.aliyuncs.com/img/QQ20250827-011758.jpg" alt=""></p><p>TCP/IP协议分为四层，从上到下依次为应用层、传输层、网络层和网络接口层：</p><ol><li>应用层：主要负责为用户提供网络服务，应用层协议包括HTTP、FTP、SMTP等</li><li>传输层：主要负责在网络中建立端到端的连接，提供可靠的数据传输，传输层协议包括TCP和UDP</li><li>网络层：主要负责网络地址的分配和路由选择，例如IP协议</li><li>数据链路层：主要负责传输数据帧，例如以太网、ATM和PPP等协议</li></ol><p>Reference：</p><p><a href="https://zhuanlan.zhihu.com/p/620485741"> 探索网络世界的核心：TCPIP协议四层模型解析 - 知乎</a></p><h2 id="进程间通信：ipc">进程间通信：IPC</h2><ol><li>管道：pipe</li><li>信号：signal</li><li>信号量：semaphore</li><li>消息队列：message</li><li>共享内存：share memory</li><li>套接字：socket</li></ol><p>Reference：</p><p><a href="https://zhuanlan.zhihu.com/p/502627174"> 进程间通信 - 知乎</a></p><p>《Linux高性能服务器编程》</p><h2 id="套接字-socket">套接字 socket</h2><p><img src="https://aliyun-oss-zh.oss-cn-beijing.aliyuncs.com/img/%E9%92%88%E5%AF%B9TCP%E7%9A%84socket%E9%80%9A%E4%BF%A1.png" alt=""></p><p>客户端与服务端通过socket建立连接并收发数据的流程大致如下：</p><ol><li>服务端和客户端初始化socket，得到文件描述符</li><li>服务端调用<code>bind()</code>，绑定IP和端口</li><li>服务端调用<code>listen()</code>，进行监听</li><li>服务端调用<code>accept()</code>，等待客户端连接</li><li>客户端调用<code>connect()</code>，向服务端发起连接请求(TCP三次握手)</li><li>服务端调用<code>accept()</code>返回用于传输的socket的文件描述符</li><li>客户端使用<code>write()</code>写入数据，服务端调用<code>read()</code>读取数据</li><li>客户端断开连接时会调用<code>close()</code>，服务端也会调用<code>close()</code>(TCP四次挥手)</li></ol><p>Reference:</p><p><a href="https://blog.csdn.net/OYMNCHR/article/details/124728256">进程间的通信方式（六种）_进程间通信-CSDN博客</a></p><h2 id="最简单的服务端">最简单的服务端</h2><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CMakeLists.txt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.19</span>)</span><br><span class="line"><span class="keyword">project</span>(socket)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD <span class="number">11</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_executable</span>(server server.cpp)</span><br><span class="line"><span class="keyword">add_executable</span>(client client.cpp)</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// server.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> std::string;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 1.创建socket</span></span><br><span class="line">    <span class="type">int</span> sockfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, IPPROTO_TCP);</span><br><span class="line">    <span class="keyword">if</span> (sockfd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Create socket error:  errno = %d errmsg = %s\n&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Create socket success!\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.绑定socket</span></span><br><span class="line">    string ip = <span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line">    <span class="type">int</span> port = <span class="number">8080</span>;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> address;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;address, <span class="number">0</span>, <span class="built_in">sizeof</span>(address));</span><br><span class="line">    address.sin_family = AF_INET;</span><br><span class="line">    <span class="comment">// 调用inet_addr()将用点分十进制字符串表示的IPv4地址转化为用网络字节序整数表示的IPv4地址，它失败时返回INADDR_NONE</span></span><br><span class="line">    address.sin_addr.s_addr = <span class="built_in">inet_addr</span>(ip.<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="comment">// 调用htons()将16位(2字节)短整型端口数据从主机字节序转换为网络字节序(大端序)</span></span><br><span class="line">    address.sin_port = <span class="built_in">htons</span>(port);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">bind</span>(sockfd, (<span class="keyword">struct</span> sockaddr *)&amp;address, <span class="built_in">sizeof</span>(address)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Bind socket error: errno = %d errmsg = %s\n&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Bind socket success: ip = %s port = %d\n&quot;</span>, ip.<span class="built_in">c_str</span>(), port);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.监听socket</span></span><br><span class="line">    <span class="comment">// backlog参数提示内核监听队列的最大长度</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">listen</span>(sockfd, <span class="number">1024</span>) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Socket listen error: errno = %d errmsg = %s\n&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Socket listening...\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 4.接受客户端连接</span></span><br><span class="line">        <span class="comment">// accept()返回与客户端连接的socket</span></span><br><span class="line">        <span class="type">int</span> connfd = <span class="built_in">accept</span>(sockfd, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>);</span><br><span class="line">        <span class="keyword">if</span> (connfd &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Socket accept error: errno = %d errmsg = %s\n&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">char</span> buf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        <span class="comment">// 5.接收客户端的数据</span></span><br><span class="line">        <span class="type">size_t</span> len = <span class="built_in">recv</span>(connfd, buf, <span class="built_in">sizeof</span>(buf), <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Recv: connfd = %d msg = %s\n&quot;</span>, connfd, buf);</span><br><span class="line">        <span class="comment">// 6.向客户端发送数据(将客户端发来的数据原封不动地发回客户端)</span></span><br><span class="line">        <span class="built_in">send</span>(connfd, buf, len, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 7.关闭socket</span></span><br><span class="line">    <span class="built_in">close</span>(sockfd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="最简单的客户端">最简单的客户端</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// client.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> std::string;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 1.创建socket</span></span><br><span class="line">    <span class="type">int</span> sockfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, IPPROTO_TCP);</span><br><span class="line">    <span class="keyword">if</span> (sockfd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Create socket error:  errno = %d errmsg = %s\n&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Create socket success!\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2.连接服务端</span></span><br><span class="line">    string ip = <span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line">    <span class="type">int</span> port = <span class="number">8080</span>;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> address;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;address, <span class="number">0</span>, <span class="built_in">sizeof</span>(address));</span><br><span class="line">    address.sin_family = AF_INET;</span><br><span class="line">    address.sin_addr.s_addr = <span class="built_in">inet_addr</span>(ip.<span class="built_in">c_str</span>());</span><br><span class="line">    address.sin_port = <span class="built_in">htons</span>(port);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">connect</span>(sockfd, (<span class="keyword">struct</span> sockaddr *)&amp;address, <span class="built_in">sizeof</span>(address)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Socket connect error: errno = %d errmsg = %s\n&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.向服务端发送数据</span></span><br><span class="line">    string data = <span class="string">&quot;hello world&quot;</span>;</span><br><span class="line">    <span class="built_in">send</span>(sockfd, data.<span class="built_in">c_str</span>(), data.<span class="built_in">size</span>(), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4.接收服务端的数据</span></span><br><span class="line">    <span class="type">char</span> buf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">recv</span>(sockfd, buf, <span class="built_in">sizeof</span>(buf), <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Recv: %s\n&quot;</span>, buf);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5.关闭socket</span></span><br><span class="line">    <span class="built_in">close</span>(sockfd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="socket简单封装">Socket简单封装</h2><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CMakeLists.txt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.19</span>)</span><br><span class="line"><span class="keyword">project</span>(socket)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD <span class="number">11</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">include_directories</span>(<span class="string">&quot;./&quot;</span>)</span><br><span class="line"><span class="keyword">file</span>(GLOB_RECURSE SOURCES <span class="string">&quot;utility/*.cpp&quot;</span> <span class="string">&quot;socket/*.cpp&quot;</span>)</span><br><span class="line"><span class="keyword">add_executable</span>(server1 <span class="variable">$&#123;SOURCES&#125;</span> server1.cpp)</span><br><span class="line"><span class="keyword">add_executable</span>(client1 <span class="variable">$&#123;SOURCES&#125;</span> client1.cpp)</span><br><span class="line"><span class="keyword">add_executable</span>(server2 <span class="variable">$&#123;SOURCES&#125;</span> server2.cpp)</span><br><span class="line"><span class="keyword">add_executable</span>(client2 <span class="variable">$&#123;SOURCES&#125;</span> client2.cpp)</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// socket/socket.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> std::string;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility/logger.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::utility;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> socket</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Socket</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">Socket</span>();</span><br><span class="line">            <span class="built_in">Socket</span>(<span class="type">int</span> sockfd);</span><br><span class="line">            ~<span class="built_in">Socket</span>();</span><br><span class="line">            <span class="comment">// 服务端绑定socket</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">bind</span><span class="params">(<span class="type">const</span> string &amp; ip, <span class="type">int</span> port)</span></span>;</span><br><span class="line">            <span class="comment">// 服务端监听socket</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">listen</span><span class="params">(<span class="type">int</span> backlog)</span></span>;</span><br><span class="line">            <span class="comment">// 客户端连接服务端</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">connect</span><span class="params">(<span class="type">const</span> string &amp; ip, <span class="type">int</span> port)</span></span>;</span><br><span class="line">            <span class="comment">// 服务端接受客户端连接，accept()返回与客户端连接的socket</span></span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">accept</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="comment">// 发送数据，返回发送多少个字节</span></span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">send</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * buf, <span class="type">int</span> len)</span></span>;</span><br><span class="line">            <span class="comment">// 接收数据</span></span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">recv</span><span class="params">(<span class="type">char</span> * buf, <span class="type">int</span> len)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">close</span><span class="params">()</span></span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">protected</span>:</span><br><span class="line">            string m_ip;</span><br><span class="line">            <span class="type">int</span> m_port;</span><br><span class="line">            <span class="type">int</span> m_sockfd;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// socket/socket.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::socket;</span><br><span class="line"></span><br><span class="line">Socket::<span class="built_in">Socket</span>() : <span class="built_in">m_ip</span>(<span class="string">&quot;&quot;</span>), <span class="built_in">m_port</span>(<span class="number">0</span>), <span class="built_in">m_sockfd</span>(<span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    m_sockfd = ::<span class="built_in">socket</span>(AF_INET, SOCK_STREAM, IPPROTO_TCP);</span><br><span class="line">    <span class="keyword">if</span> (m_sockfd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;Create socket error:  errno = %d errmsg = %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">log_debug</span>(<span class="string">&quot;Create socket success!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Socket::<span class="built_in">Socket</span>(<span class="type">int</span> sockfd) : <span class="built_in">m_ip</span>(<span class="string">&quot;&quot;</span>), <span class="built_in">m_port</span>(<span class="number">0</span>), <span class="built_in">m_sockfd</span>(sockfd)</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Socket::~<span class="built_in">Socket</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">close</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Socket::bind</span><span class="params">(<span class="type">const</span> string &amp; ip, <span class="type">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> address;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;address, <span class="number">0</span>, <span class="built_in">sizeof</span>(address));</span><br><span class="line">    address.sin_family = AF_INET;</span><br><span class="line">    <span class="keyword">if</span> (ip.<span class="built_in">empty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 如果传入的IP地址为空，则绑定任意的本地网卡地址</span></span><br><span class="line">        address.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 调用inet_addr()将用点分十进制字符串表示的IPv4地址转化为用网络字节序整数表示的IPv4地址，它失败时返回INADDR_NONE</span></span><br><span class="line">        address.sin_addr.s_addr = <span class="built_in">inet_addr</span>(ip.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 调用htons()将16位(2字节)短整型端口数据从主机字节序转换为网络字节序(大端序)</span></span><br><span class="line">    address.sin_port = <span class="built_in">htons</span>(port);</span><br><span class="line">    <span class="keyword">if</span> (::<span class="built_in">bind</span>(m_sockfd, (<span class="keyword">struct</span> sockaddr *)&amp;address, <span class="built_in">sizeof</span>(address)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;Bind socket error: errno = %d errmsg = %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    m_ip = ip;</span><br><span class="line">    m_port = port;</span><br><span class="line">    <span class="built_in">log_debug</span>(<span class="string">&quot;Bind socket success: ip = %s port = %d&quot;</span>, ip.<span class="built_in">c_str</span>(), port);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Socket::listen</span><span class="params">(<span class="type">int</span> backlog)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (::<span class="built_in">listen</span>(m_sockfd, <span class="number">1024</span>) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;Socket listen error: errno = %d errmsg = %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">log_debug</span>(<span class="string">&quot;Socket listening...&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Socket::connect</span><span class="params">(<span class="type">const</span> string &amp; ip, <span class="type">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> address;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;address, <span class="number">0</span>, <span class="built_in">sizeof</span>(address));</span><br><span class="line">    address.sin_family = AF_INET;</span><br><span class="line">    address.sin_addr.s_addr = <span class="built_in">inet_addr</span>(ip.<span class="built_in">c_str</span>());</span><br><span class="line">    address.sin_port = <span class="built_in">htons</span>(port);</span><br><span class="line">    <span class="keyword">if</span> (::<span class="built_in">connect</span>(m_sockfd, (<span class="keyword">struct</span> sockaddr *)&amp;address, <span class="built_in">sizeof</span>(address)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;Socket connect error: errno = %d errmsg = %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    m_ip = ip;</span><br><span class="line">    m_port = port;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Socket::accept</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> connfd = ::<span class="built_in">accept</span>(m_sockfd, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="keyword">if</span> (connfd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;Socket accept error: errno = %d errmsg = %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">log_debug</span>(<span class="string">&quot;Socket accept: connfd = %d&quot;</span>, connfd);</span><br><span class="line">    <span class="keyword">return</span> connfd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Socket::send</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * buf, <span class="type">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ::<span class="built_in">send</span>(m_sockfd, buf, len, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Socket::recv</span><span class="params">(<span class="type">char</span> * buf, <span class="type">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ::<span class="built_in">recv</span>(m_sockfd, buf, len, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Socket::close</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_sockfd &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ::<span class="built_in">close</span>(m_sockfd);</span><br><span class="line">        m_sockfd = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// server2.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::socket;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Singleton&lt;Logger&gt;::<span class="built_in">instance</span>()-&gt;<span class="built_in">open</span>(<span class="string">&quot;./server.log&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1.创建socket</span></span><br><span class="line">    Socket server;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.绑定socket</span></span><br><span class="line">    server.<span class="built_in">bind</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8080</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.监听socket</span></span><br><span class="line">    server.<span class="built_in">listen</span>(<span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 4.接受客户端连接</span></span><br><span class="line">        <span class="type">int</span> connfd = server.<span class="built_in">accept</span>();</span><br><span class="line">        <span class="keyword">if</span> (connfd &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>; </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function">Socket <span class="title">client</span><span class="params">(connfd)</span></span>;</span><br><span class="line">        <span class="type">char</span> buf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 5.接收客户端的数据</span></span><br><span class="line">        <span class="type">size_t</span> len = client.<span class="built_in">recv</span>(buf, <span class="built_in">sizeof</span>(buf));</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Recv: connfd = %d msg = %s\n&quot;</span>, connfd, buf);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6.向客户端发送数据</span></span><br><span class="line">        client.<span class="built_in">send</span>(buf, len);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 7.关闭socket</span></span><br><span class="line">    server.<span class="built_in">close</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// client.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::socket;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 1.创建socket</span></span><br><span class="line">    Socket client;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2.连接服务端</span></span><br><span class="line">    client.<span class="built_in">connect</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8080</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.向服务端发送数据</span></span><br><span class="line">    string data = <span class="string">&quot;hello world&quot;</span>;</span><br><span class="line">    client.<span class="built_in">send</span>(data.<span class="built_in">c_str</span>(), data.<span class="built_in">size</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4.接收服务端的数据</span></span><br><span class="line">    <span class="type">char</span> buf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    client.<span class="built_in">recv</span>(buf, <span class="built_in">sizeof</span>(buf));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Recv: %s\n&quot;</span>, buf);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5.关闭socket</span></span><br><span class="line">    client.<span class="built_in">close</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="i-o模型">I/O模型</h2><p>socket在创建的时候默认是阻塞的，可以给socket系统调用的第2个参数传递<code>SOCK_NONBLOCK</code>标志，或者通过<code>fcntl()</code>系统调用的<code>F_SETFL</code>命令，将其设置为非阻塞的。阻塞和非阻塞的概念能应用于所有文件描述符，而不仅仅是socket。称阻塞的文件描述符为阻塞I/O，称非阻塞的文件描述符为非阻塞I/O。</p><p>针对阻塞I/O执行的系统调用可能因为无法立即完成而被操作系统挂起，直到等待的事件发生为止。比如，客户端通过<code>connect()</code>向服务器发起连接时，<code>connect()</code>将首先发送同步报文段给服务器，然后等待服务器返回确认报文段。如果服务器的确认报文段没有立即到达客户端，则<code>connect()</code>调用将被挂起，直到客户端收到确认报文段并唤醒<code>connect()</code>调用。socket的基础API中，可能被阻塞的系统调用包括<code>accept()</code>、<code>send()</code>、<code>recv()</code>和<code>connect()</code>。</p><p>针对非阻塞I/O执行的系统调用则总是立即返回，而不管事件是否已经发生。如果事件没有立即发生，这些系统调用就返回<code>-1</code>，和出错的情况一样。此时必须根据<code>errno</code>来区分这两种情况。对于<code>accept()</code>、<code>send()</code>和<code>recv</code>而言，事件未发生时<code>errno</code>通常被设置成<code>EAGAIN</code>(意为“再来一次”)或者<code>EWOULDBLOCK</code>(意为“期望阻塞”)；对于<code>connect()</code>而言，<code>errno</code>则被设置成<code>EINPROGRESS</code>(意为”在处理中“)。</p><p>很显然，只有在事件已经发生的情况下操作非阻塞I/O(读、写等)，才能提高程序的效率。因此，非阻塞I/O通常要和其它I/O通知机制一起使用，比如I/O复用和SIGIO信号。</p><h3 id="阻塞io">阻塞IO</h3><p>当用户线程发出IO请求(读数据/写数据)之后，内核会去查看数据是否就绪，如果没有就绪就会等待数据就绪，而用户线程就会处于阻塞状态，用户线程交出CPU。当数据就绪之后，内核会将数据拷贝到用户线程，并返回结果给用户线程，用户线程才解除阻塞状态。</p><p>对于服务端来说，当还未有客户端连接时调用<code>accept()</code>会阻塞，客户端连接服务端后但还未发送数据时调用<code>recv()</code>也会阻塞，因为数据还未到来。服务端调用<code>send()</code>时也会发生阻塞。</p><p>对于客户端来说，调用<code>connect()</code>连接服务端会阻塞，因为需要三次握手建立TCP连接，发送数据<code>send()</code>和读取数据<code>recv()</code>都可能会阻塞。</p><p>注意，创建出来socket如果不做任何设置默认都是阻塞IO模型！</p><h3 id="非阻塞io">非阻塞IO</h3><p>当用户线程发起<code>read()</code>操作后，并不需要等待，而是马上得到结果。如果结果是一个<code>errno</code>时，它就知道数据还没有准备好，于是它可以再次发起<code>read()</code>操作。如果内核中的数据准备好了，它就将数据拷贝到用户线程。</p><p>在非阻塞IO模型中，用户线程需要不断地轮询内核数据是否就绪，也就是说非阻塞IO不会交出CPU，而会一直占用CPU。即在轮询的模式下，一般都是采用非阻塞IO。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将socket由默认的阻塞IO设置为非阻塞IO</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Socket::set_non_blocking</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 先获取socket的标记</span></span><br><span class="line">    <span class="type">int</span> flags = <span class="built_in">fcntl</span>(m_sockfd, F_GETFL, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (flags &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;Socket set_non_blocking error: errno = %d errmsg=%s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    flags |= O_NONBLOCK;</span><br><span class="line">    <span class="comment">// 设置socket的标记位</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">fcntl</span>(m_sockfd, F_SETFL, flags) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;Socket set_non_blocking error: errno = %d errmsg=%s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="发送缓冲区">发送缓冲区</h2><p><img src="https://aliyun-oss-zh.oss-cn-beijing.aliyuncs.com/img/QQ20250830-002744.jpg" alt=""></p><p>socket没法直接将数据发送到网卡，所以只能先将数据发送到操作系统的数据发送缓冲区，然后网卡从数据发送缓冲区中获取数据，再发送到接收方。</p><p>如果用户程序发送数据的速度比网卡读取的速度快，那么发送缓冲区将会很快被写满，这个时候<code>send()</code>会被阻塞，也就是写入发生阻塞。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置TCP发送缓冲区大小</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Socket::set_send_buffer</span><span class="params">(<span class="type">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> buff_size = size;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">setsockopt</span>(m_sockfd, SOL_SOCKET, SO_SNDBUF, &amp;buff_size, <span class="built_in">sizeof</span>(buff_size)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;Socket set_send_buffer error: errno = %d errmsg = %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="接收缓冲区">接收缓冲区</h2><p><img src="https://aliyun-oss-zh.oss-cn-beijing.aliyuncs.com/img/QQ20250830-002754.jpg" alt=""></p><p>首先接收方机器网卡接收到发送方的数据后，先将数据保存到操作系统的接收缓冲区，用户程序感知到操作系统缓冲区的数据后，主动调用接收数据的方法来获取数据。</p><p>如果数据接收缓冲区为空，此时<code>recv()</code>会被阻塞，也就是读取发生阻塞。</p><p>注意：发送缓冲区和接收缓冲区这两个区域是每一个socket连接都有的，本质上而言，就是内核中的两块内存空间，socket创建完成后，这两块内存空间就开辟出来了。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置TCP接收缓冲区大小</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Socket::set_recv_buffer</span><span class="params">(<span class="type">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> buff_size = size;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">setsockopt</span>(m_sockfd, SOL_SOCKET, SO_RCVBUF, &amp;buff_size, <span class="built_in">sizeof</span>(buff_size)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;Socket set_recv_buffer error: errno = %d errmsg = %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="so-linger">SO_LINGER</h2><p><code>SO_LINGER</code>选项用于控制<code>close()</code>系统调用在关闭TCP连接时的行为。默认情况下，当使用<code>close()</code>系统调用来关闭一个socket时，<code>close()</code>将立即返回，TCP模块负责把该socket对应的TCP发送缓冲区中残留的数据发送给对方。</p><p>在设置/获取<code>SO_LINGER</code>选项的值时，需要给<code>setsockopt()</code>或<code>getsockopt()</code>系统调用传递一个<code>linger</code>类型的结构体，其定义如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">linger</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> l_onoff;<span class="comment">/* 开启(非0)还是关闭(0)该选项 */</span></span><br><span class="line">    <span class="type">int</span> l_linger;<span class="comment">/* 滞留时间 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>根据<code>linger</code>结构体中两个成员变量的不同值，<code>close()</code>系统调用可能产生如下3种行为之一：</p><ol><li><code>l_onoff</code>等于<code>0</code>。此时<code>SO_LINGER</code>选项不起作用，<code>close()</code>用默认行为来关闭socket。</li><li><code>l_onoff</code>不为<code>0</code>，<code>l_linger</code>等于<code>0</code>。此时<code>close()</code>系统调用立即返回，TCP模块将丢弃被关闭的socket对应的TCP发送缓冲区中残留的数据，同时给对方发送一个复位报文段。因此，这种情况给服务器提供了异常终止一个连接的方法。</li><li><code>l_onoff</code>不为<code>0</code>，<code>l_linger</code>大于<code>0</code>。此时<code>close()</code>的行为取决于两个条件：一是被关闭的socket对应的TCP发送缓冲区中是否还有残留的数据；二是该socket是阻塞的，还是非阻塞的。对于阻塞的socket，<code>close()</code>将等待一段长为<code>l_linger</code>的时间，直到TCP模块发送完所有残留数据并得到对方的确认。如果这段时间内TCP模块没有发送完残留数据并得到对方的确认，那么<code>close()</code>系统调用将返回<code>-1</code>并设置<code>errno</code>为<code>EWOULDBLOCK</code>。如果socket是非阻塞的，<code>close()</code>将立即返回，此时需要根据其返回值和<code>errno</code>来判断残留数据是否已经发送完毕。</li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置SO_LINGER选项</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Socket::set_linger</span><span class="params">(<span class="type">bool</span> active, <span class="type">int</span> seconds)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">linger</span> l;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;l, <span class="number">0</span>, <span class="built_in">sizeof</span>(l));</span><br><span class="line">    l.l_onoff = active ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">    l.l_linger = seconds;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">setsockopt</span>(m_sockfd, SOL_SOCKET, SO_LINGER, &amp;l, <span class="built_in">sizeof</span>(l)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;Socket set_linger error: errno = %d errmsg = %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Reference:</p><p><a href="https://blog.csdn.net/u012635648/article/details/80279338">SO_LINGER详解-CSDN博客</a></p><p>《Linux高性能服务器编程》</p><h2 id="so-keepalive">SO_KEEPALIVE</h2><p>不论是服务端还是客户端，一方开启KeepAlive功能后，就会自动在规定时间内向对方发送心跳包，而另一方在收到心跳包后就会自动回复，以告诉对方我仍然在线。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置SO_KEEPALIVE选项</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Socket::set_keepalive</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> flag = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">setsockopt</span>(m_sockfd, SOL_SOCKET, SO_KEEPALIVE, &amp;flag, <span class="built_in">sizeof</span>(flag)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;Socket set_keepalive error: errno = %d errmsg = %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Reference:</p><p><a href="https://www.cnblogs.com/1119reya/p/10382276.html">TCP/IP-SO_KEEPALIVE - 鱼猫猫1119 - 博客园</a></p><h2 id="so-reuseaddr">SO_REUSEADDR</h2><p><img src="https://aliyun-oss-zh.oss-cn-beijing.aliyuncs.com/img/QQ20250831-184739.jpg" alt=""></p><p><img src="https://aliyun-oss-zh.oss-cn-beijing.aliyuncs.com/img/QQ20250831-184753.jpg" alt=""></p><p><img src="https://aliyun-oss-zh.oss-cn-beijing.aliyuncs.com/img/QQ20250830-012619.jpg" alt=""></p><p>从上图来看，客户端连接在收到服务器的结束报文段(TCP报文段6)之后，并没有直接进入<code>CLOSED</code>状态，而是转移到<code>TIME_WAIT</code>状态。在这个状态，客户端连接要等待一段长为<code>2MSL</code>(<code>Maximum Segment Life</code>，报文段最大生存时间)的时间，才能完全关闭。<code>MSL</code>是TCP报文段在网络中的最大生存时间，标准文档RFC 1122的建议值是2 min。</p><p><code>TIME_WAIT</code>状态存在的原因有两点：</p><ol><li>可靠地终止TCP连接</li><li>保证让迟来的TCP报文段有足够的时间被识别并丢弃</li></ol><p>服务器程序可以通过设置socket选项<code>SO_REUSEADDR</code>来强制使用被处于<code>TIME_WAIT</code>状态的连接占用的socket地址。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置SO_REUSEADDR选项</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Socket::set_reuseaddr</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> flag = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">setsockopt</span>(m_sockfd, SOL_SOCKET, SO_REUSEADDR, &amp;flag, <span class="built_in">sizeof</span>(flag)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;Socket set_reuseaddr error: errno = %d errmsg = %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>经过<code>setsockopt()</code>的设置之后，即使sock处于<code>TIME_WAIT</code>状态，与之绑定的socket地址也可以立即被重用。此外，也可以通过修改内核参数<code>/proc/sys/net/ipv4/tcp_tw_recycle</code>来快速回收被关闭的socket，从而使得TCP连接根本就不进入<code>TIME_WAIT</code>状态，进而允许应用程序立即重用本地的socket地址。</p><p>Reference:</p><p><a href="https://zhuanlan.zhihu.com/p/79999012"> 网络编程：SO_REUSEADDR的使用 - 知乎</a></p><h2 id="socket完整封装">Socket完整封装</h2><p>前面简单封装的<code>Socket</code>类既可以作为服务端套接字使用，也可以作为客户端套接字来使用，为了方便用户清晰知道是使用服务端套接字还是客户端套接字，新增继承自<code>Socket</code>基类的两个派生类<code>ServerSocket</code>和<code>ClientSocket</code>。</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CMakeLists.txt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.19</span>)</span><br><span class="line"><span class="keyword">project</span>(socket)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD <span class="number">11</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">include_directories</span>(<span class="string">&quot;./&quot;</span>)</span><br><span class="line"><span class="keyword">file</span>(GLOB_RECURSE SOURCES <span class="string">&quot;utility/*.cpp&quot;</span> <span class="string">&quot;socket/*.cpp&quot;</span>)</span><br><span class="line"><span class="keyword">add_executable</span>(server1 <span class="variable">$&#123;SOURCES&#125;</span> server1.cpp)</span><br><span class="line"><span class="keyword">add_executable</span>(client1 <span class="variable">$&#123;SOURCES&#125;</span> client1.cpp)</span><br><span class="line"><span class="keyword">add_executable</span>(server2 <span class="variable">$&#123;SOURCES&#125;</span> server2.cpp)</span><br><span class="line"><span class="keyword">add_executable</span>(client2 <span class="variable">$&#123;SOURCES&#125;</span> client2.cpp)</span><br><span class="line"><span class="keyword">add_executable</span>(server3 <span class="variable">$&#123;SOURCES&#125;</span> server3.cpp)</span><br><span class="line"><span class="keyword">add_executable</span>(client3 <span class="variable">$&#123;SOURCES&#125;</span> client3.cpp)</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// socket/socket.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> std::string;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility/logger.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::utility;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> socket</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Socket</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">Socket</span>();</span><br><span class="line">            <span class="built_in">Socket</span>(<span class="type">int</span> sockfd);</span><br><span class="line">            <span class="keyword">virtual</span> ~<span class="built_in">Socket</span>();</span><br><span class="line">            <span class="comment">// 服务端绑定socket</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">bind</span><span class="params">(<span class="type">const</span> string &amp; ip, <span class="type">int</span> port)</span></span>;</span><br><span class="line">            <span class="comment">// 服务端监听socket</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">listen</span><span class="params">(<span class="type">int</span> backlog)</span></span>;</span><br><span class="line">            <span class="comment">// 客户端连接服务端</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">connect</span><span class="params">(<span class="type">const</span> string &amp; ip, <span class="type">int</span> port)</span></span>;</span><br><span class="line">            <span class="comment">// 服务端接受客户端连接，accept()返回与客户端连接的socket</span></span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">accept</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="comment">// 发送数据，返回发送多少个字节</span></span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">send</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * buf, <span class="type">int</span> len)</span></span>;</span><br><span class="line">            <span class="comment">// 接收数据</span></span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">recv</span><span class="params">(<span class="type">char</span> * buf, <span class="type">int</span> len)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">close</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="comment">// 将socket由默认的阻塞IO设置为非阻塞IO</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">set_non_blocking</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="comment">// 设置TCP发送缓冲区大小</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">set_send_buffer</span><span class="params">(<span class="type">int</span> size)</span></span>;</span><br><span class="line">            <span class="comment">// 设置TCP接收缓冲区大小</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">set_recv_buffer</span><span class="params">(<span class="type">int</span> size)</span></span>;</span><br><span class="line">            <span class="comment">// 设置SO_LINGER选项</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">set_linger</span><span class="params">(<span class="type">bool</span> active, <span class="type">int</span> seconds)</span></span>;</span><br><span class="line">            <span class="comment">// 设置SO_KEEPALIVE选项</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">set_keepalive</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="comment">// 设置SO_REUSEADDR选项</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">set_reuseaddr</span><span class="params">()</span></span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">protected</span>:</span><br><span class="line">            string m_ip;</span><br><span class="line">            <span class="type">int</span> m_port;</span><br><span class="line">            <span class="type">int</span> m_sockfd;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// socket/socket.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::socket;</span><br><span class="line"></span><br><span class="line">Socket::<span class="built_in">Socket</span>() : <span class="built_in">m_ip</span>(<span class="string">&quot;&quot;</span>), <span class="built_in">m_port</span>(<span class="number">0</span>), <span class="built_in">m_sockfd</span>(<span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    m_sockfd = ::<span class="built_in">socket</span>(AF_INET, SOCK_STREAM, IPPROTO_TCP);</span><br><span class="line">    <span class="keyword">if</span> (m_sockfd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;Create socket error:  errno = %d errmsg = %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">log_debug</span>(<span class="string">&quot;Create socket success!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Socket::<span class="built_in">Socket</span>(<span class="type">int</span> sockfd) : <span class="built_in">m_ip</span>(<span class="string">&quot;&quot;</span>), <span class="built_in">m_port</span>(<span class="number">0</span>), <span class="built_in">m_sockfd</span>(sockfd)</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Socket::~<span class="built_in">Socket</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">close</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Socket::bind</span><span class="params">(<span class="type">const</span> string &amp; ip, <span class="type">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> address;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;address, <span class="number">0</span>, <span class="built_in">sizeof</span>(address));</span><br><span class="line">    address.sin_family = AF_INET;</span><br><span class="line">    <span class="keyword">if</span> (ip.<span class="built_in">empty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 如果传入的IP地址为空，则绑定任意的本地网卡地址</span></span><br><span class="line">        address.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 调用inet_addr()将用点分十进制字符串表示的IPv4地址转化为用网络字节序整数表示的IPv4地址，它失败时返回INADDR_NONE</span></span><br><span class="line">        address.sin_addr.s_addr = <span class="built_in">inet_addr</span>(ip.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 调用htons()将16位(2字节)短整型端口数据从主机字节序转换为网络字节序(大端序)</span></span><br><span class="line">    address.sin_port = <span class="built_in">htons</span>(port);</span><br><span class="line">    <span class="keyword">if</span> (::<span class="built_in">bind</span>(m_sockfd, (<span class="keyword">struct</span> sockaddr *)&amp;address, <span class="built_in">sizeof</span>(address)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;Bind socket error: errno = %d errmsg = %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    m_ip = ip;</span><br><span class="line">    m_port = port;</span><br><span class="line">    <span class="built_in">log_debug</span>(<span class="string">&quot;Bind socket success: ip = %s port = %d&quot;</span>, ip.<span class="built_in">c_str</span>(), port);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Socket::listen</span><span class="params">(<span class="type">int</span> backlog)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (::<span class="built_in">listen</span>(m_sockfd, <span class="number">1024</span>) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;Socket listen error: errno = %d errmsg = %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">log_debug</span>(<span class="string">&quot;Socket listening...&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Socket::connect</span><span class="params">(<span class="type">const</span> string &amp; ip, <span class="type">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> address;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;address, <span class="number">0</span>, <span class="built_in">sizeof</span>(address));</span><br><span class="line">    address.sin_family = AF_INET;</span><br><span class="line">    address.sin_addr.s_addr = <span class="built_in">inet_addr</span>(ip.<span class="built_in">c_str</span>());</span><br><span class="line">    address.sin_port = <span class="built_in">htons</span>(port);</span><br><span class="line">    <span class="keyword">if</span> (::<span class="built_in">connect</span>(m_sockfd, (<span class="keyword">struct</span> sockaddr *)&amp;address, <span class="built_in">sizeof</span>(address)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;Socket connect error: errno = %d errmsg = %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    m_ip = ip;</span><br><span class="line">    m_port = port;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Socket::accept</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> connfd = ::<span class="built_in">accept</span>(m_sockfd, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="keyword">if</span> (connfd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;Socket accept error: errno = %d errmsg = %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">log_debug</span>(<span class="string">&quot;Socket accept: connfd = %d&quot;</span>, connfd);</span><br><span class="line">    <span class="keyword">return</span> connfd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Socket::send</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * buf, <span class="type">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ::<span class="built_in">send</span>(m_sockfd, buf, len, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Socket::recv</span><span class="params">(<span class="type">char</span> * buf, <span class="type">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ::<span class="built_in">recv</span>(m_sockfd, buf, len, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Socket::close</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_sockfd &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ::<span class="built_in">close</span>(m_sockfd);</span><br><span class="line">        m_sockfd = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Socket::set_non_blocking</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 先获取socket的标记</span></span><br><span class="line">    <span class="type">int</span> flags = <span class="built_in">fcntl</span>(m_sockfd, F_GETFL, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (flags &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;Socket set_non_blocking error: errno = %d errmsg=%s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    flags |= O_NONBLOCK;</span><br><span class="line">    <span class="comment">// 设置socket的标记位</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">fcntl</span>(m_sockfd, F_SETFL, flags) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;Socket set_non_blocking error: errno = %d errmsg=%s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Socket::set_send_buffer</span><span class="params">(<span class="type">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> buff_size = size;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">setsockopt</span>(m_sockfd, SOL_SOCKET, SO_SNDBUF, &amp;buff_size, <span class="built_in">sizeof</span>(buff_size)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;Socket set_send_buffer error: errno = %d errmsg = %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Socket::set_recv_buffer</span><span class="params">(<span class="type">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> buff_size = size;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">setsockopt</span>(m_sockfd, SOL_SOCKET, SO_RCVBUF, &amp;buff_size, <span class="built_in">sizeof</span>(buff_size)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;Socket set_recv_buffer error: errno = %d errmsg = %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Socket::set_linger</span><span class="params">(<span class="type">bool</span> active, <span class="type">int</span> seconds)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">linger</span> l;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;l, <span class="number">0</span>, <span class="built_in">sizeof</span>(l));</span><br><span class="line">    l.l_onoff = active ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">    l.l_linger = seconds;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">setsockopt</span>(m_sockfd, SOL_SOCKET, SO_LINGER, &amp;l, <span class="built_in">sizeof</span>(l)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;Socket set_linger error: errno = %d errmsg = %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Socket::set_keepalive</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> flag = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">setsockopt</span>(m_sockfd, SOL_SOCKET, SO_KEEPALIVE, &amp;flag, <span class="built_in">sizeof</span>(flag)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;Socket set_keepalive error: errno = %d errmsg = %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Socket::set_reuseaddr</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> flag = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">setsockopt</span>(m_sockfd, SOL_SOCKET, SO_REUSEADDR, &amp;flag, <span class="built_in">sizeof</span>(flag)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;Socket set_reuseaddr error: errno = %d errmsg = %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// socket/server_socket.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> socket</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">ServerSocket</span> : <span class="keyword">public</span> Socket</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">ServerSocket</span>() = <span class="keyword">delete</span>;</span><br><span class="line">            <span class="built_in">ServerSocket</span>(<span class="type">const</span> string &amp; ip, <span class="type">int</span> port);</span><br><span class="line">            ~<span class="built_in">ServerSocket</span>() = <span class="keyword">default</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// socket/server_socket.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/server_socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::socket;</span><br><span class="line"></span><br><span class="line">ServerSocket::<span class="built_in">ServerSocket</span>(<span class="type">const</span> string &amp; ip, <span class="type">int</span> port) : <span class="built_in">Socket</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 将socket设置为非阻塞</span></span><br><span class="line">    <span class="built_in">set_non_blocking</span>();</span><br><span class="line">    <span class="built_in">set_recv_buffer</span>(<span class="number">10</span> * <span class="number">1024</span>);</span><br><span class="line">    <span class="built_in">set_send_buffer</span>(<span class="number">10</span> * <span class="number">1024</span>);</span><br><span class="line">    <span class="built_in">set_linger</span>(<span class="literal">true</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">set_keepalive</span>();</span><br><span class="line">    <span class="built_in">set_reuseaddr</span>();</span><br><span class="line">    <span class="built_in">bind</span>(ip, port);</span><br><span class="line">    <span class="built_in">listen</span>(<span class="number">1024</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// socket/client_socket.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> socket</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">ClientSocket</span> : <span class="keyword">public</span> Socket</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">ClientSocket</span>() = <span class="keyword">delete</span>;</span><br><span class="line">            <span class="built_in">ClientSocket</span>(<span class="type">const</span> string &amp; ip, <span class="type">int</span> port);</span><br><span class="line">            ~<span class="built_in">ClientSocket</span>() = <span class="keyword">default</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// socket/client_socket.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/client_socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::socket;</span><br><span class="line"></span><br><span class="line">ClientSocket::<span class="built_in">ClientSocket</span>(<span class="type">const</span> string &amp; ip, <span class="type">int</span> port)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">connect</span>(ip, port);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// server3.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/server_socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::socket;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Singleton&lt;Logger&gt;::<span class="built_in">instance</span>()-&gt;<span class="built_in">open</span>(<span class="string">&quot;./server.log&quot;</span>);</span><br><span class="line">    <span class="function">ServerSocket <span class="title">server</span><span class="params">(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8080</span>)</span></span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> connfd = server.<span class="built_in">accept</span>();</span><br><span class="line">        <span class="keyword">if</span> (connfd &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function">Socket <span class="title">client</span><span class="params">(connfd)</span></span>;</span><br><span class="line">        <span class="type">char</span> buf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        <span class="type">size_t</span> len = client.<span class="built_in">recv</span>(buf, <span class="built_in">sizeof</span>(buf));</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Recv: connfd = %d msg = %s\n&quot;</span>, connfd, buf);</span><br><span class="line">        client.<span class="built_in">send</span>(buf, len);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 基类Socket析构函数中会调用close()</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// client3.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;socket/client_socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::socket;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Singleton&lt;Logger&gt;::<span class="built_in">instance</span>()-&gt;<span class="built_in">open</span>(<span class="string">&quot;./client.log&quot;</span>);</span><br><span class="line">    <span class="function">ClientSocket <span class="title">client</span><span class="params">(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8080</span>)</span></span>;</span><br><span class="line">    string data = <span class="string">&quot;hello world&quot;</span>;</span><br><span class="line">    client.<span class="built_in">send</span>(data.<span class="built_in">c_str</span>(), data.<span class="built_in">size</span>());</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    client.<span class="built_in">recv</span>(buf, <span class="built_in">sizeof</span>(buf));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Recv: %s\n&quot;</span>, buf);</span><br><span class="line">    <span class="comment">// 基类Socket析构函数中会调用close()</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="io多路复用">IO多路复用</h2><p>在多路复用IO模型中，socket首先会被设置为非阻塞模式，会有一个专门的线程不断去轮询多个socket的状态，只有当socket真正有读写事件时，才真正调用实际的IO读写操作。IO多路复用的优势在于可以处理大量并发IO，而不用消耗太多CPU和内存。</p><p>三种常用的IO多路复用方法：select、poll和epoll。</p>]]></content>
      
      
      
        <tags>
            
            <tag> C++后端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>C++调用Python接口</title>
      <link href="/2024/07/28/C-%E8%B0%83%E7%94%A8Python%E6%8E%A5%E5%8F%A3/"/>
      <url>/2024/07/28/C-%E8%B0%83%E7%94%A8Python%E6%8E%A5%E5%8F%A3/</url>
      
        <content type="html"><![CDATA[<h1 id="c-调python脚本">C++调Python脚本</h1><h2 id="环境搭建">环境搭建</h2><p>在C++中，库可以编译为静态库或动态库并提供头文件给调用方，如此外部就可以调用相关函数使用其相关功能。而C++调用Python的原理其实就是将Python当成一个库来调用的。</p><p>需要先检查当前环境是否安装了Python，并确定Python目录下是否已经包含了头文件和库文件。</p><p>Linux系统中Python3可执行文件的具体路径：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">which</span> python3</span></span><br><span class="line">/usr/bin/python3</span><br></pre></td></tr></table></figure><h3 id="包含头文件">包含头文件</h3><p>查询Python头文件<code>Python.h</code>的具体路径：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">python3 -c <span class="string">&quot;import sysconfig; print(sysconfig.get_path(&#x27;include&#x27;))&quot;</span></span></span><br><span class="line">/usr/include/python3.12</span><br></pre></td></tr></table></figure><h3 id="包含库文件">包含库文件</h3><p>查询Python库文件<code>libpython3.12.so</code>的具体路径：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看库目录</span></span><br><span class="line">python3 -c &quot;import sysconfig; print(sysconfig.get_config_var(&#x27;LIBDIR&#x27;))&quot;</span><br><span class="line">/usr/lib/x86_64-linux-gnu</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看动态库文件名</span></span><br><span class="line">python3 -c &quot;import sysconfig; print(sysconfig.get_config_var(&#x27;LDLIBRARY&#x27;))&quot;</span><br><span class="line">libpython3.12.so</span><br></pre></td></tr></table></figure><h3 id="c-执行python语句">C++执行Python语句</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CMakeLists.txt</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cmake_minimum_required</span>(VERSION <span class="number">3.19</span>)</span><br><span class="line"><span class="built_in">project</span>(python)</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(CMAKE_CXX_STANDARD <span class="number">11</span>)</span><br><span class="line"><span class="built_in">file</span>(GLOB_RECURSE SOURCES <span class="string">&quot;utility/*.cpp&quot;</span>)</span><br><span class="line"><span class="built_in">add_executable</span>(main $&#123;SOURCES&#125; main.cpp)</span><br><span class="line"><span class="built_in">target_include_directories</span>(main PRIVATE <span class="string">&quot;/usr/include/python3.12&quot;</span>)</span><br><span class="line"><span class="built_in">target_link_libraries</span>(main PRIVATE <span class="string">&quot;/usr/lib/x86_64-linux-gnu/libpython3.12.so&quot;</span>)</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Python.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 初始化</span></span><br><span class="line">    <span class="built_in">Py_Initialize</span>();</span><br><span class="line">    <span class="comment">// 执行Python语句</span></span><br><span class="line">    <span class="built_in">PyRun_SimpleString</span>(<span class="string">&quot;import sys&quot;</span>);</span><br><span class="line">    <span class="built_in">PyRun_SimpleString</span>(<span class="string">&quot;print(&#x27;hello python&#x27;)&quot;</span>);</span><br><span class="line">    <span class="comment">// 释放资源</span></span><br><span class="line">    <span class="built_in">Py_Finalize</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">rm</span> -rf ./build &amp;&amp; cmake -S . -B build &amp;&amp; cmake --build build</span></span><br><span class="line">-- The C compiler identification is GNU 13.3.0</span><br><span class="line">-- The CXX compiler identification is GNU 13.3.0</span><br><span class="line">-- Detecting C compiler ABI info</span><br><span class="line">-- Detecting C compiler ABI info - done</span><br><span class="line">-- Check for working C compiler: /usr/bin/cc - skipped</span><br><span class="line">-- Detecting C compile features</span><br><span class="line">-- Detecting C compile features - done</span><br><span class="line">-- Detecting CXX compiler ABI info</span><br><span class="line">-- Detecting CXX compiler ABI info - done</span><br><span class="line">-- Check for working CXX compiler: /usr/bin/c++ - skipped</span><br><span class="line">-- Detecting CXX compile features</span><br><span class="line">-- Detecting CXX compile features - done</span><br><span class="line">-- Configuring done (1.2s)</span><br><span class="line">-- Generating done (0.0s)</span><br><span class="line">-- Build files have been written to: /home/zhanghua/Back-End/Basic/python/build</span><br><span class="line">[ 50%] Building CXX object CMakeFiles/main.dir/main.cpp.o</span><br><span class="line"><span class="meta prompt_">[100%</span><span class="language-bash">] Linking CXX executable main</span></span><br><span class="line"><span class="meta prompt_">[100%</span><span class="language-bash">] Built target main</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./build/main</span> </span><br><span class="line">hello python</span><br></pre></td></tr></table></figure><p>如此，头文件正确引入，库文件正确链接，控制台最后输出<code>hello python</code>，表明程序通过Python的C API正确简单地执行了Python语句。</p><h2 id="python-c-api调用体验">Python C API调用体验</h2><h3 id="c-调用python无参函数">C++调用Python无参函数</h3><p>创建一个Python脚本：<code>./script/test1.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># script/test1.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">say</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;hello python&quot;</span>)</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Python.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 1.初始化Python解释器</span></span><br><span class="line">    <span class="built_in">Py_Initialize</span>();</span><br><span class="line">    <span class="comment">// 检查初始化是否成功</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">Py_IsInitialized</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Python init failed&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.导入sys模块</span></span><br><span class="line">    <span class="built_in">PyRun_SimpleString</span>(<span class="string">&quot;import sys&quot;</span>);</span><br><span class="line">    <span class="comment">// 将./script目录添加至Python的模块搜索路径中</span></span><br><span class="line">    <span class="built_in">PyRun_SimpleString</span>(<span class="string">&quot;sys.path.append(&#x27;./script&#x27;)&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.导入test1模块</span></span><br><span class="line">    PyObject * <span class="keyword">module</span> = <span class="built_in">PyImport_ImportModule</span>(<span class="string">&quot;test1&quot;</span>);</span><br><span class="line">    <span class="comment">// 检查test1模块是否导入成功</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">module</span> == <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Module not found: test1.py&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4.从模块中获取名为say的属性(函数)</span></span><br><span class="line">    PyObject * func = <span class="built_in">PyObject_GetAttrString</span>(<span class="keyword">module</span>, <span class="string">&quot;say&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (func == <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Function not found: say&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 检查获取的对象是否为可调用(确实为函数)</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">PyCallable_Check</span>(func))</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Function not callable&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5.调用Python函数，nullptr表示没有参数传递</span></span><br><span class="line">    <span class="built_in">PyObject_CallObject</span>(func, <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6.关闭Python解释器，释放所有相关资源</span></span><br><span class="line">    <span class="built_in">Py_Finalize</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>小结一下，C++调用Python无参函数流程大致如下：</p><ol><li>初始化Python接口(<code>Py_Initialize</code>)</li><li>初始化Python系统文件路径(<code>PyRun_SimpleString</code>)</li><li>调用Python文件名(<code>PyImport_ImportModule</code>)</li><li>获取函数对象(<code>PyObject_GetAttrString</code>)</li><li>调用函数对象(<code>PyObject_CallObject</code>)</li><li>解释Python接口调用，释放资源(<code>Py_Finalize</code>)</li></ol><h3 id="c-调用python有参函数">C++调用Python有参函数</h3><p>创建一个Python脚本：<code>./script/test2.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># script/test2.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">a, b</span>):</span><br><span class="line">    c = a + b</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;a&#125;</span> + <span class="subst">&#123;b&#125;</span> = <span class="subst">&#123;c&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> c</span><br></pre></td></tr></table></figure><p>调用Python函数如果有参数，则需要创建元组进行传递。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Python.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 1.初始化Python解释器</span></span><br><span class="line">    <span class="built_in">Py_Initialize</span>();</span><br><span class="line">    <span class="comment">// 检查初始化是否成功</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">Py_IsInitialized</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Python init failed&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.配置Python模块搜索路径</span></span><br><span class="line">    <span class="built_in">PyRun_SimpleString</span>(<span class="string">&quot;import sys&quot;</span>);</span><br><span class="line">    <span class="comment">// 将./script目录添加至Python的模块搜索路径中</span></span><br><span class="line">    <span class="built_in">PyRun_SimpleString</span>(<span class="string">&quot;sys.path.append(&#x27;./script&#x27;)&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.导入test2模块</span></span><br><span class="line">    PyObject * <span class="keyword">module</span> = <span class="built_in">PyImport_ImportModule</span>(<span class="string">&quot;test2&quot;</span>);</span><br><span class="line">    <span class="comment">// 检查test2模块是否导入成功</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">module</span> == <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Module not found: test2.py&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4.从模块中获取名为add的属性(函数)</span></span><br><span class="line">    PyObject * func = <span class="built_in">PyObject_GetAttrString</span>(<span class="keyword">module</span>, <span class="string">&quot;add&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (func == <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Function not found: add&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 检查获取的对象是否为可调用(确实为函数)</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">PyCallable_Check</span>(func))</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Function not callable&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5.准备参数</span></span><br><span class="line">    <span class="comment">// 创建包含2个元素的参数元组</span></span><br><span class="line">    PyObject * args = <span class="built_in">PyTuple_New</span>(<span class="number">2</span>);</span><br><span class="line">    <span class="comment">// 第一个参数传入的是int类型，参数值为1</span></span><br><span class="line">    <span class="comment">// Py_BuildValue(&quot;i&quot;, 1)将整数1转换为Python对象</span></span><br><span class="line">    <span class="built_in">PyTuple_SetItem</span>(args, <span class="number">0</span>, <span class="built_in">Py_BuildValue</span>(<span class="string">&quot;i&quot;</span>, <span class="number">1</span>));</span><br><span class="line">    <span class="comment">// 第二个参数传入的是int类型，参数值为2</span></span><br><span class="line">    <span class="comment">// Py_BuildValue(&quot;i&quot;, 1)将整数2转换为Python对象</span></span><br><span class="line">    <span class="built_in">PyTuple_SetItem</span>(args, <span class="number">1</span>, <span class="built_in">Py_BuildValue</span>(<span class="string">&quot;i&quot;</span>, <span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6.调用Python函数并传入参数</span></span><br><span class="line">    PyObject * ret = <span class="built_in">PyObject_CallObject</span>(func, args);</span><br><span class="line">    <span class="comment">// 7.处理函数返回值</span></span><br><span class="line">    <span class="type">int</span> result = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 将Python返回值解析为C++的int类型</span></span><br><span class="line">    <span class="built_in">PyArg_Parse</span>(ret, <span class="string">&quot;i&quot;</span>, &amp;result);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Return is &quot;</span> &lt;&lt; result &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 8.关闭Python解释器，释放所有相关资源</span></span><br><span class="line">    <span class="built_in">Py_Finalize</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>小结一下，C++调用Python有参函数流程大致如下：</p><ol><li>初始化Python接口(<code>Py_Initialize</code>)</li><li>初始化Python系统文件路径(<code>PyRun_SimpleString</code>)</li><li>调用Python文件名(<code>PyImport_ImportModule</code>)</li><li>获取函数对象(<code>PyObject_GetAttrString</code>)</li><li>传递参数(<code>PyTuple_New, Py_BuildValue</code>)</li><li>调用函数对象(<code>PyObject_CallObject</code>)</li><li>接收函数返回值(<code>PyArg_Parse</code>)</li><li>解释Python接口调用，释放资源(<code>Py_Finalize</code>)</li></ol><h3 id="c-调用python类">C++调用Python类</h3><p>创建一个Python脚本：<code>./script/test3.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># script/test3.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, age</span>):</span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">foo</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;My name is <span class="subst">&#123;self.name&#125;</span>, my age is <span class="subst">&#123;self.age&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Python.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 1.初始化Python解释器</span></span><br><span class="line">    <span class="built_in">Py_Initialize</span>();</span><br><span class="line">    <span class="comment">// 检查初始化是否成功</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">Py_IsInitialized</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Python init failed&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2.配置Python模块搜索路径</span></span><br><span class="line">    <span class="built_in">PyRun_SimpleString</span>(<span class="string">&quot;import sys&quot;</span>);</span><br><span class="line">    <span class="comment">// 将./script目录添加至Python的模块搜索路径中</span></span><br><span class="line">    <span class="built_in">PyRun_SimpleString</span>(<span class="string">&quot;sys.path.append(&#x27;./script&#x27;)&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.导入test3模块</span></span><br><span class="line">    PyObject * <span class="keyword">module</span> = <span class="built_in">PyImport_ImportModule</span>(<span class="string">&quot;test3&quot;</span>);</span><br><span class="line">    <span class="comment">// 检查test3模块是否导入成功</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">module</span> == <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Module not found: test3.py&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4.从模块中获取类</span></span><br><span class="line">    PyObject * cls = <span class="built_in">PyObject_GetAttrString</span>(<span class="keyword">module</span>, <span class="string">&quot;Person&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (cls == <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Class not found: Person&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5.根据类构造函数准备参数</span></span><br><span class="line">    <span class="comment">// 创建包含2个元素的参数元组</span></span><br><span class="line">    PyObject * args = <span class="built_in">PyTuple_New</span>(<span class="number">2</span>);</span><br><span class="line">    <span class="comment">// 第一个参数传入的是字符串类型，参数值为&quot;jack&quot;</span></span><br><span class="line">    <span class="comment">// Py_BuildValue(&quot;s&quot;, &quot;jack&quot;)将字符串&quot;jack&quot;转换为Python对象</span></span><br><span class="line">    <span class="built_in">PyTuple_SetItem</span>(args, <span class="number">0</span>, <span class="built_in">Py_BuildValue</span>(<span class="string">&quot;s&quot;</span>, <span class="string">&quot;jack&quot;</span>));</span><br><span class="line">    <span class="comment">// 第二个参数传入的是int类型，参数值为18</span></span><br><span class="line">    <span class="comment">// Py_BuildValue(&quot;i&quot;, 18)将整数18转换为Python对象</span></span><br><span class="line">    <span class="built_in">PyTuple_SetItem</span>(args, <span class="number">1</span>, <span class="built_in">Py_BuildValue</span>(<span class="string">&quot;i&quot;</span>, <span class="number">18</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6.创建类的实例</span></span><br><span class="line">    <span class="comment">// PyObject * obj = PyEval_CallObject(cls, args);</span></span><br><span class="line">    PyObject * obj = <span class="built_in">PyObject_CallObject</span>(cls, args);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 7.根据实例获取其成员函数foo</span></span><br><span class="line">    PyObject * func = <span class="built_in">PyObject_GetAttrString</span>(obj, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (func == <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;function not found: foo&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">PyCallable_Check</span>(func))</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Not a callable object&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 8.调用成员函数foo</span></span><br><span class="line">    <span class="built_in">PyObject_CallObject</span>(func, <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 9.关闭Python解释器，释放所有相关资源</span></span><br><span class="line">    <span class="built_in">Py_Finalize</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>C++调用Python类的流程如下：</p><ol><li><p>初始化Python接口(<code>Py_Initialize</code>)</p></li><li><p>初始化Python系统文件路径(<code>PyRun_SimpleString</code>)</p></li><li><p>调用Python文件名(<code>PyImport_ImportModule</code>)</p></li><li><p>获取类(<code>PyObject_GetAttrString</code>)</p><p>在Python眼中，函数、类和变量都是属性</p></li><li><p>根据类构造函数实例化对象(<code>PyEval_CallObject</code>)</p></li><li><p>获取实例的函数对象(<code>PyObject_GetAttrString</code>)</p></li><li><p>传递参数(<code>PyTuple_New</code>，<code>Py_BuildValue</code>)</p></li><li><p>调用函数对象(<code>PyObject_CallObject</code>)</p></li><li><p>接收函数返回值(<code>PyArg_Parse</code>)</p></li><li><p>结束Python接口初始化(<code>Py_Finalize</code>)</p></li></ol><h2 id="封装实现">封装实现</h2><p>整体实现的架构如下：</p><p><img src="https://aliyun-oss-zh.oss-cn-beijing.aliyuncs.com/img/%25E6%2595%25B4%25E4%25BD%2593%25E6%259E%25B6%25E6%259E%2584.jpg" alt=""></p><p><code>module</code>模块表示一个Python文件，Python文件中会有一些类，用<code>class</code>来封装，通过<code>object</code>来封装类的实例化。函数通过<code>function</code>来封装，参数通过<code>argument</code>来封装。</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CMakeLists.txt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.19</span>)</span><br><span class="line"><span class="keyword">project</span>(python)</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD <span class="number">11</span>)</span><br><span class="line"><span class="keyword">file</span>(GLOB_RECURSE SOURCES <span class="string">&quot;py/*.cpp&quot;</span>)</span><br><span class="line"><span class="keyword">add_executable</span>(main <span class="variable">$&#123;SOURCES&#125;</span> main.cpp)</span><br><span class="line"><span class="keyword">target_include_directories</span>(main PRIVATE <span class="string">&quot;./&quot;</span>)</span><br><span class="line"><span class="keyword">target_include_directories</span>(main PRIVATE <span class="string">&quot;/usr/include/python3.12&quot;</span>)</span><br><span class="line"><span class="keyword">target_link_libraries</span>(main PRIVATE <span class="string">&quot;/usr/lib/x86_64-linux-gnu/libpython3.12.so&quot;</span>)</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// py/python.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdexcept&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Python.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;py/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;py/function.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;py/class.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;py/object.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;py/argument.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> std::string;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> py</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Python</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">Python</span>();</span><br><span class="line">            ~<span class="built_in">Python</span>();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 执行Python语句</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">run</span><span class="params">(<span class="type">const</span> string &amp; str)</span></span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// py/python.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;py/python.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::py;</span><br><span class="line"></span><br><span class="line">Python::<span class="built_in">Python</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 初始化Python接口</span></span><br><span class="line">    <span class="built_in">Py_Initialize</span>();</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">Py_IsInitialized</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;Python init failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Python::~<span class="built_in">Python</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 结束Python接口调用，释放资源</span></span><br><span class="line">    <span class="built_in">Py_Finalize</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Python::run</span><span class="params">(<span class="type">const</span> string &amp; str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">PyRun_SimpleString</span>(str.<span class="built_in">c_str</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// py/module.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdexcept&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Python.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> std::string;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> py</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Module</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">Function</span>;</span><br><span class="line">            <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">Class</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">Module</span>() = <span class="keyword">default</span>;</span><br><span class="line">            <span class="built_in">Module</span>(<span class="type">const</span> string &amp; name);                <span class="comment">// 传入模块名称</span></span><br><span class="line">            ~<span class="built_in">Module</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">import</span><span class="params">(<span class="type">const</span> string &amp; name)</span></span>;           <span class="comment">// 从模块中导入</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            PyObject * m_module = <span class="literal">nullptr</span>;;             <span class="comment">// 保存模块对象，便于后续获取模块中的函数</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// py/module.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;py/module.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::py;</span><br><span class="line"></span><br><span class="line">Module::<span class="built_in">Module</span>(<span class="type">const</span> string &amp; name)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">import</span>(name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Module::import</span><span class="params">(<span class="type">const</span> string &amp; name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 导入用户自定义的模块</span></span><br><span class="line">    PyObject * <span class="keyword">module</span> = <span class="built_in">PyImport_ImportModule</span>(name.<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">module</span> == <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;Module not found: &quot;</span> + name);</span><br><span class="line">    &#125;</span><br><span class="line">    m_module = <span class="keyword">module</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// py/function.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdexcept&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;py/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;py/argument.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;py/object.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Python.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> std::string;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> py</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Function</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">Function</span>() = <span class="keyword">default</span>;</span><br><span class="line">            <span class="comment">// 根据属性名称name从模块module中构造Function</span></span><br><span class="line">            <span class="built_in">Function</span>(<span class="type">const</span> Module &amp; <span class="keyword">module</span>, <span class="type">const</span> string &amp; name);</span><br><span class="line">            <span class="comment">// 根据属性名称name从实例对象object中构造Function</span></span><br><span class="line">            <span class="built_in">Function</span>(<span class="type">const</span> Object &amp; object, <span class="type">const</span> string &amp; name);</span><br><span class="line">            ~<span class="built_in">Function</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 调用无参无返回值函数</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">call</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 调用无参有返回值函数</span></span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> R&gt;</span><br><span class="line">            <span class="function">R <span class="title">call</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 调用参数可变且有返回值的函数，这样支持任意参数的传递</span></span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> R, <span class="keyword">typename</span> ...Args&gt;</span><br><span class="line">            <span class="function">R <span class="title">call</span><span class="params">(Args... args)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="comment">// 从模块中取出的函数对象</span></span><br><span class="line">            PyObject * m_func = <span class="literal">nullptr</span>;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> R&gt;</span><br><span class="line">        <span class="function">R <span class="title">Function::call</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="comment">// 调用无参有返回值函数</span></span><br><span class="line">            PyObject * ret = <span class="built_in">PyObject_CallObject</span>(m_func, <span class="literal">nullptr</span>);</span><br><span class="line">            Argument arg;</span><br><span class="line">            <span class="keyword">return</span> arg.<span class="built_in">parse_result</span>&lt;R&gt;(ret);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> R, <span class="keyword">typename</span> ...Args&gt;</span><br><span class="line">        <span class="function">R <span class="title">Function::call</span><span class="params">(Args... args)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            Argument arg;</span><br><span class="line">            arg.<span class="built_in">bind</span>(args...);</span><br><span class="line">            PyObject * ret = <span class="built_in">PyObject_CallObject</span>(m_func, arg.m_args);</span><br><span class="line">            <span class="keyword">return</span> arg.<span class="built_in">parse_result</span>&lt;R&gt;(ret);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// py/function.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;py/function.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::py;</span><br><span class="line"></span><br><span class="line">Function::<span class="built_in">Function</span>(<span class="type">const</span> Module &amp; <span class="keyword">module</span>, <span class="type">const</span> string &amp; name) : <span class="built_in">m_func</span>(<span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 获取函数对象</span></span><br><span class="line">    PyObject * func = <span class="built_in">PyObject_GetAttrString</span>(<span class="keyword">module</span>.m_module, name.<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="keyword">if</span> (func == <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;Function not found: &quot;</span> + name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">PyCallable_Check</span>(func))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;Object not callable: &quot;</span> + name);</span><br><span class="line">    &#125;</span><br><span class="line">    m_func = func;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Function::<span class="built_in">Function</span>(<span class="type">const</span> Object &amp; object, <span class="type">const</span> string &amp; name)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 获取函数对象</span></span><br><span class="line">    PyObject * func = <span class="built_in">PyObject_GetAttrString</span>(object.m_object, name.<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="keyword">if</span> (func == <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;Function not found: &quot;</span> + name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">PyCallable_Check</span>(func))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;Object not callable: &quot;</span> + name);</span><br><span class="line">    &#125;</span><br><span class="line">    m_func = func;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Function::call</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 调用函数</span></span><br><span class="line">    <span class="built_in">PyObject_CallObject</span>(m_func, <span class="literal">nullptr</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// py/argument.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Python.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> std::string;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> py</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Argument</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">Function</span>;</span><br><span class="line">            <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">Object</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">Argument</span>() = <span class="keyword">default</span>;</span><br><span class="line">            ~<span class="built_in">Argument</span>() = <span class="keyword">default</span>;</span><br><span class="line">        </span><br><span class="line">            <span class="comment">// 可变参数的绑定，这里使用可变参数模板函数</span></span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> ...Args&gt;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">bind</span><span class="params">(Args... args)</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 函数返回值的提取</span></span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> R&gt;</span><br><span class="line">            <span class="function">R <span class="title">parse_result</span><span class="params">(PyObject * ret)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="comment">// 参数展开，递归调用</span></span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> ...Args&gt;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">bind_inner</span><span class="params">(T arg, Args... args)</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 参数展开，当递归调用到最后需要提供一个结尾</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">bind_inner</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 根据参数类型获取对应标记，比如整数是&quot;i&quot;，字符串是&quot;s&quot;</span></span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">            <span class="function">string <span class="title">data_flag</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="comment">// 参数是一个元组，保存在一个PyObject中</span></span><br><span class="line">            PyObject * m_args = <span class="literal">nullptr</span>;</span><br><span class="line">            <span class="comment">// 参数个数</span></span><br><span class="line">            <span class="type">int</span> m_num = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// 当前处理的参数位置</span></span><br><span class="line">            <span class="type">int</span> m_pos = <span class="number">0</span>;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> ...Args&gt;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">Argument::bind</span><span class="params">(Args... args)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            m_num = <span class="keyword">sizeof</span>...(Args);</span><br><span class="line">            m_pos = <span class="number">0</span>;</span><br><span class="line">            m_args = <span class="built_in">PyTuple_New</span>(m_num);</span><br><span class="line">            <span class="comment">// 对参数展开</span></span><br><span class="line">            <span class="built_in">bind_inner</span>(args...);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> R&gt;</span><br><span class="line">        <span class="function">R <span class="title">Argument::parse_result</span><span class="params">(PyObject * ret)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            R result;</span><br><span class="line">            string flag = <span class="built_in">data_flag</span>&lt;R&gt;();</span><br><span class="line">            <span class="built_in">PyArg_Parse</span>(ret, flag.<span class="built_in">c_str</span>(), &amp;result);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> ...Args&gt;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">Argument::bind_inner</span><span class="params">(T arg, Args... args)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="comment">// 根据参数类型获取对应标记，比如整数是&quot;i&quot;，字符串是&quot;s&quot;</span></span><br><span class="line">            string flag = <span class="built_in">data_flag</span>&lt;T&gt;();</span><br><span class="line">            PyObject * val = <span class="built_in">Py_BuildValue</span>(flag.<span class="built_in">c_str</span>(), arg);</span><br><span class="line">            <span class="built_in">PyTuple_SetItem</span>(m_args, m_pos++, val);</span><br><span class="line">            <span class="comment">// 递归处理剩下的可变参数</span></span><br><span class="line">            <span class="built_in">bind_inner</span>(args...);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="function">string <span class="title">Argument::data_flag</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            string flag;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">typeid</span>(T) == <span class="built_in">typeid</span>(<span class="type">bool</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                flag = <span class="string">&quot;b&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">typeid</span>(T) == <span class="built_in">typeid</span>(<span class="type">int</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                flag = <span class="string">&quot;i&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">typeid</span>(T) == <span class="built_in">typeid</span>(<span class="type">unsigned</span> <span class="type">int</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                flag = <span class="string">&quot;I&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">typeid</span>(T) == <span class="built_in">typeid</span>(<span class="type">float</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                flag = <span class="string">&quot;f&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">typeid</span>(T) == <span class="built_in">typeid</span>(<span class="type">double</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                flag = <span class="string">&quot;d&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">typeid</span>(T) == <span class="built_in">typeid</span>(<span class="type">const</span> <span class="type">char</span> *))</span><br><span class="line">            &#123;</span><br><span class="line">                flag = <span class="string">&quot;s&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> flag;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// py/class.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdexcept&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;py/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Python.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> std::string;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> py</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Class</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">Object</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">Class</span>() = <span class="keyword">default</span>;</span><br><span class="line">            <span class="comment">// 从模块中获取类</span></span><br><span class="line">            <span class="built_in">Class</span>(<span class="type">const</span> Module &amp; <span class="keyword">module</span>, <span class="type">const</span> string &amp; name);</span><br><span class="line">            ~<span class="built_in">Class</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            PyObject * m_class;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// py/class.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;py/class.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::py;</span><br><span class="line"></span><br><span class="line">Class::<span class="built_in">Class</span>(<span class="type">const</span> Module &amp; <span class="keyword">module</span>, <span class="type">const</span> string &amp; name)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 获取类对象</span></span><br><span class="line">    PyObject * cls = <span class="built_in">PyObject_GetAttrString</span>(<span class="keyword">module</span>.m_module, name.<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="keyword">if</span> (cls == <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;Class not found: &quot;</span> + name);</span><br><span class="line">    &#125;</span><br><span class="line">    m_class = cls;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// py/object.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;py/class.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;py/argument.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Python.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> py</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 由Object来封装类的实例</span></span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Object</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">Function</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">Object</span>() = <span class="keyword">default</span>;</span><br><span class="line">            <span class="comment">// 创建类实例时不需要参数的构造函数</span></span><br><span class="line">            <span class="built_in">Object</span>(<span class="type">const</span> Class &amp; cls);</span><br><span class="line">            <span class="comment">// 创建类实例时需要参数的构造函数</span></span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span>... Args&gt;</span><br><span class="line">            <span class="built_in">Object</span>(<span class="type">const</span> Class &amp; cls, Args... args);</span><br><span class="line">            ~<span class="built_in">Object</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            PyObject * m_object = <span class="literal">nullptr</span>;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span>... Args&gt;</span><br><span class="line">        Object::<span class="built_in">Object</span>(<span class="type">const</span> Class &amp; cls, Args... args)</span><br><span class="line">        &#123;</span><br><span class="line">            Argument arg;</span><br><span class="line">            arg.<span class="built_in">bind</span>(args...);</span><br><span class="line">            m_object = <span class="built_in">PyObject_CallObject</span>(cls.m_class, arg.m_args);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// py/object.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;py/object.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::py;</span><br><span class="line"></span><br><span class="line">Object::<span class="built_in">Object</span>(<span class="type">const</span> Class &amp; cls)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 根据类名来实例化一个对象</span></span><br><span class="line">    m_object = <span class="built_in">PyObject_CallObject</span>(cls.m_class, <span class="literal">nullptr</span>); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;py/python.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::py;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> py = <span class="built_in">Python</span>();</span><br><span class="line">    py.<span class="built_in">run</span>(<span class="string">&quot;import sys&quot;</span>);</span><br><span class="line">    py.<span class="built_in">run</span>(<span class="string">&quot;sys.path.append(&#x27;./script&#x27;)&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">Module <span class="title">module</span><span class="params">(<span class="string">&quot;test3&quot;</span>)</span></span>;</span><br><span class="line">        <span class="function">Class <span class="title">cls</span><span class="params">(<span class="keyword">module</span>, <span class="string">&quot;Person&quot;</span>)</span></span>;</span><br><span class="line">        <span class="function">Object <span class="title">obj</span><span class="params">(cls, <span class="string">&quot;jack&quot;</span>, <span class="number">20</span>)</span></span>;</span><br><span class="line">        <span class="function">Function <span class="title">func</span><span class="params">(obj, <span class="string">&quot;foo&quot;</span>)</span></span>;</span><br><span class="line">        <span class="type">int</span> result = func.<span class="built_in">call</span>&lt;<span class="type">int</span>&gt;();</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Return is &quot;</span> &lt;&lt; result &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">catch</span>(<span class="type">const</span> std::exception&amp; e)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; e.<span class="built_in">what</span>() &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># script/test1.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">say</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;hello python&quot;</span>)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># script/test2.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">a, b</span>):</span><br><span class="line">    c = a + b</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;a&#125;</span> + <span class="subst">&#123;b&#125;</span> = <span class="subst">&#123;c&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> c</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># script/test3.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, age</span>):</span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">foo</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;My name is <span class="subst">&#123;self.name&#125;</span>, my age is <span class="subst">&#123;self.age&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">rm</span> -rf ./build &amp;&amp; cmake -S . -B build &amp;&amp; cmake --build build</span></span><br><span class="line">......</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./build/main</span> </span><br><span class="line">My name is jack, my age is 20</span><br><span class="line">Return is 0</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> C++后端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>文件目录操作</title>
      <link href="/2024/07/12/%E6%96%87%E4%BB%B6%E7%9B%AE%E5%BD%95%E6%93%8D%E4%BD%9C/"/>
      <url>/2024/07/12/%E6%96%87%E4%BB%B6%E7%9B%AE%E5%BD%95%E6%93%8D%E4%BD%9C/</url>
      
        <content type="html"><![CDATA[<h1 id="c-文件目录操作">C++文件目录操作</h1><h2 id="文件常用操作">文件常用操作</h2><p><code>File</code>类支持以下文件常用操作：</p><table><thead><tr><th style="text-align:center">成员函数</th><th style="text-align:center">描述</th></tr></thead><tbody><tr><td style="text-align:center">path</td><td style="text-align:center">获取文件名</td></tr><tr><td style="text-align:center">dir</td><td style="text-align:center">获取文件所在目录</td></tr><tr><td style="text-align:center">create</td><td style="text-align:center">创建文件</td></tr><tr><td style="text-align:center">remove</td><td style="text-align:center">删除文件</td></tr><tr><td style="text-align:center">copy</td><td style="text-align:center">复制文件</td></tr><tr><td style="text-align:center">rename</td><td style="text-align:center">文件重命名(移动文件)</td></tr><tr><td style="text-align:center">exists</td><td style="text-align:center">判断文件是否存在</td></tr><tr><td style="text-align:center">clear</td><td style="text-align:center">清空文件内容</td></tr><tr><td style="text-align:center">line</td><td style="text-align:center">获取文件行数</td></tr><tr><td style="text-align:center">size</td><td style="text-align:center">获取文件大小</td></tr><tr><td style="text-align:center">time</td><td style="text-align:center">获取文件最后修改时间</td></tr><tr><td style="text-align:center">read</td><td style="text-align:center">一次性读取文件全部内容</td></tr><tr><td style="text-align:center">write</td><td style="text-align:center">一次性写入文件</td></tr></tbody></table><h3 id="获取文件名">获取文件名</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">string <span class="title">File::path</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_path;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="获取文件所在目录">获取文件所在目录</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">string <span class="title">File::dir</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_path.<span class="built_in">empty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">char</span> sep = Directory::<span class="built_in">separator</span>();</span><br><span class="line">    <span class="type">size_t</span> last = m_path.<span class="built_in">find_last_of</span>(sep);</span><br><span class="line">    <span class="keyword">if</span> (last != std::string::npos)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> m_path.<span class="built_in">substr</span>(<span class="number">0</span>, last);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="创建一个空文件">创建一个空文件</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">File::create</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">exists</span>())</span><br><span class="line">    &#123;   </span><br><span class="line">        <span class="comment">// 文件已存在</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果目标文件不存在，则先将其目录创建出来</span></span><br><span class="line">    <span class="function">Directory <span class="title">tmp</span><span class="params">(dir())</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (!tmp.<span class="built_in">exists</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        tmp.<span class="built_in">create</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">std::ofstream <span class="title">ofs</span><span class="params">(m_path)</span></span>;</span><br><span class="line">    <span class="keyword">return</span> ofs.<span class="built_in">is_open</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="删除文件">删除文件</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">File::remove</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">unlink</span>(m_path.<span class="built_in">c_str</span>()) == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="复制文件">复制文件</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">File::copy</span><span class="params">(<span class="type">const</span> string &amp; path)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">std::ifstream <span class="title">ifs</span><span class="params">(m_path)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (ifs.<span class="built_in">fail</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果目标文件不存在，则创建目标文件</span></span><br><span class="line">    <span class="function">File <span class="title">dst</span><span class="params">(path)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (!dst.<span class="built_in">exists</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        dst.<span class="built_in">create</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">std::ofstream <span class="title">ofs</span><span class="params">(path)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (ofs.<span class="built_in">fail</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ofs &lt;&lt; ifs.<span class="built_in">rdbuf</span>();</span><br><span class="line">    ofs.<span class="built_in">flush</span>();</span><br><span class="line">    ofs.<span class="built_in">close</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="文件重命名-移动文件">文件重命名(移动文件)</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">File::rename</span><span class="params">(<span class="type">const</span> string &amp; path)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> ret = std::<span class="built_in">rename</span>(m_path.<span class="built_in">c_str</span>(), path.<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    m_path = Directory::<span class="built_in">normalize_path</span>(path);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="判断文件是否存在">判断文件是否存在</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">File::exists</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 以读取模式打开文件，通过检查流状态判断文件是否存在</span></span><br><span class="line">    <span class="function">std::ifstream <span class="title">ifs</span><span class="params">(m_path)</span></span>;</span><br><span class="line">    <span class="keyword">return</span> ifs.<span class="built_in">good</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="清空文件内容">清空文件内容</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">File::clear</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 当以std::ios::out模式打开文件时，文件内容会被自动清空</span></span><br><span class="line">    <span class="function">std::ofstream <span class="title">ofs</span><span class="params">(m_path, std::ios::out)</span></span>;</span><br><span class="line">    ofs.<span class="built_in">flush</span>();</span><br><span class="line">    ofs.<span class="built_in">clear</span>();</span><br><span class="line">    <span class="comment">// ofs对象离开作用域时，析构函数会自动关闭文件</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="获取文件行数">获取文件行数</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">File::line</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">std::ifstream <span class="title">ifs</span><span class="params">(m_path)</span></span>;</span><br><span class="line">    <span class="type">int</span> line = <span class="number">0</span>;</span><br><span class="line">    string data;</span><br><span class="line">    <span class="keyword">while</span> (std::<span class="built_in">getline</span>(ifs, data))</span><br><span class="line">    &#123;</span><br><span class="line">        line++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> line;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="获取文件大小">获取文件大小</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">long</span> <span class="title">File::size</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* 方式一</span></span><br><span class="line"><span class="comment">    std::ifstream ifs(m_path);</span></span><br><span class="line"><span class="comment">    // 将文件指针移动到最后的位置</span></span><br><span class="line"><span class="comment">    ifs.seekg(0, std::ios_base::end);</span></span><br><span class="line"><span class="comment">    return (long)ifs.tellg();</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 方式二</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">stat</span> info = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">stat</span>(m_path.<span class="built_in">c_str</span>(), &amp;info) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 读取文件信息失败，输出错误信息</span></span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;stat file error: &quot;</span> &lt;&lt; m_path &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> info.st_size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="读取文件全部内容">读取文件全部内容</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">string <span class="title">File::read</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">std::ifstream <span class="title">ifs</span><span class="params">(m_path)</span></span>;</span><br><span class="line">    std::ostringstream oss;</span><br><span class="line">    oss &lt;&lt; ifs.<span class="built_in">rdbuf</span>();</span><br><span class="line">    <span class="keyword">return</span> oss.<span class="built_in">str</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="写入文件">写入文件</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">File::write</span><span class="params">(<span class="type">const</span> string &amp; data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 覆盖式写入</span></span><br><span class="line">    <span class="function">std::ofstream <span class="title">ofs</span><span class="params">(m_path)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (!ofs.<span class="built_in">is_open</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ofs.<span class="built_in">write</span>(data.<span class="built_in">c_str</span>(), data.<span class="built_in">size</span>());</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="目录常用操作">目录常用操作</h2><table><thead><tr><th style="text-align:center">成员函数</th><th style="text-align:center">描述</th></tr></thead><tbody><tr><td style="text-align:center">path</td><td style="text-align:center">获取目录的路径</td></tr><tr><td style="text-align:center">create</td><td style="text-align:center">创建一个空目录(含子目录)</td></tr><tr><td style="text-align:center">remove</td><td style="text-align:center">删除目录(含子目录)</td></tr><tr><td style="text-align:center">copy</td><td style="text-align:center">复制目录(含子目录)</td></tr><tr><td style="text-align:center">rename</td><td style="text-align:center">目录重命名(移动目录)</td></tr><tr><td style="text-align:center">exists</td><td style="text-align:center">判断目录是否存在</td></tr><tr><td style="text-align:center">clear</td><td style="text-align:center">清空目录(含子目录)</td></tr><tr><td style="text-align:center">file</td><td style="text-align:center">获取目录(含子目录)下全部文件</td></tr><tr><td style="text-align:center">count</td><td style="text-align:center">获取目录(含子目录)下包含多少个文件</td></tr><tr><td style="text-align:center">line</td><td style="text-align:center">获取目录(含子目录)下全部文件的行数</td></tr><tr><td style="text-align:center">size</td><td style="text-align:center">获取目录(含子目录)下全部文件的大小</td></tr></tbody></table><h3 id="获取目录的路径">获取目录的路径</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">string <span class="title">Directory::path</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_path;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="创建一个空目录-含子目录">创建一个空目录(含子目录)</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Directory::create</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> sep = <span class="built_in">separator</span>();</span><br><span class="line">    std::vector&lt;string&gt; arr = String::<span class="built_in">split</span>(m_path, sep);</span><br><span class="line">    string path;</span><br><span class="line">    <span class="comment">// 遍历路径的每一部分，并逐级地创建目录</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span> &amp; one : arr)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (one.<span class="built_in">empty</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!path.<span class="built_in">empty</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 添加路径分隔符</span></span><br><span class="line">            path += sep;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 拼接当前路径部分</span></span><br><span class="line">        path += one;</span><br><span class="line">        path = <span class="built_in">adjust_path</span>(path);</span><br><span class="line">        <span class="function">Directory <span class="title">dir</span><span class="params">(path)</span></span>;</span><br><span class="line">        <span class="keyword">if</span> (dir.<span class="built_in">exists</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">mkdir</span>(path.<span class="built_in">c_str</span>()) != <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="删除目录-含子目录">删除目录(含子目录)</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Directory::remove</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 如果该目录中包含有其它文件，则也需要一起删除掉</span></span><br><span class="line">    <span class="comment">// 首先打开该目录</span></span><br><span class="line">    DIR * dir = <span class="built_in">opendir</span>(m_path.<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="keyword">if</span> (dir == <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">dirent</span> * entry;</span><br><span class="line">    <span class="keyword">while</span> ((entry = <span class="built_in">readdir</span>(dir)) != <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        string filename = entry-&gt;d_name;</span><br><span class="line">        <span class="keyword">if</span> (filename == <span class="string">&quot;.&quot;</span> || filename == <span class="string">&quot;..&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        string fullname = m_path + <span class="built_in">separator</span>() + filename;</span><br><span class="line">        <span class="comment">// 判断完整路径是目录还是文件</span></span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">stat</span> info = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">stat</span>(fullname.<span class="built_in">c_str</span>(), &amp;info) != <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            std::cerr &lt;&lt; <span class="string">&quot;stat file error: &quot;</span> &lt;&lt; fullname &lt;&lt; std::endl;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">S_ISDIR</span>(info.st_mode))</span><br><span class="line">        &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 注意：Linux C++中可以使用rmdir()来删除目录，但是rmdir()只能删除空目录(不能包含任何文件或子目录)</span></span><br><span class="line">            <span class="comment">// 所以如果是子目录，则递归删除子目录</span></span><br><span class="line">            <span class="function">Directory <span class="title">tmp</span><span class="params">(fullname)</span></span>;</span><br><span class="line">            tmp.<span class="built_in">remove</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 如果是普通文件</span></span><br><span class="line">            <span class="built_in">unlink</span>(fullname.<span class="built_in">c_str</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// rmdir()只能删除空目录(不能包含任何文件或子目录)</span></span><br><span class="line">    <span class="built_in">rmdir</span>(m_path.<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="复制目录-含子目录">复制目录(含子目录)</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Directory::copy</span><span class="params">(<span class="type">const</span> string &amp; path)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 先确保目的路径(目录)存在</span></span><br><span class="line">    <span class="function">Directory <span class="title">dir</span><span class="params">(path)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (!dir.<span class="built_in">exists</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!dir.<span class="built_in">create</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取当前目录下的全部文件</span></span><br><span class="line">    <span class="keyword">auto</span> files = <span class="built_in">file</span>();</span><br><span class="line">    <span class="comment">// 将文件从源目录拷贝至目标目录</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> &amp; file : files)</span><br><span class="line">    &#123;</span><br><span class="line">        string src = file.<span class="built_in">path</span>();</span><br><span class="line">        string dst = dir.<span class="built_in">path</span>() + src.<span class="built_in">substr</span>(m_path.<span class="built_in">length</span>());</span><br><span class="line">        <span class="keyword">if</span> (!file.<span class="built_in">copy</span>(dst))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="目录重命名-移动目录">目录重命名(移动目录)</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Directory::rename</span><span class="params">(<span class="type">const</span> string &amp; path)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> ret = std::<span class="built_in">rename</span>(m_path.<span class="built_in">c_str</span>(), path.<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    m_path = <span class="built_in">normalize_path</span>(path);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="判断目录是否存在">判断目录是否存在</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Directory::exists</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_path.<span class="built_in">empty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">stat</span> info = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="comment">// 使用stat()系统调用获取路径信息</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">stat</span>(m_path.<span class="built_in">c_str</span>(), &amp;info) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 检查st_mode标志位是否设置了S_IFDIR目录标志</span></span><br><span class="line">    <span class="keyword">if</span> (info.st_mode &amp; S_IFDIR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="清空目录-含子目录">清空目录(含子目录)</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Directory::clear</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// clear操作相较于remove操作的区别在于不用删除当前目录</span></span><br><span class="line">    DIR * dir = <span class="built_in">opendir</span>(m_path.<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="keyword">if</span> (dir == <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">dirent</span> * entry;</span><br><span class="line">    <span class="keyword">while</span> ((entry = <span class="built_in">readdir</span>(dir)) != <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        string filename = entry-&gt;d_name;</span><br><span class="line">        <span class="keyword">if</span> (filename == <span class="string">&quot;.&quot;</span> || filename == <span class="string">&quot;..&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        string fullname = m_path + <span class="built_in">separator</span>() + filename;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">stat</span> info = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">stat</span>(fullname.<span class="built_in">c_str</span>(), &amp;info) != <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            std::cerr &lt;&lt; <span class="string">&quot;stat file error: &quot;</span> &lt;&lt; fullname &lt;&lt; std::endl;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">S_ISDIR</span>(info.st_mode))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="function">Directory <span class="title">tmp</span><span class="params">(fullname)</span></span>;</span><br><span class="line">            tmp.<span class="built_in">remove</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">unlink</span>(fullname.<span class="built_in">c_str</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="获取目录-含子目录-下全部文件">获取目录(含子目录)下全部文件</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::vector&lt;File&gt; <span class="title">Directory::file</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::vector&lt;File&gt; files;</span><br><span class="line">    DIR * dir = <span class="built_in">opendir</span>(m_path.<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="keyword">if</span> (dir == <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> files;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">dirent</span> * entry;</span><br><span class="line">    <span class="keyword">while</span> ((entry = <span class="built_in">readdir</span>(dir)) != <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        string filename = entry-&gt;d_name;</span><br><span class="line">        <span class="keyword">if</span> (filename == <span class="string">&quot;.&quot;</span> || filename == <span class="string">&quot;..&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        string fullname = m_path + <span class="built_in">separator</span>() + filename;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">stat</span> info = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">stat</span>(fullname.<span class="built_in">c_str</span>(), &amp;info) != <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            std::cerr &lt;&lt; <span class="string">&quot;stat file error: &quot;</span> &lt;&lt; fullname &lt;&lt; std::endl;</span><br><span class="line">            <span class="keyword">return</span> files;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">S_ISDIR</span>(info.st_mode))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 如果是目录</span></span><br><span class="line">            <span class="function">Directory <span class="title">tmp</span><span class="params">(fullname)</span></span>;</span><br><span class="line">            <span class="keyword">auto</span> vec = tmp.<span class="built_in">file</span>();</span><br><span class="line">            files.<span class="built_in">insert</span>(files.<span class="built_in">end</span>(), vec.<span class="built_in">begin</span>(), vec.<span class="built_in">end</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 如果是普通文件</span></span><br><span class="line">            files.<span class="built_in">push_back</span>(<span class="built_in">File</span>(fullname));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> files;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="获取目录-含子目录-下包含多少文件">获取目录(含子目录)下包含多少文件</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">Directory::count</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> files = <span class="built_in">file</span>();</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">int</span>)files.<span class="built_in">size</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="获取目录-含子目录-下全部文件的行数">获取目录(含子目录)下全部文件的行数</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">Directory::line</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> line = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">auto</span> files = <span class="built_in">file</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> &amp; file : files)</span><br><span class="line">    &#123;</span><br><span class="line">        line += file.<span class="built_in">line</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> line;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="获取目录-含子目录-下全部文件的大小">获取目录(含子目录)下全部文件的大小</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">long</span> <span class="title">Directory::size</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">long</span> size = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">auto</span> files = <span class="built_in">file</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> &amp; file : files)</span><br><span class="line">    &#123;</span><br><span class="line">        size += file.<span class="built_in">size</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="跨平台">跨平台</h2><h3 id="文件操作">文件操作</h3><p>文件操作可以使用C++11标准库<code>fstream</code>以支持跨平台。</p><h3 id="目录操作">目录操作</h3><p><code>dirent.h</code>是Linux/Unix平台用于提取文件和目录信息的编程接口，Windows平台并不支持，Windows平台可以使用C++17的<code>std::filesystem</code>或者使用开源项目<a href="https://github.com/tronkko/dirent">GitHub - tronkko/dirent: C/C++ library for retrieving information on files and directories</a>提供的库：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fs/directory.h 解决dirent头文件的跨平台问题</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> WIN32</span></span><br><span class="line">    <span class="comment">// https://github.com/tronkko/dirent</span></span><br><span class="line">    <span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dirent_win/dirent_win.h&gt;</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">include</span> <span class="string">&lt;direct.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dirent.h&gt;</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fs/directory.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Directory::mkdir</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * path)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// 使用::表示全局命名空间以调用系统接口</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> WIN32</span></span><br><span class="line">    <span class="keyword">return</span> ::_mkdir(path);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="comment">// 所有者rwx，组和其它rx</span></span><br><span class="line">    <span class="keyword">return</span> ::<span class="built_in">mkdir</span>(path, <span class="number">0755</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Directory::rmdir</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * path)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> WIN32</span></span><br><span class="line">    <span class="keyword">return</span> ::_rmdir(path);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="keyword">return</span> ::<span class="built_in">rmdir</span>(path);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Directory::unlink</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * path)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> WIN32</span></span><br><span class="line">    <span class="keyword">return</span> ::_unlink(path);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="keyword">return</span> ::<span class="built_in">unlink</span>(path);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">char</span> * <span class="title">Directory::getcwd</span><span class="params">(<span class="type">char</span> * buf, <span class="type">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> WIN32</span></span><br><span class="line">    <span class="keyword">return</span> ::_getcwd(buf, len);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="keyword">return</span> ::<span class="built_in">getcwd</span>(buf, len);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="完整实现">完整实现</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fs/file.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> std::string;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> fs</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">File</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">File</span>() = <span class="keyword">delete</span>;                        <span class="comment">// 对于每个文件都必须有一个文件路径</span></span><br><span class="line">            <span class="built_in">File</span>(<span class="type">const</span> string &amp; path);</span><br><span class="line">            ~<span class="built_in">File</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">            <span class="function">string <span class="title">path</span><span class="params">()</span> <span class="type">const</span></span>;                    <span class="comment">// 获取文件路径</span></span><br><span class="line">            <span class="function">string <span class="title">dir</span><span class="params">()</span> <span class="type">const</span></span>;                     <span class="comment">// 获取文件所在目录</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">create</span><span class="params">()</span></span>;                          <span class="comment">// 创建一个空文件</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">remove</span><span class="params">()</span></span>;                          <span class="comment">// 删除文件</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">rename</span><span class="params">(<span class="type">const</span> string &amp; path)</span></span>;       <span class="comment">// 修改文件</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">clear</span><span class="params">()</span></span>;                           <span class="comment">// 清空文件</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">exists</span><span class="params">()</span> <span class="type">const</span></span>;                    <span class="comment">// 判断文件是否存在</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">copy</span><span class="params">(<span class="type">const</span> string &amp; path)</span></span>;         <span class="comment">// 复制文件到指定路径</span></span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">line</span><span class="params">()</span> <span class="type">const</span></span>;                       <span class="comment">// 获取文件的行数</span></span><br><span class="line">            <span class="function"><span class="type">long</span> <span class="title">size</span><span class="params">()</span> <span class="type">const</span></span>;                      <span class="comment">// 获取文件的大小</span></span><br><span class="line">            <span class="function"><span class="type">time_t</span> <span class="title">time</span><span class="params">()</span> <span class="type">const</span></span>;                    <span class="comment">// 获取文件最后修改的时间</span></span><br><span class="line">            <span class="function">string <span class="title">read</span><span class="params">()</span> <span class="type">const</span></span>;                    <span class="comment">// 读取文件全部内容</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">write</span><span class="params">(<span class="type">const</span> string &amp; data)</span></span>;        <span class="comment">// 写入文件</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            string m_path;                          <span class="comment">// 文件的绝对路径</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fs/file.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fs/file.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fs/directory.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::fs;</span><br><span class="line"></span><br><span class="line">File::<span class="built_in">File</span>(<span class="type">const</span> string &amp; path)</span><br><span class="line">&#123;</span><br><span class="line">    m_path = Directory::<span class="built_in">normalize_path</span>(path);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">string <span class="title">File::path</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_path;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">string <span class="title">File::dir</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_path.<span class="built_in">empty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">char</span> sep = Directory::<span class="built_in">separator</span>();</span><br><span class="line">    <span class="type">size_t</span> last = m_path.<span class="built_in">find_last_of</span>(sep);</span><br><span class="line">    <span class="keyword">if</span> (last != std::string::npos)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> m_path.<span class="built_in">substr</span>(<span class="number">0</span>, last);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">File::create</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">exists</span>())</span><br><span class="line">    &#123;   </span><br><span class="line">        <span class="comment">// 文件已存在</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果目标文件不存在，则先将其目录创建出来</span></span><br><span class="line">    <span class="function">Directory <span class="title">tmp</span><span class="params">(dir())</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (!tmp.<span class="built_in">exists</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        tmp.<span class="built_in">create</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">std::ofstream <span class="title">ofs</span><span class="params">(m_path)</span></span>;</span><br><span class="line">    <span class="keyword">return</span> ofs.<span class="built_in">is_open</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">File::remove</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">unlink</span>(m_path.<span class="built_in">c_str</span>()) == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">File::rename</span><span class="params">(<span class="type">const</span> string &amp; path)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> ret = std::<span class="built_in">rename</span>(m_path.<span class="built_in">c_str</span>(), path.<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    m_path = Directory::<span class="built_in">normalize_path</span>(path);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">File::clear</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 当以std::ios::out模式打开文件时，文件内容会被自动清空</span></span><br><span class="line">    <span class="function">std::ofstream <span class="title">ofs</span><span class="params">(m_path, std::ios::out)</span></span>;</span><br><span class="line">    ofs.<span class="built_in">flush</span>();</span><br><span class="line">    ofs.<span class="built_in">clear</span>();</span><br><span class="line">    <span class="comment">// ofs对象离开作用域时，析构函数会自动关闭文件</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">File::exists</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 以读取模式打开文件，通过检查流状态判断文件是否存在</span></span><br><span class="line">    <span class="function">std::ifstream <span class="title">ifs</span><span class="params">(m_path)</span></span>;</span><br><span class="line">    <span class="keyword">return</span> ifs.<span class="built_in">good</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">File::copy</span><span class="params">(<span class="type">const</span> string &amp; path)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">std::ifstream <span class="title">ifs</span><span class="params">(m_path)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (ifs.<span class="built_in">fail</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果目标文件不存在，则创建目标文件</span></span><br><span class="line">    <span class="function">File <span class="title">dst</span><span class="params">(path)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (!dst.<span class="built_in">exists</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        dst.<span class="built_in">create</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">std::ofstream <span class="title">ofs</span><span class="params">(path)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (ofs.<span class="built_in">fail</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ofs &lt;&lt; ifs.<span class="built_in">rdbuf</span>();</span><br><span class="line">    ofs.<span class="built_in">flush</span>();</span><br><span class="line">    ofs.<span class="built_in">close</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">File::line</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">std::ifstream <span class="title">ifs</span><span class="params">(m_path)</span></span>;</span><br><span class="line">    <span class="type">int</span> line = <span class="number">0</span>;</span><br><span class="line">    string data;</span><br><span class="line">    <span class="keyword">while</span> (std::<span class="built_in">getline</span>(ifs, data))</span><br><span class="line">    &#123;</span><br><span class="line">        line++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> line;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">long</span> <span class="title">File::size</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* 方式一</span></span><br><span class="line"><span class="comment">    std::ifstream ifs(m_path);</span></span><br><span class="line"><span class="comment">    // 将文件指针移动到最后的位置</span></span><br><span class="line"><span class="comment">    ifs.seekg(0, std::ios_base::end);</span></span><br><span class="line"><span class="comment">    return (long)ifs.tellg();</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 方式二</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">stat</span> info = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">stat</span>(m_path.<span class="built_in">c_str</span>(), &amp;info) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 读取文件信息失败，输出错误信息</span></span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;stat file error: &quot;</span> &lt;&lt; m_path &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> info.st_size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">time_t</span> <span class="title">File::time</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">stat</span> info = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">stat</span>(m_path.<span class="built_in">c_str</span>(), &amp;info) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;stat file error: &quot;</span> &lt;&lt; m_path &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// st_mtine: Time of last modification.文件最后修改的时间</span></span><br><span class="line">    <span class="keyword">return</span> info.st_mtime;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">string <span class="title">File::read</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">std::ifstream <span class="title">ifs</span><span class="params">(m_path)</span></span>;</span><br><span class="line">    std::ostringstream oss;</span><br><span class="line">    oss &lt;&lt; ifs.<span class="built_in">rdbuf</span>();</span><br><span class="line">    <span class="keyword">return</span> oss.<span class="built_in">str</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">File::write</span><span class="params">(<span class="type">const</span> string &amp; data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 覆盖式写入</span></span><br><span class="line">    <span class="function">std::ofstream <span class="title">ofs</span><span class="params">(m_path)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (!ofs.<span class="built_in">is_open</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ofs.<span class="built_in">write</span>(data.<span class="built_in">c_str</span>(), data.<span class="built_in">size</span>());</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fs/directory.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;limits.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility/string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fs/file.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 解决dirent头文件的跨平台问题</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> WIN32</span></span><br><span class="line">    <span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dirent_win/dirent_win.h&gt;</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">include</span> <span class="string">&lt;direct.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dirent.h&gt;</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::utility;</span><br><span class="line"><span class="keyword">using</span> std::string;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> fs</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Directory</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">Directory</span>();</span><br><span class="line">            <span class="built_in">Directory</span>(<span class="type">const</span> string &amp; path);</span><br><span class="line">            ~<span class="built_in">Directory</span>() = <span class="keyword">default</span>;</span><br><span class="line">        </span><br><span class="line">            <span class="function">string <span class="title">path</span><span class="params">()</span> <span class="type">const</span></span>;                        <span class="comment">// 获取目录的路径</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">create</span><span class="params">()</span></span>;                              <span class="comment">// 创建一个空目录(含多级目录)</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">exists</span><span class="params">()</span> <span class="type">const</span></span>;                        <span class="comment">// 判断目录是否存在</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">remove</span><span class="params">()</span> <span class="type">const</span></span>;                        <span class="comment">// 删除目录(含子目录)</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">clear</span><span class="params">()</span></span>;                               <span class="comment">// 清空目录(含子目录)</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">rename</span><span class="params">(<span class="type">const</span> string &amp; path)</span></span>;           <span class="comment">// 目录重命名(移动目录)</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">copy</span><span class="params">(<span class="type">const</span> string &amp; path)</span></span>;             <span class="comment">// 复制目录(含子目录)</span></span><br><span class="line">            <span class="function">std::vector&lt;File&gt; <span class="title">file</span><span class="params">()</span> <span class="type">const</span></span>;             <span class="comment">// 获取目录(含子目录)下全部文件</span></span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">count</span><span class="params">()</span> <span class="type">const</span></span>;                          <span class="comment">// 获取目录(含子目录)下包含文件的数量</span></span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">line</span><span class="params">()</span> <span class="type">const</span></span>;                           <span class="comment">// 获取目录(含子目录)下全部文件的行数</span></span><br><span class="line">            <span class="function"><span class="type">long</span> <span class="title">size</span><span class="params">()</span> <span class="type">const</span></span>;                           <span class="comment">// 获取目录(含子目录)下全部文件的大小</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="comment">// 获取路径分隔符，对于Windows是&#x27;\&#x27;，对于Linux是&#x27;/&#x27;</span></span><br><span class="line">            <span class="function"><span class="type">static</span> <span class="type">char</span> <span class="title">separator</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="comment">// 判断传入的路径path是否为绝对路径</span></span><br><span class="line">            <span class="function"><span class="type">static</span> <span class="type">bool</span> <span class="title">is_absolute_path</span><span class="params">(<span class="type">const</span> string &amp; path)</span></span>;</span><br><span class="line">            <span class="comment">// 路径统一化</span></span><br><span class="line">            <span class="function"><span class="type">static</span> string <span class="title">normalize_path</span><span class="params">(<span class="type">const</span> string &amp; path)</span></span>;</span><br><span class="line">            <span class="comment">// 对不同平台下路径的处理</span></span><br><span class="line">            <span class="function"><span class="type">static</span> string <span class="title">adjust_path</span><span class="params">(<span class="type">const</span> string &amp; path)</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">mkdir</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * path)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">rmdir</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * path)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">unlink</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * path)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">static</span> <span class="type">char</span> * <span class="title">getcwd</span><span class="params">(<span class="type">char</span> * buf, <span class="type">int</span> len)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            string m_path;                              <span class="comment">// 目录的路径</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fs/directory.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fs/directory.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::fs;</span><br><span class="line"></span><br><span class="line">Directory::<span class="built_in">Directory</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 默认构造时，目录路径为当前路径</span></span><br><span class="line">    m_path = <span class="built_in">normalize_path</span>(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Directory::<span class="built_in">Directory</span>(<span class="type">const</span> string &amp; path)</span><br><span class="line">&#123;</span><br><span class="line">    m_path = <span class="built_in">normalize_path</span>(path);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">string <span class="title">Directory::path</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_path;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Directory::create</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> sep = <span class="built_in">separator</span>();</span><br><span class="line">    std::vector&lt;string&gt; arr = String::<span class="built_in">split</span>(m_path, sep);</span><br><span class="line">    string path;</span><br><span class="line">    <span class="comment">// 遍历路径的每一部分，并逐级地创建目录</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span> &amp; one : arr)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (one.<span class="built_in">empty</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!path.<span class="built_in">empty</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 添加路径分隔符</span></span><br><span class="line">            path += sep;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 拼接当前路径部分</span></span><br><span class="line">        path += one;</span><br><span class="line">        path = <span class="built_in">adjust_path</span>(path);</span><br><span class="line">        <span class="function">Directory <span class="title">dir</span><span class="params">(path)</span></span>;</span><br><span class="line">        <span class="keyword">if</span> (dir.<span class="built_in">exists</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">mkdir</span>(path.<span class="built_in">c_str</span>()) != <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Directory::exists</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_path.<span class="built_in">empty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">stat</span> info = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="comment">// 使用stat()系统调用获取路径信息</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">stat</span>(m_path.<span class="built_in">c_str</span>(), &amp;info) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 检查st_mode标志位是否设置了S_IFDIR目录标志</span></span><br><span class="line">    <span class="keyword">if</span> (info.st_mode &amp; S_IFDIR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Directory::remove</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 如果该目录中包含有其它文件，则也需要一起删除掉</span></span><br><span class="line">    <span class="comment">// 首先打开该目录</span></span><br><span class="line">    DIR * dir = <span class="built_in">opendir</span>(m_path.<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="keyword">if</span> (dir == <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">dirent</span> * entry;</span><br><span class="line">    <span class="keyword">while</span> ((entry = <span class="built_in">readdir</span>(dir)) != <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        string filename = entry-&gt;d_name;</span><br><span class="line">        <span class="keyword">if</span> (filename == <span class="string">&quot;.&quot;</span> || filename == <span class="string">&quot;..&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        string fullname = m_path + <span class="built_in">separator</span>() + filename;</span><br><span class="line">        <span class="comment">// 判断完整路径是目录还是文件</span></span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">stat</span> info = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">stat</span>(fullname.<span class="built_in">c_str</span>(), &amp;info) != <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            std::cerr &lt;&lt; <span class="string">&quot;stat file error: &quot;</span> &lt;&lt; fullname &lt;&lt; std::endl;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">S_ISDIR</span>(info.st_mode))</span><br><span class="line">        &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 注意：Linux C++中可以使用rmdir()来删除目录，但是rmdir()只能删除空目录(不能包含任何文件或子目录)</span></span><br><span class="line">            <span class="comment">// 所以如果是子目录，则递归删除子目录</span></span><br><span class="line">            <span class="function">Directory <span class="title">tmp</span><span class="params">(fullname)</span></span>;</span><br><span class="line">            tmp.<span class="built_in">remove</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 如果是普通文件</span></span><br><span class="line">            <span class="built_in">unlink</span>(fullname.<span class="built_in">c_str</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// rmdir()只能删除空目录(不能包含任何文件或子目录)</span></span><br><span class="line">    <span class="built_in">rmdir</span>(m_path.<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Directory::clear</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// clear操作相较于remove操作的区别在于不用删除当前目录</span></span><br><span class="line">    DIR * dir = <span class="built_in">opendir</span>(m_path.<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="keyword">if</span> (dir == <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">dirent</span> * entry;</span><br><span class="line">    <span class="keyword">while</span> ((entry = <span class="built_in">readdir</span>(dir)) != <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        string filename = entry-&gt;d_name;</span><br><span class="line">        <span class="keyword">if</span> (filename == <span class="string">&quot;.&quot;</span> || filename == <span class="string">&quot;..&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        string fullname = m_path + <span class="built_in">separator</span>() + filename;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">stat</span> info = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">stat</span>(fullname.<span class="built_in">c_str</span>(), &amp;info) != <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            std::cerr &lt;&lt; <span class="string">&quot;stat file error: &quot;</span> &lt;&lt; fullname &lt;&lt; std::endl;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">S_ISDIR</span>(info.st_mode))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="function">Directory <span class="title">tmp</span><span class="params">(fullname)</span></span>;</span><br><span class="line">            tmp.<span class="built_in">remove</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">unlink</span>(fullname.<span class="built_in">c_str</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Directory::rename</span><span class="params">(<span class="type">const</span> string &amp; path)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> ret = std::<span class="built_in">rename</span>(m_path.<span class="built_in">c_str</span>(), path.<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    m_path = <span class="built_in">normalize_path</span>(path);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Directory::copy</span><span class="params">(<span class="type">const</span> string &amp; path)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 先确保目的路径(目录)存在</span></span><br><span class="line">    <span class="function">Directory <span class="title">dir</span><span class="params">(path)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (!dir.<span class="built_in">exists</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!dir.<span class="built_in">create</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取当前目录下的全部文件</span></span><br><span class="line">    <span class="keyword">auto</span> files = <span class="built_in">file</span>();</span><br><span class="line">    <span class="comment">// 将文件从源目录拷贝至目标目录</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> &amp; file : files)</span><br><span class="line">    &#123;</span><br><span class="line">        string src = file.<span class="built_in">path</span>();</span><br><span class="line">        string dst = dir.<span class="built_in">path</span>() + src.<span class="built_in">substr</span>(m_path.<span class="built_in">length</span>());</span><br><span class="line">        <span class="keyword">if</span> (!file.<span class="built_in">copy</span>(dst))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">std::vector&lt;File&gt; <span class="title">Directory::file</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::vector&lt;File&gt; files;</span><br><span class="line">    DIR * dir = <span class="built_in">opendir</span>(m_path.<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="keyword">if</span> (dir == <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> files;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">dirent</span> * entry;</span><br><span class="line">    <span class="keyword">while</span> ((entry = <span class="built_in">readdir</span>(dir)) != <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        string filename = entry-&gt;d_name;</span><br><span class="line">        <span class="keyword">if</span> (filename == <span class="string">&quot;.&quot;</span> || filename == <span class="string">&quot;..&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        string fullname = m_path + <span class="built_in">separator</span>() + filename;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">stat</span> info = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">stat</span>(fullname.<span class="built_in">c_str</span>(), &amp;info) != <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            std::cerr &lt;&lt; <span class="string">&quot;stat file error: &quot;</span> &lt;&lt; fullname &lt;&lt; std::endl;</span><br><span class="line">            <span class="keyword">return</span> files;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">S_ISDIR</span>(info.st_mode))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 如果是目录</span></span><br><span class="line">            <span class="function">Directory <span class="title">tmp</span><span class="params">(fullname)</span></span>;</span><br><span class="line">            <span class="keyword">auto</span> vec = tmp.<span class="built_in">file</span>();</span><br><span class="line">            files.<span class="built_in">insert</span>(files.<span class="built_in">end</span>(), vec.<span class="built_in">begin</span>(), vec.<span class="built_in">end</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 如果是普通文件</span></span><br><span class="line">            files.<span class="built_in">push_back</span>(<span class="built_in">File</span>(fullname));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> files;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Directory::count</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> files = <span class="built_in">file</span>();</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">int</span>)files.<span class="built_in">size</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Directory::line</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> line = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">auto</span> files = <span class="built_in">file</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> &amp; file : files)</span><br><span class="line">    &#123;</span><br><span class="line">        line += file.<span class="built_in">line</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> line;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">long</span> <span class="title">Directory::size</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">long</span> size = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">auto</span> files = <span class="built_in">file</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> &amp; file : files)</span><br><span class="line">    &#123;</span><br><span class="line">        size += file.<span class="built_in">size</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">char</span> <span class="title">Directory::separator</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> WIN32</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;\\&#x27;</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Directory::is_absolute_path</span><span class="params">(<span class="type">const</span> string &amp; path)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (path.<span class="built_in">empty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">char</span> sep = Directory::<span class="built_in">separator</span>();</span><br><span class="line">    string filepath = path;</span><br><span class="line">    <span class="comment">// 对于Windows平台，要将路径中的分隔符转换为Linux平台的分隔符</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> WIN32</span></span><br><span class="line">    std::<span class="built_in">replace</span>(filepath.<span class="built_in">begin</span>(), filepath.<span class="built_in">end</span>(), <span class="string">&#x27;/&#x27;</span>, sep);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="comment">// 将路径按照分隔符进行分割</span></span><br><span class="line">    std::vector&lt;string&gt; output = String::<span class="built_in">split</span>(filepath, sep);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> WIN32</span></span><br><span class="line">    <span class="comment">// Windows平台下的绝对路径会以盘符开始C://user/./../test/a/b/c</span></span><br><span class="line">    <span class="keyword">if</span> (output[<span class="number">0</span>].<span class="built_in">find</span>(<span class="string">&#x27;:&#x27;</span>) != std::string::npos)</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="comment">// Linux平台下的绝对路径分割后第一个元素为空/root/test/a/b/c</span></span><br><span class="line">    <span class="keyword">if</span> (output[<span class="number">0</span>].<span class="built_in">empty</span>())</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">string <span class="title">Directory::normalize_path</span><span class="params">(<span class="type">const</span> string &amp; path)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> sep = Directory::<span class="built_in">separator</span>();</span><br><span class="line">    string filepath = path;</span><br><span class="line">    <span class="comment">// 对于Windows平台，要将路径中的分隔符转换为Linux平台的分隔符</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> WIN32</span></span><br><span class="line">    std::<span class="built_in">replace</span>(filepath.<span class="built_in">begin</span>(), filepath.<span class="built_in">end</span>(), <span class="string">&#x27;/&#x27;</span>, sep);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    std::vector&lt;string&gt; path_list;</span><br><span class="line">    <span class="comment">// 如果是相对路径，则需要获取其当前目录</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">is_absolute_path</span>(path))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> cmd[PATH_MAX] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        <span class="built_in">getcwd</span>(cmd, PATH_MAX);</span><br><span class="line">        path_list = String::<span class="built_in">split</span>(cmd, sep);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span> &amp; dir : String::<span class="built_in">split</span>(filepath, sep))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (dir.<span class="built_in">empty</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (dir == <span class="string">&quot;.&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (dir == <span class="string">&quot;..&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            path_list.<span class="built_in">pop_back</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            path_list.<span class="built_in">push_back</span>(dir);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    string ret = String::<span class="built_in">join</span>(path_list, sep);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">adjust_path</span>(ret);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">string <span class="title">Directory::adjust_path</span><span class="params">(<span class="type">const</span> string &amp; path)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string result = path;</span><br><span class="line">    <span class="type">char</span> sep = <span class="built_in">separator</span>();</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> WIN32</span></span><br><span class="line">    <span class="comment">// 对于Windows路径，如果路径最后是冒号:，则需要补上一个分隔符</span></span><br><span class="line">    <span class="comment">// D:  -&gt;  D://</span></span><br><span class="line">    <span class="keyword">if</span> (path[path.<span class="built_in">size</span>() - <span class="number">1</span>] = <span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        result += sep;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="comment">// 对于Linux路径，如果路径第一个字符不是斜杠/，则路径最前面需要补上一个斜杠/</span></span><br><span class="line">    <span class="keyword">if</span> (result[<span class="number">0</span>] != sep)</span><br><span class="line">    &#123;</span><br><span class="line">        result = <span class="built_in">string</span>(<span class="number">1</span>, sep) + result;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> </span></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Directory::mkdir</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * path)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// 使用::表示全局命名空间以调用系统接口</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> WIN32</span></span><br><span class="line">    <span class="keyword">return</span> ::_mkdir(path);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="comment">// 所有者rwx，组和其它rx</span></span><br><span class="line">    <span class="keyword">return</span> ::<span class="built_in">mkdir</span>(path, <span class="number">0755</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Directory::rmdir</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * path)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> WIN32</span></span><br><span class="line">    <span class="keyword">return</span> ::_rmdir(path);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="keyword">return</span> ::<span class="built_in">rmdir</span>(path);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Directory::unlink</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * path)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> WIN32</span></span><br><span class="line">    <span class="keyword">return</span> ::_unlink(path);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="keyword">return</span> ::<span class="built_in">unlink</span>(path);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">char</span> * <span class="title">Directory::getcwd</span><span class="params">(<span class="type">char</span> * buf, <span class="type">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> WIN32</span></span><br><span class="line">    <span class="keyword">return</span> ::_getcwd(buf, len);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="keyword">return</span> ::<span class="built_in">getcwd</span>(buf, len);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> C++后端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>C++反射</title>
      <link href="/2024/06/28/C-%E5%8F%8D%E5%B0%84/"/>
      <url>/2024/06/28/C-%E5%8F%8D%E5%B0%84/</url>
      
        <content type="html"><![CDATA[<h1 id="c-反射">C++反射</h1><h2 id="反射简介">反射简介</h2><p>在程序开发中，可能会遇到这样的需求：需要执行对象里的某个方法，或需要调用对象中的某个变量，但是由于种种原因我们无法确定这个方法或变量是否存在，这时我们需要用一个特殊的方法或机制来访问和操作这个未知的方法或变量，这种机制就称之为反射。反射机制允许程序在运行时借助Reflection API取得任何类的内部信息，并能直接操作对象的内部属性和方法。</p><h2 id="问题">问题</h2><ol><li>C++不支持反射，而Java、Go、PHP等高级语言是原生支持反射的</li><li>很多业务场景需要依赖反射机制，比如：Web MVC框架</li></ol><h2 id="目标">目标</h2><ol><li>实现类对象反射</li><li>实现类成员数据反射</li><li>实现类成员函数反射</li></ol><h2 id="类对象反射">类对象反射</h2><p>类对象反射简单来说就是程序运行时读进来一个字符串，然后程序就会自动创建出字符串对应名字的类对象：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> &#123;&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">B</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> * <span class="title">create_class</span><span class="params">(<span class="type">const</span> string &amp; class_name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (class_name == <span class="string">&quot;A&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">A</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (class_name == <span class="string">&quot;B&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">B</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面的粗糙实现存在很多弊端，以下是实现类对象反射后的用法演示。类<code>A</code>如果要实现反射机制，那么它必须继承自<code>Object</code>，<code>Object</code>就是反射框架提供的基类，然后在通过宏<code>REGISTER_CLASS(A);</code>注册一下。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;reflect/class_register.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::reflect;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 类A要实现反射机制，则其必须继承自Object，Object是反射框架提供的基类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> : <span class="keyword">public</span> Object</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">A</span>() &#123;&#125;</span><br><span class="line">    ~<span class="built_in">A</span>() &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过宏REGISTER_CLASS注册一下</span></span><br><span class="line"><span class="built_in">REGISTER_CLASS</span>(A);</span><br></pre></td></tr></table></figure><p>经过以上两步后就可以使用反射了，<code>create_class()</code>根据类名来创建对象：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 类对象反射</span></span><br><span class="line">    <span class="comment">// 通过工厂类ClassFactory，调用它的create_class()并传入字符串&quot;A&quot;，得到对象a</span></span><br><span class="line">    ClassFactory * factory = Singleton&lt;ClassFactory&gt;::<span class="built_in">instance</span>();</span><br><span class="line">    Object * a = factory-&gt;<span class="built_in">create_class</span>(<span class="string">&quot;A&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="完整实现">完整实现</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// reflect/class_factory.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility/singleton.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::utility;</span><br><span class="line"><span class="keyword">using</span> std::string;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> reflect</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 如果类要实现反射机制，那么它必须继承自Object</span></span><br><span class="line">        <span class="comment">// Object就是反射框架提供的基类</span></span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Object</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">Object</span>() = <span class="keyword">default</span>;</span><br><span class="line">            <span class="keyword">virtual</span> ~<span class="built_in">Object</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">set_class_name</span><span class="params">(<span class="type">const</span> string &amp; class_name)</span></span>;             <span class="comment">// 设置类的名称</span></span><br><span class="line">            <span class="function"><span class="type">const</span> string &amp; <span class="title">get_class_name</span><span class="params">()</span> <span class="type">const</span></span>;                      <span class="comment">// 获取类的名称</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            string m_class_name;                                        <span class="comment">// 记录类的名称</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// create_object是函数指针，传入参数为空，返回类型为Object*</span></span><br><span class="line">        <span class="comment">// using create_object = Object* (*)(void);</span></span><br><span class="line">        <span class="comment">// typedef Object * (*create_object)();</span></span><br><span class="line">        <span class="keyword">using</span> create_object = Object* (*)(<span class="type">void</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 工厂类</span></span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">ClassFactory</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 单例模式</span></span><br><span class="line">            <span class="built_in">SINGLETON</span>(ClassFactory);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="comment">// 类对象反射</span></span><br><span class="line">            <span class="comment">// 注册类名称关联到它的创建函数</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">register_class</span><span class="params">(<span class="type">const</span> string &amp; class_name, create_object func)</span></span>;</span><br><span class="line">            <span class="comment">// 根据类名创建对应的对象</span></span><br><span class="line">            <span class="function">Object * <span class="title">create_class</span><span class="params">(<span class="type">const</span> string &amp; name)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="comment">// 根据字符串创建类，m_class_map就是字符串到它类的创建函数create_object的映射</span></span><br><span class="line">            std::map&lt;string, reflect::create_object&gt; m_class_map;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// reflect/class_factory.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;reflect/class_factory.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::reflect;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Object::set_class_name</span><span class="params">(<span class="type">const</span> string &amp; class_name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_class_name = class_name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">const</span> string &amp; <span class="title">Object::get_class_name</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_class_name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ClassFactory::register_class</span><span class="params">(<span class="type">const</span> string &amp; class_name, reflect::create_object func)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_class_map[class_name] = func;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Object * <span class="title">ClassFactory::create_class</span><span class="params">(<span class="type">const</span> string &amp; class_name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> it = m_class_map.<span class="built_in">find</span>(class_name);</span><br><span class="line">    <span class="keyword">if</span> (it == m_class_map.<span class="built_in">end</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> it-&gt;<span class="built_in">second</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// reflect/class_register.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;reflect/class_factory.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> reflect</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 由ClassRegister类完整类创建方法的注册</span></span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">ClassRegister</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">ClassRegister</span>(<span class="type">const</span> string &amp; class_name, create_object func)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 借助辅助类ClassRegister的构造函数完成类的注册</span></span><br><span class="line">                Singleton&lt;ClassFactory&gt;::<span class="built_in">instance</span>()-&gt;<span class="built_in">register_class</span>(class_name, func);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 注册对象的宏：首先定义一个全局的函数，然后声明一个全局的变量</span></span><br><span class="line">        <span class="comment">// 在宏中使用两个#号表示字符串连接，一个#号表示将其转换为字符串</span></span><br><span class="line">        <span class="meta">#<span class="keyword">define</span> REGISTER_CLASS(className)                                                           \</span></span><br><span class="line"><span class="meta">            Object * createObject##className()                                                      \</span></span><br><span class="line"><span class="meta">            &#123;                                                                                       \</span></span><br><span class="line"><span class="meta">                Object * obj = new className();                                                     \</span></span><br><span class="line"><span class="meta">                obj-&gt;set_class_name(#className);                                                    \</span></span><br><span class="line"><span class="meta">                return obj;                                                                         \</span></span><br><span class="line"><span class="meta">            &#125;                                                                                       \</span></span><br><span class="line"><span class="meta">            ClassRegister classRegister##className(#className, createObject##className)</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test/a.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;reflect/class_register.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::reflect;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> : <span class="keyword">public</span> Object</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">A</span>() &#123;&#125;</span><br><span class="line">    ~<span class="built_in">A</span>() &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 类创建方法注册</span></span><br><span class="line"><span class="built_in">REGISTER_CLASS</span>(A);</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;reflect/class_factory.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;test/a.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::reflect;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> factory = Singleton&lt;ClassFactory&gt;::<span class="built_in">instance</span>();</span><br><span class="line">    Object * a = factory-&gt;<span class="built_in">create_class</span>(<span class="string">&quot;A&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="类成员数据反射">类成员数据反射</h2><p>类成员数据反射有一个关键问题，就是如何获取类成员数据的内存地址偏移量<code>offset</code>？这里类成员数据反射实现后提供2种方法：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> OFFSET(className, fieldName) \</span></span><br><span class="line"><span class="meta">((size_t)(&amp;((className *)0)-&gt;fieldName))</span></span><br></pre></td></tr></table></figure><p>将<code>0</code>转换为对应类的指针<code>className*</code>，然后取对应字段，如此即可获取类成员数据<code>fieldName</code>的偏移量。注意此方式可移植性很差，对不同平台支持性不够好，部分编译器对此写法不支持。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Test t;</span><br><span class="line"><span class="type">size_t</span> offset = (<span class="type">size_t</span>)(&amp;(t.member)) - (<span class="type">size_t</span>)(&amp;t);</span><br></pre></td></tr></table></figure><p>第二种方式是跨平台的，支持不同的编译器。它首先声明一个临时变量<code>t</code>，然后通过临时变量数据成员的地址<code>&amp;t.member</code>减去临时变量的地址<code>&amp;t</code>，即可得到偏移量。这种方式虽然很好理解，但是需要创建全局的临时变量。</p><p>用法演示：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> : <span class="keyword">public</span> Object</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">A</span>() &#123;&#125;</span><br><span class="line">    ~<span class="built_in">A</span>() &#123;&#125;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">    string m_name;</span><br><span class="line">    <span class="type">int</span> m_age;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 类对象反射注册宏</span></span><br><span class="line"><span class="built_in">REGISTER_CLASS</span>(A);</span><br><span class="line"><span class="comment">// 类成员数据反射注册宏</span></span><br><span class="line"><span class="built_in">REGISTER_CLASS_FIELD</span>(A, m_name, string);</span><br><span class="line"><span class="built_in">REGISTER_CLASS_FIELD</span>(A, m_age, <span class="type">int</span>);</span><br></pre></td></tr></table></figure><h3 id="类数据成员注册宏">类数据成员注册宏</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">REGISTER_CLASS_FIELD</span>(A, m_name, string);</span><br><span class="line"><span class="built_in">REGISTER_CLASS_FIELD</span>(A, m_age, <span class="type">int</span>);</span><br></pre></td></tr></table></figure><h3 id="反射用法">反射用法</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 类对象反射</span></span><br><span class="line">    <span class="keyword">auto</span> factory = Singleton&lt;ClassFactory&gt;::<span class="built_in">instance</span>();</span><br><span class="line">    <span class="comment">// 通过工厂类创建一个a对象并获取其指针</span></span><br><span class="line">    Object * a = factory-&gt;<span class="built_in">create_class</span>(<span class="string">&quot;A&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 类成员数据反射</span></span><br><span class="line">    string name;</span><br><span class="line">    <span class="comment">// 获取a对象内部的成员数据m_name</span></span><br><span class="line">    a-&gt;<span class="built_in">get_field_value</span>(<span class="string">&quot;m_name&quot;</span>, name);</span><br><span class="line">    std::cout &lt;&lt; name &lt;&lt; std::endl;</span><br><span class="line">    <span class="comment">// 根据成员数据名称m_name来设置它的值</span></span><br><span class="line">    a-&gt;<span class="built_in">set_field_value</span>(<span class="string">&quot;m_name&quot;</span>, <span class="string">&quot;kitty&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="完整实现">完整实现</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// reflect/class_factory.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility/singleton.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;reflect/class_field.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::utility;</span><br><span class="line"><span class="keyword">using</span> std::string;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> reflect</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 如果类要实现反射机制，那么它必须继承自Object</span></span><br><span class="line">        <span class="comment">// Object就是反射框架提供的基类</span></span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Object</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">Object</span>() = <span class="keyword">default</span>;</span><br><span class="line">            <span class="keyword">virtual</span> ~<span class="built_in">Object</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">set_class_name</span><span class="params">(<span class="type">const</span> string &amp; class_name)</span></span>;             <span class="comment">// 设置类的名称</span></span><br><span class="line">            <span class="function"><span class="type">const</span> string &amp; <span class="title">get_class_name</span><span class="params">()</span> <span class="type">const</span></span>;                      <span class="comment">// 获取类的名称</span></span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">get_field_count</span><span class="params">()</span></span>;                                      <span class="comment">// 获取字段的数量</span></span><br><span class="line">            <span class="function">ClassField * <span class="title">get_field</span><span class="params">(<span class="type">int</span> pos)</span></span>;                            <span class="comment">// 根据位置获取字段信息</span></span><br><span class="line">            <span class="function">ClassField * <span class="title">get_field</span><span class="params">(<span class="type">const</span> string &amp; field_name)</span></span>;          <span class="comment">// 根据字段名称获取字段信息</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取成员数据的值</span></span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">get</span><span class="params">(<span class="type">const</span> string &amp; field_name, T &amp; value)</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 设置成员数据的值</span></span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">set</span><span class="params">(<span class="type">const</span> string &amp; field_name, <span class="type">const</span> T &amp; value)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            string m_class_name;                                        <span class="comment">// 记录类的名称</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// create_object是函数指针，传入参数为空，返回类型为Object*</span></span><br><span class="line">        <span class="keyword">using</span> create_object = Object* (*)(<span class="type">void</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 工厂类</span></span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">ClassFactory</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 单例模式</span></span><br><span class="line">            <span class="built_in">SINGLETON</span>(ClassFactory);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="comment">// 类对象反射</span></span><br><span class="line">            <span class="comment">// 注册类名称关联到它的创建函数</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">register_class</span><span class="params">(<span class="type">const</span> string &amp; class_name, create_object func)</span></span>;</span><br><span class="line">            <span class="comment">// 根据类名创建对应的对象</span></span><br><span class="line">            <span class="function">Object * <span class="title">create_class</span><span class="params">(<span class="type">const</span> string &amp; name)</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 类成员数据反射</span></span><br><span class="line">            <span class="comment">// 注册类成员数据，参数依次为类名、成员数据名称、成员数据类型和它相对于类的偏移量</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">register_class_field</span><span class="params">(<span class="type">const</span> string &amp; class_name, <span class="type">const</span> string &amp; field_name, <span class="type">const</span> string &amp; field_type, <span class="type">size_t</span> offset)</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取类字段的数量</span></span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">get_class_field_count</span><span class="params">(<span class="type">const</span> string &amp; class_name)</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 根据类名和下标获取字段信息</span></span><br><span class="line">            <span class="function">ClassField * <span class="title">get_class_field</span><span class="params">(<span class="type">const</span> string &amp; class_name, <span class="type">int</span> pos)</span></span>;</span><br><span class="line">            <span class="comment">// 根据类名和字段名称获取字段信息</span></span><br><span class="line">            <span class="function">ClassField * <span class="title">get_class_field</span><span class="params">(<span class="type">const</span> string &amp; class_name, <span class="type">const</span> string &amp; field_name)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="comment">// 根据字符串创建类，m_class_map就是字符串到它类的创建函数create_object的映射</span></span><br><span class="line">            std::map&lt;string, reflect::create_object&gt; m_class_map;</span><br><span class="line">            <span class="comment">// 存储类成员数据，key为类名称，value为该类拥有的成员数据，存储所有类成员数据的信息</span></span><br><span class="line">            std::map&lt;string, std::vector&lt;ClassField*&gt;&gt; m_class_fields;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">Object::get</span><span class="params">(<span class="type">const</span> string &amp; field_name, T &amp; value)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            ClassField * field = Singleton&lt;ClassFactory&gt;::<span class="built_in">instance</span>()-&gt;<span class="built_in">get_class_field</span>(m_class_name, field_name);</span><br><span class="line">            <span class="keyword">if</span> (field == <span class="literal">nullptr</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">size_t</span> offset = field-&gt;<span class="built_in">offset</span>();</span><br><span class="line">            <span class="comment">// 这里非常巧妙</span></span><br><span class="line">            value = *((T*)((<span class="type">unsigned</span> <span class="type">char</span>*)(<span class="keyword">this</span>) + offset));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">Object::set</span><span class="params">(<span class="type">const</span> string &amp; field_name, <span class="type">const</span> T &amp; value)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            ClassField * field = Singleton&lt;ClassFactory&gt;::<span class="built_in">instance</span>()-&gt;<span class="built_in">get_class_field</span>(m_class_name, field_name);</span><br><span class="line">            <span class="keyword">if</span> (field == <span class="literal">nullptr</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">size_t</span> offset = field-&gt;<span class="built_in">offset</span>();</span><br><span class="line">            <span class="comment">// 这里非常巧妙</span></span><br><span class="line">            *((T*)((<span class="type">unsigned</span> <span class="type">char</span>*)(<span class="keyword">this</span>) + offset)) = value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// reflect/class_factory.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;reflect/class_factory.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::reflect;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Object::set_class_name</span><span class="params">(<span class="type">const</span> string &amp; class_name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_class_name = class_name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">const</span> string &amp; <span class="title">Object::get_class_name</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_class_name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Object::get_field_count</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Singleton&lt;ClassFactory&gt;::<span class="built_in">instance</span>()-&gt;<span class="built_in">get_class_field_count</span>(m_class_name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ClassField * <span class="title">Object::get_field</span><span class="params">(<span class="type">int</span> pos)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Singleton&lt;ClassFactory&gt;::<span class="built_in">instance</span>()-&gt;<span class="built_in">get_class_field</span>(m_class_name, pos);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ClassField * <span class="title">Object::get_field</span><span class="params">(<span class="type">const</span> string &amp; field_name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Singleton&lt;ClassFactory&gt;::<span class="built_in">instance</span>()-&gt;<span class="built_in">get_class_field</span>(m_class_name, field_name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ClassFactory::register_class</span><span class="params">(<span class="type">const</span> string &amp; class_name, reflect::create_object func)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_class_map[class_name] = func;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Object * <span class="title">ClassFactory::create_class</span><span class="params">(<span class="type">const</span> string &amp; class_name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> it = m_class_map.<span class="built_in">find</span>(class_name);</span><br><span class="line">    <span class="keyword">if</span> (it == m_class_map.<span class="built_in">end</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> it-&gt;<span class="built_in">second</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ClassFactory::register_class_field</span><span class="params">(<span class="type">const</span> string &amp; class_name, <span class="type">const</span> string &amp; field_name, <span class="type">const</span> string &amp; field_type, <span class="type">size_t</span> offset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_class_fields[class_name].<span class="built_in">push_back</span>(<span class="keyword">new</span> <span class="built_in">ClassField</span>(field_name, field_type, offset));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">ClassFactory::get_class_field_count</span><span class="params">(<span class="type">const</span> string &amp; class_name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">int</span>)m_class_fields[class_name].<span class="built_in">size</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">ClassField * <span class="title">ClassFactory::get_class_field</span><span class="params">(<span class="type">const</span> string &amp; class_name, <span class="type">int</span> pos)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> size = (<span class="type">int</span>)m_class_fields[class_name].<span class="built_in">size</span>();</span><br><span class="line">    <span class="keyword">if</span> (pos &lt; <span class="number">0</span> || pos &gt;= size)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> m_class_fields[class_name][pos];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ClassField * <span class="title">ClassFactory::get_class_field</span><span class="params">(<span class="type">const</span> string &amp; class_name, <span class="type">const</span> string &amp; field_name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> fields = m_class_fields[class_name];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> it = fields.<span class="built_in">begin</span>(); it != fields.<span class="built_in">end</span>(); ++it)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ((*it)-&gt;<span class="built_in">name</span>() == field_name)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> *it;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// reflect/class_register.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;reflect/class_factory.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> reflect</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 由ClassRegister类完整类创建方法的注册</span></span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">ClassRegister</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">ClassRegister</span>(<span class="type">const</span> string &amp; class_name, create_object func)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 借助辅助类ClassRegister的构造函数完成类的注册</span></span><br><span class="line">                Singleton&lt;ClassFactory&gt;::<span class="built_in">instance</span>()-&gt;<span class="built_in">register_class</span>(class_name, func);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">ClassRegister</span>(<span class="type">const</span> string &amp; class_name, <span class="type">const</span> string &amp; field_name, <span class="type">const</span> string &amp; field_type, <span class="type">size_t</span> offset)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 注册类成员数据</span></span><br><span class="line">                Singleton&lt;ClassFactory&gt;::<span class="built_in">instance</span>()-&gt;<span class="built_in">register_class_field</span>(class_name, field_name, field_type, offset);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 注册对象的宏：首先定义一个全局的函数，然后声明一个全局的变量</span></span><br><span class="line">        <span class="comment">// 在宏中使用两个#号表示字符串连接，一个#号表示将其转换为字符串</span></span><br><span class="line">        <span class="meta">#<span class="keyword">define</span> REGISTER_CLASS(className)                                                           \</span></span><br><span class="line"><span class="meta">            Object * createObject##className()                                                      \</span></span><br><span class="line"><span class="meta">            &#123;                                                                                       \</span></span><br><span class="line"><span class="meta">                Object * obj = new className();                                                     \</span></span><br><span class="line"><span class="meta">                obj-&gt;set_class_name(#className);                                                    \</span></span><br><span class="line"><span class="meta">                return obj;                                                                         \</span></span><br><span class="line"><span class="meta">            &#125;                                                                                       \</span></span><br><span class="line"><span class="meta">            ClassRegister classRegister##className(#className, createObject##className)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 注册类成员数据</span></span><br><span class="line">        <span class="meta">#<span class="keyword">define</span> REGISTER_CLASS_FIELD(className, fieldName, fieldType)                               \</span></span><br><span class="line"><span class="meta">            className className##fieldName;                                                         \</span></span><br><span class="line"><span class="meta">            ClassRegister classRegister##fieldName(#className, #fieldName, #fieldType, (size_t)&amp;(className##fieldName.fieldName) - (size_t)&amp;(className##fieldName))</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// reflect/class_field.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> std::string;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> reflect</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">ClassField</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">ClassField</span>() : <span class="built_in">m_offset</span>(<span class="number">0</span>) &#123;&#125;</span><br><span class="line">            <span class="built_in">ClassField</span>(<span class="type">const</span> string &amp; name, <span class="type">const</span> string &amp; type, <span class="type">size_t</span> offset) : <span class="built_in">m_name</span>(name), <span class="built_in">m_type</span>(type), <span class="built_in">m_offset</span>(offset) &#123;&#125;</span><br><span class="line">            ~<span class="built_in">ClassField</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="type">const</span> string &amp; <span class="title">name</span><span class="params">()</span> <span class="type">const</span> </span>&#123;<span class="keyword">return</span> m_name;&#125;                <span class="comment">// 获取成员数据的名称</span></span><br><span class="line">            <span class="function"><span class="type">const</span> string &amp; <span class="title">type</span><span class="params">()</span> <span class="type">const</span> </span>&#123;<span class="keyword">return</span> m_type;&#125;                <span class="comment">// 获取成员数据的类型</span></span><br><span class="line">            <span class="function"><span class="type">size_t</span> <span class="title">offset</span><span class="params">()</span> <span class="type">const</span> </span>&#123;<span class="keyword">return</span> m_offset;&#125;                    <span class="comment">// 获取成员数据的偏移量</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            string m_name;                                              <span class="comment">// 成员数据的名称</span></span><br><span class="line">            string m_type;                                              <span class="comment">// 成员数据的类型</span></span><br><span class="line">            <span class="type">size_t</span> m_offset;                                            <span class="comment">// 成员数据在类对象内部的偏移量</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test/a.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;reflect/class_register.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::reflect;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> : <span class="keyword">public</span> Object</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">A</span>() : <span class="built_in">m_name</span>(<span class="string">&quot;A&quot;</span>), <span class="built_in">m_age</span>(<span class="number">18</span>) &#123;&#125;</span><br><span class="line">    ~<span class="built_in">A</span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    string m_name;</span><br><span class="line">    <span class="type">int</span> m_age;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 类创建方法注册</span></span><br><span class="line"><span class="built_in">REGISTER_CLASS</span>(A);</span><br><span class="line"><span class="built_in">REGISTER_CLASS_FIELD</span>(A, m_name, string);</span><br><span class="line"><span class="built_in">REGISTER_CLASS_FIELD</span>(A, m_age, <span class="type">int</span>);</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;reflect/class_factory.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;test/a.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::reflect;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> factory = Singleton&lt;ClassFactory&gt;::<span class="built_in">instance</span>();</span><br><span class="line">    Object * a = factory-&gt;<span class="built_in">create_class</span>(<span class="string">&quot;A&quot;</span>);</span><br><span class="line"></span><br><span class="line">    string name;</span><br><span class="line">    <span class="comment">// 获取成员数据的值</span></span><br><span class="line">    a-&gt;<span class="built_in">get</span>&lt;string&gt;(<span class="string">&quot;m_name&quot;</span>, name);</span><br><span class="line">    std::cout &lt;&lt; name &lt;&lt; std::endl;</span><br><span class="line">    <span class="type">int</span> age = <span class="number">0</span>;</span><br><span class="line">    a-&gt;<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;(<span class="string">&quot;m_age&quot;</span>, age);</span><br><span class="line">    std::cout &lt;&lt; age &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置成员数据的值</span></span><br><span class="line">    a-&gt;<span class="built_in">set</span>&lt;string&gt;(<span class="string">&quot;m_name&quot;</span>, <span class="string">&quot;kitty&quot;</span>);</span><br><span class="line">    a-&gt;<span class="built_in">set</span>&lt;<span class="type">int</span>&gt;(<span class="string">&quot;m_age&quot;</span>, <span class="number">30</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取成员数据的值</span></span><br><span class="line">    a-&gt;<span class="built_in">get</span>&lt;string&gt;(<span class="string">&quot;m_name&quot;</span>, name);</span><br><span class="line">    std::cout &lt;&lt; name &lt;&lt; std::endl;</span><br><span class="line">    a-&gt;<span class="built_in">get</span>&lt;<span class="type">int</span>&gt;(<span class="string">&quot;m_age&quot;</span>, age);</span><br><span class="line">    std::cout &lt;&lt; age &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="类成员函数反射">类成员函数反射</h2><p>以下是使用类成员函数指针的示例代码，这里通过<code>std::function</code>对要调用的成员函数进行封装。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Test</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Test</span>() = <span class="keyword">default</span>;</span><br><span class="line">    ~<span class="built_in">Test</span>() = <span class="keyword">default</span>;</span><br><span class="line">   </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Test::foo&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> std::function&lt;<span class="type">void</span>(Test*)&gt; test_method;</span><br><span class="line">test_method method = &amp;Tset::f1;</span><br><span class="line"></span><br><span class="line">Test t;</span><br><span class="line"><span class="built_in">method</span>(&amp;t);</span><br></pre></td></tr></table></figure><p>但这种方式存在问题，<code>test_method</code>作为类成员函数指针，其类型是写死的，仅适用于<code>Test::foo()</code>，而不能泛化于其它类成员函数。</p><p>这个问题可以通过以下方式来解决：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uintptr_t</span> ptr = (<span class="type">uintptr_t</span>)&amp;method;</span><br><span class="line"></span><br><span class="line">(*(test_method *)(ptr))(&amp;t);</span><br></pre></td></tr></table></figure><p>先将<code>method</code>转换为无符号整型指针，在调用函数时先转换为原来的类型<code>test_method*</code>，再解引用并传入<code>this</code>指针即可。如此解决了反射时保存通用的类成员函数指针信息的问题。</p><h3 id="类成员函数注册宏">类成员函数注册宏</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">REGISTER_CLASS_METHOD</span>(A, f1, <span class="type">void</span>);</span><br><span class="line"><span class="built_in">REGISTER_CLASS_METHOD</span>(A, f2, <span class="type">int</span>, <span class="type">const</span> string &amp;);</span><br></pre></td></tr></table></figure><h3 id="反射用法">反射用法</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">nt <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 类对象反射</span></span><br><span class="line">    ClassFactory * factory = Singleton&lt;ClassFactory&gt;::<span class="built_in">instance</span>();</span><br><span class="line">    Object * a = factory-&gt;<span class="built_in">create_class</span>(<span class="string">&quot;A&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 类成员函数反射的调用</span></span><br><span class="line">    a-&gt;<span class="built_in">call</span>(<span class="string">&quot;f1&quot;</span>);</span><br><span class="line">    <span class="type">const</span> string &amp; name = <span class="string">&quot;kitty&quot;</span>;</span><br><span class="line">    <span class="type">int</span> age = <span class="number">18</span>;</span><br><span class="line">    <span class="type">int</span> ret = a-&gt;<span class="built_in">call</span>(<span class="string">&quot;f2&quot;</span>, name, age);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="完整实现">完整实现</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// reflect/class_factory.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdint&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility/singleton.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;reflect/class_field.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;reflect/class_method.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::utility;</span><br><span class="line"><span class="keyword">using</span> std::string;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> reflect</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 如果类要实现反射机制，那么它必须继承自Object</span></span><br><span class="line">        <span class="comment">// Object就是反射框架提供的基类</span></span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Object</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">Object</span>() = <span class="keyword">default</span>;</span><br><span class="line">            <span class="keyword">virtual</span> ~<span class="built_in">Object</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">set_class_name</span><span class="params">(<span class="type">const</span> string &amp; class_name)</span></span>;             <span class="comment">// 设置类的名称</span></span><br><span class="line">            <span class="function"><span class="type">const</span> string &amp; <span class="title">get_class_name</span><span class="params">()</span> <span class="type">const</span></span>;                      <span class="comment">// 获取类的名称</span></span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">get_field_count</span><span class="params">()</span></span>;                                      <span class="comment">// 获取字段的数量</span></span><br><span class="line">            <span class="function">ClassField * <span class="title">get_field</span><span class="params">(<span class="type">int</span> pos)</span></span>;                            <span class="comment">// 根据位置获取字段信息</span></span><br><span class="line">            <span class="function">ClassField * <span class="title">get_field</span><span class="params">(<span class="type">const</span> string &amp; field_name)</span></span>;          <span class="comment">// 根据字段名称获取字段信息</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取成员数据的值</span></span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">get</span><span class="params">(<span class="type">const</span> string &amp; field_name, T &amp; value)</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 设置成员数据的值</span></span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">set</span><span class="params">(<span class="type">const</span> string &amp; field_name, <span class="type">const</span> T &amp; value)</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 类成员函数的调用</span></span><br><span class="line">            <span class="comment">// R为类成员函数的返回值类型，默认为void，类成员函数参数为可变参数，为了更好的兼容性，可变参数为右值引用</span></span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> R = <span class="type">void</span>, <span class="keyword">typename</span> ...Args&gt;</span><br><span class="line">            R <span class="built_in">call</span>(<span class="type">const</span> string &amp; method_name, Args&amp;&amp;... args);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            string m_class_name;                                        <span class="comment">// 记录类的名称</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// create_object是函数指针，传入参数为空，返回类型为Object*</span></span><br><span class="line">        <span class="keyword">using</span> create_object = Object* (*)(<span class="type">void</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 工厂类</span></span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">ClassFactory</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 单例模式</span></span><br><span class="line">            <span class="built_in">SINGLETON</span>(ClassFactory);</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="comment">// 类对象反射</span></span><br><span class="line">            <span class="comment">// 注册类名称关联到它的创建函数</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">register_class</span><span class="params">(<span class="type">const</span> string &amp; class_name, create_object func)</span></span>;</span><br><span class="line">            <span class="comment">// 根据类名创建对应的对象</span></span><br><span class="line">            <span class="function">Object * <span class="title">create_class</span><span class="params">(<span class="type">const</span> string &amp; name)</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 类成员数据反射</span></span><br><span class="line">            <span class="comment">// 注册类成员数据，参数依次为类名、成员数据名称、成员数据类型和它相对于类的偏移量</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">register_class_field</span><span class="params">(<span class="type">const</span> string &amp; class_name, <span class="type">const</span> string &amp; field_name, <span class="type">const</span> string &amp; field_type, <span class="type">size_t</span> offset)</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取类字段的数量</span></span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">get_class_field_count</span><span class="params">(<span class="type">const</span> string &amp; class_name)</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 根据类名和下标获取字段信息</span></span><br><span class="line">            <span class="function">ClassField * <span class="title">get_class_field</span><span class="params">(<span class="type">const</span> string &amp; class_name, <span class="type">int</span> pos)</span></span>;</span><br><span class="line">            <span class="comment">// 根据类名和字段名称获取字段信息</span></span><br><span class="line">            <span class="function">ClassField * <span class="title">get_class_field</span><span class="params">(<span class="type">const</span> string &amp; class_name, <span class="type">const</span> string &amp; field_name)</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 注册类成员函数，参数依次为类名、类成员函数名和类成员函数指针</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">register_class_method</span><span class="params">(<span class="type">const</span> string &amp; class_name, <span class="type">const</span> string &amp; method_name, <span class="type">uintptr_t</span> method)</span></span>;</span><br><span class="line">            <span class="comment">// 根据类名获取该类有多少个成员函数</span></span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">get_class_method_count</span><span class="params">(<span class="type">const</span> string &amp; class_name)</span></span>;</span><br><span class="line">            <span class="comment">// 根据类名和下标获取类成员函数</span></span><br><span class="line">            <span class="function">ClassMethod * <span class="title">get_class_method</span><span class="params">(<span class="type">const</span> string &amp; class_name, <span class="type">int</span> pos)</span></span>;</span><br><span class="line">            <span class="comment">// 根据类名和类成员函数名获取类成员函数</span></span><br><span class="line">            <span class="function">ClassMethod * <span class="title">get_class_method</span><span class="params">(<span class="type">const</span> string &amp; class_name, <span class="type">const</span> string &amp; method_name)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="comment">// 根据字符串创建类，m_class_map就是字符串到它类的创建函数create_object的映射</span></span><br><span class="line">            std::map&lt;string, reflect::create_object&gt; m_class_map;</span><br><span class="line">            <span class="comment">// 存储类成员数据，key为类名称，value为该类拥有的成员数据，存储所有类成员数据的信息</span></span><br><span class="line">            std::map&lt;string, std::vector&lt;ClassField*&gt;&gt; m_class_fields;</span><br><span class="line">            <span class="comment">// 存储类对应的类成员函数</span></span><br><span class="line">            std::map&lt;string, std::vector&lt;ClassMethod*&gt;&gt; m_class_methods;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">Object::get</span><span class="params">(<span class="type">const</span> string &amp; field_name, T &amp; value)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            ClassField * field = Singleton&lt;ClassFactory&gt;::<span class="built_in">instance</span>()-&gt;<span class="built_in">get_class_field</span>(m_class_name, field_name);</span><br><span class="line">            <span class="keyword">if</span> (field == <span class="literal">nullptr</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">size_t</span> offset = field-&gt;<span class="built_in">offset</span>();</span><br><span class="line">            <span class="comment">// 这里非常巧妙</span></span><br><span class="line">            value = *((T*)((<span class="type">unsigned</span> <span class="type">char</span>*)(<span class="keyword">this</span>) + offset));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">Object::set</span><span class="params">(<span class="type">const</span> string &amp; field_name, <span class="type">const</span> T &amp; value)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            ClassField * field = Singleton&lt;ClassFactory&gt;::<span class="built_in">instance</span>()-&gt;<span class="built_in">get_class_field</span>(m_class_name, field_name);</span><br><span class="line">            <span class="keyword">if</span> (field == <span class="literal">nullptr</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">size_t</span> offset = field-&gt;<span class="built_in">offset</span>();</span><br><span class="line">            <span class="comment">// 这里非常巧妙</span></span><br><span class="line">            *((T*)((<span class="type">unsigned</span> <span class="type">char</span>*)(<span class="keyword">this</span>) + offset)) = value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> R, <span class="keyword">typename</span> ...Args&gt;</span><br><span class="line">        <span class="function">R <span class="title">Object::call</span><span class="params">(<span class="type">const</span> string &amp; method_name, Args&amp;&amp;... args)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            ClassFactory * factory = Singleton&lt;ClassFactory&gt;::<span class="built_in">instance</span>();</span><br><span class="line">            ClassMethod * method = factory-&gt;<span class="built_in">get_class_method</span>(m_class_name, method_name);</span><br><span class="line">            <span class="keyword">if</span> (method == <span class="literal">nullptr</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 如果无法取得类成员函数指针，就返回默认的返回值</span></span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">R</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">auto</span> func = method-&gt;<span class="built_in">method</span>();</span><br><span class="line">            <span class="comment">// 函数指针的运行时定义</span></span><br><span class="line">            <span class="comment">// decltype(this)获取类的运行时类型</span></span><br><span class="line">            <span class="keyword">typedef</span> std::function&lt;R(<span class="keyword">decltype</span>(<span class="keyword">this</span>), Args...)&gt; class_method;</span><br><span class="line">            <span class="comment">// 先将func转换为class_method*类型，然后解引用，接着调用</span></span><br><span class="line">            <span class="keyword">return</span> (*((class_method *)func))(<span class="keyword">this</span>, args...);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// reflect/class_factory.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;reflect/class_factory.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::reflect;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Object::set_class_name</span><span class="params">(<span class="type">const</span> string &amp; class_name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_class_name = class_name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">const</span> string &amp; <span class="title">Object::get_class_name</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_class_name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Object::get_field_count</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Singleton&lt;ClassFactory&gt;::<span class="built_in">instance</span>()-&gt;<span class="built_in">get_class_field_count</span>(m_class_name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ClassField * <span class="title">Object::get_field</span><span class="params">(<span class="type">int</span> pos)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Singleton&lt;ClassFactory&gt;::<span class="built_in">instance</span>()-&gt;<span class="built_in">get_class_field</span>(m_class_name, pos);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ClassField * <span class="title">Object::get_field</span><span class="params">(<span class="type">const</span> string &amp; field_name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Singleton&lt;ClassFactory&gt;::<span class="built_in">instance</span>()-&gt;<span class="built_in">get_class_field</span>(m_class_name, field_name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ClassFactory::register_class</span><span class="params">(<span class="type">const</span> string &amp; class_name, reflect::create_object func)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_class_map[class_name] = func;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Object * <span class="title">ClassFactory::create_class</span><span class="params">(<span class="type">const</span> string &amp; class_name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> it = m_class_map.<span class="built_in">find</span>(class_name);</span><br><span class="line">    <span class="keyword">if</span> (it == m_class_map.<span class="built_in">end</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> it-&gt;<span class="built_in">second</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ClassFactory::register_class_field</span><span class="params">(<span class="type">const</span> string &amp; class_name, <span class="type">const</span> string &amp; field_name, <span class="type">const</span> string &amp; field_type, <span class="type">size_t</span> offset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_class_fields[class_name].<span class="built_in">push_back</span>(<span class="keyword">new</span> <span class="built_in">ClassField</span>(field_name, field_type, offset));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">ClassFactory::get_class_field_count</span><span class="params">(<span class="type">const</span> string &amp; class_name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">int</span>)m_class_fields[class_name].<span class="built_in">size</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">ClassField * <span class="title">ClassFactory::get_class_field</span><span class="params">(<span class="type">const</span> string &amp; class_name, <span class="type">int</span> pos)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> size = (<span class="type">int</span>)m_class_fields[class_name].<span class="built_in">size</span>();</span><br><span class="line">    <span class="keyword">if</span> (pos &lt; <span class="number">0</span> || pos &gt;= size)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> m_class_fields[class_name][pos];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ClassField * <span class="title">ClassFactory::get_class_field</span><span class="params">(<span class="type">const</span> string &amp; class_name, <span class="type">const</span> string &amp; field_name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> &amp; fields = m_class_fields[class_name];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> it = fields.<span class="built_in">begin</span>(); it != fields.<span class="built_in">end</span>(); ++it)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ((*it)-&gt;<span class="built_in">name</span>() == field_name)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> *it;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ClassFactory::register_class_method</span><span class="params">(<span class="type">const</span> string &amp; class_name, <span class="type">const</span> string &amp; method_name, <span class="type">uintptr_t</span> method)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_class_methods[class_name].<span class="built_in">push_back</span>(<span class="keyword">new</span> <span class="built_in">ClassMethod</span>(method_name, method));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">ClassFactory::get_class_method_count</span><span class="params">(<span class="type">const</span> string &amp; class_name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">int</span>)m_class_methods[class_name].<span class="built_in">size</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ClassMethod * <span class="title">ClassFactory::get_class_method</span><span class="params">(<span class="type">const</span> string &amp; class_name, <span class="type">int</span> pos)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> size = (<span class="type">int</span>)m_class_methods[class_name].<span class="built_in">size</span>();</span><br><span class="line">    <span class="keyword">if</span> (pos &lt; <span class="number">0</span> || pos &gt;= size)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> m_class_methods[class_name][pos];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ClassMethod * <span class="title">ClassFactory::get_class_method</span><span class="params">(<span class="type">const</span> string &amp; class_name, <span class="type">const</span> string &amp; method_name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> &amp; methods = m_class_methods[class_name];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> it = methods.<span class="built_in">begin</span>(); it != methods.<span class="built_in">end</span>(); ++it)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ((*it)-&gt;<span class="built_in">name</span>() == method_name)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> *it;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// reflect/class_field.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> std::string;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> reflect</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">ClassField</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">ClassField</span>() : <span class="built_in">m_offset</span>(<span class="number">0</span>) &#123;&#125;</span><br><span class="line">            <span class="built_in">ClassField</span>(<span class="type">const</span> string &amp; name, <span class="type">const</span> string &amp; type, <span class="type">size_t</span> offset) : <span class="built_in">m_name</span>(name), <span class="built_in">m_type</span>(type), <span class="built_in">m_offset</span>(offset) &#123;&#125;</span><br><span class="line">            ~<span class="built_in">ClassField</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="type">const</span> string &amp; <span class="title">name</span><span class="params">()</span> <span class="type">const</span> </span>&#123;<span class="keyword">return</span> m_name;&#125;                <span class="comment">// 获取成员数据的名称</span></span><br><span class="line">            <span class="function"><span class="type">const</span> string &amp; <span class="title">type</span><span class="params">()</span> <span class="type">const</span> </span>&#123;<span class="keyword">return</span> m_type;&#125;                <span class="comment">// 获取成员数据的类型</span></span><br><span class="line">            <span class="function"><span class="type">size_t</span> <span class="title">offset</span><span class="params">()</span> <span class="type">const</span> </span>&#123;<span class="keyword">return</span> m_offset;&#125;                    <span class="comment">// 获取成员数据的偏移量</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            string m_name;                                              <span class="comment">// 成员数据的名称</span></span><br><span class="line">            string m_type;                                              <span class="comment">// 成员数据的类型</span></span><br><span class="line">            <span class="type">size_t</span> m_offset;                                            <span class="comment">// 成员数据在类对象内部的偏移量</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// reflect/class_method.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> std::string;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> reflect</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">ClassMethod</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">ClassMethod</span>() : <span class="built_in">m_method</span>(<span class="number">0</span>) &#123;&#125;</span><br><span class="line">            <span class="built_in">ClassMethod</span>(<span class="type">const</span> string &amp; name, <span class="type">uintptr_t</span> method) : <span class="built_in">m_name</span>(name), <span class="built_in">m_method</span>(method) &#123;&#125;</span><br><span class="line">            ~<span class="built_in">ClassMethod</span>() = <span class="keyword">default</span>;</span><br><span class="line">        </span><br><span class="line">            <span class="function"><span class="type">const</span> string &amp; <span class="title">name</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> m_name;&#125;</span><br><span class="line">            <span class="function"><span class="type">uintptr_t</span> <span class="title">method</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> m_method;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            string m_name;                              <span class="comment">// 函数名称</span></span><br><span class="line">            <span class="type">uintptr_t</span> m_method;                         <span class="comment">// 类成员函数指针</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// reflect/class_register.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;reflect/class_factory.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> reflect</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 由ClassRegister类完整类创建方法的注册</span></span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">ClassRegister</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">ClassRegister</span>(<span class="type">const</span> string &amp; class_name, create_object func)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 借助辅助类ClassRegister的构造函数完成类的注册</span></span><br><span class="line">                Singleton&lt;ClassFactory&gt;::<span class="built_in">instance</span>()-&gt;<span class="built_in">register_class</span>(class_name, func);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">ClassRegister</span>(<span class="type">const</span> string &amp; class_name, <span class="type">const</span> string &amp; field_name, <span class="type">const</span> string &amp; field_type, <span class="type">size_t</span> offset)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 注册类成员数据</span></span><br><span class="line">                Singleton&lt;ClassFactory&gt;::<span class="built_in">instance</span>()-&gt;<span class="built_in">register_class_field</span>(class_name, field_name, field_type, offset);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">ClassRegister</span>(<span class="type">const</span> string &amp; class_name, <span class="type">const</span> string &amp; method_name, <span class="type">uintptr_t</span> method)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 注册类成员函数</span></span><br><span class="line">                <span class="comment">// class_name为类名，method_name为类成员函数名，method为类成员函数指针</span></span><br><span class="line">                Singleton&lt;ClassFactory&gt;::<span class="built_in">instance</span>()-&gt;<span class="built_in">register_class_method</span>(class_name, method_name, method);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 注册对象的宏：首先定义一个全局的函数，然后声明一个全局的变量</span></span><br><span class="line">        <span class="comment">// 在宏中使用两个#号表示字符串连接，一个#号表示将其转换为字符串</span></span><br><span class="line">        <span class="meta">#<span class="keyword">define</span> REGISTER_CLASS(className)                                                           \</span></span><br><span class="line"><span class="meta">            Object * createObject##className()                                                      \</span></span><br><span class="line"><span class="meta">            &#123;                                                                                       \</span></span><br><span class="line"><span class="meta">                Object * obj = new className();                                                     \</span></span><br><span class="line"><span class="meta">                obj-&gt;set_class_name(#className);                                                    \</span></span><br><span class="line"><span class="meta">                return obj;                                                                         \</span></span><br><span class="line"><span class="meta">            &#125;                                                                                       \</span></span><br><span class="line"><span class="meta">            ClassRegister classRegister##className(#className, createObject##className)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 注册类成员数据的宏</span></span><br><span class="line">        <span class="meta">#<span class="keyword">define</span> REGISTER_CLASS_FIELD(className, fieldName, fieldType)                               \</span></span><br><span class="line"><span class="meta">            className className##fieldName;                                                         \</span></span><br><span class="line"><span class="meta">            ClassRegister classRegister##fieldName(#className, #fieldName, #fieldType, (size_t)&amp;(className##fieldName.fieldName) - (size_t)&amp;(className##fieldName))</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 注册类成员函数的宏</span></span><br><span class="line">        <span class="comment">// className为类名，methodName为类成员函数名，returnType为类成员函数返回类型，...可变参数为类成员函数参数</span></span><br><span class="line">        <span class="comment">// ##__VA_ARGS__是将可变参数拼接起来</span></span><br><span class="line">        <span class="meta">#<span class="keyword">define</span> REGISTER_CLASS_METHOD(className, methodName, returnType, ...)                                                   \</span></span><br><span class="line"><span class="meta">            std::function<span class="string">&lt;returnType(className *, ##__VA_ARGS__)&gt;</span> className##methodName##method = &amp;className::methodName;       \</span></span><br><span class="line"><span class="meta">            ClassRegister classRegister##className##className##methodName(#className, #methodName, (uintptr_t)&amp;(className##methodName##method))</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test/a.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;reflect/class_register.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::reflect;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> : <span class="keyword">public</span> Object</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">A</span>() : <span class="built_in">m_name</span>(<span class="string">&quot;A&quot;</span>), <span class="built_in">m_age</span>(<span class="number">18</span>) &#123;&#125;</span><br><span class="line">    ~<span class="built_in">A</span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">f1</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;f1&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">f2</span><span class="params">(<span class="type">const</span> string &amp; name, <span class="type">int</span> age)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;f2&quot;</span> &lt;&lt; <span class="string">&quot;: name = &quot;</span> &lt;&lt; name &lt;&lt; <span class="string">&quot;, age = &quot;</span> &lt;&lt; age &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    string m_name;</span><br><span class="line">    <span class="type">int</span> m_age;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 类创建方法注册</span></span><br><span class="line"><span class="built_in">REGISTER_CLASS</span>(A);</span><br><span class="line"><span class="built_in">REGISTER_CLASS_FIELD</span>(A, m_name, string);</span><br><span class="line"><span class="built_in">REGISTER_CLASS_FIELD</span>(A, m_age, <span class="type">int</span>);</span><br><span class="line"><span class="built_in">REGISTER_CLASS_METHOD</span>(A, f1, <span class="type">void</span>);</span><br><span class="line"><span class="built_in">REGISTER_CLASS_METHOD</span>(A, f2, <span class="type">int</span>, <span class="type">const</span> string &amp;, <span class="type">int</span>);</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;reflect/class_factory.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;test/a.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::reflect;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> factory = Singleton&lt;ClassFactory&gt;::<span class="built_in">instance</span>();</span><br><span class="line">    Object * a = factory-&gt;<span class="built_in">create_class</span>(<span class="string">&quot;A&quot;</span>);</span><br><span class="line"></span><br><span class="line">    a-&gt;<span class="built_in">call</span>(<span class="string">&quot;f1&quot;</span>);</span><br><span class="line">    <span class="type">const</span> string &amp; name = <span class="string">&quot;kitty&quot;</span>;</span><br><span class="line">    <span class="type">int</span> age = <span class="number">18</span>;</span><br><span class="line">    <span class="type">int</span> ret = a-&gt;<span class="built_in">call</span>&lt;<span class="type">int</span>&gt;(<span class="string">&quot;f2&quot;</span>, name, age);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> C++后端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>timer定时器</title>
      <link href="/2024/06/14/timer%E5%AE%9A%E6%97%B6%E5%99%A8/"/>
      <url>/2024/06/14/timer%E5%AE%9A%E6%97%B6%E5%99%A8/</url>
      
        <content type="html"><![CDATA[<h1 id="c-timer定时器">C++ Timer定时器</h1><h2 id="目标">目标</h2><ol><li>轻量级</li><li>高精度：毫米级</li><li>跨平台：支持Linux、Windows、Mac OS等</li><li>实现简单，使用方便</li></ol><h2 id="基于多线程触发的timer实现">基于多线程触发的Timer实现</h2><p>在基于多线程触发的定时器实现中，每个定时任务都会分配一条线程，由该线程执行定时任务。在线程中通过<code>sleep()</code>类似函数达成定时任务延迟执行的效果。</p><h3 id="start在指定的毫秒数后调用函数">start在指定的毫秒数后调用函数</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> F, <span class="keyword">typename</span>... Args&gt;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Timer::start</span><span class="params">(<span class="type">int</span> millisecond, F &amp;&amp; f, Args&amp;&amp;... args)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_active.<span class="built_in">load</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 如果当前定时任务已激活则直接返回</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 第一次激活该定时任务</span></span><br><span class="line">    m_period = millisecond;</span><br><span class="line">    <span class="comment">// 由于m_func是函数对象function，返回值为空参数也为空，这里通过std::bind()进行一下封装，统一起来</span></span><br><span class="line">    m_func = std::<span class="built_in">bind</span>(std::forward&lt;F&gt;(f), std::forward&lt;Args&gt;(args)...);</span><br><span class="line">    m_active.<span class="built_in">store</span>(<span class="literal">true</span>);</span><br><span class="line">    m_thread = std::<span class="built_in">thread</span>([&amp;]()&#123;</span><br><span class="line">        <span class="keyword">if</span> (m_repeat &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 无限触发</span></span><br><span class="line">            <span class="keyword">while</span> (m_active.<span class="built_in">load</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">milliseconds</span>(m_period));</span><br><span class="line">                <span class="keyword">if</span> (!m_active.<span class="built_in">load</span>())</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">m_func</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 触发次数有限</span></span><br><span class="line">            <span class="keyword">while</span> (m_repeat &gt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (!m_active.<span class="built_in">load</span>())</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">milliseconds</span>(m_period));</span><br><span class="line">                <span class="keyword">if</span> (!m_active.<span class="built_in">load</span>())</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">m_func</span>();</span><br><span class="line">                m_repeat--;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 将创建出来的线程与主线程分离</span></span><br><span class="line">    m_thread.<span class="built_in">detach</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="stop关闭定时器">stop关闭定时器</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Timer::stop</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_active.<span class="built_in">store</span>(<span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="完整实现">完整实现</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// utility/timer.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;atomic&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> utility</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Timer</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">Timer</span>();</span><br><span class="line">            <span class="built_in">Timer</span>(<span class="type">int</span> repeat);</span><br><span class="line">            ~<span class="built_in">Timer</span>();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 启动一个定时任务</span></span><br><span class="line">            <span class="comment">// millisecond为定时任务的触发周期，单位毫秒ms;F为定时执行的函数;args为F需要的参数</span></span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> F, <span class="keyword">typename</span>... Args&gt;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">start</span><span class="params">(<span class="type">int</span> millisecond, F &amp;&amp; func, Args&amp;&amp;... args)</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 关闭一个定时任务</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">stop</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            std::thread m_thread;                       <span class="comment">// 执行定时任务的线程</span></span><br><span class="line">            std::atomic&lt;<span class="type">bool</span>&gt; m_active;                 <span class="comment">// 该原子变量表示当前定时任务是否在运行</span></span><br><span class="line">            std::function&lt;<span class="type">void</span>()&gt; m_func;               <span class="comment">// 该函数对象存储定时任务</span></span><br><span class="line">            <span class="type">int</span> m_period;                               <span class="comment">// 定时器执行的周期，单位毫秒ms</span></span><br><span class="line">            <span class="type">int</span> m_repeat;                               <span class="comment">// 定时器触发次数，-1表示无限触发</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> F, <span class="keyword">typename</span>... Args&gt;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">Timer::start</span><span class="params">(<span class="type">int</span> millisecond, F &amp;&amp; f, Args&amp;&amp;... args)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (m_active.<span class="built_in">load</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 如果当前定时任务已激活则直接返回</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 第一次激活该定时任务</span></span><br><span class="line">            m_period = millisecond;</span><br><span class="line">            <span class="comment">// 由于m_func是函数对象function，返回值为空参数也为空，这里通过std::bind()进行一下封装，统一起来</span></span><br><span class="line">            m_func = std::<span class="built_in">bind</span>(std::forward&lt;F&gt;(f), std::forward&lt;Args&gt;(args)...);</span><br><span class="line">            m_active.<span class="built_in">store</span>(<span class="literal">true</span>);</span><br><span class="line">            m_thread = std::<span class="built_in">thread</span>([&amp;]()&#123;</span><br><span class="line">                <span class="keyword">if</span> (m_repeat &lt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 无限触发</span></span><br><span class="line">                    <span class="keyword">while</span> (m_active.<span class="built_in">load</span>())</span><br><span class="line">                    &#123;</span><br><span class="line">                        std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">milliseconds</span>(m_period));</span><br><span class="line">                        <span class="keyword">if</span> (!m_active.<span class="built_in">load</span>())</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="built_in">m_func</span>();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 触发次数有限</span></span><br><span class="line">                    <span class="keyword">while</span> (m_repeat &gt; <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!m_active.<span class="built_in">load</span>())</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">milliseconds</span>(m_period));</span><br><span class="line">                        <span class="keyword">if</span> (!m_active.<span class="built_in">load</span>())</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="built_in">m_func</span>();</span><br><span class="line">                        m_repeat--;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="comment">// 将创建出来的线程与主线程分离</span></span><br><span class="line">            m_thread.<span class="built_in">detach</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// utility/timer.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility/timer.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::utility;</span><br><span class="line"></span><br><span class="line">Timer::<span class="built_in">Timer</span>() : <span class="built_in">m_active</span>(<span class="literal">false</span>), <span class="built_in">m_period</span>(<span class="number">0</span>), <span class="built_in">m_repeat</span>(<span class="number">-1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// repeat = -1表示定时器无限次触发</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Timer::<span class="built_in">Timer</span>(<span class="type">int</span> repeat) : <span class="built_in">m_active</span>(<span class="literal">false</span>), <span class="built_in">m_period</span>(<span class="number">0</span>), <span class="built_in">m_repeat</span>(repeat)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Timer::~<span class="built_in">Timer</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">stop</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Timer::stop</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_active.<span class="built_in">store</span>(<span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility/timer.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::utility;</span><br><span class="line"><span class="keyword">using</span> std::string;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;foo&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">bar</span><span class="params">(<span class="type">const</span> string &amp; name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;bar: &quot;</span> &lt;&lt; name &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">Timer <span class="title">t1</span><span class="params">(<span class="number">2</span>)</span></span>;</span><br><span class="line">    t1.<span class="built_in">start</span>(<span class="number">1000</span>, foo);</span><br><span class="line"></span><br><span class="line">    <span class="function">Timer <span class="title">t2</span><span class="params">(<span class="number">3</span>)</span></span>;</span><br><span class="line">    t2.<span class="built_in">start</span>(<span class="number">1500</span>, bar, <span class="string">&quot;kitty&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 阻塞等待输入，保持程序运行</span></span><br><span class="line">    std::<span class="built_in">getchar</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>基于多线程触发的定时器实现存在两个问题：</p><ol><li>每个定时器会创建1个线程去执行定时任务，定时器创建过多，则必然也会创建很多线程。而线程是属于系统资源，大量线程间的切换开销也会比较高</li><li>基于多线程触发的定时器虽然精度是毫秒级别，但是在触发周期上是有偏差的，因为要考虑定时器执行函数的时间开销。例如<code>Timer::start()</code>中<code>sleep</code>1秒，<code>m_func()</code>执行需要10毫秒，那么触发周期是达不到精确的1秒</li></ol><h2 id="基于时间线触发的timer实现">基于时间线触发的Timer实现</h2><p>基于时间线触发的定时器的实现思路：每个定时器都有一个触发执行的时间点，把这些不同的定时器按照触发时间点先后存入一个有序的结构中，然后遍历该有序结构，触发时间点越早的会放置在更前面以便被更早触发。</p><p>基于时间线触发的定时器实现是基于单线程而非多线程的，对于系统资源消耗很小。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// timer/timer.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> timer</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Timer</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">TimerManager</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">Timer</span>();</span><br><span class="line">            <span class="built_in">Timer</span>(<span class="type">int</span> repeat);</span><br><span class="line">            ~<span class="built_in">Timer</span>();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 触发定时任务执行的函数(即注册一个函数到定时任务中)</span></span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> F, <span class="keyword">typename</span>... Args&gt;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">callback</span><span class="params">(<span class="type">int</span> milliseconds, F &amp;&amp; f, Args&amp;&amp;... args)</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 定时器触发执行的函数</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">on_timer</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="function"><span class="type">static</span> <span class="type">int64_t</span> <span class="title">now</span><span class="params">()</span></span>;                   <span class="comment">// 返回当前时间戳，以毫秒ms为单位</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="type">int64_t</span> m_time;                         <span class="comment">// 定时器触发的时间点，单位毫秒ms</span></span><br><span class="line">            std::function&lt;<span class="type">void</span>()&gt; m_func;           <span class="comment">// 定时器触发时执行的函数</span></span><br><span class="line">            <span class="type">int</span> m_period;                           <span class="comment">// 定时器触发的周期，单位毫秒ms</span></span><br><span class="line">            <span class="type">int</span> m_repeat;                           <span class="comment">// 定时器触发的次数，-1为无限触发</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> F, <span class="keyword">typename</span>... Args&gt;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">Timer::callback</span><span class="params">(<span class="type">int</span> milliseconds, F &amp;&amp; f, Args&amp;&amp;... args)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            m_period = milliseconds;</span><br><span class="line">            <span class="comment">// 使用forward将函数和参数原封不动地进行转发</span></span><br><span class="line">            m_func = std::<span class="built_in">bind</span>(std::forward&lt;F&gt;(f), std::forward&lt;Args&gt;(args)...);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// timer/timer.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;timer/timer.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::timer;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 默认构造时定时器无限触发</span></span><br><span class="line">Timer::<span class="built_in">Timer</span>() : <span class="built_in">m_period</span>(<span class="number">0</span>), <span class="built_in">m_repeat</span>(<span class="number">-1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    m_time = <span class="built_in">now</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Timer::<span class="built_in">Timer</span>(<span class="type">int</span> repeat) : <span class="built_in">m_period</span>(<span class="number">0</span>), <span class="built_in">m_repeat</span>(repeat)</span><br><span class="line">&#123;</span><br><span class="line">    m_time = <span class="built_in">now</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Timer::~<span class="built_in">Timer</span>()</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int64_t</span> <span class="title">Timer::now</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 获取当前时间戳</span></span><br><span class="line">    <span class="keyword">auto</span> now = std::chrono::system_clock::<span class="built_in">now</span>();</span><br><span class="line">    <span class="comment">// 将时间戳转换为毫秒数</span></span><br><span class="line">    <span class="keyword">auto</span> now_ms = std::chrono::<span class="built_in">time_point_cast</span>&lt;std::chrono::milliseconds&gt;(now);</span><br><span class="line">    <span class="keyword">return</span> now_ms.<span class="built_in">time_since_epoch</span>().<span class="built_in">count</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Timer::on_timer</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!m_func || m_repeat == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">m_func</span>();</span><br><span class="line">    m_time += m_period;</span><br><span class="line">    <span class="keyword">if</span> (m_repeat &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        m_repeat--;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>定时器<code>Timer</code>的管理是由<code>TimerManager</code>类负责的，<code>TimerManager</code>全局唯一，因此可以用单例模式实现：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// timer/timer_manager.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;timer/timer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility/singleton.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::utility;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> timer</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// TimerManager类管理所有注册的Timer定时器</span></span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">TimerManager</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 单例模式</span></span><br><span class="line">            <span class="built_in">SINGLETON</span>(TimerManager);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="comment">// 注册一个Timer定时器到TimerManager类中</span></span><br><span class="line">            <span class="comment">// milliseconds为定时器触发周期，F为触发时执行的函数，args为F的参数</span></span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> F, <span class="keyword">typename</span>... Args&gt;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">schedule</span><span class="params">(<span class="type">int</span> milliseconds, F &amp;&amp; f, Args&amp;&amp;... args)</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// repeat为定时器函数的触发次数</span></span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> F, <span class="keyword">typename</span>... Args&gt;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">schedule</span><span class="params">(<span class="type">int</span> milliseconds, <span class="type">int</span> repeat, F &amp;&amp; f, Args&amp;&amp;... args)</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">update</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="comment">// multimap允许key重复，key其实就是Timer定时器下一次触发的时间点</span></span><br><span class="line">            std::multimap&lt;<span class="type">int64_t</span>, Timer&gt; m_timers;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> F, <span class="keyword">typename</span>... Args&gt;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">TimerManager::schedule</span><span class="params">(<span class="type">int</span> milliseconds, F &amp;&amp; f, Args&amp;&amp;... args)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="built_in">schedule</span>(milliseconds, <span class="number">-1</span>, std::forward&lt;F&gt;(f), std::forward&lt;Args&gt;(args)...);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> F, <span class="keyword">typename</span>... Args&gt;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">TimerManager::schedule</span><span class="params">(<span class="type">int</span> milliseconds, <span class="type">int</span> repeat, F &amp;&amp; f, Args&amp;&amp;... args)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="function">Timer <span class="title">t</span><span class="params">(repeat)</span></span>;</span><br><span class="line">            <span class="comment">// 注册一个定时任务</span></span><br><span class="line">            t.<span class="built_in">callback</span>(milliseconds, std::forward&lt;F&gt;(f), std::forward&lt;Args&gt;(args)...);</span><br><span class="line">            m_timers.<span class="built_in">insert</span>(std::<span class="built_in">make_pair</span>(t.m_time, t));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// timer/timer_manager.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;timer/timer_manager.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::timer;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">TimerManager::update</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_timers.<span class="built_in">empty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 如果multimap为空，则说明没有定时任务，直接返回即可</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int64_t</span> now = Timer::<span class="built_in">now</span>();</span><br><span class="line">    <span class="comment">// 从前向后遍历multimap，key越小的在前面，这样更早会被触发的定时器会先被遍历</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> it = m_timers.<span class="built_in">begin</span>(); it != m_timers.<span class="built_in">end</span>();)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (it-&gt;first &gt; now)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 该定时器还未到达触发的时间点，其后面的定时器也必然未达到触发的时间点</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        it-&gt;second.<span class="built_in">on_timer</span>();</span><br><span class="line">        <span class="comment">// 定时器触发后会刷新下一次触发的时间点，那么也要在multimap中更新它</span></span><br><span class="line">        Timer t = it-&gt;second;</span><br><span class="line">        it = m_timers.<span class="built_in">erase</span>(it);</span><br><span class="line">        <span class="keyword">if</span> (t.m_repeat != <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">auto</span> new_it = m_timers.<span class="built_in">insert</span>(std::<span class="built_in">make_pair</span>(t.m_time, t));</span><br><span class="line">            <span class="keyword">if</span> (it == m_timers.<span class="built_in">end</span>() || new_it-&gt;first &lt; it-&gt;first)</span><br><span class="line">            &#123;</span><br><span class="line">                it = new_it;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>基于时间线触发的定时器实现的用法也很简单，先获取<code>TimerManager</code>实例对象，然后调用<code>schedule()</code>注册定时任务，在<code>while(true)</code>循环中触发这些定时任务。在实践中，这个<code>while(true)</code>循环会放到一个单独的子线程中去执行。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;timer/timer_manager.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::timer;</span><br><span class="line"><span class="keyword">using</span> std::string;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;foo&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">bar</span><span class="params">(<span class="type">const</span> string &amp; name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;bar: &quot;</span> &lt;&lt; name &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> mgr = Singleton&lt;TimerManager&gt;::<span class="built_in">instance</span>();</span><br><span class="line">    mgr-&gt;<span class="built_in">schedule</span>(<span class="number">1000</span>, foo);</span><br><span class="line">    mgr-&gt;<span class="built_in">schedule</span>(<span class="number">1500</span>, bar, <span class="string">&quot;kitty&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        mgr-&gt;<span class="built_in">update</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> C++后端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>序列化</title>
      <link href="/2024/06/07/%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2024/06/07/%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h1 id="序列化简介">序列化简介</h1><p>序列化 (Serialization)是将对象的状态信息转换为可以存储或传输的形式的过程。在序列化期间，对象<br>将其当前状态写入到临时或持久性存储区。以后可以通过从存储区中读取或反序列化对象的状态，重<br>新创建该对象。</p><h2 id="序列化的方式">序列化的方式</h2><ol><li>文本格式：JSON、XML</li><li>二进制格式：protobuf、zh-serialize</li></ol><h2 id="二进制序列化">二进制序列化</h2><p>序列化：将数据结构或对象转换成二进制串的过程<br>反序列化：将在序列化过程中所产生的二进制串转换成数据结构或对象的过程</p><p>优点：</p><ul><li>序列化后，数据小，传输速度快</li><li>序列化、反序列化速度快</li></ul><h2 id="protobuf与zh-serialize的区别">Protobuf与zh-serialize的区别</h2><table><thead><tr><th style="text-align:center"></th><th style="text-align:center">protobuf</th><th style="text-align:center">zh-serialize</th></tr></thead><tbody><tr><td style="text-align:center">二进制格式</td><td style="text-align:center">是</td><td style="text-align:center">是</td></tr><tr><td style="text-align:center">数据体积</td><td style="text-align:center">小</td><td style="text-align:center">小</td></tr><tr><td style="text-align:center">编解码速度</td><td style="text-align:center">快</td><td style="text-align:center">快</td></tr><tr><td style="text-align:center">数据类型支持</td><td style="text-align:center">丰富</td><td style="text-align:center">更加丰富</td></tr><tr><td style="text-align:center">消息定义文件</td><td style="text-align:center">需要</td><td style="text-align:center">不需要</td></tr><tr><td style="text-align:center">需要编译</td><td style="text-align:center">需要</td><td style="text-align:center">不需要</td></tr><tr><td style="text-align:center">代码实现</td><td style="text-align:center">复杂</td><td style="text-align:center">简单</td></tr><tr><td style="text-align:center">使用难度</td><td style="text-align:center">复杂</td><td style="text-align:center">简单</td></tr></tbody></table><h1 id="c-序列化设计与实现">C++序列化设计与实现</h1><h2 id="基本类型数据序列化">基本类型数据序列化</h2><p>序列化会涉及到编码问题，要考虑如何将<code>bool</code>、<code>char</code>、<code>int</code>等基本数据类型进行编码为字符流。基本类型数据编码当前支持以下类型：</p><table><thead><tr><th style="text-align:center">字段类型</th><th style="text-align:center">字段长度（字节）</th><th style="text-align:center">编码格式</th></tr></thead><tbody><tr><td style="text-align:center">bool</td><td style="text-align:center">2</td><td style="text-align:center">Type(1) + Value(1)</td></tr><tr><td style="text-align:center">char</td><td style="text-align:center">2</td><td style="text-align:center">Type(1) + Value(1)</td></tr><tr><td style="text-align:center">int32</td><td style="text-align:center">5</td><td style="text-align:center">Type(1) + Value(4)</td></tr><tr><td style="text-align:center">int64</td><td style="text-align:center">9</td><td style="text-align:center">Type(1) + Value(8)</td></tr><tr><td style="text-align:center">float</td><td style="text-align:center">5</td><td style="text-align:center">Type(1) + Value(4)</td></tr><tr><td style="text-align:center">double</td><td style="text-align:center">9</td><td style="text-align:center">Type(1) + Value(8)</td></tr><tr><td style="text-align:center">string</td><td style="text-align:center">可变长度</td><td style="text-align:center">Type(1) + Length(5) + Value(变长)</td></tr></tbody></table><p>以<code>bool</code>类型为例，其编码后会占用2个字节，第1个字节存储数据的类型<code>Type</code>（数据的类型都默认占用1个字节），第2个字节存储数据的值。对于<code>char</code>、<code>int32</code>、<code>int64</code>、<code>float</code>和<code>double</code>都是类似的，注意对于<code>string</code>是可变长度的，因此其编码后第1个字节标明其类型，随后5个字节标明其字符串长度，最后就是字符串具体的内容。</p><h3 id="序列化">序列化</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * data, <span class="type">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 先确保vector中空间足够写入</span></span><br><span class="line">    <span class="built_in">reserve</span>(len);</span><br><span class="line">    <span class="type">int</span> size = m_buf.<span class="built_in">size</span>();</span><br><span class="line">    <span class="comment">// 调用内存拷贝先确保m_buf有效空间足够写入</span></span><br><span class="line">    m_buf.<span class="built_in">resize</span>(m_buf.<span class="built_in">size</span>() + len);</span><br><span class="line">    <span class="comment">// 因为数据是二进制不是字符串，因此不能简单调用push_back()，这里直接进行内存拷贝</span></span><br><span class="line">    std::<span class="built_in">memcpy</span>(&amp;m_buf[size], data, len);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">bool</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// bool类型序列化编码是2个字节，第1个字节是类型，第2个字节是它的值</span></span><br><span class="line">    <span class="type">char</span> type = DataStream::BOOL;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span>*)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span>*)&amp;value, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">char</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> type = DataStream::CHAR;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span>*)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span>*)&amp;value, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">int32_t</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> type = DataStream::INT32;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span>*)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span>*)&amp;value, <span class="built_in">sizeof</span>(<span class="type">int32_t</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">int64_t</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> type = DataStream::INT32;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span>*)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span>*)&amp;value, <span class="built_in">sizeof</span>(<span class="type">int64_t</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">float</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> type = DataStream::FLOAT;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span>*)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span>*)&amp;value, <span class="built_in">sizeof</span>(<span class="type">float</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">double</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> type = DataStream::DOUBLE;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span>*)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span>*)&amp;value, <span class="built_in">sizeof</span>(<span class="type">double</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 由于字符串属于可变长度，其序列化编码分为3部分：第1个字节表示其类型，然后5个字节表示字符串长度(int32)，剩余字节即字符串内容</span></span><br><span class="line">    <span class="type">char</span> type = DataStream::STRING;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span>*)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="type">int32_t</span> len = <span class="built_in">strlen</span>(value);</span><br><span class="line">    <span class="built_in">write</span>(len);</span><br><span class="line">    <span class="built_in">write</span>(value, len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">const</span> string &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">write</span>(value.<span class="built_in">c_str</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="反序列化">反序列化</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(<span class="type">bool</span> &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 反序列化其实就是一个解码的过程，在反序列化过程中下标m_pos从前向后移动</span></span><br><span class="line">    <span class="keyword">if</span> (m_buf[m_pos] != DataType::BOOL)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++m_pos;</span><br><span class="line">    value = m_buf[m_pos];</span><br><span class="line">    ++m_pos;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(<span class="type">char</span> &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_buf[m_pos] != DataType::CHAR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++m_pos;</span><br><span class="line">    value = m_buf[m_pos];</span><br><span class="line">    ++m_pos;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(<span class="type">int32_t</span> &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_buf[m_pos] != DataType::INT32)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++m_pos;</span><br><span class="line">    value = *((<span class="type">int32_t</span>*)&amp;(m_buf[m_pos]));</span><br><span class="line">    m_pos += <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(<span class="type">int64_t</span> &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_buf[m_pos] != DataType::INT64)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++m_pos;</span><br><span class="line">    value = *((<span class="type">int64_t</span>*)&amp;(m_buf[m_pos]));</span><br><span class="line">    m_pos += <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(<span class="type">float</span> &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_buf[m_pos] != DataType::FLOAT)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++m_pos;</span><br><span class="line">    value = *((<span class="type">float</span>*)&amp;(m_buf[m_pos]));</span><br><span class="line">    m_pos += <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(<span class="type">double</span> &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_buf[m_pos] != DataType::DOUBLE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++m_pos;</span><br><span class="line">    value = *((<span class="type">double</span>*)&amp;(m_buf[m_pos]));</span><br><span class="line">    m_pos += <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(string &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_buf[m_pos] != DataType::STRING)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++m_pos;</span><br><span class="line">    <span class="type">int32_t</span> len = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">read</span>(len);</span><br><span class="line">    <span class="keyword">if</span> (len &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    value.<span class="built_in">assign</span>((<span class="type">char</span>*)&amp;(m_buf[m_pos]), len);</span><br><span class="line">    m_pos += len;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="完整实现">完整实现</h3><p>通过<code>DataStream::write()</code>和<code>DataStream::read()</code>实现了序列化与反序列化，在此基础上可以重载流运算符来继续优化，使得代码在可用的基础上更好用：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// serialize/data_stream.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdexcept&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> std::string;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> serialize</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">DataStream</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="comment">// 用枚举值表示序列化的数据类型</span></span><br><span class="line">            <span class="keyword">enum</span> <span class="title class_">DataType</span></span><br><span class="line">            &#123;</span><br><span class="line">                BOOL = <span class="number">0</span>,</span><br><span class="line">                CHAR,</span><br><span class="line">                INT32,</span><br><span class="line">                INT64,</span><br><span class="line">                FLOAT,</span><br><span class="line">                DOUBLE,</span><br><span class="line">                STRING</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">DataStream</span>();</span><br><span class="line">            ~<span class="built_in">DataStream</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 序列化接口</span></span><br><span class="line">            <span class="comment">// 为了支持将不同数据类型进行序列化，这里write()需要重载</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">bool</span> value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">char</span> value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">int32_t</span> value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">int64_t</span> value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">float</span> value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">double</span> value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">const</span> string &amp; value)</span></span>;</span><br><span class="line">            <span class="comment">// 将长度为len字节的数据继续写入buffer中</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * data, <span class="type">int</span> len)</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 反序列化接口</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(<span class="type">bool</span> &amp; value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(<span class="type">char</span> &amp; value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(<span class="type">int32_t</span> &amp; value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(<span class="type">int64_t</span> &amp; value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(<span class="type">float</span> &amp; value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(<span class="type">double</span> &amp; value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(string &amp; str)</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">show</span><span class="params">()</span> <span class="type">const</span></span>;                              <span class="comment">// 将m_buf中的内容打印出来</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 为了代码在可用的基础上更好用，这里重载流运算符</span></span><br><span class="line">            <span class="comment">// 序列化</span></span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&lt;&lt;(<span class="type">bool</span> value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&lt;&lt;(<span class="type">char</span> value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&lt;&lt;(<span class="type">int32_t</span> value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&lt;&lt;(<span class="type">int64_t</span> value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&lt;&lt;(<span class="type">float</span> value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&lt;&lt;(<span class="type">double</span> value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> <span class="type">char</span> * value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> string &amp; value);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 反序列化</span></span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&gt;&gt;(<span class="type">bool</span> &amp; value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&gt;&gt;(<span class="type">char</span> &amp; value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&gt;&gt;(<span class="type">int32_t</span> &amp; value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&gt;&gt;(<span class="type">int64_t</span> &amp; value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&gt;&gt;(<span class="type">float</span> &amp; value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&gt;&gt;(<span class="type">double</span> &amp; value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&gt;&gt;(string &amp; value);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">reserve</span><span class="params">(<span class="type">int</span> len)</span></span>;                          <span class="comment">// 对vector扩容，修改capacity字段</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            std::vector&lt;<span class="type">char</span>&gt; m_buf;                        <span class="comment">// 保存序列化后的内容</span></span><br><span class="line">            <span class="type">int</span> m_pos;                                      <span class="comment">// 序列化过程中保存记录的位置(反序列化时使用)</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// serialize/data_stream.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;serialize/data_stream.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::serialize;</span><br><span class="line"></span><br><span class="line">DataStream::<span class="built_in">DataStream</span>() : <span class="built_in">m_pos</span>(<span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::reserve</span><span class="params">(<span class="type">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> size = m_buf.<span class="built_in">size</span>();</span><br><span class="line">    <span class="type">int</span> cap = m_buf.<span class="built_in">capacity</span>();</span><br><span class="line">    <span class="keyword">if</span> (size + len &gt; cap)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span> (size + len &gt; cap)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (cap == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cap = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                cap *= <span class="number">2</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        m_buf.<span class="built_in">reserve</span>(cap);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * data, <span class="type">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 先确保vector中空间足够写入</span></span><br><span class="line">    <span class="built_in">reserve</span>(len);</span><br><span class="line">    <span class="type">int</span> size = m_buf.<span class="built_in">size</span>();</span><br><span class="line">    <span class="comment">// 调用内存拷贝先确保m_buf有效空间足够写入</span></span><br><span class="line">    m_buf.<span class="built_in">resize</span>(m_buf.<span class="built_in">size</span>() + len);</span><br><span class="line">    <span class="comment">// 因为数据是二进制不是字符串，因此不能简单调用push_back()，这里直接进行内存拷贝</span></span><br><span class="line">    std::<span class="built_in">memcpy</span>(&amp;m_buf[size], data, len);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">bool</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// bool类型序列化编码是2个字节，第1个字节是类型，第2个字节是它的值</span></span><br><span class="line">    <span class="type">char</span> type = DataStream::BOOL;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span>*)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span>*)&amp;value, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">char</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> type = DataStream::CHAR;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span>*)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span>*)&amp;value, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">int32_t</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> type = DataStream::INT32;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span>*)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span>*)&amp;value, <span class="built_in">sizeof</span>(<span class="type">int32_t</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">int64_t</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> type = DataStream::INT32;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span>*)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span>*)&amp;value, <span class="built_in">sizeof</span>(<span class="type">int64_t</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">float</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> type = DataStream::FLOAT;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span>*)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span>*)&amp;value, <span class="built_in">sizeof</span>(<span class="type">float</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">double</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> type = DataStream::DOUBLE;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span>*)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span>*)&amp;value, <span class="built_in">sizeof</span>(<span class="type">double</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 由于字符串属于可变长度，其序列化编码分为3部分：第1个字节表示其类型，然后5个字节表示字符串长度(int32)，剩余字节即字符串内容</span></span><br><span class="line">    <span class="type">char</span> type = DataStream::STRING;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span>*)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="type">int32_t</span> len = <span class="built_in">strlen</span>(value);</span><br><span class="line">    <span class="built_in">write</span>(len);</span><br><span class="line">    <span class="built_in">write</span>(value, len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">const</span> string &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">write</span>(value.<span class="built_in">c_str</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp; DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">bool</span> value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">write</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp; DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">char</span> value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">write</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp; DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">int32_t</span> value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">write</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp; DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">int64_t</span> value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">write</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp; DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">float</span> value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">write</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp; DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">double</span> value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">write</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp; DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> <span class="type">char</span> * value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">write</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp; DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> string &amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">write</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::show</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> size = m_buf.<span class="built_in">size</span>();</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;data size = &quot;</span> &lt;&lt; size &lt;&lt; std::endl;</span><br><span class="line">    <span class="type">int</span> pos = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (pos &lt; size)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 基本数据类型序列化后第1个字节即其DataType数据类型</span></span><br><span class="line">        <span class="keyword">switch</span> ((DataType)m_buf[pos])</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> DataType::BOOL:</span><br><span class="line">                <span class="keyword">if</span> ((<span class="type">int</span>)m_buf[++pos] == <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    std::cout &lt;&lt; <span class="string">&quot;false&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    std::cout &lt;&lt; <span class="string">&quot;true&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                ++pos;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DataType::CHAR:</span><br><span class="line">                std::cout &lt;&lt; m_buf[++pos];</span><br><span class="line">                ++pos;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DataType::INT32:</span><br><span class="line">                std::cout &lt;&lt; *((<span class="type">int32_t</span>*)(&amp;m_buf[++pos]));</span><br><span class="line">                pos += <span class="number">4</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DataType::INT64:</span><br><span class="line">                std::cout &lt;&lt; *((<span class="type">int64_t</span>*)(&amp;m_buf[++pos]));</span><br><span class="line">                pos += <span class="number">8</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DataType::FLOAT:</span><br><span class="line">                std::cout &lt;&lt; *((<span class="type">float</span>*)(&amp;m_buf[++pos]));</span><br><span class="line">                pos += <span class="number">4</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DataType::DOUBLE:</span><br><span class="line">                std::cout &lt;&lt; *((<span class="type">double</span>*)(&amp;m_buf[++pos]));</span><br><span class="line">                pos += <span class="number">8</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DataType::STRING:</span><br><span class="line">                <span class="keyword">if</span> ((DataType)m_buf[++pos] == DataType::INT32)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="type">int32_t</span> len = *(<span class="type">int32_t</span>*)(&amp;m_buf[++pos]);</span><br><span class="line">                    pos += <span class="number">4</span>;</span><br><span class="line">                    std::cout &lt;&lt; <span class="built_in">string</span>(&amp;m_buf[pos], len);</span><br><span class="line">                    pos += len;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;invalid string length&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                std::cout &lt;&lt; <span class="string">&quot;invalid data type&quot;</span>;</span><br><span class="line">                <span class="keyword">break</span>;    </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(<span class="type">bool</span> &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 反序列化其实就是一个解码的过程，在反序列化过程中下标m_pos从前向后移动</span></span><br><span class="line">    <span class="keyword">if</span> (m_buf[m_pos] != DataType::BOOL)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++m_pos;</span><br><span class="line">    value = m_buf[m_pos];</span><br><span class="line">    ++m_pos;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(<span class="type">char</span> &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_buf[m_pos] != DataType::CHAR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++m_pos;</span><br><span class="line">    value = m_buf[m_pos];</span><br><span class="line">    ++m_pos;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(<span class="type">int32_t</span> &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_buf[m_pos] != DataType::INT32)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++m_pos;</span><br><span class="line">    value = *((<span class="type">int32_t</span>*)&amp;(m_buf[m_pos]));</span><br><span class="line">    m_pos += <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(<span class="type">int64_t</span> &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_buf[m_pos] != DataType::INT64)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++m_pos;</span><br><span class="line">    value = *((<span class="type">int64_t</span>*)&amp;(m_buf[m_pos]));</span><br><span class="line">    m_pos += <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(<span class="type">float</span> &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_buf[m_pos] != DataType::FLOAT)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++m_pos;</span><br><span class="line">    value = *((<span class="type">float</span>*)&amp;(m_buf[m_pos]));</span><br><span class="line">    m_pos += <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(<span class="type">double</span> &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_buf[m_pos] != DataType::DOUBLE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++m_pos;</span><br><span class="line">    value = *((<span class="type">double</span>*)&amp;(m_buf[m_pos]));</span><br><span class="line">    m_pos += <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(string &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_buf[m_pos] != DataType::STRING)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++m_pos;</span><br><span class="line">    <span class="type">int32_t</span> len = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">read</span>(len);</span><br><span class="line">    <span class="keyword">if</span> (len &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    value.<span class="built_in">assign</span>((<span class="type">char</span>*)&amp;(m_buf[m_pos]), len);</span><br><span class="line">    m_pos += len;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp; DataStream::<span class="keyword">operator</span>&gt;&gt;(<span class="type">bool</span> &amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">read</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp; DataStream::<span class="keyword">operator</span>&gt;&gt;(<span class="type">char</span> &amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">read</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp; DataStream::<span class="keyword">operator</span>&gt;&gt;(<span class="type">int32_t</span> &amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">read</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp; DataStream::<span class="keyword">operator</span>&gt;&gt;(<span class="type">int64_t</span> &amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">read</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp; DataStream::<span class="keyword">operator</span>&gt;&gt;(<span class="type">float</span> &amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">read</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp; DataStream::<span class="keyword">operator</span>&gt;&gt;(<span class="type">double</span> &amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">read</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp; DataStream::<span class="keyword">operator</span>&gt;&gt;(string &amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">read</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;serialize/data_stream.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::serialize;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    DataStream ds;</span><br><span class="line">    ds &lt;&lt; <span class="literal">true</span> &lt;&lt; <span class="number">123</span> &lt;&lt; <span class="string">&quot;hello world&quot;</span>;</span><br><span class="line">    ds.<span class="built_in">show</span>();</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> b;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    string s;</span><br><span class="line">    ds &gt;&gt; b &gt;&gt; i &gt;&gt; s;</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;i = &quot;</span> &lt;&lt; i &lt;&lt; <span class="string">&quot;, b = &quot;</span> &lt;&lt; b &lt;&lt; <span class="string">&quot;, s = &quot;</span> &lt;&lt; s &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="复合类型数据序列化">复合类型数据序列化</h2><p>复合类型是指STL中的容器，比如对STL中的<code>vector</code>、<code>list</code>、<code>map</code>和<code>set</code>进行序列化。这4种复合数据类型编码长度都是可变长度的，底层编码第1个字节表示存储数据的类型<code>Type</code>，随后5个字节表示容器的长度，即其里面有多少个元素，长度后面跟着的内容就是元素值。<code>list</code>和<code>set</code>也是类似的，注意<code>map</code>中的值是<code>key-value</code>对。注意在实现STL容器序列化前，要先实现容器元素的序列化方法。</p><table><thead><tr><th style="text-align:center">数据类型</th><th style="text-align:center">字段长度</th><th style="text-align:center">底层编码</th></tr></thead><tbody><tr><td style="text-align:center">std::vector<T></td><td style="text-align:center">可变长度</td><td style="text-align:center">Type(1) + Length(5) + Value(T + T + T + …)</td></tr><tr><td style="text-align:center">std::list<T></td><td style="text-align:center">可变长度</td><td style="text-align:center">Type(1) + Length(5) + Value(T + T + T + …)</td></tr><tr><td style="text-align:center">std::map<T></td><td style="text-align:center">可变长度</td><td style="text-align:center">Type(1) + Length(5) + Value((K, V) + (K, V) + (K, V) + …)</td></tr><tr><td style="text-align:center">std::set<T></td><td style="text-align:center">可变长度</td><td style="text-align:center">Type(1) + Length(5) + Value(T + T + T + …)</td></tr></tbody></table><h3 id="序列化">序列化</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// serialize/data_stream.h</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">const</span> std::vector&lt;T&gt; &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> type = DataType::VECTOR;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="type">int32_t</span> len = value.<span class="built_in">size</span>();</span><br><span class="line">    <span class="built_in">write</span>(len);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">write</span>(value[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">const</span> std::list&lt;T&gt; &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> type = DataType::LIST;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="type">int32_t</span> len = value.<span class="built_in">size</span>();</span><br><span class="line">    <span class="built_in">write</span>(len);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> it = value.<span class="built_in">begin</span>(); it != value.<span class="built_in">end</span>(); ++it)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">write</span>(*it);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> K, <span class="keyword">typename</span> V&gt;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">const</span> std::map&lt;K, V&gt; &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> type = DataType::MAP;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="type">int32_t</span> len = value.<span class="built_in">size</span>();</span><br><span class="line">    <span class="built_in">write</span>(len);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> it = value.<span class="built_in">begin</span>(); it != value.<span class="built_in">end</span>(); ++it)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">write</span>(it-&gt;first);</span><br><span class="line">        <span class="built_in">write</span>(it-&gt;second);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">const</span> std::set&lt;T&gt; &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> type = DataType::SET;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="type">int32_t</span> len = value.<span class="built_in">size</span>();</span><br><span class="line">    <span class="built_in">write</span>(len);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> it = value.<span class="built_in">begin</span>(); it != value.<span class="built_in">end</span>(); ++it)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">write</span>(*it);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">DataStream &amp; DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> std::vector&lt;T&gt; &amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">write</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">DataStream &amp; DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> std::list&lt;T&gt; &amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">write</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> K, <span class="keyword">typename</span> V&gt;</span><br><span class="line">DataStream &amp; DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> std::map&lt;K, V&gt; &amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">write</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">DataStream &amp; DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> std::set&lt;T&gt; &amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">write</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="反序列化">反序列化</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// serialize/data_stream.h</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(std::vector&lt;T&gt; &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    value.<span class="built_in">clear</span>();</span><br><span class="line">    <span class="keyword">if</span> (m_buf[m_pos] != DataType::VECTOR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++m_pos;</span><br><span class="line">    <span class="type">int</span> len = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">read</span>(len);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        T v;</span><br><span class="line">        <span class="built_in">read</span>(v);</span><br><span class="line">        value.<span class="built_in">push_back</span>(v);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(std::list&lt;T&gt; &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    value.<span class="built_in">clear</span>();</span><br><span class="line">    <span class="keyword">if</span> (m_buf[m_pos] != DataType::LIST)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++m_pos;</span><br><span class="line">    <span class="type">int</span> len = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">read</span>(len);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        T v;</span><br><span class="line">        <span class="built_in">read</span>(v);</span><br><span class="line">        value.<span class="built_in">push_back</span>(v);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> K, <span class="keyword">typename</span> V&gt;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(std::map&lt;K, V&gt; &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    value.<span class="built_in">clear</span>();</span><br><span class="line">    <span class="keyword">if</span> (m_buf[m_pos] != DataType::MAP)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++m_pos;</span><br><span class="line">    <span class="type">int</span> len = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">read</span>(len);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        K k;</span><br><span class="line">        <span class="built_in">read</span>(k);</span><br><span class="line">        V v;</span><br><span class="line">        <span class="built_in">read</span>(v);</span><br><span class="line">        value[k] = v;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(std::set&lt;T&gt; &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    value.<span class="built_in">clear</span>();</span><br><span class="line">    <span class="keyword">if</span> (m_buf[m_pos] != DataType::SET)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++m_pos;</span><br><span class="line">    <span class="type">int</span> len = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">read</span>(len);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        T v;</span><br><span class="line">        <span class="built_in">read</span>(v);</span><br><span class="line">        value.<span class="built_in">insert</span>(v);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">DataStream &amp; DataStream::<span class="keyword">operator</span>&gt;&gt;(std::vector&lt;T&gt; &amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">read</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">DataStream &amp; DataStream::<span class="keyword">operator</span>&gt;&gt;(std::list&lt;T&gt; &amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">read</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> K, <span class="keyword">typename</span> V&gt;</span><br><span class="line">DataStream &amp; DataStream::<span class="keyword">operator</span>&gt;&gt;(std::map&lt;K, V&gt; &amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">read</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">DataStream &amp; DataStream::<span class="keyword">operator</span>&gt;&gt;(std::set&lt;T&gt; &amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">read</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="完整实现">完整实现</h3><p>实现了复合类型数据序列化<code>write()</code>与反序列化<code>read()</code>后，在此基础上可以重载流运算符来继续优化，使得代码在可用的基础上更好用</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// serialize/data_stream.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;list&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;set&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdexcept&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> std::string;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> serialize</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">DataStream</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="comment">// 用枚举值表示序列化的数据类型</span></span><br><span class="line">            <span class="keyword">enum</span> <span class="title class_">DataType</span></span><br><span class="line">            &#123;</span><br><span class="line">                BOOL = <span class="number">0</span>,</span><br><span class="line">                CHAR,</span><br><span class="line">                INT32,</span><br><span class="line">                INT64,</span><br><span class="line">                FLOAT,</span><br><span class="line">                DOUBLE,</span><br><span class="line">                STRING,</span><br><span class="line">                VECTOR,</span><br><span class="line">                LIST,</span><br><span class="line">                MAP,</span><br><span class="line">                SET</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">DataStream</span>();</span><br><span class="line">            ~<span class="built_in">DataStream</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 序列化接口</span></span><br><span class="line">            <span class="comment">// 为了支持将不同数据类型进行序列化，这里write()需要重载</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">bool</span> value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">char</span> value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">int32_t</span> value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">int64_t</span> value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">float</span> value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">double</span> value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">const</span> string &amp; value)</span></span>;</span><br><span class="line">            <span class="comment">// 将长度为len字节的数据继续写入buffer中</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * data, <span class="type">int</span> len)</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 考虑到STL容器比如vector、list都是模板，因此这里实现模板函数</span></span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">const</span> std::vector&lt;T&gt; &amp; value)</span></span>;</span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">const</span> std::list&lt;T&gt; &amp; value)</span></span>;</span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> K, <span class="keyword">typename</span> V&gt;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">const</span> std::map&lt;K, V&gt; &amp; value)</span></span>;</span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">const</span> std::set&lt;T&gt; &amp; value)</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 反序列化接口</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(<span class="type">bool</span> &amp; value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(<span class="type">char</span> &amp; value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(<span class="type">int32_t</span> &amp; value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(<span class="type">int64_t</span> &amp; value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(<span class="type">float</span> &amp; value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(<span class="type">double</span> &amp; read)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(string &amp; str)</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(std::vector&lt;T&gt; &amp; value)</span></span>;</span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(std::list&lt;T&gt; &amp; value)</span></span>;</span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> K, <span class="keyword">typename</span> V&gt;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(std::map&lt;K, V&gt; &amp; value)</span></span>;</span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(std::set&lt;T&gt; &amp; value)</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">show</span><span class="params">()</span> <span class="type">const</span></span>;                              <span class="comment">// 将m_buf中的内容打印出来</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 为了代码在可用的基础上更好用，这里重载流运算符</span></span><br><span class="line">            <span class="comment">// 序列化</span></span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&lt;&lt;(<span class="type">bool</span> value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&lt;&lt;(<span class="type">char</span> value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&lt;&lt;(<span class="type">int32_t</span> value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&lt;&lt;(<span class="type">int64_t</span> value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&lt;&lt;(<span class="type">float</span> value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&lt;&lt;(<span class="type">double</span> value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> <span class="type">char</span> * value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> string &amp; value);</span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> std::vector&lt;T&gt; &amp; value);</span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> std::list&lt;T&gt; &amp; value);</span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> K, <span class="keyword">typename</span> V&gt;</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> std::map&lt;K, V&gt; &amp; value);</span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> std::set&lt;T&gt; &amp; value);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 反序列化</span></span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&gt;&gt;(<span class="type">bool</span> &amp; value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&gt;&gt;(<span class="type">char</span> &amp; value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&gt;&gt;(<span class="type">int32_t</span> &amp; value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&gt;&gt;(<span class="type">int64_t</span> &amp; value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&gt;&gt;(<span class="type">float</span> &amp; value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&gt;&gt;(<span class="type">double</span> &amp; value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&gt;&gt;(string &amp; value);</span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&gt;&gt;(std::vector&lt;T&gt; &amp; value);</span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&gt;&gt;(std::list&lt;T&gt; &amp; value);</span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> K, <span class="keyword">typename</span> V&gt;</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&gt;&gt;(std::map&lt;K, V&gt; &amp; value);</span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&gt;&gt;(std::set&lt;T&gt; &amp; value);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">reserve</span><span class="params">(<span class="type">int</span> len)</span></span>;                          <span class="comment">// 对vector扩容，修改capacity字段</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            std::vector&lt;<span class="type">char</span>&gt; m_buf;                        <span class="comment">// 保存序列化后的内容</span></span><br><span class="line">            <span class="type">int</span> m_pos;                                      <span class="comment">// 序列化过程中保存记录的位置(反序列化时使用)</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">const</span> std::vector&lt;T&gt; &amp; value)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="type">char</span> type = DataType::VECTOR;</span><br><span class="line">            <span class="built_in">write</span>((<span class="type">char</span> *)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">            <span class="type">int32_t</span> len = value.<span class="built_in">size</span>();</span><br><span class="line">            <span class="built_in">write</span>(len);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">write</span>(value[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">const</span> std::list&lt;T&gt; &amp; value)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="type">char</span> type = DataType::LIST;</span><br><span class="line">            <span class="built_in">write</span>((<span class="type">char</span> *)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">            <span class="type">int32_t</span> len = value.<span class="built_in">size</span>();</span><br><span class="line">            <span class="built_in">write</span>(len);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">auto</span> it = value.<span class="built_in">begin</span>(); it != value.<span class="built_in">end</span>(); ++it)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">write</span>(*it);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> K, <span class="keyword">typename</span> V&gt;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">const</span> std::map&lt;K, V&gt; &amp; value)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="type">char</span> type = DataType::MAP;</span><br><span class="line">            <span class="built_in">write</span>((<span class="type">char</span> *)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">            <span class="type">int32_t</span> len = value.<span class="built_in">size</span>();</span><br><span class="line">            <span class="built_in">write</span>(len);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">auto</span> it = value.<span class="built_in">begin</span>(); it != value.<span class="built_in">end</span>(); ++it)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">write</span>(it-&gt;first);</span><br><span class="line">                <span class="built_in">write</span>(it-&gt;second);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">const</span> std::set&lt;T&gt; &amp; value)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="type">char</span> type = DataType::SET;</span><br><span class="line">            <span class="built_in">write</span>((<span class="type">char</span> *)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">            <span class="type">int32_t</span> len = value.<span class="built_in">size</span>();</span><br><span class="line">            <span class="built_in">write</span>(len);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">auto</span> it = value.<span class="built_in">begin</span>(); it != value.<span class="built_in">end</span>(); ++it)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">write</span>(*it);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(std::vector&lt;T&gt; &amp; value)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            value.<span class="built_in">clear</span>();</span><br><span class="line">            <span class="keyword">if</span> (m_buf[m_pos] != DataType::VECTOR)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ++m_pos;</span><br><span class="line">            <span class="type">int</span> len = <span class="number">0</span>;</span><br><span class="line">            <span class="built_in">read</span>(len);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; ++i)</span><br><span class="line">            &#123;</span><br><span class="line">                T v;</span><br><span class="line">                <span class="built_in">read</span>(v);</span><br><span class="line">                value.<span class="built_in">push_back</span>(v);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(std::list&lt;T&gt; &amp; value)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            value.<span class="built_in">clear</span>();</span><br><span class="line">            <span class="keyword">if</span> (m_buf[m_pos] != DataType::LIST)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ++m_pos;</span><br><span class="line">            <span class="type">int</span> len = <span class="number">0</span>;</span><br><span class="line">            <span class="built_in">read</span>(len);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; ++i)</span><br><span class="line">            &#123;</span><br><span class="line">                T v;</span><br><span class="line">                <span class="built_in">read</span>(v);</span><br><span class="line">                value.<span class="built_in">push_back</span>(v);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> K, <span class="keyword">typename</span> V&gt;</span><br><span class="line">        <span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(std::map&lt;K, V&gt; &amp; value)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            value.<span class="built_in">clear</span>();</span><br><span class="line">            <span class="keyword">if</span> (m_buf[m_pos] != DataType::MAP)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ++m_pos;</span><br><span class="line">            <span class="type">int</span> len = <span class="number">0</span>;</span><br><span class="line">            <span class="built_in">read</span>(len);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; ++i)</span><br><span class="line">            &#123;</span><br><span class="line">                K k;</span><br><span class="line">                <span class="built_in">read</span>(k);</span><br><span class="line">                V v;</span><br><span class="line">                <span class="built_in">read</span>(v);</span><br><span class="line">                value[k] = v;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(std::set&lt;T&gt; &amp; value)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            value.<span class="built_in">clear</span>();</span><br><span class="line">            <span class="keyword">if</span> (m_buf[m_pos] != DataType::SET)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ++m_pos;</span><br><span class="line">            <span class="type">int</span> len = <span class="number">0</span>;</span><br><span class="line">            <span class="built_in">read</span>(len);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; ++i)</span><br><span class="line">            &#123;</span><br><span class="line">                T v;</span><br><span class="line">                <span class="built_in">read</span>(v);</span><br><span class="line">                value.<span class="built_in">insert</span>(v);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        DataStream &amp; DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> std::vector&lt;T&gt; &amp; value)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">write</span>(value);</span><br><span class="line">            <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        DataStream &amp; DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> std::list&lt;T&gt; &amp; value)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">write</span>(value);</span><br><span class="line">            <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> K, <span class="keyword">typename</span> V&gt;</span><br><span class="line">        DataStream &amp; DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> std::map&lt;K, V&gt; &amp; value)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">write</span>(value);</span><br><span class="line">            <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        DataStream &amp; DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> std::set&lt;T&gt; &amp; value)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">write</span>(value);</span><br><span class="line">            <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        DataStream &amp; DataStream::<span class="keyword">operator</span>&gt;&gt;(std::vector&lt;T&gt; &amp; value)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">read</span>(value);</span><br><span class="line">            <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        DataStream &amp; DataStream::<span class="keyword">operator</span>&gt;&gt;(std::list&lt;T&gt; &amp; value)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">read</span>(value);</span><br><span class="line">            <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> K, <span class="keyword">typename</span> V&gt;</span><br><span class="line">        DataStream &amp; DataStream::<span class="keyword">operator</span>&gt;&gt;(std::map&lt;K, V&gt; &amp; value)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">read</span>(value);</span><br><span class="line">            <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        DataStream &amp; DataStream::<span class="keyword">operator</span>&gt;&gt;(std::set&lt;T&gt; &amp; value)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">read</span>(value);</span><br><span class="line">            <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// serialize/data_stream.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;serialize/data_stream.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::serialize;</span><br><span class="line"></span><br><span class="line">DataStream::<span class="built_in">DataStream</span>() : <span class="built_in">m_pos</span>(<span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::reserve</span><span class="params">(<span class="type">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> size = m_buf.<span class="built_in">size</span>();</span><br><span class="line">    <span class="type">int</span> cap = m_buf.<span class="built_in">capacity</span>();</span><br><span class="line">    <span class="keyword">if</span> (size + len &gt; cap)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span> (size + len &gt; cap)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (cap == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cap = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                cap *= <span class="number">2</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        m_buf.<span class="built_in">reserve</span>(cap);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * data, <span class="type">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 先确保vector中空间足够写入</span></span><br><span class="line">    <span class="built_in">reserve</span>(len);</span><br><span class="line">    <span class="type">int</span> size = m_buf.<span class="built_in">size</span>();</span><br><span class="line">    <span class="comment">// 调用内存拷贝先确保m_buf有效空间足够写入</span></span><br><span class="line">    m_buf.<span class="built_in">resize</span>(m_buf.<span class="built_in">size</span>() + len);</span><br><span class="line">    <span class="comment">// 因为数据是二进制不是字符串，因此不能简单调用push_back()，这里直接进行内存拷贝</span></span><br><span class="line">    std::<span class="built_in">memcpy</span>(&amp;m_buf[size], data, len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">bool</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// bool类型序列化编码是2个字节，第1个字节是类型，第2个字节是它的值</span></span><br><span class="line">    <span class="type">char</span> type = DataStream::BOOL;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;value, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">char</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> type = DataStream::CHAR;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;value, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">int32_t</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> type = DataStream::INT32;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;value, <span class="built_in">sizeof</span>(<span class="type">int32_t</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">int64_t</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> type = DataStream::INT32;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;value, <span class="built_in">sizeof</span>(<span class="type">int64_t</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">float</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> type = DataStream::FLOAT;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;value, <span class="built_in">sizeof</span>(<span class="type">float</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">double</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> type = DataStream::DOUBLE;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;value, <span class="built_in">sizeof</span>(<span class="type">double</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 由于字符串属于可变长度，其序列化编码分为3部分：第1个字节表示其类型，然后5个字节表示字符串长度(int32)，剩余字节即字符串内容</span></span><br><span class="line">    <span class="type">char</span> type = DataStream::STRING;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="type">int32_t</span> len = <span class="built_in">strlen</span>(value);</span><br><span class="line">    <span class="built_in">write</span>(len);</span><br><span class="line">    <span class="built_in">write</span>(value, len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">const</span> string &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">write</span>(value.<span class="built_in">c_str</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp;DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">bool</span> value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">write</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp;DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">char</span> value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">write</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp;DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">int32_t</span> value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">write</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp;DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">int64_t</span> value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">write</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp;DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">float</span> value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">write</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp;DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">double</span> value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">write</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp;DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> <span class="type">char</span> * value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">write</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp;DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> string &amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">write</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::show</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> size = m_buf.<span class="built_in">size</span>();</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;data size = &quot;</span> &lt;&lt; size &lt;&lt; std::endl;</span><br><span class="line">    <span class="type">int</span> pos = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (pos &lt; size)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 基本数据类型序列化后第1个字节即其DataType数据类型</span></span><br><span class="line">        <span class="keyword">switch</span> ((DataType)m_buf[pos])</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">case</span> DataType::BOOL:</span><br><span class="line">            <span class="keyword">if</span> ((<span class="type">int</span>)m_buf[++pos] == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                std::cout &lt;&lt; <span class="string">&quot;false&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                std::cout &lt;&lt; <span class="string">&quot;true&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ++pos;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> DataType::CHAR:</span><br><span class="line">            std::cout &lt;&lt; m_buf[++pos];</span><br><span class="line">            ++pos;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> DataType::INT32:</span><br><span class="line">            std::cout &lt;&lt; *((<span class="type">int32_t</span> *)(&amp;m_buf[++pos]));</span><br><span class="line">            pos += <span class="number">4</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> DataType::INT64:</span><br><span class="line">            std::cout &lt;&lt; *((<span class="type">int64_t</span> *)(&amp;m_buf[++pos]));</span><br><span class="line">            pos += <span class="number">8</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> DataType::FLOAT:</span><br><span class="line">            std::cout &lt;&lt; *((<span class="type">float</span> *)(&amp;m_buf[++pos]));</span><br><span class="line">            pos += <span class="number">4</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> DataType::DOUBLE:</span><br><span class="line">            std::cout &lt;&lt; *((<span class="type">double</span> *)(&amp;m_buf[++pos]));</span><br><span class="line">            pos += <span class="number">8</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> DataType::STRING:</span><br><span class="line">            <span class="keyword">if</span> ((DataType)m_buf[++pos] == DataType::INT32)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="type">int32_t</span> len = *(<span class="type">int32_t</span> *)(&amp;m_buf[++pos]);</span><br><span class="line">                pos += <span class="number">4</span>;</span><br><span class="line">                std::cout &lt;&lt; <span class="built_in">string</span>(&amp;m_buf[pos], len);</span><br><span class="line">                pos += len;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;invalid string length&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;invalid data type&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(<span class="type">bool</span> &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 反序列化其实就是一个解码的过程，在反序列化过程中下标m_pos从前向后移动</span></span><br><span class="line">    <span class="keyword">if</span> (m_buf[m_pos] != DataType::BOOL)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++m_pos;</span><br><span class="line">    value = m_buf[m_pos];</span><br><span class="line">    ++m_pos;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(<span class="type">char</span> &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_buf[m_pos] != DataType::CHAR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++m_pos;</span><br><span class="line">    value = m_buf[m_pos];</span><br><span class="line">    ++m_pos;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(<span class="type">int32_t</span> &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_buf[m_pos] != DataType::INT32)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++m_pos;</span><br><span class="line">    value = *((<span class="type">int32_t</span> *)&amp;(m_buf[m_pos]));</span><br><span class="line">    m_pos += <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(<span class="type">int64_t</span> &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_buf[m_pos] != DataType::INT64)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++m_pos;</span><br><span class="line">    value = *((<span class="type">int64_t</span> *)&amp;(m_buf[m_pos]));</span><br><span class="line">    m_pos += <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(<span class="type">float</span> &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_buf[m_pos] != DataType::FLOAT)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++m_pos;</span><br><span class="line">    value = *((<span class="type">float</span> *)&amp;(m_buf[m_pos]));</span><br><span class="line">    m_pos += <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(<span class="type">double</span> &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_buf[m_pos] != DataType::DOUBLE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++m_pos;</span><br><span class="line">    value = *((<span class="type">double</span> *)&amp;(m_buf[m_pos]));</span><br><span class="line">    m_pos += <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(string &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_buf[m_pos] != DataType::STRING)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++m_pos;</span><br><span class="line">    <span class="type">int32_t</span> len = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">read</span>(len);</span><br><span class="line">    <span class="keyword">if</span> (len &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    value.<span class="built_in">assign</span>((<span class="type">char</span> *)&amp;(m_buf[m_pos]), len);</span><br><span class="line">    m_pos += len;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp;DataStream::<span class="keyword">operator</span>&gt;&gt;(<span class="type">bool</span> &amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">read</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp;DataStream::<span class="keyword">operator</span>&gt;&gt;(<span class="type">char</span> &amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">read</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp;DataStream::<span class="keyword">operator</span>&gt;&gt;(<span class="type">int32_t</span> &amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">read</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp;DataStream::<span class="keyword">operator</span>&gt;&gt;(<span class="type">int64_t</span> &amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">read</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp;DataStream::<span class="keyword">operator</span>&gt;&gt;(<span class="type">float</span> &amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">read</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp;DataStream::<span class="keyword">operator</span>&gt;&gt;(<span class="type">double</span> &amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">read</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp;DataStream::<span class="keyword">operator</span>&gt;&gt;(string &amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">read</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;serialize/data_stream.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::serialize;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::vector&lt;<span class="type">int</span>&gt; v1 = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;;</span><br><span class="line">    DataStream ds;</span><br><span class="line">    ds &lt;&lt; v1;</span><br><span class="line">    std::vector&lt;<span class="type">int</span>&gt; v2;</span><br><span class="line">    ds &gt;&gt; v2;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span> &amp; a : v2)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; a &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="自定义类型数据序列化">自定义类型数据序列化</h2><p>自定义数据类型是指类对象<code>class</code>，其编码如下。自定义类型数据序列化后的字段长度是可变长度，其底层编码第1个字节表示数据类型<code>CUSTOM</code>，随后跟着类中的各个成员数据。</p><table><thead><tr><th style="text-align:center">数据类型</th><th style="text-align:center">字段长度</th><th style="text-align:center">底层编码</th></tr></thead><tbody><tr><td style="text-align:center">class</td><td style="text-align:center">可变长度</td><td style="text-align:center">Type(1) + Value(D1 + D2 + D3 + …)</td></tr></tbody></table><h3 id="serializable接口类">Serializable接口类</h3><p>为了让任何一个类只要实现了相关接口就可以序列化，这里抽象出一个<code>Serializable</code>接口类，任何自定义类只要想实现序列化与反序列化，那么其必须继承自<code>Serializable</code>虚基类并实现实现<code>serialize</code>和<code>unserialize</code>这两个纯虚函数。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// serialize/serializable.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;serialize/data_stream.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> serialize</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Serializable</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="comment">// 序列化</span></span><br><span class="line">            <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">serialize</span><span class="params">(DataStream &amp; stream)</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// 反序列化</span></span><br><span class="line">            <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">unserialize</span><span class="params">(DataStream &amp; stream)</span> </span>= <span class="number">0</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;serialize/serializable.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::serialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> : <span class="keyword">public</span> Serializable</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">A</span>() = <span class="keyword">default</span>;</span><br><span class="line">    <span class="built_in">A</span>(<span class="type">const</span> string &amp; name, <span class="type">int</span> age) : <span class="built_in">m_name</span>(name), <span class="built_in">m_age</span>(age) &#123;&#125;</span><br><span class="line">    ~<span class="built_in">A</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 序列化</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">serialize</span><span class="params">(DataStream &amp; stream)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="type">char</span> type = DataStream::CUSTOM;</span><br><span class="line">        stream.<span class="built_in">write</span>((<span class="type">char</span>*)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">        stream.<span class="built_in">write</span>(m_name);</span><br><span class="line">        stream.<span class="built_in">write</span>(m_age);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 反序列化</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">unserialize</span><span class="params">(DataStream &amp; stream)</span></span></span><br><span class="line"><span class="function">    </span>&#123;   </span><br><span class="line">        <span class="type">char</span> type;</span><br><span class="line">        stream.<span class="built_in">read</span>((<span class="type">char</span>*)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">        <span class="keyword">if</span> (type != DataStream::CUSTOM)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        stream.<span class="built_in">read</span>(m_name);</span><br><span class="line">        stream.<span class="built_in">read</span>(m_age);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">show</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;name = &quot;</span> &lt;&lt; m_name &lt;&lt; <span class="string">&quot;, age = &quot;</span> &lt;&lt; m_age &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    string m_name;</span><br><span class="line">    <span class="type">int</span> m_age;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">A <span class="title">a1</span><span class="params">(<span class="string">&quot;jack&quot;</span>, <span class="number">18</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    DataStream ds;</span><br><span class="line">    a1.<span class="built_in">serialize</span>(ds);</span><br><span class="line"></span><br><span class="line">    A a2;</span><br><span class="line">    a2.<span class="built_in">unserialize</span>(ds);</span><br><span class="line">    a2.<span class="built_in">show</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="serialize宏">SERIALIZE宏</h3><p>由于不同类的数据成员是可变的，可以实现<code>SERIALIZE</code>宏传入可变参数<code>...</code>，而传入宏的数据即需要序列化和反序列化的成员数据。这样自定义类型序列化直接用宏即可，不用手动实现<code>serialize()</code>和<code>unserialize()</code>这两个接口，提升了可用性。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// serialize/serializable.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;serialize/data_stream.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> serialize</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Serializable</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="comment">// 序列化</span></span><br><span class="line">            <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">serialize</span><span class="params">(DataStream &amp; stream)</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// 反序列化</span></span><br><span class="line">            <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">unserialize</span><span class="params">(DataStream &amp; stream)</span> </span>= <span class="number">0</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 由于不同类的数据成员是可变的，这里SERIALIZE宏传入可变参数...(传入宏的数据即需要序列化和反序列化的成员数据)</span></span><br><span class="line">    <span class="comment">// 这样自定义类型序列化直接用宏即可，不用手动实现serialize()和unserialize()这两个接口</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> SERIALIZE(...)                                  \</span></span><br><span class="line"><span class="meta">        void serialize(DataStream &amp; stream) const           \</span></span><br><span class="line"><span class="meta">        &#123;                                                   \</span></span><br><span class="line"><span class="meta">            char type = DataStream::CUSTOM;                 \</span></span><br><span class="line"><span class="meta">            stream.write((char*)&amp;type, sizeof(char));       \</span></span><br><span class="line"><span class="meta">            stream.write_args(__VA_ARGS__);                 \</span></span><br><span class="line"><span class="meta">        &#125;                                                   \</span></span><br><span class="line"><span class="meta">                                                            \</span></span><br><span class="line"><span class="meta">        bool unserialize(DataStream &amp; stream)               \</span></span><br><span class="line"><span class="meta">        &#123;                                                   \</span></span><br><span class="line"><span class="meta">            char type;                                      \</span></span><br><span class="line"><span class="meta">            stream.read(&amp;type, sizeof(char));               \</span></span><br><span class="line"><span class="meta">            <span class="keyword">if</span> (type != DataStream::CUSTOM)                 \</span></span><br><span class="line"><span class="meta">            &#123;                                               \</span></span><br><span class="line"><span class="meta">                return false;                               \</span></span><br><span class="line"><span class="meta">            &#125;                                               \</span></span><br><span class="line"><span class="meta">            stream.read_args(__VA_ARGS__);                  \</span></span><br><span class="line"><span class="meta">            return true;                                    \</span></span><br><span class="line"><span class="meta">        &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// serialize/data_stream.h</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 可变参数类型序列化</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> ... Args&gt;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write_args</span><span class="params">(<span class="type">const</span> T &amp; head, <span class="type">const</span> Args&amp;... args)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 可变参数拆解为第1个参数head和剩余参数args</span></span><br><span class="line">    <span class="comment">// 先调用write()将第1个参数head进行序列化，然后递归调用write_args()对剩余参数进行序列化</span></span><br><span class="line">    <span class="built_in">write</span>(head);</span><br><span class="line">    <span class="built_in">write_args</span>(args...);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 由于write_args()递归调用到最后参数为空，因此需要实现参数为空的write_args()版本，它里面什么都不做即可</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">write_args</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 可变参数类型反序列化</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> ...Args&gt;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read_args</span><span class="params">(T &amp; head, Args&amp;... args)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">read</span>(head);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">read_args</span>(args...);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 由于read_args()递归调用到最后参数为空，因此需要实现参数为空的read_args()版本，它里面直接返回true即可</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">read_args</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="literal">true</span>;&#125;</span><br></pre></td></tr></table></figure><p>这样，对于自定义类型数据序列化，该类仅需要：</p><ol><li>继承自<code>Serialize</code>这个接口类</li><li>使用<code>SERIALIZE</code>宏定义该类有哪些数据成员需要序列化与反序列化</li></ol><p>为了使用更方便，在<code>DataStream</code>类中对自定义类型也支持重载流运算符：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// serialize/data_stream.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">const</span> Serializable &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    value.<span class="built_in">serialize</span>(*<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(Serializable &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> value.<span class="built_in">unserialize</span>(*<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp; DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> Serializable &amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">write</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp; DataStream::<span class="keyword">operator</span>&gt;&gt;(Serializable &amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">read</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="序列化后的数据保存至文件-从文件中将数据恢复以用于反序列化">序列化后的数据保存至文件&amp;从文件中将数据恢复以用于反序列化</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// serialize/data_stream.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::save</span><span class="params">(<span class="type">const</span> string &amp; filename)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">std::ofstream <span class="title">ofs</span><span class="params">(filename)</span></span>;</span><br><span class="line">    <span class="comment">// write()将数据以二进制形式写入文件，但不一定立即写入磁盘</span></span><br><span class="line">    ofs.<span class="built_in">write</span>(<span class="built_in">data</span>(), <span class="built_in">size</span>());</span><br><span class="line">    <span class="comment">// flush()强制将缓冲区中的数据写入文件，即立即将缓冲区内容写入物理设备</span></span><br><span class="line">    <span class="comment">// 注意频繁调用flush()会影响I/O性能</span></span><br><span class="line">    ofs.<span class="built_in">flush</span>();</span><br><span class="line">    ofs.<span class="built_in">close</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 从文件恢复为DataStream</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::load</span><span class="params">(<span class="type">const</span> string &amp;filename)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">std::ifstream <span class="title">ifs</span><span class="params">(filename)</span></span>;</span><br><span class="line">    std::ostringstream oss;</span><br><span class="line">    oss &lt;&lt; ifs.<span class="built_in">rdbuf</span>();</span><br><span class="line">    <span class="type">const</span> string &amp; str = oss.<span class="built_in">str</span>();</span><br><span class="line">    <span class="built_in">reserve</span>(str.<span class="built_in">size</span>());</span><br><span class="line">    <span class="built_in">write</span>(str.<span class="built_in">data</span>(), str.<span class="built_in">size</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="完整实现">完整实现</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// serialize/data_stream.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;list&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;set&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdexcept&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;serialize/serializable.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> std::string;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> serialize</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">DataStream</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="comment">// 用枚举值表示序列化的数据类型</span></span><br><span class="line">            <span class="keyword">enum</span> <span class="title class_">DataType</span></span><br><span class="line">            &#123;</span><br><span class="line">                BOOL = <span class="number">0</span>,</span><br><span class="line">                CHAR,</span><br><span class="line">                INT32,</span><br><span class="line">                INT64,</span><br><span class="line">                FLOAT,</span><br><span class="line">                DOUBLE,</span><br><span class="line">                STRING,</span><br><span class="line">                VECTOR,</span><br><span class="line">                LIST,</span><br><span class="line">                MAP,</span><br><span class="line">                SET,</span><br><span class="line">                CUSTOM              <span class="comment">// 自定义类型</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">DataStream</span>();</span><br><span class="line">            ~<span class="built_in">DataStream</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 序列化接口</span></span><br><span class="line">            <span class="comment">// 为了支持将不同数据类型进行序列化，这里write()需要重载</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">bool</span> value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">char</span> value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">int32_t</span> value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">int64_t</span> value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">float</span> value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">double</span> value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">const</span> string &amp; value)</span></span>;</span><br><span class="line">            <span class="comment">// 将长度为len字节的数据继续写入buffer中</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * data, <span class="type">int</span> len)</span></span>;</span><br><span class="line">            <span class="comment">// 对自定义类型支持序列化，即支持对于实现Serializable接口的类进行序列化</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">const</span> Serializable &amp; value)</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 考虑到STL容器比如vector、list都是模板，因此这里实现模板函数</span></span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">const</span> std::vector&lt;T&gt; &amp; value)</span></span>;</span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">const</span> std::list&lt;T&gt; &amp; value)</span></span>;</span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> K, <span class="keyword">typename</span> V&gt;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">const</span> std::map&lt;K, V&gt; &amp; value)</span></span>;</span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">const</span> std::set&lt;T&gt; &amp; value)</span></span>;</span><br><span class="line">            <span class="comment">// 可变参数类型序列化</span></span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> ... Args&gt;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write_args</span><span class="params">(<span class="type">const</span> T &amp; head, <span class="type">const</span> Args&amp;... args)</span></span>;</span><br><span class="line">            <span class="comment">// 由于write_args()递归调用到最后参数为空，因此需要实现参数为空的write_args()版本，它里面什么都不做即可</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write_args</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 反序列化接口</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(<span class="type">char</span> * data, <span class="type">int</span> len)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(<span class="type">bool</span> &amp; value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(<span class="type">char</span> &amp; value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(<span class="type">int32_t</span> &amp; value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(<span class="type">int64_t</span> &amp; value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(<span class="type">float</span> &amp; value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(<span class="type">double</span> &amp; read)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(string &amp; str)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(Serializable &amp; value)</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(std::vector&lt;T&gt; &amp; value)</span></span>;</span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(std::list&lt;T&gt; &amp; value)</span></span>;</span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> K, <span class="keyword">typename</span> V&gt;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(std::map&lt;K, V&gt; &amp; value)</span></span>;</span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(std::set&lt;T&gt; &amp; value)</span></span>;</span><br><span class="line">            <span class="comment">// 可变参数类型反序列化</span></span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> ...Args&gt;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">read_args</span><span class="params">(T &amp; head, Args&amp;... args)</span></span>;</span><br><span class="line">            <span class="comment">// 由于read_args()递归调用到最后参数为空，因此需要实现参数为空的read_args()版本，它里面直接返回true即可</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">read_args</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="literal">true</span>;&#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">show</span><span class="params">()</span> <span class="type">const</span></span>;                              <span class="comment">// 将m_buf中的内容打印出来</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 为了代码在可用的基础上更好用，这里重载流运算符</span></span><br><span class="line">            <span class="comment">// 序列化</span></span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&lt;&lt;(<span class="type">bool</span> value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&lt;&lt;(<span class="type">char</span> value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&lt;&lt;(<span class="type">int32_t</span> value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&lt;&lt;(<span class="type">int64_t</span> value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&lt;&lt;(<span class="type">float</span> value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&lt;&lt;(<span class="type">double</span> value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> <span class="type">char</span> * value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> string &amp; value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> Serializable &amp; value);</span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> std::vector&lt;T&gt; &amp; value);</span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> std::list&lt;T&gt; &amp; value);</span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> K, <span class="keyword">typename</span> V&gt;</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> std::map&lt;K, V&gt; &amp; value);</span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> std::set&lt;T&gt; &amp; value);</span><br><span class="line">            </span><br><span class="line"></span><br><span class="line">            <span class="comment">// 反序列化</span></span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&gt;&gt;(<span class="type">bool</span> &amp; value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&gt;&gt;(<span class="type">char</span> &amp; value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&gt;&gt;(<span class="type">int32_t</span> &amp; value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&gt;&gt;(<span class="type">int64_t</span> &amp; value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&gt;&gt;(<span class="type">float</span> &amp; value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&gt;&gt;(<span class="type">double</span> &amp; value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&gt;&gt;(string &amp; value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&gt;&gt;(Serializable &amp; value);</span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&gt;&gt;(std::vector&lt;T&gt; &amp; value);</span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&gt;&gt;(std::list&lt;T&gt; &amp; value);</span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> K, <span class="keyword">typename</span> V&gt;</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&gt;&gt;(std::map&lt;K, V&gt; &amp; value);</span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&gt;&gt;(std::set&lt;T&gt; &amp; value);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">reserve</span><span class="params">(<span class="type">int</span> len)</span></span>;                          <span class="comment">// 对vector扩容，修改capacity字段</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            std::vector&lt;<span class="type">char</span>&gt; m_buf;                        <span class="comment">// 保存序列化后的内容</span></span><br><span class="line">            <span class="type">int</span> m_pos;                                      <span class="comment">// 序列化过程中保存记录的位置(反序列化时使用)</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">const</span> std::vector&lt;T&gt; &amp; value)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="type">char</span> type = DataType::VECTOR;</span><br><span class="line">            <span class="built_in">write</span>((<span class="type">char</span> *)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">            <span class="type">int32_t</span> len = value.<span class="built_in">size</span>();</span><br><span class="line">            <span class="built_in">write</span>(len);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">write</span>(value[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">const</span> std::list&lt;T&gt; &amp; value)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="type">char</span> type = DataType::LIST;</span><br><span class="line">            <span class="built_in">write</span>((<span class="type">char</span> *)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">            <span class="type">int32_t</span> len = value.<span class="built_in">size</span>();</span><br><span class="line">            <span class="built_in">write</span>(len);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">auto</span> it = value.<span class="built_in">begin</span>(); it != value.<span class="built_in">end</span>(); ++it)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">write</span>(*it);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> K, <span class="keyword">typename</span> V&gt;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">const</span> std::map&lt;K, V&gt; &amp; value)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="type">char</span> type = DataType::MAP;</span><br><span class="line">            <span class="built_in">write</span>((<span class="type">char</span> *)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">            <span class="type">int32_t</span> len = value.<span class="built_in">size</span>();</span><br><span class="line">            <span class="built_in">write</span>(len);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">auto</span> it = value.<span class="built_in">begin</span>(); it != value.<span class="built_in">end</span>(); ++it)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">write</span>(it-&gt;first);</span><br><span class="line">                <span class="built_in">write</span>(it-&gt;second);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">const</span> std::set&lt;T&gt; &amp; value)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="type">char</span> type = DataType::SET;</span><br><span class="line">            <span class="built_in">write</span>((<span class="type">char</span> *)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">            <span class="type">int32_t</span> len = value.<span class="built_in">size</span>();</span><br><span class="line">            <span class="built_in">write</span>(len);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">auto</span> it = value.<span class="built_in">begin</span>(); it != value.<span class="built_in">end</span>(); ++it)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">write</span>(*it);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> ... Args&gt;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">DataStream::write_args</span><span class="params">(<span class="type">const</span> T &amp; head, <span class="type">const</span> Args&amp;... args)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="comment">// 可变参数拆解为第1个参数head和剩余参数args</span></span><br><span class="line">            <span class="comment">// 先调用write()将第1个参数head进行序列化，然后递归调用write_args()对剩余参数进行序列化</span></span><br><span class="line">            <span class="built_in">write</span>(head);</span><br><span class="line">            <span class="built_in">write_args</span>(args...);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(std::vector&lt;T&gt; &amp; value)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            value.<span class="built_in">clear</span>();</span><br><span class="line">            <span class="keyword">if</span> (m_buf[m_pos] != DataType::VECTOR)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ++m_pos;</span><br><span class="line">            <span class="type">int</span> len = <span class="number">0</span>;</span><br><span class="line">            <span class="built_in">read</span>(len);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; ++i)</span><br><span class="line">            &#123;</span><br><span class="line">                T v;</span><br><span class="line">                <span class="built_in">read</span>(v);</span><br><span class="line">                value.<span class="built_in">push_back</span>(v);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(std::list&lt;T&gt; &amp; value)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            value.<span class="built_in">clear</span>();</span><br><span class="line">            <span class="keyword">if</span> (m_buf[m_pos] != DataType::LIST)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ++m_pos;</span><br><span class="line">            <span class="type">int</span> len = <span class="number">0</span>;</span><br><span class="line">            <span class="built_in">read</span>(len);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; ++i)</span><br><span class="line">            &#123;</span><br><span class="line">                T v;</span><br><span class="line">                <span class="built_in">read</span>(v);</span><br><span class="line">                value.<span class="built_in">push_back</span>(v);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> K, <span class="keyword">typename</span> V&gt;</span><br><span class="line">        <span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(std::map&lt;K, V&gt; &amp; value)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            value.<span class="built_in">clear</span>();</span><br><span class="line">            <span class="keyword">if</span> (m_buf[m_pos] != DataType::MAP)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ++m_pos;</span><br><span class="line">            <span class="type">int</span> len = <span class="number">0</span>;</span><br><span class="line">            <span class="built_in">read</span>(len);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; ++i)</span><br><span class="line">            &#123;</span><br><span class="line">                K k;</span><br><span class="line">                <span class="built_in">read</span>(k);</span><br><span class="line">                V v;</span><br><span class="line">                <span class="built_in">read</span>(v);</span><br><span class="line">                value[k] = v;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(std::set&lt;T&gt; &amp; value)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            value.<span class="built_in">clear</span>();</span><br><span class="line">            <span class="keyword">if</span> (m_buf[m_pos] != DataType::SET)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ++m_pos;</span><br><span class="line">            <span class="type">int</span> len = <span class="number">0</span>;</span><br><span class="line">            <span class="built_in">read</span>(len);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; ++i)</span><br><span class="line">            &#123;</span><br><span class="line">                T v;</span><br><span class="line">                <span class="built_in">read</span>(v);</span><br><span class="line">                value.<span class="built_in">insert</span>(v);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> ...Args&gt;</span><br><span class="line">        <span class="function"><span class="type">bool</span> <span class="title">DataStream::read_args</span><span class="params">(T &amp; head, Args&amp;... args)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="built_in">read</span>(head);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">read_args</span>(args...);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        DataStream &amp; DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> std::vector&lt;T&gt; &amp; value)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">write</span>(value);</span><br><span class="line">            <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        DataStream &amp; DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> std::list&lt;T&gt; &amp; value)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">write</span>(value);</span><br><span class="line">            <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> K, <span class="keyword">typename</span> V&gt;</span><br><span class="line">        DataStream &amp; DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> std::map&lt;K, V&gt; &amp; value)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">write</span>(value);</span><br><span class="line">            <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        DataStream &amp; DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> std::set&lt;T&gt; &amp; value)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">write</span>(value);</span><br><span class="line">            <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        DataStream &amp; DataStream::<span class="keyword">operator</span>&gt;&gt;(std::vector&lt;T&gt; &amp; value)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">read</span>(value);</span><br><span class="line">            <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        DataStream &amp; DataStream::<span class="keyword">operator</span>&gt;&gt;(std::list&lt;T&gt; &amp; value)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">read</span>(value);</span><br><span class="line">            <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> K, <span class="keyword">typename</span> V&gt;</span><br><span class="line">        DataStream &amp; DataStream::<span class="keyword">operator</span>&gt;&gt;(std::map&lt;K, V&gt; &amp; value)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">read</span>(value);</span><br><span class="line">            <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        DataStream &amp; DataStream::<span class="keyword">operator</span>&gt;&gt;(std::set&lt;T&gt; &amp; value)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">read</span>(value);</span><br><span class="line">            <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// serialize/data_stream.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;serialize/data_stream.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::serialize;</span><br><span class="line"></span><br><span class="line">DataStream::<span class="built_in">DataStream</span>() : <span class="built_in">m_pos</span>(<span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::reserve</span><span class="params">(<span class="type">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> size = m_buf.<span class="built_in">size</span>();</span><br><span class="line">    <span class="type">int</span> cap = m_buf.<span class="built_in">capacity</span>();</span><br><span class="line">    <span class="keyword">if</span> (size + len &gt; cap)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span> (size + len &gt; cap)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (cap == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cap = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                cap *= <span class="number">2</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        m_buf.<span class="built_in">reserve</span>(cap);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * data, <span class="type">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 先确保vector中空间足够写入</span></span><br><span class="line">    <span class="built_in">reserve</span>(len);</span><br><span class="line">    <span class="type">int</span> size = m_buf.<span class="built_in">size</span>();</span><br><span class="line">    <span class="comment">// 调用内存拷贝先确保m_buf有效空间足够写入</span></span><br><span class="line">    m_buf.<span class="built_in">resize</span>(m_buf.<span class="built_in">size</span>() + len);</span><br><span class="line">    <span class="comment">// 因为数据是二进制不是字符串，因此不能简单调用push_back()，这里直接进行内存拷贝</span></span><br><span class="line">    std::<span class="built_in">memcpy</span>(&amp;m_buf[size], data, len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">bool</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// bool类型序列化编码是2个字节，第1个字节是类型，第2个字节是它的值</span></span><br><span class="line">    <span class="type">char</span> type = DataStream::BOOL;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;value, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">char</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> type = DataStream::CHAR;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;value, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">int32_t</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> type = DataStream::INT32;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;value, <span class="built_in">sizeof</span>(<span class="type">int32_t</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">int64_t</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> type = DataStream::INT32;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;value, <span class="built_in">sizeof</span>(<span class="type">int64_t</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">float</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> type = DataStream::FLOAT;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;value, <span class="built_in">sizeof</span>(<span class="type">float</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">double</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> type = DataStream::DOUBLE;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;value, <span class="built_in">sizeof</span>(<span class="type">double</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 由于字符串属于可变长度，其序列化编码分为3部分：第1个字节表示其类型，然后5个字节表示字符串长度(int32)，剩余字节即字符串内容</span></span><br><span class="line">    <span class="type">char</span> type = DataStream::STRING;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="type">int32_t</span> len = <span class="built_in">strlen</span>(value);</span><br><span class="line">    <span class="built_in">write</span>(len);</span><br><span class="line">    <span class="built_in">write</span>(value, len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">const</span> string &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">write</span>(value.<span class="built_in">c_str</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">const</span> Serializable &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    value.<span class="built_in">serialize</span>(*<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp;DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">bool</span> value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">write</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp;DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">char</span> value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">write</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp;DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">int32_t</span> value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">write</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp;DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">int64_t</span> value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">write</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp;DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">float</span> value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">write</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp;DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">double</span> value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">write</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp;DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> <span class="type">char</span> * value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">write</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp;DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> string &amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">write</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp; DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> Serializable &amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">write</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::show</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> size = m_buf.<span class="built_in">size</span>();</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;data size = &quot;</span> &lt;&lt; size &lt;&lt; std::endl;</span><br><span class="line">    <span class="type">int</span> pos = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (pos &lt; size)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 基本数据类型序列化后第1个字节即其DataType数据类型</span></span><br><span class="line">        <span class="keyword">switch</span> ((DataType)m_buf[pos])</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">case</span> DataType::BOOL:</span><br><span class="line">            <span class="keyword">if</span> ((<span class="type">int</span>)m_buf[++pos] == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                std::cout &lt;&lt; <span class="string">&quot;false&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                std::cout &lt;&lt; <span class="string">&quot;true&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ++pos;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> DataType::CHAR:</span><br><span class="line">            std::cout &lt;&lt; m_buf[++pos];</span><br><span class="line">            ++pos;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> DataType::INT32:</span><br><span class="line">            std::cout &lt;&lt; *((<span class="type">int32_t</span> *)(&amp;m_buf[++pos]));</span><br><span class="line">            pos += <span class="number">4</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> DataType::INT64:</span><br><span class="line">            std::cout &lt;&lt; *((<span class="type">int64_t</span> *)(&amp;m_buf[++pos]));</span><br><span class="line">            pos += <span class="number">8</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> DataType::FLOAT:</span><br><span class="line">            std::cout &lt;&lt; *((<span class="type">float</span> *)(&amp;m_buf[++pos]));</span><br><span class="line">            pos += <span class="number">4</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> DataType::DOUBLE:</span><br><span class="line">            std::cout &lt;&lt; *((<span class="type">double</span> *)(&amp;m_buf[++pos]));</span><br><span class="line">            pos += <span class="number">8</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> DataType::STRING:</span><br><span class="line">            <span class="keyword">if</span> ((DataType)m_buf[++pos] == DataType::INT32)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="type">int32_t</span> len = *(<span class="type">int32_t</span> *)(&amp;m_buf[++pos]);</span><br><span class="line">                pos += <span class="number">4</span>;</span><br><span class="line">                std::cout &lt;&lt; <span class="built_in">string</span>(&amp;m_buf[pos], len);</span><br><span class="line">                pos += len;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;invalid string length&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;invalid data type&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(<span class="type">char</span> * data, <span class="type">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::<span class="built_in">memcpy</span>(data, (<span class="type">char</span>*)&amp;m_buf[m_pos], len);</span><br><span class="line">    m_pos += len;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(<span class="type">bool</span> &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 反序列化其实就是一个解码的过程，在反序列化过程中下标m_pos从前向后移动</span></span><br><span class="line">    <span class="keyword">if</span> (m_buf[m_pos] != DataType::BOOL)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++m_pos;</span><br><span class="line">    value = m_buf[m_pos];</span><br><span class="line">    ++m_pos;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(<span class="type">char</span> &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_buf[m_pos] != DataType::CHAR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++m_pos;</span><br><span class="line">    value = m_buf[m_pos];</span><br><span class="line">    ++m_pos;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(<span class="type">int32_t</span> &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_buf[m_pos] != DataType::INT32)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++m_pos;</span><br><span class="line">    value = *((<span class="type">int32_t</span> *)&amp;(m_buf[m_pos]));</span><br><span class="line">    m_pos += <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(<span class="type">int64_t</span> &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_buf[m_pos] != DataType::INT64)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++m_pos;</span><br><span class="line">    value = *((<span class="type">int64_t</span> *)&amp;(m_buf[m_pos]));</span><br><span class="line">    m_pos += <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(<span class="type">float</span> &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_buf[m_pos] != DataType::FLOAT)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++m_pos;</span><br><span class="line">    value = *((<span class="type">float</span> *)&amp;(m_buf[m_pos]));</span><br><span class="line">    m_pos += <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(<span class="type">double</span> &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_buf[m_pos] != DataType::DOUBLE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++m_pos;</span><br><span class="line">    value = *((<span class="type">double</span> *)&amp;(m_buf[m_pos]));</span><br><span class="line">    m_pos += <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(string &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_buf[m_pos] != DataType::STRING)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++m_pos;</span><br><span class="line">    <span class="type">int32_t</span> len = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">read</span>(len);</span><br><span class="line">    <span class="keyword">if</span> (len &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    value.<span class="built_in">assign</span>((<span class="type">char</span> *)&amp;(m_buf[m_pos]), len);</span><br><span class="line">    m_pos += len;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(Serializable &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> value.<span class="built_in">unserialize</span>(*<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp;DataStream::<span class="keyword">operator</span>&gt;&gt;(<span class="type">bool</span> &amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">read</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp;DataStream::<span class="keyword">operator</span>&gt;&gt;(<span class="type">char</span> &amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">read</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp;DataStream::<span class="keyword">operator</span>&gt;&gt;(<span class="type">int32_t</span> &amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">read</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp;DataStream::<span class="keyword">operator</span>&gt;&gt;(<span class="type">int64_t</span> &amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">read</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp;DataStream::<span class="keyword">operator</span>&gt;&gt;(<span class="type">float</span> &amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">read</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp;DataStream::<span class="keyword">operator</span>&gt;&gt;(<span class="type">double</span> &amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">read</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp;DataStream::<span class="keyword">operator</span>&gt;&gt;(string &amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">read</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp; DataStream::<span class="keyword">operator</span>&gt;&gt;(Serializable &amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">read</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// serializa/serializable.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> serialize</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 为了避免循环引用，这里使用前向声明:</span></span><br><span class="line">        <span class="comment">// 即当只需要使用类的指针或引用而不需要知道类的完整定义时，可以使用前向声明。</span></span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">DataStream</span>;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Serializable</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="comment">// 序列化</span></span><br><span class="line">            <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">serialize</span><span class="params">(DataStream &amp; stream)</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// 反序列化</span></span><br><span class="line">            <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">unserialize</span><span class="params">(DataStream &amp; stream)</span> </span>= <span class="number">0</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 由于不同类的数据成员是可变的，这里SERIALIZE宏传入可变参数...(传入宏的数据即需要序列化和反序列化的成员数据)</span></span><br><span class="line">    <span class="comment">// 这样自定义类型序列化直接用宏即可，不用手动实现serialize()和unserialize()这两个接口</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> SERIALIZE(...)                                      \</span></span><br><span class="line"><span class="meta">        void serialize(DataStream &amp; stream) const               \</span></span><br><span class="line"><span class="meta">        &#123;                                                       \</span></span><br><span class="line"><span class="meta">            char type = DataStream::CUSTOM;                     \</span></span><br><span class="line"><span class="meta">            stream.write((char*)&amp;type, sizeof(char));           \</span></span><br><span class="line"><span class="meta">            stream.write_args(__VA_ARGS__);                     \</span></span><br><span class="line"><span class="meta">        &#125;                                                       \</span></span><br><span class="line"><span class="meta">                                                                \</span></span><br><span class="line"><span class="meta">        bool unserialize(DataStream &amp; stream)                   \</span></span><br><span class="line"><span class="meta">        &#123;                                                       \</span></span><br><span class="line"><span class="meta">            char type;                                          \</span></span><br><span class="line"><span class="meta">            stream.read(&amp;type, sizeof(char));                   \</span></span><br><span class="line"><span class="meta">            <span class="keyword">if</span> (type != DataStream::CUSTOM)                     \</span></span><br><span class="line"><span class="meta">            &#123;                                                   \</span></span><br><span class="line"><span class="meta">                return false;                                   \</span></span><br><span class="line"><span class="meta">            &#125;                                                   \</span></span><br><span class="line"><span class="meta">            stream.read_args(__VA_ARGS__);                      \</span></span><br><span class="line"><span class="meta">            return true;                                        \</span></span><br><span class="line"><span class="meta">        &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;serialize/data_stream.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;serialize/serializable.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::serialize;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> : <span class="keyword">public</span> Serializable</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">SERIALIZE</span>(m_name, m_age);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">A</span>() = <span class="keyword">default</span>;</span><br><span class="line">    <span class="built_in">A</span>(<span class="type">const</span> string &amp; name, <span class="type">int</span> age) : <span class="built_in">m_name</span>(name), <span class="built_in">m_age</span>(age) &#123;&#125;</span><br><span class="line">    ~<span class="built_in">A</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">show</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;name = &quot;</span> &lt;&lt; m_name &lt;&lt; <span class="string">&quot;, age = &quot;</span> &lt;&lt; m_age &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    string m_name;</span><br><span class="line">    <span class="type">int</span> m_age;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">A <span class="title">a1</span><span class="params">(<span class="string">&quot;jack&quot;</span>, <span class="number">18</span>)</span></span>;</span><br><span class="line">    DataStream ds;</span><br><span class="line">    ds &lt;&lt; a1;</span><br><span class="line">    A a2;</span><br><span class="line">    ds &gt;&gt; a2;</span><br><span class="line">    a2.<span class="built_in">show</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="大端与小端">大端与小端</h2><h3 id="字节序">字节序</h3><p>在计算机科学领域中，字节序指电脑内存中或在数字通信链路中，组成多字节的字的字节的排列顺序。</p><p><img src="https://aliyun-oss-zh.oss-cn-beijing.aliyuncs.com/img/QQ20250713-204923.jpg" alt=""></p><h3 id="小端">小端</h3><p>Little-Endian：将低序字节存储在起始地址（低位编址），在变量指针转换的时候地址保持不变，比如<code>int64*</code>转到<code>int32*</code>，对于机器计算来说更友好和自然。</p><h3 id="大端">大端</h3><p>Big-Endian：将高序字节存储在起始地址（高位编址），内存顺序和数字的书写顺序是一致的，对于人的直观思维比较容易理解，网络字节序统一规定采用Big-Endian。</p><h3 id="检测字节序">检测字节序</h3><p>1、Linux系统中提供了宏<code>__BYTE_ORDER</code>来检测字节序，同时还定义了 <code>__LITTLE_ENDIAN</code> 和 <code>__BIG_ENDIAN</code> 用于比较</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;endian.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> * argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (__BYTE_ORDER == __LITTLE_ENDIAN)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Little-Endian\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (__BYTE_ORDER == __BIG_ENDIAN)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Big-Endian\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Unknown\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2、使用指针或联合体<code>Union</code></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">isLittleEndian</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> num = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 如果是小端序，最低有效字节存储在内存低地址</span></span><br><span class="line">    <span class="keyword">return</span> (*(<span class="type">char</span> *)&amp;num == <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">isLittleEndian</span>()) &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;(Little-Endian)&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;(Big-Endian)&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">isLittleEndian</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        <span class="type">int</span> i;</span><br><span class="line">        <span class="type">char</span> c[<span class="built_in">sizeof</span>(<span class="type">int</span>)];</span><br><span class="line">    &#125; u;</span><br><span class="line">    u.i = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> u.c[<span class="number">0</span>] == <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; (<span class="built_in">isLittleEndian</span>() ? <span class="string">&quot;Little-Endian&quot;</span> : <span class="string">&quot;Big-Endian&quot;</span>) &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3、C++20的<code>std::endian</code></p><p>如果使用C++20或更高版本，可以直接使用<code>&lt;bits&gt;</code>头文件提供的<code>std::endian</code>。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bit&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">if</span> <span class="title">constexpr</span> <span class="params">(std::endian::native == std::endian::little)</span> </span>&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Little-Endian&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="built_in">constexpr</span> (std::endian::native == std::endian::big) &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Big-Endian&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Unknown&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="序列化支持大端和小端">序列化支持大端和小端</h3><p>序列化与反序列化库为了支持大小端，添加了大小端枚举，并且新增了数据成员表示机器的字节序：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// serialize/data_stream.h</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DataStream</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 用枚举值表示序列化的数据类型</span></span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">DataType</span></span><br><span class="line">    &#123;</span><br><span class="line">        BOOL = <span class="number">0</span>,</span><br><span class="line">        CHAR,</span><br><span class="line">        INT32,</span><br><span class="line">        INT64,</span><br><span class="line">        FLOAT,</span><br><span class="line">        DOUBLE,</span><br><span class="line">        STRING,</span><br><span class="line">        VECTOR,</span><br><span class="line">        LIST,</span><br><span class="line">        MAP,</span><br><span class="line">        SET,</span><br><span class="line">        CUSTOM              <span class="comment">// 自定义类型</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 枚举ByteOrder是为了支持大小端兼容性</span></span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">ByteOrder</span></span><br><span class="line">    &#123;</span><br><span class="line">        BigEndian = <span class="number">0</span>,</span><br><span class="line">        LittleEndian</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    </span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::vector&lt;<span class="type">char</span>&gt; m_buf;                        <span class="comment">// 保存序列化后的内容</span></span><br><span class="line">    <span class="type">int</span> m_pos;                                      <span class="comment">// 序列化过程中保存记录的位置(反序列化时使用)</span></span><br><span class="line">    ByteOrder m_byteorder;                          <span class="comment">// 字节序</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// serialize/data_stream.cpp</span></span><br><span class="line"></span><br><span class="line">DataStream::<span class="built_in">DataStream</span>() : <span class="built_in">m_pos</span>(<span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    m_byteorder = <span class="built_in">byteorder</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line">    </span><br><span class="line"><span class="function">DataStream::ByteOrder <span class="title">DataStream::byteorder</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> x = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> *(<span class="type">char</span> *)&amp;x == <span class="number">1</span> ? ByteOrder::LittleEndian : ByteOrder::BigEndian;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对于多字节的数据类型和对象需要做大小端的处理，包括<code>int32</code>、<code>int64</code>、<code>float</code>、<code>double</code>的序列化<code>write()</code>和反序列化<code>read()</code>的实现都需要相应修改：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// serialize/data_stream.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">int32_t</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> type = DataStream::INT32;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="keyword">if</span> (m_byteorder == BIG_ENDIAN)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> * first = (<span class="type">char</span>*)&amp;value;                       <span class="comment">// int32_t的第1个字节位置</span></span><br><span class="line">        <span class="type">char</span> * last = first + <span class="built_in">sizeof</span>(<span class="type">int32_t</span>);              <span class="comment">// int64_t的最后1个字节位置</span></span><br><span class="line">        std::<span class="built_in">reverse</span>(first, last);                          <span class="comment">// 对字节序做反转</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;value, <span class="built_in">sizeof</span>(<span class="type">int32_t</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">int64_t</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> type = DataStream::INT32;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="keyword">if</span> (m_byteorder == BIG_ENDIAN)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> * first = (<span class="type">char</span>*)&amp;value;</span><br><span class="line">        <span class="type">char</span> * last = first + <span class="built_in">sizeof</span>(<span class="type">int64_t</span>);</span><br><span class="line">        std::<span class="built_in">reverse</span>(first, last);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;value, <span class="built_in">sizeof</span>(<span class="type">int64_t</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">float</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> type = DataStream::FLOAT;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="keyword">if</span> (m_byteorder == BIG_ENDIAN)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> * first = (<span class="type">char</span>*)&amp;value;</span><br><span class="line">        <span class="type">char</span> * last = first + <span class="built_in">sizeof</span>(<span class="type">float</span>);</span><br><span class="line">        std::<span class="built_in">reverse</span>(first, last);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;value, <span class="built_in">sizeof</span>(<span class="type">float</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">double</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> type = DataStream::DOUBLE;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="keyword">if</span> (m_byteorder == BIG_ENDIAN)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> * first = (<span class="type">char</span>*)&amp;value;</span><br><span class="line">        <span class="type">char</span> * last = first + <span class="built_in">sizeof</span>(<span class="type">double</span>);</span><br><span class="line">        std::<span class="built_in">reverse</span>(first, last);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;value, <span class="built_in">sizeof</span>(<span class="type">double</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(<span class="type">int32_t</span> &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_buf[m_pos] != DataType::INT32)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++m_pos;</span><br><span class="line">    value = *((<span class="type">int32_t</span> *)&amp;(m_buf[m_pos]));</span><br><span class="line">    <span class="keyword">if</span> (m_byteorder == BIG_ENDIAN)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> * first = (<span class="type">char</span>*)&amp;value;</span><br><span class="line">        <span class="type">char</span> * last = first + <span class="built_in">sizeof</span>(<span class="type">int32_t</span>);</span><br><span class="line">        std::<span class="built_in">reverse</span>(first, last);</span><br><span class="line">    &#125;</span><br><span class="line">    m_pos += <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(<span class="type">int64_t</span> &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_buf[m_pos] != DataType::INT64)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++m_pos;</span><br><span class="line">    value = *((<span class="type">int64_t</span> *)&amp;(m_buf[m_pos]));</span><br><span class="line">    <span class="keyword">if</span> (m_byteorder == BIG_ENDIAN)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> * first = (<span class="type">char</span>*)&amp;value;</span><br><span class="line">        <span class="type">char</span> * last = first + <span class="built_in">sizeof</span>(<span class="type">int64_t</span>);</span><br><span class="line">        std::<span class="built_in">reverse</span>(first, last);</span><br><span class="line">    &#125;</span><br><span class="line">    m_pos += <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(<span class="type">float</span> &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_buf[m_pos] != DataType::FLOAT)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++m_pos;</span><br><span class="line">    value = *((<span class="type">float</span> *)&amp;(m_buf[m_pos]));</span><br><span class="line">    <span class="keyword">if</span> (m_byteorder == BIG_ENDIAN)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> * first = (<span class="type">char</span>*)&amp;value;</span><br><span class="line">        <span class="type">char</span> * last = first + <span class="built_in">sizeof</span>(<span class="type">float</span>);</span><br><span class="line">        std::<span class="built_in">reverse</span>(first, last);</span><br><span class="line">    &#125;</span><br><span class="line">    m_pos += <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(<span class="type">double</span> &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_buf[m_pos] != DataType::DOUBLE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++m_pos;</span><br><span class="line">    value = *((<span class="type">double</span> *)&amp;(m_buf[m_pos]));</span><br><span class="line">    <span class="keyword">if</span> (m_byteorder == BIG_ENDIAN)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> * first = (<span class="type">char</span>*)&amp;value;</span><br><span class="line">        <span class="type">char</span> * last = first + <span class="built_in">sizeof</span>(<span class="type">double</span>);</span><br><span class="line">        std::<span class="built_in">reverse</span>(first, last);</span><br><span class="line">    &#125;</span><br><span class="line">    m_pos += <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="完整实现">完整实现</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// serialize/data_stream.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;list&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;set&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdexcept&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;serialize/serializable.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> std::string;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> serialize</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">DataStream</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="comment">// 用枚举值表示序列化的数据类型</span></span><br><span class="line">            <span class="keyword">enum</span> <span class="title class_">DataType</span></span><br><span class="line">            &#123;</span><br><span class="line">                BOOL = <span class="number">0</span>,</span><br><span class="line">                CHAR,</span><br><span class="line">                INT32,</span><br><span class="line">                INT64,</span><br><span class="line">                FLOAT,</span><br><span class="line">                DOUBLE,</span><br><span class="line">                STRING,</span><br><span class="line">                VECTOR,</span><br><span class="line">                LIST,</span><br><span class="line">                MAP,</span><br><span class="line">                SET,</span><br><span class="line">                CUSTOM              <span class="comment">// 自定义类型</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 枚举ByteOrder是为了支持大小端兼容性</span></span><br><span class="line">            <span class="keyword">enum</span> <span class="title class_">ByteOrder</span></span><br><span class="line">            &#123;</span><br><span class="line">                BigEndian = <span class="number">0</span>,</span><br><span class="line">                LittleEndian</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">DataStream</span>();</span><br><span class="line">            ~<span class="built_in">DataStream</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 序列化接口</span></span><br><span class="line">            <span class="comment">// 为了支持将不同数据类型进行序列化，这里write()需要重载</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">bool</span> value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">char</span> value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">int32_t</span> value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">int64_t</span> value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">float</span> value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">double</span> value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">const</span> string &amp; value)</span></span>;</span><br><span class="line">            <span class="comment">// 将长度为len字节的数据继续写入buffer中</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * data, <span class="type">int</span> len)</span></span>;</span><br><span class="line">            <span class="comment">// 对自定义类型支持序列化，即支持对于实现Serializable接口的类进行序列化</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">const</span> Serializable &amp; value)</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 考虑到STL容器比如vector、list都是模板，因此这里实现模板函数</span></span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">const</span> std::vector&lt;T&gt; &amp; value)</span></span>;</span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">const</span> std::list&lt;T&gt; &amp; value)</span></span>;</span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> K, <span class="keyword">typename</span> V&gt;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">const</span> std::map&lt;K, V&gt; &amp; value)</span></span>;</span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">const</span> std::set&lt;T&gt; &amp; value)</span></span>;</span><br><span class="line">            <span class="comment">// 可变参数类型序列化</span></span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> ... Args&gt;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write_args</span><span class="params">(<span class="type">const</span> T &amp; head, <span class="type">const</span> Args&amp;... args)</span></span>;</span><br><span class="line">            <span class="comment">// 由于write_args()递归调用到最后参数为空，因此需要实现参数为空的write_args()版本，它里面什么都不做即可</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">write_args</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 反序列化接口</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(<span class="type">char</span> * data, <span class="type">int</span> len)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(<span class="type">bool</span> &amp; value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(<span class="type">char</span> &amp; value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(<span class="type">int32_t</span> &amp; value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(<span class="type">int64_t</span> &amp; value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(<span class="type">float</span> &amp; value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(<span class="type">double</span> &amp; read)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(string &amp; str)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(Serializable &amp; value)</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(std::vector&lt;T&gt; &amp; value)</span></span>;</span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(std::list&lt;T&gt; &amp; value)</span></span>;</span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> K, <span class="keyword">typename</span> V&gt;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(std::map&lt;K, V&gt; &amp; value)</span></span>;</span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(std::set&lt;T&gt; &amp; value)</span></span>;</span><br><span class="line">            <span class="comment">// 可变参数类型反序列化</span></span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> ...Args&gt;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">read_args</span><span class="params">(T &amp; head, Args&amp;... args)</span></span>;</span><br><span class="line">            <span class="comment">// 由于read_args()递归调用到最后参数为空，因此需要实现参数为空的read_args()版本，它里面直接返回true即可</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">read_args</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> <span class="literal">true</span>;&#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">show</span><span class="params">()</span> <span class="type">const</span></span>;                              <span class="comment">// 将m_buf中的内容打印出来</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 为了代码在可用的基础上更好用，这里重载流运算符</span></span><br><span class="line">            <span class="comment">// 序列化</span></span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&lt;&lt;(<span class="type">bool</span> value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&lt;&lt;(<span class="type">char</span> value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&lt;&lt;(<span class="type">int32_t</span> value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&lt;&lt;(<span class="type">int64_t</span> value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&lt;&lt;(<span class="type">float</span> value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&lt;&lt;(<span class="type">double</span> value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> <span class="type">char</span> * value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> string &amp; value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> Serializable &amp; value);</span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> std::vector&lt;T&gt; &amp; value);</span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> std::list&lt;T&gt; &amp; value);</span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> K, <span class="keyword">typename</span> V&gt;</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> std::map&lt;K, V&gt; &amp; value);</span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> std::set&lt;T&gt; &amp; value);</span><br><span class="line">            </span><br><span class="line"></span><br><span class="line">            <span class="comment">// 反序列化</span></span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&gt;&gt;(<span class="type">bool</span> &amp; value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&gt;&gt;(<span class="type">char</span> &amp; value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&gt;&gt;(<span class="type">int32_t</span> &amp; value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&gt;&gt;(<span class="type">int64_t</span> &amp; value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&gt;&gt;(<span class="type">float</span> &amp; value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&gt;&gt;(<span class="type">double</span> &amp; value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&gt;&gt;(string &amp; value);</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&gt;&gt;(Serializable &amp; value);</span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&gt;&gt;(std::vector&lt;T&gt; &amp; value);</span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&gt;&gt;(std::list&lt;T&gt; &amp; value);</span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> K, <span class="keyword">typename</span> V&gt;</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&gt;&gt;(std::map&lt;K, V&gt; &amp; value);</span><br><span class="line">            <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">            DataStream &amp; <span class="keyword">operator</span>&gt;&gt;(std::set&lt;T&gt; &amp; value);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取DataStream中buffer的指针</span></span><br><span class="line">            <span class="function"><span class="type">const</span> <span class="type">char</span> * <span class="title">data</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="comment">// 获取DataStream中buffer的大小</span></span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">size</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="comment">// 清空DataStream中的buffer</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">clear</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="comment">// 将DataStream中的下标m_pos重置为0</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">reset</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="comment">// 将序列化后的数据保存至文件中</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">save</span><span class="params">(<span class="type">const</span> string &amp; filename)</span></span>;</span><br><span class="line">            <span class="comment">// 从文件恢复为DataStream</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">load</span><span class="params">(<span class="type">const</span> string &amp; filename)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">reserve</span><span class="params">(<span class="type">int</span> len)</span></span>;                          <span class="comment">// 对vector扩容，修改capacity字段</span></span><br><span class="line">            <span class="function">ByteOrder <span class="title">byteorder</span><span class="params">()</span></span>;                          <span class="comment">// 返回当前机器是大端还是小端</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            std::vector&lt;<span class="type">char</span>&gt; m_buf;                        <span class="comment">// 保存序列化后的内容</span></span><br><span class="line">            <span class="type">int</span> m_pos;                                      <span class="comment">// 序列化过程中保存记录的位置(反序列化时使用)</span></span><br><span class="line">            ByteOrder m_byteorder;                          <span class="comment">// 字节序</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">const</span> std::vector&lt;T&gt; &amp; value)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="type">char</span> type = DataType::VECTOR;</span><br><span class="line">            <span class="built_in">write</span>((<span class="type">char</span> *)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">            <span class="type">int32_t</span> len = value.<span class="built_in">size</span>();</span><br><span class="line">            <span class="built_in">write</span>(len);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">write</span>(value[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">const</span> std::list&lt;T&gt; &amp; value)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="type">char</span> type = DataType::LIST;</span><br><span class="line">            <span class="built_in">write</span>((<span class="type">char</span> *)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">            <span class="type">int32_t</span> len = value.<span class="built_in">size</span>();</span><br><span class="line">            <span class="built_in">write</span>(len);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">auto</span> it = value.<span class="built_in">begin</span>(); it != value.<span class="built_in">end</span>(); ++it)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">write</span>(*it);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> K, <span class="keyword">typename</span> V&gt;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">const</span> std::map&lt;K, V&gt; &amp; value)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="type">char</span> type = DataType::MAP;</span><br><span class="line">            <span class="built_in">write</span>((<span class="type">char</span> *)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">            <span class="type">int32_t</span> len = value.<span class="built_in">size</span>();</span><br><span class="line">            <span class="built_in">write</span>(len);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">auto</span> it = value.<span class="built_in">begin</span>(); it != value.<span class="built_in">end</span>(); ++it)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">write</span>(it-&gt;first);</span><br><span class="line">                <span class="built_in">write</span>(it-&gt;second);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">const</span> std::set&lt;T&gt; &amp; value)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="type">char</span> type = DataType::SET;</span><br><span class="line">            <span class="built_in">write</span>((<span class="type">char</span> *)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">            <span class="type">int32_t</span> len = value.<span class="built_in">size</span>();</span><br><span class="line">            <span class="built_in">write</span>(len);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">auto</span> it = value.<span class="built_in">begin</span>(); it != value.<span class="built_in">end</span>(); ++it)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">write</span>(*it);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> ... Args&gt;</span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">DataStream::write_args</span><span class="params">(<span class="type">const</span> T &amp; head, <span class="type">const</span> Args&amp;... args)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="comment">// 可变参数拆解为第1个参数head和剩余参数args</span></span><br><span class="line">            <span class="comment">// 先调用write()将第1个参数head进行序列化，然后递归调用write_args()对剩余参数进行序列化</span></span><br><span class="line">            <span class="built_in">write</span>(head);</span><br><span class="line">            <span class="built_in">write_args</span>(args...);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(std::vector&lt;T&gt; &amp; value)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            value.<span class="built_in">clear</span>();</span><br><span class="line">            <span class="keyword">if</span> (m_buf[m_pos] != DataType::VECTOR)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ++m_pos;</span><br><span class="line">            <span class="type">int</span> len = <span class="number">0</span>;</span><br><span class="line">            <span class="built_in">read</span>(len);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; ++i)</span><br><span class="line">            &#123;</span><br><span class="line">                T v;</span><br><span class="line">                <span class="built_in">read</span>(v);</span><br><span class="line">                value.<span class="built_in">push_back</span>(v);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(std::list&lt;T&gt; &amp; value)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            value.<span class="built_in">clear</span>();</span><br><span class="line">            <span class="keyword">if</span> (m_buf[m_pos] != DataType::LIST)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ++m_pos;</span><br><span class="line">            <span class="type">int</span> len = <span class="number">0</span>;</span><br><span class="line">            <span class="built_in">read</span>(len);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; ++i)</span><br><span class="line">            &#123;</span><br><span class="line">                T v;</span><br><span class="line">                <span class="built_in">read</span>(v);</span><br><span class="line">                value.<span class="built_in">push_back</span>(v);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> K, <span class="keyword">typename</span> V&gt;</span><br><span class="line">        <span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(std::map&lt;K, V&gt; &amp; value)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            value.<span class="built_in">clear</span>();</span><br><span class="line">            <span class="keyword">if</span> (m_buf[m_pos] != DataType::MAP)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ++m_pos;</span><br><span class="line">            <span class="type">int</span> len = <span class="number">0</span>;</span><br><span class="line">            <span class="built_in">read</span>(len);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; ++i)</span><br><span class="line">            &#123;</span><br><span class="line">                K k;</span><br><span class="line">                <span class="built_in">read</span>(k);</span><br><span class="line">                V v;</span><br><span class="line">                <span class="built_in">read</span>(v);</span><br><span class="line">                value[k] = v;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(std::set&lt;T&gt; &amp; value)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            value.<span class="built_in">clear</span>();</span><br><span class="line">            <span class="keyword">if</span> (m_buf[m_pos] != DataType::SET)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ++m_pos;</span><br><span class="line">            <span class="type">int</span> len = <span class="number">0</span>;</span><br><span class="line">            <span class="built_in">read</span>(len);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; ++i)</span><br><span class="line">            &#123;</span><br><span class="line">                T v;</span><br><span class="line">                <span class="built_in">read</span>(v);</span><br><span class="line">                value.<span class="built_in">insert</span>(v);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> ...Args&gt;</span><br><span class="line">        <span class="function"><span class="type">bool</span> <span class="title">DataStream::read_args</span><span class="params">(T &amp; head, Args&amp;... args)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="built_in">read</span>(head);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">read_args</span>(args...);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        DataStream &amp; DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> std::vector&lt;T&gt; &amp; value)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">write</span>(value);</span><br><span class="line">            <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        DataStream &amp; DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> std::list&lt;T&gt; &amp; value)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">write</span>(value);</span><br><span class="line">            <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> K, <span class="keyword">typename</span> V&gt;</span><br><span class="line">        DataStream &amp; DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> std::map&lt;K, V&gt; &amp; value)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">write</span>(value);</span><br><span class="line">            <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        DataStream &amp; DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> std::set&lt;T&gt; &amp; value)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">write</span>(value);</span><br><span class="line">            <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        DataStream &amp; DataStream::<span class="keyword">operator</span>&gt;&gt;(std::vector&lt;T&gt; &amp; value)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">read</span>(value);</span><br><span class="line">            <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        DataStream &amp; DataStream::<span class="keyword">operator</span>&gt;&gt;(std::list&lt;T&gt; &amp; value)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">read</span>(value);</span><br><span class="line">            <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> K, <span class="keyword">typename</span> V&gt;</span><br><span class="line">        DataStream &amp; DataStream::<span class="keyword">operator</span>&gt;&gt;(std::map&lt;K, V&gt; &amp; value)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">read</span>(value);</span><br><span class="line">            <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        DataStream &amp; DataStream::<span class="keyword">operator</span>&gt;&gt;(std::set&lt;T&gt; &amp; value)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">read</span>(value);</span><br><span class="line">            <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// serialize/data_stream.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;serialize/data_stream.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::serialize;</span><br><span class="line"></span><br><span class="line">DataStream::<span class="built_in">DataStream</span>() : <span class="built_in">m_pos</span>(<span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    m_byteorder = <span class="built_in">byteorder</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::reserve</span><span class="params">(<span class="type">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> size = m_buf.<span class="built_in">size</span>();</span><br><span class="line">    <span class="type">int</span> cap = m_buf.<span class="built_in">capacity</span>();</span><br><span class="line">    <span class="keyword">if</span> (size + len &gt; cap)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span> (size + len &gt; cap)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (cap == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cap = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                cap *= <span class="number">2</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        m_buf.<span class="built_in">reserve</span>(cap);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">DataStream::ByteOrder <span class="title">DataStream::byteorder</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> x = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> *(<span class="type">char</span> *)&amp;x == <span class="number">1</span> ? ByteOrder::LittleEndian : ByteOrder::BigEndian;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * data, <span class="type">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 先确保vector中空间足够写入</span></span><br><span class="line">    <span class="built_in">reserve</span>(len);</span><br><span class="line">    <span class="type">int</span> size = m_buf.<span class="built_in">size</span>();</span><br><span class="line">    <span class="comment">// 调用内存拷贝先确保m_buf有效空间足够写入</span></span><br><span class="line">    m_buf.<span class="built_in">resize</span>(m_buf.<span class="built_in">size</span>() + len);</span><br><span class="line">    <span class="comment">// 因为数据是二进制不是字符串，因此不能简单调用push_back()，这里直接进行内存拷贝</span></span><br><span class="line">    std::<span class="built_in">memcpy</span>(&amp;m_buf[size], data, len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">bool</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// bool类型序列化编码是2个字节，第1个字节是类型，第2个字节是它的值</span></span><br><span class="line">    <span class="type">char</span> type = DataStream::BOOL;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;value, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">char</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> type = DataStream::CHAR;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;value, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">int32_t</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> type = DataStream::INT32;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="keyword">if</span> (m_byteorder == BIG_ENDIAN)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> * first = (<span class="type">char</span>*)&amp;value;                       <span class="comment">// int32_t的第1个字节位置</span></span><br><span class="line">        <span class="type">char</span> * last = first + <span class="built_in">sizeof</span>(<span class="type">int32_t</span>);              <span class="comment">// int64_t的最后1个字节位置</span></span><br><span class="line">        std::<span class="built_in">reverse</span>(first, last);                          <span class="comment">// 对字节序做反转</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;value, <span class="built_in">sizeof</span>(<span class="type">int32_t</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">int64_t</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> type = DataStream::INT32;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="keyword">if</span> (m_byteorder == BIG_ENDIAN)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> * first = (<span class="type">char</span>*)&amp;value;</span><br><span class="line">        <span class="type">char</span> * last = first + <span class="built_in">sizeof</span>(<span class="type">int64_t</span>);</span><br><span class="line">        std::<span class="built_in">reverse</span>(first, last);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;value, <span class="built_in">sizeof</span>(<span class="type">int64_t</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">float</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> type = DataStream::FLOAT;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="keyword">if</span> (m_byteorder == BIG_ENDIAN)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> * first = (<span class="type">char</span>*)&amp;value;</span><br><span class="line">        <span class="type">char</span> * last = first + <span class="built_in">sizeof</span>(<span class="type">float</span>);</span><br><span class="line">        std::<span class="built_in">reverse</span>(first, last);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;value, <span class="built_in">sizeof</span>(<span class="type">float</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">double</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> type = DataStream::DOUBLE;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="keyword">if</span> (m_byteorder == BIG_ENDIAN)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> * first = (<span class="type">char</span>*)&amp;value;</span><br><span class="line">        <span class="type">char</span> * last = first + <span class="built_in">sizeof</span>(<span class="type">double</span>);</span><br><span class="line">        std::<span class="built_in">reverse</span>(first, last);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;value, <span class="built_in">sizeof</span>(<span class="type">double</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 由于字符串属于可变长度，其序列化编码分为3部分：第1个字节表示其类型，然后5个字节表示字符串长度(int32)，剩余字节即字符串内容</span></span><br><span class="line">    <span class="type">char</span> type = DataStream::STRING;</span><br><span class="line">    <span class="built_in">write</span>((<span class="type">char</span> *)&amp;type, <span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="type">int32_t</span> len = <span class="built_in">strlen</span>(value);</span><br><span class="line">    <span class="built_in">write</span>(len);</span><br><span class="line">    <span class="built_in">write</span>(value, len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">const</span> string &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">write</span>(value.<span class="built_in">c_str</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::write</span><span class="params">(<span class="type">const</span> Serializable &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    value.<span class="built_in">serialize</span>(*<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp;DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">bool</span> value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">write</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp;DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">char</span> value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">write</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp;DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">int32_t</span> value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">write</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp;DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">int64_t</span> value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">write</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp;DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">float</span> value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">write</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp;DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">double</span> value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">write</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp;DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> <span class="type">char</span> * value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">write</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp;DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> string &amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">write</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp; DataStream::<span class="keyword">operator</span>&lt;&lt;(<span class="type">const</span> Serializable &amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">write</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::show</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> size = m_buf.<span class="built_in">size</span>();</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;data size = &quot;</span> &lt;&lt; size &lt;&lt; std::endl;</span><br><span class="line">    <span class="type">int</span> pos = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (pos &lt; size)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 基本数据类型序列化后第1个字节即其DataType数据类型</span></span><br><span class="line">        <span class="keyword">switch</span> ((DataType)m_buf[pos])</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">case</span> DataType::BOOL:</span><br><span class="line">            <span class="keyword">if</span> ((<span class="type">int</span>)m_buf[++pos] == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                std::cout &lt;&lt; <span class="string">&quot;false&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                std::cout &lt;&lt; <span class="string">&quot;true&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ++pos;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> DataType::CHAR:</span><br><span class="line">            std::cout &lt;&lt; m_buf[++pos];</span><br><span class="line">            ++pos;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> DataType::INT32:</span><br><span class="line">            std::cout &lt;&lt; *((<span class="type">int32_t</span> *)(&amp;m_buf[++pos]));</span><br><span class="line">            pos += <span class="number">4</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> DataType::INT64:</span><br><span class="line">            std::cout &lt;&lt; *((<span class="type">int64_t</span> *)(&amp;m_buf[++pos]));</span><br><span class="line">            pos += <span class="number">8</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> DataType::FLOAT:</span><br><span class="line">            std::cout &lt;&lt; *((<span class="type">float</span> *)(&amp;m_buf[++pos]));</span><br><span class="line">            pos += <span class="number">4</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> DataType::DOUBLE:</span><br><span class="line">            std::cout &lt;&lt; *((<span class="type">double</span> *)(&amp;m_buf[++pos]));</span><br><span class="line">            pos += <span class="number">8</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> DataType::STRING:</span><br><span class="line">            <span class="keyword">if</span> ((DataType)m_buf[++pos] == DataType::INT32)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="type">int32_t</span> len = *(<span class="type">int32_t</span> *)(&amp;m_buf[++pos]);</span><br><span class="line">                pos += <span class="number">4</span>;</span><br><span class="line">                std::cout &lt;&lt; <span class="built_in">string</span>(&amp;m_buf[pos], len);</span><br><span class="line">                pos += len;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;invalid string length&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;invalid data type&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(<span class="type">char</span> * data, <span class="type">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::<span class="built_in">memcpy</span>(data, (<span class="type">char</span>*)&amp;m_buf[m_pos], len);</span><br><span class="line">    m_pos += len;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(<span class="type">bool</span> &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 反序列化其实就是一个解码的过程，在反序列化过程中下标m_pos从前向后移动</span></span><br><span class="line">    <span class="keyword">if</span> (m_buf[m_pos] != DataType::BOOL)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++m_pos;</span><br><span class="line">    value = m_buf[m_pos];</span><br><span class="line">    ++m_pos;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(<span class="type">char</span> &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_buf[m_pos] != DataType::CHAR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++m_pos;</span><br><span class="line">    value = m_buf[m_pos];</span><br><span class="line">    ++m_pos;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(<span class="type">int32_t</span> &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_buf[m_pos] != DataType::INT32)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++m_pos;</span><br><span class="line">    value = *((<span class="type">int32_t</span> *)&amp;(m_buf[m_pos]));</span><br><span class="line">    <span class="keyword">if</span> (m_byteorder == BIG_ENDIAN)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> * first = (<span class="type">char</span>*)&amp;value;</span><br><span class="line">        <span class="type">char</span> * last = first + <span class="built_in">sizeof</span>(<span class="type">int32_t</span>);</span><br><span class="line">        std::<span class="built_in">reverse</span>(first, last);</span><br><span class="line">    &#125;</span><br><span class="line">    m_pos += <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(<span class="type">int64_t</span> &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_buf[m_pos] != DataType::INT64)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++m_pos;</span><br><span class="line">    value = *((<span class="type">int64_t</span> *)&amp;(m_buf[m_pos]));</span><br><span class="line">    <span class="keyword">if</span> (m_byteorder == BIG_ENDIAN)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> * first = (<span class="type">char</span>*)&amp;value;</span><br><span class="line">        <span class="type">char</span> * last = first + <span class="built_in">sizeof</span>(<span class="type">int64_t</span>);</span><br><span class="line">        std::<span class="built_in">reverse</span>(first, last);</span><br><span class="line">    &#125;</span><br><span class="line">    m_pos += <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(<span class="type">float</span> &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_buf[m_pos] != DataType::FLOAT)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++m_pos;</span><br><span class="line">    value = *((<span class="type">float</span> *)&amp;(m_buf[m_pos]));</span><br><span class="line">    <span class="keyword">if</span> (m_byteorder == BIG_ENDIAN)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> * first = (<span class="type">char</span>*)&amp;value;</span><br><span class="line">        <span class="type">char</span> * last = first + <span class="built_in">sizeof</span>(<span class="type">float</span>);</span><br><span class="line">        std::<span class="built_in">reverse</span>(first, last);</span><br><span class="line">    &#125;</span><br><span class="line">    m_pos += <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(<span class="type">double</span> &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_buf[m_pos] != DataType::DOUBLE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++m_pos;</span><br><span class="line">    value = *((<span class="type">double</span> *)&amp;(m_buf[m_pos]));</span><br><span class="line">    <span class="keyword">if</span> (m_byteorder == BIG_ENDIAN)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> * first = (<span class="type">char</span>*)&amp;value;</span><br><span class="line">        <span class="type">char</span> * last = first + <span class="built_in">sizeof</span>(<span class="type">double</span>);</span><br><span class="line">        std::<span class="built_in">reverse</span>(first, last);</span><br><span class="line">    &#125;</span><br><span class="line">    m_pos += <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(string &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_buf[m_pos] != DataType::STRING)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++m_pos;</span><br><span class="line">    <span class="type">int32_t</span> len = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">read</span>(len);</span><br><span class="line">    <span class="keyword">if</span> (len &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    value.<span class="built_in">assign</span>((<span class="type">char</span> *)&amp;(m_buf[m_pos]), len);</span><br><span class="line">    m_pos += len;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DataStream::read</span><span class="params">(Serializable &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> value.<span class="built_in">unserialize</span>(*<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp;DataStream::<span class="keyword">operator</span>&gt;&gt;(<span class="type">bool</span> &amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">read</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp;DataStream::<span class="keyword">operator</span>&gt;&gt;(<span class="type">char</span> &amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">read</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp;DataStream::<span class="keyword">operator</span>&gt;&gt;(<span class="type">int32_t</span> &amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">read</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp;DataStream::<span class="keyword">operator</span>&gt;&gt;(<span class="type">int64_t</span> &amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">read</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp;DataStream::<span class="keyword">operator</span>&gt;&gt;(<span class="type">float</span> &amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">read</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp;DataStream::<span class="keyword">operator</span>&gt;&gt;(<span class="type">double</span> &amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">read</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp;DataStream::<span class="keyword">operator</span>&gt;&gt;(string &amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">read</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream &amp; DataStream::<span class="keyword">operator</span>&gt;&gt;(Serializable &amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">read</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">const</span> <span class="type">char</span> * <span class="title">DataStream::data</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_buf.<span class="built_in">data</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">DataStream::size</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_buf.<span class="built_in">size</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::clear</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_buf.<span class="built_in">clear</span>();</span><br><span class="line">    m_pos = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::reset</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_pos = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::save</span><span class="params">(<span class="type">const</span> string &amp; filename)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">std::ofstream <span class="title">ofs</span><span class="params">(filename)</span></span>;</span><br><span class="line">    <span class="comment">// write()将数据以二进制形式写入文件，但不一定立即写入磁盘</span></span><br><span class="line">    ofs.<span class="built_in">write</span>(<span class="built_in">data</span>(), <span class="built_in">size</span>());</span><br><span class="line">    <span class="comment">// flush()强制将缓冲区中的数据写入文件，即立即将缓冲区内容写入物理设备</span></span><br><span class="line">    <span class="comment">// 注意频繁调用flush()会影响I/O性能</span></span><br><span class="line">    ofs.<span class="built_in">flush</span>();</span><br><span class="line">    ofs.<span class="built_in">close</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 从文件恢复为DataStream</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DataStream::load</span><span class="params">(<span class="type">const</span> string &amp;filename)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">std::ifstream <span class="title">ifs</span><span class="params">(filename)</span></span>;</span><br><span class="line">    std::ostringstream oss;</span><br><span class="line">    oss &lt;&lt; ifs.<span class="built_in">rdbuf</span>();</span><br><span class="line">    <span class="type">const</span> string &amp; str = oss.<span class="built_in">str</span>();</span><br><span class="line">    <span class="built_in">reserve</span>(str.<span class="built_in">size</span>());</span><br><span class="line">    <span class="built_in">write</span>(str.<span class="built_in">data</span>(), str.<span class="built_in">size</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// serialize/serializable.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> serialize</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 为了避免循环引用，这里使用前向声明:</span></span><br><span class="line">        <span class="comment">// 即当只需要使用类的指针或引用而不需要知道类的完整定义时，可以使用前向声明。</span></span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">DataStream</span>;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Serializable</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="comment">// 序列化</span></span><br><span class="line">            <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">serialize</span><span class="params">(DataStream &amp; stream)</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// 反序列化</span></span><br><span class="line">            <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">unserialize</span><span class="params">(DataStream &amp; stream)</span> </span>= <span class="number">0</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 由于不同类的数据成员是可变的，这里SERIALIZE宏传入可变参数...(传入宏的数据即需要序列化和反序列化的成员数据)</span></span><br><span class="line">    <span class="comment">// 这样自定义类型序列化直接用宏即可，不用手动实现serialize()和unserialize()这两个接口</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> SERIALIZE(...)                                      \</span></span><br><span class="line"><span class="meta">        void serialize(DataStream &amp; stream) const               \</span></span><br><span class="line"><span class="meta">        &#123;                                                       \</span></span><br><span class="line"><span class="meta">            char type = DataStream::CUSTOM;                     \</span></span><br><span class="line"><span class="meta">            stream.write((char*)&amp;type, sizeof(char));           \</span></span><br><span class="line"><span class="meta">            stream.write_args(__VA_ARGS__);                     \</span></span><br><span class="line"><span class="meta">        &#125;                                                       \</span></span><br><span class="line"><span class="meta">                                                                \</span></span><br><span class="line"><span class="meta">        bool unserialize(DataStream &amp; stream)                   \</span></span><br><span class="line"><span class="meta">        &#123;                                                       \</span></span><br><span class="line"><span class="meta">            char type;                                          \</span></span><br><span class="line"><span class="meta">            stream.read(&amp;type, sizeof(char));                   \</span></span><br><span class="line"><span class="meta">            <span class="keyword">if</span> (type != DataStream::CUSTOM)                     \</span></span><br><span class="line"><span class="meta">            &#123;                                                   \</span></span><br><span class="line"><span class="meta">                return false;                                   \</span></span><br><span class="line"><span class="meta">            &#125;                                                   \</span></span><br><span class="line"><span class="meta">            stream.read_args(__VA_ARGS__);                      \</span></span><br><span class="line"><span class="meta">            return true;                                        \</span></span><br><span class="line"><span class="meta">        &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> C++后端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>字符串操作</title>
      <link href="/2024/05/26/%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%93%8D%E4%BD%9C/"/>
      <url>/2024/05/26/%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%93%8D%E4%BD%9C/</url>
      
        <content type="html"><![CDATA[<h1 id="字符串操作">字符串操作</h1><h2 id="to-lower-内容转小写">to_lower 内容转小写</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">string <span class="title">String::to_lower</span><span class="params">(<span class="type">const</span> string &amp; input)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string str = input;</span><br><span class="line">    std::<span class="built_in">transform</span>(str.<span class="built_in">begin</span>(), str.<span class="built_in">end</span>(), str.<span class="built_in">begin</span>(), ::tolower);</span><br><span class="line">    <span class="keyword">return</span> str;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="to-upper-内容转大写">to_upper 内容转大写</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">string <span class="title">String::to_upper</span><span class="params">(<span class="type">const</span> string &amp; input)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string str = input;</span><br><span class="line">    std::<span class="built_in">transform</span>(str.<span class="built_in">begin</span>(), str.<span class="built_in">end</span>(), str.<span class="built_in">begin</span>(), ::toupper);</span><br><span class="line">    <span class="keyword">return</span> str;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ltrim-裁剪左边">ltrim 裁剪左边</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">string <span class="title">String::ltrim</span><span class="params">(<span class="type">const</span> string &amp; input, <span class="type">const</span> string &amp; trims)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string str = input;</span><br><span class="line">    <span class="type">size_t</span> pos = str.<span class="built_in">find_first_not_of</span>(trims);</span><br><span class="line">    <span class="keyword">if</span> (pos != std::string::npos)</span><br><span class="line">        str.<span class="built_in">erase</span>(<span class="number">0</span>, pos);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        str.<span class="built_in">clear</span>();</span><br><span class="line">    <span class="keyword">return</span> str;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="rtrim-裁剪右边">rtrim 裁剪右边</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">string <span class="title">String::rtrim</span><span class="params">(<span class="type">const</span> string &amp; input, <span class="type">const</span> string &amp; trims)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string str = input;</span><br><span class="line">    <span class="type">size_t</span> pos = str.<span class="built_in">find_last_not_of</span>(trims);</span><br><span class="line">    <span class="keyword">if</span> (pos != std::string::npos)</span><br><span class="line">        str.<span class="built_in">erase</span>(pos + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        str.<span class="built_in">clear</span>();</span><br><span class="line">    <span class="keyword">return</span> str;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="trim-裁剪左右两边">trim 裁剪左右两边</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">string <span class="title">String::trim</span><span class="params">(<span class="type">const</span> string &amp; input, <span class="type">const</span> string &amp; trims)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string str = <span class="built_in">ltrim</span>(input, trims);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">rtrim</span>(str, trims);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="split-字符串分割">split 字符串分割</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::vector&lt;string&gt; <span class="title">String::split</span><span class="params">(<span class="type">const</span> string &amp; input, <span class="type">const</span> string &amp; separator)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::vector&lt;string&gt; output;</span><br><span class="line">    <span class="type">size_t</span> last = <span class="number">0</span>;</span><br><span class="line">    <span class="type">size_t</span> index = input.<span class="built_in">find_first_of</span>(separator, last);</span><br><span class="line">    <span class="keyword">while</span> (index != std::string::npos)</span><br><span class="line">    &#123;</span><br><span class="line">        string str = input.<span class="built_in">substr</span>(last, index - last);</span><br><span class="line">        output.<span class="built_in">push_back</span>(str);</span><br><span class="line">        last = index + <span class="number">1</span>;</span><br><span class="line">        index = input.<span class="built_in">find_first_of</span>(separator, last);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (index - last &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        output.<span class="built_in">push_back</span>(input.<span class="built_in">substr</span>(last, index - last));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> output;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">std::vector&lt;string&gt; <span class="title">String::split</span><span class="params">(<span class="type">const</span> string &amp; input, <span class="type">char</span> separator)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">split</span>(input, <span class="built_in">string</span>(<span class="number">1</span>, separator));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="join-字符串合并">join 字符串合并</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">string <span class="title">String::join</span><span class="params">(<span class="type">const</span> std::vector&lt;string&gt; &amp; input, <span class="type">const</span> string &amp; separator)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::ostringstream oss;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> it = input.<span class="built_in">begin</span>(); it != input.<span class="built_in">end</span>(); ++it)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (it != input.<span class="built_in">begin</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            oss &lt;&lt; separator;</span><br><span class="line">        &#125;</span><br><span class="line">        oss &lt;&lt; *it;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> oss.<span class="built_in">str</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">string <span class="title">String::join</span><span class="params">(<span class="type">const</span> std::vector&lt;string&gt; &amp; input, <span class="type">char</span> separator)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">join</span>(input, <span class="built_in">string</span>(<span class="number">1</span>, separator));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="has-prefix-判断是否有前缀">has_prefix 判断是否有前缀</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">String::has_prefix</span><span class="params">(<span class="type">const</span> string &amp; input, <span class="type">const</span> string &amp; prefix)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (input.<span class="built_in">size</span>() &lt; prefix.<span class="built_in">size</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> input.<span class="built_in">substr</span>(<span class="number">0</span>, prefix.<span class="built_in">size</span>()) == prefix;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="has-suffix-判断是否有后缀">has_suffix 判断是否有后缀</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">String::has_suffix</span><span class="params">(<span class="type">const</span> string &amp; input, <span class="type">const</span> string &amp; suffix)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (input.<span class="built_in">size</span>() &lt; suffix.<span class="built_in">size</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> input.<span class="built_in">substr</span>(input.<span class="built_in">size</span>() - suffix.<span class="built_in">size</span>(), suffix.<span class="built_in">size</span>()) == suffix;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="capitalize-首字母大写">capitalize 首字母大写</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">string <span class="title">String::capitalize</span><span class="params">(<span class="type">const</span> string &amp; input)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string str = input;</span><br><span class="line">    <span class="keyword">if</span> (str.<span class="built_in">empty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> str;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">char</span> ch = input[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">islower</span>(ch))</span><br><span class="line">    &#123;</span><br><span class="line">        ch = (<span class="type">char</span>)<span class="built_in">toupper</span>(ch);</span><br><span class="line">        std::<span class="built_in">replace</span>(str.<span class="built_in">begin</span>(), str.<span class="built_in">begin</span>() + <span class="number">1</span>, str[<span class="number">0</span>], ch);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> str;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="format-格式化">format 格式化</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">string <span class="title">String::format</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * format, ...)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string result;</span><br><span class="line">    va_list arg_ptr;</span><br><span class="line">    <span class="built_in">va_start</span>(arg_ptr, format);</span><br><span class="line">    <span class="type">int</span> len = <span class="built_in">vsnprintf</span>(<span class="literal">nullptr</span>, <span class="number">0</span>, format, arg_ptr);</span><br><span class="line">    <span class="built_in">va_end</span>(arg_ptr);</span><br><span class="line">    <span class="keyword">if</span> (len &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> * buf = <span class="keyword">new</span> <span class="type">char</span>[len + <span class="number">1</span>];</span><br><span class="line">        <span class="built_in">va_start</span>(arg_ptr, format);</span><br><span class="line">        <span class="built_in">vsnprintf</span>(buf, len + <span class="number">1</span>, format, arg_ptr);</span><br><span class="line">        <span class="built_in">va_end</span>(arg_ptr);</span><br><span class="line">        buf[len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        result = buf;</span><br><span class="line">        <span class="keyword">delete</span>[] buf;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="完整实现">完整实现</h1><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// utility/string.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cctype&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdarg&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> std::string;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> utility</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">String</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">String</span>() = <span class="keyword">default</span>;</span><br><span class="line">            ~<span class="built_in">String</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="type">static</span> string <span class="title">to_lower</span><span class="params">(<span class="type">const</span> string &amp; input)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">static</span> string <span class="title">to_upper</span><span class="params">(<span class="type">const</span> string &amp; input)</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 裁剪左边</span></span><br><span class="line">            <span class="function"><span class="type">static</span> string <span class="title">ltrim</span><span class="params">(<span class="type">const</span> string &amp; input, <span class="type">const</span> string &amp; trims)</span></span>;</span><br><span class="line">            <span class="comment">// 裁剪右边</span></span><br><span class="line">            <span class="function"><span class="type">static</span> string <span class="title">rtrim</span><span class="params">(<span class="type">const</span> string &amp; input, <span class="type">const</span> string &amp; trims)</span></span>;</span><br><span class="line">            <span class="comment">// 裁剪左右两边</span></span><br><span class="line">            <span class="function"><span class="type">static</span> string <span class="title">trim</span><span class="params">(<span class="type">const</span> string &amp; input, <span class="type">const</span> string &amp; trims)</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 字符串分割</span></span><br><span class="line">            <span class="function"><span class="type">static</span> std::vector&lt;string&gt; <span class="title">split</span><span class="params">(<span class="type">const</span> string &amp; input, <span class="type">const</span> string &amp; separator)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">static</span> std::vector&lt;string&gt; <span class="title">split</span><span class="params">(<span class="type">const</span> string &amp; input, <span class="type">char</span> separator)</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 字符串合并</span></span><br><span class="line">            <span class="function"><span class="type">static</span> string <span class="title">join</span><span class="params">(<span class="type">const</span> std::vector&lt;string&gt; &amp; input, <span class="type">const</span> string &amp; separator)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">static</span> string <span class="title">join</span><span class="params">(<span class="type">const</span> std::vector&lt;string&gt; &amp; input, <span class="type">char</span> separator)</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 字符串是否有前缀</span></span><br><span class="line">            <span class="function"><span class="type">static</span> <span class="type">bool</span> <span class="title">has_prefix</span><span class="params">(<span class="type">const</span> string &amp; input, <span class="type">const</span> string &amp; prefix)</span></span>;</span><br><span class="line">            <span class="comment">// 字符串是否有后缀</span></span><br><span class="line">            <span class="function"><span class="type">static</span> <span class="type">bool</span> <span class="title">has_suffix</span><span class="params">(<span class="type">const</span> string &amp; input, <span class="type">const</span> string &amp; suffix)</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 首字母大写</span></span><br><span class="line">            <span class="function"><span class="type">static</span> string <span class="title">capitalize</span><span class="params">(<span class="type">const</span> string &amp; input)</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 字符串可变参数格式化</span></span><br><span class="line">            <span class="function"><span class="type">static</span> string <span class="title">format</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * format, ...)</span></span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// utility/string.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility/string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::utility;</span><br><span class="line"></span><br><span class="line"><span class="function">string <span class="title">String::to_lower</span><span class="params">(<span class="type">const</span> string &amp; input)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string str = input;</span><br><span class="line">    std::<span class="built_in">transform</span>(str.<span class="built_in">begin</span>(), str.<span class="built_in">end</span>(), str.<span class="built_in">begin</span>(), ::tolower);</span><br><span class="line">    <span class="keyword">return</span> str;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">string <span class="title">String::to_upper</span><span class="params">(<span class="type">const</span> string &amp; input)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string str = input;</span><br><span class="line">    std::<span class="built_in">transform</span>(str.<span class="built_in">begin</span>(), str.<span class="built_in">end</span>(), str.<span class="built_in">begin</span>(), ::toupper);</span><br><span class="line">    <span class="keyword">return</span> str;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">string <span class="title">String::ltrim</span><span class="params">(<span class="type">const</span> string &amp; input, <span class="type">const</span> string &amp; trims)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string str = input;</span><br><span class="line">    <span class="type">size_t</span> pos = str.<span class="built_in">find_first_not_of</span>(trims);</span><br><span class="line">    <span class="keyword">if</span> (pos != std::string::npos)</span><br><span class="line">        str.<span class="built_in">erase</span>(<span class="number">0</span>, pos);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        str.<span class="built_in">clear</span>();</span><br><span class="line">    <span class="keyword">return</span> str;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">string <span class="title">String::rtrim</span><span class="params">(<span class="type">const</span> string &amp; input, <span class="type">const</span> string &amp; trims)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string str = input;</span><br><span class="line">    <span class="type">size_t</span> pos = str.<span class="built_in">find_last_not_of</span>(trims);</span><br><span class="line">    <span class="keyword">if</span> (pos != std::string::npos)</span><br><span class="line">        str.<span class="built_in">erase</span>(pos + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        str.<span class="built_in">clear</span>();</span><br><span class="line">    <span class="keyword">return</span> str;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">string <span class="title">String::trim</span><span class="params">(<span class="type">const</span> string &amp; input, <span class="type">const</span> string &amp; trims)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string str = <span class="built_in">ltrim</span>(input, trims);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">rtrim</span>(str, trims);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">std::vector&lt;string&gt; <span class="title">String::split</span><span class="params">(<span class="type">const</span> string &amp; input, <span class="type">const</span> string &amp; separator)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::vector&lt;string&gt; output;</span><br><span class="line">    <span class="type">size_t</span> last = <span class="number">0</span>;</span><br><span class="line">    <span class="type">size_t</span> index = input.<span class="built_in">find_first_of</span>(separator, last);</span><br><span class="line">    <span class="keyword">while</span> (index != std::string::npos)</span><br><span class="line">    &#123;</span><br><span class="line">        string str = input.<span class="built_in">substr</span>(last, index - last);</span><br><span class="line">        output.<span class="built_in">push_back</span>(str);</span><br><span class="line">        last = index + <span class="number">1</span>;</span><br><span class="line">        index = input.<span class="built_in">find_first_of</span>(separator, last);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (index - last &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        output.<span class="built_in">push_back</span>(input.<span class="built_in">substr</span>(last, index - last));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> output;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">std::vector&lt;string&gt; <span class="title">String::split</span><span class="params">(<span class="type">const</span> string &amp; input, <span class="type">char</span> separator)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">split</span>(input, <span class="built_in">string</span>(<span class="number">1</span>, separator));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">string <span class="title">String::join</span><span class="params">(<span class="type">const</span> std::vector&lt;string&gt; &amp; input, <span class="type">const</span> string &amp; separator)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::ostringstream oss;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> it = input.<span class="built_in">begin</span>(); it != input.<span class="built_in">end</span>(); ++it)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (it != input.<span class="built_in">begin</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            oss &lt;&lt; separator;</span><br><span class="line">        &#125;</span><br><span class="line">        oss &lt;&lt; *it;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> oss.<span class="built_in">str</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">string <span class="title">String::join</span><span class="params">(<span class="type">const</span> std::vector&lt;string&gt; &amp; input, <span class="type">char</span> separator)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">join</span>(input, <span class="built_in">string</span>(<span class="number">1</span>, separator));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">String::has_prefix</span><span class="params">(<span class="type">const</span> string &amp; input, <span class="type">const</span> string &amp; prefix)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (input.<span class="built_in">size</span>() &lt; prefix.<span class="built_in">size</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> input.<span class="built_in">substr</span>(<span class="number">0</span>, prefix.<span class="built_in">size</span>()) == prefix;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">String::has_suffix</span><span class="params">(<span class="type">const</span> string &amp; input, <span class="type">const</span> string &amp; suffix)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (input.<span class="built_in">size</span>() &lt; suffix.<span class="built_in">size</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> input.<span class="built_in">substr</span>(input.<span class="built_in">size</span>() - suffix.<span class="built_in">size</span>(), suffix.<span class="built_in">size</span>()) == suffix;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">string <span class="title">String::capitalize</span><span class="params">(<span class="type">const</span> string &amp; input)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string str = input;</span><br><span class="line">    <span class="keyword">if</span> (str.<span class="built_in">empty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> str;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">char</span> ch = input[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">islower</span>(ch))</span><br><span class="line">    &#123;</span><br><span class="line">        ch = (<span class="type">char</span>)<span class="built_in">toupper</span>(ch);</span><br><span class="line">        std::<span class="built_in">replace</span>(str.<span class="built_in">begin</span>(), str.<span class="built_in">begin</span>() + <span class="number">1</span>, str[<span class="number">0</span>], ch);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> str;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">string <span class="title">String::format</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * format, ...)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string result;</span><br><span class="line">    va_list arg_ptr;</span><br><span class="line">    <span class="built_in">va_start</span>(arg_ptr, format);</span><br><span class="line">    <span class="type">int</span> len = <span class="built_in">vsnprintf</span>(<span class="literal">nullptr</span>, <span class="number">0</span>, format, arg_ptr);</span><br><span class="line">    <span class="built_in">va_end</span>(arg_ptr);</span><br><span class="line">    <span class="keyword">if</span> (len &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> * buf = <span class="keyword">new</span> <span class="type">char</span>[len + <span class="number">1</span>];</span><br><span class="line">        <span class="built_in">va_start</span>(arg_ptr, format);</span><br><span class="line">        <span class="built_in">vsnprintf</span>(buf, len + <span class="number">1</span>, format, arg_ptr);</span><br><span class="line">        <span class="built_in">va_end</span>(arg_ptr);</span><br><span class="line">        buf[len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        result = buf;</span><br><span class="line">        <span class="keyword">delete</span>[] buf;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> C++后端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>xml解析器</title>
      <link href="/2024/05/23/xml%E8%A7%A3%E6%9E%90%E5%99%A8/"/>
      <url>/2024/05/23/xml%E8%A7%A3%E6%9E%90%E5%99%A8/</url>
      
        <content type="html"><![CDATA[<h1 id="xml简介">XML简介</h1><p>XML（Extensible Markup Language，可扩展标记语言）是一种用于数据交换和展示的语言，它的主<br>要特点是可扩展性和可读性，可以被不同的应用程序和系统所使用。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">students</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">student</span> <span class="attr">id</span>=<span class="string">&quot;1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;101&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>Jack<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">age</span>&gt;</span>21<span class="tag">&lt;/<span class="name">age</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">gender</span>&gt;</span>male<span class="tag">&lt;/<span class="name">gender</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">student</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">student</span> <span class="attr">id</span>=<span class="string">&quot;2&quot;</span> <span class="attr">class</span>=<span class="string">&quot;102&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>Lucy<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">age</span>&gt;</span>22<span class="tag">&lt;/<span class="name">age</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">gender</span>&gt;</span>female<span class="tag">&lt;/<span class="name">gender</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">student</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">student</span> <span class="attr">id</span>=<span class="string">&quot;3&quot;</span> <span class="attr">class</span>=<span class="string">&quot;103&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>Lily<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">age</span>&gt;</span>23<span class="tag">&lt;/<span class="name">age</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">gender</span>&gt;</span>female<span class="tag">&lt;/<span class="name">gender</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">student</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">students</span>&gt;</span></span><br></pre></td></tr></table></figure><p>以下是XML的基础知识：</p><ol><li>标签和元素：XML的基本组成单位是元素，一个元素由开始标签、结束标签和元素内容组成，标签用于标识元素的类型，开始标签和结束标签成对出现，元素内容可以包含其他元素或文本</li><li>属性：XML元素可以有零至多个属性，每个属性由属性名和属性值组成，属性值必须被引号包含</li><li>注释：与HTML类似，XML也支持注释，以&quot;<!--"开头，"-->&quot;结束</li><li>命名空间：为避免不同XML文档中的元素名称产生冲突，可以通过命名空间来区分不同XML文档中的元素</li><li>处理指令：XML文档可以包含处理指令，一般用于指定XML解析器如何处理XML文档，例如指定样式表和DTD等</li><li>DTD（文档类型定义）：DTD定义了XML文档的规范结构，定义了XML文档中哪些元素是合法的，以及它们可以包含哪些子元素和属性</li><li>XML Schema：与DTD类似，XML Schema也是一种用于定义XML文档结构的语言，它提供了更丰富的数据类型、命名空间和可扩展性等特点</li></ol><h1 id="xml解析器设计与实现">XML解析器设计与实现</h1><h2 id="特点">特点</h2><ul><li>独立：不依赖于第三方库</li><li>跨平台：支持Linux、Windows、MacOS</li><li>简单好用：友好的API，核心的Parser仅200+行代码</li><li>高性能：性能接近TinyXML2</li></ul><h2 id="api设计">API设计</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// json/json.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdexcept&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> std::string;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> json</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Json</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="comment">// 使用枚举类型来表示不同类型的JSON元素</span></span><br><span class="line">            <span class="keyword">enum</span> <span class="title class_">Type</span></span><br><span class="line">            &#123;</span><br><span class="line">                JSON_NULL = <span class="number">0</span>,</span><br><span class="line">                JSON_BOOL,</span><br><span class="line">                JSON_INT,</span><br><span class="line">                JSON_DOUBLE,</span><br><span class="line">                JSON_STRING,</span><br><span class="line">                JSON_ARRAY,</span><br><span class="line">                JSON_OBJECT</span><br><span class="line">            &#125;;</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">Json</span>();</span><br><span class="line">            <span class="built_in">Json</span>(Type type);</span><br><span class="line">            <span class="built_in">Json</span>(<span class="type">bool</span> value);</span><br><span class="line">            <span class="built_in">Json</span>(<span class="type">int</span> value);</span><br><span class="line">            <span class="built_in">Json</span>(<span class="type">double</span> value);</span><br><span class="line">            <span class="built_in">Json</span>(<span class="type">const</span> <span class="type">char</span> * value);</span><br><span class="line">            <span class="built_in">Json</span>(<span class="type">const</span> string &amp; value);</span><br><span class="line">            <span class="built_in">Json</span>(<span class="type">const</span> Json &amp; other);</span><br><span class="line">            <span class="built_in">Json</span>(Json &amp;&amp; other);</span><br><span class="line">            ~<span class="built_in">Json</span>();</span><br><span class="line"></span><br><span class="line">            <span class="function">Type <span class="title">type</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">is_null</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">is_bool</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">is_int</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">is_double</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">is_string</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">is_array</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">is_object</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 重载类型转换运算符，类型转换运算符必须是类的成员函数，它不能声明返回类型，形参列表必须为空切通常应该是const</span></span><br><span class="line">            <span class="function"><span class="keyword">operator</span> <span class="title">bool</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="function"><span class="keyword">operator</span> <span class="title">int</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="function"><span class="keyword">operator</span> <span class="title">double</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="function"><span class="keyword">operator</span> <span class="title">string</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">as_bool</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">as_int</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="function"><span class="type">double</span> <span class="title">as_double</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="function">string <span class="title">as_string</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 拷贝赋值运算符首先需要清理释放资源，避免内存泄露</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">clear</span><span class="params">()</span></span>;</span><br><span class="line">            Json &amp; <span class="keyword">operator</span>=(<span class="type">bool</span> value);</span><br><span class="line">            Json &amp; <span class="keyword">operator</span>=(<span class="type">int</span> value);</span><br><span class="line">            Json &amp; <span class="keyword">operator</span>=(<span class="type">double</span> value);</span><br><span class="line">            Json &amp; <span class="keyword">operator</span>=(<span class="type">const</span> <span class="type">char</span> * value);</span><br><span class="line">            Json &amp; <span class="keyword">operator</span>=(<span class="type">const</span> string &amp; value);</span><br><span class="line">            Json &amp; <span class="keyword">operator</span>=(<span class="type">const</span> Json &amp; other);</span><br><span class="line">            Json &amp; <span class="keyword">operator</span>=(Json &amp;&amp; other) <span class="keyword">noexcept</span>;</span><br><span class="line"></span><br><span class="line">            <span class="function">string <span class="title">str</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="comment">// 重载输出运算符，IO运算符必须定义为非成员函数且一般被声明为友元</span></span><br><span class="line">            <span class="keyword">friend</span> std::ostream&amp; <span class="keyword">operator</span>&lt;&lt;(std::ostream &amp; os, <span class="type">const</span> Json &amp; json)</span><br><span class="line">            &#123;</span><br><span class="line">                os &lt;&lt; json.<span class="built_in">str</span>();</span><br><span class="line">                <span class="keyword">return</span> os;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">append</span><span class="params">(<span class="type">const</span> Json &amp; value)</span></span>;                <span class="comment">// 向json数组中添加元素</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">append</span><span class="params">(Json &amp;&amp; value)</span></span>;                     <span class="comment">// 向json数组中添加元素，避免深拷贝</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">has</span><span class="params">(<span class="type">int</span> index)</span></span>;                            <span class="comment">// 判断json数组中是否有该下标</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">has</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * key)</span> <span class="type">const</span></span>;               <span class="comment">// 判断json数组中是否有某个键</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">has</span><span class="params">(<span class="type">const</span> string &amp; key)</span> <span class="type">const</span></span>;             <span class="comment">// 判断json数组中是否有某个键</span></span><br><span class="line">            <span class="function">Json <span class="title">get</span><span class="params">(<span class="type">int</span> index)</span></span>;                            <span class="comment">// 根据下标获取json数组中的元素</span></span><br><span class="line">            <span class="function">Json <span class="title">get</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * key)</span></span>;                     <span class="comment">// 根据键获取对应的json对象</span></span><br><span class="line">            <span class="function">Json <span class="title">get</span><span class="params">(<span class="type">const</span> string &amp; key)</span></span>;                   <span class="comment">// 根据键获取对应的json对象</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">remove</span><span class="params">(<span class="type">int</span> index)</span></span>;                         <span class="comment">// 根据下标删除json数组中的元素</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">remove</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * key)</span></span>;                  <span class="comment">// 根据键删除对应的json对象</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">remove</span><span class="params">(<span class="type">const</span> string &amp; key)</span></span>;                <span class="comment">// 根据键删除对应的json对象</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 重载下标运算符</span></span><br><span class="line">            Json &amp; <span class="keyword">operator</span>[](<span class="type">int</span> index);                   <span class="comment">// 根据下标获取json数组中的元素</span></span><br><span class="line">            Json &amp; <span class="keyword">operator</span>[](<span class="type">const</span> <span class="type">char</span> * key);            <span class="comment">// 根据键获取json对象</span></span><br><span class="line">            Json &amp; <span class="keyword">operator</span>[](<span class="type">const</span> string &amp; key);          <span class="comment">// 根据键获取json对象</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 遍历数组</span></span><br><span class="line">            <span class="keyword">using</span> iterator = std::vector&lt;Json&gt;::iterator;</span><br><span class="line">            <span class="function">iterator <span class="title">begin</span><span class="params">()</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> (m_value.m_array)-&gt;<span class="built_in">begin</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="function">iterator <span class="title">end</span><span class="params">()</span></span></span><br><span class="line"><span class="function">            </span>&#123;   </span><br><span class="line">                <span class="keyword">return</span> (m_value.m_array)-&gt;<span class="built_in">end</span>();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// json对象和json数组均有的操作</span></span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">size</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">empty</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">parse</span><span class="params">(<span class="type">const</span> string &amp; filename)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">parse</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * buf, <span class="type">int</span> len)</span></span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="comment">// 深拷贝</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">copy</span><span class="params">(<span class="type">const</span> Json &amp; other)</span></span>;</span><br><span class="line">            <span class="comment">// 浅拷贝，仅用于移动语义提升性能</span></span><br><span class="line">            <span class="comment">// swap仅交换内容，不拷贝内容</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">swap</span><span class="params">(Json &amp; other)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="keyword">union</span> <span class="title class_">Value</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="type">bool</span> m_bool;</span><br><span class="line">                <span class="type">int</span> m_int;</span><br><span class="line">                <span class="type">double</span> m_double;</span><br><span class="line">                string * m_string;</span><br><span class="line">                std::vector&lt;Json&gt; * m_array;</span><br><span class="line">                std::map&lt;string, Json&gt; * m_object;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            Type m_type;                <span class="comment">// json实际存储的类型</span></span><br><span class="line">            Value m_value;              <span class="comment">// json实际存储的值</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// json/json.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;json/json.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;json/parser.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::json;</span><br><span class="line"></span><br><span class="line">Json::<span class="built_in">Json</span>() : <span class="built_in">m_type</span>(JSON_NULL)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Json::<span class="built_in">Json</span>(Type type) : <span class="built_in">m_type</span>(type)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">switch</span> (m_type)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> JSON_NULL:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> JSON_BOOL:</span><br><span class="line">            m_value.m_bool = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> JSON_INT:</span><br><span class="line">            m_value.m_int = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> JSON_DOUBLE:</span><br><span class="line">            m_value.m_double = <span class="number">0.0</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> JSON_STRING:</span><br><span class="line">            m_value.m_string = <span class="keyword">new</span> <span class="built_in">string</span>();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> JSON_ARRAY:</span><br><span class="line">            m_value.m_array = <span class="keyword">new</span> std::<span class="built_in">vector</span>&lt;Json&gt;();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> JSON_OBJECT:</span><br><span class="line">            m_value.m_object = <span class="keyword">new</span> std::<span class="built_in">map</span>&lt;string, Json&gt;();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Json::<span class="built_in">Json</span>(<span class="type">bool</span> value) : <span class="built_in">m_type</span>(JSON_BOOL)</span><br><span class="line">&#123;</span><br><span class="line">    m_value.m_bool = value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Json::<span class="built_in">Json</span>(<span class="type">int</span> value) : <span class="built_in">m_type</span>(JSON_INT)</span><br><span class="line">&#123;</span><br><span class="line">    m_value.m_int = value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Json::<span class="built_in">Json</span>(<span class="type">double</span> value) : <span class="built_in">m_type</span>(JSON_DOUBLE)</span><br><span class="line">&#123;</span><br><span class="line">    m_value.m_double = value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Json::<span class="built_in">Json</span>(<span class="type">const</span> <span class="type">char</span> * value) : <span class="built_in">m_type</span>(JSON_STRING)</span><br><span class="line">&#123;</span><br><span class="line">    m_value.m_string = <span class="keyword">new</span> <span class="built_in">string</span>(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Json::<span class="built_in">Json</span>(<span class="type">const</span> string &amp; value) : <span class="built_in">m_type</span>(JSON_STRING)</span><br><span class="line">&#123;</span><br><span class="line">    m_value.m_string = <span class="keyword">new</span> <span class="built_in">string</span>(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Json::<span class="built_in">Json</span>(<span class="type">const</span> Json &amp; other) : <span class="built_in">m_type</span>(JSON_NULL)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">copy</span>(other);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Json::<span class="built_in">Json</span>(Json &amp;&amp; other)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">swap</span>(other);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Json::~<span class="built_in">Json</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// TODO</span></span><br><span class="line">    <span class="comment">// clear();</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">string <span class="title">Json::str</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::stringstream ss;</span><br><span class="line">    <span class="keyword">switch</span> (m_type)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> JSON_NULL:</span><br><span class="line">            ss &lt;&lt; <span class="string">&quot;null&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> JSON_BOOL:</span><br><span class="line">            ss &lt;&lt; (m_value.m_bool ? <span class="string">&quot;true&quot;</span> : <span class="string">&quot;false&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> JSON_INT:</span><br><span class="line">            ss &lt;&lt; m_value.m_int;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> JSON_DOUBLE:</span><br><span class="line">            ss &lt;&lt; m_value.m_double;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> JSON_STRING:</span><br><span class="line">            ss &lt;&lt; <span class="string">&quot;\&quot;&quot;</span> &lt;&lt; *(m_value.m_string) &lt;&lt; <span class="string">&quot;\&quot;&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> JSON_ARRAY:</span><br><span class="line">            ss &lt;&lt; <span class="string">&quot;[&quot;</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">auto</span> it = (m_value.m_array)-&gt;<span class="built_in">begin</span>(); it != (m_value.m_array)-&gt;<span class="built_in">end</span>(); ++it)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (it != (m_value.m_array)-&gt;<span class="built_in">begin</span>())</span><br><span class="line">                &#123;</span><br><span class="line">                    ss &lt;&lt; <span class="string">&quot;,&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                ss &lt;&lt; (*it).<span class="built_in">str</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            ss &lt;&lt; <span class="string">&quot;]&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> JSON_OBJECT:</span><br><span class="line">            ss &lt;&lt; <span class="string">&quot;&#123;&quot;</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">auto</span> it = (m_value.m_object)-&gt;<span class="built_in">begin</span>(); it != (m_value.m_object)-&gt;<span class="built_in">end</span>(); ++it)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (it != (m_value.m_object)-&gt;<span class="built_in">begin</span>())</span><br><span class="line">                &#123;</span><br><span class="line">                    ss &lt;&lt; <span class="string">&quot;,&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                ss &lt;&lt; <span class="string">&quot;\&quot;&quot;</span> &lt;&lt; it-&gt;first &lt;&lt; <span class="string">&quot;\&quot;:&quot;</span> &lt;&lt; it-&gt;second.<span class="built_in">str</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            ss &lt;&lt; <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ss.<span class="built_in">str</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Json::Type <span class="title">Json::type</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_type;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Json::is_null</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_type == JSON_NULL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Json::is_bool</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_type == JSON_BOOL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Json::is_int</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_type == JSON_INT;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Json::is_double</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_type == JSON_DOUBLE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Json::is_string</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_type == JSON_STRING;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Json::is_array</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_type == JSON_ARRAY;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Json::is_object</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_type == JSON_OBJECT;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Json::as_bool</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    <span class="keyword">if</span> (m_type == JSON_BOOL)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> m_value.m_bool;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;type error: not bool type&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Json::as_int</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_type == JSON_INT)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> m_value.m_int;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;type error: not int type&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">double</span> <span class="title">Json::as_double</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_type == JSON_DOUBLE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> m_value.m_double;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;type error: not double type&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">string <span class="title">Json::as_string</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_type == JSON_STRING)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> *(m_value.m_string);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;type error: not string type&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Json::<span class="keyword">operator</span> <span class="title">bool</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">as_bool</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Json::<span class="keyword">operator</span> <span class="title">int</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">as_int</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Json::<span class="keyword">operator</span> <span class="title">double</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">as_double</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Json::<span class="keyword">operator</span> <span class="title">string</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">as_string</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Json::clear</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (m_type)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> JSON_NULL:</span><br><span class="line">        <span class="keyword">case</span> JSON_BOOL:</span><br><span class="line">        <span class="keyword">case</span> JSON_INT:</span><br><span class="line">        <span class="keyword">case</span> JSON_DOUBLE:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> JSON_STRING:</span><br><span class="line">            <span class="keyword">if</span> (m_value.m_string != <span class="literal">nullptr</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">delete</span> m_value.m_string;</span><br><span class="line">                m_value.m_string = <span class="literal">nullptr</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> JSON_ARRAY:</span><br><span class="line">            <span class="keyword">if</span> (m_value.m_array != <span class="literal">nullptr</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">auto</span> it = (m_value.m_array)-&gt;<span class="built_in">begin</span>(); it != (m_value.m_array)-&gt;<span class="built_in">end</span>(); ++it)</span><br><span class="line">                &#123;</span><br><span class="line">                    it-&gt;<span class="built_in">clear</span>();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">delete</span> m_value.m_array;</span><br><span class="line">                m_value.m_array = <span class="literal">nullptr</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> JSON_OBJECT:</span><br><span class="line">            <span class="keyword">if</span> (m_value.m_object != <span class="literal">nullptr</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">auto</span> it = (m_value.m_object)-&gt;<span class="built_in">begin</span>(); it != (m_value.m_object)-&gt;<span class="built_in">end</span>(); ++it)</span><br><span class="line">                &#123;</span><br><span class="line">                    it-&gt;second.<span class="built_in">clear</span>();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">delete</span> m_value.m_object;</span><br><span class="line">                m_value.m_object = <span class="literal">nullptr</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    m_type = JSON_NULL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Json &amp; Json::<span class="keyword">operator</span>=(<span class="type">bool</span> value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">clear</span>();</span><br><span class="line">    m_type = JSON_BOOL;</span><br><span class="line">    m_value.m_bool = value;</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Json &amp; Json::<span class="keyword">operator</span>=(<span class="type">int</span> value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">clear</span>();</span><br><span class="line">    m_type = JSON_INT;</span><br><span class="line">    m_value.m_int = value;</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Json &amp; Json::<span class="keyword">operator</span>=(<span class="type">double</span> value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">clear</span>();</span><br><span class="line">    m_type = JSON_DOUBLE;</span><br><span class="line">    m_value.m_double = value;</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Json &amp; Json::<span class="keyword">operator</span>=(<span class="type">const</span> <span class="type">char</span> *value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">clear</span>();</span><br><span class="line">    m_type = JSON_STRING;</span><br><span class="line">    m_value.m_string = <span class="keyword">new</span> <span class="built_in">string</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Json &amp; Json::<span class="keyword">operator</span>=(<span class="type">const</span> string &amp;value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">clear</span>();</span><br><span class="line">    m_type = JSON_STRING;</span><br><span class="line">    m_value.m_string = <span class="keyword">new</span> <span class="built_in">string</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Json &amp; Json::<span class="keyword">operator</span>=(<span class="type">const</span> Json &amp; other)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">clear</span>();</span><br><span class="line">    <span class="built_in">copy</span>(other);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Json &amp; Json::<span class="keyword">operator</span>=(Json &amp;&amp; other) <span class="keyword">noexcept</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">swap</span>(other);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Json::append</span><span class="params">(<span class="type">const</span> Json &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_type != JSON_ARRAY)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">clear</span>();</span><br><span class="line">        m_type = JSON_ARRAY;</span><br><span class="line">        m_value.m_array = <span class="keyword">new</span> std::<span class="built_in">vector</span>&lt;Json&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    (m_value.m_array)-&gt;<span class="built_in">push_back</span>(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Json::append</span><span class="params">(Json &amp;&amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_type != JSON_ARRAY)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">clear</span>();</span><br><span class="line">        m_type = JSON_ARRAY;</span><br><span class="line">        m_value.m_array = <span class="keyword">new</span> std::<span class="built_in">vector</span>&lt;Json&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    (m_value.m_array)-&gt;<span class="built_in">push_back</span>(std::<span class="built_in">move</span>(value));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Json::has</span><span class="params">(<span class="type">int</span> index)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_type != JSON_ARRAY)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> size = (<span class="type">int</span>)(m_value.m_array)-&gt;<span class="built_in">size</span>();</span><br><span class="line">    <span class="keyword">return</span> index &gt;= <span class="number">0</span> &amp;&amp; index &lt; size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Json::has</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * key)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_type != JSON_OBJECT)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (m_value.m_object)-&gt;<span class="built_in">find</span>(key) != (m_value.m_object)-&gt;<span class="built_in">end</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Json::has</span><span class="params">(<span class="type">const</span> string &amp; key)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">has</span>(key.<span class="built_in">c_str</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Json <span class="title">Json::get</span><span class="params">(<span class="type">int</span> index)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">has</span>(index))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Json</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (m_value.m_array)-&gt;<span class="built_in">at</span>(index);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Json <span class="title">Json::get</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">has</span>(key))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Json</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (*(m_value.m_object))[key];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Json <span class="title">Json::get</span><span class="params">(<span class="type">const</span> string &amp; key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">get</span>(key.<span class="built_in">c_str</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Json::remove</span><span class="params">(<span class="type">int</span> index)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">has</span>(index))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    (m_value.m_array)-&gt;<span class="built_in">at</span>(index).<span class="built_in">clear</span>();</span><br><span class="line">    (m_value.m_array)-&gt;<span class="built_in">erase</span>((m_value.m_array)-&gt;<span class="built_in">begin</span>() + index);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Json::remove</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_type != JSON_OBJECT)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">auto</span> it = (m_value.m_object)-&gt;<span class="built_in">find</span>(key);</span><br><span class="line">    <span class="keyword">if</span> (it == (m_value.m_object)-&gt;<span class="built_in">end</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    it-&gt;second.<span class="built_in">clear</span>();</span><br><span class="line">    (m_value.m_object)-&gt;<span class="built_in">erase</span>(key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Json::remove</span><span class="params">(<span class="type">const</span> string &amp; key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">remove</span>(key.<span class="built_in">c_str</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Json &amp; Json::<span class="keyword">operator</span>[](<span class="type">int</span> index)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_type != JSON_ARRAY)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;type error: not array&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">has</span>(index))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;array out of range&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (m_value.m_array)-&gt;<span class="built_in">at</span>(index);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Json &amp; Json::<span class="keyword">operator</span>[](<span class="type">const</span> <span class="type">char</span> * key)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_type != JSON_OBJECT)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">clear</span>();</span><br><span class="line">        m_type = JSON_OBJECT;</span><br><span class="line">        m_value.m_object = <span class="keyword">new</span> std::<span class="built_in">map</span>&lt;string, Json&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (*(m_value.m_object))[key];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Json &amp; Json::<span class="keyword">operator</span>[](<span class="type">const</span> string &amp; key)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> (*<span class="keyword">this</span>)[key.<span class="built_in">c_str</span>()];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Json::size</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (m_type)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> JSON_ARRAY:</span><br><span class="line">            <span class="keyword">return</span> (m_value.m_array)-&gt;<span class="built_in">size</span>();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> JSON_OBJECT:</span><br><span class="line">            <span class="keyword">return</span> (m_value.m_object)-&gt;<span class="built_in">size</span>();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Json::empty</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (m_type)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> JSON_NULL:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> JSON_ARRAY:</span><br><span class="line">            <span class="keyword">return</span> (m_value.m_array)-&gt;<span class="built_in">empty</span>();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> JSON_OBJECT:</span><br><span class="line">            <span class="keyword">return</span> (m_value.m_object)-&gt;<span class="built_in">empty</span>();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Json::copy</span><span class="params">(<span class="type">const</span> Json &amp; other)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">clear</span>();</span><br><span class="line">    m_type = other.m_type;</span><br><span class="line">    <span class="keyword">switch</span> (m_type)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> JSON_NULL:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> JSON_BOOL:</span><br><span class="line">        <span class="keyword">case</span> JSON_INT:</span><br><span class="line">        <span class="keyword">case</span> JSON_DOUBLE:</span><br><span class="line">            m_value = other.m_value;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> JSON_STRING:</span><br><span class="line">            <span class="keyword">if</span> (other.m_value.m_string != <span class="literal">nullptr</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                m_value.m_string = <span class="keyword">new</span> <span class="built_in">string</span>(*(other.m_value.m_string));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> JSON_ARRAY:</span><br><span class="line">            <span class="keyword">if</span> (other.m_value.m_array != <span class="literal">nullptr</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                m_value.m_array = <span class="keyword">new</span> std::<span class="built_in">vector</span>&lt;Json&gt;();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">auto</span> it = (other.m_value.m_array)-&gt;<span class="built_in">begin</span>(); it != (other.m_value.m_array)-&gt;<span class="built_in">end</span>(); ++it)</span><br><span class="line">                &#123;</span><br><span class="line">                    (m_value.m_array)-&gt;<span class="built_in">push_back</span>(*it);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> JSON_OBJECT:</span><br><span class="line">            <span class="keyword">if</span> (other.m_value.m_object != <span class="literal">nullptr</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                m_value.m_object = <span class="keyword">new</span> std::<span class="built_in">map</span>&lt;string, Json&gt;();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">auto</span> it = (other.m_value.m_object)-&gt;<span class="built_in">begin</span>(); it != (other.m_value.m_object)-&gt;<span class="built_in">end</span>(); ++it)</span><br><span class="line">                &#123;</span><br><span class="line">                    (*(m_value.m_object))[it-&gt;first] = it-&gt;second;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Json::parse</span><span class="params">(<span class="type">const</span> string &amp; filename)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">clear</span>();</span><br><span class="line">    Parser p;</span><br><span class="line">    p.<span class="built_in">load</span>(filename);</span><br><span class="line">    *<span class="keyword">this</span> = p.<span class="built_in">parse</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Json::parse</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * buf, <span class="type">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">clear</span>();</span><br><span class="line">    Parser p;</span><br><span class="line">    p.<span class="built_in">load</span>(buf, len);</span><br><span class="line">    *<span class="keyword">this</span> = p.<span class="built_in">parse</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// swap仅交换内容，不拷贝内容</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Json::swap</span><span class="params">(Json &amp; other)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Type type = m_type;</span><br><span class="line">    Value value = m_value;</span><br><span class="line">    m_type = other.m_type;</span><br><span class="line">    m_value = other.m_value;</span><br><span class="line">    other.m_type = type;</span><br><span class="line">    other.m_value = value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="parser实现">Parser实现</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// json/parser.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;json/json.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> std::string;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> json</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Parser</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">Parser</span>() = <span class="keyword">default</span>;</span><br><span class="line">            ~<span class="built_in">Parser</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">load</span><span class="params">(<span class="type">const</span> string &amp; filename)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">load</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * buf, <span class="type">int</span> len)</span></span>;</span><br><span class="line">            <span class="function">Json <span class="title">parse</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="comment">// 忽略空白符</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">skip_white_space</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="comment">// 读取下一个字符</span></span><br><span class="line">            <span class="function"><span class="type">char</span> <span class="title">get_next_token</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">in_range</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> lower, <span class="type">int</span> upper)</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="function">Json <span class="title">parse_null</span><span class="params">()</span></span>;                  <span class="comment">// 解析null</span></span><br><span class="line">            <span class="function">Json <span class="title">parse_bool</span><span class="params">()</span></span>;                  <span class="comment">// 解析bool</span></span><br><span class="line">            <span class="function">Json <span class="title">parse_number</span><span class="params">()</span></span>;                <span class="comment">// 解析数字</span></span><br><span class="line">            <span class="function">string <span class="title">parse_string</span><span class="params">()</span></span>;              <span class="comment">// 解析字符串</span></span><br><span class="line">            <span class="function">Json <span class="title">parse_array</span><span class="params">()</span></span>;                 <span class="comment">// 解析数组</span></span><br><span class="line">            <span class="function">Json <span class="title">parse_object</span><span class="params">()</span></span>;                <span class="comment">// 解析对象</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            string m_str;</span><br><span class="line">            <span class="type">size_t</span> m_idx = <span class="number">0</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// json/parser.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;json/parser.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::json;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Parser::load</span><span class="params">(<span class="type">const</span> string &amp; filename)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">std::ifstream <span class="title">ofs</span><span class="params">(filename)</span></span>;</span><br><span class="line">    std::ostringstream oss;</span><br><span class="line">    oss &lt;&lt; ofs.<span class="built_in">rdbuf</span>();</span><br><span class="line">    m_str = oss.<span class="built_in">str</span>();</span><br><span class="line">    m_idx = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Parser::load</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * buf, <span class="type">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_str.<span class="built_in">assign</span>(buf, len);</span><br><span class="line">    m_idx = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Parser::skip_white_space</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (m_str[m_idx] == <span class="string">&#x27; &#x27;</span> || m_str[m_idx] == <span class="string">&#x27;\r&#x27;</span> || m_str[m_idx] == <span class="string">&#x27;\n&#x27;</span> || m_str[m_idx] == <span class="string">&#x27;\t&#x27;</span>)</span><br><span class="line">        m_idx++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">char</span> <span class="title">Parser::get_next_token</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">skip_white_space</span>();</span><br><span class="line">    <span class="keyword">if</span> (m_idx == m_str.<span class="built_in">size</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;unexpected input&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> m_str[m_idx++];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Parser::in_range</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> lower, <span class="type">int</span> upper)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x &gt;= lower &amp;&amp; x &lt;= upper;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Json <span class="title">Parser::parse</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> ch = <span class="built_in">get_next_token</span>();</span><br><span class="line">    <span class="keyword">switch</span> (ch)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;n&#x27;</span>:</span><br><span class="line">            <span class="comment">// null</span></span><br><span class="line">            m_idx--;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">parse_null</span>();</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;t&#x27;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;f&#x27;</span>:</span><br><span class="line">            <span class="comment">// true, false</span></span><br><span class="line">            m_idx--;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">parse_bool</span>();</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;-&#x27;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;0&#x27;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;1&#x27;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;2&#x27;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;3&#x27;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;4&#x27;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;5&#x27;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;6&#x27;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;7&#x27;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;8&#x27;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;9&#x27;</span>:</span><br><span class="line">            <span class="comment">// 数字</span></span><br><span class="line">            m_idx--;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">parse_number</span>();</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;&quot;&#x27;</span>:</span><br><span class="line">            <span class="comment">// 字符串</span></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">parse_string</span>();</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;[&#x27;</span>:</span><br><span class="line">            <span class="comment">// 数组</span></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">parse_array</span>();</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;&#123;&#x27;</span>:</span><br><span class="line">            <span class="comment">// 对象</span></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">parse_object</span>();</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;unexpected character&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Json <span class="title">Parser::parse_null</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_str.<span class="built_in">compare</span>(m_idx, <span class="number">4</span>, <span class="string">&quot;null&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        m_idx += <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Json</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;parse null error&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Json <span class="title">Parser::parse_bool</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_str.<span class="built_in">compare</span>(m_idx, <span class="number">4</span>, <span class="string">&quot;true&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        m_idx += <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Json</span>(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (m_str.<span class="built_in">compare</span>(m_idx, <span class="number">5</span>, <span class="string">&quot;false&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        m_idx += <span class="number">5</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Json</span>(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;parse bool error&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Json <span class="title">Parser::parse_number</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> pos = m_idx;</span><br><span class="line">    <span class="keyword">if</span> (m_str[m_idx] == <span class="string">&#x27;-&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        m_idx++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (m_str[m_idx] == <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        m_idx++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">in_range</span>(m_str[m_idx], <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;9&#x27;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        m_idx++;</span><br><span class="line">        <span class="keyword">while</span> (<span class="built_in">in_range</span>(m_str[m_idx], <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;9&#x27;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            m_idx++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;invalid character in number&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果没有小数</span></span><br><span class="line">    <span class="keyword">if</span> (m_str[m_idx] != <span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Json</span>(std::<span class="built_in">atoi</span>(m_str.<span class="built_in">c_str</span>() + pos));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果有小数</span></span><br><span class="line">    m_idx++;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">in_range</span>(m_str[m_idx], <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;9&#x27;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;invalid float number&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">in_range</span>(m_str[m_idx], <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;9&#x27;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        m_idx++;   </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Json</span>(std::<span class="built_in">atof</span>(m_str.<span class="built_in">c_str</span>() + pos));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">string <span class="title">Parser::parse_string</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> pos = m_idx;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> ch = <span class="built_in">get_next_token</span>();</span><br><span class="line">        <span class="keyword">if</span> (ch == <span class="string">&#x27;&quot;&#x27;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果是转义字符</span></span><br><span class="line">        <span class="keyword">if</span> (ch == <span class="string">&#x27;\\&#x27;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            ch = <span class="built_in">get_next_token</span>();</span><br><span class="line">            <span class="keyword">switch</span> (ch)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;b&#x27;</span>:</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;t&#x27;</span>:</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;n&#x27;</span>:</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;f&#x27;</span>:</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;r&#x27;</span>:</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;&quot;&#x27;</span>:</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;\\&#x27;</span>:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;u&#x27;</span>:           <span class="comment">// unicode</span></span><br><span class="line">                    m_idx += <span class="number">4</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> m_str.<span class="built_in">substr</span>(pos, m_idx - pos - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Json <span class="title">Parser::parse_array</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">Json <span class="title">arr</span><span class="params">(Json::JSON_ARRAY)</span></span>;</span><br><span class="line">    <span class="type">char</span> ch = <span class="built_in">get_next_token</span>();</span><br><span class="line">    <span class="keyword">if</span> (ch == <span class="string">&#x27;]&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> arr;</span><br><span class="line">    &#125;</span><br><span class="line">    m_idx--;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        arr.<span class="built_in">append</span>(<span class="built_in">parse</span>());</span><br><span class="line">        ch = <span class="built_in">get_next_token</span>();</span><br><span class="line">        <span class="keyword">if</span> (ch == <span class="string">&#x27;]&#x27;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ch != <span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;expected &#x27;,&#x27; in array&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> arr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Json <span class="title">Parser::parse_object</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">Json <span class="title">obj</span><span class="params">(Json::JSON_OBJECT)</span></span>;</span><br><span class="line">    <span class="type">char</span> ch = <span class="built_in">get_next_token</span>();</span><br><span class="line">    <span class="keyword">if</span> (ch == <span class="string">&#x27;&#125;&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">    m_idx--;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ch = <span class="built_in">get_next_token</span>();</span><br><span class="line">        <span class="keyword">if</span> (ch != <span class="string">&#x27;&quot;&#x27;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;invalid object key&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        string key = <span class="built_in">parse_string</span>();</span><br><span class="line">        ch = <span class="built_in">get_next_token</span>();</span><br><span class="line">        <span class="keyword">if</span> (ch != <span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;expected &#x27;:&#x27; in object&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        obj[key] = <span class="built_in">parse</span>();</span><br><span class="line">        ch = <span class="built_in">get_next_token</span>();</span><br><span class="line">        <span class="keyword">if</span> (ch == <span class="string">&#x27;&#125;&#x27;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ch != <span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;expected &#x27;,&#x27; in object&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> C++后端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>time时间操作</title>
      <link href="/2024/05/19/time%E6%97%B6%E9%97%B4%E6%93%8D%E4%BD%9C/"/>
      <url>/2024/05/19/time%E6%97%B6%E9%97%B4%E6%93%8D%E4%BD%9C/</url>
      
        <content type="html"><![CDATA[<h1 id="时间常用操作">时间常用操作</h1><h2 id="time">time</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">time_t</span> <span class="title">time</span><span class="params">(<span class="type">time_t</span> *timer)</span></span></span><br></pre></td></tr></table></figure><p>形参<code>timer</code>值为<code>NULL</code>时得到当前日历时间（从<code>1970-01-01 00:00:00</code>到现在的秒数）。<br>形参<code>timer</code>为时间数值时，用于设置日历时间，<code>time_t</code>是一个<code>unsigned long</code>类型。<br>如果<code>timer</code>不为空，则返回值也存储在变量<code>timer</code>中。</p><p>缺点：时间精度仅为秒</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 自1970年1月1日起的秒数</span></span><br><span class="line">    <span class="type">time_t</span> ticks = <span class="built_in">time</span>(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%ld\n&quot;</span>, ticks);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="localtime">localtime</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">tm</span> *<span class="built_in">localtime</span>(<span class="type">const</span> <span class="type">time_t</span> *timer)</span><br></pre></td></tr></table></figure><p>C库函数<code>struct tm *localtime(const time_t *timer)</code>使用<code>timer</code>的值来填充<code>tm</code>结构，并用本地时区表示。<code>tm</code>结构体内容如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">tm</span> &#123;</span><br><span class="line">    <span class="type">int</span> tm_sec; <span class="comment">// 秒，范围从0到59</span></span><br><span class="line">    <span class="type">int</span> tm_min; <span class="comment">// 分，范围从0到59</span></span><br><span class="line">    <span class="type">int</span> tm_hour; <span class="comment">// 小时，范围从0到23</span></span><br><span class="line">    <span class="type">int</span> tm_mday; <span class="comment">// 一月中的第几天，范围从1到31</span></span><br><span class="line">    <span class="type">int</span> tm_mon; <span class="comment">// 月份，范围从0到11</span></span><br><span class="line">    <span class="type">int</span> tm_year; <span class="comment">// 自1900起的年数</span></span><br><span class="line">    <span class="type">int</span> tm_wday; <span class="comment">// 一周中的第几天，范围从0到6</span></span><br><span class="line">    <span class="type">int</span> tm_yday; <span class="comment">// 一年中的第几天，范围从0到365</span></span><br><span class="line">    <span class="type">int</span> tm_isdst; <span class="comment">// 夏令时</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span> <span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">time_t</span> ticks = <span class="built_in">time</span>(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">tm</span> * info;</span><br><span class="line">    info = <span class="built_in">localtime</span>(&amp;ticks);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d-%d-%d %d:%d:%d\n&quot;</span>,</span><br><span class="line">    info-&gt;tm_year + <span class="number">1900</span>, info-&gt;tm_mon + <span class="number">1</span>, info-&gt;tm_mday,</span><br><span class="line">    info-&gt;tm_hour, info-&gt;tm_min, info-&gt;tm_sec);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>缺点：线程不安全！</p><p>Linux线程安全版本为<code>localtime_r</code>，Windows线程安全版本为<code>localtime_s</code>。</p><h2 id="asctime">asctime</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">char</span> *<span class="title">asctime</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> tm *timeptr)</span></span></span><br></pre></td></tr></table></figure><p>C库函数<code>char *asctime(const struct tm *timeptr)</code>返回一个指向字符串的指针，它代表了结构体<code>struct timeptr</code>的日期和时间。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span> <span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">time_t</span> ticks = <span class="built_in">time</span>(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">tm</span> * info;</span><br><span class="line">    info = <span class="built_in">localtime</span>(&amp;ticks);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, <span class="built_in">asctime</span>(info));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>缺点：线程不安全；时间格式固定，适合欧美用户。</p><h2 id="strftime">strftime</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">size_t</span> <span class="title">strftime</span><span class="params">(<span class="type">char</span> *str, <span class="type">size_t</span> len, <span class="type">const</span> <span class="type">char</span> *format, <span class="type">const</span> <span class="keyword">struct</span> tm *timeptr)</span></span></span><br></pre></td></tr></table></figure><p>参数说明：</p><ul><li><code>str</code>——指向目标数组的指针，用来保存产生的C字符串</li><li><code>len</code> ——<code>str</code>目标数组长度</li><li><code>format</code> ——这是C字符串，包含了普通字符和特殊格式说明符的任何组合，这些格式说明符由函数替换为表示，即为表示时间的格式</li><li><code>timeptr</code> ——中所指定时间的相对应值</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span> <span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">time_t</span> ticks = <span class="built_in">time</span>(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">tm</span> * info;</span><br><span class="line">    info = <span class="built_in">localtime</span>(&amp;ticks);</span><br><span class="line">    <span class="type">char</span> str[<span class="number">32</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">strftime</span>(str, <span class="built_in">sizeof</span>(str), <span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>, info);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, str);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>优点：跨平台；线程安全；时间格式可定制</p><h2 id="sleep">sleep</h2><p>Linux:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">int</span> <span class="title">sleep</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> seconds)</span></span>; <span class="comment">// 参数为秒</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">usleep</span><span class="params">(<span class="type">int</span> micro_seconds)</span></span>; <span class="comment">// 参数为微秒</span></span><br></pre></td></tr></table></figure><p>Windows:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Sleep</span><span class="params">(DWORD dwMilliseconds)</span></span>; <span class="comment">// 参数为毫秒</span></span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span> <span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">usleep</span>(<span class="number">1000</span> * <span class="number">1000</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="gettimeofday">gettimeofday</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">gettimeofday</span><span class="params">(<span class="keyword">struct</span> timeval *tv, <span class="keyword">struct</span> timezone *tz)</span></span>;</span><br></pre></td></tr></table></figure><p>其参数<code>tv</code>是保存获取时间结果的结构体，参数<code>tz</code>用于保存时区结果（若不使用则传入<code>NULL</code>即可）。</p><p><code>struct timeval</code>结构体内容如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">timeval</span> &#123;</span><br><span class="line">    <span class="type">long</span> tv_sec; <span class="comment">// 秒数</span></span><br><span class="line">    <span class="type">long</span> tv_usec; <span class="comment">// 微秒数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span> <span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">timeval</span> tv;</span><br><span class="line">    <span class="built_in">gettimeofday</span>(&amp;tv, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;sec = %ld, usec = %ld\n&quot;</span>, tv.tv_sec, tv.tv_usec);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>缺点：非跨平台，Windows不支持该函数</p><h1 id="timer类设计与实现">Timer类设计与实现</h1><h2 id="跨平台实现">跨平台实现</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// utility/time.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> WI32</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// utility/time.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Time::get_time_of_day</span><span class="params">(<span class="keyword">struct</span> timeval * tv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> WIN32</span></span><br><span class="line">    SYSTEMTIME wtm;</span><br><span class="line">    <span class="built_in">GetLocalTime</span>(&amp;wtm);</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">tm</span> tm;</span><br><span class="line">    tm.tm_year = wtm.wYear - <span class="number">1900</span>;</span><br><span class="line">    tm.tm_mon = wtm.wMonth - <span class="number">1</span>;</span><br><span class="line">    tm.tm_mday = wtm.wDay;</span><br><span class="line">    tm.tm_hour = wtm.wHour;</span><br><span class="line">    tm.tm_min = wtm.wMinute;</span><br><span class="line">    tm.tm_sec = wtm.wSecond;</span><br><span class="line">    tm.tm_isdst = <span class="number">-1</span>;</span><br><span class="line">    <span class="type">time_t</span> ticks = <span class="built_in">mktime</span>(&amp;tm);</span><br><span class="line">    tv-&gt;tv_sec = ticks;</span><br><span class="line">    tv-&gt;tv_usec = wtm.wMilliseconds * <span class="number">1000</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="built_in">gettimeofday</span>(tv, <span class="literal">nullptr</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="完整实现">完整实现</h2><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CMakeLists.txt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.20</span>)</span><br><span class="line"><span class="keyword">project</span>(hello CXX)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD <span class="number">11</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">file</span>(GLOB_RECURSE SOURCES <span class="string">&quot;utility/*.cpp&quot;</span>)</span><br><span class="line"><span class="keyword">add_executable</span>(main <span class="variable">$&#123;SOURCES&#125;</span> main.cpp)</span><br><span class="line"><span class="keyword">target_include_directories</span>(main PRIVATE .)</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// utility/time.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctime&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> WI32</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> std::string;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> utility</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Time</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">Time</span>();</span><br><span class="line">            ~<span class="built_in">Time</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 以下接口分别返回年月日时分秒周</span></span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">year</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">month</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">day</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">hour</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">minute</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">second</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">week</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">show</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 自1970-01-01 00:00:00到现在的秒数与毫秒数</span></span><br><span class="line">            <span class="function"><span class="type">double</span> <span class="title">seconds</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="function"><span class="type">double</span> <span class="title">milliseconds</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="comment">// 返回格式化的时间字符串</span></span><br><span class="line">            <span class="function">string <span class="title">format</span><span class="params">(<span class="type">const</span> string &amp; format)</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="type">double</span> <span class="keyword">operator</span>-(<span class="type">const</span> Time &amp; other);</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">sleep</span><span class="params">(<span class="type">int</span> milliseconds)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">get_local_time</span><span class="params">(<span class="keyword">struct</span> tm * tm, <span class="type">const</span> <span class="type">time_t</span> * ticks)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">get_time_of_day</span><span class="params">(<span class="keyword">struct</span> timeval * tv)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="keyword">struct</span> <span class="title class_">tm</span> m_tm = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            <span class="type">int</span> m_sec;</span><br><span class="line">            <span class="type">int</span> m_usec;             <span class="comment">// 毫秒精度</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// utility/time.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility/time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::utility;</span><br><span class="line"></span><br><span class="line">Time::<span class="built_in">Time</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 自1970-01-01 00:00:00到现在的秒数</span></span><br><span class="line">    <span class="type">time_t</span> ticks = <span class="built_in">time</span>(<span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">get_local_time</span>(&amp;m_tm, &amp;ticks);</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">timeval</span> tv = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">get_time_of_day</span>(&amp;tv);</span><br><span class="line">    m_sec = tv.tv_sec;</span><br><span class="line">    m_usec = tv.tv_usec;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Time::get_local_time</span><span class="params">(<span class="keyword">struct</span> tm* tm, <span class="type">const</span> <span class="type">time_t</span> * ticks)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> WIN32</span></span><br><span class="line">    <span class="built_in">localtime_s</span>(tm, ticks);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="built_in">localtime_r</span>(ticks, tm);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Time::get_time_of_day</span><span class="params">(<span class="keyword">struct</span> timeval * tv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> WIN32</span></span><br><span class="line">    SYSTEMTIME wtm;</span><br><span class="line">    <span class="built_in">GetLocalTime</span>(&amp;wtm);</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">tm</span> tm;</span><br><span class="line">    tm.tm_year = wtm.wYear - <span class="number">1900</span>;</span><br><span class="line">    tm.tm_mon = wtm.wMonth - <span class="number">1</span>;</span><br><span class="line">    tm.tm_mday = wtm.wDay;</span><br><span class="line">    tm.tm_hour = wtm.wHour;</span><br><span class="line">    tm.tm_min = wtm.wMinute;</span><br><span class="line">    tm.tm_sec = wtm.wSecond;</span><br><span class="line">    tm.tm_isdst = <span class="number">-1</span>;</span><br><span class="line">    <span class="type">time_t</span> ticks = <span class="built_in">mktime</span>(&amp;tm);</span><br><span class="line">    tv-&gt;tv_sec = ticks;</span><br><span class="line">    tv-&gt;tv_usec = wtm.wMilliseconds * <span class="number">1000</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="built_in">gettimeofday</span>(tv, <span class="literal">nullptr</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Time::year</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_tm.tm_year + <span class="number">1900</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Time::month</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_tm.tm_mon + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Time::day</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_tm.tm_mday;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Time::hour</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_tm.tm_hour;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Time::minute</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_tm.tm_min;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Time::second</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_tm.tm_sec;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Time::week</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_tm.tm_wday;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Time::show</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="built_in">year</span>() &lt;&lt; <span class="string">&quot;-&quot;</span> &lt;&lt; <span class="built_in">month</span>() &lt;&lt; <span class="string">&quot;-&quot;</span> &lt;&lt; <span class="built_in">day</span>() &lt;&lt; <span class="string">&quot; &quot;</span></span><br><span class="line">        &lt;&lt; <span class="built_in">hour</span>() &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; <span class="built_in">minute</span>() &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; <span class="built_in">second</span>() &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">double</span> <span class="title">Time::seconds</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_sec;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">double</span> <span class="title">Time::milliseconds</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_sec * <span class="number">1000.0</span> + m_usec / <span class="number">1000.0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">double</span> Time::<span class="keyword">operator</span>-(<span class="type">const</span> Time &amp; other)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> (m_sec - other.m_sec) * <span class="number">1000000.0</span> + (m_usec - other.m_usec);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Time::sleep</span><span class="params">(<span class="type">int</span> milliseconds)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> WIN32</span></span><br><span class="line">    <span class="built_in">Sleep</span>(milliseconds);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="built_in">usleep</span>(milliseconds * <span class="number">1000</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">string <span class="title">Time::format</span><span class="params">(<span class="type">const</span> string &amp; format)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> timestamp[<span class="number">32</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">strftime</span>(timestamp, <span class="built_in">sizeof</span>(timestamp), format.<span class="built_in">c_str</span>(), &amp;m_tm);</span><br><span class="line">    <span class="keyword">return</span> timestamp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility/time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::utility;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Time t1;</span><br><span class="line">    t1.<span class="built_in">show</span>();</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;sec = &quot;</span> &lt;&lt; t1.<span class="built_in">seconds</span>() &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;milliseconds = &quot;</span> &lt;&lt; t1.<span class="built_in">milliseconds</span>() &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; t1.format(<span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>) &lt;&lt; std::endl;</span><br><span class="line">    Time::<span class="built_in">sleep</span>(<span class="number">2000</span>);</span><br><span class="line"></span><br><span class="line">    Time t2;</span><br><span class="line">    <span class="type">double</span> usec = t2 - t1;</span><br><span class="line">    std::cout &lt;&lt; usec / <span class="number">1000.0</span> &lt;&lt; <span class="string">&quot; ms&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> C++后端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vector深度探索</title>
      <link href="/2024/05/12/vector%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2/"/>
      <url>/2024/05/12/vector%E6%B7%B1%E5%BA%A6%E6%8E%A2%E7%B4%A2/</url>
      
        <content type="html"><![CDATA[<h1 id="实现一个vector">实现一个vector</h1><h2 id="探索vector的视线">探索vector的视线</h2><p>以<code>vector&lt;char&gt;</code>为例，它其实就是个字符数组，内部结构如下图所示。图中方格表示<code>vector&lt;char&gt;</code>中的每一个元素，整个一串就是一个数组，而每个元素就是连续内存中的一个字符。</p><p><img src="https://aliyun-oss-zh.oss-cn-beijing.aliyuncs.com/img/QQ20250617-011938.jpg" alt=""></p><p>该数组内部会有两个字段<code>size</code>和<code>capacity</code>，前者表示其实际大小，后者表示数组当前的最大容量5，即最多容纳多少个元素8，当它塞满以后如果继续往里面添加元素会触发内存的重新分配，给该数组分配更大一块内存。</p><h2 id="vector模板函数">vector模板函数</h2><h3 id="push-back">push_back</h3><p>向容器尾部添加元素</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="type">void</span> zh::stl::Vector&lt;T&gt;::<span class="built_in">push_back</span>(<span class="type">const</span> T &amp; value)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (m_size &lt; m_capacity)</span><br><span class="line">    &#123;</span><br><span class="line">        m_data[m_size] = value;</span><br><span class="line">        m_size++;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Vector扩容机制</span></span><br><span class="line">    <span class="keyword">if</span> (m_capacity == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        m_capacity = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        m_capacity *= <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    T * data = <span class="keyword">new</span> T[m_capacity];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; m_size; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        data[i] = m_data[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (m_data != <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">delete</span> [] m_data;</span><br><span class="line">        m_data = <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    m_data = data;</span><br><span class="line">    m_data[m_size] = value;</span><br><span class="line">    m_size++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="pop-back">pop_back</h3><p>删除容器中最后一个元素</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="type">void</span> Vector&lt;T&gt;::<span class="built_in">pop_back</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_size &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        m_size--;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="at">at</h3><p>返回指定位置元素的索引，并进行边界检查</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">T &amp; Vector&lt;T&gt;::<span class="built_in">at</span>(<span class="type">int</span> index)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (index &lt; <span class="number">0</span> || index &gt;= m_size)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;out og range&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">return</span> m_data[index];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="type">const</span> T &amp; Vector&lt;T&gt;::<span class="built_in">at</span>(<span class="type">int</span> index) <span class="type">const</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">at</span>(index);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="front">front</h3><p>返回第一个元素的引用</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">T &amp; Vector&lt;T&gt;::<span class="built_in">front</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (m_size &lt;= <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;vector is empty&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> m_data[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="type">const</span> T &amp; Vector&lt;T&gt;::<span class="built_in">front</span>() <span class="type">const</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">front</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="back">back</h3><p>返回最后一个元素的引用</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">T &amp; Vector&lt;T&gt;::<span class="built_in">back</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (m_size &lt;= <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line"><span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;vector is empty&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> m_data[m_size - <span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="type">const</span> T &amp; Vector&lt;T&gt;::<span class="built_in">back</span>() <span class="type">const</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">back</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="empty">empty</h3><p>判断<code>Vector</code>是否为空</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="type">bool</span> Vector&lt;T&gt;::<span class="built_in">empty</span>() <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> m_size == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="clear">clear</h3><p>删除<code>Vector</code>中所有元素</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="type">void</span> Vector&lt;T&gt;::<span class="built_in">clear</span>() <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">&#123;</span><br><span class="line">m_size = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="size">size</h3><p>返回<code>Vector</code>中元素的数量</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="type">int</span> Vector&lt;T&gt;::<span class="built_in">size</span>() <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> m_size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="capacity">capacity</h3><p>返回<code>Vector</code>的容量</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="type">int</span> Vector&lt;T&gt;::<span class="built_in">capacity</span>() <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> m_capacity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="data">data</h3><p>返回内部数组指针</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">T * Vector&lt;T&gt;::<span class="built_in">data</span>() <span class="keyword">noexcept</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> m_data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="operator">operator[]</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">T &amp; Vector&lt;T&gt;::<span class="keyword">operator</span>[](<span class="type">int</span> index)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">at</span>(index);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="type">const</span> T &amp; Vector&lt;T&gt;::<span class="keyword">operator</span>[](<span class="type">int</span> index) <span class="type">const</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">at</span>(index);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="operator">operator=</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">Vector&lt;T&gt; &amp; Vector&lt;T&gt;::<span class="keyword">operator</span>=(<span class="type">const</span> Vector&lt;T&gt; &amp; other)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (m_capacity &lt; other.m_size)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (m_data != <span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line">            <span class="keyword">delete</span>[] m_data;</span><br><span class="line">            m_data = <span class="literal">nullptr</span>;</span><br><span class="line">            m_size = <span class="number">0</span>;</span><br><span class="line">            m_capacity = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">        <span class="keyword">while</span> (m_capacity &lt; other.m_size)</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">if</span> (m_capacity == <span class="number">0</span>)</span><br><span class="line">          &#123;</span><br><span class="line">             m_capacity = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                m_capacity *= <span class="number">2</span>;</span><br><span class="line">            &#125;</span><br><span class="line">       &#125;</span><br><span class="line">        m_data = <span class="keyword">new</span> T[m_capacity];</span><br><span class="line">  &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; other.m_size; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        m_data[i] = other.m_data[i];</span><br><span class="line">    &#125;</span><br><span class="line">    m_size = other.m_size;</span><br><span class="line">   <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="swap">swap</h3><p>交换两个<code>Vector</code>中的元素</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="type">void</span> Vector&lt;T&gt;::<span class="built_in">swap</span>(Vector&lt;T&gt; &amp; other)</span><br><span class="line">&#123;</span><br><span class="line">    T * data = other.m_data;</span><br><span class="line">    <span class="type">int</span> size = other.m_size;</span><br><span class="line">    <span class="type">int</span> capacity = other.capacity;</span><br><span class="line">    other.m_data = m_data;</span><br><span class="line">    other.m_size = m_size;</span><br><span class="line">    other.m_capacity = capacity;</span><br><span class="line">    m_data = data;</span><br><span class="line">    m_size = size;</span><br><span class="line">    m_capacity = capacity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="iterator">iterator</h3><p>将迭代器<code>iterator</code>作为<code>Vector</code>的内部类来实现：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Vector的迭代器类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">iterator</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">iterator</span>() : <span class="built_in">m_pointer</span>(<span class="literal">nullptr</span>) &#123;&#125;</span><br><span class="line">    <span class="built_in">iterator</span>(T *pointer) : <span class="built_in">m_pointer</span>(pointer) &#123;&#125;</span><br><span class="line">    ~<span class="built_in">iterator</span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> <span class="keyword">operator</span>==(<span class="type">const</span> iterator &amp;other)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> m_pointer == other.m_pointer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> <span class="keyword">operator</span>!=(<span class="type">const</span> iterator&amp; other)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> m_pointer != other.m_pointer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    iterator &amp;<span class="keyword">operator</span>=(<span class="type">const</span> iterator &amp;other)</span><br><span class="line">    &#123;</span><br><span class="line">        m_pointer == other.m_pointer;</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 前缀++</span></span><br><span class="line">    iterator &amp;<span class="keyword">operator</span>++()</span><br><span class="line">    &#123;</span><br><span class="line">        m_pointer++;</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 后缀++</span></span><br><span class="line">    iterator <span class="keyword">operator</span>++(<span class="type">int</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        iterator it = *<span class="keyword">this</span>;</span><br><span class="line">        ++(*<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">return</span> it;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    iterator <span class="keyword">operator</span>+(<span class="type">int</span> i)</span><br><span class="line">    &#123;</span><br><span class="line">        iterator it = *<span class="keyword">this</span>;</span><br><span class="line">        it.m_pointer += i;</span><br><span class="line">        <span class="keyword">return</span> it;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    iterator &amp;<span class="keyword">operator</span>+=(<span class="type">int</span> i)</span><br><span class="line">    &#123;</span><br><span class="line">        m_pointer += i;</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 前缀--</span></span><br><span class="line">    iterator &amp;<span class="keyword">operator</span>--()</span><br><span class="line">    &#123;</span><br><span class="line">        m_pointer -= <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 后缀--</span></span><br><span class="line">    iterator <span class="keyword">operator</span>--(<span class="type">int</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        iterator it = *<span class="keyword">this</span>;</span><br><span class="line">        --(*<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">return</span> it;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    iterator <span class="keyword">operator</span>-(<span class="type">int</span> i)</span><br><span class="line">    &#123;</span><br><span class="line">        iterator it = *<span class="keyword">this</span>;</span><br><span class="line">        m_pointer -= i;</span><br><span class="line">        <span class="keyword">return</span> it;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    iterator &amp;<span class="keyword">operator</span>-=(<span class="type">int</span> i)</span><br><span class="line">    &#123;</span><br><span class="line">        m_pointer -= i;</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="keyword">operator</span>-(<span class="type">const</span> iterator &amp;other) <span class="type">const</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> m_pointer - other.m_pointer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 迭代器解引用</span></span><br><span class="line">    T &amp;<span class="keyword">operator</span>*()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> *m_pointer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    T *<span class="keyword">operator</span>-&gt;()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> m_pointer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    T *m_pointer;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">typename</span> Vector&lt;T&gt;::iterator Vector&lt;T&gt;::<span class="built_in">begin</span>() <span class="keyword">noexcept</span></span><br><span class="line">&#123;</span><br><span class="line">Vector&lt;T&gt;::<span class="function">iterator <span class="title">it</span><span class="params">(m_data)</span></span>;</span><br><span class="line"><span class="keyword">return</span> it;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">typename</span> Vector&lt;T&gt;::iterator Vector&lt;T&gt;::<span class="built_in">end</span>() <span class="keyword">noexcept</span></span><br><span class="line">&#123;</span><br><span class="line">    Vector&lt;T&gt;::<span class="function">iterator <span class="title">it</span><span class="params">(m_data + m_size)</span></span>;</span><br><span class="line">    <span class="keyword">return</span> it;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="reverse-iterator">reverse_iterator</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">reverse_iterator</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">reverse_iterator</span>() : <span class="built_in">m_pointer</span>(<span class="literal">nullptr</span>) &#123;&#125;</span><br><span class="line">    <span class="built_in">reverse_iterator</span>(T *pointer) : <span class="built_in">m_pointer</span>(pointer) &#123;&#125;</span><br><span class="line">    ~<span class="built_in">reverse_iterator</span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> <span class="keyword">operator</span>==(<span class="type">const</span> reverse_iterator &amp;other)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> m_pointer == other.m_pointer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> <span class="keyword">operator</span>!=(<span class="type">const</span> reverse_iterator &amp;other)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> m_pointer != other.m_pointer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    reverse_iterator &amp;<span class="keyword">operator</span>=(<span class="type">const</span> reverse_iterator &amp;other)</span><br><span class="line">    &#123;</span><br><span class="line">        m_pointer = other.m_pointer;</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 前缀++</span></span><br><span class="line">    reverse_iterator &amp;<span class="keyword">operator</span>++()</span><br><span class="line">    &#123;</span><br><span class="line">        m_pointer--;</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 后缀++</span></span><br><span class="line">    reverse_iterator <span class="keyword">operator</span>++(<span class="type">int</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        reverse_iterator it = *<span class="keyword">this</span>;</span><br><span class="line">        ++(*<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">return</span> it;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    reverse_iterator <span class="keyword">operator</span>+(<span class="type">int</span> i)</span><br><span class="line">    &#123;</span><br><span class="line">        reverse_iterator it = *<span class="keyword">this</span>;</span><br><span class="line">        it.m_pointer -= i;</span><br><span class="line">        <span class="keyword">return</span> it;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    reverse_iterator &amp;<span class="keyword">operator</span>+=(<span class="type">int</span> i)</span><br><span class="line">    &#123;</span><br><span class="line">        m_pointer -= i;</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 前缀--</span></span><br><span class="line">    reverse_iterator &amp;<span class="keyword">operator</span>--()</span><br><span class="line">    &#123;</span><br><span class="line">        m_pointer++;</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 后缀--</span></span><br><span class="line">    reverse_iterator <span class="keyword">operator</span>--(<span class="type">int</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        reverse_iterator it = *<span class="keyword">this</span>;</span><br><span class="line">        --(*<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">return</span> it;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    reverse_iterator <span class="keyword">operator</span>-(<span class="type">int</span> i)</span><br><span class="line">    &#123;</span><br><span class="line">        reverse_iterator it = *<span class="keyword">this</span>;</span><br><span class="line">        it.m_pointer += i;</span><br><span class="line">        <span class="keyword">return</span> it;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    reverse_iterator &amp;<span class="keyword">operator</span>-=(<span class="type">int</span> i)</span><br><span class="line">    &#123;</span><br><span class="line">        m_pointer += i;</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    T &amp;<span class="keyword">operator</span>*()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> *m_pointer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    T *<span class="keyword">operator</span>-&gt;()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> m_pointer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    T *m_pointer;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">typename</span> Vector&lt;T&gt;::reverse_iterator Vector&lt;T&gt;::<span class="built_in">rbegin</span>() <span class="keyword">noexcept</span></span><br><span class="line">&#123;</span><br><span class="line">    Vector&lt;T&gt;::<span class="function">reverse_iterator <span class="title">it</span><span class="params">(m_data + m_size - <span class="number">1</span>)</span></span>;</span><br><span class="line">    <span class="keyword">return</span> it;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">typename</span> Vector&lt;T&gt;::reverse_iterator Vector&lt;T&gt;::<span class="built_in">rend</span>() <span class="keyword">noexcept</span></span><br><span class="line">&#123;</span><br><span class="line">    Vector&lt;T&gt;::<span class="function">reverse_iterator <span class="title">it</span><span class="params">(m_data - <span class="number">1</span>)</span></span>;</span><br><span class="line">    <span class="keyword">return</span> it;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="insert">insert</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">typename</span> Vector&lt;T&gt;::iterator Vector&lt;T&gt;::<span class="built_in">insert</span>(iterator position, <span class="type">const</span> T &amp;value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">insert</span>(position, <span class="number">1</span>, value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">typename</span> Vector&lt;T&gt;::iterator Vector&lt;T&gt;::<span class="built_in">insert</span>(iterator position, <span class="type">int</span> n, <span class="type">const</span> T &amp;value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> size = position - <span class="built_in">begin</span>();</span><br><span class="line">    <span class="comment">// 容量足够</span></span><br><span class="line">    <span class="keyword">if</span> (m_size + n &lt;= m_capacity)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 先把后面的元素向后挪，避免覆盖</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = m_size; i &gt; size; i--)</span><br><span class="line">        &#123;</span><br><span class="line">            m_data[i + n - <span class="number">1</span>] = m_data[i - <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            m_data[size + i] = value;</span><br><span class="line">        &#125;</span><br><span class="line">        m_size += n;</span><br><span class="line">        <span class="keyword">return</span> Vector&lt;T&gt;::<span class="built_in">iterator</span>(m_data + size);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 容量不足，需要先扩容</span></span><br><span class="line">    <span class="keyword">while</span> (m_size + n &gt; m_capacity)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (m_capacity == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            m_capacity = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            m_capacity *= <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    T *data = <span class="keyword">new</span> T[m_capacity];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; size; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        data[i] = m_data[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        data[size + i] = value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = size; i &lt; m_size; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        data[n + i] = m_data[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (m_data != <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">delete</span>[] m_data;</span><br><span class="line">        m_data = <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    m_data = data;</span><br><span class="line">    m_size += n;</span><br><span class="line">    <span class="keyword">return</span> Vector&lt;T&gt;::<span class="built_in">iterator</span>(m_data + size);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="erase">erase</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">typename</span> Vector&lt;T&gt;::iterator Vector&lt;T&gt;::<span class="built_in">erase</span>(iterator pos)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (pos == <span class="built_in">end</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;out of range&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">end</span>() - pos == <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 删除最后一个元素</span></span><br><span class="line">        m_size -= <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">end</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> size = pos - <span class="built_in">begin</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = size; i &lt; m_size - <span class="number">1</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        m_data[i] = m_data[i + <span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    m_size -= <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> pos;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">typename</span> Vector&lt;T&gt;::iterator Vector&lt;T&gt;::<span class="built_in">erase</span>(iterator first, iterator last)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> f = first - <span class="built_in">begin</span>();</span><br><span class="line">    <span class="type">int</span> l = last - <span class="built_in">begin</span>();</span><br><span class="line">    <span class="type">int</span> n = last - first;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; m_size - l; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        m_data[f + i] = m_data[l + i];</span><br><span class="line">    &#125;</span><br><span class="line">    m_size -= n;</span><br><span class="line">    <span class="keyword">return</span> first;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="完整实现">完整实现</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// stl/vector.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdexcept&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> stl</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Vector</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">Vector</span>();</span><br><span class="line">            ~<span class="built_in">Vector</span>();</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">push_back</span><span class="params">(<span class="type">const</span> T &amp; value)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">pop_back</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="function">T &amp; <span class="title">at</span><span class="params">(<span class="type">int</span> index)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">const</span> T &amp; <span class="title">at</span><span class="params">(<span class="type">int</span> index)</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="function">T &amp; <span class="title">front</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="function"><span class="type">const</span> T &amp; <span class="title">front</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="function">T &amp; <span class="title">back</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="function"><span class="type">const</span> T &amp; <span class="title">back</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">empty</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">clear</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span></span>;</span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">size</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span></span>;</span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">capacity</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="function">T * <span class="title">data</span><span class="params">()</span> <span class="keyword">noexcept</span></span>;</span><br><span class="line">            <span class="function"><span class="type">const</span> T * <span class="title">data</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span></span>;</span><br><span class="line"></span><br><span class="line">            T &amp; <span class="keyword">operator</span>[](<span class="type">int</span> index);</span><br><span class="line">            <span class="type">const</span> T &amp; <span class="keyword">operator</span>[](<span class="type">int</span> index) <span class="type">const</span>;</span><br><span class="line"></span><br><span class="line">            Vector&lt;T&gt; &amp; <span class="keyword">operator</span>=(<span class="type">const</span> Vector&lt;T&gt; &amp; other);</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">swap</span><span class="params">(Vector&lt;T&gt; &amp; other)</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">show</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Vector的迭代器</span></span><br><span class="line">            <span class="keyword">class</span> <span class="title class_">iterator</span></span><br><span class="line">            &#123;</span><br><span class="line">            <span class="keyword">public</span>:</span><br><span class="line">                <span class="built_in">iterator</span>() : <span class="built_in">m_pointer</span>(<span class="literal">nullptr</span>) &#123;&#125;</span><br><span class="line">                <span class="built_in">iterator</span>(T * pointer) : <span class="built_in">m_pointer</span>(pointer) &#123;&#125;</span><br><span class="line">                ~<span class="built_in">iterator</span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">bool</span> <span class="keyword">operator</span>==(<span class="type">const</span> iterator &amp; other)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> m_pointer == other.m_pointer;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">bool</span> <span class="keyword">operator</span>!=(<span class="type">const</span> iterator other)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> m_pointer != other.m_pointer;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                iterator &amp; <span class="keyword">operator</span>=(<span class="type">const</span> iterator &amp; other)</span><br><span class="line">                &#123;</span><br><span class="line">                    m_pointer == other.m_pointer;</span><br><span class="line">                    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 前缀++</span></span><br><span class="line">                iterator &amp; <span class="keyword">operator</span>++()</span><br><span class="line">                &#123;</span><br><span class="line">                    m_pointer++;</span><br><span class="line">                    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 后缀++</span></span><br><span class="line">                iterator <span class="keyword">operator</span>++(<span class="type">int</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    iterator it = *<span class="keyword">this</span>;</span><br><span class="line">                    ++(*<span class="keyword">this</span>);</span><br><span class="line">                    <span class="keyword">return</span> it;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                iterator <span class="keyword">operator</span>+(<span class="type">int</span> i)</span><br><span class="line">                &#123;</span><br><span class="line">                    iterator it = *<span class="keyword">this</span>;</span><br><span class="line">                    it.m_pointer += i;</span><br><span class="line">                    <span class="keyword">return</span> it;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                iterator &amp; <span class="keyword">operator</span>+=(<span class="type">int</span> i)</span><br><span class="line">                &#123;</span><br><span class="line">                    m_pointer += i;</span><br><span class="line">                    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 前缀--</span></span><br><span class="line">                iterator &amp; <span class="keyword">operator</span>--()</span><br><span class="line">                &#123;</span><br><span class="line">                    m_pointer -= <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 后缀--</span></span><br><span class="line">                iterator <span class="keyword">operator</span>--(<span class="type">int</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    iterator it = *<span class="keyword">this</span>;</span><br><span class="line">                    --(*<span class="keyword">this</span>);</span><br><span class="line">                    <span class="keyword">return</span> it;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                iterator <span class="keyword">operator</span>-(<span class="type">int</span> i)</span><br><span class="line">                &#123;</span><br><span class="line">                    iterator it = *<span class="keyword">this</span>;</span><br><span class="line">                    it.m_pointer -= i;</span><br><span class="line">                    <span class="keyword">return</span> it;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                iterator &amp; <span class="keyword">operator</span>-=(<span class="type">int</span> i)</span><br><span class="line">                &#123;</span><br><span class="line">                    m_pointer -= i;</span><br><span class="line">                    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">int</span> <span class="keyword">operator</span>-(<span class="type">const</span> iterator &amp; other) <span class="type">const</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> m_pointer - other.m_pointer;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 迭代器解引用</span></span><br><span class="line">                T &amp; <span class="keyword">operator</span>*()</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> *m_pointer;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                T * <span class="keyword">operator</span>-&gt;()</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> m_pointer;</span><br><span class="line">                &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">private</span>:</span><br><span class="line">                T * m_pointer;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Vector的反向迭代器</span></span><br><span class="line">            <span class="keyword">class</span> <span class="title class_">reverse_iterator</span></span><br><span class="line">            &#123;</span><br><span class="line">            <span class="keyword">public</span>:</span><br><span class="line">                <span class="built_in">reverse_iterator</span>() : <span class="built_in">m_pointer</span>(<span class="literal">nullptr</span>) &#123;&#125;</span><br><span class="line">                <span class="built_in">reverse_iterator</span>(T * pointer) : <span class="built_in">m_pointer</span>(pointer) &#123;&#125;</span><br><span class="line">                ~<span class="built_in">reverse_iterator</span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">bool</span> <span class="keyword">operator</span>==(<span class="type">const</span> reverse_iterator &amp; other)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> m_pointer == other.m_pointer;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">bool</span> <span class="keyword">operator</span>!=(<span class="type">const</span> reverse_iterator &amp; other)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> m_pointer != other.m_pointer;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                reverse_iterator &amp; <span class="keyword">operator</span>=(<span class="type">const</span> reverse_iterator &amp; other)</span><br><span class="line">                &#123;</span><br><span class="line">                    m_pointer = other.m_pointer;</span><br><span class="line">                    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 前缀++</span></span><br><span class="line">                reverse_iterator &amp; <span class="keyword">operator</span>++()</span><br><span class="line">                &#123;</span><br><span class="line">                    m_pointer--;</span><br><span class="line">                    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 后缀++</span></span><br><span class="line">                reverse_iterator <span class="keyword">operator</span>++(<span class="type">int</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    reverse_iterator it = *<span class="keyword">this</span>;</span><br><span class="line">                    ++(*<span class="keyword">this</span>);</span><br><span class="line">                    <span class="keyword">return</span> it;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                reverse_iterator <span class="keyword">operator</span>+(<span class="type">int</span> i)</span><br><span class="line">                &#123;</span><br><span class="line">                    reverse_iterator it = *<span class="keyword">this</span>;</span><br><span class="line">                    it.m_pointer -= i;</span><br><span class="line">                    <span class="keyword">return</span> it;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                reverse_iterator &amp; <span class="keyword">operator</span>+=(<span class="type">int</span> i)</span><br><span class="line">                &#123;</span><br><span class="line">                    m_pointer -= i;</span><br><span class="line">                    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 前缀--</span></span><br><span class="line">                reverse_iterator &amp; <span class="keyword">operator</span>--()</span><br><span class="line">                &#123;</span><br><span class="line">                    m_pointer++;</span><br><span class="line">                    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 后缀--</span></span><br><span class="line">                reverse_iterator <span class="keyword">operator</span>--(<span class="type">int</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    reverse_iterator it = *<span class="keyword">this</span>;</span><br><span class="line">                    --(*<span class="keyword">this</span>);</span><br><span class="line">                    <span class="keyword">return</span> it;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                reverse_iterator <span class="keyword">operator</span>-(<span class="type">int</span> i)</span><br><span class="line">                &#123;</span><br><span class="line">                    reverse_iterator it = *<span class="keyword">this</span>;</span><br><span class="line">                    it.m_pointer += i;</span><br><span class="line">                    <span class="keyword">return</span> it;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                reverse_iterator &amp; <span class="keyword">operator</span>-=(<span class="type">int</span> i)</span><br><span class="line">                &#123;</span><br><span class="line">                    m_pointer += i;</span><br><span class="line">                    <span class="keyword">return</span> *<span class="keyword">this</span>;   </span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                T &amp; <span class="keyword">operator</span>*()</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> *m_pointer;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                T * <span class="keyword">operator</span>-&gt;()</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> m_pointer;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">private</span>:</span><br><span class="line">                T * m_pointer;</span><br><span class="line">            &#125;;</span><br><span class="line">        </span><br><span class="line">            <span class="function">iterator <span class="title">begin</span><span class="params">()</span> <span class="keyword">noexcept</span></span>;</span><br><span class="line">            <span class="function">iterator <span class="title">end</span><span class="params">()</span> <span class="keyword">noexcept</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="function">reverse_iterator <span class="title">rbegin</span><span class="params">()</span> <span class="keyword">noexcept</span></span>;</span><br><span class="line">            <span class="function">reverse_iterator <span class="title">rend</span><span class="params">()</span> <span class="keyword">noexcept</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="function">iterator <span class="title">insert</span><span class="params">(iterator position, <span class="type">const</span> T &amp; value)</span></span>;</span><br><span class="line">            <span class="function">iterator <span class="title">insert</span><span class="params">(iterator position, <span class="type">int</span> n, <span class="type">const</span> T &amp; value)</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="function">iterator <span class="title">erase</span><span class="params">(iterator pos)</span></span>;</span><br><span class="line">            <span class="function">iterator <span class="title">erase</span><span class="params">(iterator first, iterator last)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">is_basic_type</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            T * m_data;             <span class="comment">// 数组用指针来表示</span></span><br><span class="line">            <span class="type">int</span> m_size;             <span class="comment">// Vector中实际存储元素的个数</span></span><br><span class="line">            <span class="type">int</span> m_capacity;         <span class="comment">// Vector的最大容量</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        Vector&lt;T&gt;::<span class="built_in">Vector</span>() : <span class="built_in">m_data</span>(<span class="literal">nullptr</span>), <span class="built_in">m_size</span>(<span class="number">0</span>), <span class="built_in">m_capacity</span>(<span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        zh::stl::Vector&lt;T&gt;::~<span class="built_in">Vector</span>()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (m_data != <span class="literal">nullptr</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">delete</span>[] m_data;</span><br><span class="line">                m_data = <span class="literal">nullptr</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            m_size = <span class="number">0</span>;</span><br><span class="line">            m_capacity = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="type">void</span> zh::stl::Vector&lt;T&gt;::<span class="built_in">push_back</span>(<span class="type">const</span> T &amp; value)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (m_size &lt; m_capacity)</span><br><span class="line">            &#123;</span><br><span class="line">                m_data[m_size] = value;</span><br><span class="line">                m_size++;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Vector扩容机制</span></span><br><span class="line">            <span class="keyword">if</span> (m_capacity == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                m_capacity = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                m_capacity *= <span class="number">2</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            T * data = <span class="keyword">new</span> T[m_capacity];</span><br><span class="line">            <span class="comment">// 如果数据是基本类型，直接调用memcpy()进行整段内存复制</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">is_basic_type</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                std::<span class="built_in">memcpy</span>(data, m_data, m_size * <span class="built_in">sizeof</span>(T));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; m_size; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    data[i] = m_data[i];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (m_data != <span class="literal">nullptr</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">delete</span> [] m_data;</span><br><span class="line">                m_data = <span class="literal">nullptr</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            m_data = data;</span><br><span class="line">            m_data[m_size] = value;</span><br><span class="line">            m_size++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="type">void</span> Vector&lt;T&gt;::<span class="built_in">show</span>() <span class="type">const</span></span><br><span class="line">        &#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;size = &quot;</span> &lt;&lt; m_size &lt;&lt; <span class="string">&quot;, capacity = &quot;</span> &lt;&lt; m_capacity &lt;&lt; std::endl;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; m_size; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                std::cout &lt;&lt; m_data[i] &lt;&lt; <span class="string">&quot;, &quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            std::cout &lt;&lt; std::endl;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="type">void</span> Vector&lt;T&gt;::<span class="built_in">pop_back</span>()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (m_size &gt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                m_size--;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        T &amp; Vector&lt;T&gt;::<span class="built_in">at</span>(<span class="type">int</span> index)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (index &lt; <span class="number">0</span> || index &gt;= m_size)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;out og range&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> m_data[index];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="type">const</span> T &amp; Vector&lt;T&gt;::<span class="built_in">at</span>(<span class="type">int</span> index) <span class="type">const</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">at</span>(index);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        T &amp; Vector&lt;T&gt;::<span class="built_in">front</span>()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (m_size &lt;= <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;vector is empty&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> m_data[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="type">const</span> T &amp; Vector&lt;T&gt;::<span class="built_in">front</span>() <span class="type">const</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">front</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        T &amp; Vector&lt;T&gt;::<span class="built_in">back</span>()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (m_size &lt;= <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;vector is empty&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> m_data[m_size - <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="type">const</span> T &amp; Vector&lt;T&gt;::<span class="built_in">back</span>() <span class="type">const</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">back</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="type">bool</span> Vector&lt;T&gt;::<span class="built_in">empty</span>() <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> m_size == <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="type">void</span> Vector&lt;T&gt;::<span class="built_in">clear</span>() <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">        &#123;</span><br><span class="line">            m_size = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="type">int</span> Vector&lt;T&gt;::<span class="built_in">size</span>() <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> m_size;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="type">int</span> Vector&lt;T&gt;::<span class="built_in">capacity</span>() <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> m_capacity;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        T * Vector&lt;T&gt;::<span class="built_in">data</span>() <span class="keyword">noexcept</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> m_data;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="type">const</span> T * Vector&lt;T&gt;::<span class="built_in">data</span>() <span class="type">const</span> <span class="keyword">noexcept</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">data</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        T &amp; Vector&lt;T&gt;::<span class="keyword">operator</span>[](<span class="type">int</span> index)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">at</span>(index);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="type">const</span> T &amp; Vector&lt;T&gt;::<span class="keyword">operator</span>[](<span class="type">int</span> index) <span class="type">const</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">at</span>(index);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        Vector&lt;T&gt; &amp; Vector&lt;T&gt;::<span class="keyword">operator</span>=(<span class="type">const</span> Vector&lt;T&gt; &amp; other)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (m_capacity &lt; other.m_size)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (m_data != <span class="literal">nullptr</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">delete</span>[] m_data;</span><br><span class="line">                    m_data = <span class="literal">nullptr</span>;</span><br><span class="line">                    m_size = <span class="number">0</span>;</span><br><span class="line">                    m_capacity = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">while</span> (m_capacity &lt; other.m_size)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (m_capacity == <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        m_capacity = <span class="number">1</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        m_capacity *= <span class="number">2</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                m_data = <span class="keyword">new</span> T[m_capacity];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; other.m_size; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                m_data[i] = other.m_data[i];</span><br><span class="line">            &#125;</span><br><span class="line">            m_size = other.m_size;</span><br><span class="line">            <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="type">void</span> Vector&lt;T&gt;::<span class="built_in">swap</span>(Vector&lt;T&gt; &amp; other)</span><br><span class="line">        &#123;</span><br><span class="line">            T * data = other.m_data;</span><br><span class="line">            <span class="type">int</span> size = other.m_size;</span><br><span class="line">            <span class="type">int</span> capacity = other.capacity;</span><br><span class="line">            other.m_data = m_data;</span><br><span class="line">            other.m_size = m_size;</span><br><span class="line">            other.m_capacity = capacity;</span><br><span class="line">            m_data = data;</span><br><span class="line">            m_size = size;</span><br><span class="line">            m_capacity = capacity;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="keyword">typename</span> Vector&lt;T&gt;::iterator Vector&lt;T&gt;::<span class="built_in">begin</span>() <span class="keyword">noexcept</span></span><br><span class="line">        &#123;</span><br><span class="line">            Vector&lt;T&gt;::<span class="function">iterator <span class="title">it</span><span class="params">(m_data)</span></span>;</span><br><span class="line">            <span class="keyword">return</span> it;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="keyword">typename</span> Vector&lt;T&gt;::iterator Vector&lt;T&gt;::<span class="built_in">end</span>() <span class="keyword">noexcept</span></span><br><span class="line">        &#123;</span><br><span class="line">            Vector&lt;T&gt;::<span class="function">iterator <span class="title">it</span><span class="params">(m_data + m_size)</span></span>;</span><br><span class="line">            <span class="keyword">return</span> it;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="keyword">typename</span> Vector&lt;T&gt;::reverse_iterator Vector&lt;T&gt;::<span class="built_in">rbegin</span>() <span class="keyword">noexcept</span></span><br><span class="line">        &#123;</span><br><span class="line">            Vector&lt;T&gt;::<span class="function">reverse_iterator <span class="title">it</span><span class="params">(m_data + m_size - <span class="number">1</span>)</span></span>;</span><br><span class="line">            <span class="keyword">return</span> it;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="keyword">typename</span> Vector&lt;T&gt;::reverse_iterator Vector&lt;T&gt;::<span class="built_in">rend</span>() <span class="keyword">noexcept</span></span><br><span class="line">        &#123;</span><br><span class="line">            Vector&lt;T&gt;::<span class="function">reverse_iterator <span class="title">it</span><span class="params">(m_data - <span class="number">1</span>)</span></span>;</span><br><span class="line">            <span class="keyword">return</span> it;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="keyword">typename</span> Vector&lt;T&gt;::iterator Vector&lt;T&gt;::<span class="built_in">insert</span>(iterator position, <span class="type">const</span> T &amp; value)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">insert</span>(position, <span class="number">1</span>, value);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="keyword">typename</span> Vector&lt;T&gt;::iterator Vector&lt;T&gt;::<span class="built_in">insert</span>(iterator position, <span class="type">int</span> n, <span class="type">const</span> T &amp; value)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">int</span> size = position - <span class="built_in">begin</span>();</span><br><span class="line">            <span class="comment">// 容量足够</span></span><br><span class="line">            <span class="keyword">if</span> (m_size + n &lt;= m_capacity)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 先把后面的元素向后挪，避免覆盖</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> i = m_size; i &gt; size; i--)</span><br><span class="line">                &#123;</span><br><span class="line">                    m_data[i + n - <span class="number">1</span>] = m_data[i - <span class="number">1</span>];</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    m_data[size + i] = value;</span><br><span class="line">                &#125;</span><br><span class="line">                m_size += n;</span><br><span class="line">                <span class="keyword">return</span> Vector&lt;T&gt;::<span class="built_in">iterator</span>(m_data + size);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 容量不足，需要先扩容</span></span><br><span class="line">            <span class="keyword">while</span> (m_size + n &gt; m_capacity)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (m_capacity == <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    m_capacity = <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    m_capacity *= <span class="number">2</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            T * data = <span class="keyword">new</span> T[m_capacity];</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; size; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                data[i] = m_data[i];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                data[size + i] = value;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = size; i &lt; m_size; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                data[n + i] = m_data[i];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (m_data != <span class="literal">nullptr</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">delete</span>[] m_data;</span><br><span class="line">                m_data = <span class="literal">nullptr</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            m_data = data;</span><br><span class="line">            m_size += n;</span><br><span class="line">            <span class="keyword">return</span> Vector&lt;T&gt;::<span class="built_in">iterator</span>(m_data + size);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="keyword">typename</span> Vector&lt;T&gt;::iterator Vector&lt;T&gt;::<span class="built_in">erase</span>(iterator pos)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (pos == <span class="built_in">end</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;out of range&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">end</span>() - pos == <span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 删除最后一个元素</span></span><br><span class="line">                m_size -= <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">end</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">int</span> size = pos - <span class="built_in">begin</span>();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = size; i &lt; m_size - <span class="number">1</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                m_data[i] = m_data[i + <span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            m_size -= <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">return</span> pos;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="keyword">typename</span> Vector&lt;T&gt;::iterator Vector&lt;T&gt;::<span class="built_in">erase</span>(iterator first, iterator last)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">int</span> f = first - <span class="built_in">begin</span>();</span><br><span class="line">            <span class="type">int</span> l = last - <span class="built_in">begin</span>();</span><br><span class="line">            <span class="type">int</span> n = last - first;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; m_size - l; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                m_data[f + i] = m_data[l + i];</span><br><span class="line">            &#125;</span><br><span class="line">            m_size -= n;</span><br><span class="line">            <span class="keyword">return</span> first;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="type">bool</span> Vector&lt;T&gt;::<span class="built_in">is_basic_type</span>()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//如果模板参数类型是指针，则认定为基本数据类型</span></span><br><span class="line">            <span class="keyword">if</span> (std::is_pointer&lt;T&gt;::value)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 通过typeid判断是否为基本数据类型</span></span><br><span class="line">            <span class="keyword">return</span> (<span class="built_in">typeid</span>(T) == <span class="built_in">typeid</span>(<span class="type">bool</span>)) ||</span><br><span class="line">                   (<span class="built_in">typeid</span>(T) == <span class="built_in">typeid</span>(<span class="type">char</span>)) ||</span><br><span class="line">                   (<span class="built_in">typeid</span>(T) == <span class="built_in">typeid</span>(<span class="type">unsigned</span> <span class="type">char</span>)) ||</span><br><span class="line">                   (<span class="built_in">typeid</span>(T) == <span class="built_in">typeid</span>(<span class="type">short</span>)) ||</span><br><span class="line">                   (<span class="built_in">typeid</span>(T) == <span class="built_in">typeid</span>(<span class="type">unsigned</span> <span class="type">short</span>)) ||</span><br><span class="line">                   (<span class="built_in">typeid</span>(T) == <span class="built_in">typeid</span>(<span class="type">int</span>)) ||</span><br><span class="line">                   (<span class="built_in">typeid</span>(T) == <span class="built_in">typeid</span>(<span class="type">unsigned</span> <span class="type">int</span>)) ||</span><br><span class="line">                   (<span class="built_in">typeid</span>(T) == <span class="built_in">typeid</span>(<span class="type">long</span>)) ||</span><br><span class="line">                   (<span class="built_in">typeid</span>(T) == <span class="built_in">typeid</span>(<span class="type">unsigned</span> <span class="type">long</span>)) ||</span><br><span class="line">                   (<span class="built_in">typeid</span>(T) == <span class="built_in">typeid</span>(<span class="type">float</span>)) ||</span><br><span class="line">                   (<span class="built_in">typeid</span>(T) == <span class="built_in">typeid</span>(<span class="type">double</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> C++后端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>json解析器</title>
      <link href="/2024/05/09/json%E8%A7%A3%E6%9E%90%E5%99%A8/"/>
      <url>/2024/05/09/json%E8%A7%A3%E6%9E%90%E5%99%A8/</url>
      
        <content type="html"><![CDATA[<h1 id="json简介">JSON简介</h1><h2 id="json定义">JSON定义</h2><p>JSON的全称是&quot;JavaScript Object Notation&quot;，意思是JavaScript对象表示法，它是一种基于文本，独<br>立于语言的轻量级数据交换格式。</p><h2 id="json元素">JSON元素</h2><p><img src="https://aliyun-oss-zh.oss-cn-beijing.aliyuncs.com/img/QQ20250623-185615.jpg" alt=""></p><h2 id="json规则">JSON规则</h2><ul><li>空值：<code>null</code></li><li>布尔：<code>true</code>、<code>false</code></li><li>数字：<code>123</code>，<code>1.23</code></li><li>字符串：由双引号包裹</li><li>数组(Array)：用方括号<code>[]</code>表示，里面可以包含空值、布尔、数字、字符串、数组、对象</li><li>对象(Object)：用大括号<code>&#123;&#125;</code>表示，里面由键值对组成，键是字符串，值可以是空值、数字、布尔、字符串、数组、对象</li><li>并列的数据之间用逗号<code>,</code>进行分隔</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jack&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">18</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;work&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;c++&quot;</span><span class="punctuation">,</span> <span class="string">&quot;php&quot;</span><span class="punctuation">,</span> <span class="string">&quot;python&quot;</span><span class="punctuation">,</span> <span class="string">&quot;go&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="json官网">JSON官网</h2><p><a href="https://www.json.org/json-zh.html">https://www.json.org/json-zh.html</a></p><h1 id="json解析器设计与实现">JSON解析器设计与实现</h1><p>特点：</p><ul><li>独立：不依赖第三方库</li><li>跨平台：支持Linux、Windows、MacOS</li><li>简单好用：友好的API，核心的Parse仅200多行代码</li><li>高性能：性能比jsoncpp、nlohmann等高很多</li></ul><h2 id="api设计">API设计</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// json/json.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdexcept&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> std::string;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> json</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Json</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="comment">// 使用枚举类型来表示不同类型的JSON元素</span></span><br><span class="line">            <span class="keyword">enum</span> <span class="title class_">Type</span></span><br><span class="line">            &#123;</span><br><span class="line">                JSON_NULL = <span class="number">0</span>,</span><br><span class="line">                JSON_BOOL,</span><br><span class="line">                JSON_INT,</span><br><span class="line">                JSON_DOUBLE,</span><br><span class="line">                JSON_STRING,</span><br><span class="line">                JSON_ARRAY,</span><br><span class="line">                JSON_OBJECT</span><br><span class="line">            &#125;;</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">Json</span>();</span><br><span class="line">            <span class="built_in">Json</span>(Type type);</span><br><span class="line">            <span class="built_in">Json</span>(<span class="type">bool</span> value);</span><br><span class="line">            <span class="built_in">Json</span>(<span class="type">int</span> value);</span><br><span class="line">            <span class="built_in">Json</span>(<span class="type">double</span> value);</span><br><span class="line">            <span class="built_in">Json</span>(<span class="type">const</span> <span class="type">char</span> * value);</span><br><span class="line">            <span class="built_in">Json</span>(<span class="type">const</span> string &amp; value);</span><br><span class="line">            <span class="built_in">Json</span>(<span class="type">const</span> Json &amp; other);</span><br><span class="line">            <span class="built_in">Json</span>(Json &amp;&amp; other);</span><br><span class="line">            ~<span class="built_in">Json</span>();</span><br><span class="line"></span><br><span class="line">            <span class="function">Type <span class="title">type</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">is_null</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">is_bool</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">is_int</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">is_double</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">is_string</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">is_array</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">is_object</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 重载类型转换运算符，类型转换运算符必须是类的成员函数，它不能声明返回类型，形参列表必须为空切通常应该是const</span></span><br><span class="line">            <span class="function"><span class="keyword">operator</span> <span class="title">bool</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="function"><span class="keyword">operator</span> <span class="title">int</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="function"><span class="keyword">operator</span> <span class="title">double</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="function"><span class="keyword">operator</span> <span class="title">string</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">as_bool</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">as_int</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="function"><span class="type">double</span> <span class="title">as_double</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="function">string <span class="title">as_string</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 拷贝赋值运算符首先需要清理释放资源，避免内存泄露</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">clear</span><span class="params">()</span></span>;</span><br><span class="line">            Json &amp; <span class="keyword">operator</span>=(<span class="type">bool</span> value);</span><br><span class="line">            Json &amp; <span class="keyword">operator</span>=(<span class="type">int</span> value);</span><br><span class="line">            Json &amp; <span class="keyword">operator</span>=(<span class="type">double</span> value);</span><br><span class="line">            Json &amp; <span class="keyword">operator</span>=(<span class="type">const</span> <span class="type">char</span> * value);</span><br><span class="line">            Json &amp; <span class="keyword">operator</span>=(<span class="type">const</span> string &amp; value);</span><br><span class="line">            Json &amp; <span class="keyword">operator</span>=(<span class="type">const</span> Json &amp; other);</span><br><span class="line">            Json &amp; <span class="keyword">operator</span>=(Json &amp;&amp; other) <span class="keyword">noexcept</span>;</span><br><span class="line"></span><br><span class="line">            <span class="function">string <span class="title">str</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="comment">// 重载输出运算符，IO运算符必须定义为非成员函数且一般被声明为友元</span></span><br><span class="line">            <span class="keyword">friend</span> std::ostream&amp; <span class="keyword">operator</span>&lt;&lt;(std::ostream &amp; os, <span class="type">const</span> Json &amp; json)</span><br><span class="line">            &#123;</span><br><span class="line">                os &lt;&lt; json.<span class="built_in">str</span>();</span><br><span class="line">                <span class="keyword">return</span> os;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">append</span><span class="params">(<span class="type">const</span> Json &amp; value)</span></span>;                <span class="comment">// 向json数组中添加元素</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">append</span><span class="params">(Json &amp;&amp; value)</span></span>;                     <span class="comment">// 向json数组中添加元素，避免深拷贝</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">has</span><span class="params">(<span class="type">int</span> index)</span></span>;                            <span class="comment">// 判断json数组中是否有该下标</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">has</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * key)</span> <span class="type">const</span></span>;               <span class="comment">// 判断json数组中是否有某个键</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">has</span><span class="params">(<span class="type">const</span> string &amp; key)</span> <span class="type">const</span></span>;             <span class="comment">// 判断json数组中是否有某个键</span></span><br><span class="line">            <span class="function">Json <span class="title">get</span><span class="params">(<span class="type">int</span> index)</span></span>;                            <span class="comment">// 根据下标获取json数组中的元素</span></span><br><span class="line">            <span class="function">Json <span class="title">get</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * key)</span></span>;                     <span class="comment">// 根据键获取对应的json对象</span></span><br><span class="line">            <span class="function">Json <span class="title">get</span><span class="params">(<span class="type">const</span> string &amp; key)</span></span>;                   <span class="comment">// 根据键获取对应的json对象</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">remove</span><span class="params">(<span class="type">int</span> index)</span></span>;                         <span class="comment">// 根据下标删除json数组中的元素</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">remove</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * key)</span></span>;                  <span class="comment">// 根据键删除对应的json对象</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">remove</span><span class="params">(<span class="type">const</span> string &amp; key)</span></span>;                <span class="comment">// 根据键删除对应的json对象</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 重载下标运算符</span></span><br><span class="line">            Json &amp; <span class="keyword">operator</span>[](<span class="type">int</span> index);                   <span class="comment">// 根据下标获取json数组中的元素</span></span><br><span class="line">            Json &amp; <span class="keyword">operator</span>[](<span class="type">const</span> <span class="type">char</span> * key);            <span class="comment">// 根据键获取json对象</span></span><br><span class="line">            Json &amp; <span class="keyword">operator</span>[](<span class="type">const</span> string &amp; key);          <span class="comment">// 根据键获取json对象</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 遍历数组</span></span><br><span class="line">            <span class="keyword">using</span> iterator = std::vector&lt;Json&gt;::iterator;</span><br><span class="line">            <span class="function">iterator <span class="title">begin</span><span class="params">()</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> (m_value.m_array)-&gt;<span class="built_in">begin</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="function">iterator <span class="title">end</span><span class="params">()</span></span></span><br><span class="line"><span class="function">            </span>&#123;   </span><br><span class="line">                <span class="keyword">return</span> (m_value.m_array)-&gt;<span class="built_in">end</span>();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// json对象和json数组均有的操作</span></span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">size</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">empty</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">parse</span><span class="params">(<span class="type">const</span> string &amp; filename)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">parse</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * buf, <span class="type">int</span> len)</span></span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="comment">// 深拷贝</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">copy</span><span class="params">(<span class="type">const</span> Json &amp; other)</span></span>;</span><br><span class="line">            <span class="comment">// 浅拷贝，仅用于移动语义提升性能</span></span><br><span class="line">            <span class="comment">// swap仅交换内容，不拷贝内容</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">swap</span><span class="params">(Json &amp; other)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="keyword">union</span> <span class="title class_">Value</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="type">bool</span> m_bool;</span><br><span class="line">                <span class="type">int</span> m_int;</span><br><span class="line">                <span class="type">double</span> m_double;</span><br><span class="line">                string * m_string;</span><br><span class="line">                std::vector&lt;Json&gt; * m_array;</span><br><span class="line">                std::map&lt;string, Json&gt; * m_object;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            Type m_type;                <span class="comment">// json实际存储的类型</span></span><br><span class="line">            Value m_value;              <span class="comment">// json实际存储的值</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// json/json.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;json/json.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;json/parser.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::json;</span><br><span class="line"></span><br><span class="line">Json::<span class="built_in">Json</span>() : <span class="built_in">m_type</span>(JSON_NULL)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Json::<span class="built_in">Json</span>(Type type) : <span class="built_in">m_type</span>(type)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">switch</span> (m_type)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> JSON_NULL:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> JSON_BOOL:</span><br><span class="line">            m_value.m_bool = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> JSON_INT:</span><br><span class="line">            m_value.m_int = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> JSON_DOUBLE:</span><br><span class="line">            m_value.m_double = <span class="number">0.0</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> JSON_STRING:</span><br><span class="line">            m_value.m_string = <span class="keyword">new</span> <span class="built_in">string</span>();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> JSON_ARRAY:</span><br><span class="line">            m_value.m_array = <span class="keyword">new</span> std::<span class="built_in">vector</span>&lt;Json&gt;();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> JSON_OBJECT:</span><br><span class="line">            m_value.m_object = <span class="keyword">new</span> std::<span class="built_in">map</span>&lt;string, Json&gt;();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Json::<span class="built_in">Json</span>(<span class="type">bool</span> value) : <span class="built_in">m_type</span>(JSON_BOOL)</span><br><span class="line">&#123;</span><br><span class="line">    m_value.m_bool = value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Json::<span class="built_in">Json</span>(<span class="type">int</span> value) : <span class="built_in">m_type</span>(JSON_INT)</span><br><span class="line">&#123;</span><br><span class="line">    m_value.m_int = value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Json::<span class="built_in">Json</span>(<span class="type">double</span> value) : <span class="built_in">m_type</span>(JSON_DOUBLE)</span><br><span class="line">&#123;</span><br><span class="line">    m_value.m_double = value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Json::<span class="built_in">Json</span>(<span class="type">const</span> <span class="type">char</span> * value) : <span class="built_in">m_type</span>(JSON_STRING)</span><br><span class="line">&#123;</span><br><span class="line">    m_value.m_string = <span class="keyword">new</span> <span class="built_in">string</span>(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Json::<span class="built_in">Json</span>(<span class="type">const</span> string &amp; value) : <span class="built_in">m_type</span>(JSON_STRING)</span><br><span class="line">&#123;</span><br><span class="line">    m_value.m_string = <span class="keyword">new</span> <span class="built_in">string</span>(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Json::<span class="built_in">Json</span>(<span class="type">const</span> Json &amp; other) : <span class="built_in">m_type</span>(JSON_NULL)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">copy</span>(other);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Json::<span class="built_in">Json</span>(Json &amp;&amp; other)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">swap</span>(other);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Json::~<span class="built_in">Json</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// TODO</span></span><br><span class="line">    <span class="comment">// clear();</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">string <span class="title">Json::str</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::stringstream ss;</span><br><span class="line">    <span class="keyword">switch</span> (m_type)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> JSON_NULL:</span><br><span class="line">            ss &lt;&lt; <span class="string">&quot;null&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> JSON_BOOL:</span><br><span class="line">            ss &lt;&lt; (m_value.m_bool ? <span class="string">&quot;true&quot;</span> : <span class="string">&quot;false&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> JSON_INT:</span><br><span class="line">            ss &lt;&lt; m_value.m_int;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> JSON_DOUBLE:</span><br><span class="line">            ss &lt;&lt; m_value.m_double;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> JSON_STRING:</span><br><span class="line">            ss &lt;&lt; <span class="string">&quot;\&quot;&quot;</span> &lt;&lt; *(m_value.m_string) &lt;&lt; <span class="string">&quot;\&quot;&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> JSON_ARRAY:</span><br><span class="line">            ss &lt;&lt; <span class="string">&quot;[&quot;</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">auto</span> it = (m_value.m_array)-&gt;<span class="built_in">begin</span>(); it != (m_value.m_array)-&gt;<span class="built_in">end</span>(); ++it)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (it != (m_value.m_array)-&gt;<span class="built_in">begin</span>())</span><br><span class="line">                &#123;</span><br><span class="line">                    ss &lt;&lt; <span class="string">&quot;,&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                ss &lt;&lt; (*it).<span class="built_in">str</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            ss &lt;&lt; <span class="string">&quot;]&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> JSON_OBJECT:</span><br><span class="line">            ss &lt;&lt; <span class="string">&quot;&#123;&quot;</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">auto</span> it = (m_value.m_object)-&gt;<span class="built_in">begin</span>(); it != (m_value.m_object)-&gt;<span class="built_in">end</span>(); ++it)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (it != (m_value.m_object)-&gt;<span class="built_in">begin</span>())</span><br><span class="line">                &#123;</span><br><span class="line">                    ss &lt;&lt; <span class="string">&quot;,&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                ss &lt;&lt; <span class="string">&quot;\&quot;&quot;</span> &lt;&lt; it-&gt;first &lt;&lt; <span class="string">&quot;\&quot;:&quot;</span> &lt;&lt; it-&gt;second.<span class="built_in">str</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            ss &lt;&lt; <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ss.<span class="built_in">str</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Json::Type <span class="title">Json::type</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_type;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Json::is_null</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_type == JSON_NULL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Json::is_bool</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_type == JSON_BOOL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Json::is_int</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_type == JSON_INT;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Json::is_double</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_type == JSON_DOUBLE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Json::is_string</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_type == JSON_STRING;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Json::is_array</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_type == JSON_ARRAY;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Json::is_object</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_type == JSON_OBJECT;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Json::as_bool</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    <span class="keyword">if</span> (m_type == JSON_BOOL)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> m_value.m_bool;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;type error: not bool type&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Json::as_int</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_type == JSON_INT)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> m_value.m_int;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;type error: not int type&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">double</span> <span class="title">Json::as_double</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_type == JSON_DOUBLE)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> m_value.m_double;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;type error: not double type&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">string <span class="title">Json::as_string</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_type == JSON_STRING)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> *(m_value.m_string);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;type error: not string type&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Json::<span class="keyword">operator</span> <span class="title">bool</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">as_bool</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Json::<span class="keyword">operator</span> <span class="title">int</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">as_int</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Json::<span class="keyword">operator</span> <span class="title">double</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">as_double</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Json::<span class="keyword">operator</span> <span class="title">string</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">as_string</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Json::clear</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (m_type)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> JSON_NULL:</span><br><span class="line">        <span class="keyword">case</span> JSON_BOOL:</span><br><span class="line">        <span class="keyword">case</span> JSON_INT:</span><br><span class="line">        <span class="keyword">case</span> JSON_DOUBLE:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> JSON_STRING:</span><br><span class="line">            <span class="keyword">if</span> (m_value.m_string != <span class="literal">nullptr</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">delete</span> m_value.m_string;</span><br><span class="line">                m_value.m_string = <span class="literal">nullptr</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> JSON_ARRAY:</span><br><span class="line">            <span class="keyword">if</span> (m_value.m_array != <span class="literal">nullptr</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">auto</span> it = (m_value.m_array)-&gt;<span class="built_in">begin</span>(); it != (m_value.m_array)-&gt;<span class="built_in">end</span>(); ++it)</span><br><span class="line">                &#123;</span><br><span class="line">                    it-&gt;<span class="built_in">clear</span>();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">delete</span> m_value.m_array;</span><br><span class="line">                m_value.m_array = <span class="literal">nullptr</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> JSON_OBJECT:</span><br><span class="line">            <span class="keyword">if</span> (m_value.m_object != <span class="literal">nullptr</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">auto</span> it = (m_value.m_object)-&gt;<span class="built_in">begin</span>(); it != (m_value.m_object)-&gt;<span class="built_in">end</span>(); ++it)</span><br><span class="line">                &#123;</span><br><span class="line">                    it-&gt;second.<span class="built_in">clear</span>();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">delete</span> m_value.m_object;</span><br><span class="line">                m_value.m_object = <span class="literal">nullptr</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    m_type = JSON_NULL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Json &amp; Json::<span class="keyword">operator</span>=(<span class="type">bool</span> value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">clear</span>();</span><br><span class="line">    m_type = JSON_BOOL;</span><br><span class="line">    m_value.m_bool = value;</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Json &amp; Json::<span class="keyword">operator</span>=(<span class="type">int</span> value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">clear</span>();</span><br><span class="line">    m_type = JSON_INT;</span><br><span class="line">    m_value.m_int = value;</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Json &amp; Json::<span class="keyword">operator</span>=(<span class="type">double</span> value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">clear</span>();</span><br><span class="line">    m_type = JSON_DOUBLE;</span><br><span class="line">    m_value.m_double = value;</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Json &amp; Json::<span class="keyword">operator</span>=(<span class="type">const</span> <span class="type">char</span> *value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">clear</span>();</span><br><span class="line">    m_type = JSON_STRING;</span><br><span class="line">    m_value.m_string = <span class="keyword">new</span> <span class="built_in">string</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Json &amp; Json::<span class="keyword">operator</span>=(<span class="type">const</span> string &amp;value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">clear</span>();</span><br><span class="line">    m_type = JSON_STRING;</span><br><span class="line">    m_value.m_string = <span class="keyword">new</span> <span class="built_in">string</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Json &amp; Json::<span class="keyword">operator</span>=(<span class="type">const</span> Json &amp; other)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">clear</span>();</span><br><span class="line">    <span class="built_in">copy</span>(other);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Json &amp; Json::<span class="keyword">operator</span>=(Json &amp;&amp; other) <span class="keyword">noexcept</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">swap</span>(other);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Json::append</span><span class="params">(<span class="type">const</span> Json &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_type != JSON_ARRAY)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">clear</span>();</span><br><span class="line">        m_type = JSON_ARRAY;</span><br><span class="line">        m_value.m_array = <span class="keyword">new</span> std::<span class="built_in">vector</span>&lt;Json&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    (m_value.m_array)-&gt;<span class="built_in">push_back</span>(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Json::append</span><span class="params">(Json &amp;&amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_type != JSON_ARRAY)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">clear</span>();</span><br><span class="line">        m_type = JSON_ARRAY;</span><br><span class="line">        m_value.m_array = <span class="keyword">new</span> std::<span class="built_in">vector</span>&lt;Json&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    (m_value.m_array)-&gt;<span class="built_in">push_back</span>(std::<span class="built_in">move</span>(value));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Json::has</span><span class="params">(<span class="type">int</span> index)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_type != JSON_ARRAY)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> size = (<span class="type">int</span>)(m_value.m_array)-&gt;<span class="built_in">size</span>();</span><br><span class="line">    <span class="keyword">return</span> index &gt;= <span class="number">0</span> &amp;&amp; index &lt; size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Json::has</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * key)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_type != JSON_OBJECT)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (m_value.m_object)-&gt;<span class="built_in">find</span>(key) != (m_value.m_object)-&gt;<span class="built_in">end</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Json::has</span><span class="params">(<span class="type">const</span> string &amp; key)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">has</span>(key.<span class="built_in">c_str</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Json <span class="title">Json::get</span><span class="params">(<span class="type">int</span> index)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">has</span>(index))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Json</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (m_value.m_array)-&gt;<span class="built_in">at</span>(index);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Json <span class="title">Json::get</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">has</span>(key))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Json</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (*(m_value.m_object))[key];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Json <span class="title">Json::get</span><span class="params">(<span class="type">const</span> string &amp; key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">get</span>(key.<span class="built_in">c_str</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Json::remove</span><span class="params">(<span class="type">int</span> index)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">has</span>(index))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    (m_value.m_array)-&gt;<span class="built_in">at</span>(index).<span class="built_in">clear</span>();</span><br><span class="line">    (m_value.m_array)-&gt;<span class="built_in">erase</span>((m_value.m_array)-&gt;<span class="built_in">begin</span>() + index);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Json::remove</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_type != JSON_OBJECT)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">auto</span> it = (m_value.m_object)-&gt;<span class="built_in">find</span>(key);</span><br><span class="line">    <span class="keyword">if</span> (it == (m_value.m_object)-&gt;<span class="built_in">end</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    it-&gt;second.<span class="built_in">clear</span>();</span><br><span class="line">    (m_value.m_object)-&gt;<span class="built_in">erase</span>(key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Json::remove</span><span class="params">(<span class="type">const</span> string &amp; key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">remove</span>(key.<span class="built_in">c_str</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Json &amp; Json::<span class="keyword">operator</span>[](<span class="type">int</span> index)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_type != JSON_ARRAY)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;type error: not array&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">has</span>(index))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;array out of range&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (m_value.m_array)-&gt;<span class="built_in">at</span>(index);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Json &amp; Json::<span class="keyword">operator</span>[](<span class="type">const</span> <span class="type">char</span> * key)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_type != JSON_OBJECT)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">clear</span>();</span><br><span class="line">        m_type = JSON_OBJECT;</span><br><span class="line">        m_value.m_object = <span class="keyword">new</span> std::<span class="built_in">map</span>&lt;string, Json&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (*(m_value.m_object))[key];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Json &amp; Json::<span class="keyword">operator</span>[](<span class="type">const</span> string &amp; key)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> (*<span class="keyword">this</span>)[key.<span class="built_in">c_str</span>()];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Json::size</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (m_type)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> JSON_ARRAY:</span><br><span class="line">            <span class="keyword">return</span> (m_value.m_array)-&gt;<span class="built_in">size</span>();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> JSON_OBJECT:</span><br><span class="line">            <span class="keyword">return</span> (m_value.m_object)-&gt;<span class="built_in">size</span>();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Json::empty</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (m_type)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> JSON_NULL:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> JSON_ARRAY:</span><br><span class="line">            <span class="keyword">return</span> (m_value.m_array)-&gt;<span class="built_in">empty</span>();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> JSON_OBJECT:</span><br><span class="line">            <span class="keyword">return</span> (m_value.m_object)-&gt;<span class="built_in">empty</span>();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Json::copy</span><span class="params">(<span class="type">const</span> Json &amp; other)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">clear</span>();</span><br><span class="line">    m_type = other.m_type;</span><br><span class="line">    <span class="keyword">switch</span> (m_type)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> JSON_NULL:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> JSON_BOOL:</span><br><span class="line">        <span class="keyword">case</span> JSON_INT:</span><br><span class="line">        <span class="keyword">case</span> JSON_DOUBLE:</span><br><span class="line">            m_value = other.m_value;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> JSON_STRING:</span><br><span class="line">            <span class="keyword">if</span> (other.m_value.m_string != <span class="literal">nullptr</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                m_value.m_string = <span class="keyword">new</span> <span class="built_in">string</span>(*(other.m_value.m_string));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> JSON_ARRAY:</span><br><span class="line">            <span class="keyword">if</span> (other.m_value.m_array != <span class="literal">nullptr</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                m_value.m_array = <span class="keyword">new</span> std::<span class="built_in">vector</span>&lt;Json&gt;();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">auto</span> it = (other.m_value.m_array)-&gt;<span class="built_in">begin</span>(); it != (other.m_value.m_array)-&gt;<span class="built_in">end</span>(); ++it)</span><br><span class="line">                &#123;</span><br><span class="line">                    (m_value.m_array)-&gt;<span class="built_in">push_back</span>(*it);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> JSON_OBJECT:</span><br><span class="line">            <span class="keyword">if</span> (other.m_value.m_object != <span class="literal">nullptr</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                m_value.m_object = <span class="keyword">new</span> std::<span class="built_in">map</span>&lt;string, Json&gt;();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">auto</span> it = (other.m_value.m_object)-&gt;<span class="built_in">begin</span>(); it != (other.m_value.m_object)-&gt;<span class="built_in">end</span>(); ++it)</span><br><span class="line">                &#123;</span><br><span class="line">                    (*(m_value.m_object))[it-&gt;first] = it-&gt;second;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Json::parse</span><span class="params">(<span class="type">const</span> string &amp; filename)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">clear</span>();</span><br><span class="line">    Parser p;</span><br><span class="line">    p.<span class="built_in">load</span>(filename);</span><br><span class="line">    *<span class="keyword">this</span> = p.<span class="built_in">parse</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Json::parse</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * buf, <span class="type">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">clear</span>();</span><br><span class="line">    Parser p;</span><br><span class="line">    p.<span class="built_in">load</span>(buf, len);</span><br><span class="line">    *<span class="keyword">this</span> = p.<span class="built_in">parse</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// swap仅交换内容，不拷贝内容</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Json::swap</span><span class="params">(Json &amp; other)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Type type = m_type;</span><br><span class="line">    Value value = m_value;</span><br><span class="line">    m_type = other.m_type;</span><br><span class="line">    m_value = other.m_value;</span><br><span class="line">    other.m_type = type;</span><br><span class="line">    other.m_value = value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="parse实现">Parse实现</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// json/parser.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;json/json.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> std::string;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> json</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Parser</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">Parser</span>() = <span class="keyword">default</span>;</span><br><span class="line">            ~<span class="built_in">Parser</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">load</span><span class="params">(<span class="type">const</span> string &amp; filename)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">load</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * buf, <span class="type">int</span> len)</span></span>;</span><br><span class="line">            <span class="function">Json <span class="title">parse</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="comment">// 忽略空白符</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">skip_white_space</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="comment">// 读取下一个字符</span></span><br><span class="line">            <span class="function"><span class="type">char</span> <span class="title">get_next_token</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">in_range</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> lower, <span class="type">int</span> upper)</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="function">Json <span class="title">parse_null</span><span class="params">()</span></span>;                  <span class="comment">// 解析null</span></span><br><span class="line">            <span class="function">Json <span class="title">parse_bool</span><span class="params">()</span></span>;                  <span class="comment">// 解析bool</span></span><br><span class="line">            <span class="function">Json <span class="title">parse_number</span><span class="params">()</span></span>;                <span class="comment">// 解析数字</span></span><br><span class="line">            <span class="function">string <span class="title">parse_string</span><span class="params">()</span></span>;              <span class="comment">// 解析字符串</span></span><br><span class="line">            <span class="function">Json <span class="title">parse_array</span><span class="params">()</span></span>;                 <span class="comment">// 解析数组</span></span><br><span class="line">            <span class="function">Json <span class="title">parse_object</span><span class="params">()</span></span>;                <span class="comment">// 解析对象</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            string m_str;</span><br><span class="line">            <span class="type">size_t</span> m_idx = <span class="number">0</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// json/parser.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;json/parser.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::json;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Parser::load</span><span class="params">(<span class="type">const</span> string &amp; filename)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">std::ifstream <span class="title">ofs</span><span class="params">(filename)</span></span>;</span><br><span class="line">    std::ostringstream oss;</span><br><span class="line">    oss &lt;&lt; ofs.<span class="built_in">rdbuf</span>();</span><br><span class="line">    m_str = oss.<span class="built_in">str</span>();</span><br><span class="line">    m_idx = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Parser::load</span><span class="params">(<span class="type">const</span> <span class="type">char</span> * buf, <span class="type">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_str.<span class="built_in">assign</span>(buf, len);</span><br><span class="line">    m_idx = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Parser::skip_white_space</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (m_str[m_idx] == <span class="string">&#x27; &#x27;</span> || m_str[m_idx] == <span class="string">&#x27;\r&#x27;</span> || m_str[m_idx] == <span class="string">&#x27;\n&#x27;</span> || m_str[m_idx] == <span class="string">&#x27;\t&#x27;</span>)</span><br><span class="line">        m_idx++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">char</span> <span class="title">Parser::get_next_token</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">skip_white_space</span>();</span><br><span class="line">    <span class="keyword">if</span> (m_idx == m_str.<span class="built_in">size</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;unexpected input&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> m_str[m_idx++];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Parser::in_range</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> lower, <span class="type">int</span> upper)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x &gt;= lower &amp;&amp; x &lt;= upper;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Json <span class="title">Parser::parse</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> ch = <span class="built_in">get_next_token</span>();</span><br><span class="line">    <span class="keyword">switch</span> (ch)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;n&#x27;</span>:</span><br><span class="line">            <span class="comment">// null</span></span><br><span class="line">            m_idx--;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">parse_null</span>();</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;t&#x27;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;f&#x27;</span>:</span><br><span class="line">            <span class="comment">// true, false</span></span><br><span class="line">            m_idx--;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">parse_bool</span>();</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;-&#x27;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;0&#x27;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;1&#x27;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;2&#x27;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;3&#x27;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;4&#x27;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;5&#x27;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;6&#x27;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;7&#x27;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;8&#x27;</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;9&#x27;</span>:</span><br><span class="line">            <span class="comment">// 数字</span></span><br><span class="line">            m_idx--;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">parse_number</span>();</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;&quot;&#x27;</span>:</span><br><span class="line">            <span class="comment">// 字符串</span></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">parse_string</span>();</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;[&#x27;</span>:</span><br><span class="line">            <span class="comment">// 数组</span></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">parse_array</span>();</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;&#123;&#x27;</span>:</span><br><span class="line">            <span class="comment">// 对象</span></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">parse_object</span>();</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;unexpected character&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Json <span class="title">Parser::parse_null</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_str.<span class="built_in">compare</span>(m_idx, <span class="number">4</span>, <span class="string">&quot;null&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        m_idx += <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Json</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;parse null error&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Json <span class="title">Parser::parse_bool</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_str.<span class="built_in">compare</span>(m_idx, <span class="number">4</span>, <span class="string">&quot;true&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        m_idx += <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Json</span>(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (m_str.<span class="built_in">compare</span>(m_idx, <span class="number">5</span>, <span class="string">&quot;false&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        m_idx += <span class="number">5</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Json</span>(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;parse bool error&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Json <span class="title">Parser::parse_number</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> pos = m_idx;</span><br><span class="line">    <span class="keyword">if</span> (m_str[m_idx] == <span class="string">&#x27;-&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        m_idx++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (m_str[m_idx] == <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        m_idx++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">in_range</span>(m_str[m_idx], <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;9&#x27;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        m_idx++;</span><br><span class="line">        <span class="keyword">while</span> (<span class="built_in">in_range</span>(m_str[m_idx], <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;9&#x27;</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            m_idx++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;invalid character in number&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果没有小数</span></span><br><span class="line">    <span class="keyword">if</span> (m_str[m_idx] != <span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Json</span>(std::<span class="built_in">atoi</span>(m_str.<span class="built_in">c_str</span>() + pos));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果有小数</span></span><br><span class="line">    m_idx++;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">in_range</span>(m_str[m_idx], <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;9&#x27;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;invalid float number&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">in_range</span>(m_str[m_idx], <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;9&#x27;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        m_idx++;   </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Json</span>(std::<span class="built_in">atof</span>(m_str.<span class="built_in">c_str</span>() + pos));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">string <span class="title">Parser::parse_string</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> pos = m_idx;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> ch = <span class="built_in">get_next_token</span>();</span><br><span class="line">        <span class="keyword">if</span> (ch == <span class="string">&#x27;&quot;&#x27;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果是转义字符</span></span><br><span class="line">        <span class="keyword">if</span> (ch == <span class="string">&#x27;\\&#x27;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            ch = <span class="built_in">get_next_token</span>();</span><br><span class="line">            <span class="keyword">switch</span> (ch)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;b&#x27;</span>:</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;t&#x27;</span>:</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;n&#x27;</span>:</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;f&#x27;</span>:</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;r&#x27;</span>:</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;&quot;&#x27;</span>:</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;\\&#x27;</span>:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;u&#x27;</span>:           <span class="comment">// unicode</span></span><br><span class="line">                    m_idx += <span class="number">4</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> m_str.<span class="built_in">substr</span>(pos, m_idx - pos - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Json <span class="title">Parser::parse_array</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">Json <span class="title">arr</span><span class="params">(Json::JSON_ARRAY)</span></span>;</span><br><span class="line">    <span class="type">char</span> ch = <span class="built_in">get_next_token</span>();</span><br><span class="line">    <span class="keyword">if</span> (ch == <span class="string">&#x27;]&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> arr;</span><br><span class="line">    &#125;</span><br><span class="line">    m_idx--;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        arr.<span class="built_in">append</span>(<span class="built_in">parse</span>());</span><br><span class="line">        ch = <span class="built_in">get_next_token</span>();</span><br><span class="line">        <span class="keyword">if</span> (ch == <span class="string">&#x27;]&#x27;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ch != <span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;expected &#x27;,&#x27; in array&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> arr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Json <span class="title">Parser::parse_object</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">Json <span class="title">obj</span><span class="params">(Json::JSON_OBJECT)</span></span>;</span><br><span class="line">    <span class="type">char</span> ch = <span class="built_in">get_next_token</span>();</span><br><span class="line">    <span class="keyword">if</span> (ch == <span class="string">&#x27;&#125;&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">    m_idx--;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ch = <span class="built_in">get_next_token</span>();</span><br><span class="line">        <span class="keyword">if</span> (ch != <span class="string">&#x27;&quot;&#x27;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;invalid object key&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        string key = <span class="built_in">parse_string</span>();</span><br><span class="line">        ch = <span class="built_in">get_next_token</span>();</span><br><span class="line">        <span class="keyword">if</span> (ch != <span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;expected &#x27;:&#x27; in object&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        obj[key] = <span class="built_in">parse</span>();</span><br><span class="line">        ch = <span class="built_in">get_next_token</span>();</span><br><span class="line">        <span class="keyword">if</span> (ch == <span class="string">&#x27;&#125;&#x27;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ch != <span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;expected &#x27;,&#x27; in object&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> C++后端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>单例模式</title>
      <link href="/2024/05/05/%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/"/>
      <url>/2024/05/05/%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/</url>
      
        <content type="html"><![CDATA[<h1 id="单例模式简介">单例模式简介</h1><p>单例模式，是属于创建类型的一种常用的软件设计模式，通过单例模式的方法创建的类在当前进程中仅有一个实例。</p><h1 id="应用场景">应用场景</h1><p>单例模式可应用于配置管理、日志记录、线程池、连接池、内存池、对象池、消息队列等。</p><h1 id="实现步骤">实现步骤</h1><ol><li>将类的构造函数定义为私有方法</li><li>定义一个私有的类的静态成员数据</li><li>提供一个公有的获取静态实例的静态方法</li></ol><h1 id="单例模式设计与实现">单例模式设计与实现</h1><h2 id="常用实现">常用实现</h2><p>单例模式需要将构造函数、析构函数、拷贝构造函数和拷贝赋值运算符声明为私有的。</p><p>然后定义一个私有的类的静态实例，并初始化私有的静态实例为空指针<code>nullptr</code>。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test/singleton.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Singleton</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">static</span> Singleton * <span class="title">instance</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (m_instance == <span class="literal">nullptr</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            m_instance = <span class="keyword">new</span> <span class="built_in">Singleton</span>();</span><br><span class="line">            <span class="keyword">return</span> m_instance;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> m_instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">show</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Singleton&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">Singleton</span>() = <span class="keyword">default</span>;</span><br><span class="line">    <span class="built_in">Singleton</span>(<span class="type">const</span> Singleton &amp; a) = <span class="keyword">delete</span>;</span><br><span class="line">    Singleton &amp; <span class="keyword">operator</span>=(<span class="type">const</span> Singleton &amp; a) = <span class="keyword">delete</span>;</span><br><span class="line">    ~<span class="built_in">Singleton</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">static</span> Singleton * m_instance;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Singleton * Singleton::m_instance = <span class="literal">nullptr</span>;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;test/singleton.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Singleton * s = Singleton::<span class="built_in">instance</span>();</span><br><span class="line">    s-&gt;<span class="built_in">show</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="线程安全">线程安全</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> Singleton * <span class="title">instance</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (m_instance == <span class="literal">nullptr</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            m_instance = <span class="keyword">new</span> <span class="built_in">Singleton</span>();</span><br><span class="line">            <span class="keyword">return</span> m_instance;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> m_instance;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>上面单例模式的常见实现是存在多线程安全问题的，需要解决该线程安全问题。</p><h3 id="饿汉式写法">饿汉式写法</h3><p>由于静态数据成员是在<code>main()</code>函数运行之前初始化的，它只会被初始化一次，因此可以使用静态数据成员来解决单例模式的线程安全问题：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Singleton</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">static</span> Singleton * <span class="title">instance</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> &amp;m_instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">show</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Singleton&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">Singleton</span>() = <span class="keyword">default</span>;</span><br><span class="line">    <span class="built_in">Singleton</span>(<span class="type">const</span> Singleton &amp; a) = <span class="keyword">delete</span>;</span><br><span class="line">    Singleton &amp; <span class="keyword">operator</span>=(<span class="type">const</span> Singleton &amp; a) = <span class="keyword">delete</span>;</span><br><span class="line">    ~<span class="built_in">Singleton</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">static</span> Singleton m_instance;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Singleton Singleton::m_instance;</span><br></pre></td></tr></table></figure><p><strong>特点：</strong></p><ol><li>在程序启动时就初始化实例</li><li>线程安全，但可能会增加程序启动时间</li><li>如果单例对象很大且不一定会被使用，可能会浪费资源</li></ol><h3 id="懒汉式写法">懒汉式写法</h3><p>C++11标准保证静态局部变量的初始化是线程安全的，即在多线程环境下静态局部变量只会实例化一次：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Singleton</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">static</span> Singleton * <span class="title">instance</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="type">static</span> Singleton singleton;</span><br><span class="line">        <span class="keyword">return</span> &amp;singleton;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">show</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Singleton&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">Singleton</span>() = <span class="keyword">default</span>;</span><br><span class="line">    <span class="built_in">Singleton</span>(<span class="type">const</span> Singleton &amp; a) = <span class="keyword">delete</span>;</span><br><span class="line">    Singleton &amp; <span class="keyword">operator</span>=(<span class="type">const</span> Singleton &amp; a) = <span class="keyword">delete</span>;</span><br><span class="line">    ~<span class="built_in">Singleton</span>() = <span class="keyword">default</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><strong>特点：</strong></p><ol><li>使用静态局部变量，C++11保证其初始化是线程安全的</li><li>只有第一次调用<code>instance()</code>时才会创建实例</li><li>简单、清晰、线程安全</li></ol><h2 id="模板实现">模板实现</h2><p>如果每个类都要实现单例模式，那可能每个类都要以相同的方式实现一遍，比较麻烦，可以借助模板来简化工作：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// utility/singleton.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> utility</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 定义模板类</span></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Singleton</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="function"><span class="type">static</span> T * <span class="title">instance</span><span class="params">()</span></span></span><br><span class="line"><span class="function">            </span>&#123;   </span><br><span class="line">                <span class="comment">// C++11保证静态局部变量的初始化是线程安全的</span></span><br><span class="line">                <span class="type">static</span> T instance;</span><br><span class="line">                <span class="keyword">return</span> &amp;instance;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="built_in">Singleton</span>() = <span class="keyword">default</span>;</span><br><span class="line">            <span class="built_in">Singleton</span>(<span class="type">const</span> Singleton&lt;T&gt; &amp;) = <span class="keyword">delete</span>;</span><br><span class="line">            Singleton&lt;T&gt; <span class="keyword">operator</span>=(<span class="type">const</span> Singleton&lt;T&gt; &amp;) = <span class="keyword">delete</span>;</span><br><span class="line">            ~<span class="built_in">Singleton</span>() = <span class="keyword">default</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test/a.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility/singleton.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::utility;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 声明类Singleton&lt;A&gt;为类A的友元以便于调用其私有构造函数</span></span><br><span class="line">    <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">Singleton</span>&lt;A&gt;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">show</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;A&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">A</span>() = <span class="keyword">default</span>;</span><br><span class="line">    <span class="built_in">A</span>(<span class="type">const</span> A &amp; a) = <span class="keyword">delete</span>;</span><br><span class="line">    A &amp; <span class="keyword">operator</span>=(<span class="type">const</span> A &amp; a) = <span class="keyword">delete</span>;</span><br><span class="line">    ~<span class="built_in">A</span>() = <span class="keyword">default</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="定义优化">定义优化</h2><p>每次写一个单例类都要重复编写以下代码，非常不变。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">A</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 声明类Singleton&lt;A&gt;为类A的友元以便于调用其私有构造函数</span></span><br><span class="line">    <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">Singleton</span>&lt;A&gt;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">A</span>() = <span class="keyword">default</span>;</span><br><span class="line">    <span class="built_in">A</span>(<span class="type">const</span> A &amp; a) = <span class="keyword">delete</span>;</span><br><span class="line">    A &amp; <span class="keyword">operator</span>=(<span class="type">const</span> A &amp; a) = <span class="keyword">delete</span>;</span><br><span class="line">    ~<span class="built_in">A</span>() = <span class="keyword">default</span>;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>可以通过宏来进一步简化和优化：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// utility/singleton.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> utility</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 定义模板类</span></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Singleton</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="function"><span class="type">static</span> T * <span class="title">instance</span><span class="params">()</span></span></span><br><span class="line"><span class="function">            </span>&#123;   </span><br><span class="line">                <span class="comment">// C++11保证静态局部变量的初始化是线程安全的</span></span><br><span class="line">                <span class="type">static</span> T instance;</span><br><span class="line">                <span class="keyword">return</span> &amp;instance;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="built_in">Singleton</span>() = <span class="keyword">default</span>;</span><br><span class="line">            <span class="built_in">Singleton</span>(<span class="type">const</span> Singleton&lt;T&gt; &amp;) = <span class="keyword">delete</span>;</span><br><span class="line">            Singleton&lt;T&gt; <span class="keyword">operator</span>=(<span class="type">const</span> Singleton&lt;T&gt; &amp;) = <span class="keyword">delete</span>;</span><br><span class="line">            ~<span class="built_in">Singleton</span>() = <span class="keyword">default</span>;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 在C++宏定义中，反斜杠\的主要用途是作为续行符，表示宏定义在下一行继续</span></span><br><span class="line">        <span class="meta">#<span class="keyword">define</span> SINGLETON(classname)                                        \</span></span><br><span class="line"><span class="meta">            friend class Singleton<span class="string">&lt;classname&gt;</span>;                              \</span></span><br><span class="line"><span class="meta">            private:                                                        \</span></span><br><span class="line"><span class="meta">                classname() = default;                                      \</span></span><br><span class="line"><span class="meta">                classname(const classname &amp;) = delete;                      \</span></span><br><span class="line"><span class="meta">                classname &amp; operator=(const classname &amp;) = delete;          \</span></span><br><span class="line"><span class="meta">                ~classname() = default</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test/a.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility/singleton.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::utility;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 用宏来简化重复编码，非常方便</span></span><br><span class="line">    <span class="built_in">SINGLETON</span>(A);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">show</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;A&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h1 id="使用带模板的单例模式优化日志系统">使用带模板的单例模式优化日志系统</h1><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CMakeLists.txt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.20</span>)</span><br><span class="line"><span class="keyword">project</span>(<span class="keyword">option</span> CXX)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD <span class="number">11</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">file</span>(GLOB_RECURSE SOURCES <span class="string">&quot;utility/*.cpp&quot;</span>)</span><br><span class="line"><span class="keyword">add_executable</span>(main <span class="variable">$&#123;SOURCES&#125;</span> main.cpp)</span><br><span class="line"><span class="keyword">target_include_directories</span>(main PRIVATE .)</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// utility/singleton.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> utility</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 定义模板类</span></span><br><span class="line">        <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Singleton</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="function"><span class="type">static</span> T * <span class="title">instance</span><span class="params">()</span></span></span><br><span class="line"><span class="function">            </span>&#123;   </span><br><span class="line">                <span class="comment">// C++11保证静态局部变量的初始化是线程安全的</span></span><br><span class="line">                <span class="type">static</span> T instance;</span><br><span class="line">                <span class="keyword">return</span> &amp;instance;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="built_in">Singleton</span>() = <span class="keyword">default</span>;</span><br><span class="line">            <span class="built_in">Singleton</span>(<span class="type">const</span> Singleton&lt;T&gt; &amp;) = <span class="keyword">delete</span>;</span><br><span class="line">            Singleton&lt;T&gt; <span class="keyword">operator</span>=(<span class="type">const</span> Singleton&lt;T&gt; &amp;) = <span class="keyword">delete</span>;</span><br><span class="line">            ~<span class="built_in">Singleton</span>() = <span class="keyword">default</span>;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 在C++宏定义中，反斜杠\的主要用途是作为续行符，表示宏定义在下一行继续</span></span><br><span class="line">        <span class="meta">#<span class="keyword">define</span> SINGLETON(classname)                                        \</span></span><br><span class="line"><span class="meta">            friend class Singleton<span class="string">&lt;classname&gt;</span>;                              \</span></span><br><span class="line"><span class="meta">            private:                                                        \</span></span><br><span class="line"><span class="meta">                classname() = default;                                      \</span></span><br><span class="line"><span class="meta">                classname(const classname &amp;) = delete;                      \</span></span><br><span class="line"><span class="meta">                classname &amp; operator=(const classname &amp;) = delete;          \</span></span><br><span class="line"><span class="meta">                ~classname() = default</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// singleton/logger.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctime&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdarg&gt;</span>          <span class="comment">// 使用可变参数</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility/singleton.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 为了sleep()支持跨平台</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> WIN32</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> std::string;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> utility</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 定义日志宏以便于使用</span></span><br><span class="line">        <span class="meta">#<span class="keyword">define</span> log_debug(format, ...) \</span></span><br><span class="line"><span class="meta">            Singleton<span class="string">&lt;Logger&gt;</span>::instance()-&gt;log(Logger::LOG_DEBUG, __FILE__, __LINE__, format, ##__VA_ARGS__)</span></span><br><span class="line">        <span class="meta">#<span class="keyword">define</span> log_info(format, ...) \</span></span><br><span class="line"><span class="meta">            Singleton<span class="string">&lt;Logger&gt;</span>::instance()-&gt;log(Logger::LOG_INFO, __FILE__, __LINE__, format, ##__VA_ARGS__)</span></span><br><span class="line">        <span class="meta">#<span class="keyword">define</span> log_warn(format, ...) \</span></span><br><span class="line"><span class="meta">            Singleton<span class="string">&lt;Logger&gt;</span>::instance()-&gt;log(Logger::LOG_WARN, __FILE__, __LINE__, format, ##__VA_ARGS__)</span></span><br><span class="line">        <span class="meta">#<span class="keyword">define</span> log_error(format, ...) \</span></span><br><span class="line"><span class="meta">            Singleton<span class="string">&lt;Logger&gt;</span>::instance()-&gt;log(Logger::LOG_ERROR, __FILE__, __LINE__, format, ##__VA_ARGS__)</span></span><br><span class="line">        <span class="meta">#<span class="keyword">define</span> log_fatal(format, ...) \</span></span><br><span class="line"><span class="meta">            Singleton<span class="string">&lt;Logger&gt;</span>::instance()-&gt;log(Logger::LOG_FATAL, __FILE__, __LINE__, format, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 负责记录日志的Logger类</span></span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Logger</span>&#123;</span><br><span class="line">            <span class="built_in">SINGLETON</span>(Logger);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="comment">// 定义日志级别的枚举</span></span><br><span class="line">            <span class="keyword">enum</span> <span class="title class_">Level</span></span><br><span class="line">            &#123;</span><br><span class="line">                LOG_DEBUG = <span class="number">0</span>,</span><br><span class="line">                LOG_INFO,</span><br><span class="line">                LOG_WARN,</span><br><span class="line">                LOG_ERROR,</span><br><span class="line">                LOG_FATAL,</span><br><span class="line">                LOG_COUNT</span><br><span class="line">            &#125;;     </span><br><span class="line"></span><br><span class="line">            <span class="comment">// 记录日志之前需先打开日志文件</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">open</span><span class="params">(<span class="type">const</span> string &amp; filename)</span></span>;</span><br><span class="line">            <span class="comment">// 关闭日志文件</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">close</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="comment">// 记录日志(日志级别、日志所在文件、日志所在文件的行号、日志格式、可变参数)</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">log</span><span class="params">(Level level, <span class="type">const</span> <span class="type">char</span> * file, <span class="type">int</span> line, <span class="type">const</span> <span class="type">char</span> * format, ...)</span></span>;</span><br><span class="line">            <span class="comment">// 设置日志级别</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">set_level</span><span class="params">(Level level)</span></span>;</span><br><span class="line">            <span class="comment">// 设置日志的最大长度</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">set_max_size</span><span class="params">(<span class="type">int</span> size)</span></span>;</span><br><span class="line">            <span class="comment">// 控制台打印日志开关</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">set_console</span><span class="params">(<span class="type">bool</span> console)</span></span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="comment">// 日志翻滚</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">rotate</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="comment">// 支持跨平台的localtime接口</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">localtime</span><span class="params">(<span class="keyword">struct</span> tm * time_info, <span class="type">const</span> <span class="type">time_t</span> * ticks)</span></span>;</span><br><span class="line">            <span class="comment">// 支持跨平台的sleep接口,单位毫秒</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">sleep</span><span class="params">(<span class="type">int</span> milliseconds)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            string m_filename;                          <span class="comment">// 日志文件名</span></span><br><span class="line">            std::ofstream m_ofs;                        <span class="comment">// 当前打开的日志文件流</span></span><br><span class="line">            <span class="type">int</span> m_max = <span class="number">0</span>;                              <span class="comment">// 日志的最大长度，默认值为0</span></span><br><span class="line">            <span class="type">int</span> m_len = <span class="number">0</span>;                              <span class="comment">// 记录当前日志的长度</span></span><br><span class="line">            <span class="type">int</span> m_level = LOG_DEBUG;                    <span class="comment">// 日志级别</span></span><br><span class="line">            <span class="type">bool</span> m_console = <span class="literal">true</span>;                      <span class="comment">// 控制台打印日志内容开关</span></span><br><span class="line">            <span class="type">static</span> <span class="type">const</span> <span class="type">char</span> * s_level[LOG_COUNT];</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// singleton/logger.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility/logger.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::utility;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> * Logger::s_level[LOG_COUNT] = &#123;<span class="string">&quot;DEBUG&quot;</span>, <span class="string">&quot;INFO&quot;</span>, <span class="string">&quot;WARN&quot;</span>, <span class="string">&quot;ERROR&quot;</span>, <span class="string">&quot;FATAL&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Logger::open</span><span class="params">(<span class="type">const</span> string &amp; filename)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_filename = filename;</span><br><span class="line">    m_ofs.<span class="built_in">open</span>(filename, std::ios::app);        <span class="comment">// 以追加的方式打开文件</span></span><br><span class="line">    <span class="keyword">if</span> (m_ofs.<span class="built_in">fail</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;open log file failed: &quot;</span> + filename);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 打开日志文件时需计算已写入多少内容</span></span><br><span class="line">    m_ofs.<span class="built_in">seekp</span>(<span class="number">0</span>, std::ios::end);              <span class="comment">// 将文件指针移动至文件结尾</span></span><br><span class="line">    m_len = (<span class="type">int</span>)m_ofs.<span class="built_in">tellp</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Logger::close</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_ofs.<span class="built_in">close</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Logger::set_level</span><span class="params">(Level level)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_level = level;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Logger::set_max_size</span><span class="params">(<span class="type">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_max = size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Logger::set_console</span><span class="params">(<span class="type">bool</span> console)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_console = console;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...是可变参数</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Logger::log</span><span class="params">(Level level, <span class="type">const</span> <span class="type">char</span> * file, <span class="type">int</span> line, <span class="type">const</span> <span class="type">char</span> * format, ...)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_level &gt; level)                    <span class="comment">// 低级别日志直接忽略</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (m_ofs.<span class="built_in">fail</span>())                       <span class="comment">// 检查文件流是否处于有效的活跃状态</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    std::ostringstream oss;</span><br><span class="line">    <span class="type">time_t</span> ticks = <span class="built_in">time</span>(<span class="literal">nullptr</span>);</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">tm</span> time_info = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">localtime</span>(&amp;time_info, &amp;ticks);        <span class="comment">// 把整型的时间戳转换为年月日时分秒</span></span><br><span class="line">    <span class="type">char</span> timestamp[<span class="number">32</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">strftime</span>(timestamp, <span class="built_in">sizeof</span>(timestamp), <span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>, &amp;time_info);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> len = <span class="number">0</span>;                            <span class="comment">// 日志记录内容的长度</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> * fmt = <span class="string">&quot;%s %s %s:%d &quot;</span>;       <span class="comment">// 时间 级别 源文件:行号</span></span><br><span class="line">    <span class="comment">// 计算格式化字符串的长度</span></span><br><span class="line">    len = <span class="built_in">snprintf</span>(<span class="literal">nullptr</span>, <span class="number">0</span>, fmt, timestamp, s_level[m_level], file, line);</span><br><span class="line">    <span class="keyword">if</span> (len &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> * buffer = <span class="keyword">new</span> <span class="type">char</span>[len + <span class="number">1</span>];</span><br><span class="line">        <span class="built_in">snprintf</span>(buffer, len + <span class="number">1</span>, fmt, timestamp, s_level[m_level], file, line);</span><br><span class="line">        buffer[len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        oss &lt;&lt; buffer;</span><br><span class="line">        m_len += len;</span><br><span class="line">        <span class="keyword">delete</span>[] buffer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 可变参数的处理:</span></span><br><span class="line">    va_list arg_ptr;                                    <span class="comment">// 首先定义va_list类型变量作为可变参数列表</span></span><br><span class="line">    <span class="built_in">va_start</span>(arg_ptr, format);                          <span class="comment">// 然后使用va_start进行初始化</span></span><br><span class="line">    len = <span class="built_in">vsnprintf</span>(<span class="literal">nullptr</span>, <span class="number">0</span>, format, arg_ptr);       <span class="comment">// 拿到可变参数组装成日志的长度</span></span><br><span class="line">    <span class="built_in">va_end</span>(arg_ptr);                                    <span class="comment">// 调用va_end清理释放可变参数资源</span></span><br><span class="line">    <span class="keyword">if</span> (len &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> * content = <span class="keyword">new</span> <span class="type">char</span>[len + <span class="number">1</span>];</span><br><span class="line">        <span class="built_in">va_start</span>(arg_ptr, format);</span><br><span class="line">        <span class="built_in">vsnprintf</span>(content, len + <span class="number">1</span>, format, arg_ptr);</span><br><span class="line">        <span class="built_in">va_end</span>(arg_ptr);</span><br><span class="line">        content[len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        oss &lt;&lt; content;</span><br><span class="line">        m_len += len;</span><br><span class="line">        <span class="keyword">delete</span>[] content;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 日志内容每一行最后需要换行</span></span><br><span class="line">    oss &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    <span class="type">const</span> string &amp; str = oss.<span class="built_in">str</span>();</span><br><span class="line">    <span class="keyword">if</span> (m_console)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; str;</span><br><span class="line">    &#125;</span><br><span class="line">    m_ofs &lt;&lt; str;</span><br><span class="line">    <span class="comment">// 强制将缓冲区中的数据立即写入到关联的文件中</span></span><br><span class="line">    m_ofs.<span class="built_in">flush</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (m_max &gt; <span class="number">0</span> &amp;&amp; m_len &gt;= m_max)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Log rotate: m_len = &quot;</span> &lt;&lt; m_len &lt;&lt; <span class="string">&quot;, m_max = &quot;</span> &lt;&lt; m_max &lt;&lt; std::endl;</span><br><span class="line">        <span class="comment">// 日志需要翻滚</span></span><br><span class="line">        <span class="built_in">rotate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 日志翻滚</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Logger::rotate</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 先关闭当前日志流</span></span><br><span class="line">    <span class="built_in">close</span>();</span><br><span class="line">    <span class="comment">// sleep1秒是为避免短时间内发生了多次日志翻滚而备份日志文件名相同</span></span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">1000</span>);</span><br><span class="line">    <span class="comment">// 为避免日志文件名重复，日志文件名中采用时间戳</span></span><br><span class="line">    <span class="type">time_t</span> ticks = <span class="built_in">time</span>(<span class="literal">nullptr</span>);</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">tm</span> time_info = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">localtime</span>(&amp;time_info, &amp;ticks);</span><br><span class="line">    <span class="type">char</span> timestamp[<span class="number">32</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">strftime</span>(timestamp, <span class="built_in">sizeof</span>(timestamp), <span class="string">&quot;.%Y-%m-%d_%H-%M-%S&quot;</span>, &amp;time_info);</span><br><span class="line">    string filename = m_filename + timestamp;</span><br><span class="line">    <span class="comment">// 如果new_filename不存在，则将old_filename重命名为new_filename;</span></span><br><span class="line">    <span class="comment">// 如果new_filename存在，会删除已存在的new_filename然后将old_filename重命名为new_filename</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">rename</span>(m_filename.<span class="built_in">c_str</span>(), filename.<span class="built_in">c_str</span>()) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;rename ini file failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">open</span>(m_filename);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Logger::sleep</span><span class="params">(<span class="type">int</span> milliseconds)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> WIN32</span></span><br><span class="line">    <span class="built_in">Sleep</span>(milliseconds);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="built_in">usleep</span>(milliseconds * <span class="number">1000</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Logger::localtime</span><span class="params">(<span class="keyword">struct</span> tm * time_info, <span class="type">const</span> <span class="type">time_t</span> * ticks)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// 支持Windows平台和Linux平台</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> WIN32        </span></span><br><span class="line">    <span class="built_in">localtime_s</span>(time_info, ticks);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="built_in">localtime_r</span>(ticks, time_info);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility/logger.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::utility;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> logger = Singleton&lt;Logger&gt;::<span class="built_in">instance</span>();</span><br><span class="line">    logger-&gt;<span class="built_in">open</span>(<span class="string">&quot;./main.log&quot;</span>);</span><br><span class="line">    logger-&gt;<span class="built_in">set_max_size</span>(<span class="number">1024</span>);</span><br><span class="line">    <span class="built_in">log_debug</span>(<span class="string">&quot;hello world&quot;</span>);</span><br><span class="line">    <span class="built_in">log_error</span>(<span class="string">&quot;%s %d&quot;</span>, <span class="string">&quot;this is an error&quot;</span>, <span class="number">123</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> C++后端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>日志系统</title>
      <link href="/2024/04/28/%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F/"/>
      <url>/2024/04/28/%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F/</url>
      
        <content type="html"><![CDATA[<h1 id="日志功能介绍">日志功能介绍</h1><p>程序特别是后台服务运行时，如果在线上出现问题，一般都是通过查找日志来定位原因的。比如程序崩溃或者运行不符合预期，最佳的方式就是查看日志文件，因此在开发时程序员要考虑将重要信息记录到日志文件中。</p><ol><li>日志存储：文本文件，文件后缀为<code>.log</code></li><li>日志内容：时间、级别、文件、行号、内容</li><li>日志级别：<code>debug &lt; info &lt; warn &lt; error &lt; fatal</code></li><li>日志翻滚：当日志的大小超过设置值，那么日志内容将保存到新文件</li><li>跨平台：支持 Linux、Windows 等不同的平台</li></ol><h1 id="日志功能设计与实现">日志功能设计与实现</h1><h2 id="日志写入">日志写入</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Logger::log</span><span class="params">(Level level, <span class="type">const</span> <span class="type">char</span> * file, <span class="type">int</span> line, <span class="type">const</span> <span class="type">char</span> * format, ...)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_level &gt; level)                    <span class="comment">// 低级别日志直接忽略</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (m_ofs.<span class="built_in">fail</span>())                       <span class="comment">// 检查文件流是否处于有效的活跃状态</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    std::ostringstream oss;</span><br><span class="line">    <span class="type">time_t</span> ticks = <span class="built_in">time</span>(<span class="literal">nullptr</span>);</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">tm</span> time_info = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">localtime</span>(&amp;time_info, &amp;ticks);        <span class="comment">// 把整型的时间戳转换为年月日时分秒</span></span><br><span class="line">    <span class="type">char</span> timestamp[<span class="number">32</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">strftime</span>(timestamp, <span class="built_in">sizeof</span>(timestamp), <span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>, &amp;time_info);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> len = <span class="number">0</span>;                            <span class="comment">// 日志记录内容的长度</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> * fmt = <span class="string">&quot;%s %s %s:%d &quot;</span>;       <span class="comment">// 时间 级别 源文件:行号</span></span><br><span class="line">    <span class="comment">// 计算格式化字符串的长度</span></span><br><span class="line">    len = <span class="built_in">snprintf</span>(<span class="literal">nullptr</span>, <span class="number">0</span>, fmt, timestamp, s_level[m_level], file, line);</span><br><span class="line">    <span class="keyword">if</span> (len &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> * buffer = <span class="keyword">new</span> <span class="type">char</span>[len + <span class="number">1</span>];</span><br><span class="line">        <span class="built_in">snprintf</span>(buffer, len + <span class="number">1</span>, fmt, timestamp, s_level[m_level], file, line);</span><br><span class="line">        buffer[len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        oss &lt;&lt; buffer;</span><br><span class="line">        m_len += len;</span><br><span class="line">        <span class="keyword">delete</span>[] buffer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 可变参数的处理:</span></span><br><span class="line">    va_list arg_ptr;                                    <span class="comment">// 首先定义va_list类型变量作为可变参数列表</span></span><br><span class="line">    <span class="built_in">va_start</span>(arg_ptr, format);                          <span class="comment">// 然后使用va_start进行初始化</span></span><br><span class="line">    len = <span class="built_in">vsnprintf</span>(<span class="literal">nullptr</span>, <span class="number">0</span>, format, arg_ptr);       <span class="comment">// 拿到可变参数组装成日志的长度</span></span><br><span class="line">    <span class="built_in">va_end</span>(arg_ptr);                                    <span class="comment">// 调用va_end清理释放可变参数资源</span></span><br><span class="line">    <span class="keyword">if</span> (len &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> * content = <span class="keyword">new</span> <span class="type">char</span>[len + <span class="number">1</span>];</span><br><span class="line">        <span class="built_in">va_start</span>(arg_ptr, format);</span><br><span class="line">        <span class="built_in">vsnprintf</span>(content, len + <span class="number">1</span>, format, arg_ptr);</span><br><span class="line">        <span class="built_in">va_end</span>(arg_ptr);</span><br><span class="line">        content[len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        oss &lt;&lt; content;</span><br><span class="line">        m_len += len;</span><br><span class="line">        <span class="keyword">delete</span>[] content;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 日志内容每一行最后需要换行</span></span><br><span class="line">    oss &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    <span class="type">const</span> string &amp; str = oss.<span class="built_in">str</span>();</span><br><span class="line">    <span class="keyword">if</span> (m_console)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; str;</span><br><span class="line">    &#125;</span><br><span class="line">    m_ofs &lt;&lt; str;</span><br><span class="line">    <span class="comment">// 强制将缓冲区中的数据立即写入到关联的文件中</span></span><br><span class="line">    m_ofs.<span class="built_in">flush</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (m_max &gt; <span class="number">0</span> &amp;&amp; m_len &gt;= m_max)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Log rotate: m_len = &quot;</span> &lt;&lt; m_len &lt;&lt; <span class="string">&quot;, m_max = &quot;</span> &lt;&lt; m_max &lt;&lt; std::endl;</span><br><span class="line">        <span class="comment">// 日志需要翻滚</span></span><br><span class="line">        <span class="built_in">rotate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="日志翻滚">日志翻滚</h2><p>日志是以追加方式写入文件中，随着时间推移日志文件会越来越大，当日志文件非常大时打开该日志文件会很慢，为了优化体验需要引入日志翻滚功能。日志翻滚是指先设置一个最大日志文件大小，当日志文件超过该大小时会先将旧日志内容备份，新的日志信息会写入另一份日志文件中。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 日志翻滚</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Logger::rotate</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 先关闭当前日志流</span></span><br><span class="line">    <span class="built_in">close</span>();</span><br><span class="line">    <span class="comment">// sleep1秒是为避免短时间内发生了多次日志翻滚而备份日志文件名相同</span></span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">1000</span>);</span><br><span class="line">    <span class="comment">// 为避免日志文件名重复，日志文件名中采用时间戳</span></span><br><span class="line">    <span class="type">time_t</span> ticks = <span class="built_in">time</span>(<span class="literal">nullptr</span>);</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">tm</span> time_info = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">localtime</span>(&amp;time_info, &amp;ticks);</span><br><span class="line">    <span class="type">char</span> timestamp[<span class="number">32</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">strftime</span>(timestamp, <span class="built_in">sizeof</span>(timestamp), <span class="string">&quot;.%Y-%m-%d_%H-%M-%S&quot;</span>, &amp;time_info);</span><br><span class="line">    string filename = m_filename + timestamp;</span><br><span class="line">    <span class="comment">// 如果new_filename不存在，则将old_filename重命名为new_filename;</span></span><br><span class="line">    <span class="comment">// 如果new_filename存在，会删除已存在的new_filename然后将old_filename重命名为new_filename</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">rename</span>(m_filename.<span class="built_in">c_str</span>(), filename.<span class="built_in">c_str</span>()) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;rename ini file failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">open</span>(m_filename);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="跨平台">跨平台</h2><p>在<code>Logger::log()</code>实现中调用了<code>localtime_s()</code>将时间戳<code>time_t</code>类型转换为本地时间<code>struct tm</code>，但该函数是Windows平台实现，不是跨平台的，Linux平台上对应的是<code>localtime_r()</code>。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Logger::sleep</span><span class="params">(<span class="type">int</span> milliseconds)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> WIN32</span></span><br><span class="line">    <span class="built_in">Sleep</span>(milliseconds);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="built_in">usleep</span>(milliseconds * <span class="number">1000</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Logger::localtime</span><span class="params">(<span class="keyword">struct</span> tm * time_info, <span class="type">const</span> <span class="type">time_t</span> * ticks)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// 支持Windows平台和Linux平台</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> WIN32        </span></span><br><span class="line">    <span class="built_in">localtime_s</span>(time_info, ticks);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="built_in">localtime_r</span>(ticks, time_info);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="日志单例">日志单例</h2><p>当前日志使用时需要通过创建实例<code>Logger log;</code>，但对于应用程序来说日志是全局的，在不同模块代码中调用的应该是同一个日志实例，因此需要将日志用单例模式来实现，全局仅有一个实例。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">    </span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">namespace</span> utility</span><br><span class="line">    &#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Logger</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="comment">// 单例模式为了保证全局只有一个日志实例，需要将其构造函数和析构函数声明为私有的</span></span><br><span class="line">            <span class="built_in">Logger</span>();</span><br><span class="line">            ~<span class="built_in">Logger</span>();</span><br><span class="line">            ......</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            ......</span><br><span class="line">            <span class="comment">// 静态指针指向全局唯一的Logger对象</span></span><br><span class="line">            <span class="type">static</span> Logger * m_instance;</span><br><span class="line">        &#125;;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// utility/logger.cpp</span></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">Logger * Logger::m_instance = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">Logger * <span class="title">Logger::instance</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_instance == <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        m_instance = <span class="keyword">new</span> <span class="built_in">Logger</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> m_instance;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">......</span><br></pre></td></tr></table></figure><h2 id="日志宏实现">日志宏实现</h2><p>在调试程序时可能会快速查看局部变量等信息，当前记录一条日志会调用<code>Logger::instance()-&gt;log()</code>，并传入日志级别、源文件名、文件行号和日志信息，这样比较冗长不便，可以引入宏来优化这部分。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> utility</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 定义日志宏以便于使用</span></span><br><span class="line">        <span class="meta">#<span class="keyword">define</span> log_debug(format, ...) \</span></span><br><span class="line"><span class="meta">            Logger::instance()-&gt;log(Logger::LOG_DEBUG, __FILE__, __LINE__, format, ##__VA_ARGS__)</span></span><br><span class="line">        <span class="meta">#<span class="keyword">define</span> log_info(format, ...) \</span></span><br><span class="line"><span class="meta">            Logger::instance()-&gt;log(Logger::LOG_INFO, __FILE__, __LINE__, format, ##__VA_ARGS__)</span></span><br><span class="line">        <span class="meta">#<span class="keyword">define</span> log_warn(format, ...) \</span></span><br><span class="line"><span class="meta">            Logger::instance()-&gt;log(Logger::LOG_WARN, __FILE__, __LINE__, format, ##__VA_ARGS__)</span></span><br><span class="line">        <span class="meta">#<span class="keyword">define</span> log_error(format, ...) \</span></span><br><span class="line"><span class="meta">            Logger::instance()-&gt;log(Logger::LOG_ERROR, __FILE__, __LINE__, format, ##__VA_ARGS__)</span></span><br><span class="line">        <span class="meta">#<span class="keyword">define</span> log_fatal(format, ...) \</span></span><br><span class="line"><span class="meta">            Logger::instance()-&gt;log(Logger::LOG_FATAL, __FILE__, __LINE__, format, ##__VA_ARGS__)</span></span><br><span class="line">        </span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$</span><span class="language-bash">tree</span></span><br><span class="line">.</span><br><span class="line">├── CMakeLists.txt</span><br><span class="line">├── main.cpp</span><br><span class="line">├── main.ini</span><br><span class="line">└── utility</span><br><span class="line">    ├── ini_file.cpp</span><br><span class="line">    ├── ini_file.h</span><br><span class="line">    ├── logger.cpp</span><br><span class="line">    ├── logger.h</span><br><span class="line">    ├── option.cpp</span><br><span class="line">    ├── option.h</span><br><span class="line">    ├── value.cpp</span><br><span class="line">    └── value.h</span><br><span class="line"></span><br><span class="line">2 directories, 11 files</span><br></pre></td></tr></table></figure><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CMakeLists.txt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.20</span>)</span><br><span class="line"><span class="keyword">project</span>(<span class="keyword">option</span> CXX)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD <span class="number">11</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">file</span>(GLOB_RECURSE SOURCES <span class="string">&quot;utility/*.cpp&quot;</span>)</span><br><span class="line"><span class="keyword">add_executable</span>(main <span class="variable">$&#123;SOURCES&#125;</span> main.cpp)</span><br><span class="line"><span class="keyword">target_include_directories</span>(main PRIVATE .)</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// utility/logger.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctime&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdarg&gt;</span>          <span class="comment">// 使用可变参数</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 为了sleep()支持跨平台</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> WIN32</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> std::string;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> utility</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 定义日志宏以便于使用</span></span><br><span class="line">        <span class="meta">#<span class="keyword">define</span> log_debug(format, ...) \</span></span><br><span class="line"><span class="meta">            Logger::instance()-&gt;log(Logger::LOG_DEBUG, __FILE__, __LINE__, format, ##__VA_ARGS__)</span></span><br><span class="line">        <span class="meta">#<span class="keyword">define</span> log_info(format, ...) \</span></span><br><span class="line"><span class="meta">            Logger::instance()-&gt;log(Logger::LOG_INFO, __FILE__, __LINE__, format, ##__VA_ARGS__)</span></span><br><span class="line">        <span class="meta">#<span class="keyword">define</span> log_warn(format, ...) \</span></span><br><span class="line"><span class="meta">            Logger::instance()-&gt;log(Logger::LOG_WARN, __FILE__, __LINE__, format, ##__VA_ARGS__)</span></span><br><span class="line">        <span class="meta">#<span class="keyword">define</span> log_error(format, ...) \</span></span><br><span class="line"><span class="meta">            Logger::instance()-&gt;log(Logger::LOG_ERROR, __FILE__, __LINE__, format, ##__VA_ARGS__)</span></span><br><span class="line">        <span class="meta">#<span class="keyword">define</span> log_fatal(format, ...) \</span></span><br><span class="line"><span class="meta">            Logger::instance()-&gt;log(Logger::LOG_FATAL, __FILE__, __LINE__, format, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 负责记录日志的Logger类</span></span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Logger</span>&#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="comment">// 定义日志级别的枚举</span></span><br><span class="line">            <span class="keyword">enum</span> <span class="title class_">Level</span></span><br><span class="line">            &#123;</span><br><span class="line">                LOG_DEBUG = <span class="number">0</span>,</span><br><span class="line">                LOG_INFO,</span><br><span class="line">                LOG_WARN,</span><br><span class="line">                LOG_ERROR,</span><br><span class="line">                LOG_FATAL,</span><br><span class="line">                LOG_COUNT</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 静态方法拿到全局的实例指针</span></span><br><span class="line">            <span class="function"><span class="type">static</span> Logger * <span class="title">instance</span><span class="params">()</span></span>;     </span><br><span class="line"></span><br><span class="line">            <span class="comment">// 记录日志之前需先打开日志文件</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">open</span><span class="params">(<span class="type">const</span> string &amp; filename)</span></span>;</span><br><span class="line">            <span class="comment">// 关闭日志文件</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">close</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="comment">// 记录日志(日志级别、日志所在文件、日志所在文件的行号、日志格式、可变参数)</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">log</span><span class="params">(Level level, <span class="type">const</span> <span class="type">char</span> * file, <span class="type">int</span> line, <span class="type">const</span> <span class="type">char</span> * format, ...)</span></span>;</span><br><span class="line">            <span class="comment">// 设置日志级别</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">set_level</span><span class="params">(Level level)</span></span>;</span><br><span class="line">            <span class="comment">// 设置日志的最大长度</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">set_max_size</span><span class="params">(<span class="type">int</span> size)</span></span>;</span><br><span class="line">            <span class="comment">// 控制台打印日志开关</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">set_console</span><span class="params">(<span class="type">bool</span> console)</span></span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="comment">// 单例模式为了保证全局只有一个日志实例，需要将其构造函数和析构函数声明为私有的</span></span><br><span class="line">            <span class="built_in">Logger</span>();</span><br><span class="line">            ~<span class="built_in">Logger</span>();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 日志翻滚</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">rotate</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="comment">// 支持跨平台的localtime接口</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">localtime</span><span class="params">(<span class="keyword">struct</span> tm * time_info, <span class="type">const</span> <span class="type">time_t</span> * ticks)</span></span>;</span><br><span class="line">            <span class="comment">// 支持跨平台的sleep接口,单位毫秒</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">sleep</span><span class="params">(<span class="type">int</span> milliseconds)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            string m_filename;                          <span class="comment">// 日志文件名</span></span><br><span class="line">            std::ofstream m_ofs;                        <span class="comment">// 当前打开的日志文件流</span></span><br><span class="line">            <span class="type">int</span> m_max;                                  <span class="comment">// 日志的最大长度，默认值为0</span></span><br><span class="line">            <span class="type">int</span> m_len;                                  <span class="comment">// 记录当前日志的长度</span></span><br><span class="line">            <span class="type">int</span> m_level;                                <span class="comment">// 日志级别</span></span><br><span class="line">            <span class="type">bool</span> m_console;                             <span class="comment">// 控制台打印日志内容开关</span></span><br><span class="line">            <span class="type">static</span> <span class="type">const</span> <span class="type">char</span> * s_level[LOG_COUNT];</span><br><span class="line">            <span class="type">static</span> Logger * m_instance;               <span class="comment">// 静态指针指向全局唯一的Logger对象</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// utility/logger.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility/logger.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::utility;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> * Logger::s_level[LOG_COUNT] = &#123;<span class="string">&quot;DEBUG&quot;</span>, <span class="string">&quot;INFO&quot;</span>, <span class="string">&quot;WARN&quot;</span>, <span class="string">&quot;ERROR&quot;</span>, <span class="string">&quot;FATAL&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">Logger * Logger::m_instance = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">Logger::<span class="built_in">Logger</span>() : <span class="built_in">m_level</span>(LOG_DEBUG), <span class="built_in">m_len</span>(<span class="number">0</span>), <span class="built_in">m_max</span>(<span class="number">0</span>) <span class="comment">// 默认情况下不支持日志翻滚</span></span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Logger::~<span class="built_in">Logger</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">close</span>();                                    <span class="comment">// 关闭打开的日志文件流</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Logger * <span class="title">Logger::instance</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_instance == <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        m_instance = <span class="keyword">new</span> <span class="built_in">Logger</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> m_instance;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Logger::open</span><span class="params">(<span class="type">const</span> string &amp; filename)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_filename = filename;</span><br><span class="line">    m_ofs.<span class="built_in">open</span>(filename, std::ios::app);        <span class="comment">// 以追加的方式打开文件</span></span><br><span class="line">    <span class="keyword">if</span> (m_ofs.<span class="built_in">fail</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;open log file failed: &quot;</span> + filename);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 打开日志文件时需计算已写入多少内容</span></span><br><span class="line">    m_ofs.<span class="built_in">seekp</span>(<span class="number">0</span>, std::ios::end);              <span class="comment">// 将文件指针移动至文件结尾</span></span><br><span class="line">    m_len = (<span class="type">int</span>)m_ofs.<span class="built_in">tellp</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Logger::close</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_ofs.<span class="built_in">close</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Logger::set_level</span><span class="params">(Level level)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_level = level;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Logger::set_max_size</span><span class="params">(<span class="type">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_max = size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Logger::set_console</span><span class="params">(<span class="type">bool</span> console)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_console = console;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...是可变参数</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Logger::log</span><span class="params">(Level level, <span class="type">const</span> <span class="type">char</span> * file, <span class="type">int</span> line, <span class="type">const</span> <span class="type">char</span> * format, ...)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_level &gt; level)                    <span class="comment">// 低级别日志直接忽略</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (m_ofs.<span class="built_in">fail</span>())                       <span class="comment">// 检查文件流是否处于有效的活跃状态</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    std::ostringstream oss;</span><br><span class="line">    <span class="type">time_t</span> ticks = <span class="built_in">time</span>(<span class="literal">nullptr</span>);</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">tm</span> time_info = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">localtime</span>(&amp;time_info, &amp;ticks);        <span class="comment">// 把整型的时间戳转换为年月日时分秒</span></span><br><span class="line">    <span class="type">char</span> timestamp[<span class="number">32</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">strftime</span>(timestamp, <span class="built_in">sizeof</span>(timestamp), <span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>, &amp;time_info);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> len = <span class="number">0</span>;                            <span class="comment">// 日志记录内容的长度</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> * fmt = <span class="string">&quot;%s %s %s:%d &quot;</span>;       <span class="comment">// 时间 级别 源文件:行号</span></span><br><span class="line">    <span class="comment">// 计算格式化字符串的长度</span></span><br><span class="line">    len = <span class="built_in">snprintf</span>(<span class="literal">nullptr</span>, <span class="number">0</span>, fmt, timestamp, s_level[m_level], file, line);</span><br><span class="line">    <span class="keyword">if</span> (len &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> * buffer = <span class="keyword">new</span> <span class="type">char</span>[len + <span class="number">1</span>];</span><br><span class="line">        <span class="built_in">snprintf</span>(buffer, len + <span class="number">1</span>, fmt, timestamp, s_level[m_level], file, line);</span><br><span class="line">        buffer[len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        oss &lt;&lt; buffer;</span><br><span class="line">        m_len += len;</span><br><span class="line">        <span class="keyword">delete</span>[] buffer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 可变参数的处理:</span></span><br><span class="line">    va_list arg_ptr;                                    <span class="comment">// 首先定义va_list类型变量作为可变参数列表</span></span><br><span class="line">    <span class="built_in">va_start</span>(arg_ptr, format);                          <span class="comment">// 然后使用va_start进行初始化</span></span><br><span class="line">    len = <span class="built_in">vsnprintf</span>(<span class="literal">nullptr</span>, <span class="number">0</span>, format, arg_ptr);       <span class="comment">// 拿到可变参数组装成日志的长度</span></span><br><span class="line">    <span class="built_in">va_end</span>(arg_ptr);                                    <span class="comment">// 调用va_end清理释放可变参数资源</span></span><br><span class="line">    <span class="keyword">if</span> (len &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> * content = <span class="keyword">new</span> <span class="type">char</span>[len + <span class="number">1</span>];</span><br><span class="line">        <span class="built_in">va_start</span>(arg_ptr, format);</span><br><span class="line">        <span class="built_in">vsnprintf</span>(content, len + <span class="number">1</span>, format, arg_ptr);</span><br><span class="line">        <span class="built_in">va_end</span>(arg_ptr);</span><br><span class="line">        content[len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        oss &lt;&lt; content;</span><br><span class="line">        m_len += len;</span><br><span class="line">        <span class="keyword">delete</span>[] content;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 日志内容每一行最后需要换行</span></span><br><span class="line">    oss &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    <span class="type">const</span> string &amp; str = oss.<span class="built_in">str</span>();</span><br><span class="line">    <span class="keyword">if</span> (m_console)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; str;</span><br><span class="line">    &#125;</span><br><span class="line">    m_ofs &lt;&lt; str;</span><br><span class="line">    <span class="comment">// 强制将缓冲区中的数据立即写入到关联的文件中</span></span><br><span class="line">    m_ofs.<span class="built_in">flush</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (m_max &gt; <span class="number">0</span> &amp;&amp; m_len &gt;= m_max)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Log rotate: m_len = &quot;</span> &lt;&lt; m_len &lt;&lt; <span class="string">&quot;, m_max = &quot;</span> &lt;&lt; m_max &lt;&lt; std::endl;</span><br><span class="line">        <span class="comment">// 日志需要翻滚</span></span><br><span class="line">        <span class="built_in">rotate</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 日志翻滚</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Logger::rotate</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 先关闭当前日志流</span></span><br><span class="line">    <span class="built_in">close</span>();</span><br><span class="line">    <span class="comment">// sleep1秒是为避免短时间内发生了多次日志翻滚而备份日志文件名相同</span></span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">1000</span>);</span><br><span class="line">    <span class="comment">// 为避免日志文件名重复，日志文件名中采用时间戳</span></span><br><span class="line">    <span class="type">time_t</span> ticks = <span class="built_in">time</span>(<span class="literal">nullptr</span>);</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">tm</span> time_info = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">localtime</span>(&amp;time_info, &amp;ticks);</span><br><span class="line">    <span class="type">char</span> timestamp[<span class="number">32</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">strftime</span>(timestamp, <span class="built_in">sizeof</span>(timestamp), <span class="string">&quot;.%Y-%m-%d_%H-%M-%S&quot;</span>, &amp;time_info);</span><br><span class="line">    string filename = m_filename + timestamp;</span><br><span class="line">    <span class="comment">// 如果new_filename不存在，则将old_filename重命名为new_filename;</span></span><br><span class="line">    <span class="comment">// 如果new_filename存在，会删除已存在的new_filename然后将old_filename重命名为new_filename</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">rename</span>(m_filename.<span class="built_in">c_str</span>(), filename.<span class="built_in">c_str</span>()) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;rename ini file failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">open</span>(m_filename);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Logger::sleep</span><span class="params">(<span class="type">int</span> milliseconds)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> WIN32</span></span><br><span class="line">    <span class="built_in">Sleep</span>(milliseconds);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="built_in">usleep</span>(milliseconds * <span class="number">1000</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Logger::localtime</span><span class="params">(<span class="keyword">struct</span> tm * time_info, <span class="type">const</span> <span class="type">time_t</span> * ticks)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// 支持Windows平台和Linux平台</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> WIN32        </span></span><br><span class="line">    <span class="built_in">localtime_s</span>(time_info, ticks);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="built_in">localtime_r</span>(ticks, time_info);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility/logger.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::utility;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Logger::<span class="built_in">instance</span>()-&gt;<span class="built_in">open</span>(<span class="string">&quot;./main.log&quot;</span>);</span><br><span class="line">    Logger::<span class="built_in">instance</span>()-&gt;<span class="built_in">set_max_size</span>(<span class="number">1024</span>);</span><br><span class="line">    Logger::<span class="built_in">instance</span>()-&gt;<span class="built_in">set_console</span>(<span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; i &lt;&lt; std::endl;</span><br><span class="line">        <span class="comment">//Logger::instance()-&gt;log(Logger::LOG_DEBUG, __FILE__, __LINE__, &quot;%s %d %d&quot;, &quot;hello world&quot;, i, 123);</span></span><br><span class="line">        <span class="built_in">log_debug</span>(<span class="string">&quot;%s %d %d&quot;</span>, <span class="string">&quot;hello world&quot;</span>, i, <span class="number">123</span>);</span><br><span class="line">        <span class="built_in">log_error</span>(<span class="string">&quot;%s&quot;</span>, <span class="string">&quot;this is an error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> C++后端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ini解析器</title>
      <link href="/2024/04/21/ini%E8%A7%A3%E6%9E%90%E5%99%A8/"/>
      <url>/2024/04/21/ini%E8%A7%A3%E6%9E%90%E5%99%A8/</url>
      
        <content type="html"><![CDATA[<h1 id="常用配置文件类型">常用配置文件类型</h1><p>项目中一般会用到的配置文件有4种类型：</p><ol><li><p><code>INI</code></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[server]</span></span><br><span class="line"><span class="attr">ip</span> = <span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line"><span class="attr">port</span> = <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="section">[profile]</span></span><br><span class="line"><span class="attr">name</span> = jack</span><br><span class="line"><span class="attr">gender</span> = male</span><br><span class="line"><span class="attr">age</span> = <span class="number">30</span></span><br></pre></td></tr></table></figure><p>优点：非常简单，书写方便</p><p>缺点：不能表达复杂的数据格式</p><p>应用场景：配置文件</p></li><li><p><code>XML</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ip</span>&gt;</span>127.0.0.1<span class="tag">&lt;/<span class="name">ip</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">port</span>&gt;</span>80<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span>jack<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">gender</span>&gt;</span>male<span class="tag">&lt;/<span class="name">gender</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">age</span>&gt;</span>30<span class="tag">&lt;/<span class="name">age</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure><p>优点：可以表达复杂的数据格式</p><p>缺点：书写麻烦</p><p>应用场景：配置文件，数据传输</p></li><li><p><code>JSON</code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;server&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;ip&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">80</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;profile&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jack&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span> <span class="string">&quot;male&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">30</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>优点：简单，可以表达复杂的数据格式</p><p>缺点：书写麻烦</p><p>应用场景：配置文件，数据传输</p></li><li><p><code>YAML</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">    <span class="attr">ip:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">profile:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">jack</span></span><br><span class="line">    <span class="attr">gender:</span> <span class="string">male</span></span><br><span class="line">    <span class="attr">age:</span> <span class="number">30</span></span><br></pre></td></tr></table></figure><p>优点：简单直观，书写方便，可以表达复杂的数据格式</p><p>缺点：它使用空白符号缩进，使用场景受限，无法进行数据传输</p><p>运用场景：配置文件</p></li></ol><h1 id="为什么要用ini配置？">为什么要用INI配置？</h1><ol><li>非常简单，书写方便</li><li>运用广泛：linux绝大多数开源软件都采用<code>ini</code>配置，比如Mysql、Redis、PHP、OpenStack等</li></ol><p><code>INI</code>文件的格式很简单，例如：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[server]</span></span><br><span class="line"><span class="attr">ip</span> = <span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line"><span class="attr">port</span> = <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="section">[profile]</span></span><br><span class="line"><span class="attr">name</span> = jack</span><br><span class="line"><span class="attr">gender</span> = male</span><br><span class="line"><span class="attr">age</span> = <span class="number">30</span></span><br></pre></td></tr></table></figure><ul><li>最基本的三个要素是：section、option、value</li><li>配置文件中可以包含多个section，每个section下面可以有多个option</li><li>option/value类似字典的key/value对，以=分隔</li><li>注释以#或者;开头</li></ul><h1 id="inifile解析器设计与实现">IniFile解析器设计与实现</h1><p><code>IniFile</code>是专门用来解析<code>INI</code>配置文件的，主要包括<code>INI</code>文件解析和<code>INI</code>常用操作。</p><p><code>INI</code>格式的三要素是<code>section</code>、<code>option</code>和<code>value</code>，其中<code>option</code>和<code>value</code>就是<code>map</code>中的<code>key-value</code>键值对关系。而对于一个<code>INI</code>文件来说有很多<code>section</code>，每个<code>section</code>有自己的名称，那么也可以用<code>map</code>来存储<code>section</code>名称到对应<code>section</code>内容的映射关系。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$</span><span class="language-bash">tree</span></span><br><span class="line">.</span><br><span class="line">├── CMakeLists.txt</span><br><span class="line">├── main.cpp</span><br><span class="line">├── main.ini</span><br><span class="line">└── utility</span><br><span class="line">    ├── ini_file.cpp</span><br><span class="line">    ├── ini_file.h</span><br><span class="line">    ├── option.cpp</span><br><span class="line">    ├── option.h</span><br><span class="line">    ├── value.cpp</span><br><span class="line">    └── value.h</span><br><span class="line"></span><br><span class="line">1 directory, 9 files</span><br></pre></td></tr></table></figure><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CMakeLists.txt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.20</span>)</span><br><span class="line"><span class="keyword">project</span>(<span class="keyword">option</span> CXX)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD <span class="number">11</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">file</span>(GLOB_RECURSE SOURCES <span class="string">&quot;utility/*.cpp&quot;</span>)</span><br><span class="line"><span class="keyword">add_executable</span>(main <span class="variable">$&#123;SOURCES&#125;</span> main.cpp)</span><br><span class="line"><span class="keyword">target_include_directories</span>(main PRIVATE .)</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// utility/ini_file.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdexcept&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility/value.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> std::string;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> utility</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// INI配置文件解析器</span></span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">IniFile</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Section即INI文件格式中的section，键值对即该section中的option和value</span></span><br><span class="line">            <span class="keyword">using</span> Section = std::map&lt;string, Value&gt;;</span><br><span class="line">            <span class="comment">// typdef std::map&lt;string, Value&gt; Section;</span></span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="built_in">IniFile</span>() = <span class="keyword">default</span>;</span><br><span class="line">            <span class="built_in">IniFile</span>(<span class="type">const</span> string &amp; filename);</span><br><span class="line">            ~<span class="built_in">IniFile</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 解析INI配置文件内容</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">load</span><span class="params">(<span class="type">const</span> string &amp; filename)</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 返回INI配置文件的内容</span></span><br><span class="line">            <span class="function">string <span class="title">str</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="comment">// 打印INI文件中的所有配置项</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">show</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取INI配置文件中指定配置项内容</span></span><br><span class="line">            <span class="function">Value &amp; <span class="title">get</span><span class="params">(<span class="type">const</span> string &amp; section, <span class="type">const</span> string &amp; key)</span></span>;</span><br><span class="line">            <span class="comment">// 设置INI配置文件中指定配置项内容</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">set</span><span class="params">(<span class="type">const</span> string &amp; section, <span class="type">const</span> string &amp; key, <span class="type">const</span> Value &amp; value)</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 重载[]运算符便于用户使用，也更直观</span></span><br><span class="line">            Section &amp; <span class="keyword">operator</span>[](<span class="type">const</span> string &amp; section)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> m_sections[section];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 判断INI配置文件中是否存在某个section</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">has</span><span class="params">(<span class="type">const</span> string &amp; section)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">has</span><span class="params">(<span class="type">const</span> string &amp; section, <span class="type">const</span> string &amp; key)</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 删除某个section</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">remove</span><span class="params">(<span class="type">const</span> string &amp; section)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">remove</span><span class="params">(<span class="type">const</span> string &amp; section, <span class="type">const</span> string &amp; key)</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">clear</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="comment">// 保存到配置文件中</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">save</span><span class="params">(<span class="type">const</span> string &amp; filename)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="function">string <span class="title">trim</span><span class="params">(string str)</span></span>;                <span class="comment">// 将每一行前后的换行符去除掉</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            string m_filename;                      <span class="comment">// 保存INI文件的名称</span></span><br><span class="line">            std::map&lt;string, Section&gt; m_sections;   <span class="comment">// 记录section名称到对应section内容的映射关系</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// utility/ini_file.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility/ini_file.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::utility;</span><br><span class="line"></span><br><span class="line">IniFile::<span class="built_in">IniFile</span>(<span class="type">const</span> string &amp; filename)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">load</span>(filename);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">string <span class="title">IniFile::trim</span><span class="params">(string s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (s.<span class="built_in">empty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将字符串前端的空格/换行/回车去掉</span></span><br><span class="line">    s.<span class="built_in">erase</span>(<span class="number">0</span>, s.<span class="built_in">find_first_not_of</span>(<span class="string">&quot; \r\n&quot;</span>));</span><br><span class="line">    <span class="comment">// 将字符串尾端的空格/换行/回车去掉</span></span><br><span class="line">    s.<span class="built_in">erase</span>(s.<span class="built_in">find_last_not_of</span>(<span class="string">&quot; \r\n&quot;</span>) + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">IniFile::load</span><span class="params">(<span class="type">const</span> string &amp; filename)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_sections.<span class="built_in">clear</span>();</span><br><span class="line">    m_filename = filename;</span><br><span class="line">    <span class="function">std::ifstream <span class="title">ifs</span><span class="params">(filename)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (ifs.<span class="built_in">fail</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;loading ini file failed: &quot;</span> + filename);</span><br><span class="line">    &#125;</span><br><span class="line">    string line, name;</span><br><span class="line">    <span class="comment">// 读取每一行文件</span></span><br><span class="line">    <span class="keyword">while</span> (std::<span class="built_in">getline</span>(ifs, line))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 将每一行前后的换行符去除掉</span></span><br><span class="line">        line = <span class="built_in">trim</span>(line);</span><br><span class="line">        <span class="comment">// 如果是空行则直接略过</span></span><br><span class="line">        <span class="keyword">if</span> (line.<span class="built_in">empty</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果此行为注释则直接略过</span></span><br><span class="line">        <span class="keyword">if</span> (line[<span class="number">0</span>] == <span class="string">&#x27;#&#x27;</span> || line[<span class="number">0</span>] == <span class="string">&#x27;;&#x27;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果以[开头则出现一个section</span></span><br><span class="line">        <span class="keyword">if</span> (line[<span class="number">0</span>] == <span class="string">&#x27;[&#x27;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">auto</span> pos = line.<span class="built_in">find_first_of</span>(<span class="string">&#x27;]&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> (pos == std::string::npos)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;invalid section: &quot;</span> + line);</span><br><span class="line">            &#125;</span><br><span class="line">            name = <span class="built_in">trim</span>(line.<span class="built_in">substr</span>(<span class="number">1</span>, pos - <span class="number">1</span>));</span><br><span class="line">            m_sections[name] = <span class="built_in">Section</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 解析section中的key-value</span></span><br><span class="line">            <span class="keyword">auto</span> pos = line.<span class="built_in">find_first_of</span>(<span class="string">&#x27;=&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> (pos == std::string::npos)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;invalid option: &quot;</span> + line);</span><br><span class="line">            &#125;</span><br><span class="line">            string key = <span class="built_in">trim</span>(line.<span class="built_in">substr</span>(<span class="number">0</span>, pos));</span><br><span class="line">            string val = <span class="built_in">trim</span>(line.<span class="built_in">substr</span>(pos + <span class="number">1</span>));</span><br><span class="line">            m_sections[name][key] = val;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">string <span class="title">IniFile::str</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::stringstream ss;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span> &amp; section : m_sections)</span><br><span class="line">    &#123;</span><br><span class="line">        ss &lt;&lt; <span class="string">&quot;[&quot;</span> &lt;&lt; section.first &lt;&lt; <span class="string">&quot;]&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span> &amp; option : section.second)</span><br><span class="line">        &#123;</span><br><span class="line">            ss &lt;&lt; option.first &lt;&lt; <span class="string">&quot; = &quot;</span> &lt;&lt; <span class="built_in">string</span>(option.second) &lt;&lt; std::endl;</span><br><span class="line">        &#125;</span><br><span class="line">        ss &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ss.<span class="built_in">str</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">IniFile::show</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="built_in">str</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Value &amp; <span class="title">IniFile::get</span><span class="params">(<span class="type">const</span> string &amp; section, <span class="type">const</span> string &amp; key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_sections[section][key];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">IniFile::set</span><span class="params">(<span class="type">const</span> string &amp; section, <span class="type">const</span> string &amp; key, <span class="type">const</span> Value &amp; value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_sections[section][key] = value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">IniFile::has</span><span class="params">(<span class="type">const</span> string &amp; section)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_sections.<span class="built_in">find</span>(section) != m_sections.<span class="built_in">end</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">IniFile::has</span><span class="params">(<span class="type">const</span> string &amp; section, <span class="type">const</span> string &amp; key)</span>\</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> it = m_sections.<span class="built_in">find</span>(section);</span><br><span class="line">    <span class="keyword">if</span> (it == m_sections.<span class="built_in">end</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> it-&gt;second.<span class="built_in">find</span>(key) == it-&gt;second.<span class="built_in">end</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">IniFile::remove</span><span class="params">(<span class="type">const</span> string &amp; section)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_sections.<span class="built_in">erase</span>(section);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">IniFile::remove</span><span class="params">(<span class="type">const</span> string &amp; section, <span class="type">const</span> string &amp; key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> it = m_sections.<span class="built_in">find</span>(section);</span><br><span class="line">    <span class="keyword">if</span> (it == m_sections.<span class="built_in">end</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    it-&gt;second.<span class="built_in">erase</span>(key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">IniFile::clear</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_sections.<span class="built_in">clear</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">IniFile::save</span><span class="params">(<span class="type">const</span> string &amp; filename)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">std::ofstream <span class="title">ofs</span><span class="params">(filename)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (ofs.<span class="built_in">fail</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;saving ini file failed: &quot;</span> + filename);</span><br><span class="line">    &#125;</span><br><span class="line">    ofs &lt;&lt; <span class="built_in">str</span>();</span><br><span class="line">    ofs.<span class="built_in">close</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility/ini_file.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::utility;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">IniFile <span class="title">ini</span><span class="params">(<span class="string">&quot;./main.ini&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    ini[<span class="string">&quot;server&quot;</span>][<span class="string">&quot;ip&quot;</span>] = <span class="string">&quot;192.168.1.1&quot;</span>;</span><br><span class="line">    ini[<span class="string">&quot;server&quot;</span>][<span class="string">&quot;port&quot;</span>] = <span class="number">8000</span>;</span><br><span class="line">    ini.<span class="built_in">show</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> C++后端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>动态数据类型</title>
      <link href="/2024/04/14/%E5%8A%A8%E6%80%81%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/"/>
      <url>/2024/04/14/%E5%8A%A8%E6%80%81%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/</url>
      
        <content type="html"><![CDATA[<h1 id="命令行参数解析实现存在的问题分析">命令行参数解析实现存在的问题分析</h1><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility/option.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::utility;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Option opt;</span><br><span class="line">    opt.<span class="built_in">add</span>(<span class="string">&quot;a&quot;</span>, Option::OPT_NO);</span><br><span class="line">    opt.<span class="built_in">add</span>(<span class="string">&quot;b&quot;</span>, Option::OPT_REQUIRED);</span><br><span class="line">    opt.<span class="built_in">add</span>(<span class="string">&quot;c&quot;</span>, Option::OPT_OPTIONAL);</span><br><span class="line">    opt.<span class="built_in">parse</span>(argc, argv);</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> a = opt.<span class="built_in">get_bool</span>(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">    <span class="type">int</span> b = opt.<span class="built_in">get_int</span>(<span class="string">&quot;b&quot;</span>);</span><br><span class="line">    string c = opt.<span class="built_in">get_string</span>(<span class="string">&quot;c&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>获取基本数据类型<code>getter()</code>这部分需要优化：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> a = opt.<span class="built_in">get_bool</span>(<span class="string">&quot;a&quot;</span>);</span><br><span class="line"><span class="type">int</span> b = opt.<span class="built_in">get_int</span>(<span class="string">&quot;b&quot;</span>);</span><br><span class="line">string c = opt.<span class="built_in">get_string</span>(<span class="string">&quot;c&quot;</span>);</span><br></pre></td></tr></table></figure><p>如果要获取命令行参数是浮点类型需要新增<code>get_float()</code>方法，这样就会存在一堆<code>get_xxx()</code>方法。期望优化后达到以下目标，都使用一个<code>get()</code>方法：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> a = obj.<span class="built_in">get</span>(<span class="string">&quot;a&quot;</span>);</span><br><span class="line"><span class="type">int</span> b = obj.<span class="built_in">get</span>(<span class="string">&quot;b&quot;</span>);</span><br><span class="line">string c = obj.<span class="built_in">get</span>(<span class="string">&quot;c&quot;</span>);</span><br></pre></td></tr></table></figure><p>这里无法通过函数重载来实现，因为这里参数数量和参数类型都相同，仅返回值不同，可能需要思考更巧妙的方式来解决。</p><p>对于设置基本数据类型<code>setter()</code>也需要优化：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">obj.<span class="built_in">set_bool</span>(<span class="string">&quot;a&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">obj.<span class="built_in">set_int</span>(<span class="string">&quot;b&quot;</span>, <span class="number">123</span>);</span><br><span class="line">obj.<span class="built_in">set_string</span>(<span class="string">&quot;c&quot;</span>, <span class="string">&quot;hello world&quot;</span>);</span><br></pre></td></tr></table></figure><p>期望优化后统一使用<code>set()</code>方法：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">obj.<span class="built_in">set</span>(<span class="string">&quot;a&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">obj.<span class="built_in">set</span>(<span class="string">&quot;b&quot;</span>, <span class="number">123</span>);</span><br><span class="line">obj.<span class="built_in">set</span>(<span class="string">&quot;c&quot;</span>, <span class="string">&quot;hello world&quot;</span>);</span><br></pre></td></tr></table></figure><p>虽然<code>set()</code>可以通过函数重载方式来实现，因为虽然参数数量相同，但第二个参数类型不同。</p><p>但如果有了<code>Value</code>对象对基本数据类型进行封装，可以把基本数据类型转换为<code>Value</code>对象，而<code>Value</code>对象也可以转换为基本数据类型，这样就无需使用到函数重载技术了。</p><h1 id="value设计与实现">Value设计与实现</h1><p><img src="https://aliyun-oss-zh.oss-cn-beijing.aliyuncs.com/img/QQ20250610-183000.jpg" alt=""></p><p><code>Value</code>是一个类，左侧是基本数据类型，这些基本数据类型可以存储到<code>Value</code>对象中，同时<code>Value</code>可以转换为对应的基本数据类型，如此可以达到数据动态类型的效果。</p><h2 id="构造函数">构造函数</h2><p>由<code>bool</code>构造<code>Value</code>：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Value v = <span class="literal">true</span>;<span class="comment">// Value v(true); </span></span><br></pre></td></tr></table></figure><p>由<code>int</code>构造<code>Value</code>：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Value v = <span class="number">123</span>;</span><br></pre></td></tr></table></figure><p>由<code>float</code>构造<code>Value</code>：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Value v = <span class="number">1.23</span>;</span><br></pre></td></tr></table></figure><p>由<code>string</code>构造<code>Value</code>：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Value v = <span class="string">&quot;hello world&quot;</span>;</span><br></pre></td></tr></table></figure><h2 id="赋值运算符">赋值运算符</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Value v;</span><br><span class="line">v = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure><h2 id="类型转换运算符">类型转换运算符</h2><p><code>Value</code>转换成<code>bool</code>：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Value v = <span class="literal">true</span>;</span><br><span class="line"><span class="type">bool</span> b = v;</span><br></pre></td></tr></table></figure><p><code>Value</code>转换成<code>int</code>：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Value v = <span class="number">123</span>;</span><br><span class="line"><span class="type">int</span> i = v;</span><br></pre></td></tr></table></figure><p><code>Value</code>转换成<code>float</code>：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Value v = <span class="number">1.23</span>;</span><br><span class="line"><span class="type">float</span> f = v;</span><br></pre></td></tr></table></figure><p><code>Value</code>转换成<code>string</code>：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Value v = <span class="string">&quot;hello world&quot;</span>;</span><br><span class="line">string s = v;</span><br></pre></td></tr></table></figure><p>类型转换运算符用法简洁，代码可读性会提升不少。</p><p>这里提供带<code>const</code>和不带<code>const</code>两个版本的类型转换运算符是为了在使用场景上支持更广泛。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$</span><span class="language-bash">tree</span></span><br><span class="line">.</span><br><span class="line">├── CMakeLists.txt</span><br><span class="line">├── main.cpp</span><br><span class="line">└── utility</span><br><span class="line">    ├── option.cpp</span><br><span class="line">    ├── option.h</span><br><span class="line">    ├── value.cpp</span><br><span class="line">    └── value.h</span><br><span class="line"></span><br><span class="line">1 directory, 6 files</span><br></pre></td></tr></table></figure><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CMakeLists.txt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.20</span>)</span><br><span class="line"><span class="keyword">project</span>(<span class="keyword">option</span> CXX)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD <span class="number">11</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">file</span>(GLOB_RECURSE SOURCES <span class="string">&quot;utility/*.cpp&quot;</span>)</span><br><span class="line"><span class="keyword">add_executable</span>(main <span class="variable">$&#123;SOURCES&#125;</span> main.cpp)</span><br><span class="line"><span class="keyword">target_include_directories</span>(main PRIVATE .)</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// utility/value.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sstream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> std::string;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> utility</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Value</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="comment">// Value类是对基本数据类型的封装，将它能封装的类型放到枚举中</span></span><br><span class="line">            <span class="keyword">enum</span> <span class="title class_">Type</span></span><br><span class="line">            &#123;</span><br><span class="line">                V_NULL = <span class="number">0</span>,         <span class="comment">// 无类型</span></span><br><span class="line">                V_BOOL,</span><br><span class="line">                V_INT,</span><br><span class="line">                V_FLOAT,</span><br><span class="line">                V_DOUBLE,</span><br><span class="line">                V_STRING</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 通过构造函数将基本数据类型转入到Value</span></span><br><span class="line">            <span class="comment">// 空构造函数不传入任何值，其构造出来的Value是空的，即V_NULL</span></span><br><span class="line">            <span class="built_in">Value</span>();</span><br><span class="line">            <span class="built_in">Value</span>(<span class="type">bool</span> value);</span><br><span class="line">            <span class="built_in">Value</span>(<span class="type">int</span> value);</span><br><span class="line">            <span class="built_in">Value</span>(<span class="type">unsigned</span> <span class="type">int</span> value);</span><br><span class="line">            <span class="built_in">Value</span>(<span class="type">float</span> value);</span><br><span class="line">            <span class="built_in">Value</span>(<span class="type">double</span> value);</span><br><span class="line">            <span class="built_in">Value</span>(<span class="type">const</span> <span class="type">char</span>* value);</span><br><span class="line">            <span class="built_in">Value</span>(<span class="type">const</span> string&amp; value);</span><br><span class="line">            ~<span class="built_in">Value</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 赋值运算符</span></span><br><span class="line">            Value&amp; <span class="keyword">operator</span>=(<span class="type">const</span> <span class="type">bool</span>&amp; value);</span><br><span class="line">            Value&amp; <span class="keyword">operator</span>=(<span class="type">const</span> <span class="type">int</span>&amp; value);</span><br><span class="line">            Value&amp; <span class="keyword">operator</span>=(<span class="type">const</span> <span class="type">unsigned</span> <span class="type">int</span>&amp; value);</span><br><span class="line">            Value&amp; <span class="keyword">operator</span>=(<span class="type">const</span> <span class="type">float</span>&amp; value);</span><br><span class="line">            Value&amp; <span class="keyword">operator</span>=(<span class="type">const</span> <span class="type">double</span>&amp; value);</span><br><span class="line">            Value&amp; <span class="keyword">operator</span>=(<span class="type">const</span> <span class="type">char</span>* value);</span><br><span class="line">            Value&amp; <span class="keyword">operator</span>=(<span class="type">const</span> string&amp; value);</span><br><span class="line">            Value&amp; <span class="keyword">operator</span>=(<span class="type">const</span> Value&amp; other);</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">show</span><span class="params">()</span> <span class="type">const</span></span>;          <span class="comment">// 将Value对象内部数据打印出来，便于调试</span></span><br><span class="line"></span><br><span class="line">            <span class="function">Type <span class="title">type</span><span class="params">()</span> <span class="type">const</span></span>;          <span class="comment">// 获取Value对象的类型</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">is_null</span><span class="params">()</span> <span class="type">const</span></span>;       <span class="comment">// 判断Value对象的类型是否为空</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">is_bool</span><span class="params">()</span> <span class="type">const</span></span>;       <span class="comment">// 判断Value对象的类型是否为bool</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">is_int</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">is_float</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">is_double</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">is_string</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 实现等于运算符和不等于运算符，判断两个Value对象是否相等</span></span><br><span class="line">            <span class="type">bool</span> <span class="keyword">operator</span>==(<span class="type">const</span> Value&amp; other);</span><br><span class="line">            <span class="type">bool</span> <span class="keyword">operator</span>!=(<span class="type">const</span> Value&amp; other);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 类型转换运算符，将Value对象转换为指定类型</span></span><br><span class="line">            <span class="comment">// 为了在使用场景上支持更广泛，这里提供带const和不带const两个版本</span></span><br><span class="line">            <span class="function"><span class="keyword">operator</span> <span class="title">bool</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="function"><span class="keyword">operator</span> <span class="title">bool</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="function"><span class="keyword">operator</span> <span class="title">int</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="function"><span class="keyword">operator</span> <span class="title">int</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="function"><span class="keyword">operator</span> <span class="type">unsigned</span> <span class="title">int</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="function"><span class="keyword">operator</span> <span class="type">unsigned</span> <span class="title">int</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="function"><span class="keyword">operator</span> <span class="title">float</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="function"><span class="keyword">operator</span> <span class="title">float</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="function"><span class="keyword">operator</span> <span class="title">double</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="function"><span class="keyword">operator</span> <span class="title">double</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="function"><span class="keyword">operator</span> <span class="title">string</span><span class="params">()</span></span>;</span><br><span class="line">            <span class="function"><span class="keyword">operator</span> <span class="title">string</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            Type m_type;</span><br><span class="line">            string m_value;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// utility/value.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility/value.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::utility;</span><br><span class="line"></span><br><span class="line">Value::<span class="built_in">Value</span>() : <span class="built_in">m_type</span>(V_NULL)</span><br><span class="line">&#123;    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Value::<span class="built_in">Value</span>(<span class="type">bool</span> value) : <span class="built_in">m_type</span>(V_BOOL)</span><br><span class="line">&#123;</span><br><span class="line">    m_value = value ? <span class="string">&quot;true&quot;</span> : <span class="string">&quot;false&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Value::<span class="built_in">Value</span>(<span class="type">int</span> value) : <span class="built_in">m_type</span>(V_INT)</span><br><span class="line">&#123;</span><br><span class="line">    m_value = std::<span class="built_in">to_string</span>(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Value::<span class="built_in">Value</span>(<span class="type">unsigned</span> <span class="type">int</span> value) : <span class="built_in">m_type</span>(V_INT)</span><br><span class="line">&#123;</span><br><span class="line">    m_value = std::<span class="built_in">to_string</span>(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Value::<span class="built_in">Value</span>(<span class="type">float</span> value) : <span class="built_in">m_type</span>(V_FLOAT)</span><br><span class="line">&#123;</span><br><span class="line">    m_value = std::<span class="built_in">to_string</span>(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Value::<span class="built_in">Value</span>(<span class="type">double</span> value) : <span class="built_in">m_type</span>(V_DOUBLE)</span><br><span class="line">&#123;</span><br><span class="line">    m_value = std::<span class="built_in">to_string</span>(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Value::<span class="built_in">Value</span>(<span class="type">const</span> <span class="type">char</span>* value) : <span class="built_in">m_type</span>(V_STRING)</span><br><span class="line">&#123;</span><br><span class="line">    m_value = value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Value::<span class="built_in">Value</span>(<span class="type">const</span> string&amp; value) : <span class="built_in">m_type</span>(V_STRING)</span><br><span class="line">&#123;</span><br><span class="line">    m_value = value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Value::show</span><span class="params">()</span> <span class="type">const</span></span>&#123;</span><br><span class="line">    string type;</span><br><span class="line">    <span class="keyword">switch</span> (m_type)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> V_NULL:</span><br><span class="line">            type = <span class="string">&quot;null&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> V_BOOL:</span><br><span class="line">            type = <span class="string">&quot;bool&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> V_INT:</span><br><span class="line">            type = <span class="string">&quot;int&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> V_FLOAT:</span><br><span class="line">            type = <span class="string">&quot;float&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> V_DOUBLE:</span><br><span class="line">            type = <span class="string">&quot;double&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> V_STRING:</span><br><span class="line">            type = <span class="string">&quot;string&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;type = &quot;</span> &lt;&lt; type &lt;&lt; <span class="string">&quot;, value = &quot;</span> &lt;&lt; m_value &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Value&amp; Value::<span class="keyword">operator</span>=(<span class="type">const</span> <span class="type">bool</span>&amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    m_type = V_BOOL;</span><br><span class="line">    m_value = value ? <span class="string">&quot;true&quot;</span> : <span class="string">&quot;false&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Value&amp; Value::<span class="keyword">operator</span>=(<span class="type">const</span> <span class="type">int</span>&amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    m_type = V_INT;</span><br><span class="line">    m_value = std::<span class="built_in">to_string</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Value&amp; Value::<span class="keyword">operator</span>=(<span class="type">const</span> <span class="type">float</span>&amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    m_type = V_FLOAT;</span><br><span class="line">    m_value = std::<span class="built_in">to_string</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Value&amp; Value::<span class="keyword">operator</span>=(<span class="type">const</span> <span class="type">double</span>&amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    m_type = V_DOUBLE;</span><br><span class="line">    m_value = std::<span class="built_in">to_string</span>(value);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Value&amp; Value::<span class="keyword">operator</span>=(<span class="type">const</span> <span class="type">char</span>* value)</span><br><span class="line">&#123;</span><br><span class="line">    m_type = V_STRING;</span><br><span class="line">    m_value = value;</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Value&amp; Value::<span class="keyword">operator</span>=(<span class="type">const</span> string&amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    m_type = V_STRING;</span><br><span class="line">    m_value = value;</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Value&amp; Value::<span class="keyword">operator</span>=(<span class="type">const</span> Value&amp; other)</span><br><span class="line">&#123;</span><br><span class="line">    m_type = other.m_type;</span><br><span class="line">    m_value = other.m_value;</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Value::Type <span class="title">Value::type</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_type;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Value::is_null</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_type == V_NULL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Value::is_bool</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_type == V_BOOL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Value::is_int</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_type == V_INT;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Value::is_float</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_type == V_FLOAT;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Value::is_double</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_type == V_DOUBLE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Value::is_string</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_type == V_STRING;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> Value::<span class="keyword">operator</span>==(<span class="type">const</span> Value&amp; other)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (m_type != other.m_type)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> m_value == other.m_value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> Value::<span class="keyword">operator</span>!=(<span class="type">const</span> Value&amp; other)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> !(*<span class="keyword">this</span> == other);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Value::<span class="keyword">operator</span> <span class="title">bool</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_value == <span class="string">&quot;true&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Value::<span class="keyword">operator</span> <span class="title">bool</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_value == <span class="string">&quot;true&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Value::<span class="keyword">operator</span> <span class="title">int</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> value = <span class="number">0</span>;</span><br><span class="line">    std::stringstream ss;</span><br><span class="line">    ss &lt;&lt; m_value;</span><br><span class="line">    ss &gt;&gt; value;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Value::<span class="keyword">operator</span> <span class="title">int</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> value = <span class="number">0</span>;</span><br><span class="line">    std::stringstream ss;</span><br><span class="line">    ss &lt;&lt; m_value;</span><br><span class="line">    ss &gt;&gt; value;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Value::<span class="keyword">operator</span> <span class="type">unsigned</span> <span class="title">int</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> value = <span class="number">0</span>;</span><br><span class="line">    std::stringstream ss;</span><br><span class="line">    ss &lt;&lt; m_value;</span><br><span class="line">    ss &gt;&gt; value;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Value::<span class="keyword">operator</span> <span class="type">unsigned</span> <span class="title">int</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> value = <span class="number">0</span>;</span><br><span class="line">    std::stringstream ss;</span><br><span class="line">    ss &lt;&lt; m_value;</span><br><span class="line">    ss &gt;&gt; value;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Value::<span class="keyword">operator</span> <span class="title">float</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">float</span> value = <span class="number">0</span>;</span><br><span class="line">    std::stringstream ss;</span><br><span class="line">    ss &lt;&lt; m_value;</span><br><span class="line">    ss &gt;&gt; value;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Value::<span class="keyword">operator</span> <span class="title">float</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">float</span> value = <span class="number">0</span>;</span><br><span class="line">    std::stringstream ss;</span><br><span class="line">    ss &lt;&lt; m_value;</span><br><span class="line">    ss &gt;&gt; value;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Value::<span class="keyword">operator</span> <span class="title">double</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">double</span> value = <span class="number">0</span>;</span><br><span class="line">    std::stringstream ss;</span><br><span class="line">    ss &lt;&lt; m_value;</span><br><span class="line">    ss &gt;&gt; value;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Value::<span class="keyword">operator</span> <span class="title">double</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">double</span> value = <span class="number">0</span>;</span><br><span class="line">    std::stringstream ss;</span><br><span class="line">    ss &lt;&lt; m_value;</span><br><span class="line">    ss &gt;&gt; value;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Value::<span class="keyword">operator</span> <span class="title">string</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Value::<span class="keyword">operator</span> <span class="title">string</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="命令行参数解析优化">命令行参数解析优化</h1><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility/option.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::utility;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 短参数测试</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Option opt;</span><br><span class="line">    opt.<span class="built_in">add</span>(<span class="string">&quot;a&quot;</span>, Option::OPT_NO);</span><br><span class="line">    opt.<span class="built_in">add</span>(<span class="string">&quot;b&quot;</span>, Option::OPT_REQUIRED);</span><br><span class="line">    opt.<span class="built_in">add</span>(<span class="string">&quot;c&quot;</span>, Option::OPT_OPTIONAL);</span><br><span class="line">    opt.<span class="built_in">parse</span>(argc, argv);</span><br><span class="line">    <span class="type">bool</span> a = opt.<span class="built_in">get_bool</span>(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">    <span class="type">int</span> b = opt.<span class="built_in">get_int</span>(<span class="string">&quot;b&quot;</span>);</span><br><span class="line">    string c = opt.<span class="built_in">get_string</span>(<span class="string">&quot;c&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>之前在做命令行参数解析时，通过调用<code>get_bool()</code>获取<code>bool</code>类型参数值，通过调用<code>get_int()</code>获取<code>int</code>类型参数值，通过调用<code>get_string()</code>获取<code>string</code>类型参数值，这种写法不够简洁优雅，期望是优化后统一调用<code>get()</code>方法。而引入<code>Value</code>动态数据类型后就可以达到期望的优化目标：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// utility/value.cpp 部分代码已省略</span></span><br><span class="line"></span><br><span class="line"><span class="function">Value <span class="title">Option::get</span><span class="params">(<span class="type">const</span> string&amp; opt)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> it = m_opts.<span class="built_in">find</span>(opt);</span><br><span class="line">    <span class="keyword">if</span> (it == m_opts.<span class="built_in">end</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">Value</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">switch</span> (it-&gt;second)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> OPT_NO:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">Value</span>(m_args.<span class="built_in">find</span>(opt) != m_args.<span class="built_in">end</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> OPT_OPTIONAL:</span><br><span class="line">        <span class="keyword">case</span> OPT_REQUIRED:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">Value</span>(m_args[opt]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Value</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility/option.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::utility;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 短参数测试</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Option opt;</span><br><span class="line">    opt.<span class="built_in">add</span>(<span class="string">&quot;a&quot;</span>, Option::OPT_NO);</span><br><span class="line">    opt.<span class="built_in">add</span>(<span class="string">&quot;b&quot;</span>, Option::OPT_REQUIRED);</span><br><span class="line">    opt.<span class="built_in">add</span>(<span class="string">&quot;c&quot;</span>, Option::OPT_OPTIONAL);</span><br><span class="line">    opt.<span class="built_in">parse</span>(argc, argv);</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> a = opt.<span class="built_in">get</span>(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">    <span class="type">int</span> b = opt.<span class="built_in">get</span>(<span class="string">&quot;b&quot;</span>);</span><br><span class="line">    string c = opt.<span class="built_in">get</span>(<span class="string">&quot;c&quot;</span>);</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;a = &quot;</span> &lt;&lt; a &lt;&lt; <span class="string">&quot;, b = &quot;</span> &lt;&lt; b &lt;&lt; <span class="string">&quot;, c = &quot;</span> &lt;&lt; c &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> C++后端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>命令行参数解析</title>
      <link href="/2024/04/07/%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8F%82%E6%95%B0%E8%A7%A3%E6%9E%90/"/>
      <url>/2024/04/07/%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8F%82%E6%95%B0%E8%A7%A3%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<p>作为程序员，在日常开发中经常使用Linux命令行：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">返回上一级目录</span></span><br><span class="line">cd ..</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看nodejs版本</span></span><br><span class="line">node --version</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看网络端口</span></span><br><span class="line">netstat -a -n</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">文件拷贝</span></span><br><span class="line">cp -rf 源文件 目标文件</span><br></pre></td></tr></table></figure><h1 id="命令行选项参数">命令行选项参数</h1><p>命令行选项参数分为短参数和长参数。</p><h2 id="短参数">短参数</h2><p>最常用的参数形式就是一个短横线后接一个字母，例如：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">command -a</span><br></pre></td></tr></table></figure><p>如果要一次加好几个短参数，可以用空格隔开，例如：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">command -a -b -C -c</span><br></pre></td></tr></table></figure><p>多个短参数也可以合并在一起，例如上面的命令等价于：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">command -abCc</span><br></pre></td></tr></table></figure><p>注意：参数的字母大小写是有区别的，大写的<code>C</code>和小写的<code>c</code>通常表示不同的意思。</p><p>有一些参数还需要给它赋一个值才行，例如短参数赋值：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">command -p 10</span><br></pre></td></tr></table></figure><p>表示把<code>10</code>赋值给参数<code>p</code>。</p><h2 id="长参数">长参数</h2><p>短参数是以一个短横线<code>-</code>开始，而长参数是以两个短横线<code>--</code>开始的，例如：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">command --parameter</span><br></pre></td></tr></table></figure><p>如果有多个长参数，是不能像多个短参数那样合并写的。只能以空格隔开写，例如：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">command --parameter1 --parameter2</span><br></pre></td></tr></table></figure><p>长参数一般是这样赋值的：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">command --parameter=10</span><br><span class="line">command --parameter 10</span><br></pre></td></tr></table></figure><p>也可以组合使用短参数和长参数，例如：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">command -paTc --parameter1 --parameter2</span><br></pre></td></tr></table></figure><p>有时候，同一个意义的参数有短参数和长参数两种形式，效果是一样的，可以任选其中一种。看起来长参数的方式更加容易理解，但是不如短参数那么简洁。</p><h1 id="c库解析命令行参数">C库解析命令行参数</h1><h2 id="短参数解析：getopt">短参数解析：getopt</h2><h3 id="函数定义">函数定义</h3><p><code>getopt()</code>可以解析短参数，但它不能解析长参数，所谓短参数就是指选项前只有一个<code>-</code>（比如<code>-t</code>）。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* 参数说明:</span></span><br><span class="line"><span class="comment">* argc: 通常为 main 函数中的 argc</span></span><br><span class="line"><span class="comment">* argv: 通常为 main 函数中的 argv</span></span><br><span class="line"><span class="comment">* optstring: 短参数列表 (如:&quot;ab:c::&quot;)，它由多个部分组成，表示的意义分别为：</span></span><br><span class="line"><span class="comment">* * 不带值的参数，它的定义即是参数本身，表示选项。</span></span><br><span class="line"><span class="comment">* * 必须带值的参数，它的定义是在参数本身后面再加一个冒号。</span></span><br><span class="line"><span class="comment">* * 单个字符后跟两个冒号，表示该选项后可以跟一个参数，也可以不跟。</span></span><br><span class="line"><span class="comment">* 如果跟一个参数，参数必须紧跟在选项后不能以空格隔开。该参数的指针赋给optarg。</span></span><br><span class="line"><span class="comment">*/</span> </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">getopt</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *<span class="type">const</span> *argv, <span class="type">const</span> <span class="type">char</span> *optstring)</span></span>;</span><br></pre></td></tr></table></figure><h3 id="格式说明">格式说明</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> *optstring = <span class="string">&quot;ab:c::&quot;</span>;</span><br></pre></td></tr></table></figure><table><thead><tr><th>格式</th><th>含义</th><th>示例</th></tr></thead><tbody><tr><td>单个字符a</td><td>表示选项a没有参数</td><td>格式：-a即可，不加参数</td></tr><tr><td>单个字符加冒号b:</td><td>表示选项b有且必须加参数</td><td>格式：-b 100 或 -b100，但 -b=100 错</td></tr><tr><td>单字符加两个冒号c::</td><td>表示选项c可以有，也可以无</td><td>格式：-c 或 -c200，其它格式错误</td></tr></tbody></table><h3 id="返回值">返回值</h3><p>如果选项成功找到，返回选项字母（字母对应的ASCII码）；如果所有命令行选项都解析完毕，返回<code>-1</code>；</p><p>如果遇到选项字符不在<code>optstring</code>中，返回字符<code>?</code>；</p><p>如果遇到丢失参数，那么返回值依赖于<code>optstring</code>中第一个字符；</p><p>如果第一个字符是<code>:</code>则返回<code>:</code>，否则返回<code>?</code>并提示出错误信息。</p><h3 id="示例">示例</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> opt = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> a = <span class="number">0</span>, b = <span class="number">0</span>, c = <span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> s1[<span class="number">32</span>] = &#123;<span class="number">0</span>&#125;, s2[<span class="number">32</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">while</span> ((opt = <span class="built_in">getopt</span>(argc, argv, <span class="string">&quot;ab:c::&quot;</span>)) != <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">switch</span> (opt)</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;a&#x27;</span>:</span><br><span class="line">            a = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;b&#x27;</span>:</span><br><span class="line">                b = <span class="number">1</span>;</span><br><span class="line">                <span class="built_in">strcpy</span>(s1, optarg);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;c&#x27;</span>:</span><br><span class="line">                c = <span class="number">1</span>;</span><br><span class="line">                <span class="built_in">strcpy</span>(s2, optarg);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (a == <span class="number">1</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;option a\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (b == <span class="number">1</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;option b:%s\n&quot;</span>, s1);</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">1</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;option c:%s\n&quot;</span>, s2);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意<code>optarg</code>是一个全局变量，它定义在<code>getopt.h</code>头文件中，另外还有三个全局变量<code>optind</code>、<code>optopt</code>和<code>opterr</code>。</p><p>执行命令及输出结果：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">g++ -o main1 main1.cpp</span><br><span class="line">./main1 -a -b jack -c200</span><br><span class="line">option a</span><br><span class="line">option b:jack</span><br><span class="line">option c:200</span><br></pre></td></tr></table></figure><p><code>getopt</code>问题分析：</p><ol><li><p>短参数列表（如：<code>&quot;ab:c::&quot;</code>）不是标准格式，记忆不方便</p></li><li><p>全局变量乱入：<code>optarg</code>、<code>optind</code>、<code>optopt</code>、<code>opterr</code></p></li><li><p>需要分配固定大小的临时字符串数组</p></li></ol><h2 id="长参数：getopt-long">长参数：getopt_long</h2><h3 id="函数定义">函数定义</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">getopt_long</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* <span class="type">const</span> agrv[], <span class="type">const</span> <span class="type">char</span> *optstring, </span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="type">const</span> <span class="keyword">struct</span> option *longopts, <span class="type">int</span> *longindex)</span></span>;</span><br></pre></td></tr></table></figure><h3 id="参数说明">参数说明</h3><p>可以看到比<code>getopt()</code>多了两个参数<code>longopts</code>，<code>logindex</code>。</p><p><code>longopts</code>指明了长参数的名称和属性，可以看到它是一个结构体指针，我们通常传一个结构体数组<br>进去，每个元素代表一个参数，每个参数都是由下面的结构组成</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">option</span> &#123;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *name; <span class="comment">/* 参数名称 */</span></span><br><span class="line"><span class="type">int</span> has_arg; <span class="comment">/* 指明是否带有参数 */</span></span><br><span class="line"><span class="type">int</span> *flag; <span class="comment">/* flag=NULL时,返回value;不为空时,*flag=val,返回0 */</span></span><br><span class="line"><span class="type">int</span> val; <span class="comment">/* 用于指定函数找到选项的返回值(长选项的缩写)或flag非空时指定</span></span><br><span class="line"><span class="comment">&#125;;</span></span><br></pre></td></tr></table></figure><p>如果<code>longindex</code>非空，它指向的变量将记录当前找到参数符合<code>longopts</code>里的第几个元素的描述，即是<code>longopts</code>的下标值</p><h3 id="返回值">返回值</h3><p>对于短选项，返回值同<code>getopt</code>函数；<br>对于长选项，如果<code>flag</code>是<code>NULL</code>，返回<code>val</code>，否则返回<code>0</code>；对于错误情况返回值同<code>getopt</code>函数。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;getopt.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span>&#123;</span><br><span class="line"><span class="type">int</span> opt;</span><br><span class="line"><span class="type">int</span> opt_idx = <span class="number">0</span>;</span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> <span class="title class_">option</span> long_options[] =</span><br><span class="line">    &#123;</span><br><span class="line">            &#123;<span class="string">&quot;reqarg&quot;</span>, required_argument, <span class="literal">NULL</span>, <span class="string">&#x27;r&#x27;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;optarg&quot;</span>, optional_argument, <span class="literal">NULL</span>, <span class="string">&#x27;o&#x27;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;noarg&quot;</span>, no_argument, <span class="literal">NULL</span>, <span class="string">&#x27;n&#x27;</span>&#125;,</span><br><span class="line">        &#123;<span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="number">0</span>&#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">while</span> ((opt = <span class="built_in">getopt_long</span>(argc, argv, <span class="string">&quot;&quot;</span>, long_options, &amp;opt_idx)) != <span class="number">-1</span>)&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;opt = %c\t\t&quot;</span>, opt);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;optarg = %s\t\t&quot;</span>, optarg);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;optind = %d\t\t&quot;</span>, optind);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;argv[optind] = %s\t\t&quot;</span>, argv[optind]);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;option_index = %d\n&quot;</span>, opt_idx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>执行命令及输出结果：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">g++ -o main2 main2.cpp</span><br><span class="line">./main2 --reqarg 100 --optarg=200 --noarg</span><br><span class="line">opt = roptarg = 100optind = 3argv[optind] = --optarg=200option_index = 0</span><br><span class="line">opt = ooptarg = 200optind = 4argv[optind] = --noargoption_index = 1</span><br><span class="line">opt = noptarg = (null)optind = 5argv[optind] = (null)option_index = 2</span><br></pre></td></tr></table></figure><p><code>getopt_long</code>问题分析：到处都是问题。</p><h1 id="实现命令行参数解析">实现命令行参数解析</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">tree -A</span></span><br><span class="line">.</span><br><span class="line">├── CMakeLists.txt</span><br><span class="line">├── main.cpp</span><br><span class="line">└── utility</span><br><span class="line">    ├── option.cpp</span><br><span class="line">    └── option.h</span><br><span class="line"></span><br><span class="line">2 directories, 4 files</span><br></pre></td></tr></table></figure><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CMakeLists.txt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.20</span>)</span><br><span class="line"><span class="keyword">project</span>(<span class="keyword">option</span> CXX)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD <span class="number">11</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 GLOB_RECURSE 递归地查找所有匹配 &quot;utility/*.cpp&quot; 模式的文件</span></span><br><span class="line"><span class="comment"># 将找到的文件列表存储在 SOURCES 变量中</span></span><br><span class="line"><span class="keyword">file</span>(GLOB_RECURSE SOURCES <span class="string">&quot;utility/*.cpp&quot;</span>)</span><br><span class="line"><span class="keyword">add_executable</span>(main <span class="variable">$&#123;SOURCES&#125;</span> main.cpp)</span><br><span class="line"><span class="comment"># 将当前目录 (./) 添加到头文件搜索路径中</span></span><br><span class="line"><span class="keyword">target_include_directories</span>(main PRIVATE .)</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// utility/option.h</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 头文件仅会被引入一次</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdexcept&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> std::string;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 顶级命名空间</span></span><br><span class="line"><span class="keyword">namespace</span> zh</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 二级命名空间</span></span><br><span class="line">    <span class="keyword">namespace</span> utility</span><br><span class="line">    &#123;   </span><br><span class="line">        <span class="comment">// Option类专门负责命令行参数解析，支持解析短参数和长参数</span></span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Option</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="comment">// 定义参数类型</span></span><br><span class="line">            <span class="keyword">enum</span> <span class="title class_">Type</span></span><br><span class="line">            &#123;</span><br><span class="line">                OPT_UNKNOWN = <span class="number">0</span>,        <span class="comment">// 未知类型</span></span><br><span class="line">                OPT_NO,                 <span class="comment">// 无参数</span></span><br><span class="line">                OPT_REQUIRED,           <span class="comment">// 必带参数</span></span><br><span class="line">                OPT_OPTIONAL            <span class="comment">// 可选参数</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">Option</span>() = <span class="keyword">default</span>;</span><br><span class="line">            ~<span class="built_in">Option</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">add</span><span class="params">(<span class="type">const</span> string&amp; opt, Type type)</span></span>;     <span class="comment">// 定义参数名称和参数类型</span></span><br><span class="line">            <span class="function">Type <span class="title">type</span><span class="params">(<span class="type">const</span> string&amp; opt)</span> <span class="type">const</span></span>;         <span class="comment">// 获取某个参数的类型</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">parse</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span>;         <span class="comment">// 命令行参数解析，argc和argv都是main函数带入的</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">show</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">has</span><span class="params">(<span class="type">const</span> string&amp; opt)</span> <span class="type">const</span></span>;          <span class="comment">// 命令行中有无该参数</span></span><br><span class="line">            <span class="function"><span class="type">bool</span> <span class="title">get_bool</span><span class="params">(<span class="type">const</span> string&amp; opt)</span> <span class="type">const</span></span>;     <span class="comment">// 有没有出现这个无参的参数</span></span><br><span class="line">            <span class="function"><span class="type">int</span> <span class="title">get_int</span><span class="params">(<span class="type">const</span> string&amp; opt)</span> <span class="type">const</span></span>;</span><br><span class="line">            <span class="function">string <span class="title">get_string</span><span class="params">(<span class="type">const</span> string&amp; opt)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            std::map&lt;string, Type&gt; m_opts;          <span class="comment">// 保存参数名称和其参数类型关系</span></span><br><span class="line">            std::map&lt;string, string&gt; m_args;        <span class="comment">// 保存参数名称和其参数值</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// utility/option.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility/option.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::utility;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Option::add</span><span class="params">(<span class="type">const</span> string&amp; opt, Type type)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    m_opts[opt] = type;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Option::Type <span class="title">Option::type</span><span class="params">(<span class="type">const</span> string&amp; opt)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> it = m_opts.<span class="built_in">find</span>(opt);</span><br><span class="line">    <span class="keyword">if</span> (it == m_opts.<span class="built_in">end</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> OPT_UNKNOWN;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> it-&gt;second;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Option::parse</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 命令行中第0个元素是可执行文件</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; argc; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        string arg = argv[i];</span><br><span class="line">        <span class="keyword">if</span> (arg.<span class="built_in">substr</span>(<span class="number">0</span>, <span class="number">1</span>) != <span class="string">&quot;-&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 如果不是选项参数而是普通参数，则直接忽略</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (arg.<span class="built_in">substr</span>(<span class="number">0</span>, <span class="number">2</span>) == <span class="string">&quot;--&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 长参数解析</span></span><br><span class="line">            string str = arg.<span class="built_in">substr</span>(<span class="number">2</span>);</span><br><span class="line">            <span class="keyword">auto</span> pos = str.<span class="built_in">find</span>(<span class="string">&#x27;=&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> (pos != std::string::npos)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 出现等号，表明参数可能是必选参数，也可能是可选参数</span></span><br><span class="line">                <span class="comment">// 提取出参数名称和参数值</span></span><br><span class="line">                string opt = str.<span class="built_in">substr</span>(<span class="number">0</span>, pos);</span><br><span class="line">                string val = str.<span class="built_in">substr</span>(pos + <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">switch</span> (<span class="built_in">type</span>(opt))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">case</span> OPT_NO:</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">// 长参数中出现等号，但参数类型是无参数，不匹配</span></span><br><span class="line">                        <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;no argument option: &quot;</span> + opt);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">case</span> OPT_OPTIONAL:</span><br><span class="line">                    <span class="keyword">case</span> OPT_REQUIRED:</span><br><span class="line">                    &#123;</span><br><span class="line">                        m_args[opt] = val;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 没有出现等号</span></span><br><span class="line">                <span class="keyword">switch</span> (<span class="built_in">type</span>(str))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">case</span> OPT_NO:</span><br><span class="line">                    <span class="keyword">case</span> OPT_OPTIONAL:</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">// 长参数如果是可选参数，如果有值则必须有等号，中间不可能有空格隔开</span></span><br><span class="line">                        m_args[str] = <span class="string">&quot;&quot;</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">case</span> OPT_REQUIRED:</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">// 长参数如果是必选参数，则其后面会跟上参数值，先检查一下避免越界</span></span><br><span class="line">                        <span class="keyword">if</span> (i + <span class="number">1</span> &gt; argc)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;option required argument: &quot;</span> + str);</span><br><span class="line">                        &#125;</span><br><span class="line">                        string val = argv[i + <span class="number">1</span>];</span><br><span class="line">                        <span class="keyword">if</span> (val.<span class="built_in">substr</span>(<span class="number">0</span>, <span class="number">1</span>) == <span class="string">&quot;-&quot;</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="comment">// 如果表示参数值的字符串中出现&#x27;-&#x27;，则说明其为另一个参数的名称，逻辑出错</span></span><br><span class="line">                            <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;option missing argument: &quot;</span> + str);</span><br><span class="line">                        &#125;</span><br><span class="line">                        m_args[str] = val;</span><br><span class="line">                        i++;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        <span class="keyword">break</span>; </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 短参数解析</span></span><br><span class="line">            <span class="comment">// 将短参数提取出来</span></span><br><span class="line">            string opt = arg.<span class="built_in">substr</span>(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">switch</span> (<span class="built_in">type</span>(opt))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">case</span> OPT_NO:</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (arg.<span class="built_in">length</span>() &gt;= <span class="number">2</span>)&#123;</span><br><span class="line">                        <span class="comment">// 出现多个短参数合并(-ab)</span></span><br><span class="line">                        <span class="keyword">for</span> (<span class="type">int</span> k = <span class="number">1</span>; k &lt; arg.<span class="built_in">length</span>(); k++)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="function">string <span class="title">o</span><span class="params">(<span class="number">1</span>, arg[k])</span></span>;</span><br><span class="line">                            <span class="keyword">if</span> (<span class="built_in">type</span>(o) != OPT_NO)</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="keyword">continue</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            m_args[o] = <span class="string">&quot;&quot;</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">case</span> OPT_OPTIONAL:</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 如果长度大于2则该短参数可选参数值是带有值的(-cjack)，长度等于2则该短参数是不带参数值的</span></span><br><span class="line">                    <span class="keyword">if</span> (arg.<span class="built_in">length</span>() &gt; <span class="number">2</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        m_args[opt] = arg.<span class="built_in">substr</span>(<span class="number">2</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        m_args[opt] = <span class="string">&quot;&quot;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">case</span> OPT_REQUIRED:</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 先检查下一个参数是否会数组越界</span></span><br><span class="line">                    <span class="keyword">if</span> (i + <span class="number">1</span> &gt;= argc)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;option required argument: &quot;</span> + opt);</span><br><span class="line">                    &#125;</span><br><span class="line">                    string val = argv[i + <span class="number">1</span>];</span><br><span class="line">                    <span class="keyword">if</span> (val.<span class="built_in">substr</span>(<span class="number">0</span>, <span class="number">1</span>) == <span class="string">&quot;-&quot;</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;option missing argument: &quot;</span> + opt);</span><br><span class="line">                    &#125;</span><br><span class="line">                    m_args[opt] = val;</span><br><span class="line">                    i++;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Option::show</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; pair : m_args)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; pair.first &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; pair.second &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Option::has</span><span class="params">(<span class="type">const</span> string&amp; opt)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> it = m_opts.<span class="built_in">find</span>(opt);</span><br><span class="line">    <span class="keyword">if</span> (it == m_opts.<span class="built_in">end</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> m_args.<span class="built_in">find</span>(opt) != m_args.<span class="built_in">end</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Option::get_bool</span><span class="params">(<span class="type">const</span> string&amp; opt)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_args.<span class="built_in">find</span>(opt) != m_args.<span class="built_in">end</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Option::get_int</span><span class="params">(<span class="type">const</span> string&amp; opt)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> it = m_args.<span class="built_in">find</span>(opt);</span><br><span class="line">    <span class="keyword">if</span> (it == m_args.<span class="built_in">end</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> value = <span class="number">0</span>;</span><br><span class="line">    std::stringstream ss;</span><br><span class="line">    ss &lt;&lt; it-&gt;second;</span><br><span class="line">    ss &gt;&gt; value;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">string <span class="title">Option::get_string</span><span class="params">(<span class="type">const</span> string&amp; opt)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> it = m_args.<span class="built_in">find</span>(opt);</span><br><span class="line">    <span class="keyword">if</span> (it == m_args.<span class="built_in">end</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> it-&gt;second;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility/option.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> zh::utility;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Option opt;</span><br><span class="line">    opt.<span class="built_in">add</span>(<span class="string">&quot;a&quot;</span>, Option::OPT_NO);</span><br><span class="line">    opt.<span class="built_in">add</span>(<span class="string">&quot;b&quot;</span>, Option::OPT_REQUIRED);</span><br><span class="line">    opt.<span class="built_in">add</span>(<span class="string">&quot;c&quot;</span>, Option::OPT_OPTIONAL);</span><br><span class="line"></span><br><span class="line">    opt.<span class="built_in">parse</span>(argc, argv);</span><br><span class="line">    opt.<span class="built_in">show</span>();</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> a = opt.<span class="built_in">get_bool</span>(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">    <span class="type">int</span> b = opt.<span class="built_in">get_int</span>(<span class="string">&quot;b&quot;</span>);</span><br><span class="line">    string c = opt.<span class="built_in">get_string</span>(<span class="string">&quot;c&quot;</span>);</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;a = &quot;</span> &lt;&lt; a &lt;&lt; <span class="string">&quot;, b = &quot;</span> &lt;&lt; b &lt;&lt; <span class="string">&quot;, c = &quot;</span> &lt;&lt; c &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./build/main -a -b 123 -cjack</span></span><br><span class="line">a:</span><br><span class="line">b:123</span><br><span class="line">c:jack</span><br><span class="line">a = 1, b = 123, c = jack</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> C++后端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Leetcode 146 LRU缓存机制</title>
      <link href="/2024/04/01/Leetcode-146/"/>
      <url>/2024/04/01/Leetcode-146/</url>
      
        <content type="html"><![CDATA[<p><a href="https://leetcode.cn/problems/lru-cache/description/">146. LRU缓存 - 力扣（LeetCode）</a></p><h2 id="算法">算法</h2><h4 id="双链表-哈希表-o-1">(双链表+哈希表) <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span></h4><p>可以使用哈希表来维护整个缓存，哈希表增删改查时间复杂度都是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span>的，这样使得<code>put</code>和<code>get</code>操作的时间复杂度为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span>。为了实现最近最少使用的缓存淘汰机制，还得使用双链表作为一个队列，每次用到一个节点就先将它从双链表中删掉，然后再将它插入到双链表最左侧，如果缓存不够时就将最右侧节点淘汰掉即可。为了方便，双链表的头尾使用虚拟节点，每个节点中除了前后指针外存储<code>key</code>和<code>value</code>，哈希表用于将<code>key</code>映射至双链表中对应节点地址。<br><code>put(key,valye)</code>：首先用哈希表判断<code>key</code>是否存在：如果<code>key</code>存在，则修改对应的<code>value</code>，同时将<code>key</code>对应的节点放到双链表的最左侧；如果<code>key</code>不存在且缓存已满，则删除双链表最右侧的节点(上次使用时间最老的节点)并更新哈希表，然后在双链表最左侧插入<code>(key,value)</code>节点并更新哈希表；否则<code>key</code>不存在且缓存未满，此时直接在双链表最左侧插入<code>(key, value)</code>节点，同时更新哈希表。<br><code>get(key)</code>：首先用哈希表判断<code>key</code>是否存在：如果<code>key</code>存在，则返回对应的<code>value</code>，同时将<code>key</code>对应的节点放到双链表的最左侧；如果<code>key</code>不存在，则返回<code>-1</code>。</p><h4 id="时间复杂度">时间复杂度</h4><p>双链表和哈希表的增删改查操作的时间复杂度都是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span>，所以<code>put</code>和<code>get</code>操作的时间复杂度也都是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span>。</p><h4 id="空间复杂度">空间复杂度</h4><p>使用了双链表和哈希表，空间复杂度为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mclose">)</span></span></span></span>。</p><h2 id="c-代码">C++代码</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LRUCache</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">Node</span>&#123;</span><br><span class="line">        <span class="type">int</span> key, val;</span><br><span class="line">        Node* left, *right;</span><br><span class="line">        <span class="built_in">Node</span>(<span class="type">int</span> k, <span class="type">int</span> v) : <span class="built_in">key</span>(k), <span class="built_in">val</span>(v), <span class="built_in">left</span>(<span class="literal">nullptr</span>), <span class="built_in">right</span>(<span class="literal">nullptr</span>)&#123;&#125;</span><br><span class="line">    &#125;*L, *R;</span><br><span class="line">    unordered_map&lt;<span class="type">int</span>, Node*&gt; hash;</span><br><span class="line">    <span class="type">int</span> n;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">remove</span><span class="params">(Node* p)</span></span>&#123;</span><br><span class="line">        p-&gt;left-&gt;right = p-&gt;right;</span><br><span class="line">        p-&gt;right-&gt;left = p-&gt;left;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">insert</span><span class="params">(Node* p)</span></span>&#123;</span><br><span class="line">        p-&gt;left = L;</span><br><span class="line">        p-&gt;right = L-&gt;right;</span><br><span class="line">        p-&gt;right-&gt;left = p;</span><br><span class="line">        L-&gt;right = p;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">LRUCache</span>(<span class="type">int</span> capacity) &#123;</span><br><span class="line">        n = capacity;</span><br><span class="line">        L = <span class="keyword">new</span> <span class="built_in">Node</span>(<span class="number">-1</span>, <span class="number">-1</span>), R = <span class="keyword">new</span> <span class="built_in">Node</span>(<span class="number">-1</span>, <span class="number">-1</span>);</span><br><span class="line">        L-&gt;right = R, R-&gt;left = L;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">get</span><span class="params">(<span class="type">int</span> key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!hash.<span class="built_in">count</span>(key))</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        Node* p = hash[key];</span><br><span class="line">        <span class="built_in">remove</span>(p);</span><br><span class="line">        <span class="built_in">insert</span>(p);</span><br><span class="line">        <span class="keyword">return</span> p-&gt;val;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">put</span><span class="params">(<span class="type">int</span> key, <span class="type">int</span> value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(hash.<span class="built_in">count</span>(key))&#123;</span><br><span class="line">            Node* p = hash[key];</span><br><span class="line">            p-&gt;val = value;</span><br><span class="line">            <span class="built_in">remove</span>(p);</span><br><span class="line">            <span class="built_in">insert</span>(p);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(hash.<span class="built_in">size</span>() == n)&#123;</span><br><span class="line">                Node* p = R-&gt;left;</span><br><span class="line">                <span class="built_in">remove</span>(p);</span><br><span class="line">                hash.<span class="built_in">erase</span>(p-&gt;key);</span><br><span class="line">                <span class="keyword">delete</span> p;</span><br><span class="line">            &#125;</span><br><span class="line">            Node* t = <span class="keyword">new</span> <span class="built_in">Node</span>(key, value);</span><br><span class="line">            <span class="built_in">insert</span>(t);</span><br><span class="line">            hash[key] = t;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Your LRUCache object will be instantiated and called as such:</span></span><br><span class="line"><span class="comment"> * LRUCache* obj = new LRUCache(capacity);</span></span><br><span class="line"><span class="comment"> * int param_1 = obj-&gt;get(key);</span></span><br><span class="line"><span class="comment"> * obj-&gt;put(key,value);</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 数据结构与算法 </category>
          
          <category> Leetcode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Leetcode </tag>
            
            <tag> 哈希表 </tag>
            
            <tag> 双链表 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Effective C++ 3 资源管理</title>
      <link href="/2023/03/13/Effective-C-3-%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/"/>
      <url>/2023/03/13/Effective-C-3-%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/</url>
      
        <content type="html"><![CDATA[<p>C++程序中最常使用的资源就是动态内存（如果分配内存却从来不曾归还它，会导致内存泄露），但内存只是程序员必须管理的众多资源之一。其它常见的资源还包括文件描述符、互斥锁、图形界面中的字型和笔刷、数据库连接以及网络套接字<code>socket</code>。不论哪一种资源，重要的是当你不再使用它时，必须将它归还系统。</p><h2 id="条款13：以对象管理资源">条款13：以对象管理资源</h2><p>以对象管理资源的两个关键点：</p><ol><li><p>获得资源后立刻放进管理对象内</p><p>“以对象管理资源”的观念常被称为“资源取得时机便是初始化时机”(<em>Resource Acquisition Is Initialization, RAII</em>)，因为程序员几乎总是在获得一笔资源后于同一语句内以它初始化某个管理对象。有时获得的资源被拿来赋值（而非初始化）某个管理对象，但不论哪一种做法，每一笔资源都在获得的同时立刻被放进管理对象中。</p></li><li><p>管理对象运用析构函数确保资源被释放</p><p>不论控制流如何离开区块，一旦对象被销毁（例如当对象离开作用域）其析构函数自然会被自动调用，于是资源被释放。</p></li></ol><p>一句话概括就是：为防止资源泄露，请使用<em>RAII</em>对象，它们在构造函数中获得资源并在析构函数中释放资源。</p><h2 id="条款14：在资源管理类中小心拷贝行为">条款14：在资源管理类中小心拷贝行为</h2><p>当一个<em>RAII</em>对象被复制时，程序员一般有两种策略可供选择：</p><ol><li><p><strong>禁止复制</strong></p><p>许多时候允许<em>RAII</em>对象被复制并不合理，如果复制动作对<em>RAII</em>类并不合理，程序员便应该禁止它。将拷贝操作声明为<code>private</code>但故意不实现它，或者将拷贝操作声明为<code>=delete</code>。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Lock</span> : <span class="keyword">private</span> UnCopyable&#123;<span class="comment">// 禁止复制</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li><li><p><strong>对底层资源使用引用计数法</strong></p><p>有时程序员希望保有资源，直到它的最后一个使用者（某对象）被销毁。这种情况下复制<em>RAII</em>对象时，应将该资源的“被引用数”递增。</p></li></ol><h2 id="条款15：在资源管理类中提供对原始资源的访问">条款15：在资源管理类中提供对原始资源的访问</h2><p>APIs往往要求访问原始资源，所以每一个RAII类应该提供一个“取得其所管理之资源”的方法。对原始资源的访问可能经由显示转换<code>get()</code>或隐式转换（类型转换运算符），一般而言显示转换比较安全，但隐式转换对客户比较方便。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Font</span>&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ...</span><br><span class="line">    <span class="function">FontHandle <span class="title">get</span><span class="params">()</span> <span class="type">const</span></span>&#123;<span class="keyword">return</span> f;&#125;<span class="comment">// 显示转换函数</span></span><br><span class="line">    ...</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">operator</span> <span class="title">FontHandle</span><span class="params">()</span> <span class="type">const</span></span>&#123;<span class="comment">// 隐式转换函数</span></span><br><span class="line">        <span class="keyword">return</span> f;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    FontHandle f;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="条款16：成对使用new和delete时要采用相同形式">条款16：成对使用new和delete时要采用相同形式</h2><p>当程序员使用<code>new</code>，也就是通过<code>new</code>动态生成一个对象时，有两件事发生：第一，内存被分配出来（通过<code>operator new</code>函数）；第二，针对此内存会有一个或多个构造函数被调用。</p><p>当使用<code>delete</code>时，也有两件事发生：针对此内存会有一个或更多析构函数被调用，然后内存才被释放（通过<code>operator delete</code>函数）。<code>delete</code>的最大问题在于：即将被删除的内存之内究竟有多少个对象？这个问题的答案决定了有多少个析构函数必须被调用起来。</p><p>这个问题的本质在于：即将被删除的那个指针，所指的是单一对象或对象数组？单一对象的内存布局一般而言不同于数组的内存布局，因为数组所用的内存通常还包括“数组大小”的记录，以便<code>delete</code>知道需要调用多少次析构函数；而单一对象的内存则没有这笔记录。</p><p>当程序员对着一个指针使用<code>delete</code>，唯一能让<code>delete</code>知道内存中是否存在一个“数组大小记录”的办法就是由程序员告诉它。如果使用<code>delete</code>时加上方括号，<code>delete</code>便认定指针指向一个数组，否则它便认定指针指向单一对象。</p><p>因此：如果在<code>new</code>表达式中使用<code>[]</code>，必须在相应的<code>delete</code>表达式中也使用<code>[]</code>。如果在<code>new</code>表达式中不使用<code>[]</code>，一定不要在相应的<code>delete</code>表达式中使用<code>[]</code>。</p><h2 id="条款17：以独立语句将newed对象置入智能指针">条款17：以独立语句将newed对象置入智能指针</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">processWidget</span>(std::<span class="built_in">shared_ptr</span>&lt;Widget&gt;(<span class="keyword">new</span> Widget), <span class="built_in">priority</span>());</span><br></pre></td></tr></table></figure><p>编译器产出一个<code>processWidget</code>调用码之前，必须首先核算即将被传递的实参。上述第二实参只是单纯地对<code>priority</code>函数的调用，但第一实参<code>std::shared_ptr&lt;Widget&gt;(new Widget)</code>由两部分组成：</p><ol><li>执行<code>new Widget</code>表达式</li><li>调用<code>std::shared_ptr</code>构造函数</li></ol><p>于是在调用<code>processWidget</code>之前，编译器必须创建代码来做以下三件事：</p><ol><li>调用<code>priority</code></li><li>执行<code>new Widget</code></li><li>调用<code>std::shared_ptr</code>构造函数</li></ol><p>但是C++编译器可以以非常弹性的次序完成这些事情，可以确定是<code>new Widget</code>一定执行于<code>std::shared_ptr</code>构造函数调用之前，因为这个表达式的结果还要被传递作为<code>std::shared_ptr</code>构造函数的一个实参，但对<code>priority</code>的调用可以排在第一或第二或第三执行。如果编译器因为生成了更高效的代码而以第二顺位执行它，最终获得这样的操作序列：</p><ol><li>执行<code>new Widget</code></li><li>调用<code>priority</code></li><li>调用<code>std::shared_ptr</code>构造函数</li></ol><p>此时，一旦对<code>priority</code>的调用发生异常，那么<code>new Widget</code>返回的指针将会遗失，因为它还尚未被置入<code>std::shared_ptr</code>内！即在对<code>processWidget</code>的调用过程中可能引发资源泄露，因为在“资源创建（<code>new Widget</code>）”和“资源被转换为资源管理对象”两个时间点之间可能发生异常干扰。</p><p>由于编译器对于“跨越语句的各项操作”没有重新排列的自由（只有在语句内它才拥有那个自由度），避免这类问题的方法很简单：使用分离语句分别写出1.创建<code>Widget</code>；2.将它置入一个智能指针内，然后再把那个智能指针传给<code>processWidget</code>：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::shared_ptr&lt;Widget&gt; <span class="title">pw</span><span class="params">(<span class="keyword">new</span> Widget)</span></span>;</span><br><span class="line"><span class="built_in">processWidget</span>(pw, <span class="built_in">priority</span>());</span><br></pre></td></tr></table></figure><p>在上述修订后的代码内，“<code>new Widget</code>”表达式以及“对<code>std::shared_ptr</code>构造函数的调用”这两个动作，和“对<code>priority</code>的调用”是分隔开的，位于不同语句内，所以编译器不得在它们之间任意选择执行次序。</p><p>因此，以独立语句将<code>newed</code>对象存储于（置入）智能指针内。如果不这样做，一旦异常被抛出，有可能导致难以察觉的资源泄露！</p>]]></content>
      
      
      
        <tags>
            
            <tag> C++ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Effective C++ 2.构造、析构和赋值运算</title>
      <link href="/2023/03/07/Effective-C-2-%E6%9E%84%E9%80%A0%E3%80%81%E6%9E%90%E6%9E%84%E5%92%8C%E8%B5%8B%E5%80%BC%E8%BF%90%E7%AE%97/"/>
      <url>/2023/03/07/Effective-C-2-%E6%9E%84%E9%80%A0%E3%80%81%E6%9E%90%E6%9E%84%E5%92%8C%E8%B5%8B%E5%80%BC%E8%BF%90%E7%AE%97/</url>
      
        <content type="html"><![CDATA[<h2 id="条款05：-了解c-默默编写并调用哪些函数">条款05： 了解C++默默编写并调用哪些函数</h2><p>如果程序员没有声明，编译器就会为它声明（编译器版本的）一个拷贝构造函数、一个拷贝赋值运算符和一个析构函数。此外，如果没有声明任何构造函数，编译器也会为你声明一个默认构造函数。所有这些函数都是<code>public</code>且<code>inline</code>的。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 因此，如果写下:</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Empty</span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这就好像你写下这样的代码:</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Empty</span>&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Empty</span>()&#123;...&#125;<span class="comment">// 默认构造函数</span></span><br><span class="line">    <span class="built_in">Empty</span>(<span class="type">const</span> Empty&amp; rhs)&#123;...&#125;<span class="comment">// 拷贝构造函数</span></span><br><span class="line">    ~<span class="built_in">Empty</span>()&#123;...&#125;<span class="comment">// 析构函数</span></span><br><span class="line">    Empty&amp; <span class="keyword">operator</span>=(<span class="type">const</span> Empty&amp; rhs)&#123;...&#125;<span class="comment">// 拷贝赋值运算符</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>惟有当这些函数被需要（被调用），它们才会被编译器创建出来。</p><p>需要特别注意：编译器产出的析构函数是非<code>virtual</code>的，除非这个类的基类自身声明有<code>virtual</code>析构函数！</p><p>至于拷贝构造函数和拷贝赋值运算符，编译器创建的版本只是单纯地将来源对象的每一个非静态成员变量拷贝到目标对象。</p><p>如果打算在一个内含引用成员的类内支持赋值操作，那必须自己定义拷贝赋值运算符；面对内含<code>const</code>成员的类，编译器会拒绝编译那一行赋值动作，因为更改<code>const</code>成员是不合法的；如果某个基类将拷贝赋值运算符声明为<code>private</code>，那么编译器将拒绝为其派生类生成一个拷贝赋值运算符。</p><h2 id="条款06：若不想使用编译器自动生成的函数-就该明确拒绝">条款06：若不想使用编译器自动生成的函数，就该明确拒绝</h2><p>在C++ 11标准下，可以通过将拷贝构造函数和拷贝赋值运算符定义为<code>=delete</code>来阻止拷贝。删除的函数就是虽然程序员声明了它们，但不能以任何方式使用它们，在函数的参数列表后面加上<code>=delete</code>来指出希望将它定义为删除的。</p><p>为了阻止拷贝构造函数和拷贝赋值运算符被编译器自动生成，得程序员自行声明它们，可以将拷贝构造函数和拷贝赋值运算符声明为<code>private</code>，这样阻止人们调用它。**Tips：**可以将成员函数声明为<code>private</code>而且故意不实现它们。</p><p>也可以设计一个专门阻止拷贝动作的基类，基类中将拷贝构造函数和拷贝赋值运算符声明为<code>private</code>：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Uncopyable</span>&#123;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="built_in">Uncopyable</span>()&#123;&#125;<span class="comment">// 允许派生类对象构造和析构</span></span><br><span class="line">    ~<span class="built_in">Uncopyable</span>()&#123;&#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">Uncopyable</span>(<span class="type">const</span> Uncopyable&amp;);<span class="comment">// 声明为private但故意不实现就是为了阻止拷贝 </span></span><br><span class="line">    Uncopyable&amp; <span class="keyword">operator</span>=(<span class="type">const</span> Uncopyable&amp;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为了阻止HomeForSale对象被拷贝，唯一需要做的就是继承Uncopyable</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HomeForSale</span> : <span class="keyword">private</span> Uncopyable&#123;</span><br><span class="line">...  </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="条款07：为多态基类声明virtual析构函数">条款07：为多态基类声明virtual析构函数</h2><p>C++明白指出，当派生类对象经由一个基类指针被删除，而该基类带着一个非虚析构函数，其结果未有定义——实际执行时通常发生的是对象的派生类成分没被销毁，即派生类的析构函数未能执行起来导致派生类成员很可能没被销毁，然后其基类成分通常会被销毁，于是造成一个诡异的“局部销毁”对象，造成内存泄露。</p><p>消除该问题的做法是：给基类一个虚析构函数，此后删除派生类对象就会正常，它会销毁整个对象，包括派生类成分。</p><p>虚表指针<em>vptr</em>指向一个由函数指针构成的数组，称为虚函数表<em>vtbl</em>：每一个带有虚函数的类都有一个相应的虚函数表。当对象调用某一虚函数时，实际被调用的函数取决于该对象的虚表指针所指的那个虚表——编译器在其中寻找适当的函数指针。</p><p>无端地将所有类的析构函数声明为<code>virtual</code>，就像从未声明它们为<code>virtual</code>一样，都是错误的。最佳工程实践是：只有当类内含至少一个虚函数，程序员才为它声明虚析构函数。</p><p>析构函数的运作方式是，最深层派生的那个类其析构函数最先被调用，然后是其每一个基类的析构函数被调用。</p><h2 id="条款08：别让异常逃离析构函数">条款08：别让异常逃离析构函数</h2><p>只要析构函数吐出异常，即使并非使用容器或<code>arrays</code>，程序也可能过早结束或出现不明确行为。C++不喜欢析构函数吐出异常！</p><p>析构函数绝对不要吐出异常。如果一个被析构函数调用的函数可能抛出异常，析构函数应该捕捉任何异常，然后吞下它们（不传播）或结束程序。</p><p>如果客户需要对某个操作函数运行期间抛出的异常做出反应，那么类应该提供一个普通函数（而非在析构函数中）执行该操作。</p><h2 id="条款09：绝不在构造和析构过程中调用虚函数">条款09：绝不在构造和析构过程中调用虚函数</h2><p>基类构造期间虚函数绝不会下降到派生类阶层，取而代之的是，对象的行为就像隶属于基类类型一样。即在基类构造期间，虚函数不是虚函数。因此程序员应确定类的构造函数和析构函数都没有（在对象被创建和被销毁期间）调用虚函数，而它们中调用的所有函数也都服从同一约束。</p><h2 id="条款10：令operator-返回一个-this的引用">条款10：令<code>operator=</code>返回一个<code>*this</code>的引用</h2><p>为了实现“连锁赋值”，所有赋值相关的操作符必须返回一个引用指向操作符的左侧实参。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Widget</span>&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ...</span><br><span class="line">    Widget&amp; <span class="keyword">operator</span>=(<span class="type">const</span> Widget&amp; rhs)&#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    Widget&amp; <span class="keyword">operator</span>+=(<span class="type">const</span> Widget&amp; rhs)&#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="条款11：在operator-中处理-自我赋值">条款11：在<code>operator=</code>中处理“自我赋值”</h2><p>“自我赋值”发生在对象被赋值给自己时，虽然这看起来有点愚蠢，但它合法，而且潜在的自我赋值可能不容易被一眼辨识出来。</p><p>一般而言如果某段代码操作指针或引用而它们被用来“指向多个相同类型的对象”，就需考虑这些对象是否为同一个！</p><p>为了阻止“自我赋值”的不安全性错误，传统做法是在<code>operator=</code>最前面安插一个“证同测试”来检验是否“自我赋值”：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Bitmap</span>&#123;...&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Widget</span>&#123;</span><br><span class="line">    ...</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    Bimap* bp;<span class="comment">// 指向一个从堆分配而得的对象</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Widget&amp; Widget::<span class="keyword">operator</span>=(<span class="type">const</span> Widget&amp; rhs)&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span> == &amp;rhs) <span class="comment">// 如果是自我赋值，就不做任何事</span></span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">delete</span> pb;</span><br><span class="line">    pb = <span class="keyword">new</span> <span class="built_in">Bitmap</span>(*rhs.pb);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="条款12：复制对象时勿忘其每一个成分">条款12：复制对象时勿忘其每一个成分</h2><p>当程序员编写一个拷贝函数时，要确保复制所有局部成员变量，并调用基类中合适的拷贝函数来复制所有基类成分！</p><p>不要尝试以某个拷贝函数实现另一个拷贝函数，应将相同部分放进第三个函数中，并由两个拷贝函数 共同调用。比如发现拷贝构造函数和拷贝赋值运算符有相近的代码，消除重复代码的做法是建立一个新的成员函数给两者调用。这样的函数往往是<code>private</code>而且常被命名为<code>init</code>。这个策略可以安全消除拷贝构造函数和拷贝赋值运算符之间的代码重复问题。</p>]]></content>
      
      
      
        <tags>
            
            <tag> C++ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Effective C++ 1.让自己习惯C++</title>
      <link href="/2023/03/01/Effective-C-1-%E8%AE%A9%E8%87%AA%E5%B7%B1%E4%B9%A0%E6%83%AFC/"/>
      <url>/2023/03/01/Effective-C-1-%E8%AE%A9%E8%87%AA%E5%B7%B1%E4%B9%A0%E6%83%AFC/</url>
      
        <content type="html"><![CDATA[<h2 id="条款01：视c-为一个语言联邦">条款01：视C++为一个语言联邦</h2><p>将C++视为一个由相关语言组成的联邦而非单一语言，在其某个次语言中，各种守则与通例都倾向简单、直观易懂、并且容易记住。然后当从一个次语言移往另一个次语言时，守则可能改变，C++总共有4个次语言：C语言；C++面向对象；C++模板；标准模板库STL。</p><p>因此，C++并不是一个带有一组守则的一体语言，它是从四个次语言组成的联邦政府，每个次语言都有自己的规约。记住这四个次语言就会发现C++容易了解得多。</p><h2 id="条款02：尽量以const-enum-inline替换-define">条款02：尽量以const, enum, inline替换#define</h2><ul><li>对于单纯常量，最好以<code>const</code>对象或<code>enums</code>替换<code>#defines</code></li><li>对于形似函数的宏，最好改用<code>template inline</code>函数替换<code>#defines</code></li></ul><h2 id="条款03：尽可能使用const">条款03：尽可能使用const</h2><p>注意：如果被指物是常量，程序员可将关键字<code>const</code>写在类型之前或者类型之后星号之前，两种写法意义相同，所以下列两个函数接受的参数类型是一样的：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">f1</span><span class="params">(<span class="type">const</span> Widget *pw)</span></span>;<span class="comment">// f1获得一个指针，指向一个常量的(不变的)Widget对象</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f2</span><span class="params">(Widget <span class="type">const</span> *pw)</span></span>;<span class="comment">// f2也是</span></span><br></pre></td></tr></table></figure><p>两种形式都有人用，应该试着习惯它们。</p><p>令函数返回一个常量值，往往可以降低因客户错误而造成的意外，而又不至于放弃安全性和高效性。例如将<code>operator*</code>重载函数的返回值声明为<code>const</code>可以预防“没意思的赋值动作”。</p><h3 id="const成员函数">const成员函数</h3><p><code>const</code>作用于成员函数可以使得<code>class</code>接口比较容易理解，因为这样可以得知哪个函数可以改动对象内容而哪个函数不行；它还使“操作<code>const</code>”对象成为可能。改善C++程序效率的一个根本办法是以<em>pass by reference-to-const</em>方式传递对象，此技术的前提是有<code>const</code>成员函数可用来处理取得（并经修饰而成）的<code>const</code>对象。</p><p>注意：两个成员函数如果只是常量性不同（即一个带<code>const</code>而另一个不带），可以被重载。</p><p>真实程序中<code>const</code>对象大多用于<code>passed by pointer-to-const</code>或<code>passed by reference-to-const</code>的传递结果</p><p>当程序员希望能修改类的某个数据成员，即使是在一个<code>const</code>成员函数内，可以通过在成员变量的声明中加入<code>mutable</code>关键字来做到这一点！借助<code>mutable</code>可以释放掉非静态成员变量的<code>bitwise constness</code>约束。</p><h3 id="在const和non-const成员函数中避免重复">在const和non-const成员函数中避免重复</h3><p>为了避免<code>const</code>和<code>non-const operator[]</code>产生代码重复以及伴随的编译时间、维护、代码膨胀等，应该实现<code>operator[]</code>的功能一次并使用它两次。即必须令其中一个<code>non-const operator[]</code>调用另一个<code>const</code>兄弟，这就是<strong>常量性转除</strong>。</p><p>换而言之，当<code>const</code>和非<code>const</code>成员函数有着实质等价的实现时，令非<code>const</code>版本调用<code>const</code>版本可以避免代码重复：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TextBlock</span>&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ...</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>&amp; <span class="keyword">operator</span>[](std::<span class="type">size_t</span> position) <span class="type">const</span>&#123;<span class="comment">// 一如既往</span></span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">return</span> text[position];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">char</span>&amp; <span class="keyword">operator</span>[](std::<span class="type">size_t</span> position)&#123;</span><br><span class="line">        <span class="comment">// 先为*this加上const以调用const op[]，再将const op[]返回值的const转除</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">const_cast</span>&lt;<span class="type">char</span>&amp;&gt;(<span class="built_in">static_cast</span>&lt;<span class="type">const</span> TextBlock&amp;&gt;(*<span class="keyword">this</span>)[position]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>上面示例代码共有两次转型：第一次用来为<code>*this</code>添加<code>const</code>，这使得接下来调用<code>operator[]</code>时得以调用<code>const</code>版本；第二次则是从<code>const operator[]</code>的返回值中移除<code>const</code>。</p><p>注意：<code>const</code>成员函数调用非<code>const</code>成员函数是一种错误行为，因为对象会因此有可能被改动！</p><h2 id="条款04：确定对象被使用前已先被初始化">条款04：确定对象被使用前已先被初始化</h2><p>读取未初始化的值会导致不明确的行为。因此，永远在使用对象之前先将它初始化。</p><p>要为内置类型对象进行手工初始化，因为C++不保证初始化它们。至于内置类型以外的任何其它东西，初始化责任落在构造函数身上。规则很简单：确保每一个构造函数都将对象的每一个成员初始化。</p><p>C++规定，对象的成员变量的初始化动作发生在进入构造函数本体之前，即尽量在初始化列表替换赋值动作，这样通常效率更高。因为对大多数类型而言，比起先调用默认构造函数然后再调用拷贝赋值运算符，单只调用一次拷贝构造函数是比较高效的，有时甚至高效得多。初始化列表中列出的成员变量的排列次序应该和它们在<code>class</code>中声明的次序相同。并且，如果成员变量是<code>const</code>或<code>references</code>，它们就一定需要初值，不能被赋值。</p><p>C++有着十分固定的“成员初始化次序”：基类更早于其派生类被初始化，而类的成员变量总是以其声明次序被初始化，即使它们在初始化列表中以不同的次序出现也不会有任何影响。</p><p>为免除“跨编译单元之初始化次序”问题，请以<code>local static</code>对象替换<code>non-local static</code>对象。</p>]]></content>
      
      
      
        <tags>
            
            <tag> C++ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Effective C++ 导读</title>
      <link href="/2022/12/26/Effective-C-%E5%AF%BC%E8%AF%BB/"/>
      <url>/2022/12/26/Effective-C-%E5%AF%BC%E8%AF%BB/</url>
      
        <content type="html"><![CDATA[<h2 id="术语-terminology">术语(Terminology)</h2><p>​所谓声明式(<em>declaration</em>)是告诉编译器某个东西的名称和类型，但略去细节。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="type">int</span> x;<span class="comment">// 对象声明式</span></span><br><span class="line"><span class="function">std::<span class="type">size_t</span> <span class="title">numDigits</span><span class="params">(<span class="type">int</span> number)</span></span>;<span class="comment">// 函数声明式</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Widget</span>;<span class="comment">// 类声明式</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;<span class="comment">// 模板声明式</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GraphNode</span>;<span class="comment">// &quot;typename&quot;的使用见条款42</span></span><br></pre></td></tr></table></figure><p>​<code>size_t</code>只是一个<code>typedef</code>，是C++计算个数（例如<code>char*-based</code>字符串内的字符个数或STL容器内的元素个数等等）时用的某种不带正负号（<code>unsigned</code>）类型。它也是<code>vector</code>，<code>deque</code>和<code>string</code>内的<code>operator[]</code>函数接受的参数类型。条款3阐述当我们定义自己的<code>operator[]</code>函数时应该遵循的协议。</p><hr><p>​每个函数的声明揭示其签名式(<em>signature</em>)，也就是参数和返回类型。一个函数的签名等同于该函数的类型。</p><p>​定义式(<em>definition</em>)的任务是提供编译器一些声明式所遗漏的细节。对对象而言，定义式是编译器为此对象拨发内存的地点。对于函数或函数模板而言，定义式提供了代码本体。对于类或类模板而言，定义式列出它们的成员。</p><p>​初始化(<em>initialization</em>)是“给予对象初值”的过程。对用户自定义类型的对象而言，初始化由构造函数执行。所谓默认构造函数是一个可被调用而不带任何实参者。这样的构造函数要不没有参数，要不就是每个参数都有缺省值。</p><p>​当类的构造函数被声明为<code>explicit</code>时，这可阻止它们被用来执行隐式类型转换，但它们仍可被用来进行显式类型转换。被声明为<code>explicit</code>的构造函数通常比其<code>non-explicit</code>版本更受欢迎，因为它禁止编译器执行非预期（往往也不被期望）的类型转换。除非有一个好理由允许构造函数被用于隐式类型转换，否则一般将它声明为<code>explicit</code>。</p><p>​拷贝构造函数被用来“以同型对象初始化自我对象”，拷贝赋值运算符被用来“从另一个同型对象中拷贝其值到自我对象”：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Widget</span>&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Widget</span>();<span class="comment">// 默认构造函数</span></span><br><span class="line">    <span class="built_in">Widget</span>(<span class="type">const</span> Widget&amp; rhs);<span class="comment">// 拷贝构造函数</span></span><br><span class="line">    Widget&amp; <span class="keyword">operator</span>=(<span class="type">const</span> Widget&amp; rhs);<span class="comment">// 拷贝赋值运算符</span></span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Widget w1;<span class="comment">// 调用默认构造函数</span></span><br><span class="line"><span class="function">Widget <span class="title">w2</span><span class="params">(w1)</span></span>;<span class="comment">// 调用拷贝构造函数</span></span><br><span class="line">w1 = w2;<span class="comment">// 调用拷贝赋值运算符</span></span><br></pre></td></tr></table></figure><p>​<strong>注意</strong>：当看到赋值符号时请小心，因为<code>=</code>语法也可用来调用拷贝构造函数：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Widget w3 = w2;<span class="comment">// 调用拷贝构造函数！</span></span><br></pre></td></tr></table></figure><p>​拷贝构造很容易和拷贝赋值有所区别：如果一个新对象被定义（例如以上语句中的<code>w3</code>），一定会有个构造函数被调用，不可能调用赋值操作。如果没有新对象被定义（例如前述的<code>w1 = w2</code>语句），就不会有构造函数被调用，那么当然就是赋值操作被调用。</p><p>​拷贝构造函数是一个尤其重要的函数，因为它定义一个对象如何以值传递(<em>passed by value</em>)。以值传递意味着“调用拷贝构造函数”。<strong>注意</strong>：以值传递用户自定义类型通常是个坏主意，以引用传递(<em>passed-by-reference-to-const</em>)往往是比较好的选择，详见条款20。</p><hr><p>​<strong>不明确行为</strong>(<em>undefined behavior</em>)：由于各种因素，某些C++构件的行为没有定义，程序员无法稳定预估运行期会发生什么事。下面两个代码片段就带有“不明确的行为”：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span>* p = <span class="number">0</span>;<span class="comment">// p是个null指针</span></span><br><span class="line">std::cout &lt;&lt; *p;<span class="comment">// 对一个null指针取值会导致不明确行为</span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> name[] = <span class="string">&quot;Darla&quot;</span>;<span class="comment">// name是个数组，大小为6(别忘记最尾端的null)</span></span><br><span class="line"><span class="type">char</span> c = name[<span class="number">10</span>];<span class="comment">// 指针涉及一个无效的数组索引，这将导致不明确行为</span></span><br></pre></td></tr></table></figure><p>​不明确（未定义）行为的结果是不可预期的，很可能让人不愉快！程序会有时执行正常，有时会造成崩坏，有时更产出不正确的结果。应尽量避免不明确行为！</p><p>​程序批注中提到构造函数和析构函数时，有时会使用缩写<em>ctor</em>和<em>dtor</em>。</p><h2 id="命名习惯-naming-conventions">命名习惯(Naming Conventions)</h2><p>​参数<code>lhs</code>和<code>rhs</code>它们分别代表左手端和右手端，常常以它们作为二元操作符函数如<code>operator==</code>和<code>operator*</code>的参数名称。对于成员函数，左侧实参由<code>this</code>指针表现出来，所以有时单独使用参数名称<code>rhs</code>。</p><p>​常将“指向一个<code>T</code>型对象”的指针命名为<code>pt</code>，意思是“pointer to <code>T</code>”。</p><p>​对于引用使用类似习惯：<code>rw</code>可能是个<code>Widget</code>类型的引用，<code>ra</code>则是个<code>Airplane</code>类型的引用。</p><h2 id="关于线程-threading-consideration">关于线程(Threading Consideration)</h2><p>​<strong>线程安全性</strong>(<em>thread safety</em>)是许多程序员要面对的主题！</p><h2 id="tr1和boost">TR1和Boost</h2><p>​TR1(“Technical Report 1”)是一份规范，描述加入C++标准程序库的诸多新机能。这些机能以新的class templates和function templates形式体现，针对的题目有hash tables，reference-counting smart pointers，regular expressions，以及更多。所有的TR1组件都被置于命名空间tr1内，后者嵌套于命名空间std内。</p><p>​Boost是个组织，亦是一个网站(<a href="http://boost.org">http://boost.org</a>)，提供可移植、同行复审、源码开放的C++程序库。大多数TR1机能是以Boost的工作为基础。在编译器厂商于其C++程序库中含入TR1之前，对那些搜寻TR1实现品的开发人员而言，Boost网站可能是第一个逗留点。Boost提供比TR1更多的东西，所以无论如何得了解它。</p>]]></content>
      
      
      
        <tags>
            
            <tag> C++ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Git基础教程</title>
      <link href="/2022/09/13/Git%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/"/>
      <url>/2022/09/13/Git%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<h2 id="git基本概念">git基本概念</h2><ul><li>工作区：仓库的目录。工作区是独立于各个分支的</li><li>暂存区：数据暂时存放的区域，类似于工作区写入版本库前的缓存区。暂存区是独立于各个分支的</li><li>版本库：存放所有已经提交到本地仓库的代码版本</li><li>版本结构：树结构，树中每个节点代表一个代码版本</li></ul><h2 id="git常用命令">git常用命令</h2><ol><li><p><code>git config --global user.name zhanghua</code>：设置全局用户名，信息记录在<code>~/.gitconfig</code>文件中</p></li><li><p><code>git config --global user.email xxx@xxx.com</code>：设置全局邮箱地址，信息记录在<code>~/.gitconfig</code>文件中</p></li><li><p><code>git init</code>：将当前目录配置成git仓库，信息记录在隐藏的<code>.git</code>文件夹中，其中<code>HEAD</code>头指针指向<code>master</code>分支的一个节点</p></li><li><p><code>git add XX</code>：将XX文件添加到暂存区</p><p><code>git add .</code>：将所有待加入暂存区的文件加入暂存区</p></li><li><p><code>git rm --cached XX</code>：将文件从仓库索引目录中删掉</p></li><li><p><code>git commit -m &quot;给自己看的备注信息&quot;</code>：将暂存区的内容提交到当前分支，并将<code>HEAD</code>指针指向该分支最新版本，注意每次<code>commit</code>后暂存区会清空</p></li><li><p><code>git status</code>：查看仓库状态</p></li><li><p><code>git diff XX</code>：查看XX文件相对于暂存区修改了哪些内容</p></li><li><p><code>git log</code>：查看当前分支的所有版本（截止到<code>HEAD</code>指针指向的版本）</p><p><code>git log --pretty=oneline</code>：更简洁地查看当前分支的所有版本</p></li><li><p><code>git reflog</code>：查看HEAD指针的移动历史（包括被回滚的版本）</p></li><li><p><code>git reset --hard HEAD^</code> 或<code> git reset --hard HEAD~</code>：将代码库回滚到上一个版本</p><p><code>git reset --hard HEAD^^</code>：往上回滚两次，以此类推</p><p><code>git reset --hard HEAD~100</code>：往上回滚100个版本</p><p><code>git reset --hard 版本号</code>：回滚到某一特定版本（使用版本号的前7个字母即可）</p></li><li><p><code>git checkout — XX</code>或<code>git restore XX</code>：将XX文件尚未加入暂存区的修改全部撤销（注意：<code>git restore</code>并不是恢复至上一个历史版本，而是恢复至暂存区里存的内容）</p><p><code>git restore --staged XX</code>：将XX文件从暂存区中删除</p></li><li><p><code>git remote add origin git@git.acwing.com:xxx/XXX.git</code>：将本地仓库关联到远程仓库</p></li><li><p><code>git push -u (第一次需要-u以后不需要)</code>：将当前分支推送到远程仓库</p><p><code>git push origin branch_name</code>：将本地的某个分支推送到远程仓库</p></li><li><p><code>git clone git@git.acwing.com:xxx/XXX.git</code>：将远程仓库XXX下载到当前目录下</p></li><li><p><code>git checkout -b branch_name</code>：创建并切换到<code>branch_name</code>这个分支</p><p>注意：暂存区跟分支完全独立，切换分支是不会有多个暂存区的。因此不管在哪个分支上用的都是一个暂存区和工作目录</p></li><li><p><code>git branch</code>：查看所有分支和当前所处分支</p></li><li><p><code>git checkout branch_name</code>：切换到<code>branch_name</code>这个分支</p></li><li><p><code>git merge branch_name</code>：将分支<code>branch_name</code>快速合并到当前分支上</p></li><li><p><code>git branch -d branch_name</code>：删除本地仓库的branch_name分支</p></li><li><p><code>git branch branch_name</code>：创建新分支</p></li><li><p><code>git push --set-upstream origin branch_name</code>：设置本地的<code>branch_name</code>分支对应远程仓库的<code>branch_name</code>分支</p></li><li><p><code>git push -d origin branch_name</code>：删除远程仓库的<code>branch_name</code>分支</p></li><li><p><code>git pull</code>：将远程仓库的当前分支与本地仓库的当前分支合并</p><p><code>git pull origin branch_name</code>：将远程仓库的<code>branch_name</code>分支与本地仓库的当前分支合并</p></li><li><p><code>git branch --set-upstream-to=origin/branch_name1 branch_name2</code>：将远程的<code>branch_name1</code>分支与本地的<code>branch_name2</code>分支对应</p></li><li><p><code>git checkout -t origin/branch_name</code> 将远程的<code>branch_name</code>分支拉取到本地</p></li><li><p><code>git stash</code>：将工作区和暂存区中尚未提交的修改存入栈中</p></li><li><p><code>git stash apply</code>：将栈顶存储的修改恢复到当前分支，但不删除栈顶元素</p></li><li><p><code>git stash drop</code>：删除栈顶存储的修改</p></li><li><p><code>git stash pop</code>：将栈顶存储的修改恢复到当前分支，同时删除栈顶元素</p></li><li><p><code>git stash list</code>：查看栈中所有元素</p></li></ol>]]></content>
      
      
      
        <tags>
            
            <tag> Git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CMU15-213 Data Lab</title>
      <link href="/2022/08/26/CMU15-213-Data-Lab/"/>
      <url>/2022/08/26/CMU15-213-Data-Lab/</url>
      
        <content type="html"><![CDATA[<p>Lab开始前需仔细阅读<code>bits.c</code>注释中的<code>INTEGER CODING RULES</code>内容和<code>FLOATING POINT CODING RULES</code>内容！</p><h1 id="the-puzzles">The Puzzles</h1><h2 id="bitxor">bitXor</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/* </span><br><span class="line"> * bitXor - x^y using only ~ and &amp; </span><br><span class="line"> *   Example: bitXor(4, 5) = 1</span><br><span class="line"> *   Legal ops: ~ &amp;</span><br><span class="line"> *   Max ops: 14</span><br><span class="line"> *   Rating: 1</span><br><span class="line"> */</span><br></pre></td></tr></table></figure><p>首先介绍<strong>德摩根定律</strong>，德摩根定律在离散数学的很多场景里都出现过，它一共有两个关系：</p><ul><li><p>在命题逻辑里，可以这样表示：</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">¬</mi><mo stretchy="false">(</mo><mi>P</mi><mo>∨</mo><mi>Q</mi><mo stretchy="false">)</mo><mo>⇔</mo><mo stretchy="false">(</mo><mi mathvariant="normal">¬</mi><mi>P</mi><mo stretchy="false">)</mo><mo>∧</mo><mo stretchy="false">(</mo><mi mathvariant="normal">¬</mi><mi>Q</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\lnot(P\lor Q) \Leftrightarrow (\lnot P) \wedge (\lnot Q)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">¬</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">Q</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⇔</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">¬</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">¬</span><span class="mord mathdefault">Q</span><span class="mclose">)</span></span></span></span></span></p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">¬</mi><mo stretchy="false">(</mo><mi>P</mi><mo>∧</mo><mi>Q</mi><mo stretchy="false">)</mo><mo>⇔</mo><mo stretchy="false">(</mo><mi mathvariant="normal">¬</mi><mi>P</mi><mo stretchy="false">)</mo><mo>∨</mo><mo stretchy="false">(</mo><mi mathvariant="normal">¬</mi><mi>Q</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\lnot(P\wedge Q) \Leftrightarrow (\lnot P) \lor (\lnot Q)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">¬</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">Q</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⇔</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">¬</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">¬</span><span class="mord mathdefault">Q</span><span class="mclose">)</span></span></span></span></span></p></li><li><p>在集合里可以这样表示：</p></li></ul><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mrow><mi>A</mi><mo>⋃</mo><mi>B</mi></mrow><mo stretchy="true">‾</mo></mover><mo>=</mo><mover accent="true"><mi>A</mi><mo stretchy="true">‾</mo></mover><mo>⋂</mo><mover accent="true"><mi>B</mi><mo stretchy="true">‾</mo></mover></mrow><annotation encoding="application/x-tex">\overline{A \bigcup B} = \overline{A} \bigcap \overline{B}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.8000100000000003em;vertical-align:-0.55001em;"></span><span class="mord overline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.2500000000000004em;"><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span class="mord"><span class="mord mathdefault">A</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop op-symbol large-op" style="position:relative;top:-0.000004999999999977245em;">⋃</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span></span></span><span style="top:-4.220000000000001em;"><span class="pstrut" style="height:3.05em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.55001em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.6000100000000002em;vertical-align:-0.55001em;"></span><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8833300000000001em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">A</span></span></span><span style="top:-3.80333em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop op-symbol large-op" style="position:relative;top:-0.000004999999999977245em;">⋂</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8833300000000001em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05017em;">B</span></span></span><span style="top:-3.80333em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span></span></span></span></span></span></span></span></p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mrow><mi>A</mi><mo>⋂</mo><mi>B</mi></mrow><mo stretchy="true">‾</mo></mover><mo>=</mo><mover accent="true"><mi>A</mi><mo stretchy="true">‾</mo></mover><mo>⋃</mo><mover accent="true"><mi>B</mi><mo stretchy="true">‾</mo></mover></mrow><annotation encoding="application/x-tex">\overline{A \bigcap B} = \overline{A} \bigcup \overline{B}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.8000100000000003em;vertical-align:-0.55001em;"></span><span class="mord overline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.2500000000000004em;"><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span class="mord"><span class="mord mathdefault">A</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop op-symbol large-op" style="position:relative;top:-0.000004999999999977245em;">⋂</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span></span></span><span style="top:-4.220000000000001em;"><span class="pstrut" style="height:3.05em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.55001em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.6000100000000002em;vertical-align:-0.55001em;"></span><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8833300000000001em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">A</span></span></span><span style="top:-3.80333em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop op-symbol large-op" style="position:relative;top:-0.000004999999999977245em;">⋃</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8833300000000001em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05017em;">B</span></span></span><span style="top:-3.80333em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span></span></span></span></span></span></span></span></p><ul><li><p>在布尔代数里可以这样表示：</p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mrow><mi>x</mi><mo>⋅</mo><mi>y</mi></mrow><mo stretchy="true">‾</mo></mover><mo>=</mo><mover accent="true"><mi>x</mi><mo stretchy="true">‾</mo></mover><mo>+</mo><mover accent="true"><mi>y</mi><mo stretchy="true">‾</mo></mover></mrow><annotation encoding="application/x-tex">\overline{x \cdot y} = \overline{x} + \overline{y}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8388899999999999em;vertical-align:-0.19444em;"></span><span class="mord overline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.64445em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span></span></span><span style="top:-3.56445em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.19444em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.71389em;vertical-align:-0.08333em;"></span><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.63056em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">x</span></span></span><span style="top:-3.55056em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.825em;vertical-align:-0.19444em;"></span><span class="mord overline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.63056em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span></span></span><span style="top:-3.55056em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.19444em;"><span></span></span></span></span></span></span></span></span></span></p><p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mrow><mi>x</mi><mo>+</mo><mi>y</mi></mrow><mo stretchy="true">‾</mo></mover><mo>=</mo><mover accent="true"><mi>x</mi><mo stretchy="true">‾</mo></mover><mo>⋅</mo><mover accent="true"><mi>y</mi><mo stretchy="true">‾</mo></mover></mrow><annotation encoding="application/x-tex">\overline{x + y} = \overline{x} \cdot \overline{y}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9777700000000003em;vertical-align:-0.19444em;"></span><span class="mord overline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7833300000000002em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span></span></span><span style="top:-3.7033300000000002em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.19444em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.63056em;vertical-align:0em;"></span><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.63056em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">x</span></span></span><span style="top:-3.55056em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.825em;vertical-align:-0.19444em;"></span><span class="mord overline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.63056em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span></span></span><span style="top:-3.55056em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.19444em;"><span></span></span></span></span></span></span></span></span></span></p></li></ul><p>因此，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>⊕</mo><mi>y</mi><mo>=</mo><mover accent="true"><mi>x</mi><mo stretchy="true">‾</mo></mover><mo>⋅</mo><mi>y</mi><mo>+</mo><mi>x</mi><mo>⋅</mo><mover accent="true"><mi>y</mi><mo stretchy="true">‾</mo></mover><mo>=</mo><mover accent="true"><mrow><mover accent="true"><mrow><mover accent="true"><mi>x</mi><mo stretchy="true">‾</mo></mover><mo>⋅</mo><mi>y</mi></mrow><mo stretchy="true">‾</mo></mover><mo>⋅</mo><mover accent="true"><mrow><mi>x</mi><mo>⋅</mo><mover accent="true"><mi>y</mi><mo stretchy="true">‾</mo></mover></mrow><mo stretchy="true">‾</mo></mover></mrow><mo stretchy="true">‾</mo></mover><mo>=</mo><mover accent="true"><mrow><mo stretchy="false">(</mo><mi>x</mi><mo>+</mo><mover accent="true"><mi>y</mi><mo stretchy="true">‾</mo></mover><mo stretchy="false">)</mo><mo>⋅</mo><mo stretchy="false">(</mo><mover accent="true"><mi>x</mi><mo stretchy="true">‾</mo></mover><mo>+</mo><mi>y</mi><mo stretchy="false">)</mo></mrow><mo stretchy="true">‾</mo></mover><mo>=</mo><mover accent="true"><mrow><mi>x</mi><mo>⋅</mo><mi>y</mi><mo>+</mo><mover accent="true"><mi>x</mi><mo stretchy="true">‾</mo></mover><mo>⋅</mo><mover accent="true"><mi>y</mi><mo stretchy="true">‾</mo></mover></mrow><mo stretchy="true">‾</mo></mover><mo>=</mo><mover accent="true"><mrow><mi>x</mi><mo>⋅</mo><mi>y</mi></mrow><mo stretchy="true">‾</mo></mover><mo>⋅</mo><mover accent="true"><mrow><mover accent="true"><mi>x</mi><mo stretchy="true">‾</mo></mover><mo>⋅</mo><mover accent="true"><mi>y</mi><mo stretchy="true">‾</mo></mover></mrow><mo stretchy="true">‾</mo></mover></mrow><annotation encoding="application/x-tex">x \oplus y = \overline{x} \cdot y + x \cdot \overline{y} = \overline{\overline{\overline{x} \cdot y} \cdot \overline{x \cdot \overline{y}}} = \overline{(x + \overline{y}) \cdot (\overline{x} + y)} = \overline{x \cdot y + \overline{x} \cdot \overline{y}} = \overline{x \cdot y} \cdot \overline{\overline{x} \cdot \overline{y}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⊕</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.63056em;vertical-align:0em;"></span><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.63056em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">x</span></span></span><span style="top:-3.55056em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.7777700000000001em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.44445em;vertical-align:0em;"></span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.825em;vertical-align:-0.19444em;"></span><span class="mord overline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.63056em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span></span></span><span style="top:-3.55056em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.19444em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.225em;vertical-align:-0.19444em;"></span><span class="mord overline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0305600000000001em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord overline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8305600000000001em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.63056em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">x</span></span></span><span style="top:-3.55056em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span></span></span><span style="top:-3.75056em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.19444em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord overline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8305600000000001em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord overline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.63056em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span></span></span><span style="top:-3.55056em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.19444em;"><span></span></span></span></span></span></span></span><span style="top:-3.75056em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.19444em;"><span></span></span></span></span></span></span></span><span style="top:-3.9505600000000003em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.19444em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.2000000000000002em;vertical-align:-0.25em;"></span><span class="mord overline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9500000000000001em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord overline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.63056em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span></span></span><span style="top:-3.55056em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.19444em;"><span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mopen">(</span><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.63056em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">x</span></span></span><span style="top:-3.55056em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span><span style="top:-3.87em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.25em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.0250000000000001em;vertical-align:-0.19444em;"></span><span class="mord overline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8305600000000001em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.63056em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">x</span></span></span><span style="top:-3.55056em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord overline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.63056em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span></span></span><span style="top:-3.55056em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.19444em;"><span></span></span></span></span></span></span></span><span style="top:-3.75056em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.19444em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388899999999999em;vertical-align:-0.19444em;"></span><span class="mord overline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.64445em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span></span></span><span style="top:-3.56445em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.19444em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.0250000000000001em;vertical-align:-0.19444em;"></span><span class="mord overline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8305600000000001em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.63056em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">x</span></span></span><span style="top:-3.55056em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord overline"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.63056em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span></span></span><span style="top:-3.55056em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.19444em;"><span></span></span></span></span></span></span></span><span style="top:-3.75056em;"><span class="pstrut" style="height:3em;"></span><span class="overline-line" style="border-bottom-width:0.04em;"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.19444em;"><span></span></span></span></span></span></span></span></span></p>  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">bitXor</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span> &#123;</span><br><span class="line"><span class="keyword">return</span> ~(x &amp; y) &amp; ~(~x &amp; ~y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="tmin">tmin</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/* </span><br><span class="line"> * tmin - return minimum two&#x27;s complement integer </span><br><span class="line"> *   Legal ops: ! ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span><br><span class="line"> *   Max ops: 4</span><br><span class="line"> *   Rating: 1</span><br><span class="line"> */</span><br></pre></td></tr></table></figure><p>将最高有效位（即符号位）置为1且其余位置为0时为补码表示下的最小整数。</p>  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">tmin</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> &lt;&lt; <span class="number">31</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="istmax">isTmax</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * isTmax - returns 1 if x is the maximum, two&#x27;s complement number,</span><br><span class="line"> *     and 0 otherwise </span><br><span class="line"> *   Legal ops: ! ~ &amp; ^ | +</span><br><span class="line"> *   Max ops: 10</span><br><span class="line"> *   Rating: 1</span><br><span class="line"> */</span><br></pre></td></tr></table></figure><p>当<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">x</span></span></span></span>的符号位为0且其余位全为1时为补码表示的最大值，此时观察可以发现对<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">x</span></span></span></span>加1并取反等于自己。但同时需要注意-1（补码表示为全1）加1取反后也等于自己，这种情况需要排除掉。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">isTmax</span><span class="params">(<span class="type">int</span> x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> !(~(x + <span class="number">1</span>) ^ x) &amp; !!(x + <span class="number">1</span>); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="alloddbits">allOddBits</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/* </span><br><span class="line"> * allOddBits - return 1 if all odd-numbered bits in word set to 1</span><br><span class="line"> *   where bits are numbered from 0 (least significant) to 31 (most significant)</span><br><span class="line"> *   Examples allOddBits(0xFFFFFFFD) = 0, allOddBits(0xAAAAAAAA) = 1</span><br><span class="line"> *   Legal ops: ! ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span><br><span class="line"> *   Max ops: 12</span><br><span class="line"> *   Rating: 2</span><br><span class="line"> */</span><br></pre></td></tr></table></figure><p>先做一个32位的掩码<code>t32</code>，并使其每个字节均为<code>0xAA</code>，即所有奇数位bit均为1。然后先通过<code>x &amp; t32</code>取出<code>x</code>的所有奇数bit位，然后与<code>t32</code>进行异或来判断取出来的结果是否等同<code>t32</code>，等同则说明<code>x</code>的所有奇数位bit均为1。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">allOddBits</span><span class="params">(<span class="type">int</span> x)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> t8 = <span class="number">0xAA</span>;</span><br><span class="line">    <span class="type">int</span> t16 = (t8 &lt;&lt; <span class="number">8</span>) | t8;</span><br><span class="line">    <span class="type">int</span> t32 = (t16 &lt;&lt; <span class="number">16</span>) | t16;</span><br><span class="line">    <span class="keyword">return</span> !((x &amp; t32) ^ t32);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="negate">negate</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/* </span><br><span class="line"> * allOddBits - return 1 if all odd-numbered bits in word set to 1</span><br><span class="line"> *   where bits are numbered from 0 (least significant) to 31 (most significant)</span><br><span class="line"> *   Examples allOddBits(0xFFFFFFFD) = 0, allOddBits(0xAAAAAAAA) = 1</span><br><span class="line"> *   Legal ops: ! ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span><br><span class="line"> *   Max ops: 12</span><br><span class="line"> *   Rating: 2</span><br><span class="line"> */</span><br></pre></td></tr></table></figure><p>在C语言中，对于任意整数值<code>x</code>，计算表达式<code>-x</code>和<code>~x+1</code>得到的结果完全一样。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">negate</span><span class="params">(<span class="type">int</span> x)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> ~x + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="isasciidigit">isAsciiDigit</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/* </span><br><span class="line"> * isAsciiDigit - return 1 if 0x30 &lt;= x &lt;= 0x39 (ASCII codes for characters &#x27;0&#x27; to &#x27;9&#x27;)</span><br><span class="line"> *   Example: isAsciiDigit(0x35) = 1.</span><br><span class="line"> *            isAsciiDigit(0x3a) = 0.</span><br><span class="line"> *            isAsciiDigit(0x05) = 0.</span><br><span class="line"> *   Legal ops: ! ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span><br><span class="line"> *   Max ops: 15</span><br><span class="line"> *   Rating: 3</span><br><span class="line"> */</span><br></pre></td></tr></table></figure><p>首先<code>0x30</code>的二进制表示为<code>0b11 0000</code>，<code>0x39</code>的二进制表示为<code>0b11 1001 </code>。</p><p>用<code>cond1</code>判断<code>x</code>的高28位是否为<code>0x0000003</code>，同时也排除掉负数情况；再用<code>cond2</code>判断将<code>x</code>加6（<code>0b0110</code>）之后第5位bit是否会因为进位由1变为0，即判断<code>x</code>的最低4位是否小于等于<code>0b1001</code>。当且仅当<code>cond1</code>和<code>cond2</code>均为1时<code>isAsciiDigit</code>返回1。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">isAsciiDigit</span><span class="params">(<span class="type">int</span> x)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> cond1 = !((x &gt;&gt; <span class="number">4</span>) ^ <span class="number">0x3</span>);</span><br><span class="line">    <span class="type">int</span> cond2 = ((x + <span class="number">0x6</span>) &gt;&gt; <span class="number">4</span>) &amp; <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> cond1 &amp; cond2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="conditional">conditional</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/* </span><br><span class="line"> * conditional - same as x ? y : z </span><br><span class="line"> *   Example: conditional(2,4,5) = 4</span><br><span class="line"> *   Legal ops: ! ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span><br><span class="line"> *   Max ops: 16</span><br><span class="line"> *   Rating: 3</span><br><span class="line"> */</span><br></pre></td></tr></table></figure><p>可以想到<code>y + z + a + b</code>的形式，当<code>x</code>为真时让<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">a=0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">a</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span>且<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mo>=</mo><mo>−</mo><mi>y</mi></mrow><annotation encoding="application/x-tex">b=-y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">b</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.7777700000000001em;vertical-align:-0.19444em;"></span><span class="mord">−</span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span></span></span></span>；当<code>x</code>为假时，令<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>=</mo><mo>−</mo><mi>y</mi></mrow><annotation encoding="application/x-tex">a=-y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">a</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.7777700000000001em;vertical-align:-0.19444em;"></span><span class="mord">−</span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span></span></span></span>且<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">b=0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">b</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span>。由于不用<code>-</code>负号，因此可以用<code>~y + 1</code>代替<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mi>y</mi></mrow><annotation encoding="application/x-tex">-y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7777700000000001em;vertical-align:-0.19444em;"></span><span class="mord">−</span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span></span></span></span>，剩下的问题在于如何根据<code>x</code>的真假（即最低bit位为0或1）将所有bit位置为全1或全0。第一种方法是借助算术右移的机制，此时需要先将最低bit位左移至最高符号位，但是这种方式的移位数取决于整型类型具体有多少bit位，不具有普适性。另一种方法则更巧妙，<code>!x</code>的值只有0或1两种取值，再对它取负（即按位取反再加1）后就得到0和-1，而0和-1的补码表示不正是全0和全1嘛。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">conditional</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y, <span class="type">int</span> z)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> mask1 = (!x &lt;&lt; <span class="number">31</span>) &gt;&gt; <span class="number">31</span>; </span><br><span class="line">    <span class="type">int</span> mask2 = (!!x &lt;&lt; <span class="number">31</span>) &gt;&gt; <span class="number">31</span>; </span><br><span class="line">    <span class="type">int</span> a = (~y + <span class="number">1</span>) &amp; mask1;</span><br><span class="line">    <span class="type">int</span> b = (~z + <span class="number">1</span>) &amp; mask2;</span><br><span class="line">    <span class="keyword">return</span> y + z + a + b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">conditional</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y, <span class="type">int</span> z)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> a = !x;</span><br><span class="line">    <span class="type">int</span> b = ~a + <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> c = (~y + <span class="number">1</span>) &amp; b;</span><br><span class="line">    <span class="type">int</span> d = (~z + <span class="number">1</span>) &amp; ~b;</span><br><span class="line">    <span class="keyword">return</span>  y + z + c + d;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>由于允许使用<code>|</code>位或运算操作，因此还有简洁的写法：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">conditional</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y, <span class="type">int</span> z)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> a = !x;</span><br><span class="line">    <span class="type">int</span> b = ~a + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span>  (y &amp; ~b) | (z &amp; b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="islessorequal">isLessOrEqual</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/* </span><br><span class="line"> * isLessOrEqual - if x &lt;= y  then return 1, else return 0 </span><br><span class="line"> *   Example: isLessOrEqual(4,5) = 1.</span><br><span class="line"> *   Legal ops: ! ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span><br><span class="line"> *   Max ops: 24</span><br><span class="line"> *   Rating: 3</span><br><span class="line"> */</span><br></pre></td></tr></table></figure><ol><li>首先判断<code>x</code>与<code>y</code>是否相等，它们若相等则可以直接返回1，若<code>x</code>与<code>y</code>不等，则分别取<code>x</code>和<code>y</code>的符号位<code>signX</code>和<code>signY</code>；</li><li>若<code>x</code>正且<code>y</code>负，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>≤</mo><mi>y</mi></mrow><annotation encoding="application/x-tex">x \leq y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7719400000000001em;vertical-align:-0.13597em;"></span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span></span></span></span>一定不成立，因此返回0；</li><li>若<code>x</code>负且<code>y</code>正，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>≤</mo><mi>y</mi></mrow><annotation encoding="application/x-tex">x \leq y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7719400000000001em;vertical-align:-0.13597em;"></span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span></span></span></span>一定成立，因此返回1；</li><li>若<code>x</code>与<code>y</code>同号，则当且仅当<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>−</mo><mi>y</mi></mrow><annotation encoding="application/x-tex">x-y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span></span></span></span>结果为负（符号位为1）时<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>≤</mo><mi>y</mi></mrow><annotation encoding="application/x-tex">x \leq y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7719400000000001em;vertical-align:-0.13597em;"></span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span></span></span></span>成立。</li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">isLessOrEqual</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> cond1 = !(x ^ y);       <span class="comment">// x == y</span></span><br><span class="line">    <span class="type">int</span> signX = (x &gt;&gt; <span class="number">31</span>) &amp; <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> signY = (y &gt;&gt; <span class="number">31</span>) &amp; <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> cond2 = (!signX) &amp; signY;       <span class="comment">// x正y负</span></span><br><span class="line">    <span class="type">int</span> cond3 = (signX) &amp; (!signY);     <span class="comment">// x负y正</span></span><br><span class="line">    <span class="type">int</span> res = x + (~y + <span class="number">1</span>) &gt;&gt; <span class="number">31</span>;       <span class="comment">// x与y同号</span></span><br><span class="line">    <span class="type">int</span> flag = res &amp; <span class="number">0x1</span>;</span><br><span class="line">    <span class="keyword">return</span> cond1 | (!cond2 &amp; (cond3 | flag));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="logicalneg">logicalNeg</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/* </span><br><span class="line"> * logicalNeg - implement the ! operator, using all of </span><br><span class="line"> *              the legal operators except !</span><br><span class="line"> *   Examples: logicalNeg(3) = 0, logicalNeg(0) = 1</span><br><span class="line"> *   Legal ops: ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span><br><span class="line"> *   Max ops: 12</span><br><span class="line"> *   Rating: 4 </span><br><span class="line"> */</span><br></pre></td></tr></table></figure><p>不等于<code>0</code>的数字有正负的区别，若<code>x</code>不为0时，则<code>x</code>与<code>-x</code>的符号位必然异号；当<code>x</code>为0时，<code>x</code>与<code>-x</code>的符号位均为0。因此可将<code>x</code>与<code>-x</code>进行与运算，若<code>x</code>不为0，则结果的符号位为1，否则为0，再通过算术右移31位可得到全1或全0。最后再对结果加<code>1</code>正好可将全1的二进制表示转为<code>0b0</code>，将全0的二进制表示转为<code>0b1</code>，非常巧妙。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">logicalNeg</span><span class="params">(<span class="type">int</span> x)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> negX = ~x +<span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> sign = (x | negX) &gt;&gt; <span class="number">31</span>;</span><br><span class="line">    <span class="keyword">return</span> sign + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="howmanybits">howManyBits</h2>]]></content>
      
      
      <categories>
          
          <category> Computer Science </category>
          
          <category> CMU15-213 Introduction to Computer Systems </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CMU15-213 </tag>
            
            <tag> Lab </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Leetcode 2300 咒语和药水的成功对数</title>
      <link href="/2022/07/26/Leetcode-2300/"/>
      <url>/2022/07/26/Leetcode-2300/</url>
      
        <content type="html"><![CDATA[<p><a href="https://leetcode.cn/problems/successful-pairs-of-spells-and-potions/">2300. 咒语和药水的成功对数 - 力扣（LeetCode）</a></p><h2 id="算法">算法</h2><h4 id="排序-二分-o-m-n-logm">（排序+二分）<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mo stretchy="false">(</mo><mi>m</mi><mo>+</mo><mi>n</mi><mo stretchy="false">)</mo><mi>l</mi><mi>o</mi><mi>g</mi><mi>m</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O((m+n)logm)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mopen">(</span><span class="mord mathdefault">m</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">n</span><span class="mclose">)</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord mathdefault">m</span><span class="mclose">)</span></span></span></span></h4><ol><li>将表示药水能量强度的数组<code>potions</code>从小到大排序；</li><li>对于每个<code>spells[i]</code>，在<code>potions</code>中二分查找到第一个大于等于<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">⌈</mo><mi>s</mi><mi>u</mi><mi>c</mi><mi>c</mi><mi>e</mi><mi>s</mi><mi>s</mi><mi mathvariant="normal">/</mi><mi>s</mi><mi>p</mi><mi>e</mi><mi>l</mi><mi>l</mi><mi>s</mi><mo stretchy="false">[</mo><mi>i</mi><mo stretchy="false">]</mo><mo stretchy="false">⌉</mo></mrow><annotation encoding="application/x-tex">\lceil success / spells[i] \rceil</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">⌈</span><span class="mord mathdefault">s</span><span class="mord mathdefault">u</span><span class="mord mathdefault">c</span><span class="mord mathdefault">c</span><span class="mord mathdefault">e</span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mord">/</span><span class="mord mathdefault">s</span><span class="mord mathdefault">p</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">s</span><span class="mopen">[</span><span class="mord mathdefault">i</span><span class="mclose">]</span><span class="mclose">⌉</span></span></span></span>的位置，然后记录答案。</li></ol><h2 id="时间复杂度">时间复杂度</h2><p>对<code>potions</code>数组排序的时间复杂度为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>m</mi><mi>l</mi><mi>o</mi><mi>g</mi><mi>m</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(mlogm)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathdefault">m</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord mathdefault">m</span><span class="mclose">)</span></span></span></span>；对每个咒语的能量强度<code>spells[i]</code>均需要在<code>potions</code>数组中做一次二分，二分时间复杂度为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>l</mi><mi>o</mi><mi>g</mi><mi>m</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(logm)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord mathdefault">m</span><span class="mclose">)</span></span></span></span>，故总的时间复杂度为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mo stretchy="false">(</mo><mi>m</mi><mo>+</mo><mi>n</mi><mo stretchy="false">)</mo><mi>l</mi><mi>o</mi><mi>g</mi><mi>m</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O((m+n)logm)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mopen">(</span><span class="mord mathdefault">m</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">n</span><span class="mclose">)</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord mathdefault">m</span><span class="mclose">)</span></span></span></span>。</p><h2 id="空间复杂度">空间复杂度</h2><p><code>sort</code>排序需要<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>l</mi><mi>o</mi><mi>g</mi><mi>m</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(logm)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord mathdefault">m</span><span class="mclose">)</span></span></span></span>的系统栈空间。</p><h2 id="c-代码">C++代码</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">successfulPairs</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; spells, vector&lt;<span class="type">int</span>&gt;&amp; potions, <span class="type">long</span> <span class="type">long</span> success)</span> </span>&#123;</span><br><span class="line">        <span class="type">const</span> <span class="type">int</span> n = spells.<span class="built_in">size</span>();</span><br><span class="line">        <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">res</span><span class="params">(n)</span></span>;</span><br><span class="line">        <span class="built_in">sort</span>(potions.<span class="built_in">begin</span>(), potions.<span class="built_in">end</span>());</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++)&#123;</span><br><span class="line">            <span class="type">long</span> <span class="type">long</span> t = success / spells[i];</span><br><span class="line">            <span class="keyword">if</span> (success % spells[i]) t++;</span><br><span class="line">            res[i] = potions.<span class="built_in">end</span>() - <span class="built_in">lower_bound</span>(potions.<span class="built_in">begin</span>(), potions.<span class="built_in">end</span>(), t);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 数据结构与算法 </category>
          
          <category> Leetcode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Leetcode </tag>
            
            <tag> 二分 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Leetcode 873 最长的斐波那契子序列的长度</title>
      <link href="/2022/07/09/Leetcode-873/"/>
      <url>/2022/07/09/Leetcode-873/</url>
      
        <content type="html"><![CDATA[<p><a href="https://leetcode.cn/problems/length-of-longest-fibonacci-subsequence/">873. 最长的斐波那契子序列的长度 - 力扣（LeetCode）</a></p><h2 id="算法">算法</h2><h4 id="线性dp-o-n-2">（线性DP）<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>n</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></h4><p>本题是最长上升子序列问题的变形。<br>由于斐波那契序列要求新加入的数是前两个数之和，假设新加入斐波那契数列的数为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mi>r</mi><mi>r</mi><mo stretchy="false">[</mo><mi>i</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">arr[i]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mopen">[</span><span class="mord mathdefault">i</span><span class="mclose">]</span></span></span></span>且其前两项分别为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mi>r</mi><mi>r</mi><mo stretchy="false">[</mo><mi>j</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">arr[j]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">]</span></span></span></span>和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mi>r</mi><mi>r</mi><mo stretchy="false">[</mo><mi>k</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">arr[k]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mclose">]</span></span></span></span>且<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mi>r</mi><mi>r</mi><mo stretchy="false">[</mo><mi>k</mi><mo stretchy="false">]</mo><mo>=</mo><mi>a</mi><mi>r</mi><mi>r</mi><mo stretchy="false">[</mo><mi>i</mi><mo stretchy="false">]</mo><mo>−</mo><mi>a</mi><mi>r</mi><mi>r</mi><mo stretchy="false">[</mo><mi>j</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">arr[k] = arr[i] - arr[j]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mopen">[</span><span class="mord mathdefault">i</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">]</span></span></span></span>，因此动态规划的状态定义仅需两维。</p><ol><li>状态定义：用<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">[</mo><mi>i</mi><mo stretchy="false">]</mo><mo stretchy="false">[</mo><mi>j</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">f[i][j]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mopen">[</span><span class="mord mathdefault">i</span><span class="mclose">]</span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">]</span></span></span></span>表示最后一个数为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mi>r</mi><mi>r</mi><mo stretchy="false">[</mo><mi>i</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">arr[i]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mopen">[</span><span class="mord mathdefault">i</span><span class="mclose">]</span></span></span></span>且倒数第二个数为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mi>r</mi><mi>r</mi><mo stretchy="false">[</mo><mi>j</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">arr[j]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">]</span></span></span></span>的最长斐波那契式的子序列长度；</li><li>状态计算：根据<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mi>r</mi><mi>r</mi><mo stretchy="false">[</mo><mi>k</mi><mo stretchy="false">]</mo><mo>=</mo><mi>a</mi><mi>r</mi><mi>r</mi><mo stretchy="false">[</mo><mi>i</mi><mo stretchy="false">]</mo><mo>−</mo><mi>a</mi><mi>r</mi><mi>r</mi><mo stretchy="false">[</mo><mi>j</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">arr[k] = arr[i] - arr[j]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mopen">[</span><span class="mord mathdefault">i</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">]</span></span></span></span>可计算出斐波那契序列中倒数第三项的预期值<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mi>r</mi><mi>r</mi><mo stretchy="false">[</mo><mi>k</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">arr[k]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mclose">]</span></span></span></span>，若<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mi>r</mi><mi>r</mi><mo stretchy="false">[</mo><mi>k</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">arr[k]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mclose">]</span></span></span></span>已在<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mi>r</mi><mi>r</mi><mo stretchy="false">[</mo><mi>j</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">arr[j]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">]</span></span></span></span>之前出现过，则更新<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">[</mo><mi>i</mi><mo stretchy="false">]</mo><mo stretchy="false">[</mo><mi>j</mi><mo stretchy="false">]</mo><mo>=</mo><mi>m</mi><mi>a</mi><mi>x</mi><mo stretchy="false">(</mo><mi>f</mi><mo stretchy="false">[</mo><mi>i</mi><mo stretchy="false">]</mo><mo stretchy="false">[</mo><mi>j</mi><mo stretchy="false">]</mo><mo separator="true">,</mo><mi>f</mi><mo stretchy="false">[</mo><mi>j</mi><mo stretchy="false">]</mo><mo stretchy="false">[</mo><mi>k</mi><mo stretchy="false">]</mo><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f[i][j] = max(f[i][j], f[j][k] + 1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mopen">[</span><span class="mord mathdefault">i</span><span class="mclose">]</span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">m</span><span class="mord mathdefault">a</span><span class="mord mathdefault">x</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mopen">[</span><span class="mord mathdefault">i</span><span class="mclose">]</span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">]</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">]</span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span>。</li></ol><p>注意如果最后不存在斐波那契式的子序列需要返回0。</p><p>状态定义为两维，状态转移的计算开销为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span>，算法总的时间复杂度为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>n</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>，空间复杂度为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>n</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>。</p><h2 id="c-代码">C++代码</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">lenLongestFibSubseq</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; arr)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> n = arr.<span class="built_in">size</span>();</span><br><span class="line">        unordered_map&lt;<span class="type">int</span>, <span class="type">int</span>&gt; pos;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">            pos[arr[i]] = i;</span><br><span class="line">        vector&lt;vector&lt;<span class="type">int</span>&gt;&gt; <span class="built_in">f</span>(n, <span class="built_in">vector</span>&lt;<span class="type">int</span>&gt;(n));</span><br><span class="line">        <span class="type">int</span> res = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; i; j++)&#123;</span><br><span class="line">                <span class="type">int</span> x = arr[i] - arr[j];</span><br><span class="line">                f[i][j] = <span class="number">2</span>;</span><br><span class="line">                <span class="keyword">if</span> (x &lt; arr[j] &amp;&amp; pos.<span class="built_in">count</span>(x))&#123;</span><br><span class="line">                    <span class="type">int</span> k = pos[x];</span><br><span class="line">                    f[i][j] = <span class="built_in">max</span>(f[i][j], f[j][k] + <span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                res = <span class="built_in">max</span>(res, f[i][j]);</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">return</span> res &gt;= <span class="number">3</span> ? res : <span class="number">0</span>;  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 数据结构与算法 </category>
          
          <category> Leetcode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Leetcode </tag>
            
            <tag> 动态规划 </tag>
            
            <tag> 线性DP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Leetcode 1217 玩筹码</title>
      <link href="/2022/07/08/Leetcode-1217/"/>
      <url>/2022/07/08/Leetcode-1217/</url>
      
        <content type="html"><![CDATA[<p><a href="https://leetcode.cn/problems/minimum-cost-to-move-chips-to-the-same-position/">1217. 玩筹码 - 力扣（LeetCode）</a></p><h2 id="算法">算法</h2><h4 id="找规律-o-n">（找规律）<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mclose">)</span></span></span></span></h4><p>筹码移动距离为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn></mrow><annotation encoding="application/x-tex">2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span></span></span></span>时代价为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span>，而筹码移动距离为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>时代价为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>，因此可总结出三条性质：</p><ol><li>筹码在偶数位置间移动无需代价；</li><li>筹码在奇数位置间移动也无需代价；</li><li>将一个筹码在偶数位置与奇数位置间转移的代价为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>。</li></ol><p>所以针对本题，首先需要分别统计位于奇数位置的筹码数量<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>o</mi><mi>d</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">odd</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">o</span><span class="mord mathdefault">d</span><span class="mord mathdefault">d</span></span></span></span>和位于偶数位置的筹码数量<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mi>v</mi><mi>e</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">even</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">e</span><span class="mord mathdefault">n</span></span></span></span>，而最终只有两种情况：</p><ol><li>将所有筹码全部放置在某个偶数位置上，此时代价为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>o</mi><mi>d</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">odd</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">o</span><span class="mord mathdefault">d</span><span class="mord mathdefault">d</span></span></span></span>；</li><li>将所有筹码全部放置在某个奇数位置上，此时代价为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mi>v</mi><mi>e</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">even</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">e</span><span class="mord mathdefault">n</span></span></span></span>。</li></ol><p>两种情况最小值即为将所有筹码移动到同一位置上所需要的最小代价。</p><p>算法的时间复杂度为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mclose">)</span></span></span></span>。</p><h2 id="c-代码">C++代码</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">minCostToMoveChips</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; position)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> odd = <span class="number">0</span>, even = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> x : position)</span><br><span class="line">            <span class="keyword">if</span> (x % <span class="number">2</span>) odd++;</span><br><span class="line">            <span class="keyword">else</span> even++;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">min</span>(odd, even);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 数据结构与算法 </category>
          
          <category> Leetcode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Leetcode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Leetcode 4 寻找两个正序数组中的中位数</title>
      <link href="/2022/05/08/Leetcode-4/"/>
      <url>/2022/05/08/Leetcode-4/</url>
      
        <content type="html"><![CDATA[<p><a href="https://leetcode-cn.com/problems/median-of-two-sorted-arrays/">4. 寻找两个正序数组中的中位数 - 力扣（LeetCode）</a></p><h2 id="算法">算法</h2><h4 id="递归-o-log-m-n">（递归）<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>l</mi><mi>o</mi><mi>g</mi><mo stretchy="false">(</mo><mi>m</mi><mo>+</mo><mi>n</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(log(m+n))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mopen">(</span><span class="mord mathdefault">m</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">n</span><span class="mclose">)</span><span class="mclose">)</span></span></span></span></h4><p>问题的本质是在两个有序数组中找出第<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span></span></span></span>小数，当<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>=</mo><mo stretchy="false">(</mo><mi>m</mi><mo>+</mo><mi>n</mi><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">k=(m+n)/2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathdefault">m</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">n</span><span class="mclose">)</span><span class="mord">/</span><span class="mord">2</span></span></span></span>时即可找出中位数。<br>为了便于后续分析，首先假定<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>u</mi><mi>m</mi><mi>s</mi><mn>1</mn></mrow><annotation encoding="application/x-tex">nums1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord mathdefault">n</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mord mathdefault">s</span><span class="mord">1</span></span></span></span>中元素的数量小于<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>u</mi><mi>m</mi><mi>s</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">nums2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord mathdefault">n</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mord mathdefault">s</span><span class="mord">2</span></span></span></span>中元素的数量。分别从<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>u</mi><mi>m</mi><mi>s</mi><mn>1</mn></mrow><annotation encoding="application/x-tex">nums1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord mathdefault">n</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mord mathdefault">s</span><span class="mord">1</span></span></span></span>和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>u</mi><mi>m</mi><mi>s</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">nums2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord mathdefault">n</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mord mathdefault">s</span><span class="mord">2</span></span></span></span>中各自取出前<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">k/2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord">/</span><span class="mord">2</span></span></span></span>个元素进行比较：</p><ol><li>如果<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>u</mi><mi>m</mi><mi>s</mi><mn>1</mn><mo stretchy="false">[</mo><mi>k</mi><mi mathvariant="normal">/</mi><mn>2</mn><mo>−</mo><mn>1</mn><mo stretchy="false">]</mo><mo>&gt;</mo><mi>n</mi><mi>u</mi><mi>m</mi><mi>s</mi><mn>2</mn><mo stretchy="false">[</mo><mi>k</mi><mi mathvariant="normal">/</mi><mn>2</mn><mo>−</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">nums1[k/2 - 1] &gt; nums2[k/2 - 1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">n</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord">/</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">n</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mord mathdefault">s</span><span class="mord">2</span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord">/</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span>，说明<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>u</mi><mi>m</mi><mi>s</mi><mn>1</mn></mrow><annotation encoding="application/x-tex">nums1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord mathdefault">n</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mord mathdefault">s</span><span class="mord">1</span></span></span></span>中元素取得过多，而<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>u</mi><mi>m</mi><mi>s</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">nums2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord mathdefault">n</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mord mathdefault">s</span><span class="mord">2</span></span></span></span>中元素取得过少，即<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>u</mi><mi>m</mi><mi>s</mi><mn>2</mn><mo stretchy="false">[</mo><mn>0</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">nums2[0]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">n</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mord mathdefault">s</span><span class="mord">2</span><span class="mopen">[</span><span class="mord">0</span><span class="mclose">]</span></span></span></span>至<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>u</mi><mi>m</mi><mi>s</mi><mn>2</mn><mo stretchy="false">[</mo><mi>k</mi><mi mathvariant="normal">/</mi><mn>2</mn><mo>−</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">nums2[k/2-1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">n</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mord mathdefault">s</span><span class="mord">2</span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord">/</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span>这些元素均在两正序数组中位数之前。故可以将<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>u</mi><mi>m</mi><mi>s</mi><mn>2</mn><mo stretchy="false">[</mo><mn>0</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">nums2[0]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">n</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mord mathdefault">s</span><span class="mord">2</span><span class="mopen">[</span><span class="mord">0</span><span class="mclose">]</span></span></span></span>至<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>u</mi><mi>m</mi><mi>s</mi><mn>2</mn><mo stretchy="false">[</mo><mi>k</mi><mi mathvariant="normal">/</mi><mn>2</mn><mo>−</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">nums2[k/2-1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">n</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mord mathdefault">s</span><span class="mord">2</span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord">/</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span>这些元素取出，问题简化为从下标为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span>开始的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>u</mi><mi>m</mi><mi>s</mi><mn>1</mn></mrow><annotation encoding="application/x-tex">nums1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord mathdefault">n</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mord mathdefault">s</span><span class="mord">1</span></span></span></span>序列和下标为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">k/2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord">/</span><span class="mord">2</span></span></span></span>开始的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>u</mi><mi>m</mi><mi>s</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">nums2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord mathdefault">n</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mord mathdefault">s</span><span class="mord">2</span></span></span></span>序列中找出第<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">k/2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord">/</span><span class="mord">2</span></span></span></span>小数;</li><li>如果<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>u</mi><mi>m</mi><mi>s</mi><mn>1</mn><mo stretchy="false">[</mo><mi>k</mi><mi mathvariant="normal">/</mi><mn>2</mn><mo>−</mo><mn>1</mn><mo stretchy="false">]</mo><mo>&lt;</mo><mi>n</mi><mi>u</mi><mi>m</mi><mi>s</mi><mn>2</mn><mo stretchy="false">[</mo><mi>k</mi><mi mathvariant="normal">/</mi><mn>2</mn><mo>−</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">nums1[k/2 - 1] &lt; nums2[k/2 - 1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">n</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord">/</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">n</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mord mathdefault">s</span><span class="mord">2</span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord">/</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span>，说明<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>u</mi><mi>m</mi><mi>s</mi><mn>1</mn></mrow><annotation encoding="application/x-tex">nums1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord mathdefault">n</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mord mathdefault">s</span><span class="mord">1</span></span></span></span>中元素取得过少，而<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>u</mi><mi>m</mi><mi>s</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">nums2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord mathdefault">n</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mord mathdefault">s</span><span class="mord">2</span></span></span></span>中元素取得过多，即<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>u</mi><mi>m</mi><mi>s</mi><mn>1</mn><mo stretchy="false">[</mo><mn>0</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">nums1[0]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">n</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mopen">[</span><span class="mord">0</span><span class="mclose">]</span></span></span></span>至<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>u</mi><mi>m</mi><mi>s</mi><mn>1</mn><mo stretchy="false">[</mo><mi>k</mi><mi mathvariant="normal">/</mi><mn>2</mn><mo>−</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">nums1[k/2-1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">n</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord">/</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span>这些元素均在两正序数组中位数之前。故可以将<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>u</mi><mi>m</mi><mi>s</mi><mn>1</mn><mo stretchy="false">[</mo><mn>0</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">nums1[0]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">n</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mopen">[</span><span class="mord">0</span><span class="mclose">]</span></span></span></span>至<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>u</mi><mi>m</mi><mi>s</mi><mn>1</mn><mo stretchy="false">[</mo><mi>k</mi><mi mathvariant="normal">/</mi><mn>2</mn><mo>−</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">nums1[k/2-1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">n</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord">/</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span>这些元素取出，问题简化为从下标为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">k/2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord">/</span><span class="mord">2</span></span></span></span>开始的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>u</mi><mi>m</mi><mi>s</mi><mn>1</mn></mrow><annotation encoding="application/x-tex">nums1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord mathdefault">n</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mord mathdefault">s</span><span class="mord">1</span></span></span></span>序列和下标为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span>开始的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>u</mi><mi>m</mi><mi>s</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">nums2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord mathdefault">n</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mord mathdefault">s</span><span class="mord">2</span></span></span></span>序列中找出第<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">k/2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord">/</span><span class="mord">2</span></span></span></span>小数。当出现<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>u</mi><mi>m</mi><mi>s</mi><mn>1</mn></mrow><annotation encoding="application/x-tex">nums1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord mathdefault">n</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mord mathdefault">s</span><span class="mord">1</span></span></span></span>序列中元素数量小于<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">k/2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord">/</span><span class="mord">2</span></span></span></span>的边界情况时，记得数组访问不能越界<code>si = min(i + k / 2, int(nums1.size()))</code>。</li></ol><h4 id="时间复杂度">时间复杂度</h4><p>当<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>=</mo><mo stretchy="false">(</mo><mi>m</mi><mo>+</mo><mi>n</mi><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">k=(m+n)/2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathdefault">m</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">n</span><span class="mclose">)</span><span class="mord">/</span><span class="mord">2</span></span></span></span>即可找出中位数，并且每次递归时<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span></span></span></span>的规模都会减半，因此总的时间复杂度为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>l</mi><mi>o</mi><mi>g</mi><mo stretchy="false">(</mo><mi>m</mi><mo>+</mo><mi>n</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(log(m+n))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mopen">(</span><span class="mord mathdefault">m</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">n</span><span class="mclose">)</span><span class="mclose">)</span></span></span></span>。</p><h2 id="c-代码">C++代码</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">double</span> <span class="title">findMedianSortedArrays</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; nums1, vector&lt;<span class="type">int</span>&gt;&amp; nums2)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> total = nums1.<span class="built_in">size</span>() + nums2.<span class="built_in">size</span>();</span><br><span class="line">        <span class="keyword">if</span> (total % <span class="number">2</span> == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="type">int</span> left = <span class="built_in">findKthNumber</span>(nums1, <span class="number">0</span>, nums2, <span class="number">0</span>, total / <span class="number">2</span>);</span><br><span class="line">            <span class="type">int</span> right = <span class="built_in">findKthNumber</span>(nums1, <span class="number">0</span>, nums2, <span class="number">0</span>, total / <span class="number">2</span> + <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">return</span> (left + right) / <span class="number">2.0</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">findKthNumber</span>(nums1, <span class="number">0</span>, nums2, <span class="number">0</span>, total / <span class="number">2</span> + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">findKthNumber</span><span class="params">(vector&lt;<span class="type">int</span>&gt; &amp;nums1, <span class="type">int</span> i, vector&lt;<span class="type">int</span>&gt; &amp;nums2, <span class="type">int</span> j, <span class="type">int</span> k)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (nums1.<span class="built_in">size</span>() - i &gt; nums2.<span class="built_in">size</span>() - j)</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">findKthNumber</span>(nums2, j, nums1, i, k);</span><br><span class="line">        <span class="keyword">if</span> (i == nums1.<span class="built_in">size</span>())</span><br><span class="line">            <span class="keyword">return</span> nums2[j + k - <span class="number">1</span>];</span><br><span class="line">        <span class="keyword">if</span> (k == <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">min</span>(nums1[i], nums2[j]);</span><br><span class="line">        <span class="type">int</span> si = <span class="built_in">min</span>(i + k / <span class="number">2</span>, <span class="built_in">int</span>(nums1.<span class="built_in">size</span>())), sj = j + k / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (nums1[si - <span class="number">1</span>] &gt; nums2[sj - <span class="number">1</span>])</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">findKthNumber</span>(nums1, i, nums2, sj, k - k / <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">else</span>    </span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">findKthNumber</span>(nums1, si, nums2, j, k - (si - i));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 数据结构与算法 </category>
          
          <category> Leetcode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Leetcode </tag>
            
            <tag> 递归 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Leetcode 52 N皇后 II</title>
      <link href="/2022/05/04/Leetcode-52/"/>
      <url>/2022/05/04/Leetcode-52/</url>
      
        <content type="html"><![CDATA[<p><a href="https://leetcode-cn.com/problems/n-queens-ii/">52. N皇后 II - 力扣（LeetCode）</a></p><h2 id="算法">算法</h2><h4 id="暴力搜索-o-n">（暴力搜索）<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">!</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n!)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mclose">!</span><span class="mclose">)</span></span></span></span></h4><p>算法主要思想是暴力搜索所有方案，为了优化时间效率定义了布尔数组<code>col, dg, udg</code>，分别用来记录每一列、每条对角线和每条反对角线上是否有皇后存在。<br><code>dfs(u)</code>表示搜索棋盘第<code>u</code>行放置皇后的所有可行方案数。若棋盘上<code>(u,i)</code>位置对应的列以及对应的对角线和反对角线上都未放置皇后时，则当前位置可以放置皇后，同时更新<code>col, dg, udg</code>后继续搜索下一行<code>dfs(u+1)</code>。回溯时记得恢复现场，重置<code>col, dg, udg</code>。</p><h4 id="时间复杂度">时间复杂度</h4><p>由于<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span></span></span></span>个皇后不能在同行同列，所以每行恰有一个皇后，我们计算一下在不考虑对角线的情况下，方案数的上限：第一行有<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span></span></span></span>个位置可选，第二行有<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mtext>−</mtext><mn>1</mn></mrow><annotation encoding="application/x-tex">n−1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord mathdefault">n</span><span class="mord">−</span><span class="mord">1</span></span></span></span>个位置可选，依次类推，可得方案数最多是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo stretchy="false">!</mo></mrow><annotation encoding="application/x-tex">n!</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">n</span><span class="mclose">!</span></span></span></span>。所以时间复杂度是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">!</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n!)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mclose">!</span><span class="mclose">)</span></span></span></span>。</p><h2 id="c-代码">C++代码</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> depth;</span><br><span class="line">    vector&lt;<span class="type">bool</span>&gt; col, dg, udg;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">totalNQueens</span><span class="params">(<span class="type">int</span> n)</span> </span>&#123;</span><br><span class="line">        depth = n;</span><br><span class="line">        col = <span class="built_in">vector</span>&lt;<span class="type">bool</span>&gt;(n);</span><br><span class="line">        dg = udg = <span class="built_in">vector</span>&lt;<span class="type">bool</span>&gt;(n * <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">dfs</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">dfs</span><span class="params">(<span class="type">int</span> u)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (u == depth)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> res = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; depth; i++)&#123;</span><br><span class="line">            <span class="keyword">if</span> (!col[i] &amp;&amp; !dg[u - i + depth] &amp;&amp; !udg[u + i])&#123;</span><br><span class="line">                col[i] = dg[u - i + depth] = udg[u + i] = <span class="literal">true</span>;</span><br><span class="line">                res += <span class="built_in">dfs</span>(u + <span class="number">1</span>);</span><br><span class="line">                col[i] = dg[u - i + depth] = udg[u + i] = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 数据结构与算法 </category>
          
          <category> Leetcode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Leetcode </tag>
            
            <tag> 暴力搜索 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Leetcode 51 N皇后</title>
      <link href="/2022/05/04/Leetcode-51/"/>
      <url>/2022/05/04/Leetcode-51/</url>
      
        <content type="html"><![CDATA[<p><a href="https://leetcode-cn.com/problems/n-queens/">51. N皇后 - 力扣（LeetCode）</a></p><h2 id="算法">算法</h2><h4 id="暴力搜索-o-n">（暴力搜索）<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">!</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n!)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mclose">!</span><span class="mclose">)</span></span></span></span></h4><p>算法主要思想是暴力搜索所有方案，为了优化时间效率定义了布尔数组<code>col, dg, udg</code>，分别用来记录每一列、每条对角线和每条反对角线上是否有皇后存在。<br><code>dfs(u)</code>表示搜索棋盘第<code>u</code>行放置皇后的所有可行方案。若棋盘上<code>(u,i)</code>位置对应的列以及对应的对角线和反对角线上都未放置皇后时，则当前位置可以放置皇后<code>path[u][i]='Q'</code>，同时更新<code>col, dg, udg</code>后继续搜索下一行<code>dfs(u+1)</code>。回溯时记得恢复现场，重置<code>col, dg, udg, path</code>。</p><h4 id="时间复杂度">时间复杂度</h4><p>由于<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span></span></span></span>个皇后不能在同行同列，所以每行恰有一个皇后，我们计算一下在不考虑对角线的情况下，方案数的上限：第一行有<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span></span></span></span>个位置可选，第二行有<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mtext>−</mtext><mn>1</mn></mrow><annotation encoding="application/x-tex">n−1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord mathdefault">n</span><span class="mord">−</span><span class="mord">1</span></span></span></span>个位置可选，依次类推，可得方案数最多是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo stretchy="false">!</mo></mrow><annotation encoding="application/x-tex">n!</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">n</span><span class="mclose">!</span></span></span></span>。所以时间复杂度是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">!</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n!)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mclose">!</span><span class="mclose">)</span></span></span></span>。</p><h2 id="c-代码">C++代码</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> depth;</span><br><span class="line">    vector&lt;<span class="type">bool</span>&gt; col, dg, udg; </span><br><span class="line">    vector&lt;vector&lt;string&gt;&gt; res;</span><br><span class="line">    vector&lt;string&gt; path;</span><br><span class="line"></span><br><span class="line">    vector&lt;vector&lt;string&gt;&gt; <span class="built_in">solveNQueens</span>(<span class="type">int</span> n) &#123;</span><br><span class="line">        depth = n;</span><br><span class="line">        col = <span class="built_in">vector</span>&lt;<span class="type">bool</span>&gt;(n);</span><br><span class="line">        dg = udg = <span class="built_in">vector</span>&lt;<span class="type">bool</span>&gt;(n * <span class="number">2</span>);</span><br><span class="line">        path = <span class="built_in">vector</span>&lt;string&gt;(n, <span class="built_in">string</span>(n, <span class="string">&#x27;.&#x27;</span>));</span><br><span class="line">        <span class="built_in">dfs</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">dfs</span><span class="params">(<span class="type">int</span> u)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (u == depth)&#123;</span><br><span class="line">            res.<span class="built_in">push_back</span>(path);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; depth; i++)&#123;</span><br><span class="line">            <span class="keyword">if</span> (!col[i] &amp;&amp; !dg[i - u + depth] &amp;&amp; !udg[i + u])&#123;</span><br><span class="line">                col[i] = dg[i - u + depth] = udg[i + u] = <span class="literal">true</span>;</span><br><span class="line">                path[u][i] = <span class="string">&#x27;Q&#x27;</span>;</span><br><span class="line">                <span class="built_in">dfs</span>(u + <span class="number">1</span>);</span><br><span class="line">                <span class="comment">// 恢复现场</span></span><br><span class="line">                path[u][i] = <span class="string">&#x27;.&#x27;</span>;</span><br><span class="line">                col[i] = dg[i - u + depth] = udg[i + u] = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 数据结构与算法 </category>
          
          <category> Leetcode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Leetcode </tag>
            
            <tag> 暴力搜索 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Leetcode 59 螺旋矩阵 II</title>
      <link href="/2022/05/04/Leetcode-59/"/>
      <url>/2022/05/04/Leetcode-59/</url>
      
        <content type="html"><![CDATA[<p><a href="https://leetcode-cn.com/problems/spiral-matrix-ii/">59. 螺旋矩阵 II - 力扣（LeetCode）</a></p><h2 id="算法">算法</h2><h4 id="模拟-o-n-2">（模拟）<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>n</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></h4><ol><li>分别定义<code>x方向</code>和<code>y方向</code>上的偏移量数组<code>dx[]=&#123;-1, 0, 1, 0&#125;</code>和<code>dy[]=&#123;0, 1, 0, -1&#125;</code>，规定<code>0</code>向上，<code>1</code>向右，<code>2</code>向下，<code>3</code>向左;</li><li>从坐标<code>(0,0)</code>开始，初始方向为<code>1</code>;</li><li>每次遍历后枚举当前方向下的下一个矩阵元素，若该矩阵元素已被访问过或者超越矩阵边界则按顺时针更换方向<code>d=(d+1)%4</code></li></ol><h4 id="时间复杂度">时间复杂度</h4><p>矩阵中每个位置仅遍历一次，所以总的时间复杂度为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>n</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>。</p><h2 id="c-代码">C++代码</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    vector&lt;vector&lt;<span class="type">int</span>&gt;&gt; <span class="built_in">generateMatrix</span>(<span class="type">int</span> n) &#123;</span><br><span class="line">        vector&lt;vector&lt;<span class="type">int</span>&gt;&gt; <span class="built_in">res</span>(n, <span class="built_in">vector</span>&lt;<span class="type">int</span>&gt;(n));</span><br><span class="line">        <span class="type">int</span> dx[] = &#123;<span class="number">-1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>&#125;, dy[] = &#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">-1</span>&#125;;</span><br><span class="line">        <span class="type">int</span> x = <span class="number">0</span>, y = <span class="number">0</span>, d = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n * n; i++)&#123;</span><br><span class="line">            res[x][y] = i;</span><br><span class="line">            <span class="type">int</span> a = x + dx[d], b = y + dy[d];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (a &lt; <span class="number">0</span> || a &gt;= n || b &lt; <span class="number">0</span> || b &gt;= n || res[a][b])&#123;</span><br><span class="line">                d = (d + <span class="number">1</span>) % <span class="number">4</span>;</span><br><span class="line">                a = x + dx[d], b = y + dy[d];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            x = a, y = b;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 数据结构与算法 </category>
          
          <category> Leetcode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Leetcode </tag>
            
            <tag> 蛇形矩阵 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Leetcode 54 螺旋矩阵</title>
      <link href="/2022/05/04/Leetcode-54/"/>
      <url>/2022/05/04/Leetcode-54/</url>
      
        <content type="html"><![CDATA[<p><a href="https://leetcode-cn.com/problems/spiral-matrix/">54. 螺旋矩阵 - 力扣（LeetCode）</a></p><h2 id="算法">算法</h2><h4 id="模拟-o-nm">（模拟）<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mi>m</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(nm)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mord mathdefault">m</span><span class="mclose">)</span></span></span></span></h4><ol><li>分别定义<code>x方向</code>和<code>y方向</code>上的偏移量数组<code>dx[]=&#123;-1, 0, 1, 0&#125;</code>和<code>dy[]=&#123;0, 1, 0, -1&#125;</code>，规定<code>0</code>向上，<code>1</code>向右，<code>2</code>向下，<code>3</code>向左;</li><li>定义二维bool数组<code>st</code>表示该位置是否被访问过;</li><li>从坐标<code>(0,0)</code>开始，初始方向为<code>1</code>;</li><li>每次遍历后枚举当前方向下的下一个矩阵元素，若该矩阵元素已被访问过或者超越矩阵边界则按顺时针更换方向<code>d=(d+1)%4</code></li></ol><h4 id="时间复杂度">时间复杂度</h4><p>每个位置仅遍历一次，且寻找方向的时间复杂度是常数，故总时间复杂度为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mi>m</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(nm)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mord mathdefault">m</span><span class="mclose">)</span></span></span></span>。</p><h4 id="空间复杂度">空间复杂度</h4><p>需要额外<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mi>m</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(nm)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mord mathdefault">m</span><span class="mclose">)</span></span></span></span>的空间存储<code>st</code>数组。</p><h2 id="c-代码">C++代码</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">spiralOrder</span><span class="params">(vector&lt;vector&lt;<span class="type">int</span>&gt;&gt;&amp; matrix)</span> </span>&#123;</span><br><span class="line">        vector&lt;<span class="type">int</span>&gt; res;</span><br><span class="line">        <span class="type">int</span> m = matrix.<span class="built_in">size</span>(), n = matrix[<span class="number">0</span>].<span class="built_in">size</span>();</span><br><span class="line">        vector&lt;vector&lt;<span class="type">bool</span>&gt;&gt; <span class="built_in">st</span>(m, <span class="built_in">vector</span>&lt;<span class="type">bool</span>&gt;(n, <span class="literal">false</span>));</span><br><span class="line">        <span class="type">int</span> dx[] = &#123;<span class="number">-1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>&#125;, dy[] = &#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">-1</span>&#125;;</span><br><span class="line">        <span class="type">int</span> d = <span class="number">1</span>, x = <span class="number">0</span>, y = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= m * n; i++)&#123;</span><br><span class="line">            res.<span class="built_in">push_back</span>(matrix[x][y]);</span><br><span class="line">            st[x][y] = <span class="literal">true</span>;</span><br><span class="line">            <span class="type">int</span> a = x + dx[d], b = y + dy[d];</span><br><span class="line">            <span class="keyword">if</span> (a &lt; <span class="number">0</span> || a &gt;= m || b &lt; <span class="number">0</span> || b &gt;= n || st[a][b])&#123;</span><br><span class="line">                d = (d + <span class="number">1</span> ) % <span class="number">4</span>;</span><br><span class="line">                a = x + dx[d], b = y + dy[d];</span><br><span class="line">            &#125;</span><br><span class="line">            x = a, y = b;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 数据结构与算法 </category>
          
          <category> Leetcode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Leetcode </tag>
            
            <tag> 蛇形矩阵 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Leetcode 191 位1的个数</title>
      <link href="/2022/05/03/Leetcode-191/"/>
      <url>/2022/05/03/Leetcode-191/</url>
      
        <content type="html"><![CDATA[<p><a href="https://leetcode-cn.com/problems/number-of-1-bits/">191. 位1的个数 - 力扣（LeetCode）</a></p><h2 id="算法">算法</h2><h4 id="位运算-o-1">（位运算）<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span></h4><p>在整数的补码表示中，<code>-x</code>等价于<code>~x+1</code>，<code>lowbit(x)=x &amp; -x </code>可以返回<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">x</span></span></span></span>二进制表示下的最后一个<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>。因此可以每次减掉<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span></span></span></span>二进制表示下最后一个<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>，直至<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span></span></span></span>减到<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span>为止。</p><p>时间复杂度分析：总共最多进行<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>32</mn></mrow><annotation encoding="application/x-tex">32</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">3</span><span class="mord">2</span></span></span></span>次操作，每次操作的计算量是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span>，所以总时间复杂度是<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span>。</p><h2 id="c-代码">C++代码</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">hammingWeight</span><span class="params">(<span class="type">uint32_t</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> cnt = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (n)&#123;</span><br><span class="line">            n -= <span class="built_in">lowbit</span>(n);</span><br><span class="line">            cnt++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> cnt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">uint32_t</span> <span class="title">lowbit</span><span class="params">(<span class="type">uint32_t</span> x)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> x &amp; -x;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 数据结构与算法 </category>
          
          <category> Leetcode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Leetcode </tag>
            
            <tag> 位运算 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hello World</title>
      <link href="/2022/05/01/hello-world/"/>
      <url>/2022/05/01/hello-world/</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="quick-start">Quick Start</h2><h3 id="create-a-new-post">Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="run-server">Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="generate-static-files">Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="deploy-to-remote-sites">Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> Hexo </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
